<!doctype html><html lang=zh dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3988508441804851" crossorigin=anonymous></script><title>Infrastructure as Code中packer的使用 | 八戒的技术博客</title>
<meta name=keywords content><meta name=description content="先普及一下概念，Infrastructure as Code，也就是从代码开始定义整个网络环境、虚机、各种资源等等。
简单说就是在云上用代码来管理一切，无论是vpc、subnetwork、lb、snat、sg、ec2&mldr;&mldr;
非常符合我的胃口，因为就连架构图，都是用 graphviz 来画的。
那么 Infrastructure as Code （IAC） 可以分为以下五个部分：

Ad hoc scripts
Configuration Management tools
Orchestration tools
Provisioning tools
Server Templating tools

一、Ad hoc scripts
就是用软件对目的主机进行 point to point 操作，用shell或者ansible都可以。推荐ansible。
在 infosys 面试被一个印度老外问到这问题，因为平时根本不用ansible 的 ad hoc 点对点模式，结果被当场问住。现在才知道这玩意是什么。当然，用 ansible 的话不建议用这个，因为 playbook 是可追溯的。
二、Configuration Management tools
配置管理，这里当然推荐 ansible，每一步的操作都可以有 inventory 和 playbook 可以追溯。
三、Orchestration tools
协同工具，k8s和kvm
四、Provisioning tools
生产工具，当然是terraform，另外，阿里云是支持plumi的，华为腾讯不支持。
五、Server Templating tools
模板工具，这里就是 Packer，其实我们公司现在的模板工具，是八戒从openstack学的，改动Cloud-init的东西。
Packer更标准一下，是进化版的东西，它既可以打kvm镜像，也可以打Docker镜像。
下面我们就看看怎么使用吧，这里先说kvm，因为kvm的比较难，docker的八戒现在还是用Dockerfile，有空了再研究packer：
安装就不多说了，就一个执行文件，下载下来就行，不用装。
Packer的核心是三个部分

builders
provisioners
post-processors

我们先建立一个空目录，名字随便，就叫 test-image"><meta name=author content="八戒"><link rel=canonical href=https://rendoumi.com/posts/20220717-terraform/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.5d8a858b4ad07d913988e10d3c3dbc8c171f45316a396de8a60d67f44840812d.css integrity="sha256-XYqFi0rQfZE5iOENPD28jBcfRTFqOW3opg1n9EhAgS0=" rel="preload stylesheet" as=style><link rel=icon href=https://rendoumi.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://rendoumi.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://rendoumi.com/favicon-32x32.png><link rel=apple-touch-icon href=https://rendoumi.com/apple-touch-icon.png><link rel=mask-icon href=https://rendoumi.com/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://rendoumi.com/posts/20220717-terraform/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><meta property="og:url" content="https://rendoumi.com/posts/20220717-terraform/"><meta property="og:site_name" content="八戒的技术博客"><meta property="og:title" content="Infrastructure as Code中packer的使用"><meta property="og:description" content="先普及一下概念，Infrastructure as Code，也就是从代码开始定义整个网络环境、虚机、各种资源等等。
简单说就是在云上用代码来管理一切，无论是vpc、subnetwork、lb、snat、sg、ec2……
非常符合我的胃口，因为就连架构图，都是用 graphviz 来画的。
那么 Infrastructure as Code （IAC） 可以分为以下五个部分：
Ad hoc scripts Configuration Management tools Orchestration tools Provisioning tools Server Templating tools 一、Ad hoc scripts 就是用软件对目的主机进行 point to point 操作，用shell或者ansible都可以。推荐ansible。
在 infosys 面试被一个印度老外问到这问题，因为平时根本不用ansible 的 ad hoc 点对点模式，结果被当场问住。现在才知道这玩意是什么。当然，用 ansible 的话不建议用这个，因为 playbook 是可追溯的。
二、Configuration Management tools 配置管理，这里当然推荐 ansible，每一步的操作都可以有 inventory 和 playbook 可以追溯。
三、Orchestration tools 协同工具，k8s和kvm
四、Provisioning tools 生产工具，当然是terraform，另外，阿里云是支持plumi的，华为腾讯不支持。
五、Server Templating tools 模板工具，这里就是 Packer，其实我们公司现在的模板工具，是八戒从openstack学的，改动Cloud-init的东西。
Packer更标准一下，是进化版的东西，它既可以打kvm镜像，也可以打Docker镜像。
下面我们就看看怎么使用吧，这里先说kvm，因为kvm的比较难，docker的八戒现在还是用Dockerfile，有空了再研究packer：
安装就不多说了，就一个执行文件，下载下来就行，不用装。
Packer的核心是三个部分
builders provisioners post-processors 我们先建立一个空目录，名字随便，就叫 test-image"><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-07-17T10:30:11+08:00"><meta property="article:modified_time" content="2022-07-17T10:30:11+08:00"><meta property="og:image" content="https://rendoumi.com/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://rendoumi.com/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Infrastructure as Code中packer的使用"><meta name=twitter:description content="先普及一下概念，Infrastructure as Code，也就是从代码开始定义整个网络环境、虚机、各种资源等等。
简单说就是在云上用代码来管理一切，无论是vpc、subnetwork、lb、snat、sg、ec2&mldr;&mldr;
非常符合我的胃口，因为就连架构图，都是用 graphviz 来画的。
那么 Infrastructure as Code （IAC） 可以分为以下五个部分：

Ad hoc scripts
Configuration Management tools
Orchestration tools
Provisioning tools
Server Templating tools

一、Ad hoc scripts
就是用软件对目的主机进行 point to point 操作，用shell或者ansible都可以。推荐ansible。
在 infosys 面试被一个印度老外问到这问题，因为平时根本不用ansible 的 ad hoc 点对点模式，结果被当场问住。现在才知道这玩意是什么。当然，用 ansible 的话不建议用这个，因为 playbook 是可追溯的。
二、Configuration Management tools
配置管理，这里当然推荐 ansible，每一步的操作都可以有 inventory 和 playbook 可以追溯。
三、Orchestration tools
协同工具，k8s和kvm
四、Provisioning tools
生产工具，当然是terraform，另外，阿里云是支持plumi的，华为腾讯不支持。
五、Server Templating tools
模板工具，这里就是 Packer，其实我们公司现在的模板工具，是八戒从openstack学的，改动Cloud-init的东西。
Packer更标准一下，是进化版的东西，它既可以打kvm镜像，也可以打Docker镜像。
下面我们就看看怎么使用吧，这里先说kvm，因为kvm的比较难，docker的八戒现在还是用Dockerfile，有空了再研究packer：
安装就不多说了，就一个执行文件，下载下来就行，不用装。
Packer的核心是三个部分

builders
provisioners
post-processors

我们先建立一个空目录，名字随便，就叫 test-image"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"所有文章","item":"https://rendoumi.com/posts/"},{"@type":"ListItem","position":2,"name":"Infrastructure as Code中packer的使用","item":"https://rendoumi.com/posts/20220717-terraform/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Infrastructure as Code中packer的使用","name":"Infrastructure as Code中packer的使用","description":"先普及一下概念，Infrastructure as Code，也就是从代码开始定义整个网络环境、虚机、各种资源等等。\n简单说就是在云上用代码来管理一切，无论是vpc、subnetwork、lb、snat、sg、ec2\u0026hellip;\u0026hellip;\n非常符合我的胃口，因为就连架构图，都是用 graphviz 来画的。\n那么 Infrastructure as Code （IAC） 可以分为以下五个部分：\nAd hoc scripts Configuration Management tools Orchestration tools Provisioning tools Server Templating tools 一、Ad hoc scripts 就是用软件对目的主机进行 point to point 操作，用shell或者ansible都可以。推荐ansible。\n在 infosys 面试被一个印度老外问到这问题，因为平时根本不用ansible 的 ad hoc 点对点模式，结果被当场问住。现在才知道这玩意是什么。当然，用 ansible 的话不建议用这个，因为 playbook 是可追溯的。\n二、Configuration Management tools 配置管理，这里当然推荐 ansible，每一步的操作都可以有 inventory 和 playbook 可以追溯。\n三、Orchestration tools 协同工具，k8s和kvm\n四、Provisioning tools 生产工具，当然是terraform，另外，阿里云是支持plumi的，华为腾讯不支持。\n五、Server Templating tools 模板工具，这里就是 Packer，其实我们公司现在的模板工具，是八戒从openstack学的，改动Cloud-init的东西。\nPacker更标准一下，是进化版的东西，它既可以打kvm镜像，也可以打Docker镜像。\n下面我们就看看怎么使用吧，这里先说kvm，因为kvm的比较难，docker的八戒现在还是用Dockerfile，有空了再研究packer：\n安装就不多说了，就一个执行文件，下载下来就行，不用装。\nPacker的核心是三个部分\nbuilders provisioners post-processors 我们先建立一个空目录，名字随便，就叫 test-image\n","keywords":[],"articleBody":"先普及一下概念，Infrastructure as Code，也就是从代码开始定义整个网络环境、虚机、各种资源等等。\n简单说就是在云上用代码来管理一切，无论是vpc、subnetwork、lb、snat、sg、ec2……\n非常符合我的胃口，因为就连架构图，都是用 graphviz 来画的。\n那么 Infrastructure as Code （IAC） 可以分为以下五个部分：\nAd hoc scripts Configuration Management tools Orchestration tools Provisioning tools Server Templating tools 一、Ad hoc scripts 就是用软件对目的主机进行 point to point 操作，用shell或者ansible都可以。推荐ansible。\n在 infosys 面试被一个印度老外问到这问题，因为平时根本不用ansible 的 ad hoc 点对点模式，结果被当场问住。现在才知道这玩意是什么。当然，用 ansible 的话不建议用这个，因为 playbook 是可追溯的。\n二、Configuration Management tools 配置管理，这里当然推荐 ansible，每一步的操作都可以有 inventory 和 playbook 可以追溯。\n三、Orchestration tools 协同工具，k8s和kvm\n四、Provisioning tools 生产工具，当然是terraform，另外，阿里云是支持plumi的，华为腾讯不支持。\n五、Server Templating tools 模板工具，这里就是 Packer，其实我们公司现在的模板工具，是八戒从openstack学的，改动Cloud-init的东西。\nPacker更标准一下，是进化版的东西，它既可以打kvm镜像，也可以打Docker镜像。\n下面我们就看看怎么使用吧，这里先说kvm，因为kvm的比较难，docker的八戒现在还是用Dockerfile，有空了再研究packer：\n安装就不多说了，就一个执行文件，下载下来就行，不用装。\nPacker的核心是三个部分\nbuilders provisioners post-processors 我们先建立一个空目录，名字随便，就叫 test-image\nmkdir test-images cd test-image 然后在目录下面，建立三个文件：\npacker.json, variable.json, setup.sh\n首先看variable.json，对应AWS长这样\n{ \"description\": \"test image\", \"access_key\": \"enter-aws-your-key\", \"secret_key\": \"enter-aws-your-secret\" \"source_ami\": \"enter-yours\" } 对应腾讯云就是这样\n{ \"description\": \"test image\", \"tc_secret_id\": \"TENCENTCLOUD_ACCESS_KEY\", \"tc_secret_key\": \"TENCENTCLOUD_SECRET_KEY\", \"source_tc\": \"enter-yours\" } 稍微解释一下，无论哪家云，你都需要去申请secret的key，才可以用，然后就是source_ami和source_tc了，这个指镜像的母版\naws的长这样：\n腾讯的长这样：\nok，变量都定义好了。\n下面是packer.json的正文\naws的这样：\n{ \"builders\": [ { \"type\": \"amazon-ebs\", \"access_key\": \"{{user `access_key` }}\", \"secret_key\": \"{{user `secret_key` }}\", \"region\" : \"us-east-1\", \"ami_name\" : \"myfirstami\", \"source_ami\" : \"{{user `source_ami` }}\", \"instance_type\" : \"t2.micro\", \"ssh_username\" : \"ec2-user\" } ], \"provisioners\": [ { \"type\": \"shell\", \"script\": \"setup.sh\" } ], \"post-processors\": [ { \"type\": \"manifest\", \"output\": \"out.json\" } ] } 看见了吧，核心三部分。那么换成腾讯，就长这样\n{ \"builders\": [ { \"type\": \"tencentcloud-cvm\", \"secret_id\": \"{{user `tc_secret_id`}}\", \"secret_key\": \"{{user `tc_secret_key`}}\", \"region\": \"ap-guangzhou\", \"zone\": \"ap-guangzhou-3\", \"instance_type\": \"S2.SMALL1\", \"disk_type\": \"CLOUD_PREMIUM\", \"associate_public_ip_address\": true, \"image_name\": \"myfirsttc\", \"source_image_id\": \"{{user `source_tc` }}\", \"ssh_username\" : \"root\" } ], \"provisioners\": [ { \"type\": \"shell\", \"script\": \"setup.sh\" } ], \"post-processors\": [ { \"type\": \"manifest\", \"output\": \"out.json\" } ] } 大差不差吧。\n详细参数可以去看：https://www.packer.io/plugins/builders/tencentcloud\n那最后就是setup.sh了，举例装个jenkins好了，其他的可以根据需要进行注入：\nsleep 30 sudo yum update –y sudo wget -O /etc/yum.repos.d/jenkins.repo \\ https://pkg.jenkins.io/redhat-stable/jenkins.repo sudo rpm --import https://pkg.jenkins.io/redhat-stable/jenkins.io.key sudo yum upgrade sudo yum instqll -y epel-release sudo yum install java-openjdk11 -y sudo yum install jenkins -y sudo systemctl enable jenkins sudo systemctl start jenkins sudo systemctl status jenkins 最后run一下：\npacker build -var-file=\"variable.json\" packer.json 叽哩咕噜一顿，就build好了\nOver，这个工具在IAS中是不可缺少的一环。\n","wordCount":"273","inLanguage":"zh","image":"https://rendoumi.com/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2022-07-17T10:30:11+08:00","dateModified":"2022-07-17T10:30:11+08:00","author":{"@type":"Person","name":"八戒"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://rendoumi.com/posts/20220717-terraform/"},"publisher":{"@type":"Organization","name":"八戒的技术博客","logo":{"@type":"ImageObject","url":"https://rendoumi.com/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://rendoumi.com/ accesskey=h title="Home (Alt + H)"><img src=https://rendoumi.com/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches></div></div><ul id=menu><li><a href=https://rendoumi.com/ title=首页><span>首页</span></a></li><li><a href=https://rendoumi.com/posts/ title=文章><span>文章</span></a></li><li><a href=https://rendoumi.com/archives/ title=归档><span>归档</span></a></li><li><a href=https://blog.rendoumi.com title=生活><span>生活</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://rendoumi.com/search/ title=搜索><span>搜索</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://rendoumi.com/>主页</a>&nbsp;»&nbsp;<a href=https://rendoumi.com/posts/>所有文章</a></div><h1 class="post-title entry-hint-parent">Infrastructure as Code中packer的使用
<span class=entry-hint title=Draft><svg height="35" viewBox="0 -960 960 960" fill="currentcolor"><path d="M160-410v-60h3e2v60H160zm0-165v-60h470v60H160zm0-165v-60h470v60H160zm360 580v-123l221-220q9-9 20-13t22-4q12 0 23 4.5t20 13.5l37 37q9 9 13 20t4 22-4.5 22.5T862.09-380L643-160H520zm3e2-263-37-37 37 37zM580-220h38l121-122-18-19-19-18-122 121v38zm141-141-19-18 37 37-18-19z"/></svg></span></h1><div class=post-meta><span title='2022-07-17 10:30:11 +0800 CST'>2022年17月</span>&nbsp;·&nbsp;<span>2 分钟</span>&nbsp;·&nbsp;<span>273 字</span>&nbsp;·&nbsp;<span>八戒</span></div></header><div class=post-content><p>先普及一下概念，Infrastructure as Code，也就是从代码开始定义整个网络环境、虚机、各种资源等等。</p><p>简单说就是在云上用代码来管理一切，无论是vpc、subnetwork、lb、snat、sg、ec2&mldr;&mldr;</p><p>非常符合我的胃口，因为就连架构图，都是用 graphviz 来画的。</p><p>那么 Infrastructure as Code （IAC） 可以分为以下五个部分：</p><ul><li><strong>Ad hoc scripts</strong></li><li><strong>Configuration Management tools</strong></li><li><strong>Orchestration tools</strong></li><li><strong>Provisioning tools</strong></li><li><strong>Server Templating tools</strong></li></ul><h4 id=一ad-hoc-scripts>一、Ad hoc scripts<a hidden class=anchor aria-hidden=true href=#一ad-hoc-scripts>#</a></h4><p>就是用软件对目的主机进行 point to point 操作，用shell或者ansible都可以。推荐ansible。</p><p>在 infosys 面试被一个印度老外问到这问题，因为平时根本不用ansible 的 ad hoc 点对点模式，结果被当场问住。现在才知道这玩意是什么。当然，用 ansible 的话不建议用这个，因为 playbook 是可追溯的。</p><h4 id=二configuration-management-tools>二、Configuration Management tools<a hidden class=anchor aria-hidden=true href=#二configuration-management-tools>#</a></h4><p>配置管理，这里当然推荐 ansible，每一步的操作都可以有 inventory 和 playbook 可以追溯。</p><h4 id=三orchestration-tools>三、Orchestration tools<a hidden class=anchor aria-hidden=true href=#三orchestration-tools>#</a></h4><p>协同工具，k8s和kvm</p><h4 id=四provisioning-tools>四、Provisioning tools<a hidden class=anchor aria-hidden=true href=#四provisioning-tools>#</a></h4><p>生产工具，当然是terraform，另外，阿里云是支持plumi的，华为腾讯不支持。</p><h4 id=五server-templating-tools>五、Server Templating tools<a hidden class=anchor aria-hidden=true href=#五server-templating-tools>#</a></h4><p>模板工具，这里就是 Packer，其实我们公司现在的模板工具，是八戒从openstack学的，改动Cloud-init的东西。</p><p>Packer更标准一下，是进化版的东西，它既可以打kvm镜像，也可以打Docker镜像。</p><p>下面我们就看看怎么使用吧，这里先说kvm，因为kvm的比较难，docker的八戒现在还是用Dockerfile，有空了再研究packer：</p><p>安装就不多说了，就一个执行文件，下载下来就行，不用装。</p><p>Packer的核心是三个部分</p><ul><li>builders</li><li>provisioners</li><li>post-processors</li></ul><p>我们先建立一个空目录，名字随便，就叫 test-image</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>mkdir test-images
</span></span><span class=line><span class=cl><span class=nb>cd</span> test-image
</span></span></code></pre></div><p>然后在目录下面，建立三个文件：</p><p><strong>packer.json, variable.json, setup.sh</strong></p><p>首先看variable.json，对应AWS长这样</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>{</span> 
</span></span><span class=line><span class=cl> 	<span class=s2>&#34;description&#34;</span>: <span class=s2>&#34;test image&#34;</span>, 
</span></span><span class=line><span class=cl>    <span class=s2>&#34;access_key&#34;</span>: <span class=s2>&#34;enter-aws-your-key&#34;</span>, 
</span></span><span class=line><span class=cl>    <span class=s2>&#34;secret_key&#34;</span>: <span class=s2>&#34;enter-aws-your-secret&#34;</span> 
</span></span><span class=line><span class=cl>    <span class=s2>&#34;source_ami&#34;</span>: <span class=s2>&#34;enter-yours&#34;</span> 
</span></span><span class=line><span class=cl> <span class=o>}</span>
</span></span></code></pre></div><p>对应腾讯云就是这样</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;description&#34;</span>: <span class=s2>&#34;test image&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;tc_secret_id&#34;</span>: <span class=s2>&#34;TENCENTCLOUD_ACCESS_KEY&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;tc_secret_key&#34;</span>: <span class=s2>&#34;TENCENTCLOUD_SECRET_KEY&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;source_tc&#34;</span>: <span class=s2>&#34;enter-yours&#34;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>稍微解释一下，无论哪家云，你都需要去申请secret的key，才可以用，然后就是source_ami和source_tc了，这个指镜像的母版</p><p>aws的长这样：</p><p><img alt=image-20220717162342308 loading=lazy src=/posts/20220717-terraform/image-20220717162342308.png></p><p>腾讯的长这样：</p><p><img alt=image-20220717162309950 loading=lazy src=/posts/20220717-terraform/image-20220717162309950.png></p><p>ok，变量都定义好了。</p><p>下面是packer.json的正文</p><p>aws的这样：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span> 
</span></span><span class=line><span class=cl>	<span class=nt>&#34;builders&#34;</span><span class=p>:</span> <span class=p>[</span> 
</span></span><span class=line><span class=cl>    	<span class=p>{</span> 
</span></span><span class=line><span class=cl>        	<span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;amazon-ebs&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>            <span class=nt>&#34;access_key&#34;</span><span class=p>:</span> <span class=s2>&#34;{{user `access_key` }}&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>            <span class=nt>&#34;secret_key&#34;</span><span class=p>:</span> <span class=s2>&#34;{{user `secret_key` }}&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>            <span class=nt>&#34;region&#34;</span> <span class=p>:</span> <span class=s2>&#34;us-east-1&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>            <span class=nt>&#34;ami_name&#34;</span> <span class=p>:</span> <span class=s2>&#34;myfirstami&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>            <span class=nt>&#34;source_ami&#34;</span> <span class=p>:</span> <span class=s2>&#34;{{user `source_ami` }}&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>            <span class=nt>&#34;instance_type&#34;</span> <span class=p>:</span> <span class=s2>&#34;t2.micro&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>            <span class=nt>&#34;ssh_username&#34;</span> <span class=p>:</span> <span class=s2>&#34;ec2-user&#34;</span> 
</span></span><span class=line><span class=cl>         <span class=p>}</span> 
</span></span><span class=line><span class=cl>    <span class=p>],</span> 
</span></span><span class=line><span class=cl>  	<span class=nt>&#34;provisioners&#34;</span><span class=p>:</span> <span class=p>[</span> 
</span></span><span class=line><span class=cl>         <span class=p>{</span> 
</span></span><span class=line><span class=cl>           	<span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;shell&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>            <span class=nt>&#34;script&#34;</span><span class=p>:</span> <span class=s2>&#34;setup.sh&#34;</span> 
</span></span><span class=line><span class=cl>         <span class=p>}</span> 
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>	<span class=nt>&#34;post-processors&#34;</span><span class=p>:</span> <span class=p>[</span> 
</span></span><span class=line><span class=cl>         <span class=p>{</span> 
</span></span><span class=line><span class=cl>          	<span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;manifest&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>            <span class=nt>&#34;output&#34;</span><span class=p>:</span> <span class=s2>&#34;out.json&#34;</span> 
</span></span><span class=line><span class=cl>         <span class=p>}</span> 
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span> 
</span></span></code></pre></div><p>看见了吧，核心三部分。那么换成腾讯，就长这样</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;builders&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;tencentcloud-cvm&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;secret_id&#34;</span><span class=p>:</span> <span class=s2>&#34;{{user `tc_secret_id`}}&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;secret_key&#34;</span><span class=p>:</span> <span class=s2>&#34;{{user `tc_secret_key`}}&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;region&#34;</span><span class=p>:</span> <span class=s2>&#34;ap-guangzhou&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;zone&#34;</span><span class=p>:</span> <span class=s2>&#34;ap-guangzhou-3&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;instance_type&#34;</span><span class=p>:</span> <span class=s2>&#34;S2.SMALL1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;disk_type&#34;</span><span class=p>:</span> <span class=s2>&#34;CLOUD_PREMIUM&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;associate_public_ip_address&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;image_name&#34;</span><span class=p>:</span> <span class=s2>&#34;myfirsttc&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;source_image_id&#34;</span><span class=p>:</span> <span class=s2>&#34;{{user `source_tc` }}&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;ssh_username&#34;</span> <span class=p>:</span> <span class=s2>&#34;root&#34;</span>          
</span></span><span class=line><span class=cl>         <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>  	<span class=nt>&#34;provisioners&#34;</span><span class=p>:</span> <span class=p>[</span> 
</span></span><span class=line><span class=cl>         <span class=p>{</span> 
</span></span><span class=line><span class=cl>           	<span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;shell&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>            <span class=nt>&#34;script&#34;</span><span class=p>:</span> <span class=s2>&#34;setup.sh&#34;</span> 
</span></span><span class=line><span class=cl>         <span class=p>}</span> 
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>	<span class=nt>&#34;post-processors&#34;</span><span class=p>:</span> <span class=p>[</span> 
</span></span><span class=line><span class=cl>         <span class=p>{</span> 
</span></span><span class=line><span class=cl>          	<span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;manifest&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>            <span class=nt>&#34;output&#34;</span><span class=p>:</span> <span class=s2>&#34;out.json&#34;</span> 
</span></span><span class=line><span class=cl>         <span class=p>}</span> 
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>大差不差吧。</p><p>详细参数可以去看：https://www.packer.io/plugins/builders/tencentcloud</p><p>那最后就是setup.sh了，举例装个jenkins好了，其他的可以根据需要进行注入：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sleep <span class=m>30</span>
</span></span><span class=line><span class=cl>sudo yum update –y
</span></span><span class=line><span class=cl>sudo wget -O /etc/yum.repos.d/jenkins.repo <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    https://pkg.jenkins.io/redhat-stable/jenkins.repo
</span></span><span class=line><span class=cl>sudo rpm --import https://pkg.jenkins.io/redhat-stable/jenkins.io.key
</span></span><span class=line><span class=cl>sudo yum upgrade
</span></span><span class=line><span class=cl>sudo yum instqll -y epel-release
</span></span><span class=line><span class=cl>sudo yum install java-openjdk11 -y
</span></span><span class=line><span class=cl>sudo yum install jenkins -y
</span></span><span class=line><span class=cl>sudo systemctl <span class=nb>enable</span> jenkins
</span></span><span class=line><span class=cl>sudo systemctl start jenkins
</span></span><span class=line><span class=cl>sudo systemctl status jenkins
</span></span></code></pre></div><p>最后run一下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>packer build -var-file<span class=o>=</span><span class=s2>&#34;variable.json&#34;</span> packer.json
</span></span></code></pre></div><p>叽哩咕噜一顿，就build好了</p><p><img alt=image-20220717170447736 loading=lazy src=/posts/20220717-terraform/image-20220717170447736.png></p><p>Over，这个工具在IAS中是不可缺少的一环。</p></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://rendoumi.com/posts/20220721-mongodb_cpu/><span class=title>« 上一页</span><br><span>一次mongodb cpu很high的解决方法</span>
</a><a class=next href=https://rendoumi.com/posts/20220717-backup_cisco/><span class=title>下一页 »</span><br><span>Cisco设备自动执行和备份的脚本</span></a></nav></footer><div id=comments></div><script src=https://cwd.js.org/cwd.js></script><script>const comments=new CWDComments({el:"#comments",apiBaseUrl:"https://cwd.rendoumi.qzz.io"});comments.mount()</script></article></main><footer class=footer><span>Copyright © 2020-2025 Zhang Ranrui. All Rights Reserved.</span><br>·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script></body></html>