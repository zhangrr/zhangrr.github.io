<!doctype html><html lang=zh dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3988508441804851" crossorigin=anonymous></script><title>æ‰€æœ‰æ–‡ç«  | å…«æˆ’çš„æŠ€æœ¯åšå®¢</title>
<meta name=keywords content><meta name=description content="æ‰€æœ‰æ–‡ç«  - å…«æˆ’çš„æŠ€æœ¯åšå®¢"><meta name=author content><link rel=canonical href=https://rendoumi.com/posts/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.5d8a858b4ad07d913988e10d3c3dbc8c171f45316a396de8a60d67f44840812d.css integrity="sha256-XYqFi0rQfZE5iOENPD28jBcfRTFqOW3opg1n9EhAgS0=" rel="preload stylesheet" as=style><link rel=icon href=https://rendoumi.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://rendoumi.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://rendoumi.com/favicon-32x32.png><link rel=apple-touch-icon href=https://rendoumi.com/apple-touch-icon.png><link rel=mask-icon href=https://rendoumi.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=https://rendoumi.com/posts/index.xml title=rss><link rel=alternate hreflang=zh href=https://rendoumi.com/posts/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><meta property="og:url" content="https://rendoumi.com/posts/"><meta property="og:site_name" content="å…«æˆ’çš„æŠ€æœ¯åšå®¢"><meta property="og:title" content="æ‰€æœ‰æ–‡ç« "><meta property="og:locale" content="zh"><meta property="og:type" content="website"><meta name=twitter:card content="summary"><meta name=twitter:title content="æ‰€æœ‰æ–‡ç« "><meta name=twitter:description content><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"æ‰€æœ‰æ–‡ç« ","item":"https://rendoumi.com/posts/"}]}</script></head><body class=list id=top><header class=header><nav class=nav><div class=logo><a href=https://rendoumi.com/ accesskey=h title="å…«æˆ’çš„æŠ€æœ¯åšå®¢ (Alt + H)">å…«æˆ’çš„æŠ€æœ¯åšå®¢</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://rendoumi.com/ title=é¦–é¡µ><span>é¦–é¡µ</span></a></li><li><a href=https://rendoumi.com/posts/ title=æ–‡ç« ><span class=active>æ–‡ç« </span></a></li><li><a href=https://rendoumi.com/archives/ title=å½’æ¡£><span>å½’æ¡£</span></a></li><li><a href=https://blog.rendoumi.com title=ç”Ÿæ´»><span>ç”Ÿæ´»</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://rendoumi.com/search/ title=æœç´¢><span>æœç´¢</span></a></li></ul></nav></header><main class=main><header class=page-header><h1>æ‰€æœ‰æ–‡ç« </h1></header><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>vaultä½¿ç”¨external secretç®¡ç†kubernetes secret
<span class=entry-hint title=Draft><svg height="20" viewBox="0 -960 960 960" fill="currentcolor"><path d="M160-410v-60h3e2v60H160zm0-165v-60h470v60H160zm0-165v-60h470v60H160zm360 580v-123l221-220q9-9 20-13t22-4q12 0 23 4.5t20 13.5l37 37q9 9 13 20t4 22-4.5 22.5T862.09-380L643-160H520zm3e2-263-37-37 37 37zM580-220h38l121-122-18-19-19-18-122 121v38zm141-141-19-18 37 37-18-19z"/></svg></span></h2></header><div class=entry-content><p>ä»Šå¤©æ˜¯2025å¹´8æœˆ15æ—¥ï¼Œå¤§å™©è€—å•Šï¼š external-secrets / external-secrets Link
â­ 5416 | ğŸ”€ 1032 | Go 97.6%
External Secrets Operator é¡¹ç›®æš‚åœå‘å¸ƒ ç”±äºç»´æŠ¤å›¢é˜Ÿè§„æ¨¡è¿‡å°ï¼ŒExternal Secrets Operator å†³å®šæš‚åœæ‰€æœ‰å®˜æ–¹ç‰ˆæœ¬å‘å¸ƒï¼Œç›´åˆ°é‡å»ºè¶³å¤Ÿçš„ç»´æŠ¤å›¢é˜Ÿã€‚
Key Takeaways é¡¹ç›®æš‚åœæ‰€æœ‰å®˜æ–¹ç‰ˆæœ¬å‘å¸ƒï¼ŒåŒ…æ‹¬æ–°åŠŸèƒ½ã€è¡¥ä¸å’Œå®¹å™¨é•œåƒã€‚ å°†ç»§ç»­å®¡æ ¸å’Œåˆå¹¶ç¤¾åŒºçš„ PRï¼Œä½†ä¸ä¼šæä¾› GitHub Discussionsã€Slack æˆ–é—®é¢˜è¯„è®ºçš„æ”¯æŒã€‚ éœ€è¦è‡³å°‘äº”åé•¿æœŸç»´æŠ¤è€…æ¥ç¡®ä¿é¡¹ç›®çš„å¯æŒç»­å‘å±•ã€‚ é¼“åŠ±ä¾èµ–è¯¥é¡¹ç›®çš„å…¬å¸æˆ–å›¢é˜Ÿç§¯æå‚ä¸è´¡çŒ®ã€‚ è´¡çŒ®è€…å¯é€šè¿‡å¡«å†™è¡¨å•æˆ–æŸ¥çœ‹æ²»ç†æ–‡æ¡£åŠ å…¥é¡¹ç›®ã€‚ å±…ç„¶æš‚åœå‘å¸ƒäº†ï¼Œé‚£å°±æŠ“ç´§æ—¶é—´æŠŠVaultè·Ÿå®ƒçš„é›†æˆè®°å½•ä¸‹æ¥ï¼š
ä¸€ã€é¦–å…ˆå¿…é¡»åœ¨é›†ç¾¤é‡Œå®‰è£…Vaultï¼Œç„¶åå®‰è£…external -secretsï¼Œéƒ½ç”¨helmè£…å³å¯ helm repo add hashicorp https://helm.releases.hashicorp.com helm repo update helm install vault hashicorp/vault --set "server.dev.enabled=true" --set "injector.enabled=true" --namespace default helm repo add external-secrets https://charts.external-secrets.io helm repo update helm install external-secrets external-secrets/external-secrets --namespace external-secrets --create-namespace --set installCRDs=true äºŒã€k8sæˆæƒï¼Œk8çš„æˆæƒä½“ç³»å°±æ˜¯ sa -> role -> rolebinding é‚£kubernetesä¼šæŠŠpodä¸­saçš„Tokenæ³¨å…¥åˆ°æ–‡ä»¶ï¼š/var/run/secrets/kubernetes.io/serviceaccount/token
...</p></div><footer class=entry-footer><span title='2025-08-15 09:01:11 +0800 CST'>2025å¹´8æœˆ15æ—¥</span></footer><a class=entry-link aria-label="post link to vaultä½¿ç”¨external secretç®¡ç†kubernetes secret" href=https://rendoumi.com/posts/20250815-vault_k8s/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>k3sçš„å®‰è£…
<span class=entry-hint title=Draft><svg height="20" viewBox="0 -960 960 960" fill="currentcolor"><path d="M160-410v-60h3e2v60H160zm0-165v-60h470v60H160zm0-165v-60h470v60H160zm360 580v-123l221-220q9-9 20-13t22-4q12 0 23 4.5t20 13.5l37 37q9 9 13 20t4 22-4.5 22.5T862.09-380L643-160H520zm3e2-263-37-37 37 37zM580-220h38l121-122-18-19-19-18-122 121v38zm141-141-19-18 37 37-18-19z"/></svg></span></h2></header><div class=entry-content><p>è¿™ç¯‡æ˜¯ä¸€ä¸ªå¤§æ°´è´´ï¼Œåªæ˜¯ä¸ºäº†è®°å½•k3sçš„å®‰è£…
è¿™ä¸ªä¸œè¥¿è¢«Rancherç”¨å¾—çº¯ç†Ÿï¼Œå…ˆæ­å»ºä¸€ä¸ªk3sé›†ç¾¤ï¼Œç„¶åå†å…¶ä¸Šè£…æ§åˆ¶è½¯ä»¶ï¼Œå†å»æ§åˆ¶å…¶å®ƒé›†ç¾¤ï¼Œéå¸¸å¥½çš„æƒ³æ³•ï¼Œå€¼å¾—å€Ÿé‰´
å®‰è£…å’Œåˆ é™¤éƒ½éå¸¸ç®€æ´ï¼Œå‡†å¤‡å·¥ä½œï¼š
apt update && apt upgrade -y # ä¸‰å°æœºå™¨åˆ†åˆ«è®¾ç½® hostnamectl set-hostname master hostnamectl set-hostname worker-1 hostnamectl set-hostname worker-2 # vi /etc/hosts 127.0.0.1 master # ä¸¤å¤–ä¸¤å°ä¹Ÿåˆ†åˆ«è®¾ç½® 127.0.0.1 worker-1 # ç¬¬3å° 127.0.0.1 worker-2 å‡†å¤‡å·¥ä½œéƒ½å¼„å¥½äº†ã€‚ä¸‹é¢å®‰è£…
curl -sfL https://get.k3s.io | sh - systemctl status k3s cat /var/lib/rancher/k3s/server/node-token # åŠ å…¥æ–°èŠ‚ç‚¹ curl -sfL https://get.k3s.io | K3S_URL=https://192.168.0.200:6443 K3S_TOKEN=&lt;your-token-here> INSTALL_K3S_EXEC="--node-ip=&lt;worker-ip>" sh - åˆ é™¤ä¹Ÿå°±ä¸€å¥
/usr/local/bin/k3s-uninstall.sh å¯ä»¥åå¤è¿›è¡Œå®‰è£…</p></div><footer class=entry-footer><span title='2025-08-08 09:11:11 +0800 CST'>2025å¹´8æœˆ8æ—¥</span></footer><a class=entry-link aria-label="post link to k3sçš„å®‰è£…" href=https://rendoumi.com/posts/20250808-k3s_install/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>æ¬§æ‹‰PageCacheçš„å†…æ ¸ç¼–è¯‘
<span class=entry-hint title=Draft><svg height="20" viewBox="0 -960 960 960" fill="currentcolor"><path d="M160-410v-60h3e2v60H160zm0-165v-60h470v60H160zm0-165v-60h470v60H160zm360 580v-123l221-220q9-9 20-13t22-4q12 0 23 4.5t20 13.5l37 37q9 9 13 20t4 22-4.5 22.5T862.09-380L643-160H520zm3e2-263-37-37 37 37zM580-220h38l121-122-18-19-19-18-122 121v38zm141-141-19-18 37 37-18-19z"/></svg></span></h2></header><div class=entry-content><p>æ¬§æ‹‰ Page Cache çš„å†…æ ¸ç¼–è¯‘ PageCacheæä¾›äº†ä¸€ç§é™åˆ¶page cacheçš„èƒ½åŠ›ï¼Œèƒ½å¤Ÿå¯¹page cacheçš„æ€»é‡è¿›è¡Œæ§åˆ¶, å¢å¼ºç³»ç»Ÿåœ¨æ•°æ®åº“ç­‰page cacheå æ¯”è¾ƒé«˜åœºæ™¯ä¸‹çš„ç¨³å®šæ€§ï¼Œç§¯æé‡Šæ”¾ç¼“å­˜ã€‚
å®ƒæä¾›äº†ä»¥ä¸‹sysctlæ¥å£ï¼š
vm.pagecache_limit_ratioï¼špagecacheå ç³»ç»Ÿæ€»å†…å­˜çš„ç™¾åˆ†æ¯”ï¼Œ[0, 100]ï¼Œ0å’Œ100éƒ½è¡¨ç¤ºåŠŸèƒ½å…³é—­ã€‚ vm.pagecache_limit_reclaim_ratioï¼šé’ˆå¯¹pagecacheçœŸå®å›æ”¶çš„æ¯”ä¾‹ï¼Œåœ¨å®é™…å›æ”¶æ—¶ï¼Œæ€»æ˜¯æ¯”pagecache_limit_ratioçš„å¤šå›æ”¶ä¸€äº›ï¼Œé»˜è®¤æ¯”ä¾‹æ˜¯2%ã€‚ vm.pagecache_limit_ignore_dirtyï¼šåœ¨å›æ”¶æ—¶æ˜¯å¦å¿½ç•¥è„é¡µï¼Œé»˜è®¤å¿½ç•¥ã€‚å› ä¸ºå¯¹è„é¡µçš„å›æ”¶è¾ƒè€—æ—¶ã€‚ è¡¥ä¸æ˜¯åŸºäº openEuler-22.03-LTS çš„ï¼Œä¸é€‚ç”¨äº 24.03-LTSï¼Œä»£ç éƒ½å·²ä¸åŒäº†
ç¼–è¯‘è¿‡ç¨‹å¦‚ä¸‹ï¼š
ä¸€ã€å®‰è£…å¥½openEuler-22.03-LTSï¼Œç£ç›˜ç•™å¤Ÿç©ºé—´ï¼Œæœ€å°‘ç•™20G
äºŒã€å®‰è£…ç¼–è¯‘å·²ç»æ‰€éœ€è½¯ä»¶
dnf install -y rpm-build openssl-devel bc rsync gcc gcc-c++ flex bison m4 elfutils-libelf-devel dnf install -y python dnf install -y ncurses-devel dnf install -y dwarves ä¸‰ã€å®‰è£…å†…æ ¸æºä»£ç 
dnf install -y kernel-source ç°åœ¨æ˜¯2024å¹´11æœˆ4æ—¥ï¼Œå†…æ ¸ç‰ˆæœ¬æ˜¯ linux-5.10.0-60.139.0.166.oe2203.x86_64ï¼Œæ³¨æ„è¡¥ä¸çš„é€‚ç”¨èŒƒå›´
å››ã€æ‰“è¡¥ä¸
page.patch
å°†page.patch æ”¾åˆ° /usr/src
cd /usr/src/linux-5.10.0-60.139.0.166.oe2203.x86_64 patch -p1 &lt; ../page.patch äº”ã€ç¼–è¾‘å†…æ ¸ç‰ˆæœ¬å·ï¼ŒEXTRAVERSIONçš„ç‰ˆæœ¬å·è¦å¤§äºå½“å‰å†…æ ¸ç‰ˆæœ¬ï¼Œå¦åˆ™æ— æ³•å®‰è£…ã€‚å½“å‰æ˜¯166ï¼Œæ”¹æˆ+1ï¼Œ167
cd /usr/src/linux-5.10.0-60.139.0.166.oe2203.x86_64 vi Makefile # SPDX-License-Identifier: GPL-2.0 VERSION = 5 PATCHLEVEL = 10 SUBLEVEL = 0 EXTRAVERSION = -60.139.0.167.oe2203.x86_64 NAME = Kleptomaniac Octopus OPENEULER_MAJOR = 2203 OPENEULER_MINOR = 0 å…­ã€ç¼–è¯‘
...</p></div><footer class=entry-footer><span title='2025-08-08 09:01:11 +0800 CST'>2025å¹´8æœˆ8æ—¥</span></footer><a class=entry-link aria-label="post link to æ¬§æ‹‰PageCacheçš„å†…æ ¸ç¼–è¯‘" href=https://rendoumi.com/posts/20250808-openeuler_pagecache/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>ä¸ºæå®¢å¤©æˆæ”¹å†™ä¸€å¥—CSIå­˜å‚¨æ’ä»¶
<span class=entry-hint title=Draft><svg height="20" viewBox="0 -960 960 960" fill="currentcolor"><path d="M160-410v-60h3e2v60H160zm0-165v-60h470v60H160zm0-165v-60h470v60H160zm360 580v-123l221-220q9-9 20-13t22-4q12 0 23 4.5t20 13.5l37 37q9 9 13 20t4 22-4.5 22.5T862.09-380L643-160H520zm3e2-263-37-37 37 37zM580-220h38l121-122-18-19-19-18-122 121v38zm141-141-19-18 37 37-18-19z"/></svg></span></h2></header><div class=entry-content><p>æå®¢å¤©æˆæœ‰ä¸ªå¾ˆå‰å®³çš„scaleflashç½‘ç»œæ–‡ä»¶ç³»ç»Ÿï¼Œå……åˆ†åˆ©ç”¨rdmaçš„æ— æŸç½‘ç»œç‰¹æ€§ï¼Œå¹¶è¿›ä¸€æ­¥å‘æ‰¬å…‰å¤§ã€‚ç ”å‘å‡ºæ¥äº†å¯ä»¥é¡¶æ›¿EMCç›˜é˜µçš„å­˜å‚¨ç³»ç»Ÿï¼Œå¯ä»¥åœ¨å…¶ä¸Šè·‘Oracleç­‰æ•°æ®åº“ç³»ç»Ÿï¼ŒçœŸçš„æ˜¯å›½è´§ä¹‹å…‰äº†ã€‚
å¸®å®ƒä»¬æ”¹å†™äº†ä¸€ä¸ªcsiçš„å­˜å‚¨æ’ä»¶ï¼Œè®°å½•ä¸€ä¸‹ï¼ŒåŸºäºyandexçš„s3 csiè€Œæ¥ï¼Œè¿™æ ·æ—¢å¯ä»¥è·‘åˆ°åº•å±‚ä¸Šæä¾›æ–‡ä»¶å—è®¾å¤‡ï¼Œä¹Ÿå¯ä»¥ä¸Šå‡åˆ°ç±»ä¼¼NFSæˆ–è€…S3çš„å±‚æ¬¡æä¾›æ–‡ä»¶ç³»ç»Ÿï¼Œèƒ½æ»¡è¶³å¤§å¤šæ•°éœ€æ±‚ã€‚é‚£æºä»£ç å°±ç»å¯¹ä¸æä¾›äº†ï¼Œåªè¯´ä¸€ä¸‹è¿‡ç¨‹ï¼š
CSI PLUGINçš„ä½¿ç”¨æ–¹æ³•ï¼š ä¸€ã€å¯¼å…¥é•œåƒ csiå­˜å‚¨æ’ä»¶çš„image
cr.yandex/crp9ftr22d26age3hulg/csi-s3:0.42.66 æ–‡ä»¶ï¼šcsi.tar
å°†æ–‡ä»¶æ”¾åˆ°æ‰€æœ‰worknodeä¸Šï¼Œå¯¼å…¥æœ¬åœ°é•œåƒåº“:
ctr --address /run/k3s/containerd/containerd.sock -n k8s.io images import /root/csi.tar crictl -r unix:///run/k3s/containerd/containerd.sock images çœ‹åˆ°æœ‰ cr.yandex/crp9ftr22d26age3hulg/csi-s3:0.42.66 æ—¢æ˜¯å¯¼å…¥æˆåŠŸ
äºŒã€å®‰è£…controllerå’Œnodeserver å®‰è£…driver
æ–‡ä»¶ï¼šdriver.yaml
kubectl apply -f driver.yaml å®‰è£…controller
æ–‡ä»¶ï¼šcontroller.yaml
kubectl apply -f controller.yaml å®‰è£…nodeserver
æ–‡ä»¶ï¼šnodeserver.yaml
è§£é‡Šä¸€ä¸‹ï¼Œcontrolleræ˜¯ä¸€ä¸ªstatefulsetï¼Œæ•´ä¸ªé›†ç¾¤è¿è¡Œä¸€ä¸ªå³å¯ï¼›è€Œnodeservershiåˆ™æ˜¯ä¸€ä¸ªdaemonsetï¼Œæ¯ä¸ªworknodeéƒ½ä¼šè¿è¡Œä¸€ä¸ªå‰¯æœ¬
ä¸Šé¢ worknode æ˜¯3ä¸ªï¼Œæ‰€ä»¥æœ‰3ä¸ªå‰¯æœ¬
ä¸‰ã€scaleflash å—è®¾å¤‡çš„ä½¿ç”¨ å—è®¾å¤‡æœ€å°å•ä½æ˜¯Gï¼Œæ‰€ä»¥å¦‚æœéœ€æ±‚äº†100Mï¼Œé‚£ä¹Ÿæ˜¯1Gã€‚
é¦–å…ˆå¿…é¡»å®šä¹‰ä¸€ä¸ªstorageclassï¼Œä»¥åä½¿ç”¨è¿™ä¸€ä¸ªstorageclasså°±å¯ä»¥äº†ï¼š
cat &lt;&lt; EOF >scaleflash-storageclass.yaml --- kind: StorageClass apiVersion: storage.k8s.io/v1 metadata: name: scaleflash provisioner: ru.yandex.s3.csi parameters: mounter: scaleflash clstID: "nvmatrix_101" fsType: "xfs" EOF kubectl apply -f scaleflash-storageclass.yaml å†å®šä¹‰pvc
...</p></div><footer class=entry-footer><span title='2025-08-07 09:01:11 +0800 CST'>2025å¹´8æœˆ7æ—¥</span></footer><a class=entry-link aria-label="post link to ä¸ºæå®¢å¤©æˆæ”¹å†™ä¸€å¥—CSIå­˜å‚¨æ’ä»¶" href=https://rendoumi.com/posts/20250807-csi_scaleflash/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>vaultä½¿ç”¨agentéªŒè¯approleç”Ÿæˆ.envç¯å¢ƒå˜é‡
<span class=entry-hint title=Draft><svg height="20" viewBox="0 -960 960 960" fill="currentcolor"><path d="M160-410v-60h3e2v60H160zm0-165v-60h470v60H160zm0-165v-60h470v60H160zm360 580v-123l221-220q9-9 20-13t22-4q12 0 23 4.5t20 13.5l37 37q9 9 13 20t4 22-4.5 22.5T862.09-380L643-160H520zm3e2-263-37-37 37 37zM580-220h38l121-122-18-19-19-18-122 121v38zm141-141-19-18 37 37-18-19z"/></svg></span></h2></header><div class=entry-content><p>Vaultæ˜¯ä¸ªå¾ˆå‰å®³çš„ secret å¼•æ“äº†ï¼Œä¸å¤šè¯´äº†ï¼Œä¸»è¦ç”¨äºé›†ä¸­ç®¡ç†å„ç§å¯†ç ã€å¯†é’¥ã€‚
ç”¨æ¥ç®¡ç†Kubernetesçš„å‡­æ®ç›¸å½“å¥½ï¼Œä½†æ˜¯æˆ‘ä»¬é€šå¸¸æ˜¯è‡ªå·±å¼€å‘çš„ç¨‹åºï¼Œç„¶åéœ€è¦è¯»å„ç§é…ç½®æ–‡ä»¶ï¼Œæ¯”å¦‚è¿æ¥DBçš„ç”¨æˆ·åï¼Œå¯†ç ç­‰ç­‰ï¼Œæœ€åè¿æ¥åˆ°æ•°æ®åº“ã€‚
é‚£ä¹ˆè¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœç®¡ç†å¥½é…ç½®é¡¹å‘¢ï¼Ÿ
æ–¹æ³•å¦‚ä¸‹ï¼Œç”¨approleè¯»å–Vaultçš„é…ç½®ä¿¡æ¯ï¼š
ä¸€ã€å¯åŠ¨vaultå¼•æ“æµ‹è¯•ç¯å¢ƒ é¦–å…ˆå¯åŠ¨vaultå¼•æ“ï¼Œæµ‹è¯•ï¼Œç”¨Dockerï¼Œæ–¹ä¾¿åˆ›å»ºå’Œé”€æ¯
# å¯åŠ¨å®¹å™¨ # æˆ‘ä»¬æ‰‹åŠ¨æŒ‡å®šäº†ROOT_TOKENæ˜¯rootï¼Œè¿™åªç”¨äºæµ‹è¯•ç¯å¢ƒ docker run -d --rm \ --add-host host.docker.internal:host-gateway \ --cap-add=IPC_LOCK \ --name vault \ -p 8200:8200 \ -e VAULT_DEV_ROOT_TOKEN_ID=root \ -e VAULT_DEV_LISTEN_ADDRESS=0.0.0.0:8200 \ hashicorp/vault --add-host host.docker.internal:host-gateway è¿™ä¸ªä¸ªå‚æ•°çš„ä½œç”¨æ˜¯åœ¨å®¹å™¨çš„ /etc/hosts æ–‡ä»¶ä¸­æ·»åŠ ä¸€ä¸ªä¸»æœºåå’Œ IP åœ°å€çš„æ˜ å°„ã€‚
--add-host: è¿™æ˜¯ docker run çš„ä¸€ä¸ªé€‰é¡¹ï¼Œç”¨æ¥åœ¨å®¹å™¨çš„ /etc/hosts æ–‡ä»¶ä¸­æ·»åŠ ä¸€ä¸ªè‡ªå®šä¹‰çš„ä¸»æœºæ¡ç›®ã€‚ host.docker.internal: è¿™æ˜¯ä¸»æœºåã€‚åœ¨ Docker Desktopï¼ˆmacOS å’Œ Windowsï¼‰ä¸­ï¼Œhost.docker.internal æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ DNS åç§°ï¼Œå®ƒä¼šè¢«è§£æä¸ºå®¿ä¸»æœºçš„å†…éƒ¨ IP åœ°å€ã€‚ host-gateway: è¿™æ˜¯ docker åœ¨è¾ƒæ–°ç‰ˆæœ¬ä¸­å¼•å…¥çš„ä¸€ä¸ªç‰¹æ®Šå…³é”®å­—ã€‚å®ƒä»£è¡¨äº†å®¿ä¸»æœºä¸ Docker ç½‘ç»œä¹‹é—´çš„ç½‘å…³ IP åœ°å€ã€‚åœ¨è®¸å¤š Linux ç¯å¢ƒä¸­ï¼Œè¿™ä¸ªå…³é”®å­—ä¼šæŒ‡å‘ Docker çš„ç½‘æ¡¥ IPï¼ˆä¾‹å¦‚ 172.17.0.1ï¼‰ã€‚ ç»¼åˆèµ·æ¥ï¼Œ--add-host host.docker.internal:host-gateway çš„ä½œç”¨æ˜¯ï¼š
...</p></div><footer class=entry-footer><span title='2025-08-06 09:01:11 +0800 CST'>2025å¹´8æœˆ6æ—¥</span></footer><a class=entry-link aria-label="post link to vaultä½¿ç”¨agentéªŒè¯approleç”Ÿæˆ.envç¯å¢ƒå˜é‡" href=https://rendoumi.com/posts/20250806-vault_approle_env/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>ä¸Šéš¾åº¦---->å†…ç½‘vpsç”¨legoç”³è¯·route53 DNSè¯ä¹¦å¹¶æ›´æ–°åˆ°BTå®å¡”
<span class=entry-hint title=Draft><svg height="20" viewBox="0 -960 960 960" fill="currentcolor"><path d="M160-410v-60h3e2v60H160zm0-165v-60h470v60H160zm0-165v-60h470v60H160zm360 580v-123l221-220q9-9 20-13t22-4q12 0 23 4.5t20 13.5l37 37q9 9 13 20t4 22-4.5 22.5T862.09-380L643-160H520zm3e2-263-37-37 37 37zM580-220h38l121-122-18-19-19-18-122 121v38zm141-141-19-18 37 37-18-19z"/></svg></span></h2></header><div class=entry-content><p>ä¸Šä¸€ç¯‡æˆ‘ä»¬è¯´äº† Awsçš„EC2æœåŠ¡å™¨ç”¨legoè·å¾—å…è´¹è¯ä¹¦å¹¶æ›´æ–°åˆ°ACMï¼Œè¿™ä¸‹åˆæ¥äº†ä¸ªæ›´åŠ æœ‰éš¾åº¦çš„æŒ‘æˆ˜ï¼š
DNSè§£ææ˜¯æ”¾åœ¨äº†AWS Route 53ä¸Šï¼Œç„¶åvpsä¸Šè·‘ç€BTå®å¡”ï¼Œç”¨æ¥ä»£ç†è½¬å‘å¼€å‘ç¯å¢ƒçš„httpsè¯ä¹¦
è¿™ä¸ªç¯å¢ƒå¦‚ä½•ç”¨legoæ¥å®‰å…¨çš„ç”³è¯·åˆ°è¯ä¹¦å¹¶é…ç½®å®å¡”å‘¢ï¼Ÿè¿™å›å¯ä¸åƒEC2é‚£æ ·å¯ä»¥è‡ªåŠ¨é™„åŠ IAMè§’è‰²äº†
æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹legoçš„ç”¨æ³•å§ï¼š
https://go-acme.github.io/lego/dns/route53/
è¯­æ³•å¦‚ä¸‹ï¼š
ç»§ç»­çœ‹ï¼Œçœ‹æ¥å¿…é¡»éœ€è¦IAMçš„å‡­æ®æ‰å¯ä»¥ï¼Œç»§ç»­ä¸‹æ‹‰ï¼Œæœ‰ä½¿ç”¨IAMçš„policyï¼Œé‚£æˆ‘ä»¬å¿…é¡»åˆ›å»ºä¸€ä¸ªRoleè§’è‰²ï¼Œç„¶åå†å»ºç«‹ä¸€ä¸ªä»£ç†ç”¨æˆ·ï¼Œgenå‡ºkeyï¼Œé€šè¿‡è¿™ä¸ªä»£ç†ç”¨æˆ·çš„å‡­æ®æ¥é—´æ¥è¿›è¡Œè®¿é—®
æ­¥éª¤å¦‚ä¸‹ï¼š
ä¸€ã€å»route53ï¼Œæ‹¿åˆ°arn æˆ‘ä»¬è¦æ‹¿åˆ°å…·ä½“åŸŸåçš„zone IDï¼Œå°±æ˜¯Z0æ‰“å¤´çš„é‚£ä¸€ä¸²
äºŒã€å»ºç«‹IAMå®é™…å·¥ä½œçš„Role é¦–å…ˆå»ºç«‹ä¸€ä¸ªPolicyï¼Œroute53AcmeCert
{ "Version": "2012-10-17 "Statement": [ "Effect": "Allow", "Action": "route53:GetChange", "Resource": "arn:aws:route53:::change/*" }, { "Effect": "Allow", "Action": "route53:ListHostedZonesByName", }, { "Effect": "Allow", "Action": [ "route53:ListResourceRecordSets" ], "Resource": [ "arn:aws:route53:::hostedzone/Z01111111111111111111" ] }, { "Effect": "Allow", "Action": [ "route53:ChangeResourceRecordSets" ], "Resource": [ "arn:aws:route53:::hostedzone/Z01111111111111111111" ], "Condition": { "ForAllValues:StringEquals": { "route53:ChangeResourceRecordSetsNormalizedRecordNames": [ "_acme-challenge.example.com" ], "route53:ChangeResourceRecordSetsRecordTypes": [ "TXT" ] } } } ] } ç„¶åå»ºç«‹ä¸€ä¸ªRoleï¼ŒRealUpdateCertRoleï¼Œç»‘å®šä¸Šé¢çš„ç­–ç•¥
...</p></div><footer class=entry-footer><span title='2025-07-29 09:01:11 +0800 CST'>2025å¹´7æœˆ29æ—¥</span></footer><a class=entry-link aria-label="post link to ä¸Šéš¾åº¦---->å†…ç½‘vpsç”¨legoç”³è¯·route53 DNSè¯ä¹¦å¹¶æ›´æ–°åˆ°BTå®å¡”" href=https://rendoumi.com/posts/20250729-route53_lego_bt_certificate/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>Postgresçš„walå’ŒPITRæ—¶é—´ç‚¹æ¢å¤
<span class=entry-hint title=Draft><svg height="20" viewBox="0 -960 960 960" fill="currentcolor"><path d="M160-410v-60h3e2v60H160zm0-165v-60h470v60H160zm0-165v-60h470v60H160zm360 580v-123l221-220q9-9 20-13t22-4q12 0 23 4.5t20 13.5l37 37q9 9 13 20t4 22-4.5 22.5T862.09-380L643-160H520zm3e2-263-37-37 37 37zM580-220h38l121-122-18-19-19-18-122 121v38zm141-141-19-18 37 37-18-19z"/></svg></span></h2></header><div class=entry-content><p>ç ”ç©¶äº†Postgresçš„åº“æ•°æ®æ¢å¤å’Œè½¬ç§»ï¼Œå†æ¥ç ”ç©¶ä¸€ä¸‹PITRæŒ‰æ—¶é—´ç‚¹æ¢å¤
ç±»æ¯”åˆ°MySQLï¼Œå› ä¸ºæˆ‘ä»¬æ˜¯è¿ç»´ï¼Œä¸æ˜¯ä¸“ä¸šçš„DBAï¼Œæ‰€ä»¥æ¢å¤åˆ°æ­£ç¡®æ•°æ®å³å¯
é‚£è·Ÿé˜¿é‡Œäº‘ä»¥åŠè‡ªå»ºçš„MySQLæ¢å¤ä¸€æ ·ï¼Œé¦–å…ˆéƒ½è¦æœ‰ä¸€ä¸ªæ¯å¤©çš„åŸºç¡€å¤‡ä»½ï¼Œç„¶åç±»æ¯”MySQLçš„Binlogï¼ŒPostgresè¿™é‡Œå°±ç›¸å½“äºwalã€‚
è¿™ä¹ˆç±»æ¯”å°±å¯¹äº†ï¼Œé‚£ä¹ˆæ¢å¤è¿‡ç¨‹çš„æ€è·¯æ˜¯ä¸€æ ·çš„ï¼š
é¦–å…ˆå»ºç«‹ä¸€ä¸ªæ–°çš„å®ä¾‹ ç¬¬äºŒæ­¥æŠŠæ¯å¤©çš„åŸºç¡€ç‰©ç†å…¨å¤‡ç»™æ¢å¤ä¸Šå» ç¬¬ä¸‰æ­¥æŠŠä¹‹åçš„walæ—¥å¿—ä¼ åˆ°æ–°å®ä¾‹ï¼Œæ¢å¤åˆ°æŒ‡å®šæ—¶é—´ç‚¹ ç¬¬å››æ­¥æœ€åæŠŠè¡¨æˆ–åº“Dumpä¸‹æ¥ï¼ŒçŒå…¥åˆ°æ—§å®ä¾‹çš„æ–°è¡¨æˆ–æ–°åº“ é‚£æˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥æ¥è§£é‡Šï¼š
ä¸€ã€æ¯å¤©å»ºç«‹ä¸€ä¸ªåŸºç¡€å¤‡ä»½ï¼Œè¿™æ ·åœ¨BaseåŸºç¡€ä¸Šï¼Œåªéœ€æ¢å¤å½“å¤©çš„walï¼Œé€Ÿåº¦å¤Ÿå¿« å»ºç«‹æ¯å¤©çš„BaseåŸºç¡€ç‰©ç†å¤‡ä»½
pg_basebackup -Ft -Pv -Xf -z -Z5 -U postgres -h localhost -p 5432 -D /pg_backup è§£é‡Šä¸€ä¸‹ï¼š -Ftï¼š æŒ‡å®šå¤‡ä»½æ ¼å¼ä¸º tarã€‚ å¦‚æœä½¿ç”¨ tar æ ¼å¼ï¼Œå¤‡ä»½ä¼šè¾“å‡º tar æ–‡ä»¶ï¼Œå¹¶ä¸”ä¸éœ€è¦ç›´æ¥è®¿é—® PostgreSQL æ•°æ®ç›®å½•ã€‚ -Pvï¼š -Pï¼šæ˜¾ç¤ºå¤‡ä»½è¿›åº¦ã€‚ -vï¼šå¯ç”¨è¯¦æƒ…æ¨¡å¼ï¼ˆverboseï¼‰ï¼Œæ˜¾ç¤ºæ›´å¤šæ—¥å¿—ã€‚ -Xfï¼š -Xï¼šæ§åˆ¶ WAL æ—¥å¿—çš„å¤„ç†æ–¹å¼ï¼Œf è¡¨ç¤ºåœ¨å¤‡ä»½ä¸­åŒ…å« WAL æ–‡ä»¶ï¼ˆWrite Ahead Logsï¼‰ï¼Œç¡®ä¿å¤‡ä»½å¯ä»¥ç”¨äºæ¢å¤åˆ°å®Œæ•´çš„ä¸€è‡´çŠ¶æ€ã€‚ -zï¼š å¯ç”¨å‹ç¼©åŠŸèƒ½ã€‚ -Z5ï¼š è®¾ç½®å‹ç¼©çº§åˆ«ä¸º 5ï¼ˆå‹ç¼©çº§åˆ«ä» 0 åˆ° 9ï¼Œ9 ä¸ºæœ€é«˜å‹ç¼©ï¼‰ã€‚ -U postgresï¼š ä½¿ç”¨ postgres ç”¨æˆ·æ¥è¿æ¥æ•°æ®åº“ã€‚ -h localhostï¼š æŒ‡å®šæ•°æ®åº“ä¸»æœºä¸ºå½“å‰æœºå™¨ï¼ˆlocalhostï¼‰ã€‚ -p 5432ï¼š æŒ‡å®š PostgreSQL ç›‘å¬ç«¯å£ä¸º 5432ï¼ˆé»˜è®¤ç«¯å£ï¼‰ã€‚ -D /pg_backupï¼š å°†å¤‡ä»½æ–‡ä»¶ä¿å­˜åˆ°æŒ‡å®šè·¯å¾„ /pg_backup ä¸­ã€‚ è¿™æ ·æˆ‘ä»¬å°±åœ¨ /pg_backup ä¸­æœ‰äº†å¤‡ä»½æ–‡ä»¶ï¼ŒåŒ…æ‹¬ä¸€ä¸ªbackup_manifestçš„æ–‡ä»¶æ¸…å•ï¼Œä»¥åŠä¸€ä¸ªå‹ç¼©åŒ…
...</p></div><footer class=entry-footer><span title='2025-07-28 11:01:11 +0800 CST'>2025å¹´7æœˆ28æ—¥</span></footer><a class=entry-link aria-label="post link to Postgresçš„walå’ŒPITRæ—¶é—´ç‚¹æ¢å¤" href=https://rendoumi.com/posts/20250728-postgres_wal_pitr/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>å•æœºéƒ¨ç½²kafkaç”¨kraftä¸ä¾èµ–zookeeper
<span class=entry-hint title=Draft><svg height="20" viewBox="0 -960 960 960" fill="currentcolor"><path d="M160-410v-60h3e2v60H160zm0-165v-60h470v60H160zm0-165v-60h470v60H160zm360 580v-123l221-220q9-9 20-13t22-4q12 0 23 4.5t20 13.5l37 37q9 9 13 20t4 22-4.5 22.5T862.09-380L643-160H520zm3e2-263-37-37 37 37zM580-220h38l121-122-18-19-19-18-122 121v38zm141-141-19-18 37 37-18-19z"/></svg></span></h2></header><div class=entry-content><p>ä¸Šä¸€ç¯‡è¯´äº†ç”¨Dockeréƒ¨ç½²kafkaï¼Œåç«¯ä¸ç”¨zookeeperï¼Œæ”¹ç”¨kraftã€‚
è¿™ä¸€ç¯‡è¯´è¯´ä¸ç”¨Dockerï¼Œç›´æ¥å•æœºéƒ¨ç½²kafkaç”¨kraftçš„æ–¹æ³•ã€‚
ä¸€ã€å‡†å¤‡ï¼Œè™šæœºçš„è¯éœ€è¦4cpu 8Gå†…å­˜
# è£…å¥½java java --version å»º3ä¸ªç›®å½• # æ”¾kafkaçš„2è¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ mkdir -p /opt/kafka # æ”¾kafkaçš„æ—¥å¿—æ–‡ä»¶ mkdir -p /var/log/kafka # æ”¾kafkaçš„æ•°æ®æ–‡ä»¶ mkdir -p /var/lib/kafka äºŒã€ä¸‹è½½å¹¶é…ç½®kafka
# é‡Šæ”¾åˆ°æŒ‡å®šç›®å½• tar -xzf kafka_2.13-3.5.0.tgz -C /opt/kafka # ä¿®æ”¹/opt/kafka/config/server.properties process.roles=broker,controller node.id=1 controller.quorum.voters=1@localhost:9093 listeners=PLAINTEXT://localhost:9092,CONTROLLER://localhost:9093 log.dirs=/var/lib/kafka # ç„¶åéœ€è¦å†è¿½åŠ åˆ°server.propertiesçš„éƒ¨åˆ† metadata.log.dir=/var/lib/kafka/metadata num.replica.fetchers=1 offsets.topic.replication.factor=1 transaction.state.log.replication.factor=1 transaction.state.log.min.isr=1 ä¸‰ã€åˆå§‹åŒ–kafkaé›†ç¾¤
# ç”Ÿæˆä¸€ä¸ªuuid uuidgen dc66bcb0-758e-4360-843d-5ccb1da2ee74 # åˆå§‹åŒ– cd /opt/kafka bin/kafka-storage.sh format -t &lt;UUID> -c config/server.properties # å¯åŠ¨ bin/kafka-server-start.sh config/server.properties # æ£€æŸ¥ä¸€ä¸‹ä»£ç†çš„çŠ¶æ€ bin/kafka-broker-api-versions.sh --bootstrap-server localhost:9092 å››ã€æ¨é€æ•°æ®éªŒè¯
...</p></div><footer class=entry-footer><span title='2025-07-28 10:01:11 +0800 CST'>2025å¹´7æœˆ28æ—¥</span></footer><a class=entry-link aria-label="post link to å•æœºéƒ¨ç½²kafkaç”¨kraftä¸ä¾èµ–zookeeper" href=https://rendoumi.com/posts/20250728-kafka_kraft_alone/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>ç”¨Dockeréƒ¨ç½²kafkaä¸”ä¸ä¾èµ–zookeeper
<span class=entry-hint title=Draft><svg height="20" viewBox="0 -960 960 960" fill="currentcolor"><path d="M160-410v-60h3e2v60H160zm0-165v-60h470v60H160zm0-165v-60h470v60H160zm360 580v-123l221-220q9-9 20-13t22-4q12 0 23 4.5t20 13.5l37 37q9 9 13 20t4 22-4.5 22.5T862.09-380L643-160H520zm3e2-263-37-37 37 37zM580-220h38l121-122-18-19-19-18-122 121v38zm141-141-19-18 37 37-18-19z"/></svg></span></h2></header><div class=entry-content><p>ç”¨redpandaå±…ç„¶è¿˜è¦æ¯éš”30å¤©æ›´æ–°ä¸€ä¸‹Licenseæ–‡ä»¶ï¼Œå”å¯å¿å©¶ä¸å¯å¿å•Šã€‚
æ¢æ‰æ¢æ‰ï¼Œç›´æ¥ç”¨Dockeréƒ¨ç½²kafkaï¼Œåç«¯ä¸ç”¨zookeeperï¼Œç”¨kraftï¼Œå¤©ä¸‹è‹¦zkä¹Ÿä¹…çŸ£ï¼
æ–¹æ³•å¾ˆç®€å•ï¼Œç”¨docker-composeï¼Œç¼–è¾‘docker-compose.ymlæ–‡ä»¶
name: 'stream' services: kafka: image: confluentinc/cp-kafka:latest hostname: kafka container_name: kafka ports: - 9092:9092 - 9093:9093 environment: KAFKA_KRAFT_MODE: true # This enables KRaft mode in Kafka. KAFKA_PROCESS_ROLES: controller,broker # Kafka acts as both broker and controller. KAFKA_NODE_ID: 1 # A unique ID for this Kafka instance. KAFKA_CONTROLLER_QUORUM_VOTERS: 1@10.8.1.119:9093 # Defines the controller voters. KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093 KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://10.8.1.119:9092 KAFKA_LOG_DIRS: /var/lib/kafka/data # Where Kafka stores its logs. KAFKA_AUTO_CREATE_TOPICS_ENABLE: true # Kafka will automatically create topics if needed. KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1 # Since weâ€™re running one broker, one replica is enough. KAFKA_LOG_RETENTION_HOURS: 168 # Keep logs for 7 days. KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0 # No delay for consumer rebalancing. CLUSTER_ID: Mk3OEYBSD34fcwNTJENDM2Qk # A unique ID for the Kafka cluster. volumes: - /var/run/docker.sock:/var/run/docker.sock - ./data:/var/lib/kafka/data # Store Kafka logs on your local machine. æ³¨æ„ä»¥ä¸Šçš„æ–‡ä»¶ï¼Œæš´éœ²äº†2ä¸ªç«¯å£ï¼Œ9092å’Œ9093ï¼Œ9092ç”¨äºå®¢æˆ·ç«¯è¿æ¥ï¼Œ9093ç”¨äºé›†ç¾¤é€šè®¯ï¼›KAFKA_KRAFT_MODE: trueç”¨kraftä¸ç”¨zk. ClUSTER_IDå¯ä»¥æ¢ä¸ªä¸åŒçš„ã€‚
...</p></div><footer class=entry-footer><span title='2025-07-28 09:01:11 +0800 CST'>2025å¹´7æœˆ28æ—¥</span></footer><a class=entry-link aria-label="post link to ç”¨Dockeréƒ¨ç½²kafkaä¸”ä¸ä¾èµ–zookeeper" href=https://rendoumi.com/posts/20250728-kafka_kraft_docker/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>awsçš„EC2æœåŠ¡å™¨ç”¨legoè·å¾—å…è´¹è¯ä¹¦å¹¶æ›´æ–°åˆ°ACM
<span class=entry-hint title=Draft><svg height="20" viewBox="0 -960 960 960" fill="currentcolor"><path d="M160-410v-60h3e2v60H160zm0-165v-60h470v60H160zm0-165v-60h470v60H160zm360 580v-123l221-220q9-9 20-13t22-4q12 0 23 4.5t20 13.5l37 37q9 9 13 20t4 22-4.5 22.5T862.09-380L643-160H520zm3e2-263-37-37 37 37zM580-220h38l121-122-18-19-19-18-122 121v38zm141-141-19-18 37 37-18-19z"/></svg></span></h2></header><div class=entry-content><p>äº¤ä»£ä¸€ä¸‹èƒŒæ™¯ï¼š
å…¬å¸åœ¨AWSä¸Šç”¨çš„æ˜¯EKS+Fargateï¼Œè¿˜æœ‰ä¸€ä¸ªè·³æ¿æœºï¼Œè¯ä¹¦å‘¢å°±ä¸å¤ªæƒ³ç”¨awsæ”¶è´¹çš„äº†ï¼Œå¹²è„†ç”¨å…è´¹çš„è¯ä¹¦å¥½äº†ã€‚
é‚£é—®é¢˜å°±æ¥äº†ï¼ŒLetâ€˜s encryptçš„è¯ä¹¦90å¤©åˆ°æœŸï¼Œå·²ç»æ‰‹åŠ¨æ›´æ–°è¿‡3æ¬¡äº†ï¼Œå®åœ¨å¤ªéº»çƒ¦äº†ï¼Œèƒ½ä¸èƒ½è‡ªåŠ¨ç”³è¯·å¹¶æ›´æ–°åˆ°ACMå‘¢ï¼Ÿ
ç­”æ¡ˆæ˜¯å¯ä»¥çš„ï¼ŒåŸç†æ˜¯ï¼šåˆ©ç”¨EC2å¯ä»¥æºå¸¦IAMè§’è‰²çš„åŸç†ï¼Œå°±å¯ä»¥æ— å‡­è¯æ›´æ–°å…è´¹è¯ä¹¦åˆ°AWS Certificate Manageräº†
åšæ³•å¦‚ä¸‹ï¼š
ä¸€ã€é¦–å…ˆå»ACMä¸­æ‹¿åˆ°è¯ä¹¦çš„ARNï¼Œè¦ç¡®ä¿IAMæƒé™ä¸å¤–æ³„ï¼Œé¿å…æ›´æ–°é”™è¯ä¹¦
äºŒã€ç”Ÿæˆä¸€ä¸ªIAMçš„policyï¼Œå‘½åä¸ºAllowUpdateCertificateï¼Œåªå…è®¸æ›´æ–°è¿™ä¸¤ä¸ªç‰¹å®šçš„è¯ä¹¦
å…·ä½“ç­–ç•¥å†…å®¹å¦‚ä¸‹ï¼š
{ "Version": "2012-10-17", "Statement": [ { "Effect": "Allow", "Action": [ "acm:ImportCertificate" ], "Resource": [ "arn:aws:acm:ap-southeast-1:111111111111:certificate/arn01", "arn:aws:acm:ap-southeast-1:111111111111:certificate/arn02" ] } ] } ä¸‰ã€IAMç”Ÿæˆä¸€ä¸ªroleè§’è‰²ï¼Œå‘½åä¸ºEc2UpdateCertificateRoleï¼ŒæŠŠAllowUpdateCertificateç­–ç•¥ç»™é™„ä¸Š
å››ã€åˆ°EC2çš„å®ä¾‹è¯¦ç»†ä¿¡æ¯ä¸­ï¼Œæ“ä½œâ€“>å®‰å…¨â€“>ä¿®æ”¹IAMè§’è‰²
é™„ä¸ŠEc2UpdateCertificateRoleè¿™ä¸ªè§’è‰²
äº”ã€åœ¨EC2çš„æœºå™¨ä¸Šï¼Œè£…å¥½AWS CLIï¼Œè¿˜æœ‰lego(ç”³è¯·Letâ€™s encryptè¯ä¹¦çš„è½¯ä»¶)
å…ˆå†™å¥½è·å¾—è¯ä¹¦çš„è„šæœ¬ get_cert.shï¼ŒåŸŸåDNSè§£ææ˜¯æ‰˜ç®¡åˆ°cloudflareçš„ï¼Œæ‰€ä»¥ä¹Ÿç›´æ¥ç”¨API TOKENæ¥å¤„ç†
#!/bin/bash CLOUDFLARE_DNS_API_TOKEN=######## /usr/local/bin/lego --path /usr/local/bin/certs --email zhangranrui@rendoumi.com --dns cloudflare --domains *.rendoumi.com --domains rendoumi.com renew --renew-hook="/usr/local/bin/update_aws_cert.sh" å‚æ•°--renew-hookå¦‚æœæœ‰æ–°è¯ä¹¦ï¼Œå°±è°ƒç”¨åé¢çš„è„šæœ¬ã€‚å¦‚æœæ²¡æœ‰æ–°è¯ä¹¦ï¼Œå°±æ— æ“ä½œï¼Œé¿å…æ— ç”¨åŠŸã€‚
ç„¶åå†å†™å¥½ update_aws_cert.shï¼Œè¿™å°±æ˜¯ä¸ªåƒå­—æ–‡äº†ï¼Œç”±geminiç”Ÿæˆçš„ï¼š
ç”±äºlegoç”Ÿæˆçš„crtæ˜¯è¯ä¹¦+è¯ä¹¦é“¾ï¼Œæ‰€ä»¥ç¬¬ä¸€æ­¥è¦æŠŠè¯ä¹¦éƒ¨åˆ†ç»™å•ç‹¬æ‹†å‡ºæ¥
#!/bin/bash cd /usr/local/bin/certs/certificates #é¦–å…ˆæŠŠè¯ä¹¦å•ç‹¬æ‹†å‡ºæ¥ awk '/-----BEGIN CERTIFICATE-----/,/-----END CERTIFICATE-----/ {print} /-----END CERTIFICATE-----/ {exit}' _.rendoumi.com.crt > _.rendoumi.com.only # --- é…ç½®éƒ¨åˆ† --- # æ‚¨è¦æ›´æ–°çš„ç°æœ‰ ACM è¯ä¹¦çš„ ARN # ç¤ºä¾‹ï¼šCERTIFICATE_ARN="arn:aws:acm:ap-southeast-1:123456789012:certificate/abcdefab-1234-5678-abcd-1234567890ab" CERTIFICATE_ARN="arn:aws:acm:ap-southeast-1:111111111111:certificate/11111111-1111-1111-1111-111111111111" # æ–°è¯ä¹¦æ–‡ä»¶çš„è·¯å¾„ï¼ˆä¾‹å¦‚ï¼š/opt/certs/new_certificate.crtï¼‰ # ç¡®ä¿è¿™ä¸ªè·¯å¾„åœ¨æ‚¨çš„EC2å®ä¾‹ä¸Šæ˜¯æ­£ç¡®çš„ CERTIFICATE_BODY_PATH="_.rendoumi.com.only" # æ–°ç§é’¥æ–‡ä»¶çš„è·¯å¾„ï¼ˆä¾‹å¦‚ï¼š/opt/certs/private.keyï¼‰ # ç¡®ä¿è¿™ä¸ªè·¯å¾„åœ¨æ‚¨çš„EC2å®ä¾‹ä¸Šæ˜¯æ­£ç¡®çš„ PRIVATE_KEY_PATH="_.rendoumi.com.key" # è¯ä¹¦é“¾æ–‡ä»¶çš„è·¯å¾„ï¼ˆå¯é€‰ï¼‰ # å¦‚æœæ²¡æœ‰è¯ä¹¦é“¾ï¼Œè¯·å°†æ­¤å˜é‡ç•™ç©ºæˆ–æ³¨é‡Šæ‰ # ç¤ºä¾‹ï¼šCERTIFICATE_CHAIN_PATH="/opt/certs/ca_bundle.crt" CERTIFICATE_CHAIN_PATH="_.rendoumi.com.issuer.crt" # å¦‚æœæ²¡æœ‰é“¾ï¼Œè¯·å°†å…¶ç•™ç©º "" # ACM è¯ä¹¦æ‰€åœ¨çš„ AWS åŒºåŸŸ # è¿™ä¸ªåŒºåŸŸåº”è¯¥ä¸ CERTIFICATE_ARN ä¸­çš„åŒºåŸŸåŒ¹é… # ç¤ºä¾‹ï¼šAWS_REGION="ap-southeast-1" AWS_REGION="ap-southeast-1" # --- é…ç½®éƒ¨åˆ†ç»“æŸ --- echo "--- å¼€å§‹ä½¿ç”¨å®ä¾‹è§’è‰²é‡æ–°å¯¼å…¥ ACM è¯ä¹¦ ---" echo "è¯ä¹¦ ARN: ${CERTIFICATE_ARN}" echo "åŒºåŸŸ: ${AWS_REGION}" # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ if [ ! -f "${CERTIFICATE_BODY_PATH}" ]; then echo "é”™è¯¯ï¼šè¯ä¹¦æ–‡ä»¶ '${CERTIFICATE_BODY_PATH}' ä¸å­˜åœ¨ã€‚" exit 1 fi if [ ! -f "${PRIVATE_KEY_PATH}" ]; then echo "é”™è¯¯ï¼šç§é’¥æ–‡ä»¶ '${PRIVATE_KEY_PATH}' ä¸å­˜åœ¨ã€‚" exit 1 fi if [ -n "${CERTIFICATE_CHAIN_PATH}" ] && [ ! -f "${CERTIFICATE_CHAIN_PATH}" ]; then echo "è­¦å‘Šï¼šè¯ä¹¦é“¾æ–‡ä»¶ '${CERTIFICATE_CHAIN_PATH}' å·²æŒ‡å®šä½†ä¸å­˜åœ¨ã€‚å°†ä¸åŒ…å«è¯ä¹¦é“¾è¿›è¡Œå¯¼å…¥ã€‚" CERTIFICATE_CHAIN_PATH="" # å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™æ¸…ç©ºè·¯å¾„ fi # æ„é€  AWS CLI å‘½ä»¤ã€‚AWS CLI ä¼šè‡ªåŠ¨ä½¿ç”¨å®ä¾‹è§’è‰²æä¾›çš„å‡­è¯ã€‚ IMPORT_CMD="aws acm import-certificate \ --certificate-arn ${CERTIFICATE_ARN} \ --certificate fileb://${CERTIFICATE_BODY_PATH} \ --private-key fileb://${PRIVATE_KEY_PATH} \ --region \"${AWS_REGION}\"" # å¦‚æœæœ‰è¯ä¹¦é“¾ï¼Œåˆ™æ·»åŠ åˆ°å‘½ä»¤ä¸­ if [ -n "${CERTIFICATE_CHAIN_PATH}" ]; then IMPORT_CMD="${IMPORT_CMD} --certificate-chain fileb://${CERTIFICATE_CHAIN_PATH}" fi echo "æ­£åœ¨æ‰§è¡Œå‘½ä»¤ï¼š" echo "$IMPORT_CMD" echo "--------------------------" # æ‰§è¡Œå‘½ä»¤ # æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬ä¸æŒ‡å®š --profile æˆ–ä»»ä½•å‡­è¯ï¼ŒAWS CLI ä¼šè‡ªåŠ¨ä½¿ç”¨å®ä¾‹IAMè§’è‰²ã€‚ eval $IMPORT_CMD # æ£€æŸ¥å‘½ä»¤æ‰§è¡Œç»“æœ if [ $? -eq 0 ]; then echo "--- è¯ä¹¦é‡æ–°å¯¼å…¥æˆåŠŸï¼---" echo "ACM è¯ä¹¦ ${CERTIFICATE_ARN} å·²æ›´æ–°ã€‚" else echo "--- è¯ä¹¦é‡æ–°å¯¼å…¥å¤±è´¥ï¼---" echo "è¯·æ£€æŸ¥é”™è¯¯æ¶ˆæ¯ï¼Œç¡®ä¿ï¼š" echo "1. EC2 å®ä¾‹å·²æ­£ç¡®é™„åŠ äº†å…·æœ‰ acm:ImportCertificate æƒé™çš„ IAM è§’è‰²ã€‚" echo "2. è¯ä¹¦ã€ç§é’¥å’Œé“¾æ–‡ä»¶è·¯å¾„æ­£ç¡®ä¸”å¯è¯»ã€‚" echo "3. è¯ä¹¦/ç§é’¥/é“¾çš„æ ¼å¼æ­£ç¡®ã€‚" fi echo "--- è„šæœ¬æ‰§è¡Œå®Œæ¯• ---" çœ‹èµ·æ¥çœŸçš„æ˜¯åˆè‡­åˆé•¿ï¼ŒåºŸè¯è¿ç¯‡ã€‚æ³¨æ„ï¼šgemini ç”Ÿæˆçš„ä»£ç æœ‰é—®é¢˜ï¼Œaws acm import-certificate çš„å‚æ•°ä¸­ï¼Œè¯ä¹¦æ–‡ä»¶çš„å‰ç¼€æ˜¯fileb://ï¼Œgeminiç»™çš„æ˜¯file://ï¼Œè°ƒè¯•äº†åŠå¤©ï¼Œæœ€åå»awsçœ‹äº†æ–‡æ¡£æ‰å‘ç°ã€‚
...</p></div><footer class=entry-footer><span title='2025-07-25 10:01:11 +0800 CST'>2025å¹´7æœˆ25æ—¥</span></footer><a class=entry-link aria-label="post link to awsçš„EC2æœåŠ¡å™¨ç”¨legoè·å¾—å…è´¹è¯ä¹¦å¹¶æ›´æ–°åˆ°ACM" href=https://rendoumi.com/posts/20250725-aws_route53_update_certificate/></a></article><div class=pagination><ul class=pagination-list><li class="page-item first"><a class=page-link href=/posts/ aria-label="First Page"><span aria-hidden=true>&#9668;</span></a></li><li class="page-item prev"><a class=page-link href=/posts/page/3/ aria-label=Previous><span aria-hidden=true>&#171;</span></a></li><li class=page-item><a class=page-link href=/posts/>1</a></li><li class=page-item><a class=page-link href=/posts/page/2/>2</a></li><li class=page-item><a class=page-link href=/posts/page/3/>3</a></li><li class="page-item active"><span class=page-link aria-current=page>4</span></li><li class=page-item><a class=page-link href=/posts/page/5/>5</a></li><li class=page-item><a class=page-link href=/posts/page/6/>6</a></li><li class=page-item><a class=page-link href=/posts/page/7/>7</a></li><li class=page-item><a class=page-link href=/posts/page/8/>8</a></li><li class="page-item next"><a class=page-link href=/posts/page/5/ aria-label=Next><span aria-hidden=true>&#187;</span></a></li><li class="page-item last"><a class=page-link href=/posts/page/35/ aria-label="Last Page"><span aria-hidden=true>&#9658;</span></a></li></ul><div class=total-pages>å…± 35 é¡µ</div></div></main><footer class=footer><span>Copyright Â© 2020-2025 Zhang Ranrui. All Rights Reserved.</span><br>Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script></body></html>