<!doctype html><html lang=zh dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3988508441804851" crossorigin=anonymous></script><title>KVM下附加硬盘的passthrough直通 | 八戒的技术博客</title>
<meta name=keywords content><meta name=description content="这个比较有意思，同事要存放 2TB 的数据，但是系统是 1.7TB 的 4 块 600G 盘组成的 Raid10。
很明显盘空间不够了，去库房找两块 10TB 的大盘组成 Raid1 给他用好了。
问题来了，系统是 KVM 虚机，怎样把这个 10TB 的大盘给送进虚机呢？
这里面还真有要注意的问题：

Important
Guest virtual machines should not be given write access to whole disks or block devices (for example, /dev/sdb). Guest virtual  machines with access to whole block devices may be able to modify  volume labels, which can be used to compromise the host physical  machine system. Use partitions (for example, /dev/sdb1) or LVM  volumes to prevent this issue."><meta name=author content><link rel=canonical href=https://rendoumi.com/posts/20211119-kvm_disk_passthrough/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.5d8a858b4ad07d913988e10d3c3dbc8c171f45316a396de8a60d67f44840812d.css integrity="sha256-XYqFi0rQfZE5iOENPD28jBcfRTFqOW3opg1n9EhAgS0=" rel="preload stylesheet" as=style><link rel=icon href=https://rendoumi.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://rendoumi.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://rendoumi.com/favicon-32x32.png><link rel=apple-touch-icon href=https://rendoumi.com/apple-touch-icon.png><link rel=mask-icon href=https://rendoumi.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://rendoumi.com/posts/20211119-kvm_disk_passthrough/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><meta property="og:url" content="https://rendoumi.com/posts/20211119-kvm_disk_passthrough/"><meta property="og:site_name" content="八戒的技术博客"><meta property="og:title" content="KVM下附加硬盘的passthrough直通"><meta property="og:description" content="这个比较有意思，同事要存放 2TB 的数据，但是系统是 1.7TB 的 4 块 600G 盘组成的 Raid10。
很明显盘空间不够了，去库房找两块 10TB 的大盘组成 Raid1 给他用好了。
问题来了，系统是 KVM 虚机，怎样把这个 10TB 的大盘给送进虚机呢？
这里面还真有要注意的问题：
Important
Guest virtual machines should not be given write access to whole disks or block devices (for example, /dev/sdb). Guest virtual machines with access to whole block devices may be able to modify volume labels, which can be used to compromise the host physical machine system. Use partitions (for example, /dev/sdb1) or LVM volumes to prevent this issue."><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-11-19T10:30:11+08:00"><meta property="article:modified_time" content="2021-11-19T10:30:11+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="KVM下附加硬盘的passthrough直通"><meta name=twitter:description content="这个比较有意思，同事要存放 2TB 的数据，但是系统是 1.7TB 的 4 块 600G 盘组成的 Raid10。
很明显盘空间不够了，去库房找两块 10TB 的大盘组成 Raid1 给他用好了。
问题来了，系统是 KVM 虚机，怎样把这个 10TB 的大盘给送进虚机呢？
这里面还真有要注意的问题：

Important
Guest virtual machines should not be given write access to whole disks or block devices (for example, /dev/sdb). Guest virtual  machines with access to whole block devices may be able to modify  volume labels, which can be used to compromise the host physical  machine system. Use partitions (for example, /dev/sdb1) or LVM  volumes to prevent this issue."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"所有文章","item":"https://rendoumi.com/posts/"},{"@type":"ListItem","position":2,"name":"KVM下附加硬盘的passthrough直通","item":"https://rendoumi.com/posts/20211119-kvm_disk_passthrough/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"KVM下附加硬盘的passthrough直通","name":"KVM下附加硬盘的passthrough直通","description":"这个比较有意思，同事要存放 2TB 的数据，但是系统是 1.7TB 的 4 块 600G 盘组成的 Raid10。\n很明显盘空间不够了，去库房找两块 10TB 的大盘组成 Raid1 给他用好了。\n问题来了，系统是 KVM 虚机，怎样把这个 10TB 的大盘给送进虚机呢？\n这里面还真有要注意的问题：\nImportant\nGuest virtual machines should not be given write access to whole disks or block devices (for example, /dev/sdb). Guest virtual machines with access to whole block devices may be able to modify volume labels, which can be used to compromise the host physical machine system. Use partitions (for example, /dev/sdb1) or LVM volumes to prevent this issue.\n","keywords":[],"articleBody":"这个比较有意思，同事要存放 2TB 的数据，但是系统是 1.7TB 的 4 块 600G 盘组成的 Raid10。\n很明显盘空间不够了，去库房找两块 10TB 的大盘组成 Raid1 给他用好了。\n问题来了，系统是 KVM 虚机，怎样把这个 10TB 的大盘给送进虚机呢？\n这里面还真有要注意的问题：\nImportant\nGuest virtual machines should not be given write access to whole disks or block devices (for example, /dev/sdb). Guest virtual machines with access to whole block devices may be able to modify volume labels, which can be used to compromise the host physical machine system. Use partitions (for example, /dev/sdb1) or LVM volumes to prevent this issue.\n注意上面的说明，是不建议将整个硬盘送进虚机里面去的，建议是送分区进去，避免会写坏整个盘。\n所以先把盘的分区做好，格式化并挂载，以 /dev/sdb 为例\nparted -s /dev/sdb mklabel gpt mkpart primary 0% 100% mkfs.xfs /dev/sdb1 mount -t xfs /dev/sdb1 /mnt/sdb1 然后到实体机的磁盘目录\n# cd /dev/disk/ # ls by-id by-path by-uuid # cd by-id # ll total 0 lrwxrwxrwx 1 root root 9 3月 26 2018 scsi-36b083fe0e4f71a001c36c36716543d4d -\u003e ../../sda lrwxrwxrwx 1 root root 10 3月 26 2018 scsi-36b083fe0e4f71a001c36c36716543d4d-part1 -\u003e ../../sda1 lrwxrwxrwx 1 root root 10 3月 26 2018 scsi-36b083fe0e4f71a001c36c36716543d4d-part2 -\u003e ../../sda2 lrwxrwxrwx 1 root root 10 3月 26 2018 scsi-36b083fe0e4f71a001c36c36716543d4d-part3 -\u003e ../../sda3 lrwxrwxrwx 1 root root 9 11月 18 16:02 scsi-36b083fe0e4f71a002928bf63ef284827 -\u003e ../../sdb lrwxrwxrwx 1 root root 10 11月 18 16:24 scsi-36b083fe0e4f71a002928bf63ef284827-part1 -\u003e ../../sdb1 lrwxrwxrwx 1 root root 9 3月 26 2018 wwn-0x6b083fe0e4f71a001c36c36716543d4d -\u003e ../../sda lrwxrwxrwx 1 root root 10 3月 26 2018 wwn-0x6b083fe0e4f71a001c36c36716543d4d-part1 -\u003e ../../sda1 lrwxrwxrwx 1 root root 10 3月 26 2018 wwn-0x6b083fe0e4f71a001c36c36716543d4d-part2 -\u003e ../../sda2 lrwxrwxrwx 1 root root 10 3月 26 2018 wwn-0x6b083fe0e4f71a001c36c36716543d4d-part3 -\u003e ../../sda3 lrwxrwxrwx 1 root root 9 11月 18 16:02 wwn-0x6b083fe0e4f71a002928bf63ef284827 -\u003e ../../sdb lrwxrwxrwx 1 root root 10 11月 18 16:24 wwn-0x6b083fe0e4f71a002928bf63ef284827-part1 -\u003e ../../sdb1 看中间一行，scsi-36b083fe0e4f71a002928bf63ef284827-part1 指向 /dev/sdb1，记录下来\n然后 virsh-edit 编辑 KVM 虚机文件，增加硬盘部分：\n","wordCount":"327","inLanguage":"zh","datePublished":"2021-11-19T10:30:11+08:00","dateModified":"2021-11-19T10:30:11+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://rendoumi.com/posts/20211119-kvm_disk_passthrough/"},"publisher":{"@type":"Organization","name":"八戒的技术博客","logo":{"@type":"ImageObject","url":"https://rendoumi.com/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://rendoumi.com/ accesskey=h title="八戒的技术博客 (Alt + H)">八戒的技术博客</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://rendoumi.com/ title=首页><span>首页</span></a></li><li><a href=https://rendoumi.com/posts/ title=文章><span>文章</span></a></li><li><a href=https://rendoumi.com/archives/ title=归档><span>归档</span></a></li><li><a href=https://blog.rendoumi.com title=生活><span>生活</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://rendoumi.com/search/ title=搜索><span>搜索</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">KVM下附加硬盘的passthrough直通
<span class=entry-hint title=Draft><svg height="35" viewBox="0 -960 960 960" fill="currentcolor"><path d="M160-410v-60h3e2v60H160zm0-165v-60h470v60H160zm0-165v-60h470v60H160zm360 580v-123l221-220q9-9 20-13t22-4q12 0 23 4.5t20 13.5l37 37q9 9 13 20t4 22-4.5 22.5T862.09-380L643-160H520zm3e2-263-37-37 37 37zM580-220h38l121-122-18-19-19-18-122 121v38zm141-141-19-18 37 37-18-19z"/></svg></span></h1><div class=post-meta><span title='2021-11-19 10:30:11 +0800 CST'>2021年11月19日</span></div></header><div class=post-content><p>这个比较有意思，同事要存放 2TB 的数据，但是系统是 1.7TB 的 4 块 600G 盘组成的 Raid10。</p><p>很明显盘空间不够了，去库房找两块 10TB 的大盘组成 Raid1 给他用好了。</p><p>问题来了，系统是 KVM 虚机，怎样把这个 10TB 的大盘给送进虚机呢？</p><p>这里面还真有要注意的问题：</p><blockquote><p>Important</p><p><strong>Guest virtual machines should not be given write access to whole disks or block devices (for example, /dev/sdb).</strong> Guest virtual machines with access to whole block devices may be able to modify volume labels, which can be used to compromise the host physical machine system. <strong>Use partitions (for example, /dev/sdb1) or LVM volumes to prevent this issue.</strong></p></blockquote><p>注意上面的说明，是不建议将整个硬盘送进虚机里面去的，建议是送<strong>分区</strong>进去，避免会写坏整个盘。</p><p>所以先把盘的分区做好，格式化并挂载，以 /dev/sdb 为例</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>parted -s /dev/sdb mklabel gpt mkpart primary 0% 100%
</span></span><span class=line><span class=cl>mkfs.xfs /dev/sdb1
</span></span><span class=line><span class=cl>mount -t xfs /dev/sdb1 /mnt/sdb1
</span></span></code></pre></div><p>然后到实体机的磁盘目录</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># cd /dev/disk/</span>
</span></span><span class=line><span class=cl><span class=c1># ls</span>
</span></span><span class=line><span class=cl>by-id  by-path  by-uuid
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># cd by-id</span>
</span></span><span class=line><span class=cl><span class=c1># ll</span>
</span></span><span class=line><span class=cl>total <span class=m>0</span>
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root  <span class=m>9</span> 3月  <span class=m>26</span> <span class=m>2018</span> scsi-36b083fe0e4f71a001c36c36716543d4d -&gt; ../../sda
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root <span class=m>10</span> 3月  <span class=m>26</span> <span class=m>2018</span> scsi-36b083fe0e4f71a001c36c36716543d4d-part1 -&gt; ../../sda1
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root <span class=m>10</span> 3月  <span class=m>26</span> <span class=m>2018</span> scsi-36b083fe0e4f71a001c36c36716543d4d-part2 -&gt; ../../sda2
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root <span class=m>10</span> 3月  <span class=m>26</span> <span class=m>2018</span> scsi-36b083fe0e4f71a001c36c36716543d4d-part3 -&gt; ../../sda3
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root  <span class=m>9</span> 11月 <span class=m>18</span> 16:02 scsi-36b083fe0e4f71a002928bf63ef284827 -&gt; ../../sdb
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root <span class=m>10</span> 11月 <span class=m>18</span> 16:24 scsi-36b083fe0e4f71a002928bf63ef284827-part1 -&gt; ../../sdb1
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root  <span class=m>9</span> 3月  <span class=m>26</span> <span class=m>2018</span> wwn-0x6b083fe0e4f71a001c36c36716543d4d -&gt; ../../sda
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root <span class=m>10</span> 3月  <span class=m>26</span> <span class=m>2018</span> wwn-0x6b083fe0e4f71a001c36c36716543d4d-part1 -&gt; ../../sda1
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root <span class=m>10</span> 3月  <span class=m>26</span> <span class=m>2018</span> wwn-0x6b083fe0e4f71a001c36c36716543d4d-part2 -&gt; ../../sda2
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root <span class=m>10</span> 3月  <span class=m>26</span> <span class=m>2018</span> wwn-0x6b083fe0e4f71a001c36c36716543d4d-part3 -&gt; ../../sda3
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root  <span class=m>9</span> 11月 <span class=m>18</span> 16:02 wwn-0x6b083fe0e4f71a002928bf63ef284827 -&gt; ../../sdb
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root <span class=m>10</span> 11月 <span class=m>18</span> 16:24 wwn-0x6b083fe0e4f71a002928bf63ef284827-part1 -&gt; ../../sdb1
</span></span></code></pre></div><p><img alt=image-20211119163327664 loading=lazy src=/posts/20211119-kvm_disk_passthrough/image-20211119163327664.png></p><p>看中间一行，scsi-36b083fe0e4f71a002928bf63ef284827-part1 指向 /dev/sdb1，记录下来</p><p>然后 virsh-edit 编辑 KVM 虚机文件，增加硬盘部分：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl>    <span class=na>&lt;disk type</span><span class=o>=</span><span class=s>&#39;block&#39; device=&#39;disk&#39;&gt;
</span></span></span><span class=line><span class=cl><span class=s>      &lt;driver name=&#39;qemu&#39; type=&#39;raw&#39;/&gt;
</span></span></span><span class=line><span class=cl><span class=s>      &lt;source dev=&#39;/dev/disk/by-id/scsi-36b083fe0e4f71a002928bf63ef284827-part1&#39;/&gt;
</span></span></span><span class=line><span class=cl><span class=s>      &lt;target dev=&#39;vda&#39; bus=&#39;virtio&#39;/&gt;
</span></span></span><span class=line><span class=cl><span class=s>    &lt;/disk&gt;</span>
</span></span></code></pre></div><p>注：上面我们是使用了 by-id，当然也可以使用 by-path 和 by-uuid 来指定源盘</p><p>重启虚机并进入查看，我们能看到这块盘盘符是 /dev/vda</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>fdisk -l
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Disk /dev/vda: 11755.9 GB, <span class=m>11755860262912</span> bytes, <span class=m>22960664576</span> sectors
</span></span><span class=line><span class=cl><span class=nv>Units</span> <span class=o>=</span> sectors of <span class=m>1</span> * <span class=nv>512</span> <span class=o>=</span> <span class=m>512</span> bytes
</span></span><span class=line><span class=cl>Sector size <span class=o>(</span>logical/physical<span class=o>)</span>: <span class=m>512</span> bytes / <span class=m>512</span> bytes
</span></span><span class=line><span class=cl>I/O size <span class=o>(</span>minimum/optimal<span class=o>)</span>: <span class=m>512</span> bytes / <span class=m>512</span> bytes
</span></span></code></pre></div><p>接下来就比较怪异了，这个盘分明没有分区，我们却可以直接 mount</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mount -t xfs /dev/vda /material
</span></span></code></pre></div><p>然后 df -h 再看</p><p><img alt=image-20211119164054485 loading=lazy src=/posts/20211119-kvm_disk_passthrough/image-20211119164054485.png></p><p>能认出来，正常使用就行了。</p><p>非常古怪是吧。</p><p>大家还要注意实体机的挂载路径是 /mnt/sdb1，虚机内的挂载路径是 /material，这两个路径都是指向同一块盘，可以共通。</p></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>Copyright © 2020-2025 Zhang Ranrui. All Rights Reserved.</span><br>·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script></body></html>