<!doctype html><html lang=zh dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3988508441804851" crossorigin=anonymous></script><title>L2TP VPN在CentOS7系统下的搭建 | 八戒的技术博客</title>
<meta name=keywords content><meta name=description content="这是个很奇怪的事情，应聘了一家搞 CDN 的公司，结果上去看了一下根本不对路。就立刻辞了，但是发现它给员工开的 L2TP VPN 确实非常好用。
于是就自己也搭一个，方便自用。下面记录一下安装过程，环境是CentOS 7
一、装L2TP
# yum install epel-release
# yum install xl2tpd libreswan
二、修改核心参数
# vi /etc/sysctl.conf

vm.swappiness = 0
net.ipv4.neigh.default.gc_stale_time=120
net.ipv4.conf.all.rp_filter=0
net.ipv4.conf.default.rp_filter=0
net.ipv4.conf.default.arp_announce = 2
net.ipv4.conf.all.arp_announce=2
net.ipv4.tcp_max_tw_buckets = 5000
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_max_syn_backlog = 1024
net.ipv4.tcp_synack_retries = 2
net.ipv4.conf.lo.arp_announce=2
net.ipv4.ip_forward = 1
net.ipv4.conf.default.accept_redirects = 0
net.ipv4.conf.default.send_redirects = 0
net.ipv4.conf.default.accept_source_route = 0

# sysctl -p
三、配置 IPSEC
# vi /etc/ipsec.d/l2tp_psk.conf

conn L2TP-PSK-NAT
     rightsubnet=vhost:%priv
     also=L2TP-PSK-noNAT
conn L2TP-PSK-noNAT
     authby=secret
     pfs=no
     auto=add
     keyingtries=3
     dpddelay=30
     dpdtimeout=120
     dpdaction=clear
     rekey=no
     ikelifetime=8h
     keylife=1h
     type=transport
     left=192.168.10.232
     leftprotoport=17/1701
     right=%any
     rightprotoport=17/%any
注意上面的 left=192.168.10.232，这是服务器的ip地址，要更换为自己服务器的地址（如果在防火墙后，写内网地址，非映射后的公网IP）"><meta name=author content><link rel=canonical href=https://rendoumi.com/posts/20221113-l2tp_vpn/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.181dcf08b5d0ad7a24019e99c09910b83c66dc2a9b7be7a1215b3bb7af4cc829.css integrity="sha256-GB3PCLXQrXokAZ6ZwJkQuDxm3Cqbe+ehIVs7t69MyCk=" rel="preload stylesheet" as=style><link rel=icon href=https://rendoumi.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://rendoumi.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://rendoumi.com/favicon-32x32.png><link rel=apple-touch-icon href=https://rendoumi.com/apple-touch-icon.png><link rel=mask-icon href=https://rendoumi.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://rendoumi.com/posts/20221113-l2tp_vpn/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><meta property="og:url" content="https://rendoumi.com/posts/20221113-l2tp_vpn/"><meta property="og:site_name" content="八戒的技术博客"><meta property="og:title" content="L2TP VPN在CentOS7系统下的搭建"><meta property="og:description" content="这是个很奇怪的事情，应聘了一家搞 CDN 的公司，结果上去看了一下根本不对路。就立刻辞了，但是发现它给员工开的 L2TP VPN 确实非常好用。
于是就自己也搭一个，方便自用。下面记录一下安装过程，环境是CentOS 7
一、装L2TP # yum install epel-release # yum install xl2tpd libreswan 二、修改核心参数 # vi /etc/sysctl.conf vm.swappiness = 0 net.ipv4.neigh.default.gc_stale_time=120 net.ipv4.conf.all.rp_filter=0 net.ipv4.conf.default.rp_filter=0 net.ipv4.conf.default.arp_announce = 2 net.ipv4.conf.all.arp_announce=2 net.ipv4.tcp_max_tw_buckets = 5000 net.ipv4.tcp_syncookies = 1 net.ipv4.tcp_max_syn_backlog = 1024 net.ipv4.tcp_synack_retries = 2 net.ipv4.conf.lo.arp_announce=2 net.ipv4.ip_forward = 1 net.ipv4.conf.default.accept_redirects = 0 net.ipv4.conf.default.send_redirects = 0 net.ipv4.conf.default.accept_source_route = 0 # sysctl -p 三、配置 IPSEC # vi /etc/ipsec.d/l2tp_psk.conf conn L2TP-PSK-NAT rightsubnet=vhost:%priv also=L2TP-PSK-noNAT conn L2TP-PSK-noNAT authby=secret pfs=no auto=add keyingtries=3 dpddelay=30 dpdtimeout=120 dpdaction=clear rekey=no ikelifetime=8h keylife=1h type=transport left=192.168.10.232 leftprotoport=17/1701 right=%any rightprotoport=17/%any 注意上面的 left=192.168.10.232，这是服务器的ip地址，要更换为自己服务器的地址（如果在防火墙后，写内网地址，非映射后的公网IP）"><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-11-13T10:30:11+08:00"><meta property="article:modified_time" content="2022-11-13T10:30:11+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="L2TP VPN在CentOS7系统下的搭建"><meta name=twitter:description content="这是个很奇怪的事情，应聘了一家搞 CDN 的公司，结果上去看了一下根本不对路。就立刻辞了，但是发现它给员工开的 L2TP VPN 确实非常好用。
于是就自己也搭一个，方便自用。下面记录一下安装过程，环境是CentOS 7
一、装L2TP
# yum install epel-release
# yum install xl2tpd libreswan
二、修改核心参数
# vi /etc/sysctl.conf

vm.swappiness = 0
net.ipv4.neigh.default.gc_stale_time=120
net.ipv4.conf.all.rp_filter=0
net.ipv4.conf.default.rp_filter=0
net.ipv4.conf.default.arp_announce = 2
net.ipv4.conf.all.arp_announce=2
net.ipv4.tcp_max_tw_buckets = 5000
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_max_syn_backlog = 1024
net.ipv4.tcp_synack_retries = 2
net.ipv4.conf.lo.arp_announce=2
net.ipv4.ip_forward = 1
net.ipv4.conf.default.accept_redirects = 0
net.ipv4.conf.default.send_redirects = 0
net.ipv4.conf.default.accept_source_route = 0

# sysctl -p
三、配置 IPSEC
# vi /etc/ipsec.d/l2tp_psk.conf

conn L2TP-PSK-NAT
     rightsubnet=vhost:%priv
     also=L2TP-PSK-noNAT
conn L2TP-PSK-noNAT
     authby=secret
     pfs=no
     auto=add
     keyingtries=3
     dpddelay=30
     dpdtimeout=120
     dpdaction=clear
     rekey=no
     ikelifetime=8h
     keylife=1h
     type=transport
     left=192.168.10.232
     leftprotoport=17/1701
     right=%any
     rightprotoport=17/%any
注意上面的 left=192.168.10.232，这是服务器的ip地址，要更换为自己服务器的地址（如果在防火墙后，写内网地址，非映射后的公网IP）"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"所有文章","item":"https://rendoumi.com/posts/"},{"@type":"ListItem","position":2,"name":"L2TP VPN在CentOS7系统下的搭建","item":"https://rendoumi.com/posts/20221113-l2tp_vpn/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"L2TP VPN在CentOS7系统下的搭建","name":"L2TP VPN在CentOS7系统下的搭建","description":"这是个很奇怪的事情，应聘了一家搞 CDN 的公司，结果上去看了一下根本不对路。就立刻辞了，但是发现它给员工开的 L2TP VPN 确实非常好用。\n于是就自己也搭一个，方便自用。下面记录一下安装过程，环境是CentOS 7\n一、装L2TP # yum install epel-release # yum install xl2tpd libreswan 二、修改核心参数 # vi /etc/sysctl.conf vm.swappiness = 0 net.ipv4.neigh.default.gc_stale_time=120 net.ipv4.conf.all.rp_filter=0 net.ipv4.conf.default.rp_filter=0 net.ipv4.conf.default.arp_announce = 2 net.ipv4.conf.all.arp_announce=2 net.ipv4.tcp_max_tw_buckets = 5000 net.ipv4.tcp_syncookies = 1 net.ipv4.tcp_max_syn_backlog = 1024 net.ipv4.tcp_synack_retries = 2 net.ipv4.conf.lo.arp_announce=2 net.ipv4.ip_forward = 1 net.ipv4.conf.default.accept_redirects = 0 net.ipv4.conf.default.send_redirects = 0 net.ipv4.conf.default.accept_source_route = 0 # sysctl -p 三、配置 IPSEC # vi /etc/ipsec.d/l2tp_psk.conf conn L2TP-PSK-NAT rightsubnet=vhost:%priv also=L2TP-PSK-noNAT conn L2TP-PSK-noNAT authby=secret pfs=no auto=add keyingtries=3 dpddelay=30 dpdtimeout=120 dpdaction=clear rekey=no ikelifetime=8h keylife=1h type=transport left=192.168.10.232 leftprotoport=17/1701 right=%any rightprotoport=17/%any 注意上面的 left=192.168.10.232，这是服务器的ip地址，要更换为自己服务器的地址（如果在防火墙后，写内网地址，非映射后的公网IP）\n","keywords":[],"articleBody":"这是个很奇怪的事情，应聘了一家搞 CDN 的公司，结果上去看了一下根本不对路。就立刻辞了，但是发现它给员工开的 L2TP VPN 确实非常好用。\n于是就自己也搭一个，方便自用。下面记录一下安装过程，环境是CentOS 7\n一、装L2TP # yum install epel-release # yum install xl2tpd libreswan 二、修改核心参数 # vi /etc/sysctl.conf vm.swappiness = 0 net.ipv4.neigh.default.gc_stale_time=120 net.ipv4.conf.all.rp_filter=0 net.ipv4.conf.default.rp_filter=0 net.ipv4.conf.default.arp_announce = 2 net.ipv4.conf.all.arp_announce=2 net.ipv4.tcp_max_tw_buckets = 5000 net.ipv4.tcp_syncookies = 1 net.ipv4.tcp_max_syn_backlog = 1024 net.ipv4.tcp_synack_retries = 2 net.ipv4.conf.lo.arp_announce=2 net.ipv4.ip_forward = 1 net.ipv4.conf.default.accept_redirects = 0 net.ipv4.conf.default.send_redirects = 0 net.ipv4.conf.default.accept_source_route = 0 # sysctl -p 三、配置 IPSEC # vi /etc/ipsec.d/l2tp_psk.conf conn L2TP-PSK-NAT rightsubnet=vhost:%priv also=L2TP-PSK-noNAT conn L2TP-PSK-noNAT authby=secret pfs=no auto=add keyingtries=3 dpddelay=30 dpdtimeout=120 dpdaction=clear rekey=no ikelifetime=8h keylife=1h type=transport left=192.168.10.232 leftprotoport=17/1701 right=%any rightprotoport=17/%any 注意上面的 left=192.168.10.232，这是服务器的ip地址，要更换为自己服务器的地址（如果在防火墙后，写内网地址，非映射后的公网IP）\n然后修改密钥，之后建立L2TP的 iphone 连接时会用到：\n# vim /etc/ipsec.secrets 192.168.10.232 %any: PSK \"123456789\" 验证一下：\n# ipsec setup start\r# ipsec verify 看到上面两行红字不要慌张，Ignore，忽略掉即可。是内核特性中的reverse path filter特性，没关系。\n然后让 ipsec 自启动\n# systemctl enable ipsec 四、配置xl2tpd # 先备份 # mv /etc/xl2tpd/xl2tpd.conf /etc/xl2tpd/xl2tpd.conf.old # vim /etc/xl2tpd/xl2tpd.conf [global] listen-addr = 192.168.10.232 ipsec saref = yes [lns default] ip range = 192.168.100.128-192.168.100.254 local ip = 192.168.100.99 require chap = yes refuse pap = yes require authentication = yes name = LinuxVPNserver ppp debug = yes pppoptfile = /etc/ppp/options.xl2tpd length bit = yes 注意更换上面 192.168.10.232 的服务器ip地址，同时记住name=LinuxVPNserver\n# 先备份 # mv /etc/ppp/options.xl2tpd /etc/ppp/options.xl2tpd.old # vim /etc/ppp/options.xl2tpd ipcp-accept-local ipcp-accept-remote ms-dns 8.8.8.8 ms-dns 4.2.2.4 noccp #noauth crtscts idle 1800 mtu 1410 mru 1410 nodefaultroute debug lock proxyarp connect-delay 5000 最后编辑用户名和密码\nvim /etc/ppp/chap-secrets # Secrets for authentication using CHAP # client server secret IP addresses test LinuxVPNserver test * 注意格式，第一列是用户名，第二列是上面xl2tpd.conf中记住的name名，第三列是密码，第四列是获取到的ip地址\n然后启动\n# systemctl start xl2tpd # systemctl enable xl2tpd # systemctl status xl2tpd 五、配置防火墙 iptables -A INPUT -p gre -j ACCEPT iptables -A OUTPUT -p gre -j ACCEPT iptables -A FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT iptables -A FORWARD -s 192.168.100.0/24 -j ACCEPT iptables -t nat -A POSTROUTING -s 192.168.100.0/24 -o eth0 -j MASQUERADE 注意上面的eth0，根据服务器的具体情况进行修改\n然后这样就完成了。\n六、配置iphone手机 配置好服务器ip，账户，密码以及密钥就可以了。\n","wordCount":"282","inLanguage":"zh","datePublished":"2022-11-13T10:30:11+08:00","dateModified":"2022-11-13T10:30:11+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://rendoumi.com/posts/20221113-l2tp_vpn/"},"publisher":{"@type":"Organization","name":"八戒的技术博客","logo":{"@type":"ImageObject","url":"https://rendoumi.com/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://rendoumi.com/ accesskey=h title="八戒的技术博客 (Alt + H)">八戒的技术博客</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://rendoumi.com/ title=首页><span>首页</span></a></li><li><a href=https://rendoumi.com/posts/ title=文章><span>文章</span></a></li><li><a href=https://rendoumi.com/archives/ title=归档><span>归档</span></a></li><li><a href=https://blog.rendoumi.com title=生活><span>生活</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://rendoumi.com/search/ title=搜索><span>搜索</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">L2TP VPN在CentOS7系统下的搭建
<span class=entry-hint title=Draft><svg height="35" viewBox="0 -960 960 960" fill="currentcolor"><path d="M160-410v-60h3e2v60H160zm0-165v-60h470v60H160zm0-165v-60h470v60H160zm360 580v-123l221-220q9-9 20-13t22-4q12 0 23 4.5t20 13.5l37 37q9 9 13 20t4 22-4.5 22.5T862.09-380L643-160H520zm3e2-263-37-37 37 37zM580-220h38l121-122-18-19-19-18-122 121v38zm141-141-19-18 37 37-18-19z"/></svg></span></h1><div class=post-meta><span title='2022-11-13 10:30:11 +0800 CST'>2022年11月13日</span></div></header><div class=post-content><p>这是个很奇怪的事情，应聘了一家搞 CDN 的公司，结果上去看了一下根本不对路。就立刻辞了，但是发现它给员工开的 L2TP VPN 确实非常好用。</p><p>于是就自己也搭一个，方便自用。下面记录一下安装过程，环境是CentOS 7</p><h4 id=一装l2tp>一、装L2TP<a hidden class=anchor aria-hidden=true href=#一装l2tp>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># yum install epel-release</span>
</span></span><span class=line><span class=cl><span class=c1># yum install xl2tpd libreswan</span>
</span></span></code></pre></div><h4 id=二修改核心参数>二、修改核心参数<a hidden class=anchor aria-hidden=true href=#二修改核心参数>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># vi /etc/sysctl.conf</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>vm.swappiness <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>net.ipv4.neigh.default.gc_stale_time<span class=o>=</span><span class=m>120</span>
</span></span><span class=line><span class=cl>net.ipv4.conf.all.rp_filter<span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>net.ipv4.conf.default.rp_filter<span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>net.ipv4.conf.default.arp_announce <span class=o>=</span> <span class=m>2</span>
</span></span><span class=line><span class=cl>net.ipv4.conf.all.arp_announce<span class=o>=</span><span class=m>2</span>
</span></span><span class=line><span class=cl>net.ipv4.tcp_max_tw_buckets <span class=o>=</span> <span class=m>5000</span>
</span></span><span class=line><span class=cl>net.ipv4.tcp_syncookies <span class=o>=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>net.ipv4.tcp_max_syn_backlog <span class=o>=</span> <span class=m>1024</span>
</span></span><span class=line><span class=cl>net.ipv4.tcp_synack_retries <span class=o>=</span> <span class=m>2</span>
</span></span><span class=line><span class=cl>net.ipv4.conf.lo.arp_announce<span class=o>=</span><span class=m>2</span>
</span></span><span class=line><span class=cl>net.ipv4.ip_forward <span class=o>=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>net.ipv4.conf.default.accept_redirects <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>net.ipv4.conf.default.send_redirects <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>net.ipv4.conf.default.accept_source_route <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># sysctl -p</span>
</span></span></code></pre></div><h4 id=三配置-ipsec>三、配置 IPSEC<a hidden class=anchor aria-hidden=true href=#三配置-ipsec>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># vi /etc/ipsec.d/l2tp_psk.conf</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>conn L2TP-PSK-NAT
</span></span><span class=line><span class=cl>     <span class=nv>rightsubnet</span><span class=o>=</span>vhost:%priv
</span></span><span class=line><span class=cl>     <span class=nv>also</span><span class=o>=</span>L2TP-PSK-noNAT
</span></span><span class=line><span class=cl>conn L2TP-PSK-noNAT
</span></span><span class=line><span class=cl>     <span class=nv>authby</span><span class=o>=</span>secret
</span></span><span class=line><span class=cl>     <span class=nv>pfs</span><span class=o>=</span>no
</span></span><span class=line><span class=cl>     <span class=nv>auto</span><span class=o>=</span>add
</span></span><span class=line><span class=cl>     <span class=nv>keyingtries</span><span class=o>=</span><span class=m>3</span>
</span></span><span class=line><span class=cl>     <span class=nv>dpddelay</span><span class=o>=</span><span class=m>30</span>
</span></span><span class=line><span class=cl>     <span class=nv>dpdtimeout</span><span class=o>=</span><span class=m>120</span>
</span></span><span class=line><span class=cl>     <span class=nv>dpdaction</span><span class=o>=</span>clear
</span></span><span class=line><span class=cl>     <span class=nv>rekey</span><span class=o>=</span>no
</span></span><span class=line><span class=cl>     <span class=nv>ikelifetime</span><span class=o>=</span>8h
</span></span><span class=line><span class=cl>     <span class=nv>keylife</span><span class=o>=</span>1h
</span></span><span class=line><span class=cl>     <span class=nv>type</span><span class=o>=</span>transport
</span></span><span class=line><span class=cl>     <span class=nv>left</span><span class=o>=</span>192.168.10.232
</span></span><span class=line><span class=cl>     <span class=nv>leftprotoport</span><span class=o>=</span>17/1701
</span></span><span class=line><span class=cl>     <span class=nv>right</span><span class=o>=</span>%any
</span></span><span class=line><span class=cl>     <span class=nv>rightprotoport</span><span class=o>=</span>17/%any
</span></span></code></pre></div><p>注意上面的 left=192.168.10.232，这是服务器的ip地址，要更换为自己服务器的地址（如果在防火墙后，写内网地址，非映射后的公网IP）</p><p>然后修改密钥，之后建立L2TP的 iphone 连接时会用到：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># vim /etc/ipsec.secrets</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>192.168.10.232 %any: PSK <span class=s2>&#34;123456789&#34;</span>
</span></span></code></pre></div><p>验证一下：</p><pre tabindex=0><code># ipsec setup start

# ipsec verify
</code></pre><p><img loading=lazy src=/posts/20221113-l2tp_vpn/image-20220810094316262.png></p><p>看到上面两行红字不要慌张，Ignore，忽略掉即可。是内核特性中的reverse path filter特性，没关系。</p><p>然后让 ipsec 自启动</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># systemctl enable ipsec</span>
</span></span></code></pre></div><h4 id=四配置xl2tpd>四、配置xl2tpd<a hidden class=anchor aria-hidden=true href=#四配置xl2tpd>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 先备份</span>
</span></span><span class=line><span class=cl><span class=c1># mv /etc/xl2tpd/xl2tpd.conf /etc/xl2tpd/xl2tpd.conf.old</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># vim /etc/xl2tpd/xl2tpd.conf</span>
</span></span><span class=line><span class=cl><span class=o>[</span>global<span class=o>]</span>
</span></span><span class=line><span class=cl>listen-addr <span class=o>=</span> 192.168.10.232
</span></span><span class=line><span class=cl>ipsec <span class=nv>saref</span> <span class=o>=</span> yes
</span></span><span class=line><span class=cl><span class=o>[</span>lns default<span class=o>]</span>
</span></span><span class=line><span class=cl>ip <span class=nv>range</span> <span class=o>=</span> 192.168.100.128-192.168.100.254
</span></span><span class=line><span class=cl><span class=nb>local</span> <span class=nv>ip</span> <span class=o>=</span> 192.168.100.99
</span></span><span class=line><span class=cl>require <span class=nv>chap</span> <span class=o>=</span> yes
</span></span><span class=line><span class=cl>refuse <span class=nv>pap</span> <span class=o>=</span> yes
</span></span><span class=line><span class=cl>require <span class=nv>authentication</span> <span class=o>=</span> yes
</span></span><span class=line><span class=cl><span class=nv>name</span> <span class=o>=</span> LinuxVPNserver
</span></span><span class=line><span class=cl>ppp <span class=nv>debug</span> <span class=o>=</span> yes
</span></span><span class=line><span class=cl><span class=nv>pppoptfile</span> <span class=o>=</span> /etc/ppp/options.xl2tpd
</span></span><span class=line><span class=cl>length <span class=nv>bit</span> <span class=o>=</span> yes
</span></span></code></pre></div><p>注意更换上面 192.168.10.232 的服务器ip地址，同时记住name=LinuxVPNserver</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 先备份</span>
</span></span><span class=line><span class=cl><span class=c1># mv /etc/ppp/options.xl2tpd /etc/ppp/options.xl2tpd.old</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># vim /etc/ppp/options.xl2tpd</span>
</span></span><span class=line><span class=cl>ipcp-accept-local
</span></span><span class=line><span class=cl>ipcp-accept-remote
</span></span><span class=line><span class=cl>ms-dns  8.8.8.8
</span></span><span class=line><span class=cl>ms-dns  4.2.2.4
</span></span><span class=line><span class=cl>noccp
</span></span><span class=line><span class=cl><span class=c1>#noauth</span>
</span></span><span class=line><span class=cl>crtscts
</span></span><span class=line><span class=cl>idle <span class=m>1800</span>
</span></span><span class=line><span class=cl>mtu <span class=m>1410</span>
</span></span><span class=line><span class=cl>mru <span class=m>1410</span>
</span></span><span class=line><span class=cl>nodefaultroute
</span></span><span class=line><span class=cl>debug
</span></span><span class=line><span class=cl>lock
</span></span><span class=line><span class=cl>proxyarp
</span></span><span class=line><span class=cl>connect-delay <span class=m>5000</span>
</span></span></code></pre></div><p>最后编辑用户名和密码</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>vim /etc/ppp/chap-secrets
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Secrets for authentication using CHAP</span>
</span></span><span class=line><span class=cl><span class=c1># client        server  secret                  IP addresses</span>
</span></span><span class=line><span class=cl><span class=nb>test</span>     LinuxVPNserver <span class=nb>test</span> *
</span></span></code></pre></div><p>注意格式，第一列是用户名，第二列是上面xl2tpd.conf中记住的name名，第三列是密码，第四列是获取到的ip地址</p><p>然后启动</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># systemctl start xl2tpd</span>
</span></span><span class=line><span class=cl><span class=c1># systemctl enable xl2tpd</span>
</span></span><span class=line><span class=cl><span class=c1># systemctl status xl2tpd</span>
</span></span></code></pre></div><h4 id=五配置防火墙>五、配置防火墙<a hidden class=anchor aria-hidden=true href=#五配置防火墙>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>iptables -A INPUT -p gre -j ACCEPT
</span></span><span class=line><span class=cl>iptables -A OUTPUT -p gre -j ACCEPT
</span></span><span class=line><span class=cl>iptables -A FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT
</span></span><span class=line><span class=cl>iptables -A FORWARD -s 192.168.100.0/24 -j ACCEPT
</span></span><span class=line><span class=cl>iptables -t nat -A POSTROUTING -s 192.168.100.0/24 -o eth0 -j MASQUERADE
</span></span></code></pre></div><p>注意上面的eth0，根据服务器的具体情况进行修改</p><p>然后这样就完成了。</p><h4 id=六配置iphone手机>六、配置iphone手机<a hidden class=anchor aria-hidden=true href=#六配置iphone手机>#</a></h4><p><img loading=lazy src=/posts/20221113-l2tp_vpn/image-20220810095400410.png></p><p>配置好服务器ip，账户，密码以及密钥就可以了。</p></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>Copyright © 2020-2025 Zhang Ranrui. All Rights Reserved.</span><br>·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script></body></html>