<!doctype html><html lang=zh dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3988508441804851" crossorigin=anonymous></script><title>hubot集成企业微信+jenkins+ansible | 八戒的技术博客</title>
<meta name=keywords content><meta name=description content="Hubot是一个通用的聊天机器人，能和很多聊天软件集成，比如slack、rockchat、telegram、企业微信、IRC等。
公司用的是企业微信，之前用群机器人和 prometheus 集成，发送各种告警信息，但是群机器人无法接收消息；同时我们想集成进去很多自定义命令，比如发送指令就开始 jenkins build，发送 ansible 指令执行，发送流量图就自动把机房的流量图发过来，这个群机器人就用不成了。所以必须再直接一些，构建一个企业微信的应用。
一、企业微信安装前准备
安装前需要在企业微信中拿到4个信息：

WECHATWORK_CORP_ID
WECHATWORK_APP_AGENT_ID
WECHATWORK_APP_SECRET
WECHATWORK_AES_KEY

首先联系企业微信管理员新增一个应用：

在“管理后台-我的企业”中可以获得地一个信息，企业 ID 信息，CORP_ID  ：
拿拿  在“管理后台-应用管理-点击某具体应用-详情”页中可以获得二、三个信息， APP_AGENT_ID 和 APP_SECRET

第四个 AES_KEY 就比较麻烦了，我们进入这个应用，点击配置的图标：

然后进入，点击启用 API 接收

然后设置一下

url 填写 https://hubot.rendoumi.com/wechatwork/webhook
Token 点随机获取
EncodingAESKey 点随机获取，这就是具体的 AESKey 了


然后点击保存，这里必然会失败！没有关系，因为我们还没有装hubot呢。我们把这三个地方先记录下来，随后再来点击保存。
二、Hubot 安装前准备
1、注意上面地址：URL 地址是 https ，然后 hubot 的缺省地址是 http://xxx:8080 ，这样如果前面没有证书卸载的设备，就得搭建一个Nginx（haproxy、traefik）来代理 https 443端口到8080。
2、Hubot 是支持 Coffeescript 和 nodejs 的，从它的 Adapters 网页看
https://hubot.github.com/docs/adapters/development/
里面都是 coffee 味的单箭头函数，导致不太熟悉的八戒以为在 wechatwork module导出的时候也应该用单箭头函数，结果就悲剧了。"><meta name=author content="八戒"><link rel=canonical href=https://rendoumi.com/posts/20211222-hubot_wechat/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.5d8a858b4ad07d913988e10d3c3dbc8c171f45316a396de8a60d67f44840812d.css integrity="sha256-XYqFi0rQfZE5iOENPD28jBcfRTFqOW3opg1n9EhAgS0=" rel="preload stylesheet" as=style><link rel=icon href=https://rendoumi.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://rendoumi.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://rendoumi.com/favicon-32x32.png><link rel=apple-touch-icon href=https://rendoumi.com/apple-touch-icon.png><link rel=mask-icon href=https://rendoumi.com/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://rendoumi.com/posts/20211222-hubot_wechat/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><meta property="og:url" content="https://rendoumi.com/posts/20211222-hubot_wechat/"><meta property="og:site_name" content="八戒的技术博客"><meta property="og:title" content="hubot集成企业微信+jenkins+ansible"><meta property="og:description" content="Hubot是一个通用的聊天机器人，能和很多聊天软件集成，比如slack、rockchat、telegram、企业微信、IRC等。
公司用的是企业微信，之前用群机器人和 prometheus 集成，发送各种告警信息，但是群机器人无法接收消息；同时我们想集成进去很多自定义命令，比如发送指令就开始 jenkins build，发送 ansible 指令执行，发送流量图就自动把机房的流量图发过来，这个群机器人就用不成了。所以必须再直接一些，构建一个企业微信的应用。
一、企业微信安装前准备 安装前需要在企业微信中拿到4个信息：
WECHATWORK_CORP_ID WECHATWORK_APP_AGENT_ID WECHATWORK_APP_SECRET WECHATWORK_AES_KEY 首先联系企业微信管理员新增一个应用：
在“管理后台-我的企业”中可以获得地一个信息，企业 ID 信息，CORP_ID ：
拿拿 在“管理后台-应用管理-点击某具体应用-详情”页中可以获得二、三个信息， APP_AGENT_ID 和 APP_SECRET
第四个 AES_KEY 就比较麻烦了，我们进入这个应用，点击配置的图标：
然后进入，点击启用 API 接收
然后设置一下
url 填写 https://hubot.rendoumi.com/wechatwork/webhook Token 点随机获取 EncodingAESKey 点随机获取，这就是具体的 AESKey 了 然后点击保存，这里必然会失败！没有关系，因为我们还没有装hubot呢。我们把这三个地方先记录下来，随后再来点击保存。
二、Hubot 安装前准备 1、注意上面地址：URL 地址是 https ，然后 hubot 的缺省地址是 http://xxx:8080 ，这样如果前面没有证书卸载的设备，就得搭建一个Nginx（haproxy、traefik）来代理 https 443端口到8080。
2、Hubot 是支持 Coffeescript 和 nodejs 的，从它的 Adapters 网页看
https://hubot.github.com/docs/adapters/development/
里面都是 coffee 味的单箭头函数，导致不太熟悉的八戒以为在 wechatwork module导出的时候也应该用单箭头函数，结果就悲剧了。"><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-12-22T09:30:11+08:00"><meta property="article:modified_time" content="2021-12-22T09:30:11+08:00"><meta property="og:image" content="https://rendoumi.com/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://rendoumi.com/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="hubot集成企业微信+jenkins+ansible"><meta name=twitter:description content="Hubot是一个通用的聊天机器人，能和很多聊天软件集成，比如slack、rockchat、telegram、企业微信、IRC等。
公司用的是企业微信，之前用群机器人和 prometheus 集成，发送各种告警信息，但是群机器人无法接收消息；同时我们想集成进去很多自定义命令，比如发送指令就开始 jenkins build，发送 ansible 指令执行，发送流量图就自动把机房的流量图发过来，这个群机器人就用不成了。所以必须再直接一些，构建一个企业微信的应用。
一、企业微信安装前准备
安装前需要在企业微信中拿到4个信息：

WECHATWORK_CORP_ID
WECHATWORK_APP_AGENT_ID
WECHATWORK_APP_SECRET
WECHATWORK_AES_KEY

首先联系企业微信管理员新增一个应用：

在“管理后台-我的企业”中可以获得地一个信息，企业 ID 信息，CORP_ID  ：
拿拿  在“管理后台-应用管理-点击某具体应用-详情”页中可以获得二、三个信息， APP_AGENT_ID 和 APP_SECRET

第四个 AES_KEY 就比较麻烦了，我们进入这个应用，点击配置的图标：

然后进入，点击启用 API 接收

然后设置一下

url 填写 https://hubot.rendoumi.com/wechatwork/webhook
Token 点随机获取
EncodingAESKey 点随机获取，这就是具体的 AESKey 了


然后点击保存，这里必然会失败！没有关系，因为我们还没有装hubot呢。我们把这三个地方先记录下来，随后再来点击保存。
二、Hubot 安装前准备
1、注意上面地址：URL 地址是 https ，然后 hubot 的缺省地址是 http://xxx:8080 ，这样如果前面没有证书卸载的设备，就得搭建一个Nginx（haproxy、traefik）来代理 https 443端口到8080。
2、Hubot 是支持 Coffeescript 和 nodejs 的，从它的 Adapters 网页看
https://hubot.github.com/docs/adapters/development/
里面都是 coffee 味的单箭头函数，导致不太熟悉的八戒以为在 wechatwork module导出的时候也应该用单箭头函数，结果就悲剧了。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"所有文章","item":"https://rendoumi.com/posts/"},{"@type":"ListItem","position":2,"name":"hubot集成企业微信+jenkins+ansible","item":"https://rendoumi.com/posts/20211222-hubot_wechat/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"hubot集成企业微信+jenkins+ansible","name":"hubot集成企业微信\u002bjenkins\u002bansible","description":"Hubot是一个通用的聊天机器人，能和很多聊天软件集成，比如slack、rockchat、telegram、企业微信、IRC等。\n公司用的是企业微信，之前用群机器人和 prometheus 集成，发送各种告警信息，但是群机器人无法接收消息；同时我们想集成进去很多自定义命令，比如发送指令就开始 jenkins build，发送 ansible 指令执行，发送流量图就自动把机房的流量图发过来，这个群机器人就用不成了。所以必须再直接一些，构建一个企业微信的应用。\n一、企业微信安装前准备 安装前需要在企业微信中拿到4个信息：\nWECHATWORK_CORP_ID WECHATWORK_APP_AGENT_ID WECHATWORK_APP_SECRET WECHATWORK_AES_KEY 首先联系企业微信管理员新增一个应用：\n在“管理后台-我的企业”中可以获得地一个信息，企业 ID 信息，CORP_ID ：\n拿拿 在“管理后台-应用管理-点击某具体应用-详情”页中可以获得二、三个信息， APP_AGENT_ID 和 APP_SECRET\n第四个 AES_KEY 就比较麻烦了，我们进入这个应用，点击配置的图标：\n然后进入，点击启用 API 接收\n然后设置一下\nurl 填写 https://hubot.rendoumi.com/wechatwork/webhook Token 点随机获取 EncodingAESKey 点随机获取，这就是具体的 AESKey 了 然后点击保存，这里必然会失败！没有关系，因为我们还没有装hubot呢。我们把这三个地方先记录下来，随后再来点击保存。\n二、Hubot 安装前准备 1、注意上面地址：URL 地址是 https ，然后 hubot 的缺省地址是 http://xxx:8080 ，这样如果前面没有证书卸载的设备，就得搭建一个Nginx（haproxy、traefik）来代理 https 443端口到8080。\n2、Hubot 是支持 Coffeescript 和 nodejs 的，从它的 Adapters 网页看\nhttps://hubot.github.com/docs/adapters/development/\n里面都是 coffee 味的单箭头函数，导致不太熟悉的八戒以为在 wechatwork module导出的时候也应该用单箭头函数，结果就悲剧了。\n","keywords":[],"articleBody":"Hubot是一个通用的聊天机器人，能和很多聊天软件集成，比如slack、rockchat、telegram、企业微信、IRC等。\n公司用的是企业微信，之前用群机器人和 prometheus 集成，发送各种告警信息，但是群机器人无法接收消息；同时我们想集成进去很多自定义命令，比如发送指令就开始 jenkins build，发送 ansible 指令执行，发送流量图就自动把机房的流量图发过来，这个群机器人就用不成了。所以必须再直接一些，构建一个企业微信的应用。\n一、企业微信安装前准备 安装前需要在企业微信中拿到4个信息：\nWECHATWORK_CORP_ID WECHATWORK_APP_AGENT_ID WECHATWORK_APP_SECRET WECHATWORK_AES_KEY 首先联系企业微信管理员新增一个应用：\n在“管理后台-我的企业”中可以获得地一个信息，企业 ID 信息，CORP_ID ：\n拿拿 在“管理后台-应用管理-点击某具体应用-详情”页中可以获得二、三个信息， APP_AGENT_ID 和 APP_SECRET\n第四个 AES_KEY 就比较麻烦了，我们进入这个应用，点击配置的图标：\n然后进入，点击启用 API 接收\n然后设置一下\nurl 填写 https://hubot.rendoumi.com/wechatwork/webhook Token 点随机获取 EncodingAESKey 点随机获取，这就是具体的 AESKey 了 然后点击保存，这里必然会失败！没有关系，因为我们还没有装hubot呢。我们把这三个地方先记录下来，随后再来点击保存。\n二、Hubot 安装前准备 1、注意上面地址：URL 地址是 https ，然后 hubot 的缺省地址是 http://xxx:8080 ，这样如果前面没有证书卸载的设备，就得搭建一个Nginx（haproxy、traefik）来代理 https 443端口到8080。\n2、Hubot 是支持 Coffeescript 和 nodejs 的，从它的 Adapters 网页看\nhttps://hubot.github.com/docs/adapters/development/\n里面都是 coffee 味的单箭头函数，导致不太熟悉的八戒以为在 wechatwork module导出的时候也应该用单箭头函数，结果就悲剧了。\n所以务必清楚，Adapter 的语法是 js，普通自建自动回复script可以用coffeescript，后面会详细说这一点。\n3、安装Hubot必须新建一个普通用户，不能用 root 装\n用 root 会导致 nodejs 一堆报错，八戒新建了一个用户 bot，家目录/home/bot，然后再在这下面建立/home/bot/myhubot，在这个目录下安装。\n理由是这个如果直接装在这个用户的 home 目录下，会导致这个用户只能有这一个用途了，目录结构太浅，一堆文件\n4、Hubot的变量引入都是通过环境变量引入的\n所以无论什么wechatwork还是jenkins，都需要通过环境变量导入变量\n三、安装Hubot 首先安装nvm，参看文章 Nodejs多版本的安装与管理\ncurl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash 安装的时候最好加个 https_proxy 代理，因为这个 shell 脚本不翻墙很难下下来。\n然后务必关了代理，退出终端并重新进入，安装 nodejs 的最新版本\nnvm ls-remote nvm install v16.13.1 nvm list 确认一下，nodejs 的版本缺省是 v16.13.1\n这里千万不要手欠把 npm 的源换成国内的腾讯等，就是国外源\n然后安装hubot，并初始化\nsu - bot npm install -g yo generator-hubot mkdir /home/bot/myhubot cd /home/bot/myhubot yo hubot 会问几个问题：\nOwer：写自己邮箱就行 Bot name: bot Description: rendoumi corp Bot adapter: campfire 注意最后一个，选campfire就好，我们稍后再装wechatwork\n_____________________________ / \\ //\\ | Extracting input for | ////\\ _____ | self-replication process | //////\\ /_____\\ \\ / ======= |[^_/\\_]| /---------------------------- | | _|___@@__|__ +===+/ /// \\_\\ | |_\\ /// HUBOT/\\\\ |___/\\// / \\\\ \\ / +---+ \\____/ | | | //| +===+ \\// |xx| ? Owner zhangranrui@rendoumi.com ? Bot name bot ? Description rendoumi corp ? Bot adapter campfire 然后就会是漫长的等待：\n最后会报几个警告，不用管，忽略即可。\nnpm notice created a lockfile as package-lock.json. You should commit this file. + hubot-help@1.0.1 + hubot-google-images@0.2.7 + hubot-rules@1.0.0 + hubot-shipit@0.2.1 + hubot-redis-brain@1.0.0 + hubot-google-translate@0.2.1 + hubot-diagnostics@1.0.0 + hubot-scripts@2.17.2 + hubot@3.3.2 + hubot-maps@0.0.3 + hubot-heroku-keepalive@1.0.3 + hubot-pugme@0.1.1 added 99 packages from 53 contributors and audited 99 packages in 20.176s 2 packages are looking for funding run `npm fund` for details found 1 low severity vulnerability run `npm audit fix` to fix them, or `npm audit` for details 我们先跑一下，简单测一下功能，我们的bot name输入的是bot\ncd /home/bot/myhubot ./bin/hubot #进入后 bot ping #得到回应 PONG 这样就装好了 hubot，我们做一下修改，去掉 heroku 和 redis，否则会不停丢出报错信息，但是不要用 npm 去删除这两个包，放着那里备用也不占多少空间的\ncd /home/bot/myhubot vi external-scripts.json [ \"hubot-diagnostics\", \"hubot-help\", \"hubot-heroku-keepalive\", \"hubot-google-images\", \"hubot-google-translate\", \"hubot-pugme\", \"hubot-maps\", \"hubot-redis-brain\", \"hubot-rules\", \"hubot-shipit\" ] #去掉下面两行 hubot-heroku-keepalive hubot-redis-brain 三、安装微信 Adapter Adapter 插件，hubot是一套系统，通过各种插件跟各种聊天软件进行交互\n微信插件原始地址：https://github.com/billtt/hubot-wechatwork\n八戒稍微改了一下：https://github.com/zhangrr/hubot-wechatwork\n主要是添加了个自动回应和添加了一些调试信息，否则不知道加载成不成功。\n#先装那个老的 cd /home/bot/myhubot npm install hubot-wechatwork #覆盖掉老的模块 cd /home/bot/myhubot/node_modules git clone https://github.com/zhangrr/hubot-wechatwork 启动之前普及一下 hubot 基本知识，hubot 中变量的传入都是通过环境变量导入的，启动测试一下wechatwork\nexport WECHATWORK_CORP_ID=aaaa export WECHATWORK_APP_AGENT_ID=bbbb export WECHATWORK_APP_SECRET=cccc export WECHATWORK_AES_KEY=dddd cd /home/bot/myhubot ./bin/hubot -a wechatwork 看到信息，INFO Yunwei: loading wechatwork Adapter，说明启动没啥毛病\n然后我们回到企业微信这个应用的应用管理，点击保存接收消息服务器配置，这次就应该能成功了。\n测试一下，我们在企业微信中，对这个应用机器人私聊，发个 hi：\n再发个help，会冒出一堆信息\n然后我们可以试试指令，再发个ping，机器人回PONG，这就算正常工作了\n同时我们在终端也可以看到接收到的消息\n要注意的命令： wechatwork 有一条命令 chat create CHATID USER1,USER2,USER3,…\n解释一下，是用来建立一个企业微信群聊的，群主默认是第一个人：\nchatid 是指一个群聊的 id 号，格式是字母+数字，比如yunwei001，这个一旦创建就无法销毁，会永远保存在企业微信那里，切切记住！！！\nuser1,user2 这种是员工企业微信的id，通常是用户名全称，比如 zhangrenren,liudaqiang\n所以说的时候务必要小心，万万记住 chatid 一旦建立就无法收回。\n之后可以调用 sendChatMessage 来给群聊发送消息。\n四、准备systemd启动hubot 这样不能每次用个终端启动 hubot 吧，写个 systemd 文件来处理吧\n由于我们用到了nvm，这里确实需要一些技巧，cat /etc/systemd/system/hubot.service\n[Unit] Description=Hubot Requires=network.target After=network.target [Service] Type=simple WorkingDirectory=/home/bot/myhubot User=bot Restart=always TimeoutStartSec=10 RestartSec=10 ; Configure Hubot environment variables, use quotes around vars with whitespace as shown below. ; Environment=\"HUBOT_SLACK_TOKEN=SLACK_TOKEN\" ; Environment=\"HUBOT_JENKINS_AUTH=pe:x837491lkaflajksdf7\" ; Environment=\"HUBOT_JENKINS_URL=http://192.168.1.90:8080/\" Environment=\"NODE_VERSION=default\" Environment=\"WECHATWORK_CORP_ID=aaaa\" Environment=\"WECHATWORK_APP_AGENT_ID=bbbb\" Environment=\"WECHATWORK_APP_SECRET=cccc\" Environment=\"WECHATWORK_AES_KEY=dddd\" ExecStart=/home/bot/.nvm/nvm-exec /home/bot/myhubot/bin/hubot --adapter wechatwork [Install] WantedBy=multi-user.target 注意上面，我们指定了环境变量 NODE_VERSION=default，以及最下的 ExecStart，确定用 nvm-exec 引动 node\n另外把 wechatwork 所需的4个参数也放进环境变量中，这样重启就可以了\nsystemctl daemon-reload systemctl start hubot 五、集成jenkins 准备知识，我们必须在 jenkins 拿到用户名和 token（token是用来代替密码的），用来访问 jenkins\n首先登录 jenkins，访问网址：$JENKINS_URL/me/configure，新建一个 API Token，记录下来\n用法很简单：token替代密码用于 url 认证即可。\ncd /home/bot/myhubot npm install hubot-jenkins-optimised #编辑external-scripts.json vi external-scripts.json [ \"hubot-diagnostics\", \"hubot-help\", \"hubot-google-images\", \"hubot-google-translate\", \"hubot-pugme\", \"hubot-maps\", \"hubot-rules\", \"hubot-shipit\", \"hubot-jenkins-optimised\" ] #上面增加了一行 hubot-jenkins-optimised #编辑 /etc/systemd/system/hubot.service ，添加 jenkins 的环境变量 #jenkins的用户名是pe，所有auth是 \"pe:x837491lkaflajksdf7\" ...... Environment=\"HUBOT_JENKINS_AUTH=pe:x837491lkaflajksdf7\" Environment=\"HUBOT_JENKINS_URL=http://192.168.1.90:8080/\" ...... # 重启 hubot systemctl daemon-reload systemctl restart hubot 然后我们私聊这个机器人，对它说: jenkins list，就可以看到项目了， jenkins b 3 就可以开始build第三个项目了，所有命令可以通过对机器人说 help 来获得\n六、集成ansible 集成 ansible，其实就是集成一个 shell，也很简单\ncd /home/bot/myhubot npm install hubot-script-shellcmd #编辑external-scripts.json vi external-scripts.json [ \"hubot-diagnostics\", \"hubot-help\", \"hubot-google-images\", \"hubot-google-translate\", \"hubot-pugme\", \"hubot-maps\", \"hubot-rules\", \"hubot-shipit\", \"hubot-jenkins-optimised\", \"hubot-script-shellcmd\" ] #上面增加了一行 hubot-script-shellcmd #把shellcmd目录下的bash目录，复制一份到/home/bot/myhubot/bash cp -R node_modules/hubot-script-shellcmd/bash ./ #我们把ansible的yml都放到/homebot/myhubot/bash/ansible目录下 cd /home/bot/myhubot/bash mkdir ansible #把ansible-playbook的yml都放进去 .... #然后编写命令脚本 cd /home/bot/myhubot/bash/handles cat \u003c EOF \u003e\u003e fuse #!/bin/bash if [ -n \"$1\" ] ; then if [ -n \"$2\" ] ; then ansible-playbook /home/bot/myhubot/bash/ansible/check-disk.yml -e \"ip=$1 fs=$2\" else ansible-playbook /home/bot/myhubot/bash/ansible/check-disk.yml -e \"ip=$1 fs=/\" fi fi exit 0 EOF #给执行权 chmod 755 /home/bot/myhubot/bash/handles/fuse #重启hubot systemctl restart hubot check-disk.yml 的真身，是在远程机器上调用本机才有的rust dust命令，来算出远程机器的某个目录的使用情况\n--- - name: check machine disk space hosts: \"{{ ip }}\" gather_facts: false vars: - ip: \"{{ ip }}\" - fs: \"{{ fs }}\" - ansible_ssh_user: \"root\" - ansible_ssh_pass: \"Fuck2021!\" - ansible_ssh_common_args: \"-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null\" - host_key_checking: False tasks: - name: Run a script with arguments (using 'cmd' parameter) ansible.builtin.script: cmd: /usr/local/bin/dust -bcr {{ fs }} register: output - debug: var=output.stdout_lines 我们在企业微信对机器说 shell ，就会得到所有命令列表\n对它说 shell fuse 172.19.16.1 /export ，就会把本机才有的 dust 命令，拷贝到172.19.16.1的机器上，并对 /export 执行，得到占磁盘空间最大的文件和目录。\n参考资料： https://qydev.weixin.qq.com/wiki/index.php?title=%E5%8F%91%E9%80%81%E6%8E%A5%E5%8F%A3%E8%AF%B4%E6%98%8E\nhttp://sd.blackball.lv/library/Automation_and_Monitoring_with_Hubot_(2014).pdf\n","wordCount":"675","inLanguage":"zh","image":"https://rendoumi.com/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2021-12-22T09:30:11+08:00","dateModified":"2021-12-22T09:30:11+08:00","author":{"@type":"Person","name":"八戒"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://rendoumi.com/posts/20211222-hubot_wechat/"},"publisher":{"@type":"Organization","name":"八戒的技术博客","logo":{"@type":"ImageObject","url":"https://rendoumi.com/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://rendoumi.com/ accesskey=h title="Home (Alt + H)"><img src=https://rendoumi.com/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches></div></div><ul id=menu><li><a href=https://rendoumi.com/ title=首页><span>首页</span></a></li><li><a href=https://rendoumi.com/posts/ title=文章><span>文章</span></a></li><li><a href=https://rendoumi.com/archives/ title=归档><span>归档</span></a></li><li><a href=https://blog.rendoumi.com title=生活><span>生活</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://rendoumi.com/search/ title=搜索><span>搜索</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://rendoumi.com/>主页</a>&nbsp;»&nbsp;<a href=https://rendoumi.com/posts/>所有文章</a></div><h1 class="post-title entry-hint-parent">hubot集成企业微信+jenkins+ansible
<span class=entry-hint title=Draft><svg height="35" viewBox="0 -960 960 960" fill="currentcolor"><path d="M160-410v-60h3e2v60H160zm0-165v-60h470v60H160zm0-165v-60h470v60H160zm360 580v-123l221-220q9-9 20-13t22-4q12 0 23 4.5t20 13.5l37 37q9 9 13 20t4 22-4.5 22.5T862.09-380L643-160H520zm3e2-263-37-37 37 37zM580-220h38l121-122-18-19-19-18-122 121v38zm141-141-19-18 37 37-18-19z"/></svg></span></h1><div class=post-meta><span title='2021-12-22 09:30:11 +0800 CST'>2021年22月</span>&nbsp;·&nbsp;<span>4 分钟</span>&nbsp;·&nbsp;<span>675 字</span>&nbsp;·&nbsp;<span>八戒</span></div></header><div class=post-content><p>Hubot是一个通用的聊天机器人，能和很多聊天软件集成，比如slack、rockchat、telegram、企业微信、IRC等。</p><p>公司用的是企业微信，之前用群机器人和 prometheus 集成，发送各种告警信息，但是群机器人无法接收消息；同时我们想集成进去很多自定义命令，比如发送指令就开始 jenkins build，发送 ansible 指令执行，发送流量图就自动把机房的流量图发过来，这个群机器人就用不成了。所以必须再直接一些，构建一个企业微信的应用。</p><h2 id=一企业微信安装前准备>一、企业微信安装前准备<a hidden class=anchor aria-hidden=true href=#一企业微信安装前准备>#</a></h2><p>安装前需要在企业微信中拿到4个信息：</p><ol><li>WECHATWORK_CORP_ID</li><li>WECHATWORK_APP_AGENT_ID</li><li>WECHATWORK_APP_SECRET</li><li>WECHATWORK_AES_KEY</li></ol><p>首先联系企业微信管理员新增一个应用：</p><p><img alt=image-20211222144935256 loading=lazy src=/posts/20211222-hubot_wechat/image-20211222144935256.png></p><p>在“管理后台-我的企业”中可以获得地一个信息，企业 ID 信息，CORP_ID ：</p><p><img alt=image-20211222144654696 loading=lazy src=/posts/20211222-hubot_wechat/image-20211222144654696.png>拿拿 在“管理后台-应用管理-点击某具体应用-详情”页中可以获得二、三个信息， APP_AGENT_ID 和 APP_SECRET</p><p><img alt=image-20211222150424143 loading=lazy src=/posts/20211222-hubot_wechat/image-20211222150424143.png></p><p>第四个 AES_KEY 就比较麻烦了，我们进入这个应用，点击配置的图标：</p><p><img alt=image-20211222151155307 loading=lazy src=/posts/20211222-hubot_wechat/image-20211222151155307.png></p><p>然后进入，点击启用 API 接收</p><p><img alt=image-20211222151325525 loading=lazy src=/posts/20211222-hubot_wechat/image-20211222151325525.png></p><p>然后设置一下</p><ul><li>url 填写 <a href=https://hubot.rendoumi.com/wechatwork/webhook>https://hubot.rendoumi.com/wechatwork/webhook</a></li><li>Token 点随机获取</li><li>EncodingAESKey 点随机获取，这就是具体的 AESKey 了</li></ul><p><img alt=image-20211222151552345 loading=lazy src=/posts/20211222-hubot_wechat/image-20211222151552345.png></p><p>然后点击保存，这里必然会失败！没有关系，因为我们还没有装hubot呢。我们把这三个地方先记录下来，随后再来点击保存。</p><h2 id=二hubot-安装前准备>二、Hubot 安装前准备<a hidden class=anchor aria-hidden=true href=#二hubot-安装前准备>#</a></h2><p>1、注意上面地址：URL 地址是 https ，然后 hubot 的缺省地址是 http://xxx:8080 ，这样如果前面没有证书卸载的设备，就得搭建一个Nginx（haproxy、traefik）来代理 https 443端口到8080。</p><p>2、Hubot 是支持 Coffeescript 和 nodejs 的，从它的 Adapters 网页看</p><p><a href=https://hubot.github.com/docs/adapters/development/>https://hubot.github.com/docs/adapters/development/</a></p><p>里面都是 coffee 味的单箭头函数，导致不太熟悉的八戒以为在 wechatwork module导出的时候也应该用单箭头函数，结果就悲剧了。</p><p>所以务必清楚，Adapter 的语法是 js，普通自建自动回复script可以用coffeescript，后面会详细说这一点。</p><p>3、安装Hubot必须新建一个普通用户，不能用 root 装</p><p>用 root 会导致 nodejs 一堆报错，八戒新建了一个用户 bot，家目录/home/bot，然后再在这下面建立/home/bot/myhubot，在这个目录下安装。</p><p>理由是这个如果直接装在这个用户的 home 目录下，会导致这个用户只能有这一个用途了，目录结构太浅，一堆文件</p><p>4、Hubot的变量引入都是通过环境变量引入的</p><p>所以无论什么wechatwork还是jenkins，都需要通过环境变量导入变量</p><h2 id=三安装hubot>三、安装Hubot<a hidden class=anchor aria-hidden=true href=#三安装hubot>#</a></h2><p>首先安装nvm，参看文章 <a href=/posts/20211217-nodejs_nvm/>Nodejs多版本的安装与管理</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh <span class=p>|</span> bash
</span></span></code></pre></div><p>安装的时候最好加个 https_proxy 代理，因为这个 shell 脚本不翻墙很难下下来。</p><p>然后务必关了代理，退出终端并重新进入，安装 nodejs 的最新版本</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>nvm ls-remote
</span></span><span class=line><span class=cl>nvm install v16.13.1
</span></span><span class=line><span class=cl>nvm list
</span></span></code></pre></div><p><img alt=image-20211222154655729 loading=lazy src=/posts/20211222-hubot_wechat/image-20211222154655729.png></p><p>确认一下，nodejs 的版本缺省是 v16.13.1</p><p>这里千万不要手欠把 npm 的源换成国内的腾讯等，就是国外源</p><p>然后安装hubot，并初始化</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>su - bot
</span></span><span class=line><span class=cl>npm install -g yo generator-hubot
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>mkdir /home/bot/myhubot
</span></span><span class=line><span class=cl><span class=nb>cd</span> /home/bot/myhubot
</span></span><span class=line><span class=cl>yo hubot
</span></span></code></pre></div><p>会问几个问题：</p><ul><li>Ower：写自己邮箱就行</li><li>Bot name: bot</li><li>Description: rendoumi corp</li><li>Bot adapter: campfire</li></ul><p>注意最后一个，选campfire就好，我们稍后再装wechatwork</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl>                     <span class=na>_____________________________  </span>
</span></span><span class=line><span class=cl>                    <span class=na>/                             \ </span>
</span></span><span class=line><span class=cl>   <span class=na>//\              |      Extracting input for    |</span>
</span></span><span class=line><span class=cl>  <span class=na>////\    _____    |   self-replication process   |</span>
</span></span><span class=line><span class=cl> <span class=na>//////\  /_____\   \                             / </span>
</span></span><span class=line><span class=cl> <span class=o>=</span><span class=s>====== |[^_/\_]|   /----------------------------  
</span></span></span><span class=line><span class=cl><span class=s>  |   | _|___@@__|__                                
</span></span></span><span class=line><span class=cl><span class=s>  +===+/  ///     \_\                               
</span></span></span><span class=line><span class=cl><span class=s>   | |_\ /// HUBOT/\\                             
</span></span></span><span class=line><span class=cl><span class=s>   |___/\//      /  \\                            
</span></span></span><span class=line><span class=cl><span class=s>         \      /   +---+                            
</span></span></span><span class=line><span class=cl><span class=s>          \____/    |   |                            
</span></span></span><span class=line><span class=cl><span class=s>           | //|    +===+                            
</span></span></span><span class=line><span class=cl><span class=s>            \//      |xx|                            </span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>? Owner zhangranrui@rendoumi.com</span>
</span></span><span class=line><span class=cl><span class=na>? Bot name bot</span>
</span></span><span class=line><span class=cl><span class=na>? Description rendoumi corp</span>
</span></span><span class=line><span class=cl><span class=na>? Bot adapter campfire</span>
</span></span></code></pre></div><p>然后就会是漫长的等待：</p><p><img alt=image-20211222155430133 loading=lazy src=/posts/20211222-hubot_wechat/image-20211222155430133.png></p><p>最后会报几个警告，不用管，忽略即可。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>npm notice created a lockfile as package-lock.json. You should commit this file.
</span></span><span class=line><span class=cl>+ hubot-help@1.0.1
</span></span><span class=line><span class=cl>+ hubot-google-images@0.2.7
</span></span><span class=line><span class=cl>+ hubot-rules@1.0.0
</span></span><span class=line><span class=cl>+ hubot-shipit@0.2.1
</span></span><span class=line><span class=cl>+ hubot-redis-brain@1.0.0
</span></span><span class=line><span class=cl>+ hubot-google-translate@0.2.1
</span></span><span class=line><span class=cl>+ hubot-diagnostics@1.0.0
</span></span><span class=line><span class=cl>+ hubot-scripts@2.17.2
</span></span><span class=line><span class=cl>+ hubot@3.3.2
</span></span><span class=line><span class=cl>+ hubot-maps@0.0.3
</span></span><span class=line><span class=cl>+ hubot-heroku-keepalive@1.0.3
</span></span><span class=line><span class=cl>+ hubot-pugme@0.1.1
</span></span><span class=line><span class=cl>added <span class=m>99</span> packages from <span class=m>53</span> contributors and audited <span class=m>99</span> packages in 20.176s
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=m>2</span> packages are looking <span class=k>for</span> funding
</span></span><span class=line><span class=cl>  run <span class=sb>`</span>npm fund<span class=sb>`</span> <span class=k>for</span> details
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>found <span class=m>1</span> low severity vulnerability
</span></span><span class=line><span class=cl>  run <span class=sb>`</span>npm audit fix<span class=sb>`</span> to fix them, or <span class=sb>`</span>npm audit<span class=sb>`</span> <span class=k>for</span> details
</span></span></code></pre></div><p>我们先跑一下，简单测一下功能，我们的bot name输入的是bot</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /home/bot/myhubot
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>./bin/hubot
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#进入后</span>
</span></span><span class=line><span class=cl>bot ping
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#得到回应</span>
</span></span><span class=line><span class=cl>PONG
</span></span></code></pre></div><p>这样就装好了 hubot，我们做一下修改，去掉 heroku 和 redis，否则会不停丢出报错信息，但是不要用 npm 去删除这两个包，放着那里备用也不占多少空间的</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /home/bot/myhubot
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>vi external-scripts.json
</span></span><span class=line><span class=cl><span class=o>[</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;hubot-diagnostics&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;hubot-help&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;hubot-heroku-keepalive&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;hubot-google-images&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;hubot-google-translate&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;hubot-pugme&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;hubot-maps&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;hubot-redis-brain&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;hubot-rules&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;hubot-shipit&#34;</span>
</span></span><span class=line><span class=cl><span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#去掉下面两行</span>
</span></span><span class=line><span class=cl>hubot-heroku-keepalive
</span></span><span class=line><span class=cl>hubot-redis-brain
</span></span></code></pre></div><h2 id=三安装微信-adapter>三、安装微信 Adapter<a hidden class=anchor aria-hidden=true href=#三安装微信-adapter>#</a></h2><p>Adapter 插件，hubot是一套系统，通过各种插件跟各种聊天软件进行交互</p><p>微信插件原始地址：https://github.com/billtt/hubot-wechatwork</p><p>八戒稍微改了一下：https://github.com/zhangrr/hubot-wechatwork</p><p>主要是添加了个自动回应和添加了一些调试信息，否则不知道加载成不成功。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>#先装那个老的</span>
</span></span><span class=line><span class=cl><span class=nb>cd</span> /home/bot/myhubot
</span></span><span class=line><span class=cl>npm install hubot-wechatwork
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#覆盖掉老的模块</span>
</span></span><span class=line><span class=cl><span class=nb>cd</span> /home/bot/myhubot/node_modules
</span></span><span class=line><span class=cl>git clone https://github.com/zhangrr/hubot-wechatwork
</span></span></code></pre></div><p>启动之前普及一下 hubot 基本知识，hubot 中变量的传入都是通过环境变量导入的，启动测试一下wechatwork</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>export</span> <span class=nv>WECHATWORK_CORP_ID</span><span class=o>=</span>aaaa
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>WECHATWORK_APP_AGENT_ID</span><span class=o>=</span>bbbb
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>WECHATWORK_APP_SECRET</span><span class=o>=</span>cccc
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>WECHATWORK_AES_KEY</span><span class=o>=</span>dddd
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>cd</span> /home/bot/myhubot
</span></span><span class=line><span class=cl>./bin/hubot -a wechatwork
</span></span></code></pre></div><p>看到信息，INFO Yunwei: loading wechatwork Adapter，说明启动没啥毛病</p><p><img alt=image-20211228152907465 loading=lazy src=/posts/20211222-hubot_wechat/image-20211228152907465.png></p><p>然后我们回到企业微信这个应用的应用管理，点击保存接收消息服务器配置，这次就应该能成功了。</p><p>测试一下，我们在企业微信中，对这个应用机器人私聊，发个 hi：</p><p><img alt=image-20211228153139262 loading=lazy src=/posts/20211222-hubot_wechat/image-20211228153139262.png></p><p>再发个help，会冒出一堆信息</p><p><img alt=image-20211228153351091 loading=lazy src=/posts/20211222-hubot_wechat/image-20211228153351091.png></p><p>然后我们可以试试指令，再发个ping，机器人回PONG，这就算正常工作了</p><p><img alt=image-20211228153542953 loading=lazy src=/posts/20211222-hubot_wechat/image-20211228153542953.png></p><p>同时我们在终端也可以看到接收到的消息</p><p><img alt=image-20211228153847963 loading=lazy src=/posts/20211222-hubot_wechat/image-20211228153847963.png></p><h3 id=要注意的命令>要注意的命令：<a hidden class=anchor aria-hidden=true href=#要注意的命令>#</a></h3><p>wechatwork 有一条命令 chat create CHATID USER1,USER2,USER3,&mldr;</p><p>解释一下，是用来建立一个企业微信群聊的，群主默认是第一个人：</p><p>chatid 是指一个群聊的 id 号，格式是字母+数字，比如yunwei001，这个一旦创建就无法销毁，会永远保存在企业微信那里，切切记住！！！</p><p>user1,user2 这种是员工企业微信的id，通常是用户名全称，比如 zhangrenren,liudaqiang</p><p>所以说的时候务必要小心，万万记住 chatid 一旦建立就无法收回。</p><p>之后可以调用 sendChatMessage 来给群聊发送消息。</p><p><img alt=image-20211228163631248 loading=lazy src=/posts/20211222-hubot_wechat/image-20211228163631248.png></p><h2 id=四准备systemd启动hubot>四、准备systemd启动hubot<a hidden class=anchor aria-hidden=true href=#四准备systemd启动hubot>#</a></h2><p>这样不能每次用个终端启动 hubot 吧，写个 systemd 文件来处理吧</p><p>由于我们用到了nvm，这里确实需要一些技巧，<code>cat /etc/systemd/system/hubot.service</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>Unit<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>Description</span><span class=o>=</span>Hubot
</span></span><span class=line><span class=cl><span class=nv>Requires</span><span class=o>=</span>network.target
</span></span><span class=line><span class=cl><span class=nv>After</span><span class=o>=</span>network.target
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>Service<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>Type</span><span class=o>=</span>simple
</span></span><span class=line><span class=cl><span class=nv>WorkingDirectory</span><span class=o>=</span>/home/bot/myhubot
</span></span><span class=line><span class=cl><span class=nv>User</span><span class=o>=</span>bot
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>Restart</span><span class=o>=</span>always
</span></span><span class=line><span class=cl><span class=nv>TimeoutStartSec</span><span class=o>=</span><span class=m>10</span>
</span></span><span class=line><span class=cl><span class=nv>RestartSec</span><span class=o>=</span><span class=m>10</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>;</span> Configure Hubot environment variables, use quotes around vars with whitespace as shown below.
</span></span><span class=line><span class=cl><span class=p>;</span> <span class=nv>Environment</span><span class=o>=</span><span class=s2>&#34;HUBOT_SLACK_TOKEN=SLACK_TOKEN&#34;</span>
</span></span><span class=line><span class=cl><span class=p>;</span> <span class=nv>Environment</span><span class=o>=</span><span class=s2>&#34;HUBOT_JENKINS_AUTH=pe:x837491lkaflajksdf7&#34;</span>
</span></span><span class=line><span class=cl><span class=p>;</span> <span class=nv>Environment</span><span class=o>=</span><span class=s2>&#34;HUBOT_JENKINS_URL=http://192.168.1.90:8080/&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>Environment</span><span class=o>=</span><span class=s2>&#34;NODE_VERSION=default&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>Environment</span><span class=o>=</span><span class=s2>&#34;WECHATWORK_CORP_ID=aaaa&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>Environment</span><span class=o>=</span><span class=s2>&#34;WECHATWORK_APP_AGENT_ID=bbbb&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>Environment</span><span class=o>=</span><span class=s2>&#34;WECHATWORK_APP_SECRET=cccc&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>Environment</span><span class=o>=</span><span class=s2>&#34;WECHATWORK_AES_KEY=dddd&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>ExecStart</span><span class=o>=</span>/home/bot/.nvm/nvm-exec /home/bot/myhubot/bin/hubot --adapter wechatwork
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>Install<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>WantedBy</span><span class=o>=</span>multi-user.target
</span></span></code></pre></div><p>注意上面，我们指定了环境变量 NODE_VERSION=default，以及最下的 ExecStart，确定用 nvm-exec 引动 node</p><p>另外把 wechatwork 所需的4个参数也放进环境变量中，这样重启就可以了</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>systemctl daemon-reload
</span></span><span class=line><span class=cl>systemctl start hubot
</span></span></code></pre></div><h2 id=五集成jenkins>五、集成jenkins<a hidden class=anchor aria-hidden=true href=#五集成jenkins>#</a></h2><p>准备知识，我们必须在 jenkins 拿到用户名和 token（token是用来代替密码的），用来访问 jenkins</p><p>首先登录 jenkins，访问网址：$JENKINS_URL/me/configure，新建一个 API Token，记录下来</p><p><img alt=image-20211228155054104 loading=lazy src=/posts/20211222-hubot_wechat/image-20211228155054104.png></p><p>用法很简单：token替代密码用于 url 认证即可。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /home/bot/myhubot
</span></span><span class=line><span class=cl>npm install hubot-jenkins-optimised 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#编辑external-scripts.json</span>
</span></span><span class=line><span class=cl>vi external-scripts.json
</span></span><span class=line><span class=cl><span class=o>[</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;hubot-diagnostics&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;hubot-help&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;hubot-google-images&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;hubot-google-translate&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;hubot-pugme&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;hubot-maps&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;hubot-rules&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;hubot-shipit&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;hubot-jenkins-optimised&#34;</span>
</span></span><span class=line><span class=cl><span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#上面增加了一行</span>
</span></span><span class=line><span class=cl>hubot-jenkins-optimised
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#编辑 /etc/systemd/system/hubot.service ，添加 jenkins 的环境变量</span>
</span></span><span class=line><span class=cl><span class=c1>#jenkins的用户名是pe，所有auth是 &#34;pe:x837491lkaflajksdf7&#34;</span>
</span></span><span class=line><span class=cl>......
</span></span><span class=line><span class=cl><span class=nv>Environment</span><span class=o>=</span><span class=s2>&#34;HUBOT_JENKINS_AUTH=pe:x837491lkaflajksdf7&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>Environment</span><span class=o>=</span><span class=s2>&#34;HUBOT_JENKINS_URL=http://192.168.1.90:8080/&#34;</span>
</span></span><span class=line><span class=cl>......
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 重启 hubot</span>
</span></span><span class=line><span class=cl>systemctl daemon-reload
</span></span><span class=line><span class=cl>systemctl restart hubot
</span></span></code></pre></div><p>然后我们私聊这个机器人，对它说: jenkins list，就可以看到项目了， jenkins b 3 就可以开始build第三个项目了，所有命令可以通过对机器人说 help 来获得</p><p><img alt=image-20211228155834837 loading=lazy src=/posts/20211222-hubot_wechat/image-20211228155834837.png></p><h2 id=六集成ansible>六、集成ansible<a hidden class=anchor aria-hidden=true href=#六集成ansible>#</a></h2><p>集成 ansible，其实就是集成一个 shell，也很简单</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /home/bot/myhubot
</span></span><span class=line><span class=cl>npm install hubot-script-shellcmd
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#编辑external-scripts.json</span>
</span></span><span class=line><span class=cl>vi external-scripts.json
</span></span><span class=line><span class=cl><span class=o>[</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;hubot-diagnostics&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;hubot-help&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;hubot-google-images&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;hubot-google-translate&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;hubot-pugme&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;hubot-maps&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;hubot-rules&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;hubot-shipit&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;hubot-jenkins-optimised&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;hubot-script-shellcmd&#34;</span>
</span></span><span class=line><span class=cl><span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#上面增加了一行</span>
</span></span><span class=line><span class=cl>hubot-script-shellcmd
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#把shellcmd目录下的bash目录，复制一份到/home/bot/myhubot/bash</span>
</span></span><span class=line><span class=cl>cp -R node_modules/hubot-script-shellcmd/bash ./
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#我们把ansible的yml都放到/homebot/myhubot/bash/ansible目录下</span>
</span></span><span class=line><span class=cl><span class=nb>cd</span> /home/bot/myhubot/bash
</span></span><span class=line><span class=cl>mkdir ansible
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#把ansible-playbook的yml都放进去</span>
</span></span><span class=line><span class=cl>....
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#然后编写命令脚本</span>
</span></span><span class=line><span class=cl><span class=nb>cd</span> /home/bot/myhubot/bash/handles
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat &lt; EOF &gt;&gt; fuse
</span></span><span class=line><span class=cl><span class=c1>#!/bin/bash</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> -n <span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span> <span class=o>]</span> <span class=p>;</span> <span class=k>then</span> 
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>[</span> -n <span class=s2>&#34;</span><span class=nv>$2</span><span class=s2>&#34;</span> <span class=o>]</span> <span class=p>;</span> <span class=k>then</span> 
</span></span><span class=line><span class=cl>     ansible-playbook /home/bot/myhubot/bash/ansible/check-disk.yml  -e <span class=s2>&#34;ip=</span><span class=nv>$1</span><span class=s2> fs=</span><span class=nv>$2</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span>
</span></span><span class=line><span class=cl>     ansible-playbook /home/bot/myhubot/bash/ansible/check-disk.yml  -e <span class=s2>&#34;ip=</span><span class=nv>$1</span><span class=s2> fs=/&#34;</span>
</span></span><span class=line><span class=cl>  <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>exit</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>EOF
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#给执行权</span>
</span></span><span class=line><span class=cl>chmod <span class=m>755</span> /home/bot/myhubot/bash/handles/fuse
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#重启hubot</span>
</span></span><span class=line><span class=cl>systemctl restart hubot
</span></span></code></pre></div><p>check-disk.yml 的真身，是在远程机器上调用本机才有的rust dust命令，来算出远程机器的某个目录的使用情况</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>---
</span></span><span class=line><span class=cl>- name:  check machine disk space
</span></span><span class=line><span class=cl>  hosts: <span class=s2>&#34;{{ ip }}&#34;</span>
</span></span><span class=line><span class=cl>  gather_facts: <span class=nb>false</span>
</span></span><span class=line><span class=cl>  vars:
</span></span><span class=line><span class=cl>  - ip: <span class=s2>&#34;{{ ip }}&#34;</span>
</span></span><span class=line><span class=cl>  - fs: <span class=s2>&#34;{{ fs }}&#34;</span>
</span></span><span class=line><span class=cl>  - ansible_ssh_user: <span class=s2>&#34;root&#34;</span>
</span></span><span class=line><span class=cl>  - ansible_ssh_pass: <span class=s2>&#34;Fuck2021!&#34;</span>
</span></span><span class=line><span class=cl>  - ansible_ssh_common_args: <span class=s2>&#34;-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null&#34;</span>
</span></span><span class=line><span class=cl>  - host_key_checking: False
</span></span><span class=line><span class=cl>  tasks:
</span></span><span class=line><span class=cl>  - name: Run a script with arguments <span class=o>(</span>using <span class=s1>&#39;cmd&#39;</span> parameter<span class=o>)</span>
</span></span><span class=line><span class=cl>    ansible.builtin.script:
</span></span><span class=line><span class=cl>      cmd: /usr/local/bin/dust -bcr <span class=o>{{</span> fs <span class=o>}}</span>
</span></span><span class=line><span class=cl>    register: output
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  - debug: <span class=nv>var</span><span class=o>=</span>output.stdout_lines
</span></span></code></pre></div><p>我们在企业微信对机器说 shell ，就会得到所有命令列表</p><p><img alt=image-20211228161435568 loading=lazy src=/posts/20211222-hubot_wechat/image-20211228161435568.png></p><p>对它说 shell fuse 172.19.16.1 /export ，就会把本机才有的 dust 命令，拷贝到172.19.16.1的机器上，并对 /export 执行，得到占磁盘空间最大的文件和目录。</p><p><img alt=image-20211228161857621 loading=lazy src=/posts/20211222-hubot_wechat/image-20211228161857621.png></p><h3 id=参考资料>参考资料：<a hidden class=anchor aria-hidden=true href=#参考资料>#</a></h3><p><a href="https://qydev.weixin.qq.com/wiki/index.php?title=%E5%8F%91%E9%80%81%E6%8E%A5%E5%8F%A3%E8%AF%B4%E6%98%8E">https://qydev.weixin.qq.com/wiki/index.php?title=%E5%8F%91%E9%80%81%E6%8E%A5%E5%8F%A3%E8%AF%B4%E6%98%8E</a></p><p><a href=http://sd.blackball.lv/library/Automation_and_Monitoring_with_Hubot_(2014).pdf>http://sd.blackball.lv/library/Automation_and_Monitoring_with_Hubot_(2014).pdf</a></p></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://rendoumi.com/posts/20220104-javascript_babel_eslint/><span class=title>« 上一页</span><br><span>Javascript的项目与babel和eslint</span>
</a><a class=next href=https://rendoumi.com/posts/20211217-nodejs_nvm/><span class=title>下一页 »</span><br><span>nodejs多版本的安装与管理</span></a></nav></footer><div id=comments></div><script src=https://cwd.js.org/cwd.js></script><script>const comments=new CWDComments({el:"#comments",apiBaseUrl:"https://cwd.rendoumi.qzz.io"});comments.mount()</script></article></main><footer class=footer><span>Copyright © 2020-2025 Zhang Ranrui. All Rights Reserved.</span><br>·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script></body></html>