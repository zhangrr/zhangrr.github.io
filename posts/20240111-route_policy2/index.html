<!doctype html><html lang=zh dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3988508441804851" crossorigin=anonymous></script><title>多网关、策略路由、负载均衡的实际应用 | 八戒的技术博客</title>
<meta name=keywords content><meta name=description content='场景：

公司有两条线路，一条是鹏博士的，一条是电信的。
鹏博士是100兆共享线路，电信是10兆独享线路。
鹏博士对端的地址是1.1.1.1，本地服务器地址是1.1.1.2
电信对端的地址是2.2.2.2，本地服务器是2.2.2.3

所以导致有两个网关，大部分公司同事用得是100兆的共享，10兆的被客服独用，但是使用率很低。那能否两边都用呢？
答案是可以的，用策略路由就可以。
策略路由需要用到iproute2，没有的话先安装一下。
定义策略路由表
cd /etc/iproute2/  
echo "101 pengboshi" >> rt_tables  
echo "102 dianxin" >> rt_tables  
定义策略路由
ip route add default via 1.1.1.1 table 101  
ip route add default via 2.2.2.2 table 102  
ok，流量分为两个方向，进来的和出去的，先定义简单的，进来的：
ip rule add from 1.1.1.1 table 101  
ip rule add from 2.2.2.2 table 102  
出就比较麻烦了，100兆和10兆按权重来分，8：2吧
ip route replace default scope global \  
nexthop via 1.1.1.1 dev eth0 weight 8 \  
nexthop via 2.2.2.2 dev eth0:1 weight 2  
注意，因为我们是用了一台路由器来连接上面两个网关的，服务器实际是一个网卡上连到交换机，然后再上连路由器的，如下图:

我们把这一切固定下来，编辑/etc/rc.d/rc.local即可
# cat /etc/rc.local
#!/bin/sh
touch /var/lock/subsys/local  
/sbin/ip route replace default scope global nexthop via 1.1.1.1 dev eth0 weight 8 nexthop via 2.2.2.2 dev eth0:1 weight 2
'><meta name=author content="八戒"><link rel=canonical href=https://rendoumi.com/posts/20240111-route_policy2/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.5d8a858b4ad07d913988e10d3c3dbc8c171f45316a396de8a60d67f44840812d.css integrity="sha256-XYqFi0rQfZE5iOENPD28jBcfRTFqOW3opg1n9EhAgS0=" rel="preload stylesheet" as=style><link rel=icon href=https://rendoumi.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://rendoumi.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://rendoumi.com/favicon-32x32.png><link rel=apple-touch-icon href=https://rendoumi.com/apple-touch-icon.png><link rel=mask-icon href=https://rendoumi.com/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://rendoumi.com/posts/20240111-route_policy2/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><meta property="og:url" content="https://rendoumi.com/posts/20240111-route_policy2/"><meta property="og:site_name" content="八戒的技术博客"><meta property="og:title" content="多网关、策略路由、负载均衡的实际应用"><meta property="og:description" content='场景：
公司有两条线路，一条是鹏博士的，一条是电信的。 鹏博士是100兆共享线路，电信是10兆独享线路。 鹏博士对端的地址是1.1.1.1，本地服务器地址是1.1.1.2 电信对端的地址是2.2.2.2，本地服务器是2.2.2.3 所以导致有两个网关，大部分公司同事用得是100兆的共享，10兆的被客服独用，但是使用率很低。那能否两边都用呢？
答案是可以的，用策略路由就可以。
策略路由需要用到iproute2，没有的话先安装一下。
定义策略路由表
cd /etc/iproute2/ echo "101 pengboshi" >> rt_tables echo "102 dianxin" >> rt_tables 定义策略路由
ip route add default via 1.1.1.1 table 101 ip route add default via 2.2.2.2 table 102 ok，流量分为两个方向，进来的和出去的，先定义简单的，进来的：
ip rule add from 1.1.1.1 table 101 ip rule add from 2.2.2.2 table 102 出就比较麻烦了，100兆和10兆按权重来分，8：2吧
ip route replace default scope global \ nexthop via 1.1.1.1 dev eth0 weight 8 \ nexthop via 2.2.2.2 dev eth0:1 weight 2 注意，因为我们是用了一台路由器来连接上面两个网关的，服务器实际是一个网卡上连到交换机，然后再上连路由器的，如下图:
我们把这一切固定下来，编辑/etc/rc.d/rc.local即可
# cat /etc/rc.local #!/bin/sh touch /var/lock/subsys/local /sbin/ip route replace default scope global nexthop via 1.1.1.1 dev eth0 weight 8 nexthop via 2.2.2.2 dev eth0:1 weight 2 '><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-01-11T15:30:11+08:00"><meta property="article:modified_time" content="2024-01-11T15:30:11+08:00"><meta property="og:image" content="https://rendoumi.com/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://rendoumi.com/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="多网关、策略路由、负载均衡的实际应用"><meta name=twitter:description content='场景：

公司有两条线路，一条是鹏博士的，一条是电信的。
鹏博士是100兆共享线路，电信是10兆独享线路。
鹏博士对端的地址是1.1.1.1，本地服务器地址是1.1.1.2
电信对端的地址是2.2.2.2，本地服务器是2.2.2.3

所以导致有两个网关，大部分公司同事用得是100兆的共享，10兆的被客服独用，但是使用率很低。那能否两边都用呢？
答案是可以的，用策略路由就可以。
策略路由需要用到iproute2，没有的话先安装一下。
定义策略路由表
cd /etc/iproute2/  
echo "101 pengboshi" >> rt_tables  
echo "102 dianxin" >> rt_tables  
定义策略路由
ip route add default via 1.1.1.1 table 101  
ip route add default via 2.2.2.2 table 102  
ok，流量分为两个方向，进来的和出去的，先定义简单的，进来的：
ip rule add from 1.1.1.1 table 101  
ip rule add from 2.2.2.2 table 102  
出就比较麻烦了，100兆和10兆按权重来分，8：2吧
ip route replace default scope global \  
nexthop via 1.1.1.1 dev eth0 weight 8 \  
nexthop via 2.2.2.2 dev eth0:1 weight 2  
注意，因为我们是用了一台路由器来连接上面两个网关的，服务器实际是一个网卡上连到交换机，然后再上连路由器的，如下图:

我们把这一切固定下来，编辑/etc/rc.d/rc.local即可
# cat /etc/rc.local
#!/bin/sh
touch /var/lock/subsys/local  
/sbin/ip route replace default scope global nexthop via 1.1.1.1 dev eth0 weight 8 nexthop via 2.2.2.2 dev eth0:1 weight 2
'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"所有文章","item":"https://rendoumi.com/posts/"},{"@type":"ListItem","position":2,"name":"多网关、策略路由、负载均衡的实际应用","item":"https://rendoumi.com/posts/20240111-route_policy2/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"多网关、策略路由、负载均衡的实际应用","name":"多网关、策略路由、负载均衡的实际应用","description":"场景：\n公司有两条线路，一条是鹏博士的，一条是电信的。 鹏博士是100兆共享线路，电信是10兆独享线路。 鹏博士对端的地址是1.1.1.1，本地服务器地址是1.1.1.2 电信对端的地址是2.2.2.2，本地服务器是2.2.2.3 所以导致有两个网关，大部分公司同事用得是100兆的共享，10兆的被客服独用，但是使用率很低。那能否两边都用呢？\n答案是可以的，用策略路由就可以。\n策略路由需要用到iproute2，没有的话先安装一下。\n定义策略路由表\ncd /etc/iproute2/ echo \u0026#34;101 pengboshi\u0026#34; \u0026gt;\u0026gt; rt_tables echo \u0026#34;102 dianxin\u0026#34; \u0026gt;\u0026gt; rt_tables 定义策略路由\nip route add default via 1.1.1.1 table 101 ip route add default via 2.2.2.2 table 102 ok，流量分为两个方向，进来的和出去的，先定义简单的，进来的：\nip rule add from 1.1.1.1 table 101 ip rule add from 2.2.2.2 table 102 出就比较麻烦了，100兆和10兆按权重来分，8：2吧\nip route replace default scope global \\ nexthop via 1.1.1.1 dev eth0 weight 8 \\ nexthop via 2.2.2.2 dev eth0:1 weight 2 注意，因为我们是用了一台路由器来连接上面两个网关的，服务器实际是一个网卡上连到交换机，然后再上连路由器的，如下图:\n我们把这一切固定下来，编辑/etc/rc.d/rc.local即可\n# cat /etc/rc.local #!/bin/sh touch /var/lock/subsys/local /sbin/ip route replace default scope global nexthop via 1.1.1.1 dev eth0 weight 8 nexthop via 2.2.2.2 dev eth0:1 weight 2 ","keywords":[],"articleBody":"场景：\n公司有两条线路，一条是鹏博士的，一条是电信的。 鹏博士是100兆共享线路，电信是10兆独享线路。 鹏博士对端的地址是1.1.1.1，本地服务器地址是1.1.1.2 电信对端的地址是2.2.2.2，本地服务器是2.2.2.3 所以导致有两个网关，大部分公司同事用得是100兆的共享，10兆的被客服独用，但是使用率很低。那能否两边都用呢？\n答案是可以的，用策略路由就可以。\n策略路由需要用到iproute2，没有的话先安装一下。\n定义策略路由表\ncd /etc/iproute2/ echo \"101 pengboshi\" \u003e\u003e rt_tables echo \"102 dianxin\" \u003e\u003e rt_tables 定义策略路由\nip route add default via 1.1.1.1 table 101 ip route add default via 2.2.2.2 table 102 ok，流量分为两个方向，进来的和出去的，先定义简单的，进来的：\nip rule add from 1.1.1.1 table 101 ip rule add from 2.2.2.2 table 102 出就比较麻烦了，100兆和10兆按权重来分，8：2吧\nip route replace default scope global \\ nexthop via 1.1.1.1 dev eth0 weight 8 \\ nexthop via 2.2.2.2 dev eth0:1 weight 2 注意，因为我们是用了一台路由器来连接上面两个网关的，服务器实际是一个网卡上连到交换机，然后再上连路由器的，如下图:\n我们把这一切固定下来，编辑/etc/rc.d/rc.local即可\n# cat /etc/rc.local #!/bin/sh touch /var/lock/subsys/local /sbin/ip route replace default scope global nexthop via 1.1.1.1 dev eth0 weight 8 nexthop via 2.2.2.2 dev eth0:1 weight 2 ","wordCount":"104","inLanguage":"zh","image":"https://rendoumi.com/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2024-01-11T15:30:11+08:00","dateModified":"2024-01-11T15:30:11+08:00","author":{"@type":"Person","name":"八戒"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://rendoumi.com/posts/20240111-route_policy2/"},"publisher":{"@type":"Organization","name":"八戒的技术博客","logo":{"@type":"ImageObject","url":"https://rendoumi.com/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://rendoumi.com/ accesskey=h title="Home (Alt + H)"><img src=https://rendoumi.com/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches></div></div><ul id=menu><li><a href=https://rendoumi.com/ title=首页><span>首页</span></a></li><li><a href=https://rendoumi.com/posts/ title=文章><span>文章</span></a></li><li><a href=https://rendoumi.com/archives/ title=归档><span>归档</span></a></li><li><a href=https://blog.rendoumi.com title=生活><span>生活</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://rendoumi.com/search/ title=搜索><span>搜索</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://rendoumi.com/>主页</a>&nbsp;»&nbsp;<a href=https://rendoumi.com/posts/>所有文章</a></div><h1 class="post-title entry-hint-parent">多网关、策略路由、负载均衡的实际应用
<span class=entry-hint title=Draft><svg height="35" viewBox="0 -960 960 960" fill="currentcolor"><path d="M160-410v-60h3e2v60H160zm0-165v-60h470v60H160zm0-165v-60h470v60H160zm360 580v-123l221-220q9-9 20-13t22-4q12 0 23 4.5t20 13.5l37 37q9 9 13 20t4 22-4.5 22.5T862.09-380L643-160H520zm3e2-263-37-37 37 37zM580-220h38l121-122-18-19-19-18-122 121v38zm141-141-19-18 37 37-18-19z"/></svg></span></h1><div class=post-meta><span title='2024-01-11 15:30:11 +0800 CST'>2024年01月11日</span>&nbsp;·&nbsp;<span>1 分钟</span>&nbsp;·&nbsp;<span>104 字</span>&nbsp;·&nbsp;<span>八戒</span></div></header><div class=post-content><p>场景：</p><ul><li>公司有两条线路，一条是鹏博士的，一条是电信的。</li><li>鹏博士是100兆共享线路，电信是10兆独享线路。</li><li>鹏博士对端的地址是1.1.1.1，本地服务器地址是1.1.1.2</li><li>电信对端的地址是2.2.2.2，本地服务器是2.2.2.3</li></ul><p>所以导致有两个网关，大部分公司同事用得是100兆的共享，10兆的被客服独用，但是使用率很低。那能否两边都用呢？</p><p>答案是可以的，用策略路由就可以。</p><p>策略路由需要用到<strong>iproute2</strong>，没有的话先安装一下。</p><p>定义策略路由表</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /etc/iproute2/  
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;101 pengboshi&#34;</span> &gt;&gt; rt_tables  
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;102 dianxin&#34;</span> &gt;&gt; rt_tables  
</span></span></code></pre></div><p>定义策略路由</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ip route add default via 1.1.1.1 table <span class=m>101</span>  
</span></span><span class=line><span class=cl>ip route add default via 2.2.2.2 table <span class=m>102</span>  
</span></span></code></pre></div><p>ok，流量分为两个方向，进来的和出去的，先定义简单的，进来的：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ip rule add from 1.1.1.1 table <span class=m>101</span>  
</span></span><span class=line><span class=cl>ip rule add from 2.2.2.2 table <span class=m>102</span>  
</span></span></code></pre></div><p>出就比较麻烦了，100兆和10兆按权重来分，8：2吧</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ip route replace default scope global <span class=se>\ </span> 
</span></span><span class=line><span class=cl>nexthop via 1.1.1.1 dev eth0 weight <span class=m>8</span> <span class=se>\ </span> 
</span></span><span class=line><span class=cl>nexthop via 2.2.2.2 dev eth0:1 weight <span class=m>2</span>  
</span></span></code></pre></div><p>注意，因为我们是用了一台路由器来连接上面两个网关的，服务器实际是一个网卡上连到交换机，然后再上连路由器的，如下图:</p><p><img loading=lazy src=/posts/20240111-route_policy2/image-20240111164124457.png></p><p>我们把这一切固定下来，编辑/etc/rc.d/rc.local即可</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># cat /etc/rc.local</span>
</span></span><span class=line><span class=cl><span class=c1>#!/bin/sh</span>
</span></span><span class=line><span class=cl>touch /var/lock/subsys/local  
</span></span><span class=line><span class=cl>/sbin/ip route replace default scope global nexthop via 1.1.1.1 dev eth0 weight <span class=m>8</span> nexthop via 2.2.2.2 dev eth0:1 weight <span class=m>2</span>
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://rendoumi.com/posts/20240115-ssh_tun_vpn/><span class=title>« 上一页</span><br><span>用openssh的tunnel建立vpn</span>
</a><a class=next href=https://rendoumi.com/posts/20240111-keepalived_iptable_mark/><span class=title>下一页 »</span><br><span>Keepalived与iptables mark的联动</span></a></nav></footer><div id=comments></div><script src=https://cwd.js.org/cwd.js></script><script>const comments=new CWDComments({el:"#comments",apiBaseUrl:"https://cwd.rendoumi.qzz.io"});comments.mount()</script></article></main><footer class=footer><span>Copyright © 2020-2025 Zhang Ranrui. All Rights Reserved.</span><br>·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script></body></html>