<!doctype html><html lang=zh dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3988508441804851" crossorigin=anonymous></script><title>Linux下的策略路由 | 八戒的技术博客</title>
<meta name=keywords content><meta name=description content="如果我们有两条上网线路可以使用，那么策略路由就是个好的选择了。
基本概念：

策略路由表（Policy routing tables）: Linux 缺省有3个表，  local (不能改也不能删), main, 和 default。添加路由的时候如果不指定，缺省是添加到main路由表里的。
策略路由规则（Policy routing rules）: Linux 缺省也有三套路由规则，对应三个缺省路由表。

查看一下就可以看到三个表：
# ip rule list
0:    from all lookup local  
32766:    from all lookup main  
32767:    from all lookup default  
查local表的路由规则：
# ip route list table local
local 10.10.0.1 dev tun0  proto kernel  scope host  src 10.10.0.1  
broadcast 127.255.255.255 dev lo  proto kernel  scope link  src 127.0.0.1  
local 192.168.122.1 dev virbr0  proto kernel  scope host  src 192.168.122.1  
local 172.16.8.1 dev br0  proto kernel  scope host  src 172.16.8.1  
broadcast 192.168.122.0 dev virbr0  proto kernel  scope link  src 192.168.122.1  
broadcast 172.16.8.0 dev br0  proto kernel  scope link  src 172.16.8.1  
broadcast 172.16.9.255 dev br0  proto kernel  scope link  src 172.16.8.1  
broadcast 127.0.0.0 dev lo  proto kernel  scope link  src 127.0.0.1  
broadcast 192.168.122.255 dev virbr0  proto kernel  scope link  src 192.168.122.1  
local 127.0.0.1 dev lo  proto kernel  scope host  src 127.0.0.1  
local 127.0.0.0/8 dev lo  proto kernel  scope host  src 127.0.0.1  
使用策略路由的方法也很简单，1、定义一个路由表，2、定义路由规则，3、应用路由规则。"><meta name=author content><link rel=canonical href=https://rendoumi.com/posts/20240110-route_policy/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.b2ba6e41666745b5e88a4c8c21657c018b516fd59e9269084fa43fbdf5e81e5a.css integrity="sha256-srpuQWZnRbXoikyMIWV8AYtRb9WekmkIT6Q/vfXoHlo=" rel="preload stylesheet" as=style><link rel=icon href=https://rendoumi.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://rendoumi.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://rendoumi.com/favicon-32x32.png><link rel=apple-touch-icon href=https://rendoumi.com/apple-touch-icon.png><link rel=mask-icon href=https://rendoumi.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://rendoumi.com/posts/20240110-route_policy/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><meta property="og:url" content="https://rendoumi.com/posts/20240110-route_policy/"><meta property="og:site_name" content="八戒的技术博客"><meta property="og:title" content="Linux下的策略路由"><meta property="og:description" content="如果我们有两条上网线路可以使用，那么策略路由就是个好的选择了。
基本概念：
策略路由表（Policy routing tables）: Linux 缺省有3个表， local (不能改也不能删), main, 和 default。添加路由的时候如果不指定，缺省是添加到main路由表里的。 策略路由规则（Policy routing rules）: Linux 缺省也有三套路由规则，对应三个缺省路由表。 查看一下就可以看到三个表：
# ip rule list 0: from all lookup local 32766: from all lookup main 32767: from all lookup default 查local表的路由规则：
# ip route list table local local 10.10.0.1 dev tun0 proto kernel scope host src 10.10.0.1 broadcast 127.255.255.255 dev lo proto kernel scope link src 127.0.0.1 local 192.168.122.1 dev virbr0 proto kernel scope host src 192.168.122.1 local 172.16.8.1 dev br0 proto kernel scope host src 172.16.8.1 broadcast 192.168.122.0 dev virbr0 proto kernel scope link src 192.168.122.1 broadcast 172.16.8.0 dev br0 proto kernel scope link src 172.16.8.1 broadcast 172.16.9.255 dev br0 proto kernel scope link src 172.16.8.1 broadcast 127.0.0.0 dev lo proto kernel scope link src 127.0.0.1 broadcast 192.168.122.255 dev virbr0 proto kernel scope link src 192.168.122.1 local 127.0.0.1 dev lo proto kernel scope host src 127.0.0.1 local 127.0.0.0/8 dev lo proto kernel scope host src 127.0.0.1 使用策略路由的方法也很简单，1、定义一个路由表，2、定义路由规则，3、应用路由规则。"><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-01-10T09:05:11+08:00"><meta property="article:modified_time" content="2024-01-10T09:05:11+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Linux下的策略路由"><meta name=twitter:description content="如果我们有两条上网线路可以使用，那么策略路由就是个好的选择了。
基本概念：

策略路由表（Policy routing tables）: Linux 缺省有3个表，  local (不能改也不能删), main, 和 default。添加路由的时候如果不指定，缺省是添加到main路由表里的。
策略路由规则（Policy routing rules）: Linux 缺省也有三套路由规则，对应三个缺省路由表。

查看一下就可以看到三个表：
# ip rule list
0:    from all lookup local  
32766:    from all lookup main  
32767:    from all lookup default  
查local表的路由规则：
# ip route list table local
local 10.10.0.1 dev tun0  proto kernel  scope host  src 10.10.0.1  
broadcast 127.255.255.255 dev lo  proto kernel  scope link  src 127.0.0.1  
local 192.168.122.1 dev virbr0  proto kernel  scope host  src 192.168.122.1  
local 172.16.8.1 dev br0  proto kernel  scope host  src 172.16.8.1  
broadcast 192.168.122.0 dev virbr0  proto kernel  scope link  src 192.168.122.1  
broadcast 172.16.8.0 dev br0  proto kernel  scope link  src 172.16.8.1  
broadcast 172.16.9.255 dev br0  proto kernel  scope link  src 172.16.8.1  
broadcast 127.0.0.0 dev lo  proto kernel  scope link  src 127.0.0.1  
broadcast 192.168.122.255 dev virbr0  proto kernel  scope link  src 192.168.122.1  
local 127.0.0.1 dev lo  proto kernel  scope host  src 127.0.0.1  
local 127.0.0.0/8 dev lo  proto kernel  scope host  src 127.0.0.1  
使用策略路由的方法也很简单，1、定义一个路由表，2、定义路由规则，3、应用路由规则。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"所有文章","item":"https://rendoumi.com/posts/"},{"@type":"ListItem","position":2,"name":"Linux下的策略路由","item":"https://rendoumi.com/posts/20240110-route_policy/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Linux下的策略路由","name":"Linux下的策略路由","description":"如果我们有两条上网线路可以使用，那么策略路由就是个好的选择了。\n基本概念：\n策略路由表（Policy routing tables）: Linux 缺省有3个表， local (不能改也不能删), main, 和 default。添加路由的时候如果不指定，缺省是添加到main路由表里的。 策略路由规则（Policy routing rules）: Linux 缺省也有三套路由规则，对应三个缺省路由表。 查看一下就可以看到三个表：\n# ip rule list 0: from all lookup local 32766: from all lookup main 32767: from all lookup default 查local表的路由规则：\n# ip route list table local local 10.10.0.1 dev tun0 proto kernel scope host src 10.10.0.1 broadcast 127.255.255.255 dev lo proto kernel scope link src 127.0.0.1 local 192.168.122.1 dev virbr0 proto kernel scope host src 192.168.122.1 local 172.16.8.1 dev br0 proto kernel scope host src 172.16.8.1 broadcast 192.168.122.0 dev virbr0 proto kernel scope link src 192.168.122.1 broadcast 172.16.8.0 dev br0 proto kernel scope link src 172.16.8.1 broadcast 172.16.9.255 dev br0 proto kernel scope link src 172.16.8.1 broadcast 127.0.0.0 dev lo proto kernel scope link src 127.0.0.1 broadcast 192.168.122.255 dev virbr0 proto kernel scope link src 192.168.122.1 local 127.0.0.1 dev lo proto kernel scope host src 127.0.0.1 local 127.0.0.0/8 dev lo proto kernel scope host src 127.0.0.1 使用策略路由的方法也很简单，1、定义一个路由表，2、定义路由规则，3、应用路由规则。\n","keywords":[],"articleBody":"如果我们有两条上网线路可以使用，那么策略路由就是个好的选择了。\n基本概念：\n策略路由表（Policy routing tables）: Linux 缺省有3个表， local (不能改也不能删), main, 和 default。添加路由的时候如果不指定，缺省是添加到main路由表里的。 策略路由规则（Policy routing rules）: Linux 缺省也有三套路由规则，对应三个缺省路由表。 查看一下就可以看到三个表：\n# ip rule list 0: from all lookup local 32766: from all lookup main 32767: from all lookup default 查local表的路由规则：\n# ip route list table local local 10.10.0.1 dev tun0 proto kernel scope host src 10.10.0.1 broadcast 127.255.255.255 dev lo proto kernel scope link src 127.0.0.1 local 192.168.122.1 dev virbr0 proto kernel scope host src 192.168.122.1 local 172.16.8.1 dev br0 proto kernel scope host src 172.16.8.1 broadcast 192.168.122.0 dev virbr0 proto kernel scope link src 192.168.122.1 broadcast 172.16.8.0 dev br0 proto kernel scope link src 172.16.8.1 broadcast 172.16.9.255 dev br0 proto kernel scope link src 172.16.8.1 broadcast 127.0.0.0 dev lo proto kernel scope link src 127.0.0.1 broadcast 192.168.122.255 dev virbr0 proto kernel scope link src 192.168.122.1 local 127.0.0.1 dev lo proto kernel scope host src 127.0.0.1 local 127.0.0.0/8 dev lo proto kernel scope host src 127.0.0.1 使用策略路由的方法也很简单，1、定义一个路由表，2、定义路由规则，3、应用路由规则。\n一、先建立一个自定义的路由表，ID 是 10000 ，名字叫做mygod（注意，ID从0-32766之间随你便起，3万多个可选）：\necho 10000 mygod \u003e\u003e /etc/iproute2/rt_tables 二、建立路由规则\nip rule add from \u003csource address\u003e lookup 假设我们机器上连了两条线路，两块网卡，分配了2个ip，第一个线路是eth0，ip是192.168.1.1，第二个线路是eth1，ip是192.168.2.1。我们添加一下策略路由规则，从192.168.2.1过来的走mygod规则。\nip rule add from 192.168.2.1 lookup mygod 三、应用路由规则\nip route add default via 192.168.2.1 dev eth1 table mygod 注意，这里是应用了缺省路由，当然你也可以弄其他的。比如，一台机器一个网卡，N个IP，每个ip对应不同的专线。你就可以添加不同的非缺省路由。另外，也是支持vlan的。\nip route add default via 192.168.2.1 dev eth0.30 table vlan30 如果想把策略路由固定下来，不用每次都执行shell脚本，生成下面两个文件：\n# vi /etc/sysconfig/network-scripts/route-eth1 192.168.2.0/24 dev eth1 table mygod default via 192.168.2.1 dev eth1 table mygod # vi /etc/sysconfig/network-scripts/rule-eth1 from 192.168.2.0/24 lookup mygod ","wordCount":"227","inLanguage":"zh","datePublished":"2024-01-10T09:05:11+08:00","dateModified":"2024-01-10T09:05:11+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://rendoumi.com/posts/20240110-route_policy/"},"publisher":{"@type":"Organization","name":"八戒的技术博客","logo":{"@type":"ImageObject","url":"https://rendoumi.com/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://rendoumi.com/ accesskey=h title="八戒的技术博客 (Alt + H)">八戒的技术博客</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://rendoumi.com/ title=首页><span>首页</span></a></li><li><a href=https://rendoumi.com/posts/ title=文章><span>文章</span></a></li><li><a href=https://rendoumi.com/archives/ title=归档><span>归档</span></a></li><li><a href=https://blog.rendoumi.com title=生活><span>生活</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://rendoumi.com/search/ title=搜索><span>搜索</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Linux下的策略路由
<span class=entry-hint title=Draft><svg height="35" viewBox="0 -960 960 960" fill="currentcolor"><path d="M160-410v-60h3e2v60H160zm0-165v-60h470v60H160zm0-165v-60h470v60H160zm360 580v-123l221-220q9-9 20-13t22-4q12 0 23 4.5t20 13.5l37 37q9 9 13 20t4 22-4.5 22.5T862.09-380L643-160H520zm3e2-263-37-37 37 37zM580-220h38l121-122-18-19-19-18-122 121v38zm141-141-19-18 37 37-18-19z"/></svg></span></h1><div class=post-meta><span title='2024-01-10 09:05:11 +0800 CST'>2024年1月10日</span></div></header><div class=post-content><p>如果我们有两条上网线路可以使用，那么策略路由就是个好的选择了。</p><p>基本概念：</p><ul><li>策略路由表（Policy routing tables）: Linux 缺省有3个表， local (不能改也不能删), main, 和 default。添加路由的时候如果不指定，缺省是添加到<code>main</code>路由表里的。</li><li>策略路由规则（Policy routing rules）: Linux 缺省也有三套路由规则，对应三个缺省路由表。</li></ul><p>查看一下就可以看到三个表：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># ip rule list</span>
</span></span><span class=line><span class=cl>0:    from all lookup <span class=nb>local</span>  
</span></span><span class=line><span class=cl>32766:    from all lookup main  
</span></span><span class=line><span class=cl>32767:    from all lookup default  
</span></span></code></pre></div><p>查local表的路由规则：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># ip route list table local</span>
</span></span><span class=line><span class=cl><span class=nb>local</span> 10.10.0.1 dev tun0  proto kernel  scope host  src 10.10.0.1  
</span></span><span class=line><span class=cl>broadcast 127.255.255.255 dev lo  proto kernel  scope link  src 127.0.0.1  
</span></span><span class=line><span class=cl><span class=nb>local</span> 192.168.122.1 dev virbr0  proto kernel  scope host  src 192.168.122.1  
</span></span><span class=line><span class=cl><span class=nb>local</span> 172.16.8.1 dev br0  proto kernel  scope host  src 172.16.8.1  
</span></span><span class=line><span class=cl>broadcast 192.168.122.0 dev virbr0  proto kernel  scope link  src 192.168.122.1  
</span></span><span class=line><span class=cl>broadcast 172.16.8.0 dev br0  proto kernel  scope link  src 172.16.8.1  
</span></span><span class=line><span class=cl>broadcast 172.16.9.255 dev br0  proto kernel  scope link  src 172.16.8.1  
</span></span><span class=line><span class=cl>broadcast 127.0.0.0 dev lo  proto kernel  scope link  src 127.0.0.1  
</span></span><span class=line><span class=cl>broadcast 192.168.122.255 dev virbr0  proto kernel  scope link  src 192.168.122.1  
</span></span><span class=line><span class=cl><span class=nb>local</span> 127.0.0.1 dev lo  proto kernel  scope host  src 127.0.0.1  
</span></span><span class=line><span class=cl><span class=nb>local</span> 127.0.0.0/8 dev lo  proto kernel  scope host  src 127.0.0.1  
</span></span></code></pre></div><p>使用策略路由的方法也很简单，1、定义一个路由表，2、定义路由规则，3、应用路由规则。</p><p>一、先建立一个自定义的路由表，ID 是 10000 ，名字叫做mygod（注意，ID从0-32766之间随你便起，3万多个可选）：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>echo</span> <span class=m>10000</span> mygod &gt;&gt; /etc/iproute2/rt_tables  
</span></span></code></pre></div><p>二、建立路由规则</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ip rule add from &lt;<span class=nb>source</span> address&gt; lookup &lt;table name&gt;  
</span></span></code></pre></div><p>假设我们机器上连了两条线路，两块网卡，分配了2个ip，第一个线路是eth0，ip是192.168.1.1，第二个线路是eth1，ip是192.168.2.1。我们添加一下策略路由规则，从192.168.2.1过来的走mygod规则。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ip rule add from 192.168.2.1 lookup mygod  
</span></span></code></pre></div><p>三、应用路由规则</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ip route add default via 192.168.2.1 dev eth1 table mygod  
</span></span></code></pre></div><p>注意，这里是应用了缺省路由，当然你也可以弄其他的。比如，一台机器一个网卡，N个IP，每个ip对应不同的专线。你就可以添加不同的非缺省路由。另外，也是支持vlan的。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ip route add default via 192.168.2.1 dev eth0.30 table vlan30  
</span></span></code></pre></div><p>如果想把策略路由固定下来，不用每次都执行shell脚本，生成下面两个文件：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># vi /etc/sysconfig/network-scripts/route-eth1</span>
</span></span><span class=line><span class=cl>192.168.2.0/24 dev eth1 table mygod  
</span></span><span class=line><span class=cl>default via 192.168.2.1 dev eth1 table mygod
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># vi /etc/sysconfig/network-scripts/rule-eth1</span>
</span></span><span class=line><span class=cl>from 192.168.2.0/24 lookup mygod  
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>Copyright © 2020-2025 Zhang Ranrui. All Rights Reserved.</span><br>·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script></body></html>