<!doctype html><html lang=zh dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3988508441804851" crossorigin=anonymous></script><title>CentOS 7 Live-CD 的制作 | 八戒的技术博客</title>
<meta name=keywords content><meta name=description content='某些场合，很有可能需要启动ISO或者USB盘，自带Linux系统，然后拯救当前损坏的系统
或者直接启动一个LIVE CentOS系统，去做某些事，比如用MegaRaid划分Raid、测试系统等等
这时候就需要制作出来一个LIVE CD的系统了
制作步骤如下：
一、安装live-tools
yum -y install livecd-tools
二、准备Kickstart文件centos7-live-docker.ks
下载地址：centos7-live-docker.ks
lang en_GB.UTF-8
keyboard us
timezone Asia/Shanghai --isUtc

#selinux --enforcing
selinux --disabled

#firewall --enabled --service=cockpit
firewall --disabled

#xconfig --startxonboot
part / --size 8192 --fstype ext4
services --enabled=NetworkManager,sshd --disabled=network


# Root password
auth --useshadow --enablemd5
rootpw --plaintext Kalaisadog2021

repo --name=base --baseurl=http://mirror.centos.org/centos/7/os/x86_64/
repo --name=updates --baseurl=http://mirror.centos.org/centos/7/updates/x86_64/
repo --name=extras --baseurl=http://mirror.centos.org/centos/7/extras/x86_64/
repo --name=epel --baseurl=http://dl.fedoraproject.org/pub/epel/7/x86_64/

%packages 
@core
kernel
dracut
bash
firewalld
NetworkManager
e2fsprogs
rootfiles
docker
openssh-server

#By zhang ranrui
unzip
net-tools
binutils
wget
bash-completion
bc
dmidecode
dmraid
dmraid-events
lvm2
lvm2-libs
kpartx
mdadm
parted
xfsdump
xfsprogs
gdisk
bzip2
extundelete
libHX
libHX-devel
autoconf
gcc
gcc-c++
make
screen
telnet

%end

%post

systemctl enable docker

# By Zhang Ranrui, Add your custom script
#wget http://www.rendoumi.com/soft/other/xfs_irecover -O /usr/local/bin/xfs_irecover
#chmod 755 /usr/local/bin/xfs_irecover

echo "Banner /etc/issue" >> /etc/ssh/sshd_config

sed -i "s/After=network\.target/After=network-online\.target\nWants=network-online\.target/g" /usr/lib/systemd/system/rc-local.service

chmod 755 /etc/systemd/system/rc.local.service.d
chmod 644 /etc/systemd/system/rc.local.service.d/local.conf

chmod 755 /etc/rc.d/rc.local
systemctl enable rc-local
systemctl start rc-local

# FIXME: it&#39;d be better to get this installed from a package
cat > /etc/rc.d/init.d/livesys << EOF
#!/bin/bash
#
# live: Init script for live image
#
# chkconfig: 345 00 99
# description: Init script for live image.
### BEGIN INIT INFO
# X-Start-Before: display-manager
### END INIT INFO

. /etc/init.d/functions

if ! strstr "\`cat /proc/cmdline\`" rd.live.image || [ "\$1" != "start" ]; then
    exit 0
fi

if [ -e /.liveimg-configured ] ; then
    configdone=1
fi

exists() {
    which \$1 >/dev/null 2>&amp;1 || return
    \$*
}

# Make sure we don&#39;t mangle the hardware clock on shutdown
ln -sf /dev/null /etc/systemd/system/hwclock-save.service

livedir="LiveOS"
for arg in \`cat /proc/cmdline\` ; do
  if [ "\${arg##rd.live.dir=}" != "\${arg}" ]; then
    livedir=\${arg##rd.live.dir=}
    return
  fi
  if [ "\${arg##live_dir=}" != "\${arg}" ]; then
    livedir=\${arg##live_dir=}
    return
  fi
done

# enable swaps unless requested otherwise
swaps=\`blkid -t TYPE=swap -o device\`
if ! strstr "\`cat /proc/cmdline\`" noswap && [ -n "\$swaps" ] ; then
  for s in \$swaps ; do
    action "Enabling swap partition \$s" swapon \$s
  done
fi
if ! strstr "\`cat /proc/cmdline\`" noswap && [ -f /run/initramfs/live/\${livedir}/swap.img ] ; then
  action "Enabling swap file" swapon /run/initramfs/live/\${livedir}/swap.img
fi

mountDockerDisk() {
  # support label/uuid
  if [ "\${dockerdev##LABEL=}" != "\${dockerdev}" -o "\${dockerdev##UUID=}" != "\${dockerdev}" ]; then
    dockerdev=\`/sbin/blkid -o device -t "\$dockerdev"\`
  fi

  # if we&#39;re given a file rather than a blockdev, loopback it
  if [ "\${dockerdev##mtd}" != "\${dockerdev}" ]; then
    # mtd devs don&#39;t have a block device but get magic-mounted with -t jffs2
    mountopts="-t jffs2"
  elif [ ! -b "\$dockerdev" ]; then
    loopdev=\`losetup -f\`
    if [ "\${dockerdev##/run/initramfs/live}" != "\${dockerdev}" ]; then
      action "Remounting live store r/w" mount -o remount,rw /run/initramfs/live
    fi
    losetup \$loopdev \$dockerdev
    dockerdev=\$loopdev
  fi

  # if it&#39;s encrypted, we need to unlock it
  if [ "\$(/sbin/blkid -s TYPE -o value \$dockerdev 2>/dev/null)" = "crypto_LUKS" ]; then
    echo
    echo "Setting up encrypted Docker device"
    plymouth ask-for-password --command="cryptsetup luksOpen \$dockerdev EncDocker"
    dockerdev=/dev/mapper/EncDocker
  fi

  # and finally do the mount
  mount \$mountopts \$dockerdev /var/lib/docker
  # if we have /home under what&#39;s passed for persistent home, then
  # we should make that the real /home.  useful for mtd device on olpc
  if [ -d /var/lib/docker/docker ]; then mount --bind /var/lib/docker/docker /var/lib/docker ; fi
  [ -x /sbin/restorecon ] && /sbin/restorecon /var/lib/docker
}

findDockerDisk() {
  for arg in \`cat /proc/cmdline\` ; do
    if [ "\${arg##dockerdisk=}" != "\${arg}" ]; then
      dockerdev=\${arg##dockerdisk=}
      return
    fi
  done
}

if strstr "\`cat /proc/cmdline\`" dockerdisk= ; then
  findDockerDisk
elif [ -e /run/initramfs/live/\${livedir}/docker.img ]; then
  dockerdev=/run/initramfs/live/\${livedir}/docker.img
fi

# if we have a persistent /home, then we want to go ahead and mount it
if ! strstr "\`cat /proc/cmdline\`" nodockerdisk && [ -n "\$dockerdev" ] ; then
  action "Mounting persistent /var/lib/docker" mountDockerDisk
fi

# make it so that we don&#39;t do writing to the overlay for things which
# are just tmpdirs/caches
mount -t tmpfs -o mode=0755 varcacheyum /var/cache/yum
mount -t tmpfs vartmp /var/tmp
[ -x /sbin/restorecon ] && /sbin/restorecon /var/cache/yum /var/tmp >/dev/null 2>&amp;1

if [ -n "\$configdone" ]; then
  exit 0
fi

# add fedora user with no passwd
action "Adding live user" useradd \$USERADDARGS -c "Live System User" liveuser
passwd -d liveuser > /dev/null
usermod -aG wheel,docker liveuser > /dev/null

# Remove root password lock
passwd -d root > /dev/null
(echo Kalaisadog2021; echo Kalaisadog2021)|passwd root --stdin

# turn off firstboot for livecd boots
systemctl --no-reload disable firstboot-text.service 2> /dev/null || :
systemctl --no-reload disable firstboot-graphical.service 2> /dev/null || :
systemctl stop firstboot-text.service 2> /dev/null || :
systemctl stop firstboot-graphical.service 2> /dev/null || :

# don&#39;t use prelink on a running live image
sed -i &#39;s/PRELINKING=yes/PRELINKING=no/&#39; /etc/sysconfig/prelink &>/dev/null || :

# turn off mdmonitor by default
systemctl --no-reload disable mdmonitor.service 2> /dev/null || :
systemctl --no-reload disable mdmonitor-takeover.service 2> /dev/null || :
systemctl stop mdmonitor.service 2> /dev/null || :
systemctl stop mdmonitor-takeover.service 2> /dev/null || :

# don&#39;t enable the gnome-settings-daemon packagekit plugin
gsettings set org.gnome.settings-daemon.plugins.updates active &#39;false&#39; || :

# don&#39;t start cron/at as they tend to spawn things which are
# disk intensive that are painful on a live image
systemctl --no-reload disable crond.service 2> /dev/null || :
systemctl --no-reload disable atd.service 2> /dev/null || :
systemctl stop crond.service 2> /dev/null || :
systemctl stop atd.service 2> /dev/null || :

# Mark things as configured
touch /.liveimg-configured

# add static hostname to work around xauth bug
# https://bugzilla.redhat.com/show_bug.cgi?id=679486
echo "localhost" > /etc/hostname

# Fixing the lang install issue when other lang than English is selected . See http://bugs.centos.org/view.php?id=7217
/usr/bin/cp /usr/lib/python2.7/site-packages/blivet/size.py /usr/lib/python2.7/site-packages/blivet/size.py.orig
/usr/bin/sed -i "s#return self.humanReadable()#return self.humanReadable().encode(&#39;utf-8&#39;)#g" /usr/lib/python2.7/site-packages/blivet/size.py

EOF

# bah, hal starts way too late
cat > /etc/rc.d/init.d/livesys-late << EOF
#!/bin/bash
#
# live: Late init script for live image
#
# chkconfig: 345 99 01
# description: Late init script for live image.

. /etc/init.d/functions

if ! strstr "\`cat /proc/cmdline\`" rd.live.image || [ "\$1" != "start" ] || [ -e /.liveimg-late-configured ] ; then
    exit 0
fi

exists() {
    which \$1 >/dev/null 2>&amp;1 || return
    \$*
}

touch /.liveimg-late-configured

# read some variables out of /proc/cmdline
for o in \`cat /proc/cmdline\` ; do
    case \$o in
    ks=*)
        ks="--kickstart=\${o#ks=}"
        ;;
    xdriver=*)
        xdriver="\${o#xdriver=}"
        ;;
    esac
done

# if liveinst or textinst is given, start anaconda
if strstr "\`cat /proc/cmdline\`" liveinst ; then
   plymouth --quit
   /usr/sbin/liveinst \$ks
fi
if strstr "\`cat /proc/cmdline\`" textinst ; then
   plymouth --quit
   /usr/sbin/liveinst --text \$ks
fi

# configure X, allowing user to override xdriver
if [ -n "\$xdriver" ]; then
   cat > /etc/X11/xorg.conf.d/00-xdriver.conf <<FOE
Section "Device"
        Identifier      "Videocard0"
        Driver  "\$xdriver"
EndSection
FOE
fi

EOF

chmod 755 /etc/rc.d/init.d/livesys
/sbin/restorecon /etc/rc.d/init.d/livesys
/sbin/chkconfig --add livesys

chmod 755 /etc/rc.d/init.d/livesys-late
/sbin/restorecon /etc/rc.d/init.d/livesys-late
/sbin/chkconfig --add livesys-late

# enable tmpfs for /tmp
systemctl enable tmp.mount


# enable docker
systemctl enable docker.service

# work around for poor key import UI in PackageKit
rm -f /var/lib/rpm/__db*
releasever=$(rpm -q --qf &#39;%{version}\n&#39; --whatprovides system-release)
basearch=$(uname -i)
rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-fedora-$releasever-$basearch
echo "Packages within this LiveCD"
rpm -qa
# Note that running rpm recreates the rpm db files which aren&#39;t needed or wanted
rm -f /var/lib/rpm/__db*

# go ahead and pre-make the man -k cache (#455968)
/usr/bin/mandb

# save a little bit of space at least...
rm -f /boot/initramfs*
# make sure there aren&#39;t core files lying around
rm -f /core*

# convince readahead not to collect
# FIXME: for systemd

cat >> /etc/rc.d/init.d/livesys << EOF


# disable updates plugin
cat >> /usr/share/glib-2.0/schemas/org.gnome.settings-daemon.plugins.updates.gschema.override << FOE
[org.gnome.settings-daemon.plugins.updates]
active=false
FOE

# Show the system-config-keyboard tool on the desktop
mkdir /home/liveuser/Desktop -p >/dev/null
cat /usr/share/applications/system-config-keyboard.desktop | sed &#39;/NotShowIn/d&#39; |sed &#39;s/Terminal=false/Terminal=true/&#39; > /home/liveuser/Desktop/system-config-keyboard.desktop
cat /usr/share/applications/liveinst.desktop | sed &#39;/NoDisplay/d&#39; > /home/liveuser/Desktop/liveinst.desktop 
chmod +x /home/liveuser/Desktop/*.desktop
chown -R liveuser:liveuser /home/liveuser

# Liveuser face
if [ -e /usr/share/icons/hicolor/96x96/apps/fedora-logo-icon.png ] ; then
    cp /usr/share/icons/hicolor/96x96/apps/fedora-logo-icon.png /home/liveuser/.face
    chown liveuser:liveuser /home/liveuser/.face
fi

# make the installer show up
if [ -f /usr/share/applications/liveinst.desktop ]; then
  # Show harddisk install in shell dash
  sed -i -e &#39;s/NoDisplay=true/NoDisplay=false/&#39; /usr/share/applications/liveinst.desktop 
  # need to move it to anaconda.desktop to make shell happy
  #cp /usr/share/applications/liveinst.desktop /usr/share/applications/anaconda.desktop
fi
  cat >> /usr/share/glib-2.0/schemas/org.gnome.shell.gschema.override << FOE
[org.gnome.shell]
favorite-apps=[&#39;liveinst.desktop&#39;,&#39;firefox.desktop&#39;, &#39;evolution.desktop&#39;, &#39;empathy.desktop&#39;, &#39;rhythmbox.desktop&#39;, &#39;shotwell.desktop&#39;, &#39;libreoffice-writer.desktop&#39;, &#39;nautilus.desktop&#39;, &#39;gnome-documents.desktop&#39;, &#39;anaconda.desktop&#39;]
FOE


# set up auto-login
cat > /etc/gdm/custom.conf << FOE
[daemon]
AutomaticLoginEnable=True
AutomaticLogin=liveuser
FOE

# Turn off PackageKit-command-not-found while uninstalled
if [ -f /etc/PackageKit/CommandNotFound.conf ]; then
  sed -i -e &#39;s/^SoftwareSourceSearch=true/SoftwareSourceSearch=false/&#39; /etc/PackageKit/CommandNotFound.conf
fi

# make sure to set the right permissions and selinux contexts
chown -R liveuser:liveuser /home/liveuser/
restorecon -R /home/liveuser/

# Fixing default locale to us
localectl set-keymap us
localectl set-x11-keymap us
EOF


# rebuild schema cache with any overrides we installed
glib-compile-schemas /usr/share/glib-2.0/schemas


%end
注意，上面注释了两个地方，都可以添加软件或者运行脚本'><meta name=author content="八戒"><link rel=canonical href=https://rendoumi.com/posts/20211010-live_cd/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.5d8a858b4ad07d913988e10d3c3dbc8c171f45316a396de8a60d67f44840812d.css integrity="sha256-XYqFi0rQfZE5iOENPD28jBcfRTFqOW3opg1n9EhAgS0=" rel="preload stylesheet" as=style><link rel=icon href=https://rendoumi.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://rendoumi.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://rendoumi.com/favicon-32x32.png><link rel=apple-touch-icon href=https://rendoumi.com/apple-touch-icon.png><link rel=mask-icon href=https://rendoumi.com/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://rendoumi.com/posts/20211010-live_cd/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><meta property="og:url" content="https://rendoumi.com/posts/20211010-live_cd/"><meta property="og:site_name" content="八戒的技术博客"><meta property="og:title" content="CentOS 7 Live-CD 的制作"><meta property="og:description" content='某些场合，很有可能需要启动ISO或者USB盘，自带Linux系统，然后拯救当前损坏的系统
或者直接启动一个LIVE CentOS系统，去做某些事，比如用MegaRaid划分Raid、测试系统等等
这时候就需要制作出来一个LIVE CD的系统了
制作步骤如下：
一、安装live-tools yum -y install livecd-tools 二、准备Kickstart文件centos7-live-docker.ks 下载地址：centos7-live-docker.ks
lang en_GB.UTF-8 keyboard us timezone Asia/Shanghai --isUtc #selinux --enforcing selinux --disabled #firewall --enabled --service=cockpit firewall --disabled #xconfig --startxonboot part / --size 8192 --fstype ext4 services --enabled=NetworkManager,sshd --disabled=network # Root password auth --useshadow --enablemd5 rootpw --plaintext Kalaisadog2021 repo --name=base --baseurl=http://mirror.centos.org/centos/7/os/x86_64/ repo --name=updates --baseurl=http://mirror.centos.org/centos/7/updates/x86_64/ repo --name=extras --baseurl=http://mirror.centos.org/centos/7/extras/x86_64/ repo --name=epel --baseurl=http://dl.fedoraproject.org/pub/epel/7/x86_64/ %packages @core kernel dracut bash firewalld NetworkManager e2fsprogs rootfiles docker openssh-server #By zhang ranrui unzip net-tools binutils wget bash-completion bc dmidecode dmraid dmraid-events lvm2 lvm2-libs kpartx mdadm parted xfsdump xfsprogs gdisk bzip2 extundelete libHX libHX-devel autoconf gcc gcc-c++ make screen telnet %end %post systemctl enable docker # By Zhang Ranrui, Add your custom script #wget http://www.rendoumi.com/soft/other/xfs_irecover -O /usr/local/bin/xfs_irecover #chmod 755 /usr/local/bin/xfs_irecover echo "Banner /etc/issue" >> /etc/ssh/sshd_config sed -i "s/After=network\.target/After=network-online\.target\nWants=network-online\.target/g" /usr/lib/systemd/system/rc-local.service chmod 755 /etc/systemd/system/rc.local.service.d chmod 644 /etc/systemd/system/rc.local.service.d/local.conf chmod 755 /etc/rc.d/rc.local systemctl enable rc-local systemctl start rc-local # FIXME: it&#39;d be better to get this installed from a package cat > /etc/rc.d/init.d/livesys << EOF #!/bin/bash # # live: Init script for live image # # chkconfig: 345 00 99 # description: Init script for live image. ### BEGIN INIT INFO # X-Start-Before: display-manager ### END INIT INFO . /etc/init.d/functions if ! strstr "\`cat /proc/cmdline\`" rd.live.image || [ "\$1" != "start" ]; then exit 0 fi if [ -e /.liveimg-configured ] ; then configdone=1 fi exists() { which \$1 >/dev/null 2>&amp;1 || return \$* } # Make sure we don&#39;t mangle the hardware clock on shutdown ln -sf /dev/null /etc/systemd/system/hwclock-save.service livedir="LiveOS" for arg in \`cat /proc/cmdline\` ; do if [ "\${arg##rd.live.dir=}" != "\${arg}" ]; then livedir=\${arg##rd.live.dir=} return fi if [ "\${arg##live_dir=}" != "\${arg}" ]; then livedir=\${arg##live_dir=} return fi done # enable swaps unless requested otherwise swaps=\`blkid -t TYPE=swap -o device\` if ! strstr "\`cat /proc/cmdline\`" noswap && [ -n "\$swaps" ] ; then for s in \$swaps ; do action "Enabling swap partition \$s" swapon \$s done fi if ! strstr "\`cat /proc/cmdline\`" noswap && [ -f /run/initramfs/live/\${livedir}/swap.img ] ; then action "Enabling swap file" swapon /run/initramfs/live/\${livedir}/swap.img fi mountDockerDisk() { # support label/uuid if [ "\${dockerdev##LABEL=}" != "\${dockerdev}" -o "\${dockerdev##UUID=}" != "\${dockerdev}" ]; then dockerdev=\`/sbin/blkid -o device -t "\$dockerdev"\` fi # if we&#39;re given a file rather than a blockdev, loopback it if [ "\${dockerdev##mtd}" != "\${dockerdev}" ]; then # mtd devs don&#39;t have a block device but get magic-mounted with -t jffs2 mountopts="-t jffs2" elif [ ! -b "\$dockerdev" ]; then loopdev=\`losetup -f\` if [ "\${dockerdev##/run/initramfs/live}" != "\${dockerdev}" ]; then action "Remounting live store r/w" mount -o remount,rw /run/initramfs/live fi losetup \$loopdev \$dockerdev dockerdev=\$loopdev fi # if it&#39;s encrypted, we need to unlock it if [ "\$(/sbin/blkid -s TYPE -o value \$dockerdev 2>/dev/null)" = "crypto_LUKS" ]; then echo echo "Setting up encrypted Docker device" plymouth ask-for-password --command="cryptsetup luksOpen \$dockerdev EncDocker" dockerdev=/dev/mapper/EncDocker fi # and finally do the mount mount \$mountopts \$dockerdev /var/lib/docker # if we have /home under what&#39;s passed for persistent home, then # we should make that the real /home. useful for mtd device on olpc if [ -d /var/lib/docker/docker ]; then mount --bind /var/lib/docker/docker /var/lib/docker ; fi [ -x /sbin/restorecon ] && /sbin/restorecon /var/lib/docker } findDockerDisk() { for arg in \`cat /proc/cmdline\` ; do if [ "\${arg##dockerdisk=}" != "\${arg}" ]; then dockerdev=\${arg##dockerdisk=} return fi done } if strstr "\`cat /proc/cmdline\`" dockerdisk= ; then findDockerDisk elif [ -e /run/initramfs/live/\${livedir}/docker.img ]; then dockerdev=/run/initramfs/live/\${livedir}/docker.img fi # if we have a persistent /home, then we want to go ahead and mount it if ! strstr "\`cat /proc/cmdline\`" nodockerdisk && [ -n "\$dockerdev" ] ; then action "Mounting persistent /var/lib/docker" mountDockerDisk fi # make it so that we don&#39;t do writing to the overlay for things which # are just tmpdirs/caches mount -t tmpfs -o mode=0755 varcacheyum /var/cache/yum mount -t tmpfs vartmp /var/tmp [ -x /sbin/restorecon ] && /sbin/restorecon /var/cache/yum /var/tmp >/dev/null 2>&amp;1 if [ -n "\$configdone" ]; then exit 0 fi # add fedora user with no passwd action "Adding live user" useradd \$USERADDARGS -c "Live System User" liveuser passwd -d liveuser > /dev/null usermod -aG wheel,docker liveuser > /dev/null # Remove root password lock passwd -d root > /dev/null (echo Kalaisadog2021; echo Kalaisadog2021)|passwd root --stdin # turn off firstboot for livecd boots systemctl --no-reload disable firstboot-text.service 2> /dev/null || : systemctl --no-reload disable firstboot-graphical.service 2> /dev/null || : systemctl stop firstboot-text.service 2> /dev/null || : systemctl stop firstboot-graphical.service 2> /dev/null || : # don&#39;t use prelink on a running live image sed -i &#39;s/PRELINKING=yes/PRELINKING=no/&#39; /etc/sysconfig/prelink &>/dev/null || : # turn off mdmonitor by default systemctl --no-reload disable mdmonitor.service 2> /dev/null || : systemctl --no-reload disable mdmonitor-takeover.service 2> /dev/null || : systemctl stop mdmonitor.service 2> /dev/null || : systemctl stop mdmonitor-takeover.service 2> /dev/null || : # don&#39;t enable the gnome-settings-daemon packagekit plugin gsettings set org.gnome.settings-daemon.plugins.updates active &#39;false&#39; || : # don&#39;t start cron/at as they tend to spawn things which are # disk intensive that are painful on a live image systemctl --no-reload disable crond.service 2> /dev/null || : systemctl --no-reload disable atd.service 2> /dev/null || : systemctl stop crond.service 2> /dev/null || : systemctl stop atd.service 2> /dev/null || : # Mark things as configured touch /.liveimg-configured # add static hostname to work around xauth bug # https://bugzilla.redhat.com/show_bug.cgi?id=679486 echo "localhost" > /etc/hostname # Fixing the lang install issue when other lang than English is selected . See http://bugs.centos.org/view.php?id=7217 /usr/bin/cp /usr/lib/python2.7/site-packages/blivet/size.py /usr/lib/python2.7/site-packages/blivet/size.py.orig /usr/bin/sed -i "s#return self.humanReadable()#return self.humanReadable().encode(&#39;utf-8&#39;)#g" /usr/lib/python2.7/site-packages/blivet/size.py EOF # bah, hal starts way too late cat > /etc/rc.d/init.d/livesys-late << EOF #!/bin/bash # # live: Late init script for live image # # chkconfig: 345 99 01 # description: Late init script for live image. . /etc/init.d/functions if ! strstr "\`cat /proc/cmdline\`" rd.live.image || [ "\$1" != "start" ] || [ -e /.liveimg-late-configured ] ; then exit 0 fi exists() { which \$1 >/dev/null 2>&amp;1 || return \$* } touch /.liveimg-late-configured # read some variables out of /proc/cmdline for o in \`cat /proc/cmdline\` ; do case \$o in ks=*) ks="--kickstart=\${o#ks=}" ;; xdriver=*) xdriver="\${o#xdriver=}" ;; esac done # if liveinst or textinst is given, start anaconda if strstr "\`cat /proc/cmdline\`" liveinst ; then plymouth --quit /usr/sbin/liveinst \$ks fi if strstr "\`cat /proc/cmdline\`" textinst ; then plymouth --quit /usr/sbin/liveinst --text \$ks fi # configure X, allowing user to override xdriver if [ -n "\$xdriver" ]; then cat > /etc/X11/xorg.conf.d/00-xdriver.conf <<FOE Section "Device" Identifier "Videocard0" Driver "\$xdriver" EndSection FOE fi EOF chmod 755 /etc/rc.d/init.d/livesys /sbin/restorecon /etc/rc.d/init.d/livesys /sbin/chkconfig --add livesys chmod 755 /etc/rc.d/init.d/livesys-late /sbin/restorecon /etc/rc.d/init.d/livesys-late /sbin/chkconfig --add livesys-late # enable tmpfs for /tmp systemctl enable tmp.mount # enable docker systemctl enable docker.service # work around for poor key import UI in PackageKit rm -f /var/lib/rpm/__db* releasever=$(rpm -q --qf &#39;%{version}\n&#39; --whatprovides system-release) basearch=$(uname -i) rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-fedora-$releasever-$basearch echo "Packages within this LiveCD" rpm -qa # Note that running rpm recreates the rpm db files which aren&#39;t needed or wanted rm -f /var/lib/rpm/__db* # go ahead and pre-make the man -k cache (#455968) /usr/bin/mandb # save a little bit of space at least... rm -f /boot/initramfs* # make sure there aren&#39;t core files lying around rm -f /core* # convince readahead not to collect # FIXME: for systemd cat >> /etc/rc.d/init.d/livesys << EOF # disable updates plugin cat >> /usr/share/glib-2.0/schemas/org.gnome.settings-daemon.plugins.updates.gschema.override << FOE [org.gnome.settings-daemon.plugins.updates] active=false FOE # Show the system-config-keyboard tool on the desktop mkdir /home/liveuser/Desktop -p >/dev/null cat /usr/share/applications/system-config-keyboard.desktop | sed &#39;/NotShowIn/d&#39; |sed &#39;s/Terminal=false/Terminal=true/&#39; > /home/liveuser/Desktop/system-config-keyboard.desktop cat /usr/share/applications/liveinst.desktop | sed &#39;/NoDisplay/d&#39; > /home/liveuser/Desktop/liveinst.desktop chmod +x /home/liveuser/Desktop/*.desktop chown -R liveuser:liveuser /home/liveuser # Liveuser face if [ -e /usr/share/icons/hicolor/96x96/apps/fedora-logo-icon.png ] ; then cp /usr/share/icons/hicolor/96x96/apps/fedora-logo-icon.png /home/liveuser/.face chown liveuser:liveuser /home/liveuser/.face fi # make the installer show up if [ -f /usr/share/applications/liveinst.desktop ]; then # Show harddisk install in shell dash sed -i -e &#39;s/NoDisplay=true/NoDisplay=false/&#39; /usr/share/applications/liveinst.desktop # need to move it to anaconda.desktop to make shell happy #cp /usr/share/applications/liveinst.desktop /usr/share/applications/anaconda.desktop fi cat >> /usr/share/glib-2.0/schemas/org.gnome.shell.gschema.override << FOE [org.gnome.shell] favorite-apps=[&#39;liveinst.desktop&#39;,&#39;firefox.desktop&#39;, &#39;evolution.desktop&#39;, &#39;empathy.desktop&#39;, &#39;rhythmbox.desktop&#39;, &#39;shotwell.desktop&#39;, &#39;libreoffice-writer.desktop&#39;, &#39;nautilus.desktop&#39;, &#39;gnome-documents.desktop&#39;, &#39;anaconda.desktop&#39;] FOE # set up auto-login cat > /etc/gdm/custom.conf << FOE [daemon] AutomaticLoginEnable=True AutomaticLogin=liveuser FOE # Turn off PackageKit-command-not-found while uninstalled if [ -f /etc/PackageKit/CommandNotFound.conf ]; then sed -i -e &#39;s/^SoftwareSourceSearch=true/SoftwareSourceSearch=false/&#39; /etc/PackageKit/CommandNotFound.conf fi # make sure to set the right permissions and selinux contexts chown -R liveuser:liveuser /home/liveuser/ restorecon -R /home/liveuser/ # Fixing default locale to us localectl set-keymap us localectl set-x11-keymap us EOF # rebuild schema cache with any overrides we installed glib-compile-schemas /usr/share/glib-2.0/schemas %end 注意，上面注释了两个地方，都可以添加软件或者运行脚本'><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-10-10T09:30:11+08:00"><meta property="article:modified_time" content="2021-10-10T09:30:11+08:00"><meta property="og:image" content="https://rendoumi.com/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://rendoumi.com/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="CentOS 7 Live-CD 的制作"><meta name=twitter:description content='某些场合，很有可能需要启动ISO或者USB盘，自带Linux系统，然后拯救当前损坏的系统
或者直接启动一个LIVE CentOS系统，去做某些事，比如用MegaRaid划分Raid、测试系统等等
这时候就需要制作出来一个LIVE CD的系统了
制作步骤如下：
一、安装live-tools
yum -y install livecd-tools
二、准备Kickstart文件centos7-live-docker.ks
下载地址：centos7-live-docker.ks
lang en_GB.UTF-8
keyboard us
timezone Asia/Shanghai --isUtc

#selinux --enforcing
selinux --disabled

#firewall --enabled --service=cockpit
firewall --disabled

#xconfig --startxonboot
part / --size 8192 --fstype ext4
services --enabled=NetworkManager,sshd --disabled=network


# Root password
auth --useshadow --enablemd5
rootpw --plaintext Kalaisadog2021

repo --name=base --baseurl=http://mirror.centos.org/centos/7/os/x86_64/
repo --name=updates --baseurl=http://mirror.centos.org/centos/7/updates/x86_64/
repo --name=extras --baseurl=http://mirror.centos.org/centos/7/extras/x86_64/
repo --name=epel --baseurl=http://dl.fedoraproject.org/pub/epel/7/x86_64/

%packages 
@core
kernel
dracut
bash
firewalld
NetworkManager
e2fsprogs
rootfiles
docker
openssh-server

#By zhang ranrui
unzip
net-tools
binutils
wget
bash-completion
bc
dmidecode
dmraid
dmraid-events
lvm2
lvm2-libs
kpartx
mdadm
parted
xfsdump
xfsprogs
gdisk
bzip2
extundelete
libHX
libHX-devel
autoconf
gcc
gcc-c++
make
screen
telnet

%end

%post

systemctl enable docker

# By Zhang Ranrui, Add your custom script
#wget http://www.rendoumi.com/soft/other/xfs_irecover -O /usr/local/bin/xfs_irecover
#chmod 755 /usr/local/bin/xfs_irecover

echo "Banner /etc/issue" >> /etc/ssh/sshd_config

sed -i "s/After=network\.target/After=network-online\.target\nWants=network-online\.target/g" /usr/lib/systemd/system/rc-local.service

chmod 755 /etc/systemd/system/rc.local.service.d
chmod 644 /etc/systemd/system/rc.local.service.d/local.conf

chmod 755 /etc/rc.d/rc.local
systemctl enable rc-local
systemctl start rc-local

# FIXME: it&#39;d be better to get this installed from a package
cat > /etc/rc.d/init.d/livesys << EOF
#!/bin/bash
#
# live: Init script for live image
#
# chkconfig: 345 00 99
# description: Init script for live image.
### BEGIN INIT INFO
# X-Start-Before: display-manager
### END INIT INFO

. /etc/init.d/functions

if ! strstr "\`cat /proc/cmdline\`" rd.live.image || [ "\$1" != "start" ]; then
    exit 0
fi

if [ -e /.liveimg-configured ] ; then
    configdone=1
fi

exists() {
    which \$1 >/dev/null 2>&amp;1 || return
    \$*
}

# Make sure we don&#39;t mangle the hardware clock on shutdown
ln -sf /dev/null /etc/systemd/system/hwclock-save.service

livedir="LiveOS"
for arg in \`cat /proc/cmdline\` ; do
  if [ "\${arg##rd.live.dir=}" != "\${arg}" ]; then
    livedir=\${arg##rd.live.dir=}
    return
  fi
  if [ "\${arg##live_dir=}" != "\${arg}" ]; then
    livedir=\${arg##live_dir=}
    return
  fi
done

# enable swaps unless requested otherwise
swaps=\`blkid -t TYPE=swap -o device\`
if ! strstr "\`cat /proc/cmdline\`" noswap && [ -n "\$swaps" ] ; then
  for s in \$swaps ; do
    action "Enabling swap partition \$s" swapon \$s
  done
fi
if ! strstr "\`cat /proc/cmdline\`" noswap && [ -f /run/initramfs/live/\${livedir}/swap.img ] ; then
  action "Enabling swap file" swapon /run/initramfs/live/\${livedir}/swap.img
fi

mountDockerDisk() {
  # support label/uuid
  if [ "\${dockerdev##LABEL=}" != "\${dockerdev}" -o "\${dockerdev##UUID=}" != "\${dockerdev}" ]; then
    dockerdev=\`/sbin/blkid -o device -t "\$dockerdev"\`
  fi

  # if we&#39;re given a file rather than a blockdev, loopback it
  if [ "\${dockerdev##mtd}" != "\${dockerdev}" ]; then
    # mtd devs don&#39;t have a block device but get magic-mounted with -t jffs2
    mountopts="-t jffs2"
  elif [ ! -b "\$dockerdev" ]; then
    loopdev=\`losetup -f\`
    if [ "\${dockerdev##/run/initramfs/live}" != "\${dockerdev}" ]; then
      action "Remounting live store r/w" mount -o remount,rw /run/initramfs/live
    fi
    losetup \$loopdev \$dockerdev
    dockerdev=\$loopdev
  fi

  # if it&#39;s encrypted, we need to unlock it
  if [ "\$(/sbin/blkid -s TYPE -o value \$dockerdev 2>/dev/null)" = "crypto_LUKS" ]; then
    echo
    echo "Setting up encrypted Docker device"
    plymouth ask-for-password --command="cryptsetup luksOpen \$dockerdev EncDocker"
    dockerdev=/dev/mapper/EncDocker
  fi

  # and finally do the mount
  mount \$mountopts \$dockerdev /var/lib/docker
  # if we have /home under what&#39;s passed for persistent home, then
  # we should make that the real /home.  useful for mtd device on olpc
  if [ -d /var/lib/docker/docker ]; then mount --bind /var/lib/docker/docker /var/lib/docker ; fi
  [ -x /sbin/restorecon ] && /sbin/restorecon /var/lib/docker
}

findDockerDisk() {
  for arg in \`cat /proc/cmdline\` ; do
    if [ "\${arg##dockerdisk=}" != "\${arg}" ]; then
      dockerdev=\${arg##dockerdisk=}
      return
    fi
  done
}

if strstr "\`cat /proc/cmdline\`" dockerdisk= ; then
  findDockerDisk
elif [ -e /run/initramfs/live/\${livedir}/docker.img ]; then
  dockerdev=/run/initramfs/live/\${livedir}/docker.img
fi

# if we have a persistent /home, then we want to go ahead and mount it
if ! strstr "\`cat /proc/cmdline\`" nodockerdisk && [ -n "\$dockerdev" ] ; then
  action "Mounting persistent /var/lib/docker" mountDockerDisk
fi

# make it so that we don&#39;t do writing to the overlay for things which
# are just tmpdirs/caches
mount -t tmpfs -o mode=0755 varcacheyum /var/cache/yum
mount -t tmpfs vartmp /var/tmp
[ -x /sbin/restorecon ] && /sbin/restorecon /var/cache/yum /var/tmp >/dev/null 2>&amp;1

if [ -n "\$configdone" ]; then
  exit 0
fi

# add fedora user with no passwd
action "Adding live user" useradd \$USERADDARGS -c "Live System User" liveuser
passwd -d liveuser > /dev/null
usermod -aG wheel,docker liveuser > /dev/null

# Remove root password lock
passwd -d root > /dev/null
(echo Kalaisadog2021; echo Kalaisadog2021)|passwd root --stdin

# turn off firstboot for livecd boots
systemctl --no-reload disable firstboot-text.service 2> /dev/null || :
systemctl --no-reload disable firstboot-graphical.service 2> /dev/null || :
systemctl stop firstboot-text.service 2> /dev/null || :
systemctl stop firstboot-graphical.service 2> /dev/null || :

# don&#39;t use prelink on a running live image
sed -i &#39;s/PRELINKING=yes/PRELINKING=no/&#39; /etc/sysconfig/prelink &>/dev/null || :

# turn off mdmonitor by default
systemctl --no-reload disable mdmonitor.service 2> /dev/null || :
systemctl --no-reload disable mdmonitor-takeover.service 2> /dev/null || :
systemctl stop mdmonitor.service 2> /dev/null || :
systemctl stop mdmonitor-takeover.service 2> /dev/null || :

# don&#39;t enable the gnome-settings-daemon packagekit plugin
gsettings set org.gnome.settings-daemon.plugins.updates active &#39;false&#39; || :

# don&#39;t start cron/at as they tend to spawn things which are
# disk intensive that are painful on a live image
systemctl --no-reload disable crond.service 2> /dev/null || :
systemctl --no-reload disable atd.service 2> /dev/null || :
systemctl stop crond.service 2> /dev/null || :
systemctl stop atd.service 2> /dev/null || :

# Mark things as configured
touch /.liveimg-configured

# add static hostname to work around xauth bug
# https://bugzilla.redhat.com/show_bug.cgi?id=679486
echo "localhost" > /etc/hostname

# Fixing the lang install issue when other lang than English is selected . See http://bugs.centos.org/view.php?id=7217
/usr/bin/cp /usr/lib/python2.7/site-packages/blivet/size.py /usr/lib/python2.7/site-packages/blivet/size.py.orig
/usr/bin/sed -i "s#return self.humanReadable()#return self.humanReadable().encode(&#39;utf-8&#39;)#g" /usr/lib/python2.7/site-packages/blivet/size.py

EOF

# bah, hal starts way too late
cat > /etc/rc.d/init.d/livesys-late << EOF
#!/bin/bash
#
# live: Late init script for live image
#
# chkconfig: 345 99 01
# description: Late init script for live image.

. /etc/init.d/functions

if ! strstr "\`cat /proc/cmdline\`" rd.live.image || [ "\$1" != "start" ] || [ -e /.liveimg-late-configured ] ; then
    exit 0
fi

exists() {
    which \$1 >/dev/null 2>&amp;1 || return
    \$*
}

touch /.liveimg-late-configured

# read some variables out of /proc/cmdline
for o in \`cat /proc/cmdline\` ; do
    case \$o in
    ks=*)
        ks="--kickstart=\${o#ks=}"
        ;;
    xdriver=*)
        xdriver="\${o#xdriver=}"
        ;;
    esac
done

# if liveinst or textinst is given, start anaconda
if strstr "\`cat /proc/cmdline\`" liveinst ; then
   plymouth --quit
   /usr/sbin/liveinst \$ks
fi
if strstr "\`cat /proc/cmdline\`" textinst ; then
   plymouth --quit
   /usr/sbin/liveinst --text \$ks
fi

# configure X, allowing user to override xdriver
if [ -n "\$xdriver" ]; then
   cat > /etc/X11/xorg.conf.d/00-xdriver.conf <<FOE
Section "Device"
        Identifier      "Videocard0"
        Driver  "\$xdriver"
EndSection
FOE
fi

EOF

chmod 755 /etc/rc.d/init.d/livesys
/sbin/restorecon /etc/rc.d/init.d/livesys
/sbin/chkconfig --add livesys

chmod 755 /etc/rc.d/init.d/livesys-late
/sbin/restorecon /etc/rc.d/init.d/livesys-late
/sbin/chkconfig --add livesys-late

# enable tmpfs for /tmp
systemctl enable tmp.mount


# enable docker
systemctl enable docker.service

# work around for poor key import UI in PackageKit
rm -f /var/lib/rpm/__db*
releasever=$(rpm -q --qf &#39;%{version}\n&#39; --whatprovides system-release)
basearch=$(uname -i)
rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-fedora-$releasever-$basearch
echo "Packages within this LiveCD"
rpm -qa
# Note that running rpm recreates the rpm db files which aren&#39;t needed or wanted
rm -f /var/lib/rpm/__db*

# go ahead and pre-make the man -k cache (#455968)
/usr/bin/mandb

# save a little bit of space at least...
rm -f /boot/initramfs*
# make sure there aren&#39;t core files lying around
rm -f /core*

# convince readahead not to collect
# FIXME: for systemd

cat >> /etc/rc.d/init.d/livesys << EOF


# disable updates plugin
cat >> /usr/share/glib-2.0/schemas/org.gnome.settings-daemon.plugins.updates.gschema.override << FOE
[org.gnome.settings-daemon.plugins.updates]
active=false
FOE

# Show the system-config-keyboard tool on the desktop
mkdir /home/liveuser/Desktop -p >/dev/null
cat /usr/share/applications/system-config-keyboard.desktop | sed &#39;/NotShowIn/d&#39; |sed &#39;s/Terminal=false/Terminal=true/&#39; > /home/liveuser/Desktop/system-config-keyboard.desktop
cat /usr/share/applications/liveinst.desktop | sed &#39;/NoDisplay/d&#39; > /home/liveuser/Desktop/liveinst.desktop 
chmod +x /home/liveuser/Desktop/*.desktop
chown -R liveuser:liveuser /home/liveuser

# Liveuser face
if [ -e /usr/share/icons/hicolor/96x96/apps/fedora-logo-icon.png ] ; then
    cp /usr/share/icons/hicolor/96x96/apps/fedora-logo-icon.png /home/liveuser/.face
    chown liveuser:liveuser /home/liveuser/.face
fi

# make the installer show up
if [ -f /usr/share/applications/liveinst.desktop ]; then
  # Show harddisk install in shell dash
  sed -i -e &#39;s/NoDisplay=true/NoDisplay=false/&#39; /usr/share/applications/liveinst.desktop 
  # need to move it to anaconda.desktop to make shell happy
  #cp /usr/share/applications/liveinst.desktop /usr/share/applications/anaconda.desktop
fi
  cat >> /usr/share/glib-2.0/schemas/org.gnome.shell.gschema.override << FOE
[org.gnome.shell]
favorite-apps=[&#39;liveinst.desktop&#39;,&#39;firefox.desktop&#39;, &#39;evolution.desktop&#39;, &#39;empathy.desktop&#39;, &#39;rhythmbox.desktop&#39;, &#39;shotwell.desktop&#39;, &#39;libreoffice-writer.desktop&#39;, &#39;nautilus.desktop&#39;, &#39;gnome-documents.desktop&#39;, &#39;anaconda.desktop&#39;]
FOE


# set up auto-login
cat > /etc/gdm/custom.conf << FOE
[daemon]
AutomaticLoginEnable=True
AutomaticLogin=liveuser
FOE

# Turn off PackageKit-command-not-found while uninstalled
if [ -f /etc/PackageKit/CommandNotFound.conf ]; then
  sed -i -e &#39;s/^SoftwareSourceSearch=true/SoftwareSourceSearch=false/&#39; /etc/PackageKit/CommandNotFound.conf
fi

# make sure to set the right permissions and selinux contexts
chown -R liveuser:liveuser /home/liveuser/
restorecon -R /home/liveuser/

# Fixing default locale to us
localectl set-keymap us
localectl set-x11-keymap us
EOF


# rebuild schema cache with any overrides we installed
glib-compile-schemas /usr/share/glib-2.0/schemas


%end
注意，上面注释了两个地方，都可以添加软件或者运行脚本'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"所有文章","item":"https://rendoumi.com/posts/"},{"@type":"ListItem","position":2,"name":"CentOS 7 Live-CD 的制作","item":"https://rendoumi.com/posts/20211010-live_cd/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"CentOS 7 Live-CD 的制作","name":"CentOS 7 Live-CD 的制作","description":"某些场合，很有可能需要启动ISO或者USB盘，自带Linux系统，然后拯救当前损坏的系统\n或者直接启动一个LIVE CentOS系统，去做某些事，比如用MegaRaid划分Raid、测试系统等等\n这时候就需要制作出来一个LIVE CD的系统了\n制作步骤如下：\n一、安装live-tools yum -y install livecd-tools 二、准备Kickstart文件centos7-live-docker.ks 下载地址：centos7-live-docker.ks\nlang en_GB.UTF-8 keyboard us timezone Asia/Shanghai --isUtc #selinux --enforcing selinux --disabled #firewall --enabled --service=cockpit firewall --disabled #xconfig --startxonboot part / --size 8192 --fstype ext4 services --enabled=NetworkManager,sshd --disabled=network # Root password auth --useshadow --enablemd5 rootpw --plaintext Kalaisadog2021 repo --name=base --baseurl=http://mirror.centos.org/centos/7/os/x86_64/ repo --name=updates --baseurl=http://mirror.centos.org/centos/7/updates/x86_64/ repo --name=extras --baseurl=http://mirror.centos.org/centos/7/extras/x86_64/ repo --name=epel --baseurl=http://dl.fedoraproject.org/pub/epel/7/x86_64/ %packages @core kernel dracut bash firewalld NetworkManager e2fsprogs rootfiles docker openssh-server #By zhang ranrui unzip net-tools binutils wget bash-completion bc dmidecode dmraid dmraid-events lvm2 lvm2-libs kpartx mdadm parted xfsdump xfsprogs gdisk bzip2 extundelete libHX libHX-devel autoconf gcc gcc-c++ make screen telnet %end %post systemctl enable docker # By Zhang Ranrui, Add your custom script #wget http://www.rendoumi.com/soft/other/xfs_irecover -O /usr/local/bin/xfs_irecover #chmod 755 /usr/local/bin/xfs_irecover echo \u0026#34;Banner /etc/issue\u0026#34; \u0026gt;\u0026gt; /etc/ssh/sshd_config sed -i \u0026#34;s/After=network\\.target/After=network-online\\.target\\nWants=network-online\\.target/g\u0026#34; /usr/lib/systemd/system/rc-local.service chmod 755 /etc/systemd/system/rc.local.service.d chmod 644 /etc/systemd/system/rc.local.service.d/local.conf chmod 755 /etc/rc.d/rc.local systemctl enable rc-local systemctl start rc-local # FIXME: it\u0026#39;d be better to get this installed from a package cat \u0026gt; /etc/rc.d/init.d/livesys \u0026lt;\u0026lt; EOF #!/bin/bash # # live: Init script for live image # # chkconfig: 345 00 99 # description: Init script for live image. ### BEGIN INIT INFO # X-Start-Before: display-manager ### END INIT INFO . /etc/init.d/functions if ! strstr \u0026#34;\\`cat /proc/cmdline\\`\u0026#34; rd.live.image || [ \u0026#34;\\$1\u0026#34; != \u0026#34;start\u0026#34; ]; then exit 0 fi if [ -e /.liveimg-configured ] ; then configdone=1 fi exists() { which \\$1 \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 || return \\$* } # Make sure we don\u0026#39;t mangle the hardware clock on shutdown ln -sf /dev/null /etc/systemd/system/hwclock-save.service livedir=\u0026#34;LiveOS\u0026#34; for arg in \\`cat /proc/cmdline\\` ; do if [ \u0026#34;\\${arg##rd.live.dir=}\u0026#34; != \u0026#34;\\${arg}\u0026#34; ]; then livedir=\\${arg##rd.live.dir=} return fi if [ \u0026#34;\\${arg##live_dir=}\u0026#34; != \u0026#34;\\${arg}\u0026#34; ]; then livedir=\\${arg##live_dir=} return fi done # enable swaps unless requested otherwise swaps=\\`blkid -t TYPE=swap -o device\\` if ! strstr \u0026#34;\\`cat /proc/cmdline\\`\u0026#34; noswap \u0026amp;\u0026amp; [ -n \u0026#34;\\$swaps\u0026#34; ] ; then for s in \\$swaps ; do action \u0026#34;Enabling swap partition \\$s\u0026#34; swapon \\$s done fi if ! strstr \u0026#34;\\`cat /proc/cmdline\\`\u0026#34; noswap \u0026amp;\u0026amp; [ -f /run/initramfs/live/\\${livedir}/swap.img ] ; then action \u0026#34;Enabling swap file\u0026#34; swapon /run/initramfs/live/\\${livedir}/swap.img fi mountDockerDisk() { # support label/uuid if [ \u0026#34;\\${dockerdev##LABEL=}\u0026#34; != \u0026#34;\\${dockerdev}\u0026#34; -o \u0026#34;\\${dockerdev##UUID=}\u0026#34; != \u0026#34;\\${dockerdev}\u0026#34; ]; then dockerdev=\\`/sbin/blkid -o device -t \u0026#34;\\$dockerdev\u0026#34;\\` fi # if we\u0026#39;re given a file rather than a blockdev, loopback it if [ \u0026#34;\\${dockerdev##mtd}\u0026#34; != \u0026#34;\\${dockerdev}\u0026#34; ]; then # mtd devs don\u0026#39;t have a block device but get magic-mounted with -t jffs2 mountopts=\u0026#34;-t jffs2\u0026#34; elif [ ! -b \u0026#34;\\$dockerdev\u0026#34; ]; then loopdev=\\`losetup -f\\` if [ \u0026#34;\\${dockerdev##/run/initramfs/live}\u0026#34; != \u0026#34;\\${dockerdev}\u0026#34; ]; then action \u0026#34;Remounting live store r/w\u0026#34; mount -o remount,rw /run/initramfs/live fi losetup \\$loopdev \\$dockerdev dockerdev=\\$loopdev fi # if it\u0026#39;s encrypted, we need to unlock it if [ \u0026#34;\\$(/sbin/blkid -s TYPE -o value \\$dockerdev 2\u0026gt;/dev/null)\u0026#34; = \u0026#34;crypto_LUKS\u0026#34; ]; then echo echo \u0026#34;Setting up encrypted Docker device\u0026#34; plymouth ask-for-password --command=\u0026#34;cryptsetup luksOpen \\$dockerdev EncDocker\u0026#34; dockerdev=/dev/mapper/EncDocker fi # and finally do the mount mount \\$mountopts \\$dockerdev /var/lib/docker # if we have /home under what\u0026#39;s passed for persistent home, then # we should make that the real /home. useful for mtd device on olpc if [ -d /var/lib/docker/docker ]; then mount --bind /var/lib/docker/docker /var/lib/docker ; fi [ -x /sbin/restorecon ] \u0026amp;\u0026amp; /sbin/restorecon /var/lib/docker } findDockerDisk() { for arg in \\`cat /proc/cmdline\\` ; do if [ \u0026#34;\\${arg##dockerdisk=}\u0026#34; != \u0026#34;\\${arg}\u0026#34; ]; then dockerdev=\\${arg##dockerdisk=} return fi done } if strstr \u0026#34;\\`cat /proc/cmdline\\`\u0026#34; dockerdisk= ; then findDockerDisk elif [ -e /run/initramfs/live/\\${livedir}/docker.img ]; then dockerdev=/run/initramfs/live/\\${livedir}/docker.img fi # if we have a persistent /home, then we want to go ahead and mount it if ! strstr \u0026#34;\\`cat /proc/cmdline\\`\u0026#34; nodockerdisk \u0026amp;\u0026amp; [ -n \u0026#34;\\$dockerdev\u0026#34; ] ; then action \u0026#34;Mounting persistent /var/lib/docker\u0026#34; mountDockerDisk fi # make it so that we don\u0026#39;t do writing to the overlay for things which # are just tmpdirs/caches mount -t tmpfs -o mode=0755 varcacheyum /var/cache/yum mount -t tmpfs vartmp /var/tmp [ -x /sbin/restorecon ] \u0026amp;\u0026amp; /sbin/restorecon /var/cache/yum /var/tmp \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 if [ -n \u0026#34;\\$configdone\u0026#34; ]; then exit 0 fi # add fedora user with no passwd action \u0026#34;Adding live user\u0026#34; useradd \\$USERADDARGS -c \u0026#34;Live System User\u0026#34; liveuser passwd -d liveuser \u0026gt; /dev/null usermod -aG wheel,docker liveuser \u0026gt; /dev/null # Remove root password lock passwd -d root \u0026gt; /dev/null (echo Kalaisadog2021; echo Kalaisadog2021)|passwd root --stdin # turn off firstboot for livecd boots systemctl --no-reload disable firstboot-text.service 2\u0026gt; /dev/null || : systemctl --no-reload disable firstboot-graphical.service 2\u0026gt; /dev/null || : systemctl stop firstboot-text.service 2\u0026gt; /dev/null || : systemctl stop firstboot-graphical.service 2\u0026gt; /dev/null || : # don\u0026#39;t use prelink on a running live image sed -i \u0026#39;s/PRELINKING=yes/PRELINKING=no/\u0026#39; /etc/sysconfig/prelink \u0026amp;\u0026gt;/dev/null || : # turn off mdmonitor by default systemctl --no-reload disable mdmonitor.service 2\u0026gt; /dev/null || : systemctl --no-reload disable mdmonitor-takeover.service 2\u0026gt; /dev/null || : systemctl stop mdmonitor.service 2\u0026gt; /dev/null || : systemctl stop mdmonitor-takeover.service 2\u0026gt; /dev/null || : # don\u0026#39;t enable the gnome-settings-daemon packagekit plugin gsettings set org.gnome.settings-daemon.plugins.updates active \u0026#39;false\u0026#39; || : # don\u0026#39;t start cron/at as they tend to spawn things which are # disk intensive that are painful on a live image systemctl --no-reload disable crond.service 2\u0026gt; /dev/null || : systemctl --no-reload disable atd.service 2\u0026gt; /dev/null || : systemctl stop crond.service 2\u0026gt; /dev/null || : systemctl stop atd.service 2\u0026gt; /dev/null || : # Mark things as configured touch /.liveimg-configured # add static hostname to work around xauth bug # https://bugzilla.redhat.com/show_bug.cgi?id=679486 echo \u0026#34;localhost\u0026#34; \u0026gt; /etc/hostname # Fixing the lang install issue when other lang than English is selected . See http://bugs.centos.org/view.php?id=7217 /usr/bin/cp /usr/lib/python2.7/site-packages/blivet/size.py /usr/lib/python2.7/site-packages/blivet/size.py.orig /usr/bin/sed -i \u0026#34;s#return self.humanReadable()#return self.humanReadable().encode(\u0026#39;utf-8\u0026#39;)#g\u0026#34; /usr/lib/python2.7/site-packages/blivet/size.py EOF # bah, hal starts way too late cat \u0026gt; /etc/rc.d/init.d/livesys-late \u0026lt;\u0026lt; EOF #!/bin/bash # # live: Late init script for live image # # chkconfig: 345 99 01 # description: Late init script for live image. . /etc/init.d/functions if ! strstr \u0026#34;\\`cat /proc/cmdline\\`\u0026#34; rd.live.image || [ \u0026#34;\\$1\u0026#34; != \u0026#34;start\u0026#34; ] || [ -e /.liveimg-late-configured ] ; then exit 0 fi exists() { which \\$1 \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 || return \\$* } touch /.liveimg-late-configured # read some variables out of /proc/cmdline for o in \\`cat /proc/cmdline\\` ; do case \\$o in ks=*) ks=\u0026#34;--kickstart=\\${o#ks=}\u0026#34; ;; xdriver=*) xdriver=\u0026#34;\\${o#xdriver=}\u0026#34; ;; esac done # if liveinst or textinst is given, start anaconda if strstr \u0026#34;\\`cat /proc/cmdline\\`\u0026#34; liveinst ; then plymouth --quit /usr/sbin/liveinst \\$ks fi if strstr \u0026#34;\\`cat /proc/cmdline\\`\u0026#34; textinst ; then plymouth --quit /usr/sbin/liveinst --text \\$ks fi # configure X, allowing user to override xdriver if [ -n \u0026#34;\\$xdriver\u0026#34; ]; then cat \u0026gt; /etc/X11/xorg.conf.d/00-xdriver.conf \u0026lt;\u0026lt;FOE Section \u0026#34;Device\u0026#34; Identifier \u0026#34;Videocard0\u0026#34; Driver \u0026#34;\\$xdriver\u0026#34; EndSection FOE fi EOF chmod 755 /etc/rc.d/init.d/livesys /sbin/restorecon /etc/rc.d/init.d/livesys /sbin/chkconfig --add livesys chmod 755 /etc/rc.d/init.d/livesys-late /sbin/restorecon /etc/rc.d/init.d/livesys-late /sbin/chkconfig --add livesys-late # enable tmpfs for /tmp systemctl enable tmp.mount # enable docker systemctl enable docker.service # work around for poor key import UI in PackageKit rm -f /var/lib/rpm/__db* releasever=$(rpm -q --qf \u0026#39;%{version}\\n\u0026#39; --whatprovides system-release) basearch=$(uname -i) rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-fedora-$releasever-$basearch echo \u0026#34;Packages within this LiveCD\u0026#34; rpm -qa # Note that running rpm recreates the rpm db files which aren\u0026#39;t needed or wanted rm -f /var/lib/rpm/__db* # go ahead and pre-make the man -k cache (#455968) /usr/bin/mandb # save a little bit of space at least... rm -f /boot/initramfs* # make sure there aren\u0026#39;t core files lying around rm -f /core* # convince readahead not to collect # FIXME: for systemd cat \u0026gt;\u0026gt; /etc/rc.d/init.d/livesys \u0026lt;\u0026lt; EOF # disable updates plugin cat \u0026gt;\u0026gt; /usr/share/glib-2.0/schemas/org.gnome.settings-daemon.plugins.updates.gschema.override \u0026lt;\u0026lt; FOE [org.gnome.settings-daemon.plugins.updates] active=false FOE # Show the system-config-keyboard tool on the desktop mkdir /home/liveuser/Desktop -p \u0026gt;/dev/null cat /usr/share/applications/system-config-keyboard.desktop | sed \u0026#39;/NotShowIn/d\u0026#39; |sed \u0026#39;s/Terminal=false/Terminal=true/\u0026#39; \u0026gt; /home/liveuser/Desktop/system-config-keyboard.desktop cat /usr/share/applications/liveinst.desktop | sed \u0026#39;/NoDisplay/d\u0026#39; \u0026gt; /home/liveuser/Desktop/liveinst.desktop chmod +x /home/liveuser/Desktop/*.desktop chown -R liveuser:liveuser /home/liveuser # Liveuser face if [ -e /usr/share/icons/hicolor/96x96/apps/fedora-logo-icon.png ] ; then cp /usr/share/icons/hicolor/96x96/apps/fedora-logo-icon.png /home/liveuser/.face chown liveuser:liveuser /home/liveuser/.face fi # make the installer show up if [ -f /usr/share/applications/liveinst.desktop ]; then # Show harddisk install in shell dash sed -i -e \u0026#39;s/NoDisplay=true/NoDisplay=false/\u0026#39; /usr/share/applications/liveinst.desktop # need to move it to anaconda.desktop to make shell happy #cp /usr/share/applications/liveinst.desktop /usr/share/applications/anaconda.desktop fi cat \u0026gt;\u0026gt; /usr/share/glib-2.0/schemas/org.gnome.shell.gschema.override \u0026lt;\u0026lt; FOE [org.gnome.shell] favorite-apps=[\u0026#39;liveinst.desktop\u0026#39;,\u0026#39;firefox.desktop\u0026#39;, \u0026#39;evolution.desktop\u0026#39;, \u0026#39;empathy.desktop\u0026#39;, \u0026#39;rhythmbox.desktop\u0026#39;, \u0026#39;shotwell.desktop\u0026#39;, \u0026#39;libreoffice-writer.desktop\u0026#39;, \u0026#39;nautilus.desktop\u0026#39;, \u0026#39;gnome-documents.desktop\u0026#39;, \u0026#39;anaconda.desktop\u0026#39;] FOE # set up auto-login cat \u0026gt; /etc/gdm/custom.conf \u0026lt;\u0026lt; FOE [daemon] AutomaticLoginEnable=True AutomaticLogin=liveuser FOE # Turn off PackageKit-command-not-found while uninstalled if [ -f /etc/PackageKit/CommandNotFound.conf ]; then sed -i -e \u0026#39;s/^SoftwareSourceSearch=true/SoftwareSourceSearch=false/\u0026#39; /etc/PackageKit/CommandNotFound.conf fi # make sure to set the right permissions and selinux contexts chown -R liveuser:liveuser /home/liveuser/ restorecon -R /home/liveuser/ # Fixing default locale to us localectl set-keymap us localectl set-x11-keymap us EOF # rebuild schema cache with any overrides we installed glib-compile-schemas /usr/share/glib-2.0/schemas %end 注意，上面注释了两个地方，都可以添加软件或者运行脚本\n","keywords":[],"articleBody":"某些场合，很有可能需要启动ISO或者USB盘，自带Linux系统，然后拯救当前损坏的系统\n或者直接启动一个LIVE CentOS系统，去做某些事，比如用MegaRaid划分Raid、测试系统等等\n这时候就需要制作出来一个LIVE CD的系统了\n制作步骤如下：\n一、安装live-tools yum -y install livecd-tools 二、准备Kickstart文件centos7-live-docker.ks 下载地址：centos7-live-docker.ks\nlang en_GB.UTF-8 keyboard us timezone Asia/Shanghai --isUtc #selinux --enforcing selinux --disabled #firewall --enabled --service=cockpit firewall --disabled #xconfig --startxonboot part / --size 8192 --fstype ext4 services --enabled=NetworkManager,sshd --disabled=network # Root password auth --useshadow --enablemd5 rootpw --plaintext Kalaisadog2021 repo --name=base --baseurl=http://mirror.centos.org/centos/7/os/x86_64/ repo --name=updates --baseurl=http://mirror.centos.org/centos/7/updates/x86_64/ repo --name=extras --baseurl=http://mirror.centos.org/centos/7/extras/x86_64/ repo --name=epel --baseurl=http://dl.fedoraproject.org/pub/epel/7/x86_64/ %packages @core kernel dracut bash firewalld NetworkManager e2fsprogs rootfiles docker openssh-server #By zhang ranrui unzip net-tools binutils wget bash-completion bc dmidecode dmraid dmraid-events lvm2 lvm2-libs kpartx mdadm parted xfsdump xfsprogs gdisk bzip2 extundelete libHX libHX-devel autoconf gcc gcc-c++ make screen telnet %end %post systemctl enable docker # By Zhang Ranrui, Add your custom script #wget http://www.rendoumi.com/soft/other/xfs_irecover -O /usr/local/bin/xfs_irecover #chmod 755 /usr/local/bin/xfs_irecover echo \"Banner /etc/issue\" \u003e\u003e /etc/ssh/sshd_config sed -i \"s/After=network\\.target/After=network-online\\.target\\nWants=network-online\\.target/g\" /usr/lib/systemd/system/rc-local.service chmod 755 /etc/systemd/system/rc.local.service.d chmod 644 /etc/systemd/system/rc.local.service.d/local.conf chmod 755 /etc/rc.d/rc.local systemctl enable rc-local systemctl start rc-local # FIXME: it'd be better to get this installed from a package cat \u003e /etc/rc.d/init.d/livesys \u003c\u003c EOF #!/bin/bash # # live: Init script for live image # # chkconfig: 345 00 99 # description: Init script for live image. ### BEGIN INIT INFO # X-Start-Before: display-manager ### END INIT INFO . /etc/init.d/functions if ! strstr \"\\`cat /proc/cmdline\\`\" rd.live.image || [ \"\\$1\" != \"start\" ]; then exit 0 fi if [ -e /.liveimg-configured ] ; then configdone=1 fi exists() { which \\$1 \u003e/dev/null 2\u003e\u00261 || return \\$* } # Make sure we don't mangle the hardware clock on shutdown ln -sf /dev/null /etc/systemd/system/hwclock-save.service livedir=\"LiveOS\" for arg in \\`cat /proc/cmdline\\` ; do if [ \"\\${arg##rd.live.dir=}\" != \"\\${arg}\" ]; then livedir=\\${arg##rd.live.dir=} return fi if [ \"\\${arg##live_dir=}\" != \"\\${arg}\" ]; then livedir=\\${arg##live_dir=} return fi done # enable swaps unless requested otherwise swaps=\\`blkid -t TYPE=swap -o device\\` if ! strstr \"\\`cat /proc/cmdline\\`\" noswap \u0026\u0026 [ -n \"\\$swaps\" ] ; then for s in \\$swaps ; do action \"Enabling swap partition \\$s\" swapon \\$s done fi if ! strstr \"\\`cat /proc/cmdline\\`\" noswap \u0026\u0026 [ -f /run/initramfs/live/\\${livedir}/swap.img ] ; then action \"Enabling swap file\" swapon /run/initramfs/live/\\${livedir}/swap.img fi mountDockerDisk() { # support label/uuid if [ \"\\${dockerdev##LABEL=}\" != \"\\${dockerdev}\" -o \"\\${dockerdev##UUID=}\" != \"\\${dockerdev}\" ]; then dockerdev=\\`/sbin/blkid -o device -t \"\\$dockerdev\"\\` fi # if we're given a file rather than a blockdev, loopback it if [ \"\\${dockerdev##mtd}\" != \"\\${dockerdev}\" ]; then # mtd devs don't have a block device but get magic-mounted with -t jffs2 mountopts=\"-t jffs2\" elif [ ! -b \"\\$dockerdev\" ]; then loopdev=\\`losetup -f\\` if [ \"\\${dockerdev##/run/initramfs/live}\" != \"\\${dockerdev}\" ]; then action \"Remounting live store r/w\" mount -o remount,rw /run/initramfs/live fi losetup \\$loopdev \\$dockerdev dockerdev=\\$loopdev fi # if it's encrypted, we need to unlock it if [ \"\\$(/sbin/blkid -s TYPE -o value \\$dockerdev 2\u003e/dev/null)\" = \"crypto_LUKS\" ]; then echo echo \"Setting up encrypted Docker device\" plymouth ask-for-password --command=\"cryptsetup luksOpen \\$dockerdev EncDocker\" dockerdev=/dev/mapper/EncDocker fi # and finally do the mount mount \\$mountopts \\$dockerdev /var/lib/docker # if we have /home under what's passed for persistent home, then # we should make that the real /home. useful for mtd device on olpc if [ -d /var/lib/docker/docker ]; then mount --bind /var/lib/docker/docker /var/lib/docker ; fi [ -x /sbin/restorecon ] \u0026\u0026 /sbin/restorecon /var/lib/docker } findDockerDisk() { for arg in \\`cat /proc/cmdline\\` ; do if [ \"\\${arg##dockerdisk=}\" != \"\\${arg}\" ]; then dockerdev=\\${arg##dockerdisk=} return fi done } if strstr \"\\`cat /proc/cmdline\\`\" dockerdisk= ; then findDockerDisk elif [ -e /run/initramfs/live/\\${livedir}/docker.img ]; then dockerdev=/run/initramfs/live/\\${livedir}/docker.img fi # if we have a persistent /home, then we want to go ahead and mount it if ! strstr \"\\`cat /proc/cmdline\\`\" nodockerdisk \u0026\u0026 [ -n \"\\$dockerdev\" ] ; then action \"Mounting persistent /var/lib/docker\" mountDockerDisk fi # make it so that we don't do writing to the overlay for things which # are just tmpdirs/caches mount -t tmpfs -o mode=0755 varcacheyum /var/cache/yum mount -t tmpfs vartmp /var/tmp [ -x /sbin/restorecon ] \u0026\u0026 /sbin/restorecon /var/cache/yum /var/tmp \u003e/dev/null 2\u003e\u00261 if [ -n \"\\$configdone\" ]; then exit 0 fi # add fedora user with no passwd action \"Adding live user\" useradd \\$USERADDARGS -c \"Live System User\" liveuser passwd -d liveuser \u003e /dev/null usermod -aG wheel,docker liveuser \u003e /dev/null # Remove root password lock passwd -d root \u003e /dev/null (echo Kalaisadog2021; echo Kalaisadog2021)|passwd root --stdin # turn off firstboot for livecd boots systemctl --no-reload disable firstboot-text.service 2\u003e /dev/null || : systemctl --no-reload disable firstboot-graphical.service 2\u003e /dev/null || : systemctl stop firstboot-text.service 2\u003e /dev/null || : systemctl stop firstboot-graphical.service 2\u003e /dev/null || : # don't use prelink on a running live image sed -i 's/PRELINKING=yes/PRELINKING=no/' /etc/sysconfig/prelink \u0026\u003e/dev/null || : # turn off mdmonitor by default systemctl --no-reload disable mdmonitor.service 2\u003e /dev/null || : systemctl --no-reload disable mdmonitor-takeover.service 2\u003e /dev/null || : systemctl stop mdmonitor.service 2\u003e /dev/null || : systemctl stop mdmonitor-takeover.service 2\u003e /dev/null || : # don't enable the gnome-settings-daemon packagekit plugin gsettings set org.gnome.settings-daemon.plugins.updates active 'false' || : # don't start cron/at as they tend to spawn things which are # disk intensive that are painful on a live image systemctl --no-reload disable crond.service 2\u003e /dev/null || : systemctl --no-reload disable atd.service 2\u003e /dev/null || : systemctl stop crond.service 2\u003e /dev/null || : systemctl stop atd.service 2\u003e /dev/null || : # Mark things as configured touch /.liveimg-configured # add static hostname to work around xauth bug # https://bugzilla.redhat.com/show_bug.cgi?id=679486 echo \"localhost\" \u003e /etc/hostname # Fixing the lang install issue when other lang than English is selected . See http://bugs.centos.org/view.php?id=7217 /usr/bin/cp /usr/lib/python2.7/site-packages/blivet/size.py /usr/lib/python2.7/site-packages/blivet/size.py.orig /usr/bin/sed -i \"s#return self.humanReadable()#return self.humanReadable().encode('utf-8')#g\" /usr/lib/python2.7/site-packages/blivet/size.py EOF # bah, hal starts way too late cat \u003e /etc/rc.d/init.d/livesys-late \u003c\u003c EOF #!/bin/bash # # live: Late init script for live image # # chkconfig: 345 99 01 # description: Late init script for live image. . /etc/init.d/functions if ! strstr \"\\`cat /proc/cmdline\\`\" rd.live.image || [ \"\\$1\" != \"start\" ] || [ -e /.liveimg-late-configured ] ; then exit 0 fi exists() { which \\$1 \u003e/dev/null 2\u003e\u00261 || return \\$* } touch /.liveimg-late-configured # read some variables out of /proc/cmdline for o in \\`cat /proc/cmdline\\` ; do case \\$o in ks=*) ks=\"--kickstart=\\${o#ks=}\" ;; xdriver=*) xdriver=\"\\${o#xdriver=}\" ;; esac done # if liveinst or textinst is given, start anaconda if strstr \"\\`cat /proc/cmdline\\`\" liveinst ; then plymouth --quit /usr/sbin/liveinst \\$ks fi if strstr \"\\`cat /proc/cmdline\\`\" textinst ; then plymouth --quit /usr/sbin/liveinst --text \\$ks fi # configure X, allowing user to override xdriver if [ -n \"\\$xdriver\" ]; then cat \u003e /etc/X11/xorg.conf.d/00-xdriver.conf \u003c","wordCount":"1385","inLanguage":"zh","image":"https://rendoumi.com/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2021-10-10T09:30:11+08:00","dateModified":"2021-10-10T09:30:11+08:00","author":{"@type":"Person","name":"八戒"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://rendoumi.com/posts/20211010-live_cd/"},"publisher":{"@type":"Organization","name":"八戒的技术博客","logo":{"@type":"ImageObject","url":"https://rendoumi.com/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://rendoumi.com/ accesskey=h title="Home (Alt + H)"><img src=https://rendoumi.com/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches></div></div><ul id=menu><li><a href=https://rendoumi.com/ title=首页><span>首页</span></a></li><li><a href=https://rendoumi.com/posts/ title=文章><span>文章</span></a></li><li><a href=https://rendoumi.com/archives/ title=归档><span>归档</span></a></li><li><a href=https://blog.rendoumi.com title=生活><span>生活</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://rendoumi.com/search/ title=搜索><span>搜索</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://rendoumi.com/>主页</a>&nbsp;»&nbsp;<a href=https://rendoumi.com/posts/>所有文章</a></div><h1 class="post-title entry-hint-parent">CentOS 7 Live-CD 的制作
<span class=entry-hint title=Draft><svg height="35" viewBox="0 -960 960 960" fill="currentcolor"><path d="M160-410v-60h3e2v60H160zm0-165v-60h470v60H160zm0-165v-60h470v60H160zm360 580v-123l221-220q9-9 20-13t22-4q12 0 23 4.5t20 13.5l37 37q9 9 13 20t4 22-4.5 22.5T862.09-380L643-160H520zm3e2-263-37-37 37 37zM580-220h38l121-122-18-19-19-18-122 121v38zm141-141-19-18 37 37-18-19z"/></svg></span></h1><div class=post-meta><span title='2021-10-10 09:30:11 +0800 CST'>2021年10月10日</span>&nbsp;·&nbsp;<span>7 分钟</span>&nbsp;·&nbsp;<span>1385 字</span>&nbsp;·&nbsp;<span>八戒</span></div></header><div class=post-content><p>某些场合，很有可能需要启动ISO或者USB盘，自带Linux系统，然后拯救当前损坏的系统</p><p>或者直接启动一个LIVE CentOS系统，去做某些事，比如用MegaRaid划分Raid、测试系统等等</p><p>这时候就需要制作出来一个LIVE CD的系统了</p><p>制作步骤如下：</p><h2 id=一安装live-tools>一、安装live-tools<a hidden class=anchor aria-hidden=true href=#一安装live-tools>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>yum -y install livecd-tools
</span></span></code></pre></div><h2 id=二准备kickstart文件centos7-live-dockerks>二、准备Kickstart文件centos7-live-docker.ks<a hidden class=anchor aria-hidden=true href=#二准备kickstart文件centos7-live-dockerks>#</a></h2><p>下载地址：<a href=centos7-live-docker.ks>centos7-live-docker.ks</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=na>lang en_GB.UTF-8</span>
</span></span><span class=line><span class=cl><span class=na>keyboard us</span>
</span></span><span class=line><span class=cl><span class=na>timezone Asia/Shanghai --isUtc</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#selinux --enforcing</span>
</span></span><span class=line><span class=cl><span class=na>selinux --disabled</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#firewall --enabled --service=cockpit</span>
</span></span><span class=line><span class=cl><span class=na>firewall --disabled</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#xconfig --startxonboot</span>
</span></span><span class=line><span class=cl><span class=na>part / --size 8192 --fstype ext4</span>
</span></span><span class=line><span class=cl><span class=na>services --enabled</span><span class=o>=</span><span class=s>NetworkManager,sshd --disabled=network</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Root password</span>
</span></span><span class=line><span class=cl><span class=na>auth --useshadow --enablemd5</span>
</span></span><span class=line><span class=cl><span class=na>rootpw --plaintext Kalaisadog2021</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>repo --name</span><span class=o>=</span><span class=s>base --baseurl=http://mirror.centos.org/centos/7/os/x86_64/</span>
</span></span><span class=line><span class=cl><span class=na>repo --name</span><span class=o>=</span><span class=s>updates --baseurl=http://mirror.centos.org/centos/7/updates/x86_64/</span>
</span></span><span class=line><span class=cl><span class=na>repo --name</span><span class=o>=</span><span class=s>extras --baseurl=http://mirror.centos.org/centos/7/extras/x86_64/</span>
</span></span><span class=line><span class=cl><span class=na>repo --name</span><span class=o>=</span><span class=s>epel --baseurl=http://dl.fedoraproject.org/pub/epel/7/x86_64/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>%packages </span>
</span></span><span class=line><span class=cl><span class=na>@core</span>
</span></span><span class=line><span class=cl><span class=na>kernel</span>
</span></span><span class=line><span class=cl><span class=na>dracut</span>
</span></span><span class=line><span class=cl><span class=na>bash</span>
</span></span><span class=line><span class=cl><span class=na>firewalld</span>
</span></span><span class=line><span class=cl><span class=na>NetworkManager</span>
</span></span><span class=line><span class=cl><span class=na>e2fsprogs</span>
</span></span><span class=line><span class=cl><span class=na>rootfiles</span>
</span></span><span class=line><span class=cl><span class=na>docker</span>
</span></span><span class=line><span class=cl><span class=na>openssh-server</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#By zhang ranrui</span>
</span></span><span class=line><span class=cl><span class=na>unzip</span>
</span></span><span class=line><span class=cl><span class=na>net-tools</span>
</span></span><span class=line><span class=cl><span class=na>binutils</span>
</span></span><span class=line><span class=cl><span class=na>wget</span>
</span></span><span class=line><span class=cl><span class=na>bash-completion</span>
</span></span><span class=line><span class=cl><span class=na>bc</span>
</span></span><span class=line><span class=cl><span class=na>dmidecode</span>
</span></span><span class=line><span class=cl><span class=na>dmraid</span>
</span></span><span class=line><span class=cl><span class=na>dmraid-events</span>
</span></span><span class=line><span class=cl><span class=na>lvm2</span>
</span></span><span class=line><span class=cl><span class=na>lvm2-libs</span>
</span></span><span class=line><span class=cl><span class=na>kpartx</span>
</span></span><span class=line><span class=cl><span class=na>mdadm</span>
</span></span><span class=line><span class=cl><span class=na>parted</span>
</span></span><span class=line><span class=cl><span class=na>xfsdump</span>
</span></span><span class=line><span class=cl><span class=na>xfsprogs</span>
</span></span><span class=line><span class=cl><span class=na>gdisk</span>
</span></span><span class=line><span class=cl><span class=na>bzip2</span>
</span></span><span class=line><span class=cl><span class=na>extundelete</span>
</span></span><span class=line><span class=cl><span class=na>libHX</span>
</span></span><span class=line><span class=cl><span class=na>libHX-devel</span>
</span></span><span class=line><span class=cl><span class=na>autoconf</span>
</span></span><span class=line><span class=cl><span class=na>gcc</span>
</span></span><span class=line><span class=cl><span class=na>gcc-c++</span>
</span></span><span class=line><span class=cl><span class=na>make</span>
</span></span><span class=line><span class=cl><span class=na>screen</span>
</span></span><span class=line><span class=cl><span class=na>telnet</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>%end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>%post</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>systemctl enable docker</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># By Zhang Ranrui, Add your custom script</span>
</span></span><span class=line><span class=cl><span class=c1>#wget http://www.rendoumi.com/soft/other/xfs_irecover -O /usr/local/bin/xfs_irecover</span>
</span></span><span class=line><span class=cl><span class=c1>#chmod 755 /usr/local/bin/xfs_irecover</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>echo &#34;Banner /etc/issue&#34; &gt;&gt; /etc/ssh/sshd_config</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>sed -i &#34;s/After</span><span class=o>=</span><span class=s>network\.target/After=network-online\.target\nWants=network-online\.target/g&#34; /usr/lib/systemd/system/rc-local.service</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>chmod 755 /etc/systemd/system/rc.local.service.d</span>
</span></span><span class=line><span class=cl><span class=na>chmod 644 /etc/systemd/system/rc.local.service.d/local.conf</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>chmod 755 /etc/rc.d/rc.local</span>
</span></span><span class=line><span class=cl><span class=na>systemctl enable rc-local</span>
</span></span><span class=line><span class=cl><span class=na>systemctl start rc-local</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># FIXME: it&#39;d be better to get this installed from a package</span>
</span></span><span class=line><span class=cl><span class=na>cat &gt; /etc/rc.d/init.d/livesys &lt;&lt; EOF</span>
</span></span><span class=line><span class=cl><span class=c1>#!/bin/bash</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># live: Init script for live image</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># chkconfig: 345 00 99</span>
</span></span><span class=line><span class=cl><span class=c1># description: Init script for live image.</span>
</span></span><span class=line><span class=cl><span class=c1>### BEGIN INIT INFO</span>
</span></span><span class=line><span class=cl><span class=c1># X-Start-Before: display-manager</span>
</span></span><span class=line><span class=cl><span class=c1>### END INIT INFO</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>. /etc/init.d/functions</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>if ! strstr &#34;\`cat /proc/cmdline\`&#34; rd.live.image || [ &#34;\$1&#34; !</span><span class=o>=</span> <span class=s>&#34;start&#34; ]; then
</span></span></span><span class=line><span class=cl><span class=s>    exit 0</span>
</span></span><span class=line><span class=cl><span class=na>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>if [ -e /.liveimg-configured ] ; then</span>
</span></span><span class=line><span class=cl>    <span class=na>configdone</span><span class=o>=</span><span class=s>1</span>
</span></span><span class=line><span class=cl><span class=na>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>exists() {</span>
</span></span><span class=line><span class=cl>    <span class=na>which \$1 &gt;/dev/null 2&gt;&amp;1 || return</span>
</span></span><span class=line><span class=cl>    <span class=na>\$*</span>
</span></span><span class=line><span class=cl><span class=na>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Make sure we don&#39;t mangle the hardware clock on shutdown</span>
</span></span><span class=line><span class=cl><span class=na>ln -sf /dev/null /etc/systemd/system/hwclock-save.service</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>livedir</span><span class=o>=</span><span class=s>&#34;LiveOS&#34;</span>
</span></span><span class=line><span class=cl><span class=na>for arg in \`cat /proc/cmdline\` ; do</span>
</span></span><span class=line><span class=cl>  <span class=na>if [ &#34;\${arg##rd.live.dir</span><span class=o>=</span><span class=s>}&#34; != &#34;\${arg}&#34; ]; then
</span></span></span><span class=line><span class=cl><span class=s>    livedir=\${arg##rd.live.dir=}
</span></span></span><span class=line><span class=cl><span class=s>    return
</span></span></span><span class=line><span class=cl><span class=s>  fi
</span></span></span><span class=line><span class=cl><span class=s>  if [ &#34;\${arg##live_dir=}&#34; != &#34;\${arg}&#34; ]; then
</span></span></span><span class=line><span class=cl><span class=s>    livedir=\${arg##live_dir=}
</span></span></span><span class=line><span class=cl><span class=s>    return
</span></span></span><span class=line><span class=cl><span class=s>  fi</span>
</span></span><span class=line><span class=cl><span class=na>done</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># enable swaps unless requested otherwise</span>
</span></span><span class=line><span class=cl><span class=na>swaps</span><span class=o>=</span><span class=s>\`blkid -t TYPE=swap -o device\`</span>
</span></span><span class=line><span class=cl><span class=na>if ! strstr &#34;\`cat /proc/cmdline\`&#34; noswap &amp;&amp; [ -n &#34;\$swaps&#34; ] ; then</span>
</span></span><span class=line><span class=cl>  <span class=na>for s in \$swaps ; do</span>
</span></span><span class=line><span class=cl>    <span class=na>action &#34;Enabling swap partition \$s&#34; swapon \$s</span>
</span></span><span class=line><span class=cl>  <span class=na>done</span>
</span></span><span class=line><span class=cl><span class=na>fi</span>
</span></span><span class=line><span class=cl><span class=na>if ! strstr &#34;\`cat /proc/cmdline\`&#34; noswap &amp;&amp; [ -f /run/initramfs/live/\${livedir}/swap.img ] ; then</span>
</span></span><span class=line><span class=cl>  <span class=na>action &#34;Enabling swap file&#34; swapon /run/initramfs/live/\${livedir}/swap.img</span>
</span></span><span class=line><span class=cl><span class=na>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>mountDockerDisk() {</span>
</span></span><span class=line><span class=cl>  <span class=c1># support label/uuid</span>
</span></span><span class=line><span class=cl>  <span class=na>if [ &#34;\${dockerdev##LABEL</span><span class=o>=</span><span class=s>}&#34; != &#34;\${dockerdev}&#34; -o &#34;\${dockerdev##UUID=}&#34; != &#34;\${dockerdev}&#34; ]; then
</span></span></span><span class=line><span class=cl><span class=s>    dockerdev=\`/sbin/blkid -o device -t &#34;\$dockerdev&#34;\`
</span></span></span><span class=line><span class=cl><span class=s>  fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># if we&#39;re given a file rather than a blockdev, loopback it</span>
</span></span><span class=line><span class=cl>  <span class=na>if [ &#34;\${dockerdev##mtd}&#34; !</span><span class=o>=</span> <span class=s>&#34;\${dockerdev}&#34; ]; then
</span></span></span><span class=line><span class=cl><span class=s>    # mtd devs don&#39;t have a block device but get magic-mounted with -t jffs2
</span></span></span><span class=line><span class=cl><span class=s>    mountopts=&#34;-t jffs2&#34;
</span></span></span><span class=line><span class=cl><span class=s>  elif [ ! -b &#34;\$dockerdev&#34; ]; then
</span></span></span><span class=line><span class=cl><span class=s>    loopdev=\`losetup -f\`
</span></span></span><span class=line><span class=cl><span class=s>    if [ &#34;\${dockerdev##/run/initramfs/live}&#34; != &#34;\${dockerdev}&#34; ]; then
</span></span></span><span class=line><span class=cl><span class=s>      action &#34;Remounting live store r/w&#34; mount -o remount,rw /run/initramfs/live
</span></span></span><span class=line><span class=cl><span class=s>    fi
</span></span></span><span class=line><span class=cl><span class=s>    losetup \$loopdev \$dockerdev
</span></span></span><span class=line><span class=cl><span class=s>    dockerdev=\$loopdev
</span></span></span><span class=line><span class=cl><span class=s>  fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># if it&#39;s encrypted, we need to unlock it</span>
</span></span><span class=line><span class=cl>  <span class=na>if [ &#34;\$(/sbin/blkid -s TYPE -o value \$dockerdev 2&gt;/dev/null)&#34;</span> <span class=o>=</span> <span class=s>&#34;crypto_LUKS&#34; ]; then
</span></span></span><span class=line><span class=cl><span class=s>    echo
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;Setting up encrypted Docker device&#34;
</span></span></span><span class=line><span class=cl><span class=s>    plymouth ask-for-password --command=&#34;cryptsetup luksOpen \$dockerdev EncDocker&#34;
</span></span></span><span class=line><span class=cl><span class=s>    dockerdev=/dev/mapper/EncDocker
</span></span></span><span class=line><span class=cl><span class=s>  fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># and finally do the mount</span>
</span></span><span class=line><span class=cl>  <span class=na>mount \$mountopts \$dockerdev /var/lib/docker</span>
</span></span><span class=line><span class=cl>  <span class=c1># if we have /home under what&#39;s passed for persistent home, then</span>
</span></span><span class=line><span class=cl>  <span class=c1># we should make that the real /home.  useful for mtd device on olpc</span>
</span></span><span class=line><span class=cl>  <span class=na>if [ -d /var/lib/docker/docker ]; then mount --bind /var/lib/docker/docker /var/lib/docker ; fi</span>
</span></span><span class=line><span class=cl>  <span class=na>[ -x /sbin/restorecon ] &amp;&amp; /sbin/restorecon /var/lib/docker</span>
</span></span><span class=line><span class=cl><span class=na>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>findDockerDisk() {</span>
</span></span><span class=line><span class=cl>  <span class=na>for arg in \`cat /proc/cmdline\` ; do</span>
</span></span><span class=line><span class=cl>    <span class=na>if [ &#34;\${arg##dockerdisk</span><span class=o>=</span><span class=s>}&#34; != &#34;\${arg}&#34; ]; then
</span></span></span><span class=line><span class=cl><span class=s>      dockerdev=\${arg##dockerdisk=}
</span></span></span><span class=line><span class=cl><span class=s>      return
</span></span></span><span class=line><span class=cl><span class=s>    fi
</span></span></span><span class=line><span class=cl><span class=s>  done</span>
</span></span><span class=line><span class=cl><span class=na>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>if strstr &#34;\`cat /proc/cmdline\`&#34; dockerdisk</span><span class=o>=</span> <span class=s>; then
</span></span></span><span class=line><span class=cl><span class=s>  findDockerDisk</span>
</span></span><span class=line><span class=cl><span class=na>elif [ -e /run/initramfs/live/\${livedir}/docker.img ]; then</span>
</span></span><span class=line><span class=cl>  <span class=na>dockerdev</span><span class=o>=</span><span class=s>/run/initramfs/live/\${livedir}/docker.img</span>
</span></span><span class=line><span class=cl><span class=na>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># if we have a persistent /home, then we want to go ahead and mount it</span>
</span></span><span class=line><span class=cl><span class=na>if ! strstr &#34;\`cat /proc/cmdline\`&#34; nodockerdisk &amp;&amp; [ -n &#34;\$dockerdev&#34; ] ; then</span>
</span></span><span class=line><span class=cl>  <span class=na>action &#34;Mounting persistent /var/lib/docker&#34; mountDockerDisk</span>
</span></span><span class=line><span class=cl><span class=na>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># make it so that we don&#39;t do writing to the overlay for things which</span>
</span></span><span class=line><span class=cl><span class=c1># are just tmpdirs/caches</span>
</span></span><span class=line><span class=cl><span class=na>mount -t tmpfs -o mode</span><span class=o>=</span><span class=s>0755 varcacheyum /var/cache/yum</span>
</span></span><span class=line><span class=cl><span class=na>mount -t tmpfs vartmp /var/tmp</span>
</span></span><span class=line><span class=cl><span class=na>[ -x /sbin/restorecon ] &amp;&amp; /sbin/restorecon /var/cache/yum /var/tmp &gt;/dev/null 2&gt;&amp;1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>if [ -n &#34;\$configdone&#34; ]; then</span>
</span></span><span class=line><span class=cl>  <span class=na>exit 0</span>
</span></span><span class=line><span class=cl><span class=na>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># add fedora user with no passwd</span>
</span></span><span class=line><span class=cl><span class=na>action &#34;Adding live user&#34; useradd \$USERADDARGS -c &#34;Live System User&#34; liveuser</span>
</span></span><span class=line><span class=cl><span class=na>passwd -d liveuser &gt; /dev/null</span>
</span></span><span class=line><span class=cl><span class=na>usermod -aG wheel,docker liveuser &gt; /dev/null</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Remove root password lock</span>
</span></span><span class=line><span class=cl><span class=na>passwd -d root &gt; /dev/null</span>
</span></span><span class=line><span class=cl><span class=na>(echo Kalaisadog2021; echo Kalaisadog2021)|passwd root --stdin</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># turn off firstboot for livecd boots</span>
</span></span><span class=line><span class=cl><span class=na>systemctl --no-reload disable firstboot-text.service 2&gt; /dev/null || :</span>
</span></span><span class=line><span class=cl><span class=na>systemctl --no-reload disable firstboot-graphical.service 2&gt; /dev/null || :</span>
</span></span><span class=line><span class=cl><span class=na>systemctl stop firstboot-text.service 2&gt; /dev/null || :</span>
</span></span><span class=line><span class=cl><span class=na>systemctl stop firstboot-graphical.service 2&gt; /dev/null || :</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># don&#39;t use prelink on a running live image</span>
</span></span><span class=line><span class=cl><span class=na>sed -i &#39;s/PRELINKING</span><span class=o>=</span><span class=s>yes/PRELINKING=no/&#39; /etc/sysconfig/prelink &amp;&gt;/dev/null || :</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># turn off mdmonitor by default</span>
</span></span><span class=line><span class=cl><span class=na>systemctl --no-reload disable mdmonitor.service 2&gt; /dev/null || :</span>
</span></span><span class=line><span class=cl><span class=na>systemctl --no-reload disable mdmonitor-takeover.service 2&gt; /dev/null || :</span>
</span></span><span class=line><span class=cl><span class=na>systemctl stop mdmonitor.service 2&gt; /dev/null || :</span>
</span></span><span class=line><span class=cl><span class=na>systemctl stop mdmonitor-takeover.service 2&gt; /dev/null || :</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># don&#39;t enable the gnome-settings-daemon packagekit plugin</span>
</span></span><span class=line><span class=cl><span class=na>gsettings set org.gnome.settings-daemon.plugins.updates active &#39;false&#39; || :</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># don&#39;t start cron/at as they tend to spawn things which are</span>
</span></span><span class=line><span class=cl><span class=c1># disk intensive that are painful on a live image</span>
</span></span><span class=line><span class=cl><span class=na>systemctl --no-reload disable crond.service 2&gt; /dev/null || :</span>
</span></span><span class=line><span class=cl><span class=na>systemctl --no-reload disable atd.service 2&gt; /dev/null || :</span>
</span></span><span class=line><span class=cl><span class=na>systemctl stop crond.service 2&gt; /dev/null || :</span>
</span></span><span class=line><span class=cl><span class=na>systemctl stop atd.service 2&gt; /dev/null || :</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Mark things as configured</span>
</span></span><span class=line><span class=cl><span class=na>touch /.liveimg-configured</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># add static hostname to work around xauth bug</span>
</span></span><span class=line><span class=cl><span class=c1># https://bugzilla.redhat.com/show_bug.cgi?id=679486</span>
</span></span><span class=line><span class=cl><span class=na>echo &#34;localhost&#34; &gt; /etc/hostname</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Fixing the lang install issue when other lang than English is selected . See http://bugs.centos.org/view.php?id=7217</span>
</span></span><span class=line><span class=cl><span class=na>/usr/bin/cp /usr/lib/python2.7/site-packages/blivet/size.py /usr/lib/python2.7/site-packages/blivet/size.py.orig</span>
</span></span><span class=line><span class=cl><span class=na>/usr/bin/sed -i &#34;s#return self.humanReadable()#return self.humanReadable().encode(&#39;utf-8&#39;)#g&#34; /usr/lib/python2.7/site-packages/blivet/size.py</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># bah, hal starts way too late</span>
</span></span><span class=line><span class=cl><span class=na>cat &gt; /etc/rc.d/init.d/livesys-late &lt;&lt; EOF</span>
</span></span><span class=line><span class=cl><span class=c1>#!/bin/bash</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># live: Late init script for live image</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># chkconfig: 345 99 01</span>
</span></span><span class=line><span class=cl><span class=c1># description: Late init script for live image.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>. /etc/init.d/functions</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>if ! strstr &#34;\`cat /proc/cmdline\`&#34; rd.live.image || [ &#34;\$1&#34; !</span><span class=o>=</span> <span class=s>&#34;start&#34; ] || [ -e /.liveimg-late-configured ] ; then
</span></span></span><span class=line><span class=cl><span class=s>    exit 0</span>
</span></span><span class=line><span class=cl><span class=na>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>exists() {</span>
</span></span><span class=line><span class=cl>    <span class=na>which \$1 &gt;/dev/null 2&gt;&amp;1 || return</span>
</span></span><span class=line><span class=cl>    <span class=na>\$*</span>
</span></span><span class=line><span class=cl><span class=na>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>touch /.liveimg-late-configured</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># read some variables out of /proc/cmdline</span>
</span></span><span class=line><span class=cl><span class=na>for o in \`cat /proc/cmdline\` ; do</span>
</span></span><span class=line><span class=cl>    <span class=na>case \$o in</span>
</span></span><span class=line><span class=cl>    <span class=na>ks</span><span class=o>=</span><span class=s>*)
</span></span></span><span class=line><span class=cl><span class=s>        ks=&#34;--kickstart=\${o#ks=}&#34;
</span></span></span><span class=line><span class=cl><span class=s>        ;;
</span></span></span><span class=line><span class=cl><span class=s>    xdriver=*)
</span></span></span><span class=line><span class=cl><span class=s>        xdriver=&#34;\${o#xdriver=}&#34;
</span></span></span><span class=line><span class=cl><span class=s>        ;;
</span></span></span><span class=line><span class=cl><span class=s>    esac</span>
</span></span><span class=line><span class=cl><span class=na>done</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># if liveinst or textinst is given, start anaconda</span>
</span></span><span class=line><span class=cl><span class=na>if strstr &#34;\`cat /proc/cmdline\`&#34; liveinst ; then</span>
</span></span><span class=line><span class=cl>   <span class=na>plymouth --quit</span>
</span></span><span class=line><span class=cl>   <span class=na>/usr/sbin/liveinst \$ks</span>
</span></span><span class=line><span class=cl><span class=na>fi</span>
</span></span><span class=line><span class=cl><span class=na>if strstr &#34;\`cat /proc/cmdline\`&#34; textinst ; then</span>
</span></span><span class=line><span class=cl>   <span class=na>plymouth --quit</span>
</span></span><span class=line><span class=cl>   <span class=na>/usr/sbin/liveinst --text \$ks</span>
</span></span><span class=line><span class=cl><span class=na>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># configure X, allowing user to override xdriver</span>
</span></span><span class=line><span class=cl><span class=na>if [ -n &#34;\$xdriver&#34; ]; then</span>
</span></span><span class=line><span class=cl>   <span class=na>cat &gt; /etc/X11/xorg.conf.d/00-xdriver.conf &lt;&lt;FOE</span>
</span></span><span class=line><span class=cl><span class=na>Section &#34;Device&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>Identifier      &#34;Videocard0&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>Driver  &#34;\$xdriver&#34;</span>
</span></span><span class=line><span class=cl><span class=na>EndSection</span>
</span></span><span class=line><span class=cl><span class=na>FOE</span>
</span></span><span class=line><span class=cl><span class=na>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>chmod 755 /etc/rc.d/init.d/livesys</span>
</span></span><span class=line><span class=cl><span class=na>/sbin/restorecon /etc/rc.d/init.d/livesys</span>
</span></span><span class=line><span class=cl><span class=na>/sbin/chkconfig --add livesys</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>chmod 755 /etc/rc.d/init.d/livesys-late</span>
</span></span><span class=line><span class=cl><span class=na>/sbin/restorecon /etc/rc.d/init.d/livesys-late</span>
</span></span><span class=line><span class=cl><span class=na>/sbin/chkconfig --add livesys-late</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># enable tmpfs for /tmp</span>
</span></span><span class=line><span class=cl><span class=na>systemctl enable tmp.mount</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># enable docker</span>
</span></span><span class=line><span class=cl><span class=na>systemctl enable docker.service</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># work around for poor key import UI in PackageKit</span>
</span></span><span class=line><span class=cl><span class=na>rm -f /var/lib/rpm/__db*</span>
</span></span><span class=line><span class=cl><span class=na>releasever</span><span class=o>=</span><span class=s>$(rpm -q --qf &#39;%{version}\n&#39; --whatprovides system-release)</span>
</span></span><span class=line><span class=cl><span class=na>basearch</span><span class=o>=</span><span class=s>$(uname -i)</span>
</span></span><span class=line><span class=cl><span class=na>rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-fedora-$releasever-$basearch</span>
</span></span><span class=line><span class=cl><span class=na>echo &#34;Packages within this LiveCD&#34;</span>
</span></span><span class=line><span class=cl><span class=na>rpm -qa</span>
</span></span><span class=line><span class=cl><span class=c1># Note that running rpm recreates the rpm db files which aren&#39;t needed or wanted</span>
</span></span><span class=line><span class=cl><span class=na>rm -f /var/lib/rpm/__db*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># go ahead and pre-make the man -k cache (#455968)</span>
</span></span><span class=line><span class=cl><span class=na>/usr/bin/mandb</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># save a little bit of space at least...</span>
</span></span><span class=line><span class=cl><span class=na>rm -f /boot/initramfs*</span>
</span></span><span class=line><span class=cl><span class=c1># make sure there aren&#39;t core files lying around</span>
</span></span><span class=line><span class=cl><span class=na>rm -f /core*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># convince readahead not to collect</span>
</span></span><span class=line><span class=cl><span class=c1># FIXME: for systemd</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>cat &gt;&gt; /etc/rc.d/init.d/livesys &lt;&lt; EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># disable updates plugin</span>
</span></span><span class=line><span class=cl><span class=na>cat &gt;&gt; /usr/share/glib-2.0/schemas/org.gnome.settings-daemon.plugins.updates.gschema.override &lt;&lt; FOE</span>
</span></span><span class=line><span class=cl><span class=k>[org.gnome.settings-daemon.plugins.updates]</span>
</span></span><span class=line><span class=cl><span class=na>active</span><span class=o>=</span><span class=s>false</span>
</span></span><span class=line><span class=cl><span class=na>FOE</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Show the system-config-keyboard tool on the desktop</span>
</span></span><span class=line><span class=cl><span class=na>mkdir /home/liveuser/Desktop -p &gt;/dev/null</span>
</span></span><span class=line><span class=cl><span class=na>cat /usr/share/applications/system-config-keyboard.desktop | sed &#39;/NotShowIn/d&#39; |sed &#39;s/Terminal</span><span class=o>=</span><span class=s>false/Terminal=true/&#39; &gt; /home/liveuser/Desktop/system-config-keyboard.desktop</span>
</span></span><span class=line><span class=cl><span class=na>cat /usr/share/applications/liveinst.desktop | sed &#39;/NoDisplay/d&#39; &gt; /home/liveuser/Desktop/liveinst.desktop </span>
</span></span><span class=line><span class=cl><span class=na>chmod +x /home/liveuser/Desktop/*.desktop</span>
</span></span><span class=line><span class=cl><span class=na>chown -R liveuser:liveuser /home/liveuser</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Liveuser face</span>
</span></span><span class=line><span class=cl><span class=na>if [ -e /usr/share/icons/hicolor/96x96/apps/fedora-logo-icon.png ] ; then</span>
</span></span><span class=line><span class=cl>    <span class=na>cp /usr/share/icons/hicolor/96x96/apps/fedora-logo-icon.png /home/liveuser/.face</span>
</span></span><span class=line><span class=cl>    <span class=na>chown liveuser:liveuser /home/liveuser/.face</span>
</span></span><span class=line><span class=cl><span class=na>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># make the installer show up</span>
</span></span><span class=line><span class=cl><span class=na>if [ -f /usr/share/applications/liveinst.desktop ]; then</span>
</span></span><span class=line><span class=cl>  <span class=c1># Show harddisk install in shell dash</span>
</span></span><span class=line><span class=cl>  <span class=na>sed -i -e &#39;s/NoDisplay</span><span class=o>=</span><span class=s>true/NoDisplay=false/&#39; /usr/share/applications/liveinst.desktop 
</span></span></span><span class=line><span class=cl><span class=s>  # need to move it to anaconda.desktop to make shell happy
</span></span></span><span class=line><span class=cl><span class=s>  #cp /usr/share/applications/liveinst.desktop /usr/share/applications/anaconda.desktop</span>
</span></span><span class=line><span class=cl><span class=na>fi</span>
</span></span><span class=line><span class=cl>  <span class=na>cat &gt;&gt; /usr/share/glib-2.0/schemas/org.gnome.shell.gschema.override &lt;&lt; FOE</span>
</span></span><span class=line><span class=cl><span class=k>[org.gnome.shell]</span>
</span></span><span class=line><span class=cl><span class=na>favorite-apps</span><span class=o>=</span><span class=s>[&#39;liveinst.desktop&#39;,&#39;firefox.desktop&#39;, &#39;evolution.desktop&#39;, &#39;empathy.desktop&#39;, &#39;rhythmbox.desktop&#39;, &#39;shotwell.desktop&#39;, &#39;libreoffice-writer.desktop&#39;, &#39;nautilus.desktop&#39;, &#39;gnome-documents.desktop&#39;, &#39;anaconda.desktop&#39;]</span>
</span></span><span class=line><span class=cl><span class=na>FOE</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># set up auto-login</span>
</span></span><span class=line><span class=cl><span class=na>cat &gt; /etc/gdm/custom.conf &lt;&lt; FOE</span>
</span></span><span class=line><span class=cl><span class=k>[daemon]</span>
</span></span><span class=line><span class=cl><span class=na>AutomaticLoginEnable</span><span class=o>=</span><span class=s>True</span>
</span></span><span class=line><span class=cl><span class=na>AutomaticLogin</span><span class=o>=</span><span class=s>liveuser</span>
</span></span><span class=line><span class=cl><span class=na>FOE</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Turn off PackageKit-command-not-found while uninstalled</span>
</span></span><span class=line><span class=cl><span class=na>if [ -f /etc/PackageKit/CommandNotFound.conf ]; then</span>
</span></span><span class=line><span class=cl>  <span class=na>sed -i -e &#39;s/^SoftwareSourceSearch</span><span class=o>=</span><span class=s>true/SoftwareSourceSearch=false/&#39; /etc/PackageKit/CommandNotFound.conf</span>
</span></span><span class=line><span class=cl><span class=na>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># make sure to set the right permissions and selinux contexts</span>
</span></span><span class=line><span class=cl><span class=na>chown -R liveuser:liveuser /home/liveuser/</span>
</span></span><span class=line><span class=cl><span class=na>restorecon -R /home/liveuser/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Fixing default locale to us</span>
</span></span><span class=line><span class=cl><span class=na>localectl set-keymap us</span>
</span></span><span class=line><span class=cl><span class=na>localectl set-x11-keymap us</span>
</span></span><span class=line><span class=cl><span class=na>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># rebuild schema cache with any overrides we installed</span>
</span></span><span class=line><span class=cl><span class=na>glib-compile-schemas /usr/share/glib-2.0/schemas</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>%end</span>
</span></span></code></pre></div><p>注意，上面注释了两个地方，都可以添加软件或者运行脚本</p><p><img alt=image-20211011103123419 loading=lazy src=/posts/20211010-live_cd/image-20211011103123419.png></p><p><img alt=image-20211011103303446 loading=lazy src=/posts/20211010-live_cd/image-20211011103303446.png></p><h2 id=三build出iso文件>三、build出iso文件<a hidden class=anchor aria-hidden=true href=#三build出iso文件>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>livecd-creator --verbose -c centos7-live-docker.ks --cache<span class=o>=</span>cache -f centos7-live-docker
</span></span></code></pre></div><p>然后就会得到centos7-live-docker.iso的文件，注意在build过程中的报错信息，多数是无法下载包导致的。</p><p>直接加载ISO文件启动或者刻录到USB上启动，就可以进入这个自制的Live系统了</p><p>千万注意，启动一定要选Bios legacy，不要用Uefi。</p><p>相关一些有用的链接：</p><ol><li><a href=https://github.com/minishift/minishift-centos-iso>https://github.com/minishift/minishift-centos-iso</a></li><li><a href=https://github.com/livecd-tools/livecd-tools>https://github.com/livecd-tools/livecd-tools</a></li><li><a href=https://blog.csdn.net/sharpbladepan/article/details/107423468>https://blog.csdn.net/sharpbladepan/article/details/107423468</a></li></ol></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://rendoumi.com/posts/20211014-linux_wifi/><span class=title>« 上一页</span><br><span>Ubuntu下自建一个wifi热点供手机使用</span>
</a><a class=next href=https://rendoumi.com/posts/untitled/><span class=title>下一页 »</span><br><span></span></a></nav></footer><div id=comments></div><script src=https://cwd.js.org/cwd.js></script><script>const comments=new CWDComments({el:"#comments",apiBaseUrl:"https://cwd.rendoumi.qzz.io"});comments.mount()</script></article></main><footer class=footer><span>Copyright © 2020-2025 Zhang Ranrui. All Rights Reserved.</span><br>·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script></body></html>