[{"categories":null,"content":"å…ˆæ™®åŠä¸€ä¸‹æ¦‚å¿µï¼ŒInfrastructure as Codeï¼Œä¹Ÿå°±æ˜¯ä»ä»£ç å¼€å§‹å®šä¹‰æ•´ä¸ªç½‘ç»œç¯å¢ƒã€è™šæœºã€å„ç§èµ„æºç­‰ç­‰ã€‚\nç®€å•è¯´å°±æ˜¯åœ¨äº‘ä¸Šç”¨ä»£ç æ¥ç®¡ç†ä¸€åˆ‡ï¼Œæ— è®ºæ˜¯vpcã€subnetworkã€lbã€snatã€sgã€ec2\u0026hellip;\u0026hellip;\néå¸¸ç¬¦åˆæˆ‘çš„èƒƒå£ï¼Œå› ä¸ºå°±è¿æ¶æ„å›¾ï¼Œéƒ½æ˜¯ç”¨ graphviz æ¥ç”»çš„ã€‚\né‚£ä¹ˆ Infrastructure as Code ï¼ˆIACï¼‰ å¯ä»¥åˆ†ä¸ºä»¥ä¸‹äº”ä¸ªéƒ¨åˆ†ï¼š\n Ad hoc scripts Configuration Management tools Orchestration tools Provisioning tools Server Templating tools  ä¸€ã€Ad hoc scripts å°±æ˜¯ç”¨è½¯ä»¶å¯¹ç›®çš„ä¸»æœºè¿›è¡Œ point to point æ“ä½œï¼Œç”¨shellæˆ–è€…ansibleéƒ½å¯ä»¥ã€‚æ¨èansibleã€‚\nåœ¨ infosys é¢è¯•è¢«ä¸€ä¸ªå°åº¦è€å¤–é—®åˆ°è¿™é—®é¢˜ï¼Œå› ä¸ºå¹³æ—¶æ ¹æœ¬ä¸ç”¨ansible çš„ ad hoc ç‚¹å¯¹ç‚¹æ¨¡å¼ï¼Œç»“æœè¢«å½“åœºé—®ä½ã€‚ç°åœ¨æ‰çŸ¥é“è¿™ç©æ„æ˜¯ä»€ä¹ˆã€‚å½“ç„¶ï¼Œç”¨ ansible çš„è¯ä¸å»ºè®®ç”¨è¿™ä¸ªï¼Œå› ä¸º playbook æ˜¯å¯è¿½æº¯çš„ã€‚\näºŒã€Configuration Management tools é…ç½®ç®¡ç†ï¼Œè¿™é‡Œå½“ç„¶æ¨è ansibleï¼Œæ¯ä¸€æ­¥çš„æ“ä½œéƒ½å¯ä»¥æœ‰ inventory å’Œ playbook å¯ä»¥è¿½æº¯ã€‚\nä¸‰ã€Orchestration tools ååŒå·¥å…·ï¼Œk8så’Œkvm\nå››ã€Provisioning tools ç”Ÿäº§å·¥å…·ï¼Œå½“ç„¶æ˜¯terraformï¼Œå¦å¤–ï¼Œé˜¿é‡Œäº‘æ˜¯æ”¯æŒplumiçš„ï¼Œåä¸ºè…¾è®¯ä¸æ”¯æŒã€‚\näº”ã€Server Templating tools æ¨¡æ¿å·¥å…·ï¼Œè¿™é‡Œå°±æ˜¯ Packerï¼Œå…¶å®æˆ‘ä»¬å…¬å¸ç°åœ¨çš„æ¨¡æ¿å·¥å…·ï¼Œæ˜¯å…«æˆ’ä»openstackå­¦çš„ï¼Œæ”¹åŠ¨Cloud-initçš„ä¸œè¥¿ã€‚\nPackeræ›´æ ‡å‡†ä¸€ä¸‹ï¼Œæ˜¯è¿›åŒ–ç‰ˆçš„ä¸œè¥¿ï¼Œå®ƒæ—¢å¯ä»¥æ‰“kvmé•œåƒï¼Œä¹Ÿå¯ä»¥æ‰“Dockeré•œåƒã€‚\nä¸‹é¢æˆ‘ä»¬å°±çœ‹çœ‹æ€ä¹ˆä½¿ç”¨å§ï¼Œè¿™é‡Œå…ˆè¯´kvmï¼Œå› ä¸ºkvmçš„æ¯”è¾ƒéš¾ï¼Œdockerçš„å…«æˆ’ç°åœ¨è¿˜æ˜¯ç”¨Dockerfileï¼Œæœ‰ç©ºäº†å†ç ”ç©¶packerï¼š\nå®‰è£…å°±ä¸å¤šè¯´äº†ï¼Œå°±ä¸€ä¸ªæ‰§è¡Œæ–‡ä»¶ï¼Œä¸‹è½½ä¸‹æ¥å°±è¡Œï¼Œä¸ç”¨è£…ã€‚\nPackerçš„æ ¸å¿ƒæ˜¯ä¸‰ä¸ªéƒ¨åˆ†\n builders provisioners post-processors  æˆ‘ä»¬å…ˆå»ºç«‹ä¸€ä¸ªç©ºç›®å½•ï¼Œåå­—éšä¾¿ï¼Œå°±å« test-image\n1mkdir test-images 2cd test-image ç„¶ååœ¨ç›®å½•ä¸‹é¢ï¼Œå»ºç«‹ä¸‰ä¸ªæ–‡ä»¶ï¼š\npacker.json, variable.json, setup.sh\né¦–å…ˆçœ‹variable.jsonï¼Œå¯¹åº”AWSé•¿è¿™æ ·\n1{ 2 \u0026#34;description\u0026#34;: \u0026#34;test image\u0026#34;, 3 \u0026#34;access_key\u0026#34;: \u0026#34;enter-aws-your-key\u0026#34;, 4 \u0026#34;secret_key\u0026#34;: \u0026#34;enter-aws-your-secret\u0026#34; 5 \u0026#34;source_ami\u0026#34;: \u0026#34;enter-yours\u0026#34; 6 } å¯¹åº”è…¾è®¯äº‘å°±æ˜¯è¿™æ ·\n1{ 2 \u0026#34;description\u0026#34;: \u0026#34;test image\u0026#34;, 3 \u0026#34;tc_secret_id\u0026#34;: \u0026#34;TENCENTCLOUD_ACCESS_KEY\u0026#34;, 4 \u0026#34;tc_secret_key\u0026#34;: \u0026#34;TENCENTCLOUD_SECRET_KEY\u0026#34;, 5 \u0026#34;source_tc\u0026#34;: \u0026#34;enter-yours\u0026#34; 6} ç¨å¾®è§£é‡Šä¸€ä¸‹ï¼Œæ— è®ºå“ªå®¶äº‘ï¼Œä½ éƒ½éœ€è¦å»ç”³è¯·secretçš„keyï¼Œæ‰å¯ä»¥ç”¨ï¼Œç„¶åå°±æ˜¯source_amiå’Œsource_tcäº†ï¼Œè¿™ä¸ªæŒ‡é•œåƒçš„æ¯ç‰ˆ\nawsçš„é•¿è¿™æ ·ï¼š\nè…¾è®¯çš„é•¿è¿™æ ·ï¼š\nokï¼Œå˜é‡éƒ½å®šä¹‰å¥½äº†ã€‚\nä¸‹é¢æ˜¯packer.jsonçš„æ­£æ–‡\nawsçš„è¿™æ ·ï¼š\n1{ 2\t\u0026#34;builders\u0026#34;: [ 3 { 4 \u0026#34;type\u0026#34;: \u0026#34;amazon-ebs\u0026#34;, 5 \u0026#34;access_key\u0026#34;: \u0026#34;{{user `access_key` }}\u0026#34;, 6 \u0026#34;secret_key\u0026#34;: \u0026#34;{{user `secret_key` }}\u0026#34;, 7 \u0026#34;region\u0026#34; : \u0026#34;us-east-1\u0026#34;, 8 \u0026#34;ami_name\u0026#34; : \u0026#34;myfirstami\u0026#34;, 9 \u0026#34;source_ami\u0026#34; : \u0026#34;{{user `source_ami` }}\u0026#34;, 10 \u0026#34;instance_type\u0026#34; : \u0026#34;t2.micro\u0026#34;, 11 \u0026#34;ssh_username\u0026#34; : \u0026#34;ec2-user\u0026#34; 12 } 13 ], 14 \u0026#34;provisioners\u0026#34;: [ 15 { 16 \u0026#34;type\u0026#34;: \u0026#34;shell\u0026#34;, 17 \u0026#34;script\u0026#34;: \u0026#34;setup.sh\u0026#34; 18 } 19 ], 20\t\u0026#34;post-processors\u0026#34;: [ 21 { 22 \u0026#34;type\u0026#34;: \u0026#34;manifest\u0026#34;, 23 \u0026#34;output\u0026#34;: \u0026#34;out.json\u0026#34; 24 } 25 ] 26} çœ‹è§äº†å§ï¼Œæ ¸å¿ƒä¸‰éƒ¨åˆ†ã€‚é‚£ä¹ˆæ¢æˆè…¾è®¯ï¼Œå°±é•¿è¿™æ ·\n1{ 2 \u0026#34;builders\u0026#34;: [ 3 { 4 \u0026#34;type\u0026#34;: \u0026#34;tencentcloud-cvm\u0026#34;, 5 \u0026#34;secret_id\u0026#34;: \u0026#34;{{user `tc_secret_id`}}\u0026#34;, 6 \u0026#34;secret_key\u0026#34;: \u0026#34;{{user `tc_secret_key`}}\u0026#34;, 7 \u0026#34;region\u0026#34;: \u0026#34;ap-guangzhou\u0026#34;, 8 \u0026#34;zone\u0026#34;: \u0026#34;ap-guangzhou-3\u0026#34;, 9 \u0026#34;instance_type\u0026#34;: \u0026#34;S2.SMALL1\u0026#34;, 10 \u0026#34;disk_type\u0026#34;: \u0026#34;CLOUD_PREMIUM\u0026#34;, 11 \u0026#34;associate_public_ip_address\u0026#34;: true, 12 \u0026#34;image_name\u0026#34;: \u0026#34;myfirsttc\u0026#34;, 13 \u0026#34;source_image_id\u0026#34;: \u0026#34;{{user `source_tc` }}\u0026#34;, 14 \u0026#34;ssh_username\u0026#34; : \u0026#34;root\u0026#34; 15 } 16 ], 17 \u0026#34;provisioners\u0026#34;: [ 18 { 19 \u0026#34;type\u0026#34;: \u0026#34;shell\u0026#34;, 20 \u0026#34;script\u0026#34;: \u0026#34;setup.sh\u0026#34; 21 } 22 ], 23\t\u0026#34;post-processors\u0026#34;: [ 24 { 25 \u0026#34;type\u0026#34;: \u0026#34;manifest\u0026#34;, 26 \u0026#34;output\u0026#34;: \u0026#34;out.json\u0026#34; 27 } 28 ] 29} å¤§å·®ä¸å·®å§ã€‚\nè¯¦ç»†å‚æ•°å¯ä»¥å»çœ‹ï¼šhttps://www.packer.io/plugins/builders/tencentcloud\né‚£æœ€åå°±æ˜¯setup.shäº†ï¼Œä¸¾ä¾‹è£…ä¸ªjenkinså¥½äº†ï¼Œå…¶ä»–çš„å¯ä»¥æ ¹æ®éœ€è¦è¿›è¡Œæ³¨å…¥ï¼š\n1sleep 30 2sudo yum update â€“y 3sudo wget -O /etc/yum.repos.d/jenkins.repo \\ 4 https://pkg.jenkins.io/redhat-stable/jenkins.repo 5sudo rpm --import https://pkg.jenkins.io/redhat-stable/jenkins.io.key 6sudo yum upgrade 7sudo yum instqll -y epel-release 8sudo yum install java-openjdk11 -y 9sudo yum install jenkins -y 10sudo systemctl enable jenkins 11sudo systemctl start jenkins 12sudo systemctl status jenkins æœ€årunä¸€ä¸‹ï¼š\n1packer build -var-file=\u0026#34;variable.json\u0026#34; packer.json å½å“©å’•å™œä¸€é¡¿ï¼Œå°±buildå¥½äº†\nOverï¼Œè¿™ä¸ªå·¥å…·åœ¨IASä¸­æ˜¯ä¸å¯ç¼ºå°‘çš„ä¸€ç¯ã€‚\n","date":"2022-07-17","img":"","permalink":"https://bajie.dev/posts/20220717-terraform/","series":null,"tags":null,"title":"Infrastructure as Codeä¸­packerçš„ä½¿ç”¨"},{"categories":null,"content":"åœ¨æ—¥å¸¸å·¥ä½œä¸­æˆ‘ä»¬ç»å¸¸è¦å¯¹ Cisco çš„ç½‘ç»œè®¾å¤‡çš„é…ç½®è¿›è¡Œå¤‡ä»½ï¼Œæˆ–è€…å’Œ suricata è”åŠ¨çš„æ—¶å€™è¦æ‰§è¡Œæ“ä½œã€‚\næ–¹æ³•å…¶å®å¾ˆç®€å•ï¼Œè°ƒç”¨ python çš„ç›¸åº”æ¨¡å—å³å¯ã€‚\nå‡†å¤‡å·¥ä½œå¦‚ä¸‹ï¼š\né¦–é€‰éœ€è¦åœ¨/export/servers/python363è£…å¥½ python 3.6, pip install netmiko\nå…¶æ¬¡ï¼Œåœ¨è·¯ç”±å™¨ä¸Šå¯ä»¥é…ç½®ençš„å¯†ç \nç„¶åä¾æ¬¡æ‰§è¡Œå¤‡ä»½å°±å¯ä»¥äº†ã€‚\n1#!/export/servers/python363/bin/python3.6 2from netmiko import Netmiko 3import time 4tw_bgp = { 5 \u0026#34;device_type\u0026#34;: \u0026#34;cisco_ios\u0026#34;, 6 \u0026#34;host\u0026#34;: \u0026#34;tw-bgp\u0026#34;, 7 \u0026#34;ip\u0026#34;: \u0026#34;192.168.1.10\u0026#34;, 8 \u0026#34;username\u0026#34;: \u0026#34;noc\u0026#34;, 9 \u0026#34;use_keys\u0026#34;: True, 10 \u0026#34;secret\u0026#34; : \u0026#34;xxxxxxxx\u0026#34;, 11 \u0026#34;key_file\u0026#34;: \u0026#34;/root/.ssh/id_jump_rsa_new\u0026#34;, 12} 13tw_r1_e1 = { 14 \u0026#34;device_type\u0026#34;: \u0026#34;cisco_ios\u0026#34;, 15 \u0026#34;host\u0026#34;: \u0026#34;tw-r1-e1\u0026#34;, 16 \u0026#34;ip\u0026#34;: \u0026#34;192.168.1.11\u0026#34;, 17 \u0026#34;username\u0026#34;: \u0026#34;noc\u0026#34;, 18 \u0026#34;use_keys\u0026#34;: True, 19 \u0026#34;key_file\u0026#34;: \u0026#34;/root/.ssh/id_jump_rsa_new\u0026#34;, 20} 21tw_r1_e2 = { 22 \u0026#34;device_type\u0026#34;: \u0026#34;cisco_ios\u0026#34;, 23 \u0026#34;host\u0026#34;: \u0026#34;tw-r1-e2\u0026#34;, 24 \u0026#34;ip\u0026#34;: \u0026#34;192.168.1.12\u0026#34;, 25 \u0026#34;username\u0026#34;: \u0026#34;noc\u0026#34;, 26 \u0026#34;use_keys\u0026#34;: True, 27 \u0026#34;key_file\u0026#34;: \u0026#34;/root/.ssh/id_jump_rsa_new\u0026#34;, 28} 29tw_r2_e1 = { 30 \u0026#34;device_type\u0026#34;: \u0026#34;cisco_ios\u0026#34;, 31 \u0026#34;host\u0026#34;: \u0026#34;tw-r2-e1\u0026#34;, 32 \u0026#34;ip\u0026#34;: \u0026#34;192.168.1.13\u0026#34;, 33 \u0026#34;username\u0026#34;: \u0026#34;noc\u0026#34;, 34 \u0026#34;use_keys\u0026#34;: True, 35 \u0026#34;key_file\u0026#34;: \u0026#34;/root/.ssh/id_jump_rsa_new\u0026#34;, 36} 37tw_r2_e2 = { 38 \u0026#34;device_type\u0026#34;: \u0026#34;cisco_ios\u0026#34;, 39 \u0026#34;host\u0026#34;: \u0026#34;tw-r2-e2\u0026#34;, 40 \u0026#34;ip\u0026#34;: \u0026#34;192.168.1.14\u0026#34;, 41 \u0026#34;username\u0026#34;: \u0026#34;noc\u0026#34;, 42 \u0026#34;use_keys\u0026#34;: True, 43 \u0026#34;key_file\u0026#34;: \u0026#34;/root/.ssh/id_jump_rsa_new\u0026#34;, 44} 45 46devices=[tw_bgp, tw_r1_e1, tw_r1_e2, tw_r2_e1, tw_r2_e2] 47 48for dev in devices: 49 name = dev[\u0026#34;ip\u0026#34;] 50 connection = Netmiko(**dev) 51 connection.enable() 52 out = connection.send_command(\u0026#34;show running-config\u0026#34;) 53 calender = time.strftime(\u0026#34;%Y%m%d\u0026#34;) 54 file_name = \u0026#39;{}-{}.txt\u0026#39;.format(dev[\u0026#34;host\u0026#34;],calender) 55 file = open(file_name ,\u0026#34;w\u0026#34;) 56 file.write(out) 57 file.close() 58 connection.disconnect() 59 print(\u0026#34;BACKUP for %sdone\u0026#34; %dev[\u0026#34;host\u0026#34;]) ","date":"2022-07-17","img":"","permalink":"https://bajie.dev/posts/20220717-backup_cisco/","series":null,"tags":null,"title":"Ciscoè®¾å¤‡è‡ªåŠ¨æ‰§è¡Œå’Œå¤‡ä»½çš„è„šæœ¬"},{"categories":null,"content":"NFS Server å¾ˆå¸¸ç”¨ï¼Œä½†æ˜¯å‘ä¹Ÿæ˜¯å·¨å¤§çš„ã€‚ä¹‹å‰åœ¨äº¬ä¸œè¿ç»´ Hadoop é›†ç¾¤çš„æ—¶å€™ç¢°åˆ°è¿‡è„‘è£‚ï¼ŒåŸå› å°±æ˜¯ NFS å¼•èµ·çš„ã€‚\nå…³é”® NFS æ˜¯å†…æ ¸æ€çš„ï¼Œä¸€æ—¦å´©æºƒï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯çš„æ‰€æœ‰å‘½ä»¤ï¼Œlsã€dfã€duç­‰ç­‰ï¼Œç»Ÿç»Ÿæ— ååº”ï¼Œç»“æœæ˜¯å¾ˆæ‚²å‰§çš„ã€‚\nä¸‹é¢è¦æ¨èä¸€ä¸‹ nfs-ganesha ï¼Œå®ƒæ˜¯ç”¨æˆ·æ€çš„nfs-serverï¼Œæ”¯æŒv3å’Œv4ï¼Œè€Œnfsç¼ºçœæ˜¯å†…æ ¸æ€çš„v3ã€‚\nå¼ºçƒˆæ¨èå¤§å®¶ç”¨è¿™ä¸ªï¼Œè€Œä¸æ˜¯ç”¨å†…æ ¸æ€çš„ï¼Œå¹¶ä¸” nfs-ganesha è¿˜æ˜¯æ”¯æŒ glusterFS çš„ã€‚\n1yum install -y centos-release-nfs-ganesha30.noarch 2 3vi /etc/ganesha/ganesha.conf 4%include /etc/ganesha/exports/gv0.conf 5 6vi /etc/ganesha/exports/gv0.conf 7EXPORT{ 8 Export_Id = 1 ; # Export ID unique to each export 9 Path = \u0026#34;/mnt/upload\u0026#34;; 10 Pseudo = /upload; 11 FSAL { 12 name = VFS; 13 } 14 Access_type = RW; # Access permissions 15 Squash = No_root_squash; # To enable/disable root squashing 16 Disable_ACL = TRUE; # To enable/disable ACL 17 Protocols = \u0026#34;4\u0026#34; ; # NFS protocols supported 18 Transports = \u0026#34;UDP\u0026#34;,\u0026#34;TCP\u0026#34; ; # Transport protocols supported 19 SecType = \u0026#34;sys\u0026#34;; # Security flavors supported 20} 21 22#å¯åŠ¨ 23systemctl restart nfs-ganesha 24 25#æ‰‹åŠ¨mountçš„æ–¹æ³• 26mount -t nfs -o soft,intr,rsize=8192,wsize=8192,timeo=900,proto=tcp,vers=4 192.168.31.2:/upload /mnt/nfs-upload 27 28#è‡ªåŠ¨mountçš„æ–¹æ³• 29cat /etc/fstab 30192.168.31.2:/upload /mnt/nfs-upload nfs rw,vers=4,addr=192.168.31.2,clientaddr=192.168.31.8 0 0 æ³¨æ„idå¯¹é½é—®é¢˜å¯èƒ½è¦ç”¨åˆ°rpcidmapd\n","date":"2022-07-06","img":"","permalink":"https://bajie.dev/posts/20220706-nfs_usermode/","series":null,"tags":null,"title":"ç”¨æˆ·æ€çš„NFS Server"},{"categories":null,"content":"JavaScript åˆ°åº•æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ ä¸€ã€å·¥ä½œåŸç†  JavaScriptåˆ°åº•æ˜¯ï¼š\n åŒæ­¥è¿˜æ˜¯å¼‚æ­¥ï¼Ÿ å•çº¿ç¨‹è¿˜æ˜¯å¤šçº¿ç¨‹ï¼Ÿ     JavaScript ä¸­çš„ä¸€åˆ‡éƒ½å‘ç”Ÿåœ¨\nExecution Context ï¼ˆæ‰§è¡Œä¸Šä¸‹æ–‡ï¼‰ä¸­\n æ‚¨å¯ä»¥å‡è®¾è¿™ä¸ªæ‰§è¡Œä¸Šä¸‹æ–‡ æ˜¯ä¸€ä¸ªå¤§ç›’å­æˆ–ä¸€ä¸ªå®¹å™¨ï¼Œåœ¨å…¶ä¸­æ‰§è¡Œæ•´ä¸ª JavaScript ä»£ç ã€‚ è¿™ä¸ªå¤§ç›’å­é‡Œæœ‰ä¸¤ä¸ªç»„ä»¶ï¼š  Memoryï¼ˆå†…å­˜ç»„ä»¶ï¼‰ï¼šè¿™æ˜¯æ‰€æœ‰å˜é‡å’Œå‡½æ•°å­˜å‚¨ä¸ºé”®å€¼å¯¹çš„åœ°æ–¹ã€‚è¿™ä¸ª**â€œå†…å­˜ç»„ä»¶â€**ä¹Ÿç§°ä¸º**å˜é‡ç¯å¢ƒ**ã€‚å› æ­¤ï¼Œå®ƒæ˜¯ä¸€ç§ç¯å¢ƒï¼Œå…¶ä¸­æ‰€æœ‰è¿™äº›å˜é‡å’Œå‡½æ•°éƒ½å­˜å‚¨ä¸ºé”®å€¼å¯¹ã€‚ Codeï¼ˆä»£ç ç»„ä»¶ï¼‰ï¼šè¿™æ˜¯ä»£ç é€è¡Œæ‰§è¡Œçš„åœ°æ–¹ã€‚è¿™ä¸ªâ€œä»£ç ç»„ä»¶â€ä¹Ÿç§°ä¸ºæ‰§è¡Œçº¿ç¨‹ã€‚æ‰€ä»¥ï¼Œè¿™ä¸ªæ‰§è¡Œçº¿ç¨‹æ˜¯ä¸€ä¸ªå•çº¿ç¨‹ï¼Œæ•´ä¸ªä»£ç ä¸€æ¬¡åªæ‰§è¡Œä¸€è¡Œã€‚      ç»“è®ºï¼šJavaScript æ˜¯ä¸€ç§åŒæ­¥å•çº¿ç¨‹è¯­è¨€ã€‚\n å•çº¿ç¨‹ æ„å‘³ç€ JavaScript ä¸€æ¬¡åªèƒ½æ‰§è¡Œä¸€ä¸ªå‘½ä»¤ã€‚ åŒæ­¥å•çº¿ç¨‹ æ„å‘³ç€ JavaScript ä¸€æ¬¡åªèƒ½ä»¥ç‰¹å®šé¡ºåºæ¯æ¬¡æ‰§è¡Œä¸€ä¸ªå‘½ä»¤ã€‚è¿™æ„å‘³ç€å®ƒåªèƒ½åœ¨å½“å‰è¡Œå®Œæˆæ‰§è¡Œåè½¬åˆ°ä¸‹ä¸€è¡Œã€‚è¿™å°±æ˜¯åŒæ­¥å•çº¿ç¨‹çš„æ„æ€ã€‚    å¾ˆæƒŠè¯§å§ï¼Œå®é™… javascripts æœ‰å•çº¿ç¨‹ event loop å¤§å¾ªç¯æ¥å®Œæˆå¾ˆå¤šä¸å¯æ€è®®çš„äº‹æƒ…ã€‚\näºŒã€å®é™…å·¥ä½œè¿‡ç¨‹åˆ†æ JavaScript ä»£ç æ˜¯å¦‚ä½•æ‰§è¡Œçš„ï¼Ÿ å½“ä½ è¿è¡Œ JavaScript ä»£ç æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ\n ä¼šåˆ›å»ºä¸€ä¸ªExecution Contextï¼ˆæ‰§è¡Œä¸Šä¸‹æ–‡ï¼‰ã€‚\n è®©æˆ‘ä»¬ä½¿ç”¨å®é™…çš„ä»£ç æ¥ä¸¾ä¸ªä¾‹å­ï¼š\n1var n = 2; 2function square(num) { 3 var ans = num * num; 4 return ans; 5} 6var square2 = square(n); 7var square4 = square(4);   æ‰§è¡Œä¸Šè¿°ä»£ç æ—¶ï¼Œä¼šåˆ›å»º ä¸€ä¸ªæ‰§è¡Œä¸Šä¸‹æ–‡\n  æ­¤æ‰§è¡Œä¸Šä¸‹æ–‡åˆ†ä¸¤ä¸ªé˜¶æ®µåˆ›å»ºï¼š\n  ä¸€ã€åˆ›å»ºï¼š\nåˆ›å»ºé˜¶æ®µä¹Ÿç§°ä¸ºå†…å­˜åˆ›å»ºé˜¶æ®µ\nã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸å…³é”®çš„é˜¶æ®µã€‚\n  åœ¨å†…å­˜åˆ›å»ºçš„ç¬¬ä¸€é˜¶æ®µï¼ŒJavaScript ä¼šä¸ºæ‰€æœ‰çš„å˜é‡å’Œå‡½æ•°åˆ†é…å†…å­˜ã€‚\n  é¦–å…ˆ JavaScript é‡åˆ°var n = 2;ï¼Œå®ƒå°±ä¼šåˆ†é…å†…å­˜ç»™n.\nå½“ä¸ºnåˆ†é…å†…å­˜æ—¶ï¼Œå®ƒä¼šå…ˆå­˜å‚¨ä¸€ä¸ªç‰¹æ®Šå€¼undefinedã€‚undefinedåœ¨ JavaScript ä¸­è¢«è§†ä¸ºç‰¹æ®Šçš„å ä½ç¬¦ã€‚\n  åœ¨é‡åˆ° functionsquare(num)æ—¶ï¼Œå®ƒä¹Ÿä¼šä¸ºè¿™ä¸ª function () åˆ†é…å†…å­˜ã€‚\n  åœ¨ä¸º function() åˆ†é…å†…å­˜çš„æƒ…å†µä¸‹ï¼Œå®ƒå°†è¯¥å‡½æ•°çš„æ•´ä¸ªä»£ç å­˜å‚¨åœ¨å†…å­˜ç©ºé—´ä¸­ã€‚\n  åé¢ä¸ºä¸¤ä¸ªå˜é‡square2å’Œsquare4åˆ†é…äº†å†…å­˜ï¼Œå­˜å‚¨çš„åŒæ ·æ˜¯undefinedã€‚\n  ä¸ºäº†å®Œæˆè¿™ä¸ªåˆ›å»ºé˜¶æ®µï¼ŒJavaScript ä¼šé€è¡Œä»ä¸Šåˆ°ä¸‹éå†æ‰«æä»£ç ã€‚\n    äºŒã€ä»£ç æ‰§è¡Œï¼š\n æ‰«æå®Œæ¯•ï¼Œç°åœ¨ JavaScript å†æ¬¡é€è¡Œè¿è¡Œæ•´ä¸ªç¨‹åºã€‚ å½“å®ƒé‡åˆ°æ—¶var n = 2;ï¼Œå®ƒå®é™…ä¸Šå°†2ä½œä¸ºå€¼næ”¾å…¥å†…å­˜ç»„ä»¶ä¸­ã€‚ å½“å®ƒé‡åˆ° çš„å‡½æ•°å®šä¹‰æ—¶square(num)ï¼Œå®ƒæ²¡æœ‰ä»€ä¹ˆå¯æ‰§è¡Œçš„ï¼Œæ‰€ä»¥ JavaScript ç®€å•åœ°è·³è¿‡äº†ã€‚ å½“å®ƒé‡åˆ° æ—¶var square2 = square(n);ï¼Œæˆ‘ä»¬ç°åœ¨æ­£åœ¨è°ƒç”¨ä¸€ä¸ªå‡½æ•°ã€‚ å‡½æ•°æ˜¯ JavaScript çš„æ ¸å¿ƒã€‚å®ƒä»¬åœ¨ JavaScript ä¸­çš„è¡Œä¸ºä¸åœ¨ä»»ä½•å…¶ä»–è¯­è¨€ä¸­çš„è¡Œä¸ºéå¸¸ä¸åŒã€‚ æ¯å½“è°ƒç”¨ä¸€ä¸ªå‡½æ•°æ—¶ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªå…¨æ–°çš„Execution Contextï¼ˆæ‰§è¡Œä¸Šä¸‹æ–‡ï¼‰ã€‚ å› æ­¤ï¼Œä»æŠ€æœ¯ä¸Šè®²ï¼Œåœ¨æ•´ä¸ª**Execution Context çš„ä»£ç ç»„ä»¶ä¸­åˆåˆ›å»ºäº†ä¸€ä¸ªå…¨æ–°çš„Execution Context ** ã€‚ è¿™ä¸ªæ–°çš„å†…éƒ¨ Exection Context æ‰§è¡Œä¸Šä¸‹æ–‡ä¹Ÿæœ‰å®ƒè‡ªå·±çš„å†…å­˜ç»„ä»¶å’Œä»£ç ç»„ä»¶ã€‚ ç°åœ¨åœ¨å†…éƒ¨å‘ç”Ÿçš„äº‹æƒ…æ˜¯ï¼š  åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæœ‰ 2 ä¸ªå˜é‡ï¼Œå³numï¼ˆå‚æ•°ï¼‰å’Œansã€‚ æ‰€ä»¥å†…å­˜å°†åˆ†é…ç»™numå’Œansã€‚ åœ¨ç¬¬ 1 é˜¶æ®µï¼Œä¸å¤–éƒ¨æ‰§è¡Œä¸Šä¸‹æ–‡ä¸€æ ·ï¼Œundefinedå°†åˆ†é…ç»™numå’Œansã€‚ ç°åœ¨è¿›å…¥é˜¶æ®µ 2ï¼ˆä»£ç æ‰§è¡Œé˜¶æ®µï¼‰ï¼Œå‚æ•°çš„å€¼è¢«åˆ†é…ç»™å‚æ•°ã€‚å› æ­¤ï¼Œåœ¨æˆ‘ä»¬è°ƒç”¨å‡½æ•°çš„è¯­å¥var square2 = square(n);æ—¶ï¼Œæˆ‘ä»¬å°†å‚æ•°nçš„å€¼ 2 ä¼ é€’ç»™å‡½æ•°square(num)ï¼Œå¹¶ä¸”è¯¥å‚æ•°çš„å€¼æ›¿æ¢äº†å†…éƒ¨æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­numçš„å†…å­˜ç»„ä»¶ä¸­çš„å ä½ç¬¦undefinedã€‚ è®¡ç®—ånum * numï¼Œå°†å€¼å­˜å‚¨åœ¨ ä¸­ansã€‚ åœ¨é‡åˆ° æ—¶return ans;ï¼Œå°†å­˜å‚¨çš„å€¼ansè¿”å›åˆ°è°ƒç”¨çš„ä½ç½®ï¼Œå¹¶ä¸”æ­¤å†…éƒ¨æ‰§è¡Œä¸Šä¸‹æ–‡ç»“æŸã€‚å½“å®ƒç»“æŸæ—¶ï¼Œå†…éƒ¨æ‰§è¡Œä¸Šä¸‹æ–‡å®é™…ä¸Šè¢«åˆ é™¤äº†ã€‚   ç°åœ¨ï¼Œé‡åˆ°ä¸‹ä¸€è¡Œæ—¶éµå¾ªç›¸åŒçš„è¿‡ç¨‹var square4 = square(4);ã€‚ æœ€åä¸€è¡ŒæˆåŠŸæ‰§è¡Œåï¼Œæ•´ä¸ªæ‰§è¡Œä¸Šä¸‹æ–‡ä¹Ÿè¢«åˆ é™¤ã€‚è¿™ç§*â€œæ•´ä½“â€*æ‰§è¡Œä¸Šä¸‹æ–‡ä¹Ÿç§°ä¸º**å…¨å±€æ‰§è¡Œä¸Šä¸‹æ–‡**ã€‚         é‚£ä¹ˆï¼ŒJavaScript æ˜¯å¦‚ä½•ç®¡ç†è¿™ç§é“¾æ¡å¼çš„ ** æ‰§è¡Œä¸Šä¸‹æ–‡ ** çš„å‘¢ï¼Ÿ\n  å®ƒå®é™…ä¸Šåœ¨åå°ç®¡ç†ä¸€ä¸ªå †æ ˆã€‚ æ­¤å †æ ˆä¹Ÿç§°ä¸ºCall Stackï¼ˆè°ƒç”¨å †æ ˆï¼‰ã€‚ GECï¼ˆGlobal Execution Context å…¨å±€æ‰§è¡Œä¸Šä¸‹æ–‡ï¼‰å§‹ç»ˆä½äºæ­¤å †æ ˆçš„åº•éƒ¨ã€‚ æ¯å½“åˆ›å»ºä¸€ä¸ªæ–°çš„æ‰§è¡Œä¸Šä¸‹æ–‡æ—¶ï¼Œå®ƒå°±ä¼šè¢«å‹å…¥è¿™ä¸ªå †æ ˆï¼Œå¹¶åœ¨å®Œæˆå…¶ç›®çš„æ—¶è¢«å¼¹å‡ºã€‚ æ§ä»¶ä¸æ­¤è°ƒç”¨å †æ ˆçš„æœ€é¡¶éƒ¨å…ƒç´ ä¿æŒä¸€è‡´ã€‚ æ­¤è°ƒç”¨å †æ ˆä»…ç”¨äºç®¡ç†æ‰§è¡Œä¸Šä¸‹æ–‡ã€‚ åœ¨æˆåŠŸæ‰§è¡Œæœ€åä¸€æ¡è¯­å¥æ—¶ï¼Œè°ƒç”¨å †æ ˆè¢«æ¸…ç©ºã€‚   è°ƒç”¨å †æ ˆç»´æŠ¤æ‰§è¡Œä¸Šä¸‹æ–‡çš„*æ‰§è¡Œé¡ºåºã€‚*\n ç»™ä¸ªå›¾æ›´å¥½ç†è§£ï¼š\nè°ƒç”¨å †æ ˆå…·æœ‰ä»¥ä¸‹èŠ±å“¨çš„åç§°ï¼Œä¹Ÿå¯ä»¥é€šè¿‡è¿™äº›åç§°æ¥å¼•ç”¨å®ƒï¼š\n Execution Context Stackï¼ˆæ‰§è¡Œä¸Šä¸‹æ–‡å †æ ˆï¼‰ Program Stackï¼ˆç¨‹åºæ ˆï¼‰ Control Stackï¼ˆæ§åˆ¶å †æ ˆï¼‰ Runtime Stackï¼ˆè¿è¡Œæ—¶å †æ ˆï¼‰ Machine Stackï¼ˆæœºå™¨å †æ ˆï¼‰  è¿™æ ·å¤§å®¶å°±ç†è§£äº†å§ï¼Œè¿™æ ·åé¢çš„å˜é‡æå‡ Hoisting å°±å¾ˆå¥½ç†è§£äº†ã€‚\n ","date":"2022-06-21","img":"","permalink":"https://bajie.dev/posts/20220621-javascripts_how_to_run/","series":null,"tags":null,"title":"JavaScript åˆ°åº•æ˜¯å¦‚ä½•æ‰§è¡Œçš„å‘¢ -- JSçš„ä½œåŸç†"},{"categories":null,"content":"Javascripts ä¸­çš„ if \u0026hellip; else ç”¨èµ·æ¥å€’æ˜¯å¾ˆæ–¹ä¾¿ï¼Œä½†æ˜¯çœ‹èµ·æ¥å°±ä¸èˆ’æœäº†\n1if (true) { 2} 3 4if (true) { 5} 6 7if (true) { 8 if (true) { 9 if (true) { 10 } 11 } else { 12 } 13} else { 14} ä¸Šé¢çœ‹èµ·æ¥å¾ˆé—¹å¿ƒå§ï¼Œä¸‹é¢è®²è®²ä¼˜åŒ–ï¼š\nä¸€ã€ä¸‰å…ƒä¼˜åŒ– if (ture) elseå¯ä»¥ç”¨ä¸‰å…ƒæ“ä½œç¬¦æ¥ä¼˜åŒ–å®ƒï¼š\n1// Bad ğŸ˜¥ 2if (true) { 3 console.log(\u0026#34;Congratutions!\u0026#34;) 4} else { 5 console.warn(\u0026#34;Oops, something went wrong!\u0026#34;) 6} 7 8// Great ğŸ¥° 9true 10 ? console.log(\u0026#34;Congratutions\u0026#34;) 11 : console.warn(\u0026#34;Oops, something went wrong!\u0026#34;) äºŒã€ä¸ä¼˜åŒ– trueçš„æƒ…å†µä¸‹æ‰æ‰§è¡Œå¯ä»¥ç”¨ä¸æ¥è¿›è¡Œä¼˜åŒ–ï¼š\n1if (true) { 2 alert(1) 3} 4 5// is equals to: 6 7true \u0026amp;\u0026amp; alert(1) ä¸‰ã€æå‰è¿”å› å¦‚æœæœ‰å¤šä¸ªåˆ¤æ–­ï¼ŒæŒ‰ç…§å¤æ‚ç¨‹åº¦ï¼Œä»ä¸Šåˆ°ä¸‹ï¼Œæå‰è¿”å›ã€‚\n1function handleRequest(req) { 2 if (req.code \u0026gt;= 500) { 3 return \u0026#34;Server error\u0026#34;; 4 } 5 if (req.code \u0026gt;= 404) { 6 return \u0026#34;Cilent error\u0026#34;; 7 } 8 return \u0026#34;Suceess\u0026#34;; 9} å››ã€ç±»è¡¨æ ¼ä¼˜åŒ– ä¸‹é¢æ˜¯ç±»ä¼¼è¡¨æ ¼ä¼¼çš„é€‰æ‹©ï¼Œé€šå¸¸ä¼šç”¨ switch æ¥è¿›è¡Œä¼˜åŒ–\n1// Bad ğŸ˜¥ 2const weekday = (num) =\u0026gt; { 3 if (num === 1) { 4 return \u0026#34;Monday\u0026#34; 5 } else if (num === 2) { 6 return \u0026#34;Tuesday\u0026#34; 7 } else if (num === 3) { 8 return \u0026#34;Wednesday\u0026#34; 9 } else if (num === 4) { 10 return \u0026#34;Thursday\u0026#34; 11 } else if (num === 5) { 12 return \u0026#34;Friday\u0026#34; 13 } else if (num === 6) { 14 return \u0026#34;Saturday\u0026#34; 15 } else if (num === 7) { 16 return \u0026#34;Sunday\u0026#34; 17 } else { 18 return \u0026#34;Unknown\u0026#34; 19 } 20} 21 22console.log(weekday(1)) // Monday switch ä¹Ÿä¸æ˜¯æœ€ä¼˜è§£ï¼Œç”¨å¯¹è±¡çš„é”®å€¼å¯¹æ¥è§£ï¼š\n1const weekday = (option) =\u0026gt; { 2 let obj = { 3 1: \u0026#34;Monday\u0026#34;, 4 2: \u0026#34;Tuesday\u0026#34;, 5 3: \u0026#34;Wednesday\u0026#34;, 6 4: \u0026#34;Thursday\u0026#34;, 7 5: \u0026#34;Friday\u0026#34;, 8 6: \u0026#34;Saturday\u0026#34;, 9 0: \u0026#34;Sunday\u0026#34; 10 } 11 return obj[option] ?? \u0026#34;Unknown\u0026#34; 12} 13 14console.log(weekday(1)) // Monday ä¹Ÿå¯ä»¥ç”¨ ES6 çš„ map æ¥å®ç°ï¼š\n1// Great ğŸ¥° 2const weekday = (num) =\u0026gt; { 3 const map = new Map() 4 .set(1, \u0026#34;Monday\u0026#34;) 5 .set(2, \u0026#34;Tuesday\u0026#34;) 6 .set(3, \u0026#34;Wednesday\u0026#34;) 7 .set(4, \u0026#34;Thursday\u0026#34;) 8 .set(5, \u0026#34;Friday\u0026#34;) 9 .set(6, \u0026#34;Saturday\u0026#34;) 10 .set(7, \u0026#34;Sunday\u0026#34;); 11 return map.has(num) ? map.get(num) : \u0026#34;Unknown\u0026#34;; 12}; 13 14console.log(weekday(1)); äº”ã€é€‰é¡¹å¤šå¯¹ä¸€çš„æ•°ç»„ä¼˜åŒ– çœ‹å¦‚ä¸‹ä»£ç ï¼Œå¤šä¸ªé€‰é¡¹å¯¹åº”ä¸€ä¸ªè¿”å›ï¼š\n1const getContinent = (option) =\u0026gt; { 2 if (option === \u0026#34;China\u0026#34; || option === \u0026#34;Japan\u0026#34;) { 3 return \u0026#34;Asia\u0026#34;; 4 } 5 if (option === \u0026#34;Germany\u0026#34; || option === \u0026#34;France\u0026#34;) { 6 return \u0026#34;Europe\u0026#34;; 7 } 8}; 9 10console.log(getContinent(\u0026#34;China\u0026#34;)); ä½¿ç”¨æ•°ç»„æ¥å®¹çº³å¤šä¸ªé€‰é¡¹ï¼Œç„¶åç”¨ includes æ¥åˆ¤æ–­å¹¶è¿”å›\n1const getContinent = (option) =\u0026gt; { 2 const Asia = [\u0026#34;China\u0026#34;, \u0026#34;Japan\u0026#34;]; 3 const Europe = [\u0026#34;Germany\u0026#34;, \u0026#34;Franch\u0026#34;]; 4 if (Asia.includes(option)) return \u0026#34;Asia\u0026#34;; 5 if (Europe.includes(option)) return \u0026#34;Europe\u0026#34;; 6 return \u0026#34;Unknown\u0026#34;; 7}; 8 9console.log(getContinent(\u0026#34;China\u0026#34;)); // Asia è¿›ä¸€æ­¥ä¼˜åŒ–ï¼Œç”¨ \u0026amp;\u0026amp; ä¸ä¼˜åŒ–\n1const getContinent = (option) =\u0026gt; { 2 let [result, setResult] = [\u0026#34;unknown\u0026#34;, (str) =\u0026gt; (result = str)]; 3 const Asia = [\u0026#34;China\u0026#34;, \u0026#34;Japan\u0026#34;]; 4 const Europe = [\u0026#34;Germany\u0026#34;, \u0026#34;Franch\u0026#34;]; 5 Asia.includes(option) \u0026amp;\u0026amp; setResult(\u0026#34;Asia\u0026#34;); 6 Europe.includes(option) \u0026amp;\u0026amp; setResult(\u0026#34;Europe\u0026#34;); 7 return result; 8}; 9 10console.log(getContinent(\u0026#34;China\u0026#34;)); ","date":"2022-06-15","img":"","permalink":"https://bajie.dev/posts/20220615-javascripts_if/","series":null,"tags":null,"title":"Javascriptsä¸­ifçš„ä¼˜åŒ–"},{"categories":null,"content":"Shellè„šæœ¬çš„è¿›é˜¶æŠ€å·§ï¼š\nä¸€ã€String ç±»çš„æŠ€å·§ Stringç±»å½“ä½œæ•°ç»„æ¥ä½¿ç”¨ï¼Œæ³¨æ„èŒƒå›´çš„ä¸‹æ ‡ï¼Œ0:4ï¼Œ4æœ€åè¦è¢«è¸¢æ‰ï¼Œå®é™…æ˜¯0-3ï¼Œå…±4ä¸ªå­—ç¬¦ï¼š\n1string=\u0026#34;Bash is great!\u0026#34; 2 3echo ${string:8} # great! 4echo ${string:0:4} # Bash 5echo ${string:8:-1} # great (-1: upto 1st element from right) æ•°ç»„çš„é•¿åº¦ï¼š\n1string=\u0026#34;Bash is great!\u0026#34;; 2len=${#string} 3echo \u0026#34;len = $len\u0026#34; å­—ç¬¦ä¸²çš„æ›¿æ¢ï¼š\n1string=\u0026#34;Bash is great!!\u0026#34; 2echo ${string/Bash/GNU Bash} # GNU Bash is great!! 3echo ${string//!/.} # Bash is great.. å¤§å°å†™æ›¿æ¢:\n1string=\u0026#34;Bash\u0026#34; 2echo ${string^^} # BASH 3echo ${string,,} # bash æŒ‰indexå­˜å–æ•°ç»„ä¸­å­—ç¬¦åœ¨shellä¸­ä¸å¯ç”¨ï¼Œä½†æ˜¯å¯ä»¥ç”¨functionå˜ç›¸å®ç°ï¼š\n1function charAt() { 2 string=$1 3 i=$2 4 echo ${string:i:1} 5} 6echo $(charAt \u0026#34;Hello\u0026#34; 2) # l 7echo $(charAt \u0026#34;Hello\u0026#34; 1) # e äºŒã€æ•°ç»„å’Œå­—å…¸ å®šä¹‰ä¸€ä¸ªæ•°ç»„å¹¶ä¸”éå†å®ƒï¼š\n1A=(2 4 5 6 4) 2for i in ${A[@]}; do 3 echo -n \u0026#34;${i} \u0026#34; # 2 4 5 6 4 4done åŒæ ·å¯¹æ•°ç»„è¿›è¡Œåˆ‡å‰²ï¼š\n1A=(2 4 5 6 4) 2echo ${A[@]:2:3} # 5 6 4 3echo ${A[@]:0:1} # 2 Bash ä¸­çš„æ•°ç»„éœ€è¦ä½¿ç”¨ [@] ç¬¦å·æ¥å¼•ç”¨æ•´ä¸ªæ•°ç»„ï¼Œå¯ä»¥ç”¨ç®€æ´çš„è¯­æ³•å¯¹æ•°ç»„å¢åŠ å…ƒç´ \n1A=(1 2 3) 2A+=(4) 3echo ${A[@]} # 1 2 3 4 4A+=(5 6) 5echo ${A[@]} # 1 2 3 4 5 6 å­—å…¸ä¹Ÿä¸€æ ·\n1declare -A D 2D=([\u0026#34;one\u0026#34;]=1 [\u0026#34;two\u0026#34;]=2 [\u0026#34;three\u0026#34;]=3) 3for i in ${!D[@]}; do 4 echo \u0026#34;$i -\u0026gt; ${D[$i]}\u0026#34; # one -\u0026gt; 1 .... 5done ä¸‰ã€æ•°å­¦è®¡ç®— ç®€å•çš„æ•°å­¦è®¡ç®—å¯ä»¥ç”¨ $((...)) æ¥å®Œæˆï¼š\n1a=10 2b=5 3 4echo \u0026#34;$a + $b = $((a + b))\u0026#34; # 10 + 5 = 15 5echo \u0026#34;$a - $b = $((a - b))\u0026#34; # 10 - 5 = 5 6echo \u0026#34;$a x $b = $((a * b))\u0026#34; # 10 x 5 = 50 7echo \u0026#34;$a / $b = $((a / b))\u0026#34; # 10 / 5 = 2 8echo \u0026#34;$a % $b = $((a % b))\u0026#34; # 10 % 5 = 0 æˆ–è€…å€ŸåŠ©å¤æ‚ä¸€ç‚¹çš„ bc æ¥å®Œæˆï¼š\n1a=10 2b=5.7 3 4echo \u0026#34;$a / $b = $(echo \u0026#34;scale = 2; $a / $b\u0026#34; | bc)\u0026#34; # 10 / 5.7 = 1.75 éšæœºæ•°çš„äº§ç”Ÿï¼š\n1echo $(($RANDOM % 10)) # Random number between 0 and 10 å››ã€è¾“å…¥ æ§åˆ¶è¾“å…¥å˜é‡ï¼š\n1read -p \u0026#34;Enter your name: \u0026#34; name 2echo \u0026#34;Hello, $name\u0026#34; å¦‚æœè¦è¾“å…¥æ•°ç»„ï¼š\n1read -p \u0026#34;Enter numbers: \u0026#34; -a A 2echo ${A[@]} å€ŸåŠ©ä¸Šé¢çš„æŠ€å·§ï¼Œæˆ‘ä»¬å¯ä»¥å†™å‡ºä¸€äº›å¤æ‚çš„ shell è„šæœ¬äº†\n","date":"2022-06-09","img":"","permalink":"https://bajie.dev/posts/20220609-shell_tips/","series":null,"tags":null,"title":"Shellè¿›é˜¶æŠ€å·§"},{"categories":null,"content":"ä¸€ã€åŸºæœ¬æ¦‚å¿µ\n1. å¼‚æ­¥\næ‰€è°“ \u0026quot; å¼‚æ­¥ \u0026ldquo;ï¼Œç®€å•è¯´å°±æ˜¯ä¸€ä¸ªä»»åŠ¡åˆ†æˆä¸¤æ®µï¼Œ å…ˆæ‰§è¡Œç¬¬ä¸€æ®µï¼Œ ç„¶åè½¬è€Œæ‰§è¡Œå…¶ä»–ä»»åŠ¡å»ï¼Œ ç­‰åšå¥½äº†å‡†å¤‡ï¼Œ å†å›è¿‡å¤´æ‰§è¡Œç¬¬äºŒæ®µã€‚\næ¯”å¦‚ï¼Œ æœ‰ä¸€ä¸ªä»»åŠ¡æ˜¯è¯»å–æ–‡ä»¶è¿›è¡Œå¤„ç†ï¼Œ ä»»åŠ¡çš„ç¬¬ä¸€æ®µæ˜¯å‘æ“ä½œç³»ç»Ÿå‘å‡ºè¯·æ±‚ï¼Œ è¦æ±‚è¯»å–æ–‡ä»¶ã€‚ ç„¶åï¼Œ ç¨‹åºæ‰§è¡Œå…¶ä»–ä»»åŠ¡ï¼Œ ç­‰åˆ°æ“ä½œç³»ç»Ÿè¿”å›æ–‡ä»¶ï¼Œå†æ¥ç€æ‰§è¡Œä»»åŠ¡çš„ç¬¬äºŒæ®µï¼ˆ å¤„ç†æ–‡ä»¶ï¼‰ã€‚ è¿™ç§ä¸è¿ç»­çš„æ‰§è¡Œï¼Œ å°±å«åšå¼‚æ­¥ã€‚\nç›¸åº”åœ°ï¼Œ è¿ç»­çš„æ‰§è¡Œå°±å«åšåŒæ­¥ã€‚ ç”±äºæ˜¯è¿ç»­æ‰§è¡Œï¼Œ ä¸èƒ½æ’å…¥å…¶ä»–ä»»åŠ¡ï¼Œ æ‰€ä»¥æ“ä½œç³»ç»Ÿä»ç¡¬ç›˜è¯»å–æ–‡ä»¶çš„è¿™æ®µæ—¶é—´ï¼Œ ç¨‹åºåªèƒ½å¹²ç­‰ç€ä»€ä¹ˆä¹Ÿåšä¸äº†ã€‚\n2. å›è°ƒå‡½æ•°\njavascript è¯­è¨€å¯¹å¼‚æ­¥ç¼–ç¨‹çš„å®ç°ï¼Œ å°±æ˜¯å›è°ƒå‡½æ•°ã€‚ æ‰€è°“å›è°ƒå‡½æ•°ï¼Œ å°±æ˜¯æŠŠä»»åŠ¡çš„ç¬¬äºŒæ®µå•ç‹¬å†™åœ¨ä¸€ä¸ªå‡½æ•°é‡Œé¢ï¼Œ ç­‰åˆ°å‡†å¤‡å¥½äº†ï¼Œç»§ç»­æ‰§è¡Œçš„æ—¶å€™ï¼Œ å°±ç›´æ¥è°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚ å®ƒçš„è‹±è¯­åå­— callbackï¼Œ ç›´è¯‘è¿‡æ¥å°±æ˜¯ \u0026quot; å›è°ƒ \u0026ldquo;ã€‚\nè¯»å–æ–‡ä»¶è¿›è¡Œå¤„ç†ï¼Œ æ˜¯è¿™æ ·çš„ï¼Œreadfile æ˜¯å¼‚æ­¥çš„ï¼ŒreadfileSync æ˜¯åŒæ­¥çš„ã€‚\n1fs.readfile(\u0026#39;/etc/passwd\u0026#39;, function(err, data) { 2 if(err) throw err; 3 console.log(data); 4}); ä¸Šé¢ä»£ç ä¸­ï¼Œ readfile å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œ å°±æ˜¯å›è°ƒå‡½æ•°ï¼Œ ä¹Ÿå°±æ˜¯ä»»åŠ¡çš„ç¬¬äºŒæ®µã€‚ ç­‰åˆ°æ“ä½œç³»ç»Ÿè¿”å›äº† / etc / passwdè¿™ä¸ªæ–‡ä»¶ä»¥åï¼Œ å›è°ƒå‡½æ•°æ‰ä¼šæ‰§è¡Œã€‚\n==ä¸€ä¸ªæœ‰è¶£çš„é—®é¢˜æ˜¯ï¼Œ ä¸ºä»€ä¹ˆ node.js çº¦å®šï¼Œ å›è°ƒå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œ å¿…é¡»æ˜¯é”™è¯¯å¯¹è±¡ errï¼ˆ å¦‚æœæ²¡æœ‰é”™è¯¯ï¼Œ è¯¥å‚æ•°å°±æ˜¯ nullï¼‰ï¼Ÿ åŸå› æ˜¯æ‰§è¡Œåˆ†æˆä¸¤æ®µï¼Œ åœ¨è¿™ä¸¤æ®µä¹‹é—´æŠ›å‡ºçš„é”™è¯¯ï¼Œ ç¨‹åºæ— æ³•æ•æ‰ï¼Œ åªèƒ½å½“ä½œå‚æ•°ï¼Œ ä¼ å…¥ç¬¬äºŒæ®µã€‚==\n3. promise\nâ€œæƒ³åƒä¸€ä¸‹ä½ æ˜¯ä¸ªå°å­©ï¼Œä½ å¦ˆå¦ˆ promise æ‰¿è¯ºä½ ä¸‹æ˜ŸæœŸç»™ä½ ä¸€éƒ¨æ–°æ‰‹æœºâ€\nåªæœ‰ä¸‹å‘¨æ¥ä¸´çš„æ—¶å€™ï¼Œä½ æ‰ä¼šçŸ¥é“ä½ çœŸçš„å¾—åˆ°ä¸€éƒ¨æ‰‹æœºï¼Œæˆ–è€…æ˜¯éª—ä½ ç©çš„ã€‚\nè¿™å°±æ˜¯ promise. ä¸€ä¸ª promise æœ‰ä¸‰ç§çŠ¶æ€ï¼š\n Pending: å¾…å®šï¼Œä½ ä¸çŸ¥é“ä½ æ˜¯å¦èƒ½å¾—åˆ°ä¸€éƒ¨æ‰‹æœº Resolved: å¦ˆå¦ˆå¾ˆé«˜å…´ï¼Œä½ å¾—åˆ°ä¸€éƒ¨æ‰‹æœº Rejected: å¦ˆå¦ˆä¸é«˜å…´ï¼Œä½ æ²¡æœ‰å¾—åˆ°ä¸€éƒ¨æ‰‹æœº  çŠ¶æ€å›¾å¦‚ä¸‹ï¼š\nè¯­æ³•å¾ˆç®€å•ï¼š\n1// promise syntax look like this 2new Promise(function (resolve, reject) { ... } ); 3 å†çœ‹ä¸€ä¸‹ä¸Šé¢é—®é¢˜çš„è§£å†³æ–¹æ³•ï¼š\né¦–å…ˆç¡®å®š Mom çš„çŠ¶æ€æ˜¯ unhappyï¼Œç„¶åå»ºç«‹ä¸€ä¸ª Promise æ¥ç¡®å®šæ˜¯å¦å¾—åˆ°æ‰‹æœºï¼Œæœ€åç”¨ä¸€ä¸ªå‡½æ•° askMom æ¥è°ƒç”¨è¿™ä¸ª Promise\nresolve() ä¸­å¯ä»¥æ”¾ç½®ä¸€ä¸ªå‚æ•°ç”¨äºå‘ä¸‹ä¸€ä¸ª then ä¼ é€’ä¸€ä¸ªå€¼ï¼Œthen ä¸­çš„å‡½æ•°ä¹Ÿå¯ä»¥è¿”å›ä¸€ä¸ªå€¼ä¼ é€’ç»™ thenã€‚ä½†æ˜¯ï¼Œå¦‚æœ then ä¸­è¿”å›çš„æ˜¯ä¸€ä¸ª Promise å¯¹è±¡ï¼Œé‚£ä¹ˆä¸‹ä¸€ä¸ª then å°†ç›¸å½“äºå¯¹è¿™ä¸ªè¿”å›çš„ Promise è¿›è¡Œæ“ä½œã€‚\nreject() å‚æ•°ä¸­ä¸€èˆ¬ä¼šä¼ é€’ä¸€ä¸ªå¼‚å¸¸ç»™ä¹‹åçš„ catch å‡½æ•°ç”¨äºå¤„ç†å¼‚å¸¸ã€‚\nä½†æ˜¯è¯·æ³¨æ„ä»¥ä¸‹ä¸¤ç‚¹ï¼š\n resolve å’Œ reject çš„ä½œç”¨åŸŸåªæœ‰èµ·å§‹å‡½æ•°ï¼Œä¸åŒ…æ‹¬ then ä»¥åŠå…¶ä»–åºåˆ—ï¼› resolve å’Œ reject å¹¶ä¸èƒ½å¤Ÿä½¿èµ·å§‹å‡½æ•°åœæ­¢è¿è¡Œï¼Œåˆ«å¿˜äº† returnã€‚  1var isMomHappy = false; 2 3// Promise 4var willIGetNewPhone = new Promise( 5 function (resolve, reject) { 6 if (isMomHappy) { 7 var phone = { 8 brand: \u0026#39;Samsung\u0026#39;, 9 color: \u0026#39;black\u0026#39; 10 }; 11 resolve(phone); // resolved 12 } else { 13 var reason = new Error(\u0026#39;mom is not happy\u0026#39;); 14 reject(reason); // rejected 15 } 16 17 } 18); 19 20var askMom = function () { 21 willIGetNewPhone 22 .then(function (fulfilled) { 23 // yay, you got a new phone 24 console.log(fulfilled); 25 // output: { brand: \u0026#39;Samsung\u0026#39;, color: \u0026#39;black\u0026#39; } 26 }) 27 .catch(function (error) { 28 // oops, mom didn\u0026#39;t buy it 29 console.log(error.message); 30 // output: \u0026#39;mom is not happy\u0026#39; 31 }); 32}; 33 34askMom(); å¾ˆæœ‰ç‚¹æ„æ€å§ã€‚æŠ½è±¡äº†ï¼Œé‚£å°±å®é™…ç‚¹ã€‚\njavascripts ä¸­çš„ fetch å‡½æ•°å°±æ˜¯åŸºäºPromiseèŒƒå¼çš„ï¼Œpromise çš„ resolves ç»‘åœ¨äº† Response ä¸Šã€‚Promise ç±»æœ‰ .then() .catch() å’Œ .finally() ä¸‰ä¸ªæ–¹æ³•ï¼Œè¿™ä¸‰ä¸ªæ–¹æ³•çš„å‚æ•°éƒ½æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œ.then() å¯ä»¥å°†å‚æ•°ä¸­çš„å‡½æ•°æ·»åŠ åˆ°å½“å‰ Promise çš„æ­£å¸¸æ‰§è¡Œåºåˆ—ï¼Œ.catch() åˆ™æ˜¯è®¾å®š Promise çš„å¼‚å¸¸å¤„ç†åºåˆ—ï¼Œ.finally() æ˜¯åœ¨ Promise æ‰§è¡Œçš„æœ€åä¸€å®šä¼šæ‰§è¡Œçš„åºåˆ—ã€‚ .then() ä¼ å…¥çš„å‡½æ•°ä¼šæŒ‰é¡ºåºä¾æ¬¡æ‰§è¡Œï¼Œæœ‰ä»»ä½•å¼‚å¸¸éƒ½ä¼šç›´æ¥è·³åˆ° catch åºåˆ—ï¼š\n1 fetch(\u0026#34;http://192.168.1.6/graph_image_hubot.php?action=view\u0026amp;local_graph_id=13619\u0026amp;rra_id=5\u0026#34;) 2 .then(response =\u0026gt; { 3 if (response.ok) { 4 return response.buffer(); 5 } 6 throw new Error(\u0026#39;Network response was not ok.\u0026#39;); 7 }) 8 .then(buffer =\u0026gt; { 9 const formData = new FormData(); 10 formData.append( \u0026#39;media\u0026#39;, buffer, {filename: \u0026#39;bandwidth.png\u0026#39;, contentType: \u0026#39;image/png\u0026#39; } ); 11 robot.wwork.sendImageMessage(owner, formData); 12 }); 13 ä¸Šé¢çš„ç¨‹åºå®é™…ä¸Šæ˜¯ä» cacti æœåŠ¡å™¨æ‹¿åˆ°ä¸€å¼ æµé‡å›¾ç‰‡ï¼Œç„¶å fetch çš„ç»“æœ anywayï¼Œresponseæ€»æ˜¯æœ‰ä¸œè¥¿çš„ï¼Œéƒ½ä¼šæ˜¯æˆåŠŸçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»å†ç”¨ response.ok æ¥åˆ¤æ–­ï¼ŒæˆåŠŸå°±ç»§ç»­å¾—åˆ° buffer æµï¼Œæœ€ç»ˆé€åˆ° hubot ä¸­å»ã€‚ä¸‰ä¸ªè¿‡ç¨‹ç”¨ then ä¸²äº†èµ·æ¥ï¼Œæ¯ä¸€æ­¥éƒ½æˆåŠŸæ‰ä¼šè¿›è¡Œä¸‹ä¸€æ­¥ã€‚\nè¿™æ ·å†™é¿å…äº†å›è°ƒåœ°ç‹±ï¼Œçœ‹èµ·æ¥ä¹Ÿæ¯”è¾ƒèˆ’æœã€‚\né‚£ä»€ä¹ˆæ—¶å€™ç”¨ promise å‘¢ï¼Œå®ƒæ˜¯å¼‚æ­¥çš„ï¼Œæœ‰å¤§IOè¯»å†™ç¡¬ç›˜ã€è¯»å†™ç½‘ç»œçš„æ—¶å€™ç”¨ï¼Œä¸Šé¢æ˜¯è¯»å†™ç½‘ç»œã€‚ä¸‹é¢å†æ¥ä¸€ä¸ªè¯»å†™ç£ç›˜çš„ï¼š\n1const {promise: {readFile, writeFile}} = require(\u0026#39;fs\u0026#39;); 2(async () =\u0026gt; { 3 let content = await readFile(\u0026#39;./data.txt\u0026#39;, \u0026#39;utf8\u0026#39;); 4 await writeFile(\u0026#39;2.txt\u0026#39;, content, \u0026#39;utf8\u0026#39;); 5 console.log(\u0026#39;ok\u0026#39;); 6})(); ä¸Šé¢çš„è¯­æ³•æ˜¯ ES7 çš„ï¼Œå®ƒæ›´å°½äº†ä¸€æ­¥ï¼Œé¦–å…ˆå£°æ˜ä¸€ä¸ªåŒ¿åçš„å‡½æ•°æ˜¯ async å¼‚æ­¥çš„ï¼Œç„¶åç”¨awaitæ¥è¿›è¡Œç­‰å¾…ï¼Œå°†è¯»å’Œå†™ä¸¤ä¸ªå¤§æ“ä½œéƒ½æ”¾åˆ° await çš„ä¸€æ­¥æ“ä½œä¸­å»ï¼Œè¿™æ ·ç¨‹åºçœ‹èµ·æ¥å°±å˜æˆåŒæ­¥çš„ä¸€æ­¥æ­¥ç­‰å¾…äº†ã€‚è·Ÿ ES6 çš„ promise æ¯”èµ·æ¥ï¼Œæ›´è¿›äº†ä¸€æ­¥ã€‚\n","date":"2022-05-24","img":"","permalink":"https://bajie.dev/posts/20220524-javascripts_promise/","series":null,"tags":null,"title":"Javascriptsä¸­çš„promise"},{"categories":null,"content":"Javascripts ä¸­çš„ map\nè¯´åˆ°mapï¼Œå¦‚æœæˆ‘ä»¬æœ‰å¾ªç¯çš„è¯ï¼Œä¸åœéå†ï¼Œä¼šæŠŠæ—¶é—´ææˆ O(n)ã€‚å¦‚æœæœ‰mapï¼Œæ—¶é—´å°±å˜æˆäº†O(1)ï¼Œæ‰€ä»¥è¿˜æ˜¯ç›¸å½“æœ‰æ•ˆç‡çš„ã€‚\nmap æ˜¯ ES2015 ä¸­æ–°å¢åŠ çš„ï¼Œæ˜¯ä¸€ç§æ–°çš„ Object ç±»å‹ï¼Œå…è®¸å­˜æ”¾å„ç§ key-value å¯¹ã€‚\nmap æœ€å¤§çš„ç‰¹æ€§æ˜¯ï¼Œkey å¯ä»¥æ˜¯ä»»ä½•ç±»å‹ï¼ŒåŒ…æ‹¬ object å’Œ functionï¼›å¯ä»¥è°ƒç”¨ size å¾—åˆ° map çš„å¤§å°ï¼›è¿­ä»£çš„æ—¶å€™ï¼Œæ˜¯ä¸¥æ ¼æŒ‰ç…§æ·»åŠ çš„é¡ºåºè¿›è¡Œè¿­ä»£çš„ã€‚\nmap çš„æ–¹æ³•å¦‚ä¸‹ï¼š set, get, size, has, delete, clear:\n1let things = new Map(); 2 3const myFunc = () =\u0026gt; \u0026#39;ğŸ•\u0026#39;; 4 5things.set(\u0026#39;ğŸš—\u0026#39;, \u0026#39;Car\u0026#39;); 6things.set(\u0026#39;ğŸ \u0026#39;, \u0026#39;House\u0026#39;); 7things.set(\u0026#39;âœˆï¸\u0026#39;, \u0026#39;Airplane\u0026#39;); 8things.set(myFunc, \u0026#39;ğŸ˜„ Key is a function!\u0026#39;); 9 10things.size; // 4 11 12things.has(\u0026#39;ğŸš—\u0026#39;); // true 13 14things.has(myFunc) // true 15things.has(() =\u0026gt; \u0026#39;ğŸ•\u0026#39;); // false, not the same reference 16things.get(myFunc); // \u0026#39;ğŸ˜„ Key is a function!\u0026#39; 17 18things.delete(\u0026#39;âœˆï¸\u0026#39;); 19things.has(\u0026#39;âœˆï¸\u0026#39;); // false 20 21things.clear(); 22things.size; // 0 23 24// setting key-value pairs is chainable 25things.set(\u0026#39;ğŸ”§\u0026#39;, \u0026#39;Wrench\u0026#39;) 26 .set(\u0026#39;ğŸ¸\u0026#39;, \u0026#39;Guitar\u0026#39;) 27 .set(\u0026#39;ğŸ•¹\u0026#39;, \u0026#39;Joystick\u0026#39;); 28 29const myMap = new Map(); 30 31// Even another map can be a key 32things.set(myMap, \u0026#39;Oh gosh!\u0026#39;); 33things.size; // 4 34things.get(myMap); // \u0026#39;Oh gosh!\u0026#39; è¿­ä»£å®ƒçš„æ–¹æ³•ï¼Œå¯ä»¥ç”¨ for \u0026hellip; ofï¼Œé¡ºåºæ˜¯ä¸¥æ ¼æŒ‰ç…§ä½ æ’å…¥çš„é¡ºåºæ¥çš„ï¼š\n1let activities = new Map(); 2 3activities.set(1, \u0026#39;ğŸ‚\u0026#39;); 4activities.set(2, \u0026#39;ğŸ\u0026#39;); 5activities.set(3, \u0026#39;ğŸš£\u0026#39;); 6activities.set(4, \u0026#39;ğŸ¤¾\u0026#39;); 7 8for (let [nb, activity] of activities) { 9 console.log(`Activity ${nb} is ${activity}`); 10} 11 12// Activity 1 is ğŸ‚ 13// Activity 2 is ğŸ 14// Activity 3 is ğŸš£ 15// Activity 4 is ğŸ¤¾ 16 ä¹Ÿå¯ä»¥ç”¨ forEach æ¥è¿­ä»£ï¼Œæ³¨æ„ä¸€ç‚¹å³å¯ï¼ŒforEach çš„ callback å‡½æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ valueï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ keyï¼Œè·Ÿ for \u0026hellip; of æ˜¯ç›¸åçš„ï¼š\n1activities.forEach((value, key) =\u0026gt; { 2 console.log(`Activity ${key} is ${value}`); 3}); ","date":"2022-05-23","img":"","permalink":"https://bajie.dev/posts/20220523-javascripts_map/","series":null,"tags":null,"title":"Javascriptsä¸­çš„map"},{"categories":null,"content":"åƒé‡Œä¹‹è¡Œå§‹äºè¶³ä¸‹ï¼Œjavascript æ¨¡å—æ¼«å¤©é£ï¼Œèƒ½åšçš„äº‹ä¹Ÿæ˜¯äº”èŠ±å…«é—¨ã€‚æˆ‘ä»¬æ¥å®è·µä¸€ä¸‹\nå‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š\né‡Œé¢æ˜¯ä¸€è¡Œè¡Œæ•°æ®ï¼Œæˆ‘ä»¬è¦åšçš„å°±æ˜¯æŠŠæ‰€æœ‰å€¼å–æ•´æ±‚å’Œï¼Œæ–‡ä»¶ä¸­æœ‰æŸäº›ç©ºè¡Œ\nå¾ˆç®€å•ï¼Œç¨‹åºå¦‚ä¸‹ï¼š\n1var fs = require(\u0026#39;fs\u0026#39;); 2 3calculate = () =\u0026gt; { 4 fs.readFile(\u0026#39;data.txt\u0026#39;, \u0026#39;utf8\u0026#39;, (err, data) =\u0026gt; { 5 if (err) { 6 throw new Error(err) 7 } 8 9 const arr = data.split(\u0026#39;\\r\\n\u0026#39;); 10 const result = arr 11 .filter(e =\u0026gt; e) 12 .map(parseFloat) 13 .reduce((curr, next) =\u0026gt; curr + next); 14 console.log(\u0026#39;RESULT: \u0026#39;, result); 15 }); 16} è¶…çº§ç®€å•å§\nå…³é”®å°±æ˜¯ä¸Šé¢çš„é“¾å¼è°ƒç”¨\n split ç”¨æ¥åˆ†å‰²æ¯ä¸€è¡Œ filter ç”¨æ¥å»æ‰ç©ºè¡Œ map ç”¨æ¥æŠŠæ¯ä¸€è¡Œéƒ½è½¬åŒ–æˆæ•´æ•° reduce ç”¨æ¥æ±‚å’Œ  ","date":"2022-05-22","img":"","permalink":"https://bajie.dev/posts/20220522-javascirpts_fs/","series":null,"tags":null,"title":"Javascriptçš„å®é™…åº”ç”¨-Fsæ¨¡å—"},{"categories":null,"content":"JavaScript Module æ˜¯ä»€ä¹ˆ ä¸€ä¸ª JavaScript module æ¨¡å—å‡†ç¡®çš„è¯´å°±æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œå®ƒå…è®¸ä½ æŠŠä»£ç  export å¯¼å‡ºæ¥å¤ç”¨ï¼Œè¿™æ ·åˆ«çš„ JavaScript æ–‡ä»¶å¯ä»¥ import è¿™ä¸ªæ–‡ä»¶æŠŠå®ƒä½œä¸ºåº“æ–‡ä»¶æ¥ä½¿ç”¨äº†ã€‚\næ¨¡å—ä¸»è¦æ˜¯ç”¨åœ¨å·¥ç¨‹æ–‡ä»¶ä¸­ï¼Œç”¨æ¥æŠŠä»£ç å…±äº«ç»™å…¶ä»–æ–‡ä»¶ç”¨ï¼Œjavascipt çš„æ¨¡å—å¯ä»¥è¯´æ˜¯æ»¡å¤©é£ã€‚\nè¿™é‡Œå‘¢è®¨è®ºçš„æ˜¯å‰ç«¯çš„éƒ¨åˆ†ï¼Œå³æ˜¯è¿è¡Œåœ¨æµè§ˆå™¨ä¸­çš„ javascripts module éƒ¨åˆ†ï¼Œè€Œä¸æ˜¯è¿è¡Œåœ¨åç«¯çš„ Node.js çš„éƒ¨åˆ†ï¼Œåç«¯ç°åœ¨å·²ç»å‘å‰ç«¯é æ‹¢äº†ã€‚\nES6æ ‡å‡†å‘å¸ƒåï¼Œmoduleæˆä¸ºæ ‡å‡†ï¼Œæ ‡å‡†ä½¿ç”¨æ˜¯ä»¥exportæŒ‡ä»¤å¯¼å‡ºæ¥å£ï¼Œä»¥importå¼•å…¥æ¨¡å—ï¼Œä½†æ˜¯åœ¨æˆ‘ä»¬ä¸€è´¯çš„nodeæ¨¡å—ä¸­ï¼Œæˆ‘ä»¬ä¾ç„¶é‡‡ç”¨çš„æ˜¯CommonJSè§„èŒƒï¼Œä½¿ç”¨requireå¼•å…¥æ¨¡å—ï¼Œä½¿ç”¨module.exportså¯¼å‡ºæ¥å£ã€‚è¿™ç‚¹ä¹Ÿç†è§£æ¸…æ¥šã€‚\næˆ‘ä»¬ä»é›¶æ¥ä¸€æ­¥æ­¥å¼€å§‹å§\nå¦‚ä½•æŠŠä¸€ä¸ª JavaScript æ–‡ä»¶è½¬æ¢ä¸º ES çš„ module 1: åˆ›å»ºä¸€ä¸ª project ç›®å½• è¿™ä¸ªç›®å½•ç”¨æ¥æ”¾ HTML å’Œ JavaScript æ–‡ä»¶\n2: å»ºç«‹ä½ çš„ code ä»£ç æ–‡ä»¶ åœ¨ project æ–‡ä»¶å¤¹ä¸­å»ºç«‹2ä¸ªæ–‡ä»¶:\n index.html index.js  3: æ·»åŠ  JavaScript æ–‡ä»¶çš„å¼•ç”¨åˆ° HTML æ–‡ä»¶ä¸­ æ‰“å¼€index.html ç¼–è¾‘å®ƒï¼š\n1\u0026lt;!DOCTYPE html\u0026gt; 2\u0026lt;html\u0026gt; 3 \u0026lt;head\u0026gt; 4 \u0026lt;meta charset=\u0026#34;UTF-8\u0026#34;\u0026gt; 5 \u0026lt;meta name=\u0026#34;viewport\u0026#34; content=\u0026#34;width=device-width, initial-scale=1.0\u0026#34;\u0026gt; 6 \u0026lt;title\u0026gt;ES Module - zhang ranrui\u0026lt;/title\u0026gt; 7 \u0026lt;/head\u0026gt; 8 \u0026lt;body\u0026gt; 9 \u0026lt;h1\u0026gt;ES Module Tutorial\u0026lt;/h1\u0026gt; 10 11 \u0026lt;!-- Add the \u0026#34;index.js\u0026#34; JavaScript file to this HTML document --\u0026gt; 12 \u0026lt;script type=\u0026#34;module\u0026#34; src=\u0026#34;index.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; 13 \u0026lt;/body\u0026gt; 14\u0026lt;/html\u0026gt; ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å¼•ç”¨äº† index.js , å¹¶å®šä¹‰å®ƒ type=\u0026ldquo;module\u0026rdquo;ï¼Œè¿™æ˜¾å¼æŒ‡æ˜äº† index.js æ˜¯ä¸€ä¸ª ES çš„moduleã€‚\né‚£ä¹ˆï¼Œå¦‚æœæœ‰äº†ä¸€ä¸ª ES çš„ moduleï¼Œå¦‚ä½•ä½¿ç”¨å®ƒå‘¢ï¼Œä¹Ÿä¸¾ä¸ªä¾‹å­ï¼š\nå¦‚ä½•ä½¿ç”¨ä¸€ä¸ª ES çš„ Module 1: å»ºç«‹ä¸€ä¸ª project ç›®å½• åŒæ ·æ˜¯æ”¾ html å’Œ module æ–‡ä»¶çš„ã€‚\n2: å»ºç«‹ code æ–‡ä»¶ åœ¨ project æ–‡ä»¶å¤¹ä¸‹å»ºç«‹å¦‚ä¸‹æ–‡ä»¶:\n index.html module-1.js module-2.js  3: å¢åŠ  modules æ–‡ä»¶çš„å¼•ç”¨åˆ° HTML æ–‡ä»¶ ç¼–è¾‘ index.html æ–‡ä»¶ï¼Œå¢åŠ å¯¹ module çš„å¼•ç”¨:\n1\u0026lt;!DOCTYPE html\u0026gt; 2\u0026lt;html\u0026gt; 3 \u0026lt;head\u0026gt; 4 \u0026lt;meta charset=\u0026#34;UTF-8\u0026#34;\u0026gt; 5 \u0026lt;meta name=\u0026#34;viewport\u0026#34; content=\u0026#34;width=device-width, initial-scale=1.0\u0026#34;\u0026gt; 6 \u0026lt;title\u0026gt;ES Module - zhang ranrui\u0026lt;/title\u0026gt; 7 \u0026lt;/head\u0026gt; 8 \u0026lt;body\u0026gt; 9 \u0026lt;h1\u0026gt;ES Module Tutorial\u0026lt;/h1\u0026gt; 10 \u0026lt;h2\u0026gt;Check the console\u0026lt;/h2\u0026gt; 11 12 \u0026lt;script type=\u0026#34;module\u0026#34; src=\u0026#34;module-1.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; 13 \u0026lt;script type=\u0026#34;module\u0026#34; src=\u0026#34;module-2.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; 14 \u0026lt;/body\u0026gt; 15\u0026lt;/html\u0026gt; 4: æµè§ˆä½ çš„ index.html æ³¨æ„ï¼Œè¿™é‡Œåªèƒ½åœ¨ localhost çš„æœåŠ¡å™¨ä¸Šæµè§ˆï¼Œç›´æ¥æµè§ˆæœ¬åœ°æ–‡ä»¶ä¼šæŠ¥ cors çš„é”™ã€‚\næ€ä¹ˆ Export å¯¼å‡ºä¸€ä¸ª Module ä¸­çš„ä»£ç  æœ‰ä¸¤ç§ä½¿ç”¨æ–¹æ³•\n åœ¨ä»£ç å‰ä½¿ç”¨ export å…³é”®å­— ä½¿ç”¨ export å£°æ˜è¯­å¥  ä¸€ã€åœ¨ä»£ç å‰ä½¿ç”¨ export å…³é”®å­— æ³¨æ„ï¼šæ˜¯åœ¨æ­£å¼ä»£ç ä¹‹å‰\n1// module-1.js 2 3// Export the \u0026#34;bestClub\u0026#34; variable: 4export const bestClub = \u0026#34;Your Club\u0026#34;; å¦å¤–ä¸€ä¸ªä¾‹å­ï¼š\n1// Export the \u0026#34;multiply\u0026#34; function: 2export function multiply(x, y) { 3 return x * y; 4} äºŒã€ä½¿ç”¨ export å£°æ˜è¯­å¥ å¦ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨ export å£°æ˜è¯­å¥ï¼Œè¿™ç§æ–¹å¼ç”¨ {} åŒ…è£¹ è¦å¯¼å‡ºçš„å˜é‡ï¼Œä¸­é—´çš„å˜é‡åç”¨é€—å·æ¥éš”å¼€ã€‚\n1// Create a variable named \u0026#34;bestClub\u0026#34;: 2const bestClub = \u0026#34;Your Club\u0026#34;; 3 4// Create a function named \u0026#34;multiply\u0026#34;: 5function multiply(x, y) { 6 return x * y; 7} 8 9// Create an array named \u0026#34;fruits\u0026#34;: 10const fruits = [\u0026#34;Mango\u0026#34;, \u0026#34;Apple\u0026#34;, \u0026#34;Orange\u0026#34;, \u0026#34;Lemon\u0026#34;]; 11 12// Export the three statements above: 13export { bestClub, multiply, fruits }; å¯¼å‡ºæœ‰äº†ï¼Œæ€æ ·å¯¼å…¥åˆ«çš„æ¨¡å— Exported çš„ä»£ç å‘¢ï¼Ÿ æ¥ä¸Šçš„ä¾‹å­ï¼Œåªå¯¼å…¥ä¸€ä¸ªå˜é‡ï¼š\n1// module-2.js 2 3import { bestClub } from \u0026#34;./module-1.js\u0026#34;; å¯¼å…¥æ‰€æœ‰å˜é‡\n1// Import three items from the module-1.js file: 2import { bestClub, multiply, fruits } from \u0026#34;./module-1.js\u0026#34;; æ³¨æ„./æ˜¯è¡¨ç¤ºå½“å‰è·¯å¾„ï¼Œå¦‚æœè·¯å¾„ä¸å¯¹ï¼Œæœ‰å¯èƒ½éœ€è¦å…¨è·¯å¾„å¯¼å…¥\n1// Import three items from the module-1.js file: 2import { bestClub, multiply, fruits } from \u0026#34;/codesweetly/blog/notes/modular-javascript/es-modules/module-1.js\u0026#34;; æ³¨æ„åœ¨åç«¯ Node.js å’Œ module bundlers ä¸­ï¼Œæ˜¯å…è®¸ä½ ä¸å†™æ–‡ä»¶ååç¼€çš„ï¼Œæ¯”å¦‚ä¸‹é¢\n1// Import three items from the module-1.js file: 2import { bestClub, multiply, fruits } from \u0026#34;module-1\u0026#34;; ä½†æ˜¯ï¼Œåœ¨ ES modules ä¸­ï¼Œä¸å…è®¸çœç•¥æ–‡ä»¶åç¼€ã€‚\nå¦‚ä½•ä½¿ç”¨ä»åˆ«çš„æ¨¡å— Imported å¯¼å…¥çš„ä»£ç  1// module-2.js 2 3import { bestClub } from \u0026#34;./module-1.js\u0026#34;; 4 5const myBestClub = bestClub + \u0026#34; \u0026#34; + \u0026#34;is my best club.\u0026#34;; 6 7console.log(myBestClub); æ³¨æ„:\n import å…³é”®å­—åªèƒ½å‡ºç°åœ¨ modules æ–‡ä»¶ä¸­ï¼Œä¸èƒ½å‡ºç°åœ¨é€šå¸¸çš„ JavaScript ç¨‹åºæ–‡ä»¶ä¸­ã€‚ ä¸€ä¸ªè¢« imported å¯¼å…¥çš„æ¨¡å—åªèƒ½ä½œç”¨äºæœ¬æ–‡ä»¶ä¸­ï¼Œè€Œä¸æ˜¯å…¨å±€å¯ç”¨ã€‚ä½ åªèƒ½åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ä½¿ç”¨ã€‚ JavaScript ä¼šè‡ªåŠ¨æå‡ import è¯­å¥çš„ä½œç”¨åŸŸï¼Œæ‰€ä»¥ä½ å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹ä½¿ç”¨ import ï¼Œç”šè‡³åœ¨ä½¿ç”¨å…¶ä¸­ä»£ç ä¹‹åã€‚ Imported å¯¼å…¥çš„æ¨¡å—ç¼ºçœå¤„äº strict ä¸¥æ ¼æ¨¡å¼ä¸‹ã€‚  å¦‚ä½•å°† Exports å’Œ Imports å¯¼å…¥å¯¼å‡ºçš„æ¨¡å—é‡å‘½å ç”¨ as å³å¯ï¼š\n1// module-1.js 2 3// Create a variable named \u0026#34;bestClub\u0026#34;: 4const bestClub = \u0026#34;Your Club\u0026#34;; 5 6// Export the bestClub variable as \u0026#34;favoriteTeam\u0026#34;: 7export { bestClub as favoriteTeam }; æ¥ä¸‹æ¥ä½¿ç”¨å°±ä¸èƒ½æ˜¯ bestclub , è€Œæ˜¯ favoriteTeam äº†ï¼š\n1// module-2.js 2 3import { favoriteTeam } from \u0026#34;./module-1.js\u0026#34;; 4 5const myBestClub = favoriteTeam + \u0026#34; \u0026#34; + \u0026#34;is my best club.\u0026#34;; 6 7console.log(myBestClub); åŒæ ·å¯ä»¥åœ¨ import çš„æ—¶å€™ä½¿ç”¨ as\n1// module-1.js 2// Create a variable named \u0026#34;bestClub\u0026#34;: 3const bestClub = \u0026#34;Your Club\u0026#34;; 4// Export the bestClub variable: 5export { bestClub }; 6 7// module-2.js 8import { bestClub as favoriteTeam } from \u0026#34;./module-1.js\u0026#34;; 9const myBestClub = favoriteTeam + \u0026#34; \u0026#34; + \u0026#34;is my best club.\u0026#34;; 10console.log(myBestClub); å¦‚ä½•åœ¨ ES Module ä¸­é‡å‘½åå¤šä¸ª Exports å¯¼å‡º å¾ˆç®€å•ï¼Œç”¨asåŠ ä¸Šé€—å·åˆ†å‰²ç¬¦å·\n1// module-1.js 2 3const bestClub = \u0026#34;Your Club\u0026#34;; 4const fruits = [\u0026#34;Grape\u0026#34;, \u0026#34;Apple\u0026#34;, \u0026#34;Pineapple\u0026#34;, \u0026#34;Lemon\u0026#34;]; 5 6function multiply(x, y) { 7 return x * y; 8} 9 10// Export the three statements above: 11export { 12 bestClub as favoriteTeam, 13 fruits as crops, 14 multiply as product 15}; 16// module-2.js 17 18import { favoriteTeam, crops, product } from \u0026#34;./module-1.js\u0026#34;; 19 20const bestClub = `I bought ${product(2, 11)}${crops[2]}s at ${favoriteTeam}.`; 21 22console.log(bestClub); å¦‚ä½•åœ¨ ES Module ä¸­é‡å‘½åå¤šä¸ª Import å¯¼å…¥ è·Ÿä¸Šé¢ä¸€æ ·ï¼š\n1// module-1.js 2 3const bestClub = \u0026#34;Your Club\u0026#34;; 4const fruits = [\u0026#34;Grape\u0026#34;, \u0026#34;Apple\u0026#34;, \u0026#34;Pineapple\u0026#34;, \u0026#34;Lemon\u0026#34;]; 5function multiply(x, y) { 6 return x * y; 7} 8 9// Export the three statements above: 10export { bestClub, fruits, multiply }; 11// module-2.js 12 13import { 14 bestClub as favoriteTeam, 15 fruits as crops, 16 multiply as product 17} from \u0026#34;./module-1.js\u0026#34;; 18 19const bestClub = `I bought ${product(2, 11)}${crops[2]}s at ${favoriteTeam}.`; 20 21console.log(bestClub); å¦‚ä½•åœ¨ ES Module ä¸€å¥è¯ import å¯¼å…¥æ‰€æœ‰å¯¼å‡ºå˜é‡ ç”¨*å·ï¼š\n1// Import all exportable features from the \u0026#34;countries.js\u0026#34; module: 2import * as allCountries from \u0026#34;./countries.js\u0026#34;; ä¾‹å­å¦‚ä¸‹ï¼š\n1// module-1.js 2 3const bestClub = \u0026#34;Your Club\u0026#34;; 4const fruits = [\u0026#34;Grape\u0026#34;, \u0026#34;Apple\u0026#34;, \u0026#34;Pineapple\u0026#34;, \u0026#34;Lemon\u0026#34;]; 5function multiply(x, y) { 6 return x * y; 7} 8 9// Export the three statements above: 10export { bestClub, fruits, multiply }; 11// module-2.js 12 13import * as firstModule from \u0026#34;./module-1.js\u0026#34;; 14 15const bestClub = `I bought ${firstModule.multiply(2, 11)}${firstModule.fruits[2]}s at ${firstModule.bestClub}.`; 16 17console.log(bestClub); å¦‚ä½•åœ¨ ES Module ä¸­ Export æŒ‡å®š default ç¼ºçœå¯¼å‡º å¦‚æœå¯¼å‡ºçš„æ—¶å€™æŒ‡å®š default ï¼Œå°±æ˜¯ç¼ºçœå¯¼å‡ºã€‚Default export\n1// module-1.js 2 3const bestClub = \u0026#34;Your Club\u0026#34;; 4 5// Export the bestClub variable as a default export: 6export default bestClub; æ³¨æ„ï¼šdefault ä¸¤è¾¹æ²¡æœ‰èŠ±æ‹¬å·ï¼Œå› ä¸º default åªèƒ½æœ‰ä¸€ä¸ªï¼Œè€Œä¸”ç¼ºçœå¯¼å‡ºä¸èƒ½æ˜¯ var , let æˆ–è€… const\nå¦‚ä½• import å¯¼å…¥ç¼ºçœå¯¼å‡º ä¾ç„¶ä¸¤ç§æ–¹æ³•ï¼š\n ä½¿ç”¨ default as çš„è¯­æ³• ç›´æ¥å‘½åç¼ºçœå¯¼å‡º  ä¸€ã€ä½¿ç”¨ default as è¯­æ³• 1import { default as newName } from \u0026#34;./module-relative-path.js\u0026#34;; ä¾‹å­ï¼š\n1// module-1.js 2 3// Export the string value as a default export: 4export default \u0026#34;Your Club\u0026#34;; 5// module-2.js 6 7import { default as favoriteTeam } from \u0026#34;./module-1.js\u0026#34;; 8 9const bestClub = favoriteTeam + \u0026#34; \u0026#34; + \u0026#34;is my best club.\u0026#34;; 10 11console.log(bestClub); äºŒã€ç›´æ¥å‘½åç¼ºçœå¯¼å‡º è¿™ç§æ–¹å¼ï¼Œå¯ä»¥çœ‹ä½œæ˜¯ç¬¬ä¸€ç§å»æ‰èŠ±æ‹¬å·ï¼Œå»æ‰ default as åçš„ç®€ç•¥å†™æ³•ï¼š\n1import newName from \u0026#34;./module-relative-path.js\u0026#34;; ä¾‹å­ï¼š\n1// module-1.js 2 3// Export the string value as a default export: 4export default \u0026#34;Your Club\u0026#34;; 5// module-2.js 6 7import favoriteTeam from \u0026#34;./module-1.js\u0026#34;; 8 9const bestClub = favoriteTeam + \u0026#34; \u0026#34; + \u0026#34;is my best club.\u0026#34;; 10 11console.log(bestClub); overï¼Œè¿™ä¹ˆå¤šï¼Œå¤§å®¶åº”è¯¥ä¼šäº†å§ã€‚å›å¤´ä¼šå¦å¼€ä¸€ç¯‡è¯´è¯´å¦‚ä½•æŠŠæ¨¡å—éƒ½å‹åˆ°ä¸€èµ·ï¼Œé‚£å°±æ˜¯ webpack çš„åŠŸèƒ½äº†ã€‚\n","date":"2022-05-21","img":"","permalink":"https://bajie.dev/posts/20220521-javascripts_module/","series":null,"tags":null,"title":"Javascriptsä¸­çš„module"},{"categories":null,"content":"ç ”ç©¶ä¸€ä¸‹ javascripts çš„ reduce ï¼Œreduce æ˜¯æ—¢èƒ½æ”¹å˜ array çš„ sizeï¼Œåˆèƒ½æ”¹å˜æ•°å€¼çš„å‡½æ•°ï¼Œfilter æ˜¯åªèƒ½æ”¹å˜sizeï¼Œä¸èƒ½æ”¹å˜æ•°å€¼ï¼›è€Œ map æ˜¯ä¸èƒ½æ”¹å˜ sizeï¼Œå¯ä»¥æ”¹å˜æ•°å€¼ã€‚å¾ˆæ‹—å£å§ï¼Œä¸‰ä¸ªå…„å¼Ÿã€‚\nç®€å•ä»‹ç»ä¸€ä¸‹ reduceã€‚\nå‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªæ•°ç»„:\n1[1, 2, 3, 4] æˆ‘ä»¬è¦å¯¹æ•´ä¸ªæ•°ç»„æ±‚å’Œ.\nreduce å®é™…æ˜¯æŒ‰ç…§ä¸‹åˆ—çš„ç®—å¼æ¥è¿›è¡Œæ±‚å’Œçš„:\n((((1) + 2) + 3) + 4)\né‚£å®é™… reduce å‡½æ•°æ‰§è¡Œä¸­ï¼Œä½ å¯ä»¥æŒ‰ä½ éœ€æ±‚æ¥è‡ªå®šä¹‰ä½ è‡ªå·±çš„ + æ“ä½œç¬¦ã€‚æ•°ç»„çš„å€¼ä¹Ÿå¯ä»¥æ˜¯å…¶ä»–çš„ä»»æ„ä¸œè¥¿ã€‚å¬èµ·æ¥æœ‰ç‚¹æ„æ€å§ï¼Ÿ\n1ã€ Reduce æ˜¯å¹²å˜›çš„ åœ¨ä¸€ä¸ªå‡½æ•°å¼ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œreduce å…¶å®æœ‰å¾ˆå¤šåˆ«çš„åç§°ï¼Œæ¯”å¦‚ foldï¼ˆå¯¹æŠ˜ï¼‰, accumulateï¼ˆç´¯åŠ å™¨ï¼‰, aggregateï¼ˆèšåˆå™¨ï¼‰, compressï¼ˆå‹ç¼©ï¼‰ ç”šè‡³å« injectï¼ˆæ³¨å…¥ï¼‰ã€‚\n2ã€ Reduce çš„å‚æ•° å¸¸ç”¨ç”¨æ³•å¦‚ä¸‹ï¼š\n1let myArray = [/* é¦–å…ˆå®šä¹‰ä¸€ä¸ªæ•°ç»„ */]; 2let callbackfn = /* å†å®šä¹‰ä¸€ä¸ªå‡½æ•° */ ; 3let initialvalue = /* ä»»æ„ä¸€ä¸ªåˆå§‹åŒ–çš„å€¼ */ ; 4 5myArray.reduce(callbackfn) 6myArray.reduce(callbackfn, initialValue) reduce çš„å‚æ•°å¦‚ä¸‹:\ncallbackfn: å¿…é¡»æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä¼šåœ¨æ•´ä¸ªæ•°ç»„ä¸­åå¤è°ƒç”¨ï¼Œreduce è°ƒç”¨ callbackfn çš„æ—¶å€™æœ‰4ä¸ªå‚æ•°ï¼Œæˆ‘ä»¬å®šä¹‰å®ƒä»¬æ˜¯ previousValue, currentElement, index å’Œ array ï¼Œçœ‹èµ·æ¥åƒä¸‹é¢ä¸€æ ·:\n1callbackfn(previousValue, currentElement, index, array) è§£é‡Šä¸€ä¸‹:\n previousValue: è¿™ä¸ªå‚æ•°å°±æ˜¯ä¸€ä¸ªç´¯åŠ å™¨ã€‚ currentElement: æ•°ç»„ä¸­å¤„ç†çš„å½“å‰å…ƒç´ ã€‚ index: å½“å‰å…ƒç´ çš„ç´¢å¼•å€¼ã€‚ array: myArrayè°ƒç”¨çš„æ•°ç»„.  Return valueï¼ˆè¿”å›å€¼ï¼‰: æœ€åä¸€æ¬¡è°ƒç”¨ callbackfn çš„æ—¶å€™ï¼Œè¿”å›å€¼å°±æ˜¯æ•´ä¸ª reduce è¿‡ç¨‹çš„è¿”å›å€¼ã€‚å¦‚æœä¸æ˜¯æœ€åä¸€æ¬¡è°ƒç”¨ï¼Œå®ƒè¿”å›çš„å€¼ä¼šè¢«ä¸‹æ¬¡çš„ callbackFn çš„ previousvalue å‚æ•°æ¥æ”¶ã€‚\næˆ‘ä»¬å¿…é¡»æ³¨æ„ï¼Œå‡½æ•°å°±æ˜¯å‡½æ•°ï¼Œå‡½æ•°è¿‡ç¨‹ä¸­å¤„ç†çš„å˜é‡è¦ä¹ˆæ˜¯å¤–å›´çš„ scope å¸¦è¿›æ¥çš„ï¼Œè¦ä¹ˆæ˜¯å‡½æ•°ä½“å†…è‡ªå®šä¹‰çš„ï¼Œæ‰€ä»¥åé¢ä¸¤ä¸ª index å’Œ array ä¹Ÿæ˜¯å¿…é¡»å­˜åœ¨çš„ï¼Œåªä¸è¿‡æ˜¯ reduce å‡½æ•°æ›¿ä½ è‡ªåŠ¨å¤„ç†äº†ã€‚\n3ã€ ç”¨ç”»å›¾æ¥ç†è§£ Reduce çœ‹ä¸Šé¢çš„å›¾ï¼Œreduce å’Œ reductRight å‡½æ•°çš„åŒºåˆ«å°±æ˜¯æ–¹å‘ï¼Œä¸€ä¸ªæ˜¯ä»å·¦åˆ°å³ï¼Œä¸€ä¸ªæ˜¯ä»å³åˆ°å·¦ã€‚\nå…³æ³¨ç‚¹å¦‚ä¸‹:\n acc ç›¸å½“äº previousValue ï¼Œç´¯åŠ å™¨. curVal ç›¸å½“äºcurrentElementï¼Œå½“å‰å¤„ç†å…ƒç´ . æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ å‘ä¸‹è¾“å‡ºåˆ°åœˆ r å°±æ˜¯curValè¾“å‡ºåˆ°***r***çš„å…·ä½“è¡¨ç°. åŒ…å«æ•°ç»„å…ƒç´ çš„é•¿æ–¹å½¢è¾“å‡ºåˆ°ä¸‹ä¸€ä¸ª r å°±æ˜¯ acc è¾“å‡ºåˆ°***r***çš„å…·ä½“è¡¨ç°. åˆå§‹åŒ–å€¼åœ¨æ•°ç»„å¤–å•ç‹¬è¡¨ç¤ºï¼Œå®ƒæ˜¯ä½œä¸ºä¸€ä¸ªå•ç‹¬çš„ acc è¾“å‡ºåˆ° r ä¸­çš„.  3ã€ ç”¨æµç¨‹å›¾æ¥ç†è§£ Reduce ä¸‹é¢ç”¨20è¡Œçš„ä¼ªä»£ç æ¥è¯¦ç»†è§£é‡Šæ•´ä¸ª reduce çš„è¿‡ç¨‹ï¼Œé¦–å…ˆè¿›å…¥ reduce å‡½æ•°ï¼š\n If initialValue is present, å¦‚æœåˆå§‹åŒ–å˜é‡ä¸ä¸ºç©º ã€€If myArray has no elements, æ¥ç€åˆ¤æ–­å¦‚æœæ•°ç»„ä¸ºç©º ã€€Return initialValue. é‚£ä¹ˆç›´æ¥åˆå§‹åŒ–å˜é‡ä½œä¸º reduce çš„ç»“æœè¿”å› ã€€else åˆå§‹åŒ–å˜é‡ä¸ºç©ºä½†æ•°ç»„ä¸ä¸ºç©º ã€€Let accumulator be initialValue. æŠŠåˆå§‹å˜é‡èµ‹ç»™ç´¯åŠ å™¨ ã€€If the method is reduce, å¦‚æœæ–¹æ³•æ˜¯ reduce ã€€Let startIndex be the index of the leftmost element of myArray. æŠŠæ•°ç»„æœ€å·¦è¾¹çš„å…ƒç´ çš„indexå€¼èµ‹äºˆ startIndex else å¦‚æœåˆå§‹åŒ–å˜é‡ä¸ºç©º ã€€If myArray has no elements, å¦‚æœæ•°ç»„æ²¡æœ‰å…ƒç´  ã€€Throw TypeError. åˆå§‹åŒ–å˜é‡ä¸ºç©ºï¼Œæ•°ç»„ä¹Ÿä¸ºç©ºï¼Œç›´æ¥æŠ›ç±»å‹é”™è¯¯ ã€€Else if myArray has just only one element, å¦‚æœæ•°ç»„åªæœ‰ä¸€ä¸ªå…ƒç´  ã€€Return that element. é‚£ä¹ˆç›´æ¥å°†æ•°ç»„ä¸­å”¯ä¸€ä¸€ä¸ªå…ƒç´ ä½œä¸º reduce ç»“æœè¿”å› ã€€Else ã€€If the method is reduce,å¦‚æœæ–¹æ³•æ˜¯ reduce ã€€Let accumulator be the leftmost element of myArray. æŠŠæ•°ç»„æœ€å·¦è¾¹çš„ç¬¬ä¸€ä¸ªå…ƒç´ èµ‹ç»™ç´¯åŠ å™¨  If the method is reduce, å¦‚æœæ–¹æ³•æ˜¯reduce ã€€In left to right order, for each element of myArray such that its index i â‰¥ startingIndex, æŒ‰ç…§ä»å·¦åˆ°å³çš„é¡ºåºï¼Œéå†æ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ ï¼Œæ¥ä¸ªå¤§å¾ªç¯ ã€€Set accumulator to callbackfn(accumulator, myArray[i], i, myArray). æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ ï¼Œéƒ½é€ä¸ªè®¾ç½®åˆ°callbackfnå‡½æ•°ä¸­å¹¶è¿è¡Œ Return accumulator. ç´¯åŠ å™¨çš„å€¼ä½œä¸º reduce ç»“æœè¿”å›  ä»”ç»†ç†è§£ï¼Œæå®Œäº†å§ã€‚\nç»™ä¸ªå®é™…ä¾‹å­ï¼Œä¸€ç¾¤å­¦ç”Ÿï¼Œæœ‰ç”·æœ‰å¥³ï¼Œå…ˆé€‰å‡ºå¥³å­¦ç”Ÿï¼Œç„¶åè®¡ç®—å‡ºå¥¹ä»¬æ¯ä¸ªäººçš„å¹³å‡æˆç»©ï¼Œæœ€åæŠŠå¥¹ä»¬æ‰“å°å‡ºæ¥ï¼š\n1const students = [ 2 { 3 name: \u0026#34;Anna\u0026#34;, 4 sex: \u0026#34;f\u0026#34;, 5 grades: [4.5, 3.5, 4] 6 }, 7 8 { 9 name: \u0026#34;Dennis\u0026#34;, 10 sex: \u0026#34;m\u0026#34;, 11 country: \u0026#34;Germany\u0026#34;, 12 grades: [5, 1.5, 4] 13 }, 14 15 { 16 name: \u0026#34;Martha\u0026#34;, 17 sex: \u0026#34;f\u0026#34;, 18 grades: [5, 4, 2.5, 3] 19 }, 20 21 { 22 name: \u0026#34;Brock\u0026#34;, 23 sex: \u0026#34;m\u0026#34;, 24 grades: [4, 3, 2] 25 } 26]; 27 28 29//TODO: Compute and Return female students results using functional programming. 30 31function studentResult(students){ 32 return students.filter(x =\u0026gt; x.sex==\u0026#34;f\u0026#34;).reduce((init,cur)=\u0026gt;{ 33 cur[\u0026#39;grades\u0026#39;]=cur.grades.reduce((acc,cur) =\u0026gt; acc+cur,0)/cur.grades.length; 34 return init.concat(cur); 35 },[]); 36} 37 38console.log(studentResult(students)); 39//[ { name: \u0026#39;Anna\u0026#39;, sex: \u0026#39;f\u0026#39;, grades: 4 }, { name: \u0026#39;Martha\u0026#39;, sex: \u0026#39;f\u0026#39;, grades: 3.625 } ] 40 æ³¨æ„ä¸€ç‚¹ï¼Œreduce å¯ä»¥åŠ¨ sizeï¼Œä¹Ÿå¯ä»¥åŠ¨å€¼ï¼Œä¸Šé¢å®é™…æ”¹å˜äº† students æ•°ç»„å…ƒç´ çš„å€¼äº†ï¼Œä¸å¤ªå¥½ã€‚åº”è¯¥èµ‹ä¸€ä¸ªæ–°å€¼ concat æˆ–è€… push è¿›æ–°æ•°ç»„ã€‚\nä¸‹é¢çš„æ–¹æ³•å°±æ²¡æœ‰åŠ¨åŸæ•°ç»„çš„æ•°æ®ï¼š\n1function studentResult(students){ 2 return students.filter(x =\u0026gt; x.sex==\u0026#34;f\u0026#34;).reduce((init,cur)=\u0026gt;{ 3 let newarr = {}; 4 newarr[\u0026#39;name\u0026#39;]=cur.name; 5 newarr[\u0026#39;sex\u0026#39;]=cur.sex; 6 newarr[\u0026#39;grades\u0026#39;]=cur.grades.reduce((acc,cur) =\u0026gt; acc+cur,0)/cur.grades.length; 7 init.push(newarr); 8 return init; 9 },[]); 10} ","date":"2022-05-20","img":"","permalink":"https://bajie.dev/posts/20220520-javascripts_reduce/","series":null,"tags":null,"title":"Javascriptsä¹‹æ•°ç»„çš„reduce"},{"categories":null,"content":"é¢è¯•çš„æ—¶å€™è¢«é—®åˆ°ï¼šå¦‚ä½•æ‰èƒ½è®© docker æ‰“å‡ºçš„é•œåƒåŒ…å°½é‡å°ï¼Ÿ\nå…¶å®åœ¨ç”Ÿäº§å·²ç»å°½é‡ä½¿ç”¨æœ€å°åŒ–çš„é•œåƒåŒ…äº†ï¼Œåªæ˜¯çªç„¶è¢«é—®åˆ°è¿˜æ˜¯æœ‰ç‚¹æ‡µåœˆï¼›å› ä¸ºå°è±¡ä¸­è‡ªå·±åŸºæœ¬æ˜¯ä½¿ç”¨ alphine åšåº•åŒ…ï¼ŒDockerfile é€šå¸¸å°±æ˜¯ copy ä¸€ä¸ªå¯æ‰§è¡Œçš„ç¨‹åºè¿›å»å°±å®Œäº‹äº†ï¼Œå¦‚æœä¸è¡Œï¼Œå†å¼€ shell è¿›å»æ…¢æ…¢æ·»åŠ ç¼ºå°‘çš„åº“æ–‡ä»¶ã€‚\nè¿™é‡Œå°±æ€»ç»“ä¸€ä¸‹ï¼Œä¸¤ç‚¹ï¼š\nä¸€ã€ä½¿ç”¨å°½é‡å°çš„åº•åŒ… ä»¥ alphine ä¸ºä¸»ï¼Œä½¿ç”¨ alphine åº•åŒ…çš„æ—¶å€™ï¼Œéœ€è¦æ³¨æ„ä»¥ä¸‹ï¼š\n1ã€æ›¿æ¢ apk çš„æº\n2ã€æ›´æ–°ã€æ›´æ–°è¯ä¹¦\n3ã€æ³¨æ„ Timezone çš„è®¾ç½®\n4ã€æ³¨æ„ glibc åº“çš„å…¼å®¹é—®é¢˜\näºŒã€ä½¿ç”¨åˆ†é˜¶æ®µbuild é€šå¸¸ç±»ä¼¼cã€goã€rustä¹‹ç±»çš„æºä»£ç ï¼Œéƒ½éœ€è¦ç»è¿‡ç¼–è¯‘ï¼Œæœ€åäº§ç”Ÿå¯æ‰§è¡Œæ–‡ä»¶ï¼Œé‚£ä¹ˆå®Œæ•´çš„ç¼–è¯‘ç¯å¢ƒå…¶å®å¯¹æœ€åçš„é•œåƒæ¥è¯´éƒ½æ˜¯ä¸éœ€è¦çš„ã€‚\næ‰€ä»¥åˆ©ç”¨åˆ†é˜¶æ®µbuildï¼Œç”©è„±ç¼–è¯‘ç¯å¢ƒä»¥åŠä¸­é—´äº§ç‰©ï¼Œå°±å¯ä»¥ç¼©å°æœ€å build å‡ºé•œåƒçš„å¤§å°ï¼Œä½¿ç”¨ä¹Ÿå¾ˆç®€å•ã€‚\nDockerfile æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š\n1FROM golang:alpine AS build-env 2WORKDIR /app 3ADD . /app 4RUN cd /app \u0026amp;\u0026amp; go build -o goapp 5 6 7FROM alpine 8RUN apk update \u0026amp;\u0026amp; \\ 9 apk add ca-certificates \u0026amp;\u0026amp; \\ 10 update-ca-certificates \u0026amp;\u0026amp; \\ 11 rm -rf /var/cache/apk/* 12WORKDIR /app 13COPY --from=build-env /app/goapp /app 14EXPOSE 8080 15ENTRYPOINT ./goapp 16 17 ","date":"2022-04-01","img":"","permalink":"https://bajie.dev/posts/20220401-docker_mini_image/","series":null,"tags":null,"title":"é¢è¯•ä¹‹Dockerå¦‚ä½•æ‰“å‡ºæœ€å°çš„é•œåƒ"},{"categories":null,"content":"é¢è¯•æ—¶è¢«é—®åˆ°ï¼šæ˜¯å¦äº†è§£ Nginxï¼Œå®ƒä½¿ç”¨çš„ epoll æ¨¡å¼å’Œå…¶ä»–çš„ç›¸æ¯”æœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼Ÿ\nç›´æ¥è¢«é—®ä½ï¼Œå®é™…ç”Ÿäº§ä¸­é…è¿‡ä¸å°‘çš„ Nginxï¼Œå„ç§ rewriteã€regexã€æ­£åå‘ä»£ç†ã€phpã€fast-cgiã€é™æµã€è¯ä¹¦ã€jwtã€corsï¼›epoll åªå¤§æ¦‚æœ‰å°è±¡æ˜¯ä¸‹é¢è¿™è¡Œï¼š\n1events { 2 use epoll; 3 worker_connections 1024; 4} å®åœ¨æ˜¯æ±—é¢œå•Šï¼Œæ‰€ä»¥å¾—ä»”ç»†ç ”ç©¶ä¸€ä¸‹è¿™ä¸ª epollã€‚\né¦–å…ˆæ‰”æ¦‚å¿µ IOå¤šè·¯å¤ç”¨ï¼š å¤šè·¯æ˜¯æŒ‡ç½‘ç»œè¿æ¥ï¼Œå¤ç”¨æŒ‡çš„æ˜¯åŒä¸€ä¸ªçº¿ç¨‹ã€‚\nIOå¤šè·¯å¤ç”¨æ˜¯ä¸€ç§åŒæ­¥IOæ¨¡å‹ï¼Œå®ç°ä¸€ä¸ªçº¿ç¨‹å¯ä»¥ç›‘è§†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼›\nä¸€æ—¦æŸä¸ªæè¿°ç¬¦å°±ç»ªï¼ˆä¸€èˆ¬æ˜¯è¯»å°±ç»ªæˆ–è€…å†™å°±ç»ªï¼‰ï¼Œå°±èƒ½å¤Ÿé€šçŸ¥åº”ç”¨ç¨‹åºè¿›è¡Œç›¸åº”çš„è¯»å†™æ“ä½œï¼›\næ²¡æœ‰æ–‡ä»¶æè¿°ç¬¦å°±ç»ªæ—¶ä¼šé˜»å¡åº”ç”¨ç¨‹åºï¼Œäº¤å‡ºcpuã€‚\né‚£ä¹ˆIOå¤šè·¯å¤ç”¨çš„å®ç°æ–¹æ³•æœ‰ä¸‰ç§ï¼š selectã€pollã€epoll selectã€pollã€epollæœ¬è´¨ä¸Šéƒ½æ˜¯åŒæ­¥I/Oï¼Œç”¨æˆ·è¿›ç¨‹ï¼ˆè¿™é‡Œå°±æ˜¯Nginxï¼‰è´Ÿè´£è¯»å†™ï¼ˆä»å†…æ ¸ç©ºé—´æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼‰ï¼Œè¯»å†™è¿‡ç¨‹ä¸­ï¼Œç”¨æˆ·è¿›ç¨‹æ˜¯é˜»å¡çš„ã€‚\nselectï¼š\n  æŸ¥è¯¢ fd_set ä¸­ï¼Œæ˜¯å¦æœ‰å°±ç»ªçš„ fdï¼Œå¯ä»¥è®¾å®šä¸€ä¸ªè¶…æ—¶æ—¶é—´ï¼Œå½“æœ‰ fd (File descripter) å°±ç»ªæˆ–è¶…æ—¶è¿”å›ï¼›\n  fd_set æ˜¯ä¸€ä¸ªä½é›†åˆï¼Œå¤§å°æ˜¯åœ¨ç¼–è¯‘å†…æ ¸æ—¶çš„å¸¸é‡ï¼Œé»˜è®¤å¤§å°ä¸º 1024\n  ç‰¹ç‚¹ï¼š\n  è¿æ¥æ•°é™åˆ¶ï¼Œfd_set å¯è¡¨ç¤ºçš„ fd æ•°é‡å¤ªå°äº†ï¼›\n  çº¿æ€§æ‰«æï¼šåˆ¤æ–­ fd æ˜¯å¦å°±ç»ªï¼Œéœ€è¦éå†ä¸€è¾¹ fd_setï¼›\n  æ•°æ®å¤åˆ¶ï¼šä»å†…æ ¸ç©ºé—´æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼Œå¤åˆ¶è¿æ¥å°±ç»ªçŠ¶æ€ä¿¡æ¯\n  pollï¼š\n  è§£å†³äº†è¿æ¥æ•°é™åˆ¶ï¼š\n  poll ä¸­å°† select ä¸­çš„ fd_set æ›¿æ¢æˆäº†ä¸€ä¸ª pollfd æ•°ç»„\n  è§£å†³ fd æ•°é‡è¿‡å°çš„é—®é¢˜\n  æ•°æ®å¤åˆ¶ï¼šä»å†…æ ¸ç©ºé—´æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼Œå¤åˆ¶è¿æ¥å°±ç»ªçŠ¶æ€ä¿¡æ¯\n  epollï¼ševent äº‹ä»¶é©±åŠ¨\n  äº‹ä»¶æœºåˆ¶ï¼šé¿å…çº¿æ€§æ‰«æ\n  ä¸ºæ¯ä¸ª fdï¼Œæ³¨å†Œä¸€ä¸ªç›‘å¬äº‹ä»¶\n  fd å˜æ›´ä¸ºå°±ç»ªæ—¶ï¼Œå°† fd æ·»åŠ åˆ°å°±ç»ªé“¾è¡¨\n  fd æ•°é‡ï¼šæ— é™åˆ¶ï¼ˆOS çº§åˆ«çš„é™åˆ¶ï¼Œå•ä¸ªè¿›ç¨‹èƒ½æ‰“å¼€å¤šå°‘ä¸ª fdï¼‰\n  åŒºåˆ«åœ¨äº:\nepollè¾ƒçµæ´»ï¼Œå¦‚æœæœ‰ä¸€ç™¾ä¸‡ä¸ªé“¾æ¥çŠ¶æ€åŒæ—¶ä¿æŒï¼Œä½†æ˜¯åœ¨æŸä¸ªæ—¶åˆ»ï¼Œåªæœ‰å‡ ç™¾ä¸ªé“¾æ¥æ˜¯æ´»è·ƒçš„ã€‚epollçš„å¤„ç†æ˜¯é€šè¿‡epoll_create()åˆ›å»ºå¯¹è±¡ï¼Œepoll_ctl()æ”¶é›†æ‰€æœ‰çš„å¥—æ¥å­—æ·»åŠ åˆ°epollå¯¹è±¡ï¼Œepoll_wait()æ”¶é›†æ‰€æœ‰å‘ç”Ÿäº‹ä»¶ä¹Ÿå°±æ˜¯æ‰€è°“çš„æ´»è·ƒçš„é“¾æ¥ï¼Œå¹¶æ”¶é›†åˆ°ä¸€ä¸ªListé“¾è¡¨ä¸­ï¼Œè¿™æ ·åªéœ€è¦éå†è¿™äº›Listé“¾è¡¨é‡Œçš„æ•°æ®ï¼Œè€Œä¸ç”¨éå†ä¸€ç™¾ä¸‡ä¸ªé“¾æ¥ã€‚ è€Œåè€…select pollåˆ™æ˜¯æ¯æ¬¡æ”¶é›†äº‹ä»¶æ—¶ï¼Œå°†è¿™ä¸€ç™¾ä¸‡ä¸ªé“¾æ¥éƒ½ä¼ ç»™æ“ä½œç³»ç»Ÿï¼Œå†ç”±æ“ä½œç³»ç»Ÿå†…æ ¸ä¸Šåˆ¤æ–­æŸäº›é“¾æ¥äº§ç”Ÿäº†äº‹ä»¶ï¼Œé€ æˆäº†å·¨å¤§çš„èµ„æºæµªè´¹ï¼ˆå¤§æ‰¹é‡çš„ä¸åŒæ€å†…å­˜å¤åˆ¶ï¼‰ã€‚\nä¸ºä»€ä¹ˆepollæ•ˆç‡æ¯”è¾ƒé«˜ï¼š\nepoll åœ¨epoll_create æ—¶ï¼Œå°±å·²ç»å»ºç«‹å¥½äº†ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦å¯¹åº” epoll å¯¹è±¡ï¼ŒåŒæ—¶ï¼Œåœ¨å†…æ ¸ cache é‡Œå»ºç«‹äº†ä¸€ä¸ªçº¢é»‘æ ‘ï¼Œç”¨äºå­˜å‚¨åç»­epoll_ctlä¼ æ¥çš„socketè¿æ¥ã€‚å†åŒæ—¶ï¼Œåˆå»ºç«‹äº†ä¸€ä¸ªlisté“¾è¡¨ï¼Œç”¨äºå­˜å‚¨å‡†å¤‡å°±ç»ªçš„äº‹ä»¶ã€‚ ç­‰åˆ° epoll_wait() è°ƒç”¨çš„æ—¶å€™ï¼Œåªéœ€è¦è§‚å¯Ÿlisté“¾è¡¨é‡Œæœ‰æ²¡æœ‰æ•°æ®å°±å¯ä»¥ï¼Œæœ‰æ•°æ®å°±è¿”å›ï¼Œæ²¡æ•°æ®å°±sleepã€‚ç­‰åˆ°timeoutåï¼Œå³ä½¿æ²¡æ•°æ®ï¼Œä¹Ÿè¿”å›äº†ã€‚æ‰€ä»¥ epoll_wait ä¼šéå¸¸é«˜æ•ˆ\nä¸‰è€…çš„æ¯”è¾ƒï¼š\n    select poll epoll     æ•°æ®ç»“æ„ bitmap æ•°ç»„ çº¢é»‘æ ‘   æœ€å¤§è¿æ¥æ•° 1024 æ— ä¸Šé™ æ— ä¸Šé™   fdæ‹·è´ æ¯æ¬¡è°ƒç”¨selectæ‹·è´ æ¯æ¬¡è°ƒç”¨pollæ‹·è´ fdé¦–æ¬¡è°ƒç”¨epoll_ctlæ‹·è´ï¼Œæ¯æ¬¡è°ƒç”¨epoll_waitä¸æ‹·è´   å·¥ä½œæ•ˆç‡ è½®è¯¢ï¼šO(n) è½®è¯¢ï¼šO(n) å›è°ƒï¼šO(1)    Nginx çš„å¹¶å‘å¤„ç†èƒ½åŠ› å…³äº Nginx çš„å¹¶å‘å¤„ç†èƒ½åŠ›ï¼š\n å¹¶å‘è¿æ¥æ•°ï¼Œä¸€èˆ¬ä¼˜åŒ–åï¼Œå³°å€¼èƒ½ä¿æŒåœ¨ 1~3w å·¦å³ã€‚ï¼ˆå†…å­˜å’Œ CPU æ ¸å¿ƒæ•°ä¸åŒï¼Œä¼šæœ‰è¿›ä¸€æ­¥ä¼˜åŒ–ç©ºé—´ï¼‰ Nginx çš„æœ€å¤§è¿æ¥æ•°ï¼šWorker è¿›ç¨‹æ•°é‡ x å•ä¸ª Worker è¿›ç¨‹çš„æœ€å¤§è¿æ¥æ•°  ","date":"2022-04-01","img":"","permalink":"https://bajie.dev/posts/20220401-nginx_epoll/","series":null,"tags":null,"title":"é¢è¯•ä¹‹Nginxçš„epollçš„ä¼˜åŠ¿"},{"categories":null,"content":"ç°åœ¨å„å¤§å…¬æœ‰äº‘çš„ k8s ç½‘ç»œæ’ä»¶åŸºæœ¬ç”¨çš„éƒ½æ˜¯ vxlanï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦å¯¹è¿™ä¸ªè¿›è¡Œä¸€ä¸‹è¯¦ç»†äº†è§£ï¼Œä»¥ä¾¿ç”¨äºå…¬å¸çš„æ­£å¼ç”Ÿäº§ç¯å¢ƒã€‚\nä¸€ã€åŸç† é¦–å…ˆï¼Œkubernetesçš„ç½‘ç»œæ¨¡å‹ï¼š\nåŒ…å«ä¸‰è¦ç´ ï¼š\n  æ‰€æœ‰çš„å®¹å™¨(container)ä¹‹é—´èƒ½å¤Ÿåœ¨ä¸ä½¿ç”¨ NAT çš„æƒ…å†µä¸‹äº’ç›¸é€šè®¯\n  æ‰€æœ‰çš„èŠ‚ç‚¹(Node)èƒ½å¤Ÿåœ¨ä¸ä½¿ç”¨ NAT çš„æƒ…å†µä¸‹è·Ÿæ‰€æœ‰çš„å®¹å™¨(container)äº’ç›¸é€šè®¯ï¼ˆåä¹‹å®¹å™¨è®¿é—®èŠ‚ç‚¹äº¦ç„¶ï¼‰\n  å®¹å™¨(container)ä¸­çš„IPåœ°å€ï¼Œåœ¨å®¹å™¨å†…å’Œå®¹å™¨å¤–é¢çœ‹èµ·æ¥æ˜¯ä¸€æ ·çš„\n  é‚£æ¥åˆ° flannelï¼Œå®ƒæ˜¯ä¸€ç§ Overlay network è¦†ç›–ç½‘ç»œï¼Œç›–åœ¨åŸæœ‰çš„ Node ç½‘ç»œåŸºç¡€ä¸Šï¼š ä¸Šå›¾è¦ä»”ç»†åˆ†æï¼Œ K8S ä¸­å­˜åœ¨ä¸‰ä¸ª+ä¸€ä¸ªç½‘ç»œæ®µï¼š\n node ç½‘ç»œæ®µï¼Œä¸Šå›¾æ˜¯ 172.20.32.0/19ï¼Œè¿™æ˜¯åŸºç¡€ç½‘ç»œæ®µ pod ç½‘ç»œæ®µï¼Œ100.96.0.0/16ï¼Œ2Â¹â¶(65536)ä¸ªIPï¼Œè¿™æ˜¯ç”± flannel äº§ç”Ÿçš„ overlay networkï¼Œæ‰€æœ‰çš„ pod éƒ½ç«™åœ¨ä¸€ä¸ªå¤§å¹¿åœºä¸Šï¼Œäº’ç›¸å¯è§ svc ç½‘ç»œæ®µï¼Œä¸Šå›¾æœªæï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“ï¼Œæƒ³è¦æŠŠ pod çš„ ip ç»™å›ºå®šä¸‹æ¥ï¼Œå°±å¾—ä½¿ç”¨ svc æ¥åˆ†é…å›ºå®šçš„åŸŸåï¼Œè¿™ä¸ªæ˜¯ç”± iptables æ¥ç»´æŠ¤çš„ In-Host docker networkç½‘ç»œæ®µï¼Œè¿™æ˜¯æ¯ä¸ª Node ä¸»æœºçš„å•ç‹¬ç½‘ç»œæ®µï¼Œflannelç»™æ¯ä¸ª Node ä¸»æœºåˆ’åˆ†äº†ä¸€ä¸ª 100.96.x.0/24 æ®µï¼Œç„¶ååœ¨ etcd å†…è¿›è¡Œç»´æŠ¤ï¼Œæ¥é¿å…ä¸åŒçš„ Node ä¸»æœºåˆ†é…IPå†²çªã€‚  ç»¼è¿°ï¼šflannel ä¸ºæ¯ä¸ª Node åˆ†é…ä¸€ä¸ª subnetï¼Œå®¹å™¨(container)ä»æ­¤ subnet ä¸­åˆ†é… IPï¼Œè¿™äº› IP å¯ä»¥åœ¨ Node é—´è·¯ç”±ï¼Œå®¹å™¨é—´æ— éœ€ NAT å’Œ port mapping å°±å¯ä»¥è·¨ä¸»æœºé€šä¿¡ã€‚\næ¯ä¸ª subnet éƒ½æ˜¯ä»ä¸€ä¸ªæ›´å¤§çš„ IP æ± ä¸­åˆ’åˆ†çš„ï¼Œflannel ä¼šåœ¨æ¯ä¸ª Node ä¸Šè¿è¡Œä¸€ä¸ªå« flanneld çš„ agentï¼Œå…¶èŒè´£å°±æ˜¯ä»æ± å­ä¸­åˆ†é… subnetã€‚ä¸ºäº†åœ¨å„ä¸ªä¸»æœºé—´å…±äº«ä¿¡æ¯ï¼Œflannel ç”¨ etcdï¼ˆä¸ consul ç±»ä¼¼çš„ key-value åˆ†å¸ƒå¼æ•°æ®åº“ï¼‰å­˜æ”¾ç½‘ç»œé…ç½®ã€å·²åˆ†é…çš„ subnetã€host çš„ IP ç­‰ä¿¡æ¯ã€‚\næ•°æ®åŒ…å¦‚ä½•åœ¨ä¸»æœºé—´è½¬å‘æ˜¯ç”± backend å®ç°çš„ã€‚flannel æä¾›äº†å¤šç§ backendï¼Œæœ€å¸¸ç”¨çš„æœ‰ vxlan å’Œ host-gwï¼Œudp ä¸‡ä¸‡ä¸å¯ä½¿ç”¨ã€‚\nä»”ç»†åˆ†æä¸€ä¸‹ä¸¤ä¸ªä¸åŒä¸»æœºä¸Šçš„containerè·¨ä¸»æœºäº’ç›¸é€šè®¯çš„è¿‡ç¨‹ï¼š\ncontainer-1 é¦–å…ˆå»ºç«‹ IP åŒ…ï¼Œ src: 100.96.1.2 -\u0026gt; dst: 100.96.2.3, åŒ…å‘åˆ° docker0 ç½‘æ¡¥ï¼Œdocker0 æ˜¯ container-1 çš„ç¼ºçœ gateway ç½‘å…³ã€‚\nåœ¨æ¯ä¸ª Node ä¸Šï¼Œflannel éƒ½ä¼šè·‘ä¸€ä¸ªflanneldçš„å®ˆæŠ¤è¿›ç¨‹ï¼Œå®ƒä¼šåœ¨ Linux çš„ kernel è·¯ç”±è¡¨ä¸­å»ºç«‹è‹¥å¹²æ¡è·¯ç”±ï¼Œ Node1 çš„è·¯ç”±è¡¨å¦‚ä¸‹:\n1admin@ip-172-20-33-102:~$ ip route 2default via 172.20.32.1 dev eth0 3100.96.0.0/16 dev flannel0 proto kernel scope link src 100.96.1.0 4100.96.1.0/24 dev docker0 proto kernel scope link src 100.96.1.1 5172.20.32.0/19 dev eth0 proto kernel scope link src 172.20.33.102 å¯¹ç…§è·¯ç”±è¡¨ï¼Œdst 100.96.2.3 çš„è·¯ç”±ä¼šè½åˆ° 100.96.0.0/16 è¿™ä¸€æ¡ä¸Šï¼Œä¹Ÿå°±æ˜¯è¯´ä¼šè½åˆ° flannel0 è¿™ä¸ªè®¾å¤‡ä¸Šç»§ç»­è½¬å‘å‡ºå»ã€‚\nflannel0 å‘¢æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªç”±flanneld è¿›ç¨‹å»ºç«‹çš„ TUN è™šæ‹Ÿç½‘å¡è®¾å¤‡ï¼š\n å†™TUNï¼šå½“ IP åŒ…å†™åˆ°flannel0åï¼Œä¼šè½¬å‘åˆ° kernelï¼Œç„¶å kernel æŸ¥è·¯ç”±è¡¨å†è½¬å‘ è¯»TUNï¼šå½“ IP åŒ…é¦–å…ˆåˆ°è¾¾æ ¸å¿ƒï¼Œè·¯ç”±è¡¨æ˜¾ç¤ºä¸‹ä¸€è·³æ˜¯flannel0è™šæ‹Ÿç½‘å¡ï¼Œkernelä¼šç›´æ¥æŠŠåŒ…å‘åˆ°äº§ç”Ÿè¿™ä¸ªè™šæ‹Ÿç½‘å¡çš„è¿›ç¨‹å»ï¼Œä¹Ÿå°±æ˜¯flanneldè¿›è¡Œè¯»åŒ…  çœ‹ä¸Šå›¾ï¼ŒIP åŒ…é¦–å…ˆåˆ°è¾¾ Docker0ï¼Œå› ä¸ºå®ƒæ˜¯ç½‘å…³ï¼Œç„¶åæŸ¥å†…æ ¸è·¯ç”±è¡¨ï¼Œåˆ°è¾¾flannel0è™šæ‹Ÿç½‘å¡ï¼Œç„¶åå°±åˆ°è¾¾flanneldè¿›ç¨‹è¯»åŒ…ï¼Œ è¿™æ—¶å€™flanneldä¼šåšä»€ä¹ˆå‘¢ï¼Ÿ\nflanneldä» etcd ä¸­è·å¾—å„ä¸ªä¸»æœºç½‘æ®µå¯¹åº”çš„èŠ‚ç‚¹ä¿¡æ¯ï¼š\n1admin@ip-172-20-33-102:~$ etcdctl ls /coreos.com/network/subnets 2/coreos.com/network/subnets/100.96.1.0-24 3/coreos.com/network/subnets/100.96.2.0-24 4/coreos.com/network/subnets/100.96.3.0-24 5 6admin@ip-172-20-33-102:~$ etcdctl get /coreos.com/network/subnets/100.96.2.0-24 7{\u0026#34;PublicIP\u0026#34;:\u0026#34;172.20.54.98\u0026#34;} äºæ˜¯ä¹ Node1 ä¸Šé¢çš„ flanneld è¿›ç¨‹å¾—çŸ¥ 100.96.2.3 IPå¯¹åº”çš„ç½‘æ®µæ˜¯ 100.96.2.0/24 ï¼Œå†è¿›ä¸€æ­¥å¯¹åº”åˆ° Node2 çš„å…¬ç½‘IP 172.20.54.98ï¼Œç„¶åå®ƒå°±ä¼šç»§ç»­å°è£…è¿™ä¸ªIPåŒ…ï¼Œç”¨UDPæˆ–è€…VXLANï¼ŒæŠŠè¿™ä¸ª IP åŒ…å†åŒ…è£¹ä¸€å±‚å°èµ·æ¥é€åˆ° Node2 çš„ flanneld è¿›ç¨‹å»ã€‚\nNode2ï¼šåŒ…é¦–å…ˆä»ç½‘å¡åˆ°è¾¾ Node2 çš„æ ¸å¿ƒ kernelï¼Œè·¯ç”±è¡¨æ˜¾ç¤ºä¸‹ä¸€è·³æ˜¯flannel0 è™šæ‹Ÿç½‘å¡ï¼ŒåŒ…å°±è½¬å‘åˆ° flanneld è¿›ç¨‹è¯»åŒ…ï¼Œflanneldæ¥æ”¶åˆ°åŒ…åï¼Œå°±ä¼šåšæ‹†åŒ…ï¼Œæ‹†å®ŒåŒ…ç›´æ¥å†™åŒ…åˆ° TUNï¼Œç„¶ååŒ…åˆ°è¾¾æœ¬åœ°æ ¸å¿ƒè·¯ç”±ï¼Œå†æŸ¥è·¯ç”±è¡¨è½¬å‘åˆ°docker0ï¼Œæœ€ç»ˆåˆ°è¾¾ container-2\næˆ‘ä»¬åŒæ ·å¯ä»¥æŸ¥çœ‹ Node2 çš„è·¯ç”±è¡¨ï¼Œåº”è¯¥æ˜¾ç¤ºå¦‚ä¸‹ç»“æœï¼š\n1admin@ip-172-20-54-98:~$ ip route 2default via 172.20.32.1 dev eth0 3100.96.0.0/16 dev flannel0 proto kernel scope link src 100.96.2.0 4100.96.2.0/24 dev docker0 proto kernel scope link src 100.96.2.1 5172.20.32.0/19 dev eth0 proto kernel scope link src 172.20.54.98 è¿™æ ·æ•´ä¸ªè¿‡ç¨‹å°±æ˜æ™°äº†ã€‚\né“ç†æ˜æ™°äº†ï¼Œä¸‹é¢æˆ‘ä»¬å°±éœ€è¦æ¥å®é™…æ“ä½œäº†ã€‚\näºŒã€å®æˆ˜ ç›´æ¥åœ¨ k8s é‡Œè£…å°±å¾ˆç®€å•ï¼Œç”¨ yaml ä¸€æ­¥æ“ä½œå°±è¡Œäº†ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸åšä»»ä½•ä»‹ç»ã€‚\næˆ‘ä»¬ä¸‹é¢è¯´çš„æ˜¯å¦‚ä½•å•ç‹¬æŠŠ flannel å•ç‹¬æ‹¿å‡ºæ¥ä½¿ç”¨ï¼š\n1ã€é¦–å…ˆè¦è£…etcd å‚ç…§ä¹‹å‰çš„å¸–å­ï¼šEtcdå•èŠ‚ç‚¹åº”ç”¨ è¿™é‡Œä¹Ÿç»™å‡ºä¸ç”¨Dockerï¼Œç”¨systemctlæ¥è¿è¡Œçš„æ–¹æ¡ˆï¼š\nå‡†å¤‡å·¥ä½œï¼Œå…³é—­selinuxï¼Œæ‰“å¼€åŒ…è½¬å‘ï¼š\n1echo 1 \u0026gt; /proc/sys/net/ipv4/ip_forward 2#æˆ–è€…ä¿®æ”¹/etc/sysctl.confï¼Œç„¶åsysctl -p 3#net.ipv4.ip_forward = 1 4 5systemctl disable firewalld.service 6systemctl stop firewalld.service 7 8iptables -P FORWARD ACCEPT å®‰è£… etcd ï¼š\n1yum install etcd -y 2 3cp /etc/etcd/etcd.conf/etc/etcd/etcd.conf.bak 4 5vi /etc/etcd/etcd.conf 6ETCD_LISTEN_PEER_URLS=\u0026#34;http://172.16.9.110:2380\u0026#34; 7ETCD_LISTEN_CLIENT_URLS=http://172.16.9.110:2379,http://127.0.0.1:2379 8ETCD_NAME=\u0026#34;default\u0026#34; 9ETCD_INITIAL_ADVERTISE_PEER_URLS=\u0026#34;http://172.16.9.110:2380\u0026#34; 10ETCD_ADVERTISE_CLIENT_URLS=http://172.16.9.110:2379 11 12systemctl enable --now etcd é…ç½® etcdï¼š\n1vi /root/etcd.sh 2{ \u0026#34;Network\u0026#34;: \u0026#34;10.10.0.0/16\u0026#34;,\u0026#34;SubnetLen\u0026#34;: 24,\u0026#34;Backend\u0026#34;: {\u0026#34;Type\u0026#34;:\u0026#34;vxlan\u0026#34;} } 3 4etcdctl --endpoints=http://172.16.9.110:2379 set kubernetesâ€‘cluster/network/config \u0026lt; /root/etcd.sh 5 6etcdctl ls kubernetesâ€‘cluster/network/config 7 8curl -s http://172.16.9.110:2379/v2/keys/kubernetesâ€‘cluster/network/subnets è§£é‡Šä¸€ä¸‹ï¼špod çš„ç½‘æ®µæ˜¯ 10.10.0.0/16ï¼Œæ©ç æ˜¯ /16 ï¼Œæœ¬åœ° Node ä¸»æœºçš„æ©ç æ˜¯/24ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€å°å®¿ä¸»æœºä¸Šæœ€å¤šäº§256å°containerã€‚\nç„¶å etcd çš„ key æ˜¯ kubernetesâ€‘cluster/network\n2ã€ç„¶åè£… flannelï¼š æ³¨æ„ etcd çš„é…ç½®è·Ÿä¸Šé¢ä¸€è‡´ï¼š\n1yum install flannel -y 2 3cp /etc/sysconfig/flanneld/etc/sysconfig/flanneld.bak 4 5vi/etc/sysconfig/flanneld 6FLANNEL_ETCD_ENDPOINTS=http://172.16.9.110:2379 7FLANNEL_ETCD_PREFIX=\u0026#34;kubernetesâ€‘cluster/network\u0026#34; 8 9systemctl enable --now flanneld 3ã€é‡å¯Docker ç¼–è¾‘dockerå¯åŠ¨é…ç½®æ–‡ä»¶ï¼š\n1cat /run/flannel/subnet.env 2FLANNEL_NETWORK=10.10.0.0/16 3FLANNEL_SUBNET=10.10.1.1/24 4FLANNEL_MTU=1450 5FLANNEL_IPMASQ=false 6 7/usr/lib/systemd/system/docker.service 8 9# Add: --bip= and --mtu= 10 11vi /usr/lib/systemd/system/docker.service 12dockerd --bip=$FLANNEL_SUBNET --mtu=$FLANNEL_MTU 13 14æˆ–è€… 15cat /run/flannel/docker 16DOCKER_OPT_BIP=\u0026#34;â€‘â€‘bip=10.10.1.1/24\u0026#34; 17DOCKER_OPT_IPMASQ=\u0026#34;â€‘â€‘ipâ€‘masq=true\u0026#34; 18DOCKER_OPT_MTU=\u0026#34;â€‘â€‘mtu=1450\u0026#34; 19DOCKER_NETWORK_OPTIONS=\u0026#34; â€‘â€‘bip=10.10.1.1/24 â€‘â€‘ipâ€‘masq=false â€‘â€‘mtu=1450 \u0026#34; 20 21cat /etc/systemd/system/docker.service.d/docker.conf 22ServiceEnvironmentFile=â€‘/etc/sysconfig/docker 23EnvironmentFile=â€‘/etc/sysconfig/dockerâ€‘storage 24EnvironmentFile=â€‘/etc/sysconfig/dockerâ€‘network 25EnvironmentFile=â€‘/run/flannel/docker 26ExecStart= 27ExecStart=/usr/bin/dockerd $OPTIONS 28 $DOCKER_STORAGE_OPTIONS 29 $DOCKER_NETWORK_OPTIONS 30 $BLOCK_REGISTRY 31 $INSECURE_REGISTRY ç„¶åå°±å¯ä»¥äº†ã€‚\né‚£ä¹ˆä¸ºä»€ä¹ˆ flannel ä¸ç”¨ UDP å‘¢ï¼Ÿ\nçœ‹ä¸Šå›¾ï¼ŒåŒ…ä»ç”¨æˆ·ç©ºé—´åˆ°å†…æ ¸ç©ºé—´çš„æµå…¥æµå‡ºï¼Œä¼šç»è¿‡1ã€2ã€3çš„æ¥å›æ‹·è´ç¿»è½¬ï¼Œæ€§èƒ½æŸå¤±è¾ƒå¤§ï¼Œæ‰€ä»¥ UDP åªèƒ½ç”¨åœ¨æµ‹è¯•ç¯å¢ƒã€‚\næœ€å flannel çš„ VXLAN å’Œ HOST-GW åˆæœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ\n ä¸ vxlan ä¸åŒï¼Œhost-gw ä¸ä¼šå°è£…æ•°æ®åŒ…ï¼Œè€Œæ˜¯åœ¨ä¸»æœºçš„è·¯ç”±è¡¨ä¸­åˆ›å»ºåˆ°å…¶ä»–ä¸»æœº subnet çš„è·¯ç”±æ¡ç›®ï¼Œä»è€Œå®ç°å®¹å™¨è·¨ä¸»æœºé€šä¿¡ host-gw æŠŠæ¯ä¸ªä¸»æœºéƒ½é…ç½®æˆç½‘å…³ï¼Œä¸»æœºçŸ¥é“å…¶ä»–ä¸»æœºçš„ subnet å’Œè½¬å‘åœ°å€ã€‚ vxlan åˆ™åœ¨ä¸»æœºé—´å»ºç«‹éš§é“ï¼Œä¸åŒä¸»æœºçš„å®¹å™¨éƒ½åœ¨ä¸€ä¸ªå¤§çš„ç½‘æ®µå†…ï¼ˆæ¯”å¦‚ 10.2.0.0/16ï¼‰ã€‚ è™½ç„¶ vxlan ä¸ host-gw ä½¿ç”¨ä¸åŒçš„æœºåˆ¶å»ºç«‹ä¸»æœºä¹‹é—´è¿æ¥ï¼Œä½†å¯¹äºå®¹å™¨åˆ™æ— éœ€ä»»ä½•æ”¹å˜ã€‚ ç”±äº vxlan éœ€è¦å¯¹æ•°æ®è¿›è¡Œé¢å¤–æ‰“åŒ…å’Œæ‹†åŒ…ï¼Œæ€§èƒ½ä¼šç¨é€Šäº host-gwã€‚  ","date":"2022-03-17","img":"","permalink":"https://bajie.dev/posts/20220317-kubernetes_flannel/","series":null,"tags":null,"title":"Kubernetesä¸‹Flannelç½‘ç»œ"},{"categories":null,"content":"æœ‰ V2EX çš„å›å‹é—®åˆ°å¦‚ä½•é™æ€ç¼–è¯‘ keepalived çš„é—®é¢˜ï¼Œå®é™…ä¸Š keepalived ç¡®å®é…ç½®æ¯”è¾ƒéº»çƒ¦ã€‚é‚£è¿˜æœ‰ä¸€ä¸ªç®€å•æ˜“è¡Œçš„ ucarpï¼Œç”Ÿäº§ä¹Ÿå¯ä»¥ç”¨è¿™ä¸ªã€‚\nucarp è·Ÿ keepalived ä¸€æ ·ï¼Œéƒ½æ˜¯ç”¨äºé«˜å¯ç”¨çš„ IP æ¼‚ç§»\nä½†æ˜¯æ¯” keepalived é…ç½®ç®€å•ï¼Œè€Œä¸” opnsense å°±æ˜¯ç”¨çš„è¿™ä¸ªåšçš„é«˜å¯ç”¨ï¼Œopnsense æ˜¯ä¸ªéå¸¸å¯é çš„é˜²ç«å¢™è½¯ä»¶ã€‚\né¦–å…ˆæœ‰ä¸¤å°è™šæœºï¼Œ172.18.19.1å’Œ172.18.19.2ï¼Œè™šæ‹Ÿipæ˜¯172.18.19.3\nå…ˆé…ç½®172.18.19.1\n1yum install epel-release 2yum install psmisc 3yum install ucarp 4 5cat\u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; /etc/systemd/system/ucarp.service 6[Unit] 7Description=UCARP virtual interface 8After=network.target 910[Service] 11Type=simple 12ExecStart=/usr/local/bin/ucarp.sh 13RemainAfterExit=true 14ExecStop=/usr/bin/killall -SIGTERM ucarp 15ExecStop=/bin/sleep 10 16TimeoutStopSec=30 17StandardOutput=journal 1819[Install] 20WantedBy=multi-user.target 21EOF 22 23æ³¨æ„ï¼Œä¸Šé¢æˆ‘ä»¬çš„systemdæ˜¯ç›´æ¥è°ƒç”¨äº†ucarp.shæ¥å¯åŠ¨ï¼Œè¿™æ ·æ›´ç®€å•ã€‚ 24ä¸‰ä¸ªè„šæœ¬ï¼Œæ³¨æ„æƒé™æ˜¯755 25 26cat\u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; /usr/local/bin/ucarp.sh 27#!/bin/bash\u0026#39; 28/usr/sbin/ucarp -i eth0 -B -p nb1Dshiwode -v 001 -a 172.18.19.3 -s 172.18.19.1 --shutdown --preempt -u /usr/local/bin/vip-up.sh -d /usr/local/bin/vip-down.sh 29EOF 30 31cat\u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; /usr/local/bin/vip-up.sh 32#!/bin/sh 33/sbin/ip addr add ${2}/24 dev ${1} 34/sbin/ip neigh flush dev ${1} 35EOF 36 37cat\u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; /usr/local/bin/vip-down.sh 38#!/bin/sh 39/sbin/ip addr del ${2}/24 dev ${1} 40/usr/sbin/arp -d ${2} 41EOF 42 43chmod 755 /usr/local/bin/ucarp.sh /usr/local/bin/vip-up.sh /usr/local/bin/vip-down.sh okï¼Œç¬¬ä¸€å°æœºå™¨å°±é…ç½®å¥½äº†\næ‰€æœ‰çš„ä¸œè¥¿éƒ½åœ¨ucarp.shçš„é‚£ä¸€è¡Œçš„å‚æ•°ä¸Šï¼Œç›´æ¥ç”¨ucarp -hæ¥æŸ¥çœ‹\né…ç½®ç¬¬äºŒå°172.18.19.2ï¼Œå…¶ä»–çš„ä¸œè¥¿éƒ½ä¸€æ ·ï¼Œå”¯ä¸€ä¸åŒçš„å°±æ˜¯ucapr.shçš„ä¸€å¤„ä¸ä¸€æ ·\n1cat\u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; /usr/local/bin/ucarp.sh 2#!/bin/bash\u0026#39; 3/usr/sbin/ucarp -i eth0 -B -p nb1Dshiwode -v 001 -a 172.18.19.3 -s 172.18.19.2 --shutdown --preempt -u /usr/local/bin/vip-up.sh -d /usr/local/bin/vip-down.sh 4EOF 5 6# -s 172.18.19.2 æºipå’Œ19.1ä¸åŒ okï¼Œä¸¤å°éƒ½é…ç½®å®Œæ¯•, åˆ†åˆ«æ‰§è¡Œå¯åŠ¨\n1systemctl daemon-reload 2systemctl enable --now ucarp å¯ä»¥å†æ‰¾ä¸€å°æœºå™¨ï¼Œä¸€ç›´é•¿ ping 172.18.19.3ï¼Œç„¶åéšæœºæ€æ‰ 19.1 å’Œ 19.2 ä¸Šé¢çš„ ucarp è¿›ç¨‹ï¼Œå¯ä»¥çœ‹åˆ° vip 172.18.19.3 ä¼šæ¥å›é£˜\næ³¨æ„ï¼šå¦‚æœä¸»æ‰äº†ï¼Œä»æ¥ç®¡äº† vip å˜æˆ masterï¼Œé‚£ä¹ˆä¸»å†èµ·æ¥çš„æ—¶å€™ä¸ä¼šå»æŠ¢ä»çš„ masterã€‚\n","date":"2022-02-25","img":"","permalink":"https://bajie.dev/posts/20220225-ucarp/","series":null,"tags":null,"title":"Ucarpçš„å®‰è£…é…ç½®"},{"categories":null,"content":"ç”¨è¿‡äº†å¥½å‡ ä¸ª tunnel å·¥å…·è½¯ä»¶ï¼Œå„æœ‰é•¿å¤„ã€‚\nghostunnel æ˜¯æ”¯æŒè‡ªå®šä¹‰ tls è¯ä¹¦åŠ å¯†çš„ï¼Œè¿™å›ç”¨ä¸ªæ›´å‰å®³çš„ï¼Œæ”¯æŒå„ç§ä»£ç†é“¾æ¡çš„ï¼Œgost\né¡¹ç›®åœ°å€ï¼šhttps://github.com/ginuerzh/gost\né‡Œé¢çš„æ¦‚å¿µæœ‰ç‚¹æ„æ€ï¼Œå…¶å®å°±ä¸¤æ¡ï¼Œ-L æœ¬åœ°ç›‘å¬ï¼Œ-F é“¾æ¡è½¬å‘ã€‚\næ³¨æ„çš„å°±ä¸€ç‚¹ï¼Œ-F çš„æ—¶å€™å®é™…æ˜¯ä¸€ä¸ªä¸­è½¬æœåŠ¡å™¨ã€‚è¿™ä¸ªä¸­è½¬æœåŠ¡å™¨è¦è½¬å‘çš„è§„åˆ™éœ€è¦åœ¨ -L å‚æ•°é‡ŒæŒ‡å®šã€‚\né‚£ä¹ˆä¸¾ä¸ªå…·ä½“çš„ä¾‹å­ï¼š\nä¸­è½¬æœåŠ¡å™¨å¼€äº†ä¸€ä¸ªæ˜æ–‡ç«¯å£ 9999ï¼Œè¿™ä¸ªç«¯å£è·‘çš„æ˜¯ ghostunnel clientï¼ŒåŠ å¯†æ•°æ®åä¼ åˆ°å¦å¤–ä¸€ä¸ªghostunnel serveræœåŠ¡å™¨ï¼Œç„¶åæ•°æ®æ˜æ–‡ç©¿å‡ºï¼Œè®¿é—®å…·ä½“çš„ç›®çš„ç½‘ç«™çš„ç«¯å£ã€‚\nå®¢æˆ·ç«¯çš„æœåŠ¡å™¨å‘¢æ— å¤–ç½‘è®¿é—®æƒé™ï¼Œéœ€è¦è®¿é—®ä¸­è½¬æœåŠ¡å™¨ 192.168.1.1 çš„ 9999 ç«¯å£ï¼Œç„¶åæ•°æ®é€šè¿‡ ghostunnel åŠ å¯†ç©¿å‡ºåˆ°å¤–ç½‘ã€‚\nä¸­è½¬æœåŠ¡å™¨é…ç½®å¦‚ä¸‹ï¼š\n1# ghostunnel ç›‘å¬æœ¬åœ°ç¯å›åœ°å€çš„9999ç«¯å£ï¼ŒTLS åŠ å¯†ç©¿è¶Šåˆ°å¤–ç½‘110.114.5.19:9999ï¼Œç„¶åæ ¹æ®å¤–ç½‘ server é‡Œé¢çš„é…ç½®ï¼Œåˆ°è¾¾æœ€ç»ˆç›®çš„åœ° ip å’Œ ç«¯å£ 2ghostunnel client --listen localhost:9999 --target 110.114.5.19:9999 --keystore client.pem --cacert ca.pem --unsafe-listen 3 4# gost ç›‘å¬æœ¬åœ°ç½‘å¡192.168.1.1çš„9999ç«¯å£ 5gost-linux-amd64-2.11.1 -L=tls://192.168.1.1:9999 å®¢æˆ·ç«¯é…ç½®å¦‚ä¸‹ï¼š\n1gost-linux-amd64-2.11.1 -L=tcp://localhost:9999/localhost:9999 -F=tls://192.168.1.1:9999 è¿™æ ·å®¢æˆ·ç«¯çš„ç¨‹åºï¼Œåªè¦è¿æ¥ localhost:9999 çš„ tcp ç«¯å£ï¼Œå°±å¯ä»¥æ¥åŠ›ä¸­è½¬æœåŠ¡å™¨ç©¿å‡ºå»äº†ã€‚\nä¸Šé¢çš„é…ç½®éå¸¸æ€ªå¼‚å§ï¼Œä»”ç»†è§£é‡Šä¸€ä¸‹ï¼š\nä¸­è½¬æœåŠ¡å™¨å‘¢æœ‰ä¸¤ä¸ªåœ°å€ï¼Œlocalhostçš„ç¯å›åœ°å€ï¼Œä»¥åŠæœ¬åœ°ç½‘å¡192.168.1.1\nlocalhost:9999 æ˜¯ç”¨ ghostunnel åŠ å¯† tcp æµé‡ï¼Œtls ç©¿åˆ°å¤–ç½‘ 110.114.5.19 çš„ 9999 ç«¯å£ï¼Œç„¶åå¤–ç½‘å†è½¬å‘ã€‚\nä¸­è½¬æœåŠ¡å™¨åŒæ—¶ç›‘å¬äº†ä¸€ä¸ª 192.168.1.1:9999 ç«¯å£ tls çš„åŠ å¯†ä»£ç†ç«¯å£ã€‚\nä¸­è½¬æœåŠ¡å™¨çš„éƒ¨åˆ†å°±å®Œäº†ã€‚\nè€Œå®¢æˆ·ç«¯é…ç½® -L = tcp://localhost:9999/localhost:9999\nç¬¬ä¸€ä¸ª localhost:9999 æŒ‡çš„æ˜¯æœ¬æœºçš„åœ°å€ï¼Œç¬¬äºŒä¸ª localhost:9999 æŒ‡çš„æ˜¯ä¸­è½¬æœºä¸Šé¢çš„è½¬å‘åœ°å€ï¼Œè¿™ä¸ªåœ°æ–¹éå¸¸è®©äººè¿·æƒ‘ã€‚\nå¼ºè°ƒä¸€ä¸‹ï¼šä¸­è½¬ä»£ç†çš„è½¬å‘é…ç½®æ˜¯åœ¨å®¢æˆ·ç«¯è®¾ç½®ï¼Œè€Œä¸æ˜¯ä¸­è½¬ä»£ç†ä¸Šè®¾ç½®ã€‚ ç„¶å -F æŒ‡å®šäº†ä¸­è½¬æœåŠ¡å™¨ï¼Œå°±å¯ä»¥äº†ã€‚\næœ€åä¸€ä¸ªè¦æ³¨æ„çš„åœ°æ–¹ï¼Œä»£ç†åè®®æ— è®ºæ˜¯ tls ã€kcp ç­‰ï¼Œéƒ½è‡ªå¸¦ç¼ºçœçš„è¯ä¹¦ï¼Œå¦‚æœä¸æ»¡æ„ï¼Œå¯ä»¥è‡ªå·±æŒ‡å®šçš„ã€‚è¿™ä¸ªå·¥å…·ä¸ç”¨ç‰¹æ„ç”Ÿæˆè¯ä¹¦æ¥ä½¿ç”¨ã€‚\n","date":"2022-02-24","img":"","permalink":"https://bajie.dev/posts/20220224-gost_tunnel/","series":null,"tags":null,"title":"Gost Tunnelçš„ä½¿ç”¨"},{"categories":null,"content":"è¿™ä¸ªéœ€æ±‚ä¹Ÿå¾ˆæœ‰ç‚¹æ„æ€ï¼ŒDBA è¦æ±‚åš MySQL çš„å¸è½½ä»åº“ï¼Œæ•°æ®é‡ä¼šå¾ˆå¤§ï¼Œç¡¬ç›˜ç©ºé—´åæœŸéœ€è¦æ‰©å®¹ï¼Œä½†æ˜¯ cpu åå€’å çš„ä¸å¤šã€‚\nå•ç‹¬ MySQL æ˜¯æ— æ³•é™åˆ¶å…¶ CPU æ ¸ä½¿ç”¨çš„ï¼Œè¿™æ ·çš„è¯ï¼Œæœ€å¥½å°±æ˜¯åšä¸ªè™šæœºæ¥æ§åˆ¶ MySQL æ€» CPU æ ¸æ•°çš„ä½¿ç”¨ï¼Œç„¶åç¡¬ç›˜æ‰©å®¹çš„è¯ï¼Œæ¯”å¦‚è¦æ‹‰ä¼¸è™šæœºçš„é™„åŠ ç¬¬äºŒå—ç¡¬ç›˜ï¼Œå¦‚æœæ˜¯ QEMU æ ¼å¼ï¼Œä¼šèŠ±è´¹å¾ˆé•¿æ—¶é—´ï¼Œæ‰€ä»¥å¹²è„†æŠŠå®¿ä¸»æœºçš„ç›®å½•ç›´æ¥é€ä¼ è¿›è™šæœºï¼Œä¹‹åå¦‚æœè¦æ‰©å®¹åŠ ç¡¬ç›˜ï¼Œç›´æ¥æŠŠæ–°çš„å¤§ç¡¬ç›˜ mount å‡ºæ¥å†é€è¿›å»å³å¯ï¼Œæ–°æ—§ç¡¬ç›˜æ‹·è´æ•°æ®ä¹Ÿæ¯”æ‹‰ä¼¸è™šæœºç¡¬ç›˜å¿«ã€‚\nCentOS7 ä¸‹çš„åšæ³•å¦‚ä¸‹ï¼š\nä¸¤ä¸ªå¤§å‰æï¼š\nä¸€ã€å®¿ä¸»æœºçš„ KVM qemu ç³»ç»Ÿéœ€è¦ä½¿ç”¨æ–°çš„ rpm åŒ…ï¼Œéœ€è¦ç¼–è¯‘\näºŒã€è™šæœºçš„å†…æ ¸éœ€è¦å‡çº§ï¼Œmount å‘½ä»¤éœ€è¦æ”¯æŒ -t p9 çš„æ–°æ ¼å¼\næˆ‘ä»¬åšå¥½å‡†å¤‡ï¼Œå°±å¯ä»¥å¼€å§‹äº†\nä¸€ã€ç¼–è¯‘å®¿ä¸»æœºçš„qemuæ–°åŒ… ç°åœ¨å·²ç»æ˜¯2022å¹´äº†ï¼Œæ‰€ä»¥ç¼–è¯‘çš„æ–¹å¼ä¹Ÿå‘ç”Ÿå˜åŒ–äº†ï¼Œæœ€ä½³ç¼–è¯‘æ–¹å¼æ˜¯å¹²è„†å¯åŠ¨ä¸€ä¸ª Docker è™šæ‹Ÿæœºï¼Œæ¥ç¼–è¯‘å‡ºæ¥ rpm åŒ…ï¼Œä¹Ÿä¸æ±¡æŸ“ç¯å¢ƒã€‚\né¦–å…ˆå…‹éš†ä¸‹æ¥é¡¹ç›®ï¼š\n1git clone https://github.com/AlekseyChudov/qemu-kvm-virtfs.git 2 3cd qemu-kvm-virtfs 4 çœ‹ä¸€ä¸‹æœ€åçš„ build è„šæœ¬ï¼Œæœ‰ä¸€ä¸ªåœ°æ–¹éœ€è¦ä¿®æ”¹ï¼š\nç°åœ¨çš„ CentOS æœ€æ–°ç‰ˆæ˜¯ 7.9.2009 ï¼Œè¿™ä¸ªç‰ˆæœ¬æ ‘é‡Œæ˜¯æ²¡æœ‰ qemu çš„ Source Code çš„ï¼Œéœ€è¦ä¿®æ”¹ baseurlï¼Œé™ä½åˆ° 7.8.2003 æ‰æœ‰ Source çš„ repo\n1baseurl=https://mirrors.tripadvisor.com/centos-vault/centos/\\$releasever/virt/Source/kvm-common/ 2 3æ”¹æˆï¼š 4 5baseurl=https://mirrors.tripadvisor.com/centos-vault/centos/7.8.2003/virt/Source/kvm-common/ æ”¹å¥½å build è„šæœ¬å¦‚ä¸‹\n1#!/bin/bash 2 3set -ex 4 5yum -y update 6 7yum -y install \\ 8 \u0026#34;@Development Tools\u0026#34; \\ 9 centos-release-qemu-ev \\ 10 glusterfs-api-devel \\ 11 glusterfs-devel \\ 12 iasl \\ 13 kernel-devel \\ 14 libcacard-devel \\ 15 libepoxy-devel \\ 16 mesa-libgbm-devel \\ 17 nss-devel \\ 18 spice-protocol \\ 19 spice-server-devel \\ 20 usbredir-devel 21 22cat \u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; /etc/yum.repos.d/CentOS-QEMU-EV.repo 23[centos-qemu-ev-source] 24name=CentOS-\\$releasever - QEMU EV Sources 25baseurl=https://mirrors.tripadvisor.com/centos-vault/centos/7.8.2003/virt/Source/kvm-common/ 26gpgcheck=1 27enabled=0 28gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-SIG-Virtualization 29EOF 30 31yum-builddep -y qemu-kvm-ev 32 33yumdownloader --source qemu-kvm-ev 34 35rpm -Uvh qemu-kvm-ev-*.src.rpm 36 37sed -i \u0026#39;s/--disable-virtfs/--enable-virtfs/\u0026#39; /root/rpmbuild/SOURCES/build_configure.sh 38 39sed -i -e \u0026#39;/^%files -n qemu-kvm-common/,/^$/s/^$/%{_bindir}\\/virtfs-proxy-helper\\n%{_mandir}\\/man1\\/virtfs-proxy-helper.1.gz\\n/\u0026#39; \\ 40 -e \u0026#39;/^%if %{rhev}$/,/^%else$/s/pkgsuffix -ev/pkgsuffix -virtfs/\u0026#39; \\ 41 -e \u0026#39;/%define rhel_rhev_conflicts()/ a Provides: %1-ev = %{epoch}:%{version}-%{release} \\\\\\nObsoletes: %1-ev \u0026lt; %{obsoletes_version} \\\\\u0026#39; \\ 42 /root/rpmbuild/SPECS/qemu-kvm.spec 43 44rpmbuild -ba --clean /root/rpmbuild/SPECS/qemu-kvm.spec ç„¶åä¸€å¥è¯æ‰§è¡Œ Buildï¼š\n1cd qemu-kvm-virtfs 2 3docker run -it --privileged -v \u0026#34;$PWD/rpmbuild:/root/rpmbuild\u0026#34; \\ 4 docker.io/centos:7 /root/rpmbuild/build 5 6ä¼šå¾—åˆ°å¦‚ä¸‹çš„åŒ…ï¼Œç‰ˆæœ¬æ˜¯ 2.12.0-44.1.el7_8.1 ï¼š 7 8rpmbuild/RPMS/x86_64/qemu-img-virtfs-2.12.0-44.1.el7_8.1.x86_64.rpm 9rpmbuild/RPMS/x86_64/qemu-kvm-common-virtfs-2.12.0-44.1.el7_8.1.x86_64.rpm 10rpmbuild/RPMS/x86_64/qemu-kvm-tools-virtfs-2.12.0-44.1.el7_8.1.x86_64.rpm 11rpmbuild/RPMS/x86_64/qemu-kvm-virtfs-2.12.0-44.1.el7_8.1.x86_64.rpm 12rpmbuild/RPMS/x86_64/qemu-kvm-virtfs-debuginfo-2.12.0-44.1.el7_8.1.x86_64.rpm 13rpmbuild/SRPMS/qemu-kvm-virtfs-2.12.0-44.1.el7_8.1.src.rpm 14 æˆ‘ä»¬åœ¨å®¿ä¸»æœºä¸Šå®‰è£…æ›¿æ¢æ–°çš„ qemu åŒ…ï¼Œå¹¶é‡å¯ libvirtd\n1yum -y install \\ 2 cloud-utils \\ 3 libvirt-client \\ 4 libvirt-daemon-config-network \\ 5 libvirt-daemon-config-nwfilter \\ 6 libvirt-daemon-driver-interface \\ 7 libvirt-daemon-driver-qemu \\ 8 virt-install \\ 9 rpmbuild/RPMS/x86_64/qemu-img-virtfs-2.12.0-44.1.el7_8.1.x86_64.rpm \\ 10 rpmbuild/RPMS/x86_64/qemu-kvm-common-virtfs-2.12.0-44.1.el7_8.1.x86_64.rpm \\ 11 rpmbuild/RPMS/x86_64/qemu-kvm-virtfs-2.12.0-44.1.el7_8.1.x86_64.rpm 12 13systemctl restart libvirtd è¿™æ ·å®¿ä¸»æœºå°±å‡†å¤‡å¥½äº†ã€‚\näºŒã€ç”Ÿäº§è™šæœºï¼Œåšå¥½passthrough ç”Ÿäº§è™šæœºçš„æ—¶å€™ï¼Œéœ€è¦åšå¥½å†…å¤–æ–‡ä»¶ç›®å½•çš„ç›´é€šï¼Œå®¿ä¸»æœºç›®å½•æ˜¯ /opt/testï¼Œå¯¹åº”è™šæœºç›®å½•æ˜¯ /test\n1\u0026lt;domains ...\u0026gt; 2 ... 3 \u0026lt;devices ...\u0026gt; 4 \u0026lt;filesystem type=\u0026#39;mount\u0026#39; accessmode=\u0026#39;passthrough\u0026#39;\u0026gt; 5 \u0026lt;source dir=\u0026#39;/opt/test\u0026#39;/\u0026gt; 6 \u0026lt;target dir=\u0026#39;/test\u0026#39;/\u0026gt; 7 \u0026lt;/filesystem\u0026gt; 8 \u0026lt;/devices\u0026gt; 9\u0026lt;/domains\u0026gt; è™šæœºå¯åŠ¨åï¼Œéœ€è¦å‡çº§æ ¸å¿ƒï¼Œæ”¯æŒæ–°çš„ mount é€‰é¡¹\n1yum -y update 2yum -y --enablerepo centosplus install kernel-plus 3reboot 4 5# æŠŠå®¿ä¸»æœºæä¾›çš„ /test ç‚¹ mount å‡ºæ¥ 6mount -t 9p -o trans=virtio,version=9p2000.L /test /opt/test ä¹Ÿå¯ä»¥æŠŠæŒ‚è½½ç‚¹å†™è¿›è™šæœºçš„ fstabï¼Œä¸‹æ¬¡å°±ä¼šè‡ªåŠ¨ mount äº†\n1/test /opt/test 9p trans=virtio,version=9p2000.L,nofail,_netdev,x-mount.mkdir 0 0 ","date":"2022-02-23","img":"","permalink":"https://bajie.dev/posts/20220223-kvm_passthrouth/","series":null,"tags":null,"title":"KVMä¸‹å®¿ä¸»æœºçš„ç›®å½•ç›´é€šåˆ°è™šæœº"},{"categories":null,"content":"è¿™æ˜¯ä¸ªä¸¥è‚ƒè¯é¢˜ï¼Œæ­£ç»æŒ–ä»¥å¤ªå¸çš„è¯ï¼Œå¾ˆå¤šçš„çŸ¿å‚éƒ½æ˜¯å¦‚æœç›´æ¥æŒ–åˆ°ä»¥å¤ªå¸åœ°å€ï¼Œé‚£ä¹ˆå¿…é¡»æŒ–åˆ°å®Œæ•´ä¸€ä¸ªæ‰å…è®¸æç°ï¼Œæ‰‹ç»­è´¹è¿˜ç‰¹é«˜ã€‚\nä½†æ˜¯å¦‚æœæŒ–åˆ°ä»¥å¤ªé“¾Polygonçš„åœ°å€çš„è¯ï¼Œå°±å¯ä»¥ 0.005 ETHæå¸äº†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º\nä½†æ˜¯åƒä¸‡è®°ä½ï¼ŒPolygonæå‡ºçš„æ‰€è°“ 0.005 ETHï¼Œçœ‹ä¸‹å›¾ï¼Œåªæ˜¯ä¸ªERC-20çš„Tokenï¼Œå®é™…æ˜¯wETH Tokenï¼Œå¿…é¡»ç»è¿‡è½¬æ¢æ‰èƒ½æåˆ° ETH å»ã€‚\nä» ERC-20 è½¬æ¢åˆ°å…¶å®ƒä»£å¸å‘¢ï¼Œéœ€è¦ MATIC ä»£å¸æ¥ä»˜è´¦ï¼Œè¿™ç©æ„ä¹Ÿå¿…é¡»å¾—æœ‰å•Šï¼åºŸè¯ä¸å¤šè¯´ï¼Œç›´æ¥æ”¾ä¸ŠæŒ–MATICæ•™ç¨‹ï¼Œæˆ‘çš„æœºå™¨æ˜¯ CentoOS\né¦–å…ˆéœ€è¦æœ‰ä¸ªå®Œå…¨è‡ªä¸»çš„çš„ ETH é’±åŒ…åœ°å€ï¼Œè¿™ä¸ªæˆ‘å°±ä¸æ•™å¤§å®¶äº†\nä¸€ã€ä¸‹è½½xmrigæŒ–çŸ¿è½¯ä»¶ ä¸‹è½½åœ°å€ï¼šhttps://github.com/xmrig/xmrig/releases\næˆ‘ä»¬é€‰æ‹©æœ€è¿‘çš„ä¸‹è½½å°±å¥½\näºŒã€åšå¥½åŠ å¯†é€šé“ æˆ‘ä»¬éœ€è¦åšå¥½ä¸€æ¡åŠ å¯†tcpé€šé“\nç”¨ ghostunnel, localhost:9012 \u0026mdash;\u0026gt; vps:9012 \u0026mdash;\u0026gt; rx.unmineable.com:3333\nä¸‰ã€ç”¨screenåå°å¼€æŒ– 1screen 2 3#./xmrig -o localhost:9999 -a rx -k -u DOGE:MATICåœ°å€.çŸ¿å·¥å 4./xmrig -o localhost:9012 -u MATIC:0x64358C7ddC96001697aBbA7ed431BADB6ABAaec5.cpu01 -p x --cpu-no-yield 5 6ctrl+a+d å››ã€æŸ¥çœ‹æŒ–äº†å¤šå°‘ æŸ¥çœ‹åœ°å€ï¼šhttps://unmineable.com/coins/MATIC/address/ äº”ã€å…‘æ¢ æŒ–åˆ°äº†è¶³å¤Ÿçš„ MATICï¼Œå°±å¯ä»¥æ„‰å¿«çš„å…‘æ¢äº†ã€‚\n","date":"2022-02-22","img":"","permalink":"https://bajie.dev/posts/20220222-eth_matic/","series":null,"tags":null,"title":"å¦‚ä½•ç”¨CPUæŒ–Polygonç½‘ç»œçš„MATICå¸"},{"categories":null,"content":"å…¬å¸è¦åšé˜¿é‡Œçš„å°ç¨‹åºæ¥å…¥ï¼Œéœ€è¦é€šè¿‡æµ‹è¯•ï¼Œæµ‹è¯•å‘¢éœ€è¦æä¾›ç¡¬ç›˜çš„ç›‘æ§æŠ¥å‘Šï¼Œæ¯”å¦‚ iops ã€‚\nåŒäº‹ä»ç½‘ä¸Šæ‰¾äº†ä¸€ä¸‹ï¼Œiops ç›‘æ§åŸæ–‡å¦‚ä¸‹ï¼šç›‘æ§ç£ç›˜çš„ iops ï¼Œåˆ©ç”¨ linux çš„ /proc/diskstats çš„ç¬¬å››ä¸ªå­—æ®µå’Œç¬¬å…«å­—æ®µå¯ç›‘æ§è¯»å’Œå†™çš„ iopsï¼Œç¬¬å››ä¸ªè®°å½•æ˜¯è®°å½•æ‰€æœ‰è¯»çš„æ¬¡æ•°ï¼Œç¬¬å…«ä¸ªå­—æ®µæ˜¯è®°å½•æ‰€æœ‰å†™çš„æ¬¡æ•°ã€‚é€šè¿‡ zabbix ä¸Šçš„å·®é€Ÿç‡å³å¯ç›‘æ§ç£ç›˜çš„ iopsã€‚\næ–‡ç« é“¾æ¥ï¼šhttps://cloud.tencent.com/developer/article/1519113?ivk_sa=1024320u ä»”ç»†ç ”ç©¶äº†ä¸€ä¸‹ä¸Šé¢çš„æ–‡ç« ï¼Œçœ‹äº†å®ƒæä¾›äº†ä¸¤å¼ ç›‘æ§å›¾ï¼Œåˆ†æä¸€ä¸‹ï¼š\nç¬¬ä¸€å¼ å›¾ï¼š\næœ‰ä¸¤ä¸ªæŒ‡æ ‡ï¼Œç»¿è‰²çš„æ˜¯ç¡¬ç›˜æ¯ç§’çš„ io è¯»æ¬¡æ•°ï¼Œçº¢è‰²çš„æ˜¯ç¡¬ç›˜æ¯ç§’çš„ io å†™æ¬¡æ•°ã€‚\nç¬¬äºŒå¼ å›¾ï¼š\nåŒæ ·ä¸¤ä¸ªæŒ‡æ ‡ï¼Œç»¿è‰²çš„æ˜¯ç¡¬ç›˜æ¯ç§’çš„ io è¯» Bytesï¼Œçº¢è‰²çš„æ˜¯ç¡¬ç›˜æ¯ç§’çš„ io å†™ Bytesã€‚\nçŸ¥é“äº†æŒ‡æ ‡å…·ä½“çš„å«ä¹‰ï¼Œè¿™æ ·å°±å¥½åŠäº†ã€‚\næˆ‘ä»¬ç”¨çš„æ˜¯ prometheus å’Œ node_exporter\né¦–å…ˆå»çœ‹çœ‹ node_exporter æš´éœ²çš„æŒ‡æ ‡ï¼Œæœä¸€æœ node_diskï¼Œä¼šçœ‹åˆ°å¦‚ä¸‹4ä¸ªæŒ‡æ ‡ï¼š\n1# HELP node_disk_reads_completed_total The total number of reads completed successfully. 2# TYPE node_disk_reads_completed_total counter 3node_disk_reads_completed_total{device=\u0026#34;sda\u0026#34;} 4.9530358e+07 4# HELP node_disk_writes_completed_total The total number of writes completed successfully. 5# TYPE node_disk_writes_completed_total counter 6node_disk_writes_completed_total{device=\u0026#34;sda\u0026#34;} 1.4449267304e+10 7 8# HELP node_disk_read_bytes_total The total number of bytes read successfully. 9# TYPE node_disk_read_bytes_total counter 10node_disk_read_bytes_total{device=\u0026#34;sda\u0026#34;} 6.4101677568e+11 11# HELP node_disk_written_bytes_total The total number of bytes written successfully. 12# TYPE node_disk_written_bytes_total counter 13node_disk_written_bytes_total{device=\u0026#34;sda\u0026#34;} 1.15483858333184e+14 14 å¯ä»¥çœ‹å‡ºæ˜¯ä¸Šé¢ 4 ä¸ªæŒ‡æ ‡ï¼Œè¿™å››ä¸ªæŒ‡æ ‡éƒ½æ˜¯ counter è®¡æ•°å™¨ç±»å‹çš„ï¼Œéƒ½æ˜¯åªå¢ä¸å‡çš„ã€‚\nç„¶åå» prometheus ï¼Œç”»ä¸ªå›¾è¯•è¯•ï¼Œquery åˆ†åˆ«å¦‚ä¸‹ï¼ˆæ³¨æ„æˆ‘ä»¬çš„ instance å³ node_exporterï¼Œæ˜¯è·‘åœ¨äº† 50000 ç«¯å£ï¼Œæ˜¯éæ ‡å‡†çš„ï¼‰ï¼š\n1node_disk_reads_completed_total{instance=\u0026#34;192.168.1.1:50000\u0026#34;} 2node_disk_writes_completed_total{instance=\u0026#34;192.168.1.1:50000\u0026#34;} 3 4node_disk_read_bytes_total{instance=\u0026#34;192.168.1.1:50000\u0026#34;} 5node_disk_written_bytes_total{instance=\u0026#34;192.18.1.1:50000\u0026#34;} å¤§å®¶çœ‹åˆ°äº† counter ç±»å‹ï¼Œå¿…ç„¶æ˜¯ä¸€æ¡æ–œçº¿ç›´å†²å¤©é™…ã€‚\nå¥½äº†ï¼Œæˆ‘ä»¬ç„¶åå» grafana é‡Œå¢åŠ é¢æ¿ï¼š\né€‰ Add Query\nå…ˆé€‰æ•°æ®æºï¼Œé€‰æ‹©ç³»ç»Ÿä¸­å·²ç»é…å¥½çš„ prometheusï¼Œæ€ä¹ˆé…è¿™é‡Œå°±ä¸è¯´äº†ï¼š\nç„¶ååœ¨ Query çš„ Metrics é‡Œå¡«å…¥ node_disk_written_bytes_total{instance=\u0026quot;192.168.1.1:50000\u0026quot;}ï¼š\nåœ¨ Legend çš„ç©ºç™½å¤„éšä¾¿ç‚¹ä¸€ä¸‹ï¼Œå¤§æŠ˜çº¿å‡ºç°äº†ï¼Œè€Œä¸”ç»™å‡ºäº†æç¤ºï¼šTime series is monotonically increasing. Try applying a rate() function.\nå¬äººåŠï¼Œåƒé¥±é¥­ã€‚æˆ‘ä»¬æ”¹ä¸€ä¸‹ Metrics çš„æŸ¥è¯¢è¯­å¥ï¼Œå› ä¸ºæˆ‘ä»¬æ˜¯5åˆ†é’ŸæŠ“ä¸€æ¬¡æ•°æ®ï¼Œæ‰€ä»¥æ”¹æˆå¦‚ä¸‹æ ¼å¼ï¼š rate(node_disk_written_bytes_total{instance=\u0026quot;192.18.1.1:50000\u0026quot;}[5m])\nå†å¢åŠ ä¸€ä¸ªæŸ¥è¯¢ï¼ŒAdd Query åŒæ—¶æŠŠ read bytes å’Œ write bytes æ”¾è¿›ä¸€å¼ å›¾å»ï¼š\næœ€åä¿®æ­£ä¸€ä¸‹ï¼š\n1A: 2Metrics: rate(node_disk_read_bytes_total{instance=\u0026#34;192.168.1.1:50000\u0026#34;}[5m]) 3Legend: sda read per second 4 5B: 6Metrics: rate(node_disk_written_bytes_total{instance=\u0026#34;192.168.1.1:50000\u0026#34;}[5m]) 7Legend: sda write per second å†æŠŠæœ€å¤§ã€æœ€å°ã€å¹³å‡ã€å½“å‰ç»™å‡ºæ¥ï¼š\nè¿™æ ·å›¾å°±åšå¥½äº†ï¼Œæœ€åå®Œå·¥çš„ä¸¤å¼ å›¾ï¼š\næ‰€æœ‰ prometheus ä»å„ç§ exporter æ”¶ä¸Šæ¥çš„æ•°æ®éƒ½å¯ä»¥è¿™ä¹ˆå›¾å½¢åŒ–ï¼Œä»¥åç”»å›¾å°±ä¸°ç®€ç”±äººäº†ã€‚\n","date":"2022-01-18","img":"","permalink":"https://bajie.dev/posts/20220118-grafana_prometheus/","series":null,"tags":null,"title":"Grafanaç”»å‡ºprometheusçš„å›¾"},{"categories":null,"content":"æœ€è¿‘å¼€å§‹å¼„hubotï¼Œé¡ºå¸¦ä¹Ÿå¼€å§‹å­¦ä¹  javascript ï¼Œé¦–å…ˆä»å•ç‹¬ä¸€ä¸ª nodejs é¡¹ç›®å¼€å§‹ï¼š\nnvm å’Œ node çš„å®‰è£…ä½¿ç”¨åœ¨å‰é¢å·²ç»è¯´è¿‡äº†ï¼š Nodejså¤šç‰ˆæœ¬çš„å®‰è£…ä¸ç®¡ç† æ–°å»ºä¸€ä¸ªé¡¹ç›®ç›®å½•ï¼Œbuild01\nç„¶ååœ¨å…¶ä¸‹å»ºç«‹å¦‚ä¸‹ç›®å½•ç»“æ„ï¼š\n1mkdir build01 2 3cd build01 4mkdir es6 dist 5 6mkdir public 7cd public 8mkdir es6 dist è§£é‡Šä¸€ä¸‹ï¼Œes6 ä¸‹æ”¾çš„æ˜¯æœåŠ¡å™¨ç«¯çš„æºä»£ç ï¼Œdist ä¸‹æ”¾çš„æ˜¯æœåŠ¡å™¨ç«¯å¤„ç†è¿‡çš„æºä»£ç ã€‚\npublic/es6 æ”¾çš„æ˜¯æµè§ˆå™¨ç«¯çš„æºä»£ç ï¼Œpublic/dist æ”¾çš„æ˜¯æµè§ˆå™¨ç«¯å¤„ç†è¿‡çš„æºä»£ç ã€‚\nä¸€ã€å®‰è£…gulpå’Œbabel babel æ˜¯ç”¨æ¥åš js æ ¼å¼è½¬æ¢çš„ï¼Œæ³¨æ„ï¼ŒåŸæœ‰çš„ babel-preset-es2015 å·²ç»ä¸é€‚ç”¨äº†ã€‚\n1npm install --save-dev gulp gulp-babel babel-preset-env@next ç”Ÿæˆä¸€ä¸ª.babelrc æ–‡ä»¶ï¼Œå†…å®¹å°±ä¸€è¡Œ\n1{ \u0026#34;presets\u0026#34;: [\u0026#34;env\u0026#34;] } åœ¨ es6 ç›®å½•ä¸‹ï¼Œå»ºç«‹ä¸€ä¸ªæµ‹è¯•çš„ test.js æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š\n1\u0026#39;use strict\u0026#39;; 2 3const sentences = [ 4{ subject: \u0026#39;JavaScript\u0026#39;, verb: \u0026#39;is\u0026#39;, object: \u0026#39;great\u0026#39; }, 5{ subject: \u0026#39;Elephants\u0026#39;, verb: \u0026#39;are\u0026#39;, object: \u0026#39;large\u0026#39; }, 6]; 7 8function say({ subject, verb, object }) { 9 console.log(`${subject} ${verb} ${object}`); 10} 11 12for ( let s of sentences) { 13 say(s); 14} ä»”ç»†çœ‹ï¼Œä¸Šé¢è¿™ä¸ªæ–‡ä»¶ç”¨åˆ°äº† es6 çš„è¯­æ³•ï¼Œå¯¹è±¡çš„è§£æ„ï¼Œofè¯­æ³•ã€‚\næˆ‘ä»¬æ¥ç”¨ babel æŠŠå®ƒè½¬æ¢ä¸€ä¸‹ï¼Œå˜æˆ es5 çš„è¯­æ³•\nåœ¨build01ç›®å½•ä¸‹ï¼Œç”Ÿæˆgulpfile.jsï¼Œå†…å®¹å¦‚ä¸‹ï¼š\n1const gulp = require(\u0026#39;gulp\u0026#39;); 2const babel = require(\u0026#39;gulp-babel\u0026#39;); 3 4 5gulp.task(\u0026#39;default\u0026#39;, done =\u0026gt;{ 6 7 gulp.src(\u0026#34;es6/**/*.js\u0026#34;) 8 .pipe(babel()) 9 .pipe(gulp.dest(\u0026#34;dist\u0026#34;)); 10 11 gulp.src(\u0026#34;public/es6/**/*.js\u0026#34;) 12 .pipe(babel()) 13 .pipe(gulp.dest(\u0026#34;public/dist\u0026#34;)); 14 15 done(); 16 17}); æ³¨æ„ä¸Šé¢ï¼Œ**è¡¨ç¤ºæ´ç©¿æ‰€æœ‰å­ç›®å½•ã€‚è¿è¡Œ gulp ï¼Œå°±ä¼šåœ¨ dist ç›®å½•ä¸‹ç”Ÿæˆæ–°çš„ test.js ï¼Œå†…å®¹å¦‚ä¸‹ï¼š\n1\u0026#39;use strict\u0026#39;; 2 3var sentences = [{ 4subject: \u0026#39;JavaScript\u0026#39;, 5verb: \u0026#39;is\u0026#39;, 6object: \u0026#39;great\u0026#39; 7}, { 8 subject: \u0026#39;Elephants\u0026#39;, 9 verb: \u0026#39;are\u0026#39;, 10 object: \u0026#39;large\u0026#39; 11}]; 12 13function say(_ref) { 14 var subject = _ref.subject, 15verb = _ref.verb, 16object = _ref.object; 17console.log(\u0026#34;\u0026#34;.concat(subject, \u0026#34; \u0026#34;).concat(verb, \u0026#34; \u0026#34;).concat(object)); 18} 19 20for (var _i = 0; _i \u0026lt; sentences.length; _i++) { 21var s = sentences[_i]; 22say(s); 23} ä»”ç»†çœ‹ï¼Œes6 çš„è¯­æ³• å˜æˆ es5 çš„è¯­æ³•äº†ã€‚\näºŒã€å®‰è£…eslint babel æ˜¯å¯¹è¯­æ³•è¿›è¡Œè½¬æ¢ï¼Œé‚£ä¹ˆ eslint å°±æ˜¯å¯¹è¯­æ³•ä½œå‡ºè§„èŒƒï¼Œå¾ˆå¤šäººåƒ airbnb é‚£ä¸€å¥—è§„åˆ™ã€‚\n1npm install --save-dev eslint gulp-eslint gulp-if å®‰è£…å®Œæˆåæ‰§è¡Œå‘½ä»¤è¿›è¡Œåˆå§‹åŒ–ï¼š\n1eslint --init ä¼šæé—®ä¸€å †é—®é¢˜ï¼š\n1How would you like to use ESLint? â€¦ 2â–¸ To check syntax, find problems, and enforce code style 3 4What type of modules does your project use? â€¦ 5â–¸ JavaScript modules (import/export) 6 7Which framework does your project use? â€¦ 8 React 9 Vue.js 10â–¸ None of these 11 12Does your project use TypeScript? â€£ No / Yes 13 14#ä¸¤ä¸ªéƒ½é€‰å“¦ 15Where does your code run? â€¦ (Press \u0026lt;space\u0026gt; to select, \u0026lt;a\u0026gt; to toggle all, \u0026lt;i\u0026gt; to invert selection) 16âœ” Browser 17âœ” Node 18 19How would you like to define a style for your project? â€¦ 20â–¸ Answer questions about your style 21 22âœ” What format do you want your config file to be in? Â· JSON 23âœ” What style of indentation do you use? Â· 4 24âœ” What quotes do you use for strings? Â· single 25âœ” What line endings do you use? Â· unix 26âœ” Do you require semicolons? Â· Yes æœ€åå¾—åˆ°æ–‡ä»¶ .eslintrc.json\n1{ 2 \u0026#34;env\u0026#34;: { 3 \u0026#34;browser\u0026#34;: true, 4 \u0026#34;es2021\u0026#34;: true, 5 \u0026#34;node\u0026#34;: true 6 }, 7 \u0026#34;extends\u0026#34;: \u0026#34;eslint:recommended\u0026#34;, 8 \u0026#34;parserOptions\u0026#34;: { 9 \u0026#34;ecmaVersion\u0026#34;: 13, 10 \u0026#34;sourceType\u0026#34;: \u0026#34;module\u0026#34; 11 }, 12 \u0026#34;rules\u0026#34;: { 13 \u0026#34;indent\u0026#34;: [ 14 \u0026#34;error\u0026#34;, 15 4 16 ], 17 \u0026#34;linebreak-style\u0026#34;: [ 18 \u0026#34;error\u0026#34;, 19 \u0026#34;unix\u0026#34; 20 ], 21 \u0026#34;quotes\u0026#34;: [ 22 \u0026#34;error\u0026#34;, 23 \u0026#34;single\u0026#34; 24 ], 25 \u0026#34;semi\u0026#34;: [ 26 \u0026#34;error\u0026#34;, 27 \u0026#34;always\u0026#34; 28 ] 29 } 30} è¿™é‡Œæ³¨æ„ï¼Œè¦æ”¹ä¸¤ä¸ªåœ°æ–¹ï¼š\n1\u0026#34;es2021\u0026#34;: true, 2æ”¹æˆ 3\u0026#34;es6\u0026#34;: true, 4 5\u0026#34;ecmaVersion\u0026#34;: 13, 6æ”¹æˆ 7\u0026#34;ecmaVersion\u0026#34;: 10, ç„¶åæˆ‘ä»¬æ”¹å†™ä¸€ä¸‹ gulpfile.jsï¼Œå¢åŠ  eslint çš„éƒ¨åˆ†\n1const gulp = require(\u0026#39;gulp\u0026#39;); 2const babel = require(\u0026#39;gulp-babel\u0026#39;); 3const eslint = require(\u0026#39;gulp-eslint\u0026#39;); 4const gulpIf = require(\u0026#39;gulp-if\u0026#39;); 5 6function isFixed(file) { 7 return file.eslint !== null \u0026amp;\u0026amp; file.eslint.fixed; 8} 9 10gulp.task(\u0026#39;default\u0026#39;, done =\u0026gt;{ 11 12 gulp.src([\u0026#34;es6/**/*.js\u0026#34;, \u0026#34;public/**/*.js\u0026#34;]) 13 .pipe(eslint({fix: true})) 14 .pipe(eslint.format()) 15 .pipe(gulpIf(isFixed, gulp.dest(file =\u0026gt; file.base))) 16 .pipe(eslint.failAfterError()); 17 18 19 gulp.src(\u0026#34;es6/**/*.js\u0026#34;) 20 .pipe(babel()) 21 .pipe(gulp.dest(\u0026#34;dist\u0026#34;)); 22 23 gulp.src(\u0026#34;public/es6/**/*.js\u0026#34;) 24 .pipe(babel()) 25 .pipe(gulp.dest(\u0026#34;public/dist\u0026#34;)); 26 27 done(); 28 29}); å†è¿è¡Œ gulp ï¼Œä¼šæŠŠ es6/test.js ç»™æ ¼å¼åŒ–å¥½ï¼Œå¯¹æ¯”ä¸€ä¸‹åŸæ–‡ä»¶å°±çŸ¥é“äº†ï¼Œident è¢«è°ƒæ•´æˆ4ä¸ªç©ºæ ¼äº†ï¼š\n1\u0026#39;use strict\u0026#39;; 2 3const sentences = [ 4 { subject: \u0026#39;JavaScript\u0026#39;, verb: \u0026#39;is\u0026#39;, object: \u0026#39;great\u0026#39; }, 5 { subject: \u0026#39;Elephants\u0026#39;, verb: \u0026#39;are\u0026#39;, object: \u0026#39;large\u0026#39; }, 6]; 7 8function say({ subject, verb, object }) { 9 console.log(`${subject} ${verb} ${object}`); 10} 11 12for ( let s of sentences) { 13 say(s); 14} ","date":"2022-01-04","img":"","permalink":"https://bajie.dev/posts/20220104-javascript_babel_eslint/","series":null,"tags":null,"title":"Javascriptçš„é¡¹ç›®ä¸babelå’Œeslint"},{"categories":null,"content":"Hubotæ˜¯ä¸€ä¸ªé€šç”¨çš„èŠå¤©æœºå™¨äººï¼Œèƒ½å’Œå¾ˆå¤šèŠå¤©è½¯ä»¶é›†æˆï¼Œæ¯”å¦‚slackã€rockchatã€telegramã€ä¼ä¸šå¾®ä¿¡ã€IRCç­‰ã€‚\nå…¬å¸ç”¨çš„æ˜¯ä¼ä¸šå¾®ä¿¡ï¼Œä¹‹å‰ç”¨ç¾¤æœºå™¨äººå’Œ prometheus é›†æˆï¼Œå‘é€å„ç§å‘Šè­¦ä¿¡æ¯ï¼Œä½†æ˜¯ç¾¤æœºå™¨äººæ— æ³•æ¥æ”¶æ¶ˆæ¯ï¼›åŒæ—¶æˆ‘ä»¬æƒ³é›†æˆè¿›å»å¾ˆå¤šè‡ªå®šä¹‰å‘½ä»¤ï¼Œæ¯”å¦‚å‘é€æŒ‡ä»¤å°±å¼€å§‹ jenkins buildï¼Œå‘é€ ansible æŒ‡ä»¤æ‰§è¡Œï¼Œå‘é€æµé‡å›¾å°±è‡ªåŠ¨æŠŠæœºæˆ¿çš„æµé‡å›¾å‘è¿‡æ¥ï¼Œè¿™ä¸ªç¾¤æœºå™¨äººå°±ç”¨ä¸æˆäº†ã€‚æ‰€ä»¥å¿…é¡»å†ç›´æ¥ä¸€äº›ï¼Œæ„å»ºä¸€ä¸ªä¼ä¸šå¾®ä¿¡çš„åº”ç”¨ã€‚\nä¸€ã€ä¼ä¸šå¾®ä¿¡å®‰è£…å‰å‡†å¤‡ å®‰è£…å‰éœ€è¦åœ¨ä¼ä¸šå¾®ä¿¡ä¸­æ‹¿åˆ°4ä¸ªä¿¡æ¯ï¼š\n WECHATWORK_CORP_ID WECHATWORK_APP_AGENT_ID WECHATWORK_APP_SECRET WECHATWORK_AES_KEY  é¦–å…ˆè”ç³»ä¼ä¸šå¾®ä¿¡ç®¡ç†å‘˜æ–°å¢ä¸€ä¸ªåº”ç”¨ï¼š\nåœ¨â€œç®¡ç†åå°-æˆ‘çš„ä¼ä¸šâ€ä¸­å¯ä»¥è·å¾—åœ°ä¸€ä¸ªä¿¡æ¯ï¼Œä¼ä¸š ID ä¿¡æ¯ï¼ŒCORP_ID ï¼š\næ‹¿æ‹¿ åœ¨â€œç®¡ç†åå°-åº”ç”¨ç®¡ç†-ç‚¹å‡»æŸå…·ä½“åº”ç”¨-è¯¦æƒ…â€é¡µä¸­å¯ä»¥è·å¾—äºŒã€ä¸‰ä¸ªä¿¡æ¯ï¼Œ APP_AGENT_ID å’Œ APP_SECRET\nç¬¬å››ä¸ª AES_KEY å°±æ¯”è¾ƒéº»çƒ¦äº†ï¼Œæˆ‘ä»¬è¿›å…¥è¿™ä¸ªåº”ç”¨ï¼Œç‚¹å‡»é…ç½®çš„å›¾æ ‡ï¼š\nç„¶åè¿›å…¥ï¼Œç‚¹å‡»å¯ç”¨ API æ¥æ”¶\nç„¶åè®¾ç½®ä¸€ä¸‹\n url å¡«å†™ https://hubot.rendoumi.com/wechatwork/webhook  Token ç‚¹éšæœºè·å– EncodingAESKey ç‚¹éšæœºè·å–ï¼Œè¿™å°±æ˜¯å…·ä½“çš„ AESKey äº†  ç„¶åç‚¹å‡»ä¿å­˜ï¼Œè¿™é‡Œå¿…ç„¶ä¼šå¤±è´¥ï¼æ²¡æœ‰å…³ç³»ï¼Œå› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰è£…hubotå‘¢ã€‚æˆ‘ä»¬æŠŠè¿™ä¸‰ä¸ªåœ°æ–¹å…ˆè®°å½•ä¸‹æ¥ï¼Œéšåå†æ¥ç‚¹å‡»ä¿å­˜ã€‚\näºŒã€Hubot å®‰è£…å‰å‡†å¤‡ 1ã€æ³¨æ„ä¸Šé¢åœ°å€ï¼šURL åœ°å€æ˜¯ https ï¼Œç„¶å hubot çš„ç¼ºçœåœ°å€æ˜¯ http://xxx:8080 ï¼Œè¿™æ ·å¦‚æœå‰é¢æ²¡æœ‰è¯ä¹¦å¸è½½çš„è®¾å¤‡ï¼Œå°±å¾—æ­å»ºä¸€ä¸ªNginxï¼ˆhaproxyã€traefikï¼‰æ¥ä»£ç† https 443ç«¯å£åˆ°8080ã€‚\n2ã€Hubot æ˜¯æ”¯æŒ Coffeescript å’Œ nodejs çš„ï¼Œä»å®ƒçš„ Adapters ç½‘é¡µçœ‹\nhttps://hubot.github.com/docs/adapters/development/ é‡Œé¢éƒ½æ˜¯ coffee å‘³çš„å•ç®­å¤´å‡½æ•°ï¼Œå¯¼è‡´ä¸å¤ªç†Ÿæ‚‰çš„å…«æˆ’ä»¥ä¸ºåœ¨ wechatwork moduleå¯¼å‡ºçš„æ—¶å€™ä¹Ÿåº”è¯¥ç”¨å•ç®­å¤´å‡½æ•°ï¼Œç»“æœå°±æ‚²å‰§äº†ã€‚\næ‰€ä»¥åŠ¡å¿…æ¸…æ¥šï¼ŒAdapter çš„è¯­æ³•æ˜¯ jsï¼Œæ™®é€šè‡ªå»ºè‡ªåŠ¨å›å¤scriptå¯ä»¥ç”¨coffeescriptï¼Œåé¢ä¼šè¯¦ç»†è¯´è¿™ä¸€ç‚¹ã€‚\n3ã€å®‰è£…Hubotå¿…é¡»æ–°å»ºä¸€ä¸ªæ™®é€šç”¨æˆ·ï¼Œä¸èƒ½ç”¨ root è£…\nç”¨ root ä¼šå¯¼è‡´ nodejs ä¸€å †æŠ¥é”™ï¼Œå…«æˆ’æ–°å»ºäº†ä¸€ä¸ªç”¨æˆ· botï¼Œå®¶ç›®å½•/home/botï¼Œç„¶åå†åœ¨è¿™ä¸‹é¢å»ºç«‹/home/bot/myhubotï¼Œåœ¨è¿™ä¸ªç›®å½•ä¸‹å®‰è£…ã€‚\nç†ç”±æ˜¯è¿™ä¸ªå¦‚æœç›´æ¥è£…åœ¨è¿™ä¸ªç”¨æˆ·çš„ home ç›®å½•ä¸‹ï¼Œä¼šå¯¼è‡´è¿™ä¸ªç”¨æˆ·åªèƒ½æœ‰è¿™ä¸€ä¸ªç”¨é€”äº†ï¼Œç›®å½•ç»“æ„å¤ªæµ…ï¼Œä¸€å †æ–‡ä»¶\n4ã€Hubotçš„å˜é‡å¼•å…¥éƒ½æ˜¯é€šè¿‡ç¯å¢ƒå˜é‡å¼•å…¥çš„\næ‰€ä»¥æ— è®ºä»€ä¹ˆwechatworkè¿˜æ˜¯jenkinsï¼Œéƒ½éœ€è¦é€šè¿‡ç¯å¢ƒå˜é‡å¯¼å…¥å˜é‡\nä¸‰ã€å®‰è£…Hubot é¦–å…ˆå®‰è£…nvmï¼Œå‚çœ‹æ–‡ç«  Nodejså¤šç‰ˆæœ¬çš„å®‰è£…ä¸ç®¡ç† 1curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash å®‰è£…çš„æ—¶å€™æœ€å¥½åŠ ä¸ª https_proxy ä»£ç†ï¼Œå› ä¸ºè¿™ä¸ª shell è„šæœ¬ä¸ç¿»å¢™å¾ˆéš¾ä¸‹ä¸‹æ¥ã€‚\nç„¶ååŠ¡å¿…å…³äº†ä»£ç†ï¼Œé€€å‡ºç»ˆç«¯å¹¶é‡æ–°è¿›å…¥ï¼Œå®‰è£… nodejs çš„æœ€æ–°ç‰ˆæœ¬\n1nvm ls-remote 2nvm install v16.13.1 3nvm list ç¡®è®¤ä¸€ä¸‹ï¼Œnodejs çš„ç‰ˆæœ¬ç¼ºçœæ˜¯ v16.13.1\nè¿™é‡Œåƒä¸‡ä¸è¦æ‰‹æ¬ æŠŠ npm çš„æºæ¢æˆå›½å†…çš„è…¾è®¯ç­‰ï¼Œå°±æ˜¯å›½å¤–æº\nç„¶åå®‰è£…hubotï¼Œå¹¶åˆå§‹åŒ–\n1su - bot 2npm install -g yo generator-hubot 3 4mkdir /home/bot/myhubot 5cd /home/bot/myhubot 6yo hubot ä¼šé—®å‡ ä¸ªé—®é¢˜ï¼š\n Owerï¼šå†™è‡ªå·±é‚®ç®±å°±è¡Œ Bot name: bot Description: rendoumi corp Bot adapter: campfire  æ³¨æ„æœ€åä¸€ä¸ªï¼Œé€‰campfireå°±å¥½ï¼Œæˆ‘ä»¬ç¨åå†è£…wechatwork\n1 _____________________________  2 / \\  3 //\\ | Extracting input for | 4 ////\\ _____ | self-replication process | 5 //////\\ /_____\\ \\ /  6 ======= |[^_/\\_]| /---------------------------- 7| | _|___@@__|__ 8+===+/ /// \\_\\ 9| |_\\ /// HUBOT/\\\\ 10|___/\\// / \\\\ 11\\ / +---+ 12\\____/ | | 13| //| +===+ 14\\// |xx|  15 16? Owner zhangranrui@rendoumi.com 17? Bot name bot 18? Description rendoumi corp 19? Bot adapter campfire ç„¶åå°±ä¼šæ˜¯æ¼«é•¿çš„ç­‰å¾…ï¼š\næœ€åä¼šæŠ¥å‡ ä¸ªè­¦å‘Šï¼Œä¸ç”¨ç®¡ï¼Œå¿½ç•¥å³å¯ã€‚\n1npm notice created a lockfile as package-lock.json. You should commit this file. 2+ hubot-help@1.0.1 3+ hubot-google-images@0.2.7 4+ hubot-rules@1.0.0 5+ hubot-shipit@0.2.1 6+ hubot-redis-brain@1.0.0 7+ hubot-google-translate@0.2.1 8+ hubot-diagnostics@1.0.0 9+ hubot-scripts@2.17.2 10+ hubot@3.3.2 11+ hubot-maps@0.0.3 12+ hubot-heroku-keepalive@1.0.3 13+ hubot-pugme@0.1.1 14added 99 packages from 53 contributors and audited 99 packages in 20.176s 15 162 packages are looking for funding 17 run `npm fund` for details 18 19found 1 low severity vulnerability 20 run `npm audit fix` to fix them, or `npm audit` for details æˆ‘ä»¬å…ˆè·‘ä¸€ä¸‹ï¼Œç®€å•æµ‹ä¸€ä¸‹åŠŸèƒ½ï¼Œæˆ‘ä»¬çš„bot nameè¾“å…¥çš„æ˜¯bot\n1cd /home/bot/myhubot 2 3./bin/hubot 4 5#è¿›å…¥å 6bot ping 7 8#å¾—åˆ°å›åº” 9PONG è¿™æ ·å°±è£…å¥½äº† hubotï¼Œæˆ‘ä»¬åšä¸€ä¸‹ä¿®æ”¹ï¼Œå»æ‰ heroku å’Œ redisï¼Œå¦åˆ™ä¼šä¸åœä¸¢å‡ºæŠ¥é”™ä¿¡æ¯ï¼Œä½†æ˜¯ä¸è¦ç”¨ npm å»åˆ é™¤è¿™ä¸¤ä¸ªåŒ…ï¼Œæ”¾ç€é‚£é‡Œå¤‡ç”¨ä¹Ÿä¸å å¤šå°‘ç©ºé—´çš„\n1cd /home/bot/myhubot 2 3vi external-scripts.json 4[ 5 \u0026#34;hubot-diagnostics\u0026#34;, 6 \u0026#34;hubot-help\u0026#34;, 7 \u0026#34;hubot-heroku-keepalive\u0026#34;, 8 \u0026#34;hubot-google-images\u0026#34;, 9 \u0026#34;hubot-google-translate\u0026#34;, 10 \u0026#34;hubot-pugme\u0026#34;, 11 \u0026#34;hubot-maps\u0026#34;, 12 \u0026#34;hubot-redis-brain\u0026#34;, 13 \u0026#34;hubot-rules\u0026#34;, 14 \u0026#34;hubot-shipit\u0026#34; 15] 16 17#å»æ‰ä¸‹é¢ä¸¤è¡Œ 18hubot-heroku-keepalive 19hubot-redis-brain ä¸‰ã€å®‰è£…å¾®ä¿¡ Adapter Adapter æ’ä»¶ï¼Œhubotæ˜¯ä¸€å¥—ç³»ç»Ÿï¼Œé€šè¿‡å„ç§æ’ä»¶è·Ÿå„ç§èŠå¤©è½¯ä»¶è¿›è¡Œäº¤äº’\nå¾®ä¿¡æ’ä»¶åŸå§‹åœ°å€ï¼šhttps://github.com/billtt/hubot-wechatwork\nå…«æˆ’ç¨å¾®æ”¹äº†ä¸€ä¸‹ï¼šhttps://github.com/zhangrr/hubot-wechatwork\nä¸»è¦æ˜¯æ·»åŠ äº†ä¸ªè‡ªåŠ¨å›åº”å’Œæ·»åŠ äº†ä¸€äº›è°ƒè¯•ä¿¡æ¯ï¼Œå¦åˆ™ä¸çŸ¥é“åŠ è½½æˆä¸æˆåŠŸã€‚\n1#å…ˆè£…é‚£ä¸ªè€çš„ 2cd /home/bot/myhubot 3npm install hubot-wechatwork 4 5#è¦†ç›–æ‰è€çš„æ¨¡å— 6cd /home/bot/myhubot/node_modules 7git clone https://github.com/zhangrr/hubot-wechatwork å¯åŠ¨ä¹‹å‰æ™®åŠä¸€ä¸‹ hubot åŸºæœ¬çŸ¥è¯†ï¼Œhubot ä¸­å˜é‡çš„ä¼ å…¥éƒ½æ˜¯é€šè¿‡ç¯å¢ƒå˜é‡å¯¼å…¥çš„ï¼Œå¯åŠ¨æµ‹è¯•ä¸€ä¸‹wechatwork\n1export WECHATWORK_CORP_ID=aaaa 2export WECHATWORK_APP_AGENT_ID=bbbb 3export WECHATWORK_APP_SECRET=cccc 4export WECHATWORK_AES_KEY=dddd 5 6cd /home/bot/myhubot 7./bin/hubot -a wechatwork çœ‹åˆ°ä¿¡æ¯ï¼ŒINFO Yunwei: loading wechatwork Adapterï¼Œè¯´æ˜å¯åŠ¨æ²¡å•¥æ¯›ç—…\nç„¶åæˆ‘ä»¬å›åˆ°ä¼ä¸šå¾®ä¿¡è¿™ä¸ªåº”ç”¨çš„åº”ç”¨ç®¡ç†ï¼Œç‚¹å‡»ä¿å­˜æ¥æ”¶æ¶ˆæ¯æœåŠ¡å™¨é…ç½®ï¼Œè¿™æ¬¡å°±åº”è¯¥èƒ½æˆåŠŸäº†ã€‚\næµ‹è¯•ä¸€ä¸‹ï¼Œæˆ‘ä»¬åœ¨ä¼ä¸šå¾®ä¿¡ä¸­ï¼Œå¯¹è¿™ä¸ªåº”ç”¨æœºå™¨äººç§èŠï¼Œå‘ä¸ª hiï¼š\nå†å‘ä¸ªhelpï¼Œä¼šå†’å‡ºä¸€å †ä¿¡æ¯\nç„¶åæˆ‘ä»¬å¯ä»¥è¯•è¯•æŒ‡ä»¤ï¼Œå†å‘ä¸ªpingï¼Œæœºå™¨äººå›PONGï¼Œè¿™å°±ç®—æ­£å¸¸å·¥ä½œäº†\nåŒæ—¶æˆ‘ä»¬åœ¨ç»ˆç«¯ä¹Ÿå¯ä»¥çœ‹åˆ°æ¥æ”¶åˆ°çš„æ¶ˆæ¯\nè¦æ³¨æ„çš„å‘½ä»¤ï¼š wechatwork æœ‰ä¸€æ¡å‘½ä»¤ chat create CHATID USER1,USER2,USER3,\u0026hellip;\nè§£é‡Šä¸€ä¸‹ï¼Œæ˜¯ç”¨æ¥å»ºç«‹ä¸€ä¸ªä¼ä¸šå¾®ä¿¡ç¾¤èŠçš„ï¼Œç¾¤ä¸»é»˜è®¤æ˜¯ç¬¬ä¸€ä¸ªäººï¼š\nchatid æ˜¯æŒ‡ä¸€ä¸ªç¾¤èŠçš„ id å·ï¼Œæ ¼å¼æ˜¯å­—æ¯+æ•°å­—ï¼Œæ¯”å¦‚yunwei001ï¼Œè¿™ä¸ªä¸€æ—¦åˆ›å»ºå°±æ— æ³•é”€æ¯ï¼Œä¼šæ°¸è¿œä¿å­˜åœ¨ä¼ä¸šå¾®ä¿¡é‚£é‡Œï¼Œåˆ‡åˆ‡è®°ä½ï¼ï¼ï¼\nuser1,user2 è¿™ç§æ˜¯å‘˜å·¥ä¼ä¸šå¾®ä¿¡çš„idï¼Œé€šå¸¸æ˜¯ç”¨æˆ·åå…¨ç§°ï¼Œæ¯”å¦‚ zhangrenren,liudaqiang\næ‰€ä»¥è¯´çš„æ—¶å€™åŠ¡å¿…è¦å°å¿ƒï¼Œä¸‡ä¸‡è®°ä½ chatid ä¸€æ—¦å»ºç«‹å°±æ— æ³•æ”¶å›ã€‚\nä¹‹åå¯ä»¥è°ƒç”¨ sendChatMessage æ¥ç»™ç¾¤èŠå‘é€æ¶ˆæ¯ã€‚\nå››ã€å‡†å¤‡systemdå¯åŠ¨hubot è¿™æ ·ä¸èƒ½æ¯æ¬¡ç”¨ä¸ªç»ˆç«¯å¯åŠ¨ hubot å§ï¼Œå†™ä¸ª systemd æ–‡ä»¶æ¥å¤„ç†å§\nç”±äºæˆ‘ä»¬ç”¨åˆ°äº†nvmï¼Œè¿™é‡Œç¡®å®éœ€è¦ä¸€äº›æŠ€å·§ï¼Œcat /etc/systemd/system/hubot.service\n1[Unit] 2Description=Hubot 3Requires=network.target 4After=network.target 5 6[Service] 7Type=simple 8WorkingDirectory=/home/bot/myhubot 9User=bot 10 11Restart=always 12TimeoutStartSec=10 13RestartSec=10 14 15; Configure Hubot environment variables, use quotes around vars with whitespace as shown below. 16; Environment=\u0026#34;HUBOT_SLACK_TOKEN=SLACK_TOKEN\u0026#34; 17; Environment=\u0026#34;HUBOT_JENKINS_AUTH=pe:x837491lkaflajksdf7\u0026#34; 18; Environment=\u0026#34;HUBOT_JENKINS_URL=http://192.168.1.90:8080/\u0026#34; 19Environment=\u0026#34;NODE_VERSION=default\u0026#34; 20Environment=\u0026#34;WECHATWORK_CORP_ID=aaaa\u0026#34; 21Environment=\u0026#34;WECHATWORK_APP_AGENT_ID=bbbb\u0026#34; 22Environment=\u0026#34;WECHATWORK_APP_SECRET=cccc\u0026#34; 23Environment=\u0026#34;WECHATWORK_AES_KEY=dddd\u0026#34; 24 25ExecStart=/home/bot/.nvm/nvm-exec /home/bot/myhubot/bin/hubot --adapter wechatwork 26 27[Install] 28WantedBy=multi-user.target æ³¨æ„ä¸Šé¢ï¼Œæˆ‘ä»¬æŒ‡å®šäº†ç¯å¢ƒå˜é‡ NODE_VERSION=defaultï¼Œä»¥åŠæœ€ä¸‹çš„ ExecStartï¼Œç¡®å®šç”¨ nvm-exec å¼•åŠ¨ node\nå¦å¤–æŠŠ wechatwork æ‰€éœ€çš„4ä¸ªå‚æ•°ä¹Ÿæ”¾è¿›ç¯å¢ƒå˜é‡ä¸­ï¼Œè¿™æ ·é‡å¯å°±å¯ä»¥äº†\n1systemctl daemon-reload 2systemctl start hubot äº”ã€é›†æˆjenkins å‡†å¤‡çŸ¥è¯†ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨ jenkins æ‹¿åˆ°ç”¨æˆ·åå’Œ tokenï¼ˆtokenæ˜¯ç”¨æ¥ä»£æ›¿å¯†ç çš„ï¼‰ï¼Œç”¨æ¥è®¿é—® jenkins\né¦–å…ˆç™»å½• jenkinsï¼Œè®¿é—®ç½‘å€ï¼š$JENKINS_URL/me/configureï¼Œæ–°å»ºä¸€ä¸ª API Tokenï¼Œè®°å½•ä¸‹æ¥\nç”¨æ³•å¾ˆç®€å•ï¼štokenæ›¿ä»£å¯†ç ç”¨äº url è®¤è¯å³å¯ã€‚\n1cd /home/bot/myhubot 2npm install hubot-jenkins-optimised 3 4#ç¼–è¾‘external-scripts.json 5vi external-scripts.json 6[ 7 \u0026#34;hubot-diagnostics\u0026#34;, 8 \u0026#34;hubot-help\u0026#34;, 9 \u0026#34;hubot-google-images\u0026#34;, 10 \u0026#34;hubot-google-translate\u0026#34;, 11 \u0026#34;hubot-pugme\u0026#34;, 12 \u0026#34;hubot-maps\u0026#34;, 13 \u0026#34;hubot-rules\u0026#34;, 14 \u0026#34;hubot-shipit\u0026#34;, 15 \u0026#34;hubot-jenkins-optimised\u0026#34; 16] 17 18#ä¸Šé¢å¢åŠ äº†ä¸€è¡Œ 19hubot-jenkins-optimised 20 21#ç¼–è¾‘ /etc/systemd/system/hubot.service ï¼Œæ·»åŠ  jenkins çš„ç¯å¢ƒå˜é‡ 22#jenkinsçš„ç”¨æˆ·åæ˜¯peï¼Œæ‰€æœ‰authæ˜¯ \u0026#34;pe:x837491lkaflajksdf7\u0026#34; 23...... 24Environment=\u0026#34;HUBOT_JENKINS_AUTH=pe:x837491lkaflajksdf7\u0026#34; 25Environment=\u0026#34;HUBOT_JENKINS_URL=http://192.168.1.90:8080/\u0026#34; 26...... 27 28# é‡å¯ hubot 29systemctl daemon-reload 30systemctl restart hubot ç„¶åæˆ‘ä»¬ç§èŠè¿™ä¸ªæœºå™¨äººï¼Œå¯¹å®ƒè¯´: jenkins listï¼Œå°±å¯ä»¥çœ‹åˆ°é¡¹ç›®äº†ï¼Œ jenkins b 3 å°±å¯ä»¥å¼€å§‹buildç¬¬ä¸‰ä¸ªé¡¹ç›®äº†ï¼Œæ‰€æœ‰å‘½ä»¤å¯ä»¥é€šè¿‡å¯¹æœºå™¨äººè¯´ help æ¥è·å¾—\nå…­ã€é›†æˆansible é›†æˆ ansibleï¼Œå…¶å®å°±æ˜¯é›†æˆä¸€ä¸ª shellï¼Œä¹Ÿå¾ˆç®€å•\n1cd /home/bot/myhubot 2npm install hubot-script-shellcmd 3 4#ç¼–è¾‘external-scripts.json 5vi external-scripts.json 6[ 7 \u0026#34;hubot-diagnostics\u0026#34;, 8 \u0026#34;hubot-help\u0026#34;, 9 \u0026#34;hubot-google-images\u0026#34;, 10 \u0026#34;hubot-google-translate\u0026#34;, 11 \u0026#34;hubot-pugme\u0026#34;, 12 \u0026#34;hubot-maps\u0026#34;, 13 \u0026#34;hubot-rules\u0026#34;, 14 \u0026#34;hubot-shipit\u0026#34;, 15 \u0026#34;hubot-jenkins-optimised\u0026#34;, 16 \u0026#34;hubot-script-shellcmd\u0026#34; 17] 18 19#ä¸Šé¢å¢åŠ äº†ä¸€è¡Œ 20hubot-script-shellcmd 21 22#æŠŠshellcmdç›®å½•ä¸‹çš„bashç›®å½•ï¼Œå¤åˆ¶ä¸€ä»½åˆ°/home/bot/myhubot/bash 23cp -R node_modules/hubot-script-shellcmd/bash ./ 24 25#æˆ‘ä»¬æŠŠansibleçš„ymléƒ½æ”¾åˆ°/homebot/myhubot/bash/ansibleç›®å½•ä¸‹ 26cd /home/bot/myhubot/bash 27mkdir ansible 28 29#æŠŠansible-playbookçš„ymléƒ½æ”¾è¿›å» 30.... 31 32#ç„¶åç¼–å†™å‘½ä»¤è„šæœ¬ 33cd /home/bot/myhubot/bash/handles 34 35cat \u0026lt; EOF \u0026gt;\u0026gt; fuse 36#!/bin/bash 37 38if [ -n \u0026#34;$1\u0026#34; ] ; then 39 if [ -n \u0026#34;$2\u0026#34; ] ; then 40 ansible-playbook /home/bot/myhubot/bash/ansible/check-disk.yml -e \u0026#34;ip=$1fs=$2\u0026#34; 41 else 42 ansible-playbook /home/bot/myhubot/bash/ansible/check-disk.yml -e \u0026#34;ip=$1fs=/\u0026#34; 43 fi 44fi 45 46exit 0 47EOF 48 49#ç»™æ‰§è¡Œæƒ 50chmod 755 /home/bot/myhubot/bash/handles/fuse 51 52#é‡å¯hubot 53systemctl restart hubot check-disk.yml çš„çœŸèº«ï¼Œæ˜¯åœ¨è¿œç¨‹æœºå™¨ä¸Šè°ƒç”¨æœ¬æœºæ‰æœ‰çš„rust dustå‘½ä»¤ï¼Œæ¥ç®—å‡ºè¿œç¨‹æœºå™¨çš„æŸä¸ªç›®å½•çš„ä½¿ç”¨æƒ…å†µ\n1--- 2- name: check machine disk space 3 hosts: \u0026#34;{{ ip }}\u0026#34; 4 gather_facts: false 5 vars: 6 - ip: \u0026#34;{{ ip }}\u0026#34; 7 - fs: \u0026#34;{{ fs }}\u0026#34; 8 - ansible_ssh_user: \u0026#34;root\u0026#34; 9 - ansible_ssh_pass: \u0026#34;Fuck2021!\u0026#34; 10 - ansible_ssh_common_args: \u0026#34;-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null\u0026#34; 11 - host_key_checking: False 12 tasks: 13 - name: Run a script with arguments (using \u0026#39;cmd\u0026#39; parameter) 14 ansible.builtin.script: 15 cmd: /usr/local/bin/dust -bcr {{ fs }} 16 register: output 17 18 - debug: var=output.stdout_lines æˆ‘ä»¬åœ¨ä¼ä¸šå¾®ä¿¡å¯¹æœºå™¨è¯´ shell ï¼Œå°±ä¼šå¾—åˆ°æ‰€æœ‰å‘½ä»¤åˆ—è¡¨\nå¯¹å®ƒè¯´ shell fuse 172.19.16.1 /export ï¼Œå°±ä¼šæŠŠæœ¬æœºæ‰æœ‰çš„ dust å‘½ä»¤ï¼Œæ‹·è´åˆ°172.19.16.1çš„æœºå™¨ä¸Šï¼Œå¹¶å¯¹ /export æ‰§è¡Œï¼Œå¾—åˆ°å ç£ç›˜ç©ºé—´æœ€å¤§çš„æ–‡ä»¶å’Œç›®å½•ã€‚\nå‚è€ƒèµ„æ–™ï¼š https://qydev.weixin.qq.com/wiki/index.php?title=%E5%8F%91%E9%80%81%E6%8E%A5%E5%8F%A3%E8%AF%B4%E6%98%8E http://sd.blackball.lv/library/Automation_and_Monitoring_with_Hubot_(2014).pdf ","date":"2021-12-22","img":"","permalink":"https://bajie.dev/posts/20211222-hubot_wechat/","series":null,"tags":null,"title":"Huboté›†æˆä¼ä¸šå¾®ä¿¡+jenkins+ansible"},{"categories":null,"content":"æœ€è¿‘åœ¨æ JavaScriptsï¼Œnodejsçš„ç‰ˆæœ¬æ»¡å¤©é£ï¼Œä¹‹å‰ç”¨çš„ nvm ç®¡ç†çš„æ–¹æ³•çªç„¶ä¸èƒ½ç”¨äº†ã€‚\nè¿™é‡Œè®°å½•ä¸€ä¸‹ï¼Œæ¯”è¾ƒæ–°çš„ nvm çš„å®‰è£…ä½¿ç”¨æ–¹æ³•ï¼š\nä¸‹è½½å®‰è£…ï¼š\n1curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash ä»¥ä¸Šçš„è„šæœ¬å®‰è£…åˆ°åº•åšäº†ä»€ä¹ˆå‘¢ï¼Ÿ\nä¸€ã€å®ƒ clone äº† nvm åˆ° $HOME/.nvmç›®å½•\näºŒã€å®ƒåœ¨ .bashrc ä¸­æ·»åŠ äº†ä¸‰è¡Œ\näº‹å®ä¸Šå®ƒæ˜¯æ ¹æ®å½“å‰çš„ bash é€‰æ‹©åœ¨ .bash_profileã€.zshrcã€.profileã€.bashrcä¸­çš„æŸä¸€ä¸ªè¿›è¡Œæ·»åŠ \nç„¶åæˆ‘ä»¬é€€å‡ºç»ˆç«¯ï¼Œå¹¶é‡æ–°è¿›å…¥ï¼Œçœ‹çœ‹\n1nvm list 2nvm ls-remote ç„¶åé€‰æ‹©æœ€æ–°çš„ç‰ˆæœ¬å®‰è£…ï¼š\n1nvm install v16.13.1 å¦‚æœæƒ³ä½¿ç”¨ä¸åŒç‰ˆæœ¬\n1nvm use 14.0.0 è®¾ç½®ç¼ºçœç‰ˆæœ¬æˆ–è€…å–æ¶ˆ\n1nvm alias defaut \u0026lt;your_nodejs_default_version\u0026gt; 2 3nvm alias default 14.0.0 4node -v # prints 14.0.0 å‚è€ƒåœ°å€ï¼šhttps://github.com/nvm-sh/nvm\n","date":"2021-12-17","img":"","permalink":"https://bajie.dev/posts/20211217-nodejs_nvm/","series":null,"tags":null,"title":"Nodejså¤šç‰ˆæœ¬çš„å®‰è£…ä¸ç®¡ç†"},{"categories":null,"content":"S3 çš„æ¡¶å­˜å‚¨å¯ä»¥ç”¨ minio æ¥æ¨¡æ‹Ÿã€‚\nç½‘ä¸Šæœ‰ä¸ª Backblaze çš„ç½‘ç«™ï¼Œæä¾› 10GB çš„å…è´¹ç©ºé—´ï¼Œä¸”å¦‚æœæ˜¯å…¬ç½‘è®¿é—®ï¼Œ1GBæµé‡æ˜¯å…è´¹çš„ï¼Œå¦‚æœå‰é¢å¥—äº† Cloudflare çš„CDNï¼Œé‚£åŸºæœ¬æ˜¯å…¨å…äº†ã€‚\nè¯´ä¸‹ä½¿ç”¨æ–¹å¼ï¼š\né¦–å…ˆå» https://www.backblaze.com/ æ³¨å†Œä¸ªå¸å·ï¼š\nç„¶åç›´æ¥å»ºä¸ªæ¡¶ï¼ˆCreate a Bucketï¼‰\næ¡¶æ–‡ä»¶ç±»å‹é€‰æ‹© publicï¼Œå¦åˆ™æ— æ³•å…¬ç½‘è®¿é—®ï¼š\nç„¶å gen å‡º master app key æ¥å¹¶è®°å½•å¥½ï¼š\néšåæœ€å¤§çš„é—®é¢˜å°±æ¥äº†ï¼Œå¦‚æœä½ ç”¨å®ƒé¡µé¢è‡ªå¸¦çš„ä¸Šä¼ ä¸‹è½½å·¥å…·ï¼Œå½»åº•å®Œè›‹ï¼Œæ‹–è¿›å»çš„æ–‡ä»¶å¤¹ä¼šå˜æˆæ‰å¹³çš„ï¼Œå®Œå…¨ä¸§å¤±ç›®å½•ç»“æ„ã€‚\nå¿…é¡»è¦æ‰¾ä¸€ä¸ªå¥½ç”¨çš„ä¸Šä¼ å·¥å…·äº†ï¼Œæ¨è b2 ã€‚\nb2 å·¥å…·ä¸‹è½½ï¼š\nhttps://github.com/Backblaze/B2_Command_Line_Tool ä¸‹è½½åç›´æ¥æ”¹åä¸º b2 ï¼Œç„¶åæ”¾åˆ° /usr/local/bin ä¸­\n1wget -O /usr/local/bin/b2 https://github.com/Backblaze/B2_Command_Line_Tool/releases/download/v3.1.0/b2-linux 2chmod 755 /usr/lcoal/b2 è¿è¡Œä¸€ä¸‹ï¼Œæœ‰å¾ˆå¤šå‘½ä»¤å‚æ•°ï¼š\nè¯¦ç»†çš„ä½¿ç”¨æ–‡æ¡£ï¼š\nhttps://b2-command-line-tool.readthedocs.io/en/master/ å…ˆå»é…ç½®å¸å·ï¼Œè¾“å…¥applicationKeyIdå’ŒapplicationKey\n1b2 authorize-account ç„¶åå°±å¯ä»¥å¾€æ¡¶é‡Œä¼ ä¸œè¥¿äº†ï¼ŒæŠŠå½“å‰ç›®å½•ä¸‹çš„ä¸œè¥¿ä¼ åˆ° rendoumi è¿™ä¸ªæ¡¶é‡Œï¼Œå¹¶ä¸”ä¸è¦ä¼  .git ç›®å½•\n1b2 sync --excludeDirRegex .git . b2://rendoumi/ å¥— Cloudflare å°±éšæ„äº†ã€‚full sslï¼Œå»ºä¸ª CNAME ä¸”ç”¨ Page rule åš url è½¬å‘å°±å¯ä»¥äº†ã€‚\n","date":"2021-12-08","img":"","permalink":"https://bajie.dev/posts/20211208-backblaze_usage/","series":null,"tags":null,"title":"Backblazeç±»S3å…è´¹å…å¤‡æ¡ˆå¯¹è±¡å­˜å‚¨"},{"categories":null,"content":"kubernetesä¸‹å®šåˆ¶ http 50x ä»¥åŠ 40x æœåŠ¡å™¨è¿”å›ä¿¡æ¯çš„è¯ï¼Œå¦‚æœç”¨ Nginx åš ingressï¼Œå¤§å®¶ä¼šå¾ˆè‡ªç„¶æƒ³åˆ°ç›´æ¥ç”¨ nginx æ¥å®šåˆ¶ï¼š\n1 error_page 500 502 503 504 /50x.html; 2 location = /50x.html { 3root /export/html; 4} è¿™æ ·åšæ˜¯ä¸è¡Œçš„ï¼Œå› ä¸º Nginx ä½œä¸º ingress æ¥ä½¿ç”¨ï¼Œå°±ä¸èƒ½è½åœ°ï¼Œåªèƒ½åšè½¬å‘ï¼›å¦‚æœä½ è½åœ°äº†ï¼Œè®¿é—®äº†æœ¬åœ°æ–‡ä»¶ï¼Œå°±è¿èƒŒäº†åˆè¡·ã€‚è€Œä¸”åœ¨ ingress çš„ pod ä¸Šæ”¾é¡µé¢ï¼Œä¼šå¯¼è‡´ ingress çš„é…ç½®é”™ä¹±ã€‚\né‚£ä¹ˆæ­£ç¡® 50x é‡å®šä½çš„æ–¹æ³•å¦‚ä¸‹ï¼šé¦–å…ˆå»ºç«‹ä¸€ä¸ª deploy å’Œå¯¹åº”çš„ svcï¼Œå°±æ˜¯å»ºç«‹ä¸€ä¸ª web æœåŠ¡å™¨ï¼Œèƒ½æä¾›æœåŠ¡è¿”å› 50x å’Œ 40x çš„å®šåˆ¶é¡µé¢ï¼›ç„¶ååœ¨ ingress\nå†…æŒ‡å®š custom-http-errors å’Œ default-backend æŒ‡å‘å®ƒå°±å¯ä»¥äº†ã€‚\nä¸€ã€å»ºç«‹miniserveçš„deployå’Œsvc æˆ‘ä»¬é€‰ç”¨ rust çš„ miniserve ä½œä¸º web æœåŠ¡å™¨ï¼Œå‡†å¤‡å¥½å®šåˆ¶å¥½çš„ index.htmlï¼Œå†™ä¸ª Dockerfile\nç½‘å€ï¼šhttps://github.com/svenstaro/miniserve\n1FROM alpine:3.12 2RUN apk add --update bash \u0026amp;\u0026amp; rm -rf /var/cache/apk/* 3 4COPY . /data/ 5 6RUN rm -rf /data/Dockerfile 7 8WORKDIR /data 9EXPOSE 8080 10 11CMD [\u0026#34;/data/miniserve\u0026#34;,\u0026#34;--index\u0026#34;,\u0026#34;index.html\u0026#34;] 12#CMD /bin/sh -c \u0026#34;while true; do echo hi; sleep 10; done\u0026#34; ä½œå‡ºé•œåƒåæ¨é€åˆ°é˜¿é‡Œé•œåƒï¼šregistry.cn-shanghai.aliyuncs.com/rendoumi/miniserve:lastest\nç„¶åå‡†å¤‡å¥½ deployå’Œ svcï¼Œéƒ¨ç½²åˆ° kubernetes é‡Œ\n1---2apiVersion:apps/v13kind:Deployment4metadata:5name:miniserve-deploy6labels:7app:miniserve8spec:9replicas:110selector:11matchLabels:12app:miniserve13template:14metadata:15labels:16app:miniserve17spec:18containers:19- name:miniserve20image:registry.cn-shanghai.aliyuncs.com/rendoumi/miniserve:lastest21imagePullPolicy:Always22ports:23- containerPort:808024---25apiVersion:v126kind:Service27metadata:28name:miniserve-svc29labels:30app:miniserve31spec:32ports:33- name:http34protocol:TCP35port:8036targetPort:808037selector:38app:miniserve39type:ClusterIPäºŒã€ä¿®æ”¹ingress ä¿®æ”¹çš„åœ°æ–¹å°±æ˜¯ annotations çš„æœ€åä¸¤è¡Œï¼š\n1apiVersion:networking.k8s.io/v1beta1 2kind:Ingress 3metadata:4name:kala-com-ingress 5annotations:6kubernetes.io/ingress.class:\u0026#34;nginx\u0026#34;7nginx.ingress.kubernetes.io/limit-connections:\u0026#34;2\u0026#34;8nginx.ingress.kubernetes.io/limit-rpm:\u0026#34;2\u0026#34;9nginx.ingress.kubernetes.io/limit-rps:\u0026#34;1\u0026#34;10nginx.ingress.kubernetes.io/app-root:\u0026#34;/webui/\u0026#34;11nginx.ingress.kubernetes.io/auth-type:basic 12nginx.ingress.kubernetes.io/auth-secret:kala-auth 13nginx.ingress.kubernetes.io/auth-realm:\u0026#39;Authentication Required - Kala\u0026#39;14nginx.ingress.kubernetes.io/default-backend:\u0026#34;miniserve-svc\u0026#34;15nginx.ingress.kubernetes.io/custom-http-errors:\u0026#34;403,404,500,502,503,504\u0026#34;16spec:17rules:18- host:kala.rendoumi.com 19http:20paths:21- path:/ 22backend:23serviceName:kala-svc 24servicePort:80æµ‹è¯•çš„è¯ç”¨ wrk å‹ä½ï¼Œç„¶åcurlå†æµ‹å°±503è½¬åˆ°miniserve-svc\n1wrk -c 3 -t 3 -d 10 http://kala.rendoumi.com/webui/ --latency 2 3curl -v -H \u0026#34;Host: kala.rendoumi.com\u0026#34; http://kala.rendoumi.com/webui/ ","date":"2021-11-29","img":"","permalink":"https://bajie.dev/posts/20211129-kubernetes_custom_503/","series":null,"tags":null,"title":"Kubernetesä¸‹å®šåˆ¶æœåŠ¡å™¨503ä»¥åŠå…¶ä»–çš„403æ¶ˆæ¯"},{"categories":null,"content":"åœ¨ kubernetes ä¸­ï¼Œingress è´Ÿè´£è½¬å‘ã€èæ–­å’Œé™æµã€‚\næˆ‘ä»¬ä»¥ Nginx ingress ä¸ºä¾‹ï¼Œè®¨è®ºä¸€ä¸‹è¿™æ–¹é¢çš„é—®é¢˜ã€‚\nä¸€ã€Nginx ingressé»‘ç™½åå• è¿™ä¸ªå¾ˆç®€å•äº†ï¼Œä¸¢è¿›é»‘åå•æˆ–è€…ç™½åå•ï¼Œåœ¨å…¥å£å‰æ‹¦ä¸€åˆ€ã€‚\næˆ‘ä»¬åªè¦åœ¨ annotations å£°æ˜å³å¯ï¼š\n1apiVersion:networking.k8s.io/v1beta1 2kind:Ingress 3metadata:4name:www-com-ingress 5annotations:6kubernetes.io/ingress.class:nginx 7nginx.ingress.kubernetes.io/ssl-redirect:\u0026#34;true\u0026#34;8nginx.ingress.kubernetes.io/block-cidrs:a.b.c.d/32 9#nginx.ingress.kubernetes.io/whitelist-source-range: a.b.c.d/32 10spec:11tls:12- hosts:13- www.huabbao.com 14secretName:www-huabbao-com-cert 15rules:16- host:www.huabbao.com 17http:18paths:19- path:/ 20backend:21serviceName:nginx-svc æ³¨æ„ï¼Œå¤šä¸ªipçš„è¯ï¼Œä¹‹é—´ç”¨é€—å·éš”å¼€ï¼ˆè¯¥å€¼æ˜¯é€—å·åˆ†éš”çš„CIDRåˆ—è¡¨ï¼‰ ï¼š\n1nginx.ingress.kubernetes.io/whitelist-source-range:\u0026#39;58.246.36.130,180.167.74.98,114.85.176.38â€™ äºŒã€Nginx ingressé™é€Ÿ é™é€Ÿè¿™ä¸ªé—®é¢˜æ¯”è¾ƒå¤æ‚ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦è€ƒè™‘åˆ°ç”¨æˆ·ä½“éªŒï¼Œå¦‚æœå¾ˆé²æ£’æ€§çš„å¼ºåˆ¶é™åˆ¶å®¢æˆ·ç«¯æµé‡æ˜¯10KBï¼Œé‚£ä¹ˆå¦‚æœä¸€å¼€å§‹çš„åŠ è½½é¡µé¢å¦‚æœè¾ƒå¤§ï¼Œå®¢æˆ·ç›´æ¥å°±ç¦»åœºäº†ã€‚æ‰€ä»¥é¦–å…ˆè¦è€ƒè™‘è¦æœ‰åˆå§‹å­—èŠ‚é‡ï¼Œè¿™ä¸ªé‡éœ€è¦èƒ½è®©å®¢æˆ·é¡ºç•…çš„æ‰“å¼€é¦–é¡µã€‚ç„¶åæˆ‘ä»¬å†è®¾å®šè¯·æ±‚é€Ÿç‡ï¼Œå†è€ƒè™‘å•ä¸ªIPåœ°å€çš„å¹¶å‘è¿æ¥é‡ï¼ˆå¹¶å‘é‡Ã—é€Ÿç‡=å®¢æˆ·ç«¯å®é™…é€Ÿç‡ï¼‰ï¼Œç¬¬å››ä¸ªå†è€ƒè™‘æ¯åˆ†é’Ÿæˆ–æ¯ç§’çš„æœ€å¤§è¯·æ±‚æ•°ã€‚\nä»¥ä¸‹æ³¨é‡Šå®šä¹‰æŒ‰é¡ºåºæ’åˆ—ï¼Œå¯ä»¥è®¾ç½®å•ä¸ªå®¢æˆ·ç«¯IPåœ°å€æ‰“å¼€çš„è¿æ¥çš„é™åˆ¶ï¼Œå¯ç”¨äºç¼“è§£DDoSæ”»å‡»ã€‚\n ä¸€ã€nginx.ingress.kubernetes.io/limit-rate-afterï¼šè®¾ç½®åˆå§‹å­—èŠ‚é‡ï¼Œåœ¨æ­¤ä¹‹åï¼Œè¿›ä¸€æ­¥ä¼ è¾“å°†å—åˆ°limit-rateé€Ÿç‡é™åˆ¶ã€‚   äºŒã€nginx.ingress.kubernetes.io/limit-rateï¼šæ¯ç§’æ¥å—çš„è¯·æ±‚é€Ÿç‡ï¼ˆæ¯ç§’å­—èŠ‚æ•°ï¼‰ã€‚ ä¸‰ã€nginx.ingress.kubernetes.io/limit-connectionsï¼šæ¥è‡ªå•ä¸ªIPåœ°å€çš„å¹¶å‘è¿æ¥æ•°ã€‚ï¼ˆå¯ä»¥å»ºç«‹æœ€å¤§è¿æ¥æ•°ï¼‰ å››ã€nginx.ingress.kubernetes.io/limit-rpsï¼šæ¯ç§’å¯ä»ç»™å®šIPæ¥å—çš„è¿æ¥æ•°ã€‚ï¼ˆæ¯ä¸ªæº IP æ¯ä¸ªæº IP æ¯ç§’æœ€å¤§è¯·æ±‚æ¬¡æ•°ï¼‰ äº”ã€nginx.ingress.kubernetes.io/limit-rpmï¼šæ¯åˆ†é’Ÿå¯ä»ç»™å®šIPæ¥å—çš„è¿æ¥æ•°ã€‚ï¼ˆæ¯ä¸ªæº IP æ¯åˆ†é’Ÿæœ€å¤§è¯·æ±‚æ¬¡æ•°ï¼‰  å¯ä»¥æŒ‡å®š nginx.ingress.kubernetes.io/limit-whitelist è®¾ç½®ä»é€Ÿç‡é™åˆ¶ä¸­æ’é™¤çš„å®¢æˆ·ç«¯IPæºèŒƒå›´ï¼Œè¯¥å€¼ä¹Ÿæ˜¯é€—å·åˆ†éš”çš„CIDRåˆ—è¡¨ã€‚\nå¦‚æœåœ¨å•ä¸ªIngressè§„åˆ™ä¸­è®¾ç½®äº†å¤šä¸ªæ³¨é‡Š limit-rpmï¼Œåˆ™ limit-rps ä¼˜å…ˆã€‚\n1apiVersion:extensions/v1beta1 2kind:Ingress 3metadata:4name:my-ingress 5annotations:6nginx.ingress.kubernetes.io/limit-rate-after:500k7nginx.ingress.kubernetes.io/limit-rate:50k8nginx.ingress.kubernetes.io/limit-connections:\u0026#34;3\u0026#34;9nginx.ingress.kubernetes.io/limit-rps:\u0026#34;1\u0026#34;10nginx.ingress.kubernetes.io/limit-rpm:\u0026#34;3\u0026#34;11nginx.ingress.kubernetes.io/limit-whitelist:\u0026#34;192.168.7.0/24\u0026#34;12spec:13rules:14- host:my.test.com 15http:16paths:17- path:/ 18backend:19serviceName:nginx 20servicePort:80è§£é‡Šä¸€ä¸‹ï¼š\né¦–å…ˆè®¾ç½®äº†åˆå§‹å­—èŠ‚é‡æ˜¯500k\nç„¶ååˆå§‹å­—èŠ‚é‡ç”¨å®Œä¹‹åï¼Œé™åˆ¶ç”¨æˆ·ä¼ è¾“é€Ÿç‡æ˜¯50k/s\néšåå¹¶å‘è¿æ¥è®¾ç½®ä¸º3ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯å¦‚æœåŒæ—¶æ‰“å¼€3ä¸ªè¿æ¥ï¼Œæ€»é€Ÿç‡æ˜¯ 50kÃ—3=150k/s\nç¬¬å››æ­¥è¿›ä¸€æ­¥è®¾ç½®äº†æ¯ç§’æœ€å¤§è¯·æ±‚æ¬¡æ•°æ˜¯1ï¼Œä¸‹é¢åˆè®¾ç½®æ¯åˆ†é’Ÿæœ€å¤§è¯·æ±‚æ¬¡æ•°æ˜¯3ã€‚\nç¬¬äº”æ­¥è®¾ç½®äº† 192.168.7.0/24 è¿™æ®µä¸å—é™é€Ÿçš„å½±å“\nè®¾ç½®å¥½ä»¥åå‹æµ‹è¯•ä¸€ä¸‹ï¼š\nè¶…é™è¿”å›çš„ä»£ç æ˜¯503\n1wrk -c 3 -t 3 -d 10 http://m.test.com --latency 2 3 4curl -v -H \u0026#34;Host: m.test.com\u0026#34; http://m.test.com 5\u0026lt; HTTP/1.1 503 Service Temporarily Unavailable 6\u0026lt; Date: Wed, 28 Jul 2021 04:32:03 GMT 7\u0026lt; Content-Type: text/html 8\u0026lt; Content-Length: 190 9\u0026lt; Connection: keep-alive 10HTTP/1.1 503 Service Temporarily Unavailable ","date":"2021-11-29","img":"","permalink":"https://bajie.dev/posts/20211129-kubernetes_nginx_ingress_limit/","series":null,"tags":null,"title":"Kubernetesä¸‹nginx Ingressçš„é™åˆ¶"},{"categories":null,"content":"é˜¿é‡Œçš„äº‘çš„ OSS å¹¶ä¸æ˜¯å®Œå…¨ç‰ˆæœ¬çš„ AWS S3 å…¼å®¹ã€‚\næˆ‘ä»¬å¦‚æœéœ€è¦ç”¨ S3 åè®®è®¿é—® OSSï¼Œå°±æ¯”è¾ƒéº»çƒ¦äº†ã€‚\næ‰€ä»¥æ­å»ºä¸€ä¸ª minio æ¥åšç½‘å…³ï¼Œä»£ç†OSSï¼Œminio æ˜¯åŸºæœ¬å…¼å®¹S3çš„ï¼Œæ‰€ä»¥è¿™æ ·æ›²çº¿æ•‘å›½ï¼Œé€šè¿‡ S3 åè®®è®¿é—® minio æ¥è®¿é—®æœ€åç«¯çš„ OSS\nè¿™é‡Œè¿˜æœ‰ä¸€æ®µæ•…äº‹ï¼š\nMinio ä¸­é—´æœ‰ä¸€ç‰ˆæ˜¯æ”¯æŒ oss çš„ï¼Œä½†æ˜¯åæ¥ oss æ”¹äº†åè®®ï¼Œæ‰€ä»¥ç°åœ¨çš„æœ€æ–°ç‰ˆæœ¬ minio åè€Œæ˜¯ä¸æ”¯æŒä»£ç† oss çš„ï¼Œæˆ‘ä»¬å¿…é¡»æ‰‹åŠ¨ä½œå‡ºé•œåƒï¼Œæ”¾åˆ°é•œåƒåº“é‡Œï¼Œç„¶åé˜¿é‡Œ ACK å†ä½¿ç”¨\né¦–å…ˆå»ä¸‹è½½é‚£ä¸€ç‰ˆç›´æ¥æ”¯æŒossçš„\n1wget http://dl.minio.org.cn/server/minio/release/linux-amd64/archive/minio.RELEASE.2020-04-15T19-42-18Z 2 3chmod 755 minio.RELEASE.2020-04-15T19-42-18Z è¿™ä¸ªæ–‡ä»¶æ¯”è¾ƒå®è´µï¼Œç»™ä¸ªæœ¬åœ°å¤‡ä»½é“¾æ¥ä¸‹è½½ï¼š\nminio.RELEASE.2020-04-15T19-42-18Z ç„¶ååœ¨å½“å‰ç›®å½•ç¼–è¾‘ Dockerfile ï¼Œå› ä¸º K8S å’Œ OSS åŒä¸€åœ°åŸŸï¼Œæ‰€ä»¥ç”¨ OSS ç§ç½‘åŸŸåï¼š\n1FROM alpine:3.12  2 3RUN apk add --update bash \u0026amp;\u0026amp; rm -rf /var/cache/apk/*  4 5COPY minio.RELEASE.2020-04-15T19-42-18Z /data/minio.RELEASE.2020-04-15T19-42-18Z  6 7ENV MINIO_ACCESS_KEY=LTAI5tFFTbsxxxxxuLb  8ENV MINIO_SECRET_KEY=t78PyGnHZilxxxxxdxBCjvNgtVC5Y  9 10WORKDIR /data  11EXPOSE 9000  12 13CMD [\u0026#34;/data/minio.RELEASE.2020-04-15T19-42-18Z\u0026#34;,\u0026#34;gateway\u0026#34;,\u0026#34;oss\u0026#34;,\u0026#34;http://oss-cn-shanghai-internal.aliyuncs.com\u0026#34;]  14# CMD /bin/sh -c \u0026#34;while true; do echo hi; sleep 10; done\u0026#34; æ³¨æ„ä¸Šé¢ï¼ŒMINIO_ACCESS_KEY å’Œ MINIO_SECRET_KEY å¯¹åº”çš„æ˜¯é˜¿é‡Œäº‘ OSSçš„ AccessKey ID å’Œ AccessKey Secret\næ‰“å¼€é˜¿é‡Œäº‘ç½‘å€ï¼Œæ–°å»ºAccessKey ID å’Œ AccessKey Secret ï¼Œæ³¨æ„è¿™ä¸œè¥¿åªèƒ½çœ‹è§ä¸€æ¬¡ï¼Œä¹‹åå†ä¹Ÿä¸èƒ½æ˜æ–‡çœ‹äº†ï¼Œæ‰€ä»¥ç¬¬ä¸€æ¬¡åŠ¡å¿…ä¿å­˜å¥½ï¼ï¼ï¼\nhttps://ram.console.aliyun.com/manage/ak ç„¶åè¿˜æœ‰ Dockerfile çš„æœ€åä¸€è¡Œï¼Œå…«æˆ’çš„ä¹ æƒ¯æ˜¯ä¿ç•™ä¸€ä¸ªæ­»å¾ªç¯ shellï¼Œå¦‚æœé•œåƒ CMD æœ‰é—®é¢˜ï¼Œæ— æ³•å¯åŠ¨ï¼Œå°±æ¢æˆè¿™ä¸ªå…ˆå¯åŠ¨ï¼Œç„¶åå†è¿›å»è°ƒè¯•ã€‚ï¼ˆç»å¸¸æœ‰ä»€ä¹ˆåº“é”™ã€é“¾æ¥æä¸å¥½éœ€è¦ä¿®æ”¹ï¼‰\ndocker build -t registry.cn-shanghai.aliyuncs.com/rendoumi/minio . \nç„¶å push ä¸Šå»\ndocker push registry.cn-shanghai.aliyuncs.com/rendoumi/minio \nç¼–å†™å¥½Deploymentå’Œsvcï¼Œå¦‚æœæƒ³å…¬å¼€è¿˜å¯ä»¥å†™ ingress å‘å¤–æš´éœ²ï¼Œè‡ªå·±å…¬å¸ç”¨è¿˜æ˜¯ port-forward æ›´å®‰å…¨\n1--- 2apiVersion: apps/v1  3kind: Deployment  4metadata:  5 name: minio-deploy  6 labels:  7 app: minio  8spec:  9 replicas: 1  10 selector:  11 matchLabels:  12 app: minio  13 template:  14 metadata:  15 labels:  16 app: minio  17 spec:  18 containers:  19 - name: minio  20 image: registry.cn-shanghai.aliyuncs.com/rendoumi/minio:latest  21 ports:  22 - containerPort: 9000  23--- 24apiVersion: v1  25kind: Service  26metadata:  27 name: minio-svc  28 labels:  29 app: minio  30spec:  31 ports:  32 - name: http  33 protocol: TCP  34 port: 9000  35 targetPort: 9000  36 selector:  37 app: minio  38 type: ClusterIP  ç„¶åå¼€è½¬å‘ï¼š\n1kubectl port-forward svc/minio-svc 9000:9000 \u0026amp; ç”¨æµè§ˆå™¨è®¿é—® http://localhost:9000 å°±å¯ä»¥äº†ï¼Œè¿˜å¾—è¾“å…¥ä¸€éå¯†ç \nè¿™æ ·å°±å¯ä»¥çœ‹åˆ° OSS çš„æ‰€æœ‰æ¡¶äº†\nMinioçš„å®˜æ–¹å‘½ä»¤è¡Œå®¢æˆ·ç«¯æ˜¯ mcï¼Œä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š\n1wget https://dl.min.io/client/mc/release/linux-amd64/mc 2chmod 755 mc 3 4./mc alias set minio http://minio-svc:9000 MINIO_ACCESS_KEY å’Œ MINIO_SECRET_KEY 5 6./mc ls minio minio è·‘åœ¨å®¹å™¨å¤–è¿›è¡Œ OSS ä»£ç†çš„æ–¹æ³•ï¼Œæ³¨æ„ä¸åŒåœ°æ–¹ï¼ŒOSS çš„åŸŸåæ”¹ä¸ºå…¬ç½‘çš„äº†ï¼š\n1#!/bin/sh 2export MINIO_ACCESS_KEY=LTAI5tFFTbsxxxxxuLb 3export MINIO_SECRET_KEY=t78PyGnHZilxxxxxdxBCjvNgtVC5Y 4nohup ./minio.RELEASE.2020-04-15T19-42-18Z gateway oss http://oss-cn-shanghai.aliyuncs.com \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 \u0026amp; ","date":"2021-11-26","img":"","permalink":"https://bajie.dev/posts/20211126-kubernetes_minio_oss_gateway/","series":null,"tags":null,"title":"Kubernetesæ­å»ºminioä½œä¸ºé˜¿é‡ŒOSSçš„Gateway"},{"categories":null,"content":"æœ¬æ¥ k8s çš„ crontab æ˜¯å¯åŠ¨ä¸€ä¸ªå®¹å™¨æ¥è¿è¡Œçš„ï¼Œå¾ˆç®€å•ï¼Œå¦‚ä¸‹ï¼š\n1apiVersion:batch/v1beta12kind:CronJob3metadata:4name:curl-cron5spec:6schedule:\u0026#34;*/1 * * * *\u0026#34;7jobTemplate:8spec:9template:10spec:11containers:12- name:curl-cron13image:radial/busyboxplus:curl14imagePullPolicy:IfNotPresent15command:16- /bin/sh17- -c18- date;echo \u0026#34;run crontab\u0026#34;;curl http://www.baidu.com19restartPolicy:OnFailure20successfulJobsHistoryLimit:221failedJobsHistoryLimit:2ä¸Šé¢å°±è·‘äº†ä¸€ä¸ª busybox çš„ podï¼Œæ¯åˆ†é’Ÿå»è®¿é—®ç™¾åº¦ï¼Œç„¶ååœ¨ stdout è¾“å‡ºç»“æœ\nè¿™ä¸ªæ²¡ä»€ä¹ˆï¼Œæ³¨æ„ä¸Šé¢æ–‡ä»¶çš„æœ€åä¸¤è¡Œã€‚é™åˆ¶æˆåŠŸä»¥åŠå¤±è´¥ job çš„ History æ•°é‡ï¼Œå¦‚æœä¸åŠ é™åˆ¶ï¼Œkubectl get pods ä¼šçœ‹åˆ°æ— ç©·æ— å°½çš„completed çŠ¶æ€çš„ curl-cron podã€‚\n  åˆ†å‰²çº¿ï¼Œéƒ¨ç½² crontab çš„ yaml å¾ˆç®€å•ã€‚ä½†æ˜¯ï¼Œç°åœ¨äº§å“éƒ¨æœ‰ä¸ªéœ€æ±‚ï¼Œä»–ä»¬è¦åœ¨æŸä¸€å¤©è¿›è¡Œä¿ƒé”€æ´»åŠ¨ï¼Œå¤§æ¦‚2å¤©ï¼ŒæœŸé—´ä¼šæµé‡å¤§å¢ï¼Œäºæ˜¯æƒ³åº”ç”¨ hpa æ¥ä¼¸ç¼© podï¼Œæ´»åŠ¨ç»“æŸåå…³é—­ hpaã€‚ä¹‹åä»–ä»¬è¿˜ä¼šæœ‰ä¸æ–­çš„ä¿ƒé”€ï¼Œç ”å‘ä¸çŸ¥é“ä»€ä¹ˆæ—¶å€™å¼€å§‹ï¼Œä»€ä¹ˆæ—¶å€™ç»“æŸï¼›ä½†æ˜¯ç ”å‘åˆä¸æƒ³äº§å“éƒ¨çœ‹åˆ° yamlï¼Œå¹¶ä¸”éšæ—¶é…åˆéƒ¨ç½² hpaã€‚\nè¿˜æœ‰ä¸ªé—®é¢˜ï¼Œå¦‚æœç”¨crontabï¼Œé‚£ä¹ˆæ´»åŠ¨å¼€å§‹è¿è¡Œä¸€æ¬¡ï¼Œæ´»åŠ¨ç»“æŸä¸€æ¬¡ï¼Œæœ€åç ”å‘è¿˜å¾—æ¸…ç†åˆ é™¤æ‰è¿™ä¸¤ä¸ª crontab æ¥æ¢å¤æ­£å¸¸ã€‚\nè¿™ä¸‹éº»çƒ¦äº†ï¼Œæœ‰ä»€ä¹ˆé¡µé¢ç®¡ç† crontab çš„ç¥å™¨ï¼Œèƒ½è®©äº§å“éƒ¨è‡ªå·±è¿è¡Œï¼Œç„¶åæƒé™åˆ†ç¦»ï¼Œè€Œä¸”èƒ½æŒ‡å®šå†æœªæ¥çš„æŸå¤©è¿è¡Œä¸€æ¬¡æˆ–å¤šæ¬¡ï¼Œä¸”ä¸ç”¨æ‰‹å·¥æ¸…ç†å°±å¥½äº†ã€‚\nè¿˜çœŸçš„æœ‰ä¸€ä¸ªï¼Œkala å°±æ˜¯äº†ï¼ï¼ï¼\nKala æ˜¯ä¸€ä¸ªcronç®¡ç†é…ç½®å·¥å…·ï¼Œé¡¹ç›®åœ°å€ï¼š\nhttps://github.com/ajvb/kala å¡æ‹‰æ˜¯åŸºäº Airbnb çš„ Chronos ç¿»å†™çš„ Go ç¨‹åºã€‚\nå®ƒæ¯” crontab æ›´å¥½ä¸€äº›çš„æ˜¯ï¼Œå¯ä»¥æŒ‡å®šæœªæ¥æŸå¤©çš„ä¸€æ¬¡æ€§æ‰§è¡Œä»»åŠ¡ï¼Œæœ‰ä¸ªä½¿ç”¨ç•Œé¢\nKala å¯ä»¥æ‰§è¡Œæœ¬åœ°çš„å‘½ä»¤ï¼Œä¹Ÿå¯ä»¥å‘èµ· http çš„è¯·æ±‚ã€‚\næ³¨æ„ï¼Œkala çš„æºä»£ç é‡Œæœ‰ä¸€ä¸ªåœ°æ–¹éœ€è¦ä¿®æ”¹ï¼Œå¦åˆ™å‚æ•°bolt-pathä¸ç”Ÿæ•ˆï¼Œæˆ‘ä»¬æ”¹æ‰å®ƒè‡ªå·±ç¼–è¯‘ä¸ª2è¿›åˆ¶ç¨‹åºå‡ºæ¥ã€‚\n1Modify cmd/server.go 2 3switch viper.GetString(\u0026#34;jobdb\u0026#34;) { 4case \u0026#34;boltdb\u0026#34;: 5db = boltdb.GetBoltDB(viper.GetString(\u0026#34;boltpath\u0026#34;)) 6 7Change to 8db = boltdb.GetBoltDB(viper.GetString(\u0026#34;bolt-path\u0026#34;)) 9 10Run it : 11./kala serve --jobdb=boltdb --bolt-path=/data/db æˆ‘ä»¬ç”¨ Dockerfile é€ ä¸€ä¸ªé•œåƒå‡ºæ¥ï¼š\n1FROM alpine:3.12 2RUN apk add --update bash \u0026amp;\u0026amp; rm -rf /var/cache/apk/* 3 4COPY . /data/ 5 6RUN mkdir /lib64 \u0026amp;\u0026amp; \\ 7 ln -s /lib/libc.musl-x86_64.so.1 /lib64/ld-linux-x86-64.so.2 \u0026amp;\u0026amp; \\ 8 mv /data/kubectl /bin \u0026amp;\u0026amp; \\ 9 mv /data/.kube /root \u0026amp;\u0026amp; \\ 10 rm -rf /data/Dockerfile 11 12WORKDIR /data 13EXPOSE 8000 14 15CMD [\u0026#34;/data/kala\u0026#34;, \u0026#34;serve\u0026#34;,\u0026#34;--jobdb=boltdb\u0026#34;,\u0026#34;--bolt-path=/data/db\u0026#34;] 16#CMD /bin/sh -c \u0026#34;while true; do echo hi; sleep 10; done\u0026#34; æ³¨æ„ä¸Šé¢æˆ‘ä»¬æŠŠ kubectl å’Œ .kube é…ç½®ä¸€èµ·æ”¾è¿›äº†é•œåƒï¼Œå½“ç„¶ä¸€äº› yaml å’Œè„šæœ¬ä¹Ÿå¯ä»¥éƒ½æ‰“è¿›å»ï¼Œç„¶åæ¨åˆ°é˜¿é‡Œäº‘é•œåƒä»“åº“å»ï¼ˆæ³¨æ„å®‰å…¨é—®é¢˜ï¼‰ã€‚\nå¤‡æ³¨ ï¼škalaé»˜è®¤çš„ç«¯å£æ˜¯8000ï¼Œè®¿é—® url æ˜¯ /webui\nç„¶åæˆ‘ä»¬ç”Ÿæˆä¸€ä¸ª secret æ”¾è¿› k8s\n1htpasswd -c auth kala-auth 2New password: 3Re-type new password: 4Adding password for user kala 5 6kubectl create secret generic kala-auth --from-file=kala-auth 7secret \u0026#34;kala-auth\u0026#34; created 8 9kubectl get secret kala-auth -o yaml ç„¶åæˆ‘ä»¬å®šä¹‰ä¸€ç³»åˆ—çš„èµ„æºæ–‡ä»¶ï¼ŒDeploymentã€SVCã€Ingressï¼Œå…¶ä¸­ ingress å¼•ç”¨äº† kala-auth çš„ secretï¼Œå¹¶ä¸”æŒ‡å®šäº† app-root æ˜¯ /webui/ã€‚\nå¦å¤– kala ä½¿ç”¨äº† k8s-kala-5g çš„æŒä¹…åŒ–å·ï¼ŒåŠ¡å¿…äº‹å…ˆå‡†å¤‡å¥½ pv å’Œ pvcï¼Œä¸æŒä¹…åŒ–çš„è¯ pod ä¸€é‡å¯ï¼Œä¹‹å‰ä¿å­˜çš„é…ç½®ä¿¡æ¯å°±å…¨æ²¡äº†ã€‚\n1---2apiVersion:apps/v13kind:Deployment4metadata:5name:kala-deploy6labels:7app:kala8spec:9replicas:110selector:11matchLabels:12app:kala13template:14metadata:15labels:16app:kala17spec:18containers:19- name:kala20image:registry.cn-shanghai.aliyun.com/xxx/kala:latest21imagePullPolicy:Always22ports:23- containerPort:800024volumeMounts:25- mountPath:/data/db26name:kala-data27volumes:28- name:kala-data29persistentVolumeClaim:30claimName:k8s-kala-5g31---32apiVersion:v133kind:Service34metadata:35name:kala-svc36labels:37app:kala38spec:39ports:40- name:http41protocol:TCP42port:800043targetPort:800044selector:45app:kala46type:ClusterIP47---48apiVersion:networking.k8s.io/v1beta149kind:Ingress50metadata:51name:kala-com-ingress52annotations:53kubernetes.io/ingress.class:nginx54nginx.ingress.kubernetes.io/block-cidrs:111.201.134.93/3255nginx.ingress.kubernetes.io/auth-type:basic56nginx.ingress.kubernetes.io/auth-secret:kala-auth57nginx.ingress.kubernetes.io/auth-realm:\u0026#39;Authentication Required - Kala\u0026#39;58nginx.ingress.kubernetes.io/app-root:\u0026#39;/webui/\u0026#39;59spec:60rules:61- host:kala.rendoumi.com62http:63paths:64- path:/65backend:66serviceName:kala-svc67servicePort:80è¿™æ · kala å°±å¯ä»¥ä»å…¬ç½‘è®¿é—®äº†ï¼Œhttp://kala.rendoumi.com:8000/ ï¼Œä¸”éœ€è¦æä¾›å¯†ç æ‰èƒ½è¿›å…¥ã€‚\nä¸‹é¢è¯´ä¸€ä¸‹å…·ä½“çš„ç”¨æ³•ï¼Œè¿˜æ˜¯æœ‰ä¸€äº›æŠ€å·§æ€§çš„ï¼Œç™»å½•è¿›å»åçš„é¡µé¢ï¼š\nè¿›å…¥åå·¦ä¸Šè§’ç‚¹å‡» Create å»ºç«‹æ–°ä»»åŠ¡\nè¦å¡«å†™å†…å®¹å¦‚ä¸‹ï¼š\n  Job nameï¼šèµ·ä¸ªåå­—ï¼Œå«ï¼šå¢å¤§HPA\n  Commandï¼šè¦è¿è¡Œçš„è„šæœ¬ï¼š/data/resize.sh 35 (å›ºå®šæ‰©å¤§ECIçš„è„šæœ¬)\n  Scheduleï¼šR0/2021-07-07T06:00:00+08:00/PT0S\n  â€‹ è¿™ä¸ªæœ€é‡è¦\nâ€‹ è¿™è¡Œçš„æ ¼å¼æ˜¯è¿™æ ·çš„ï¼šNumber of times to repeat/Start Datetime/Interval Between Runs\nâ€‹ R0 é‡å¤0æ¬¡ï¼Œå³åªæ‰§è¡Œä¸€æ¬¡ï¼Œä¸é‡å¤\nâ€‹ 2021-07-06T06:00:00+8:00 æ—¶é—´æˆ³ï¼Œæ³¨æ„æ—¶åŒºä¸­å›½+8:00\nâ€‹ PT0S æ— å»¶è¿Ÿ0Så¯åŠ¨\nâ€‹ åˆèµ·æ¥å°±æ˜¯\nâ€‹ R0/2021-07-07T06:00:00+08:00/PT0S å°±æ˜¯åœ¨2021å¹´7æœˆ7æ—¥ä¸­å›½æ—¶é—´6ç‚¹æ— ä»»ä½•å»¶è¿Ÿæ‰§è¡Œä¸€æ¬¡è„šæœ¬ resize.sh\n Reset Form è¿™ä¸ªä¸€å®šè¦é€‰æ‰ï¼Œä¿æŒç©ºï¼Œå¦åˆ™ä¸‹æ¬¡è¿›æ¥ä¸Šæ¬¡çš„æ•°æ®éƒ½æ²¡äº†ï¼Œè¿˜å¾—æ‰‹åŠ¨è¾“å…¥ï¼Œéº»çƒ¦  å…¶ä»–éƒ½ä¸å¡«å†™ï¼Œç„¶å Create å°±è¡Œäº†\nç„¶åæˆ‘ä»¬å¯ä»¥å†å»ºä¸€ä¸ªæ¢å¤çš„ä»»åŠ¡\næˆ‘ä»¬å»ç•Œé¢å°±å¯ä»¥çœ‹åˆ°å¤šäº†ä¸¤ä¸ªä»»åŠ¡ï¼Œå¢å¤§HPAå’Œæ¢å¤HPAï¼Œè¿™æ ·å°± OK äº†\næ³¨æ„ï¼šJOBä¸€æ—¦å»ºç«‹ï¼Œä»¥åå°±å¯ä»¥ç›´æ¥ä»ç•Œé¢ä¸Šæ‰‹åŠ¨æ‰§è¡Œï¼ŒRun Manually\nè¿™ä¸œè¥¿çœŸæ˜¯ä¸ªç¥å™¨ï¼Œäº§å“éƒ¨çš„åŒäº‹å¯ä»¥éšæ—¶ä¿®æ”¹hpaå’Œæ¢å¤ï¼Œè€Œä¸ç”¨é€šè¿‡ç ”å‘éƒ¨äº†ï¼Œå–„è«å¤§ç„‰ã€‚\n","date":"2021-11-25","img":"","permalink":"https://bajie.dev/posts/20211125-kubernetes_crontab_kala/","series":null,"tags":null,"title":"æ›¿ä»£kubernetes Crontabçš„ç¥å™¨kala"},{"categories":null,"content":"kubernetes çš„åŠ¨æ€ä¼¸ç¼© HPA æ˜¯éå¸¸æœ‰ç”¨çš„ç‰¹æ€§ã€‚\næˆ‘ä»¬çš„æœåŠ¡å™¨æ‰˜ç®¡åœ¨é˜¿é‡Œäº‘çš„ ACK ä¸Šï¼Œk8s æ ¹æ® cpu æˆ–è€… å†…å­˜çš„ä½¿ç”¨æƒ…å†µï¼Œä¼šè‡ªåŠ¨ä¼¸ç¼©å…³é”® pod çš„æ•°é‡ï¼Œä»¥åº”å¯¹å¤§æµé‡çš„æƒ…å½¢ã€‚è€Œä¸”æ›´å¦™çš„æ˜¯ï¼ŒåŠ¨æ€æ‰©å±•çš„ pod å¹¶ä¸æ˜¯ä½¿ç”¨è‡ªå·±çš„å›ºå®šæœåŠ¡å™¨ï¼Œè€Œæ˜¯ä½¿ç”¨é˜¿é‡ŒåŠ¨æ€çš„ ECI è™šæ‹ŸèŠ‚ç‚¹æœåŠ¡å™¨ï¼Œè¿™æ ·å°±çœŸçš„æ˜¯å³å¼€å³ç”¨ï¼Œç”¨å®Œå³æ¯ã€‚æœ‰å¤šå¤§æµé‡ä»˜å¤šå°‘é’±ï¼Œç‰©å°½å…¶ç”¨ã€‚\næˆ‘ä»¬å…ˆæ˜ç¡®ä¸€ä¸‹æ¦‚å¿µï¼š\nk8s çš„èµ„æºæŒ‡æ ‡è·å–æ˜¯é€šè¿‡ api æ¥å£æ¥è·å¾—çš„ï¼Œæœ‰ä¸¤ç§ apiï¼Œä¸€ç§æ˜¯æ ¸å¿ƒæŒ‡æ ‡ï¼Œä¸€ç§æ˜¯è‡ªå®šä¹‰æŒ‡æ ‡ã€‚\n  æ ¸å¿ƒæŒ‡æ ‡ï¼šCore metricsï¼Œç”±metrics-serveræä¾›APIï¼Œå³ metrics.k8s.ioï¼Œä»…æä¾›Nodeå’ŒPodçš„CPUå’Œå†…å­˜ä½¿ç”¨æƒ…å†µã€‚api æ˜¯ metrics.k8s.io\n  è‡ªå®šä¹‰æŒ‡æ ‡ï¼šCustom Metricsï¼Œç”±Prometheus Adapteræä¾›APIï¼Œå³ custom.metrics.k8s.ioï¼Œç”±æ­¤å¯æ”¯æŒä»»æ„Prometheusé‡‡é›†åˆ°çš„è‡ªå®šä¹‰æŒ‡æ ‡ã€‚api æ˜¯ custom.metrics.k8s.io å’Œ external.metrics.k8s.io\n  ä¸€ã€æ ¸å¿ƒæŒ‡æ ‡metrics-server é˜¿é‡Œçš„ ACK ç¼ºçœæ˜¯è£…äº† metrics-server çš„ï¼Œçœ‹ä¸€ä¸‹ï¼Œç³»ç»Ÿé‡Œæœ‰ä¸€ä¸ªmetrics-server\n1kubectl get pods -n kube-system å†çœ‹çœ‹ api çš„æ ¸å¿ƒæŒ‡æ ‡èƒ½æ‹¿åˆ°ä»€ä¹ˆï¼Œå…ˆçœ‹ Node çš„æŒ‡æ ‡ï¼š\n1kubectl get --raw \u0026#34;/apis/metrics.k8s.io\u0026#34; | jq . 2kubectl get --raw \u0026#34;/apis/metrics.k8s.io/v1beta1\u0026#34; | jq . 3kubectl get --raw \u0026#34;/apis/metrics.k8s.io/v1beta1/nodes\u0026#34; | jq . å¯ä»¥çœ‹åˆ°é˜¿é‡Œ eci è™šæ‹ŸèŠ‚ç‚¹çš„ cpu å’Œ memory èµ„æºã€‚\nå†çœ‹çœ‹ Pod çš„æŒ‡æ ‡ï¼š\n1kubectl get --raw \u0026#34;/apis/metrics.k8s.io/v1beta1/pods\u0026#34; | jq . å¯ä»¥æ¸…æ¥šå¾—çœ‹åˆ°è°ƒåº¦åˆ°è™šæ‹ŸèŠ‚ç‚¹ä¸Šçš„ Pod çš„ cpu å’Œ memory èµ„æºä½¿ç”¨æƒ…å†µã€‚å¤§å®¶çœ‹åˆ°åªæœ‰ cpu å’Œ memoryï¼Œè¿™å°±å¤Ÿäº†ã€‚\nç»™ä¸ªå…¨éƒ¨ä½¿ç”¨è‡ªå·± Work Node å®ä½“èŠ‚ç‚¹ä¼¸ç¼©çš„ä¾‹å­ï¼š\nphp-hpa.yaml (è¿™é‡Œå®šä¹‰äº†å¹³å‡cpuä½¿ç”¨åˆ°è¾¾80%æˆ–è€…å†…å­˜å¹³å‡ä½¿ç”¨åˆ°200Må°±ä¼¸ç¼©ï¼‰ï¼š\nphp-hpa è§„èŒƒäº† php-deploy å¦‚ä½•ä¼¸ç¼©ï¼Œæœ€å°2ï¼Œæœ€å¤§10ï¼š\n1apiVersion: autoscaling/v2beta1  2kind: HorizontalPodAutoscaler  3metadata:  4 name: php-hpa 5 namespace: default 6spec:  7 scaleTargetRef:  8 apiVersion: extensions/v1beta1  9 kind: Deployment  10 name: php-deploy 11 minReplicas: 2  12 maxReplicas: 10  13 metrics:  14 - type: Resource  15 resource:  16 name: cpu  17 targetAverageUtilization: 80  18 - type: Resource  19 resource:  20 name: memory  21 targetAverageValue: 200Mi å†ç»™ä¸ªé˜¿é‡Œ ACK ä½¿ç”¨ ECI è™šæ‹ŸèŠ‚ç‚¹ä¼¸ç¼©çš„ä¾‹å­ï¼š\næˆ‘ä»¬é¦–å…ˆå®šä¹‰ä¸€ä¸ªæ­£å¸¸çš„ deployment ï¼Œphp-deployï¼Œè¿™ä¸ªå°±æ­£å¸¸å®šä¹‰è·Ÿåˆ«çš„æ²¡åŒºåˆ«ã€‚\nç„¶åå†å®šä¹‰æ‰©å±•åˆ° eci èŠ‚ç‚¹çš„ ElasticWorloadï¼Œelastic-phpï¼Œè¿™ä¸ªç”¨æ¥æ§åˆ¶ php-deploy æ‹“å±•åˆ° eci è™šæ‹ŸèŠ‚ç‚¹å»\nä¸‹é¢æ˜¯å›ºå®š6ä¸ªï¼ŒåŠ¨æ€24ä¸ªï¼Œåˆè®¡30ä¸ª\n1apiVersion: autoscaling.alibabacloud.com/v1beta1 2kind: ElasticWorkload 3metadata: 4 name: elastic-php 5spec: 6 sourceTarget: 7 name: php-deploy 8 kind: Deployment 9 apiVersion: apps/v1 10 min: 0 11 max: 6 12 elasticUnit: 13 - name: virtual-kubelet 14 labels: 15 virtual-kubelet: \u0026#34;true\u0026#34; 16 alibabacloud.com/eci: \u0026#34;true\u0026#34; 17 annotations: 18 virtual-kubelet: \u0026#34;true\u0026#34; 19 nodeSelector: 20 type: \u0026#34;virtual-kubelet\u0026#34; 21 tolerations: 22 - key: \u0026#34;virtual-kubelet.io/provider\u0026#34; 23 operator: \u0026#34;Exists\u0026#34; 24 min: 0 25 max: 24 26 replicas: 30 ç„¶åå®šä¹‰ HPA php-hpa æ¥æ§åˆ¶ elastic-php çš„è‡ªåŠ¨ä¼¸ç¼©\n1apiVersion: autoscaling/v2beta2  2kind: HorizontalPodAutoscaler  3metadata:  4 name: php-hpa  5 namespace: default  6spec:  7 scaleTargetRef:  8 apiVersion: autoscaling.alibabacloud.com/v1beta1  9 kind: ElasticWorkload  10 name: elastic-php  11 minReplicas: 6  12 maxReplicas: 30  13 metrics:  14 - type: Resource  15 resource:  16 name: cpu  17 target:  18 type: Utilization  19 averageUtilization: 90  20 behavior:  21 scaleUp:  22 policies:  23 #- type: percent  24 # value: 500%  25 - type: Pods  26 value: 5  27 periodSeconds: 180  28 scaleDown:  29 policies:  30 - type: Pods  31 value: 1  32 periodSeconds: 600  ä¸Šé¢çš„ ElasticWorkload éœ€è¦ä»”ç»†è§£é‡Šä¸€ä¸‹ï¼Œphp-deploy å®šä¹‰çš„ pod å‰¯æœ¬å›ºå®šæ˜¯6ä¸ªï¼Œè¿™6ä¸ªéƒ½æ˜¯åœ¨æˆ‘ä»¬è‡ªå·±èŠ‚ç‚¹ä¸Šä¸ç”¨å†ä»˜è´¹ï¼Œç„¶å ECI çš„ pod å‰¯æœ¬æ•°æ˜¯0ä¸ªåˆ°24ä¸ªï¼Œé‚£ä¹ˆæ€»ä½“podæ•°é‡å°±æ˜¯ 6+24 = 30 ä¸ªï¼Œå…¶ä¸­ 24ä¸ªæ˜¯å¯ä»¥åœ¨è™šæ‹ŸèŠ‚ç‚¹ä¸Šä¼¸ç¼©çš„ã€‚è€Œ php-hpa å®šä¹‰äº†ä¼¸ç¼©èŒƒå›´æ˜¯ 6-30ï¼Œé‚£å°±æ„å‘³ç€å¹³æ—¶æµé‡å°çš„æ—¶å€™ç”¨çš„éƒ½æ˜¯è‡ªå·±æœåŠ¡å™¨ä¸Šé‚£6ä¸ªå›ºå®š podï¼Œå¦‚æœæµé‡å¤§äº†ï¼Œå°±ä¼šæ‰©å¤§åˆ° eci è™šæ‹ŸèŠ‚ç‚¹ä¸Šï¼Œè™šæ‹ŸèŠ‚ç‚¹æœ€å¤§é‡æ˜¯24ä¸ªï¼Œå¦‚æœæµé‡é™ä¸‹æ¥äº†ï¼Œå°±ä¼šç¼©å›å»ï¼Œç¼©åˆ°è‡ªå·±æœåŠ¡å™¨çš„6ä¸ªpod ä¸Šå»ã€‚è¿™æ ·å¯ä»¥ç²¾ç¡®æ§åˆ¶æˆæœ¬ã€‚\nphp-hpa å®šä¹‰çš„æœ€ä¸‹é¢ï¼Œæ‰©å¤§çš„æ—¶å€™å¦‚æœ cpu åˆ°äº† 90%ï¼Œé‚£ä¹ˆä¸€æ¬¡æ€§æ‰©å¤§5ä¸ªpodï¼Œç¼©å°çš„æ—¶å€™ä¸€ä¸ªä¸€ä¸ªç¼©ï¼Œè¿™æ ·é¿å…å¸¦æ¥æµé‡çš„æ¯›åˆºã€‚\näºŒã€è‡ªå®šä¹‰æŒ‡æ ‡Prometheus å¦‚ä¸Šå…¶å®å·²ç»å¯ä»¥æ»¡è¶³å¤§å¤šæ•°è¦æ±‚äº†ï¼Œä½†æ˜¯æƒ³æ›´è¿›ä¸€æ­¥ï¼Œæ¯”å¦‚æƒ³ä» Prometheus æ‹¿åˆ°çš„æŒ‡æ ‡æ¥è¿›è¡Œ hpa ä¼¸ç¼©ã€‚\né‚£å°±æ¯”è¾ƒéº»çƒ¦äº†\nçœ‹ä¸Šå›¾ï¼ŒPrometheus Operator é€šè¿‡ http æ‹‰å– pod çš„ metric æŒ‡æ ‡ï¼ŒPrometheus Adaptor å†æ‹‰å– Prometheus Operator å­˜å‚¨çš„æ•°æ®å¹¶ä¸”æš´éœ²ç»™ Custom API ä½¿ç”¨ã€‚ä¸ºå•¥è¦å¼„è¿™äºŒä¸ªä¸œè¥¿å‘¢ï¼Ÿå› ä¸º Prometheus é‡‡é›†åˆ°çš„ metrics æ•°æ®å¹¶ä¸èƒ½ç›´æ¥ç»™ k8s ç”¨ï¼Œå› ä¸ºä¸¤è€…æ•°æ®æ ¼å¼ä¸å…¼å®¹ï¼Œè¿˜éœ€è¦å¦å¤–ä¸€ä¸ªç»„ä»¶(kube-state-metrics)ï¼Œå°†prometheus çš„ metrics æ•°æ®æ ¼å¼è½¬æ¢æˆ k8s API æ¥å£èƒ½è¯†åˆ«çš„æ ¼å¼ï¼Œè½¬æ¢ä»¥åï¼Œå› ä¸ºæ˜¯è‡ªå®šä¹‰APIï¼Œæ‰€ä»¥è¿˜éœ€è¦ç”¨ Kubernetes aggregator åœ¨ä¸» API æœåŠ¡å™¨ä¸­æ³¨å†Œï¼Œä»¥ä¾¿å…¶ä»–ç¨‹åºç›´æ¥é€šè¿‡ /apis/ æ¥è®¿é—®ã€‚\næˆ‘ä»¬é¦–å…ˆæ¥çœ‹çœ‹å¦‚ä½•å®‰è£…è¿™äºŒä¸ªä¸œè¥¿ï¼š\né¦–å…ˆè£… Prometheus Operatorï¼Œè¿™å®¶ä¼™ä¼šè‡ªåŠ¨è£…ä¸€æ†ä¸œè¥¿ï¼Œ Pormetheusã€Grafanaã€Alert managerç­‰ï¼Œæ‰€ä»¥æœ€å¥½ç»™å®ƒå•ç‹¬å¼„ä¸€ä¸ªå‘½åç©ºé—´\n prometheus-operator  prometheus  alertmanager  node-exporter  kube-state-metrics  grafana   1#å®‰è£… 2helm install --name prometheus --namespace monitoring stable/prometheus-operator 3 4#å¼€ä¸ªç«¯å£æœ¬åœ°è®¿é—® prometheus çš„é¢æ¿ï¼Œcurl http://localhost:9090 5kubectl port-forward --namespace monitoring svc/prometheus-operator-prometheus 9090:9090 6 7 8#çœ‹çœ‹éƒ½æœ‰ä»€ä¹ˆpod 9kubectl get pod -n monitoring 10NAME READY STATUS RESTARTS AGE 11pod/alertmanager-prometheus-operator-alertmanager-0 2/2 Running 0 98m 12pod/prometheus-operator-grafana-857dfc5fc8-vdnff 2/2 Running 0 99m 13pod/prometheus-operator-kube-state-metrics-66b4c95cd9-mz8nt 1/1 Running 0 99m 14pod/prometheus-operator-operator-56964458-8sspk 2/2 Running 0 99m 15pod/prometheus-operator-prometheus-node-exporter-dcf5p 1/1 Running 0 99m 16pod/prometheus-operator-prometheus-node-exporter-nv6ph 1/1 Running 0 99m 17pod/prometheus-prometheus-operator-prometheus-0 3/3 Running 1 98m 18 19#çœ‹çœ‹éƒ½æœ‰ä»€ä¹ˆsvc 20kubectl get svc -n monitoring 21NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE 22alertmanager-operated ClusterIP None \u0026lt;none\u0026gt; 9093/TCP,9094/TCP,9094/UDP 100m 23prometheus-operated ClusterIP None \u0026lt;none\u0026gt; 9090/TCP 100m 24prometheus-operator-alertmanager NodePort 10.1.238.78 \u0026lt;none\u0026gt; 9093:31765/TCP 102m 25prometheus-operator-grafana NodePort 10.1.125.228 \u0026lt;none\u0026gt; 80:30284/TCP 102m 26prometheus-operator-kube-state-metrics ClusterIP 10.1.187.129 \u0026lt;none\u0026gt; 8080/TCP 102m 27prometheus-operator-operator ClusterIP 10.1.242.61 \u0026lt;none\u0026gt; 8080/TCP,443/TCP 102m 28prometheus-operator-prometheus NodePort 10.1.156.181 \u0026lt;none\u0026gt; 9090:30268/TCP 102m 29prometheus-operator-prometheus-node-exporter ClusterIP 10.1.226.134 \u0026lt;none\u0026gt; 9100/TCP 102m æˆ‘ä»¬çœ‹åˆ°æœ‰ prometheus-operated è¿™ä¸ªClusterIP svcï¼Œæ³¨æ„ k8s çš„ coredns åŸŸåè§£ææ–¹å¼ï¼Œé›†ç¾¤çš„å†…éƒ¨åŸŸåæ˜¯ hbb.localï¼Œé‚£ä¹ˆè¿™ä¸ª svc çš„å…¨ hostname å°±æ˜¯ prometheus-operated.monitoring.svc.hbb.localï¼Œé›†ç¾¤ä¸­å¯ä»¥å–èˆåˆ° prometheus-operated.monitoring æˆ–è€… prometheus-operated.monitoring.svc æ¥è®¿é—®ã€‚\nç„¶åå†è£… Prometheus Adaptorï¼Œæˆ‘ä»¬è¦æ ¹æ®ä¸Šé¢çš„å…·ä½“æƒ…å†µæ¥è®¾ç½® prometheus.urlï¼š\n1helm install --name prometheus-adapter stable/prometheus-adapter --set prometheus.url=\u0026#34;http://prometheus-operated.monitoring.svc\u0026#34;,prometheus.port=\u0026#34;9090\u0026#34; --set image.tag=\u0026#34;v0.4.1\u0026#34; --set rbac.create=\u0026#34;true\u0026#34; --namespace custom-metrics 2 è®¿é—® external å’Œ custom éªŒè¯ä¸€ä¸‹ï¼š\n1kubectl get --raw \u0026#34;/apis/external.metrics.k8s.io/v1beta1\u0026#34; | jq 2{ 3 \u0026#34;kind\u0026#34;: \u0026#34;APIResourceList\u0026#34;, 4 \u0026#34;apiVersion\u0026#34;: \u0026#34;v1\u0026#34;, 5 \u0026#34;groupVersion\u0026#34;: \u0026#34;external.metrics.k8s.io/v1beta1\u0026#34;, 6 \u0026#34;resources\u0026#34;: [] 7} 8 9kubectl get --raw \u0026#34;/apis/custom.metrics.k8s.io/v1beta1\u0026#34; | jq 10{ 11 \u0026#34;kind\u0026#34;: \u0026#34;APIResourceList\u0026#34;, 12 \u0026#34;apiVersion\u0026#34;: \u0026#34;v1\u0026#34;, 13 \u0026#34;groupVersion\u0026#34;: \u0026#34;custom.metrics.k8s.io/v1beta1\u0026#34;, 14 \u0026#34;resources\u0026#34;: [ 15 { 16 \u0026#34;name\u0026#34;: \u0026#34;*/agent.googleapis.com|agent|api_request_count\u0026#34;, 17 \u0026#34;singularName\u0026#34;: \u0026#34;\u0026#34;, 18 \u0026#34;namespaced\u0026#34;: true, 19 \u0026#34;kind\u0026#34;: \u0026#34;MetricValueList\u0026#34;, 20 \u0026#34;verbs\u0026#34;: [ 21 \u0026#34;get\u0026#34; 22 ] 23 }, 24[...lots more metrics...] 25 { 26 \u0026#34;name\u0026#34;: \u0026#34;*/vpn.googleapis.com|tunnel_established\u0026#34;, 27 \u0026#34;singularName\u0026#34;: \u0026#34;\u0026#34;, 28 \u0026#34;namespaced\u0026#34;: true, 29 \u0026#34;kind\u0026#34;: \u0026#34;MetricValueList\u0026#34;, 30 \u0026#34;verbs\u0026#34;: [ 31 \u0026#34;get\u0026#34; 32 ] 33 } 34 ] 35} é‡å¤´æˆåœ¨ä¸‹é¢ï¼Œå…¶å® Prometheus Adaptor ä» Prometheus æ‹¿çš„æŒ‡æ ‡ä¹Ÿæ˜¯æœ‰é™çš„ï¼Œå¦‚æœæœ‰è‡ªå®šä¹‰æŒ‡æ ‡ï¼Œæˆ–è€…æƒ³å¤šæ‹¿äº›ï¼Œå°±å¾—ç»§ç»­æ‹“å±•ï¼ï¼ï¼\næœ€å¿«çš„æ–¹å¼æ˜¯ç¼–è¾‘ namespace æ˜¯ custom-metrics ä¸‹çš„ configmap ï¼Œåå­—æ˜¯ Prometheus-adapterï¼Œå¢åŠ seriesQuery\nseriesQueryé•¿è¿™æ ·å­ï¼Œä¸‹é¢æ˜¯ç»Ÿè®¡äº†æ‰€æœ‰ app=shopping-kart çš„ pod 5åˆ†é’Ÿä¹‹å†…çš„å˜åŒ–é€Ÿç‡æ€»å’Œï¼š\n1apiVersion: v1 2kind: ConfigMap 3metadata: 4 labels: 5 app: prometheus-adapter 6 chart: prometheus-adapter-v1.2.0 7 heritage: Tiller 8 release: prometheus-adapter 9 name: prometheus-adapter 10data: 11 config.yaml: | 12- seriesQuery: \u0026#39;{app=\u0026#34;shopping-kart\u0026#34;,kubernetes_namespace!=\u0026#34;\u0026#34;,kubernetes_pod_name!=\u0026#34;\u0026#34;}\u0026#39; 13seriesFilters: [] 14resources: 15overrides: 16kubernetes_namespace: 17resource: namespace 18kubernetes_pod_name: 19resource: pod 20name: 21matches: \u0026#34;\u0026#34; 22as: \u0026#34;\u0026#34; 23metricsQuery: sum(rate(\u0026lt;\u0026lt;.Series\u0026gt;\u0026gt;{\u0026lt;\u0026lt;.LabelMatchers\u0026gt;\u0026gt;}[5m])) by (\u0026lt;\u0026lt;.GroupBy\u0026gt;\u0026gt;) 24 Adapter configmapçš„é…ç½®å¦‚ä¸‹ï¼š\n  seriesQuery tells the Prometheus Metric name to the adapterï¼ˆè¦å»prometheusæ‹¿ä»€ä¹ˆæŒ‡æ ‡ï¼‰\n  resources tells which Kubernetes resources each metric is associated with or which labels does the metric include, e.g., namespace, pod etc.ï¼ˆå…³è”çš„èµ„æºï¼Œæœ€å¸¸ç”¨çš„å°±æ˜¯ pod å’Œ namespaceï¼‰\n  metricsQuery is the actual Prometheus query that needs to be performed to calculate the actual values.ï¼ˆå åŠ  seriesQuery åå‘é€ç»™prometheusçš„å®é™…æŸ¥è¯¢ï¼Œç”¨äºå¾—å‡ºæœ€ç»ˆçš„æŒ‡æ ‡å€¼ï¼‰\n  name with which the metric should be exposed to the custom metrics APIï¼ˆæš´éœ²ç»™APIçš„æŒ‡æ ‡åï¼‰\n  ä¸¾ä¸ªä¾‹å­ï¼šå¦‚æœæˆ‘ä»¬è¦è®¡ç®— container_network_receive_packets_totalï¼Œåœ¨Prometheus UIé‡Œæˆ‘ä»¬è¦è¾“å…¥ä»¥ä¸‹è¡Œæ¥æŸ¥è¯¢:\nsum(rate(container_network_receive_packets_total{namespace=\u0026ldquo;default\u0026rdquo;,pod=~\u0026ldquo;php-deploy.*\u0026quot;}[10m])) by (pod)*\nè½¬æ¢æˆ Adapter çš„ metricsQuery å°±å˜æˆè¿™æ ·äº†ï¼Œå¾ˆéš¾æ‡‚ï¼š\n*metricsQuery: \u0026lsquo;sum(rate(\u0026laquo;.series\u0026raquo;{\u0026laquo;.labelmatchers\u0026raquo;}10m])) by (\u0026laquo;.groupby\u0026raquo;)'\u0026lt;/.groupby\u0026gt;\u0026lt;/.labelmatchers\u0026gt;\u0026lt;/.series\u0026gt;*\nå†ç»™ä¸ªä¾‹å­ï¼š\n1rate(gorush_total_push_count{instance=\u0026#34;push.server.com:80\u0026#34;,job=\u0026#34;push-server\u0026#34;}[5m]) å˜æˆ adapter çš„ configmap\n1apiVersion: v1 2data: 3 config.yaml: | 4 rules: 5 - seriesQuery: \u0026#39;{__name__=~\u0026#34;gorush_total_push_count\u0026#34;}\u0026#39; 6seriesFilters: [] 7resources: 8overrides: 9namespace: 10resource: namespace 11pod: 12resource: pod 13name: 14matches: \u0026#34;\u0026#34; 15as: \u0026#34;gorush_push_per_second\u0026#34; 16metricsQuery: rate(\u0026lt;\u0026lt;.Series\u0026gt;\u0026gt;{\u0026lt;\u0026lt;.LabelMatchers\u0026gt;\u0026gt;}[5m]) ä¿®æ”¹äº†configmapï¼Œå¿…é¡»é‡å¯prometheus-adapterçš„podé‡æ–°åŠ è½½é…ç½®ï¼ï¼ï¼\nåœ¨hpaä¸­åº”ç”¨çš„ä¾‹å­ï¼š\n1apiVersion: autoscaling/v2beta1 2kind: HorizontalPodAutoscaler 3metadata: 4 name: gorush-hpa 5spec: 6 scaleTargetRef: 7 apiVersion: apps/v1 8 kind: Deployment 9 name: gorush 10 minReplicas: 1 11 maxReplicas: 5 12 metrics: 13 - type: Pods 14 pods: 15 metricName: gorush_push_per_second 16 targetAverageValue: 1m å†æ¥ä¸€ä¸ªï¼Œprometheus å‡½æ•°åæ˜¯ myapp_client_connectedï¼š\n1apiVersion: v1 2data: 3 config.yaml: | 4 rules: 5 - seriesQuery: \u0026#39;{__name__= \u0026#34;myapp_client_connected\u0026#34;}\u0026#39; 6seriesFilters: [] 7resources: 8overrides: 9k8s_namespace: 10resource: namespace 11k8s_pod_name: 12resource: pod 13name: 14matches: \u0026#34;myapp_client_connected\u0026#34; 15as: \u0026#34;\u0026#34; 16metricsQuery: \u0026lt;\u0026lt;.Series\u0026gt;\u0026gt;{\u0026lt;\u0026lt;.LabelMatchers\u0026gt;\u0026gt;,container_name!=\u0026#34;POD\u0026#34;} hpaçš„ä½¿ç”¨\n1apiVersion: autoscaling/v2beta1 2kind: HorizontalPodAutoscaler 3metadata: 4 name: hpa-sim 5 namespace: default 6spec: 7 scaleTargetRef: 8 apiVersion: apps/v1 9 kind: Deployment 10 name: hpa-sim 11 minReplicas: 1 12 maxReplicas: 10 13 metrics: 14 - type: Pods 15 pods: 16 metricName: myapp_client_connected 17 targetAverageValue: 20 å¾ˆå¤æ‚å§ã€‚æˆ‘ä»¬ä¸‹é¢ç»™ä¸ªè¯¦ç»†ä¾‹å­\nä¸‰ã€è‡ªå®šä¹‰æŒ‡æ ‡å…¨å¥—ä¾‹å­ æˆ‘ä»¬å…ˆå®šä¹‰ä¸€ä¸ª deploymentï¼Œè¿è¡Œä¸€ä¸ª nginx-vts çš„ podï¼Œè¿™ä¸ªé•œåƒå…¶å®å·²ç»è‡ªå·±æš´éœ²å‡ºäº† metric æŒ‡æ ‡\n1apiVersion: apps/v1 2kind: Deployment 3metadata: 4 name: nginx-deploy 5 annotations: 6 prometheus.io/scrape: \u0026#34;true\u0026#34; 7 prometheus.io/port: \u0026#34;80\u0026#34; 8 prometheus.io/path: \u0026#34;/status/format/prometheus\u0026#34; 9spec: 10 selector: 11 matchLabels: 12 app: nginx-deploy 13 template: 14 metadata: 15 labels: 16 app: nginx-deploy 17 spec: 18 containers: 19 - name: nginx-deploy 20 image: cnych/nginx-vts:v1.0 21 resources: 22 limits: 23 cpu: 50m 24 requests: 25 cpu: 50m 26 ports: 27 - containerPort: 80 28 name: http ç„¶åå®šä¹‰ä¸ª svcï¼ŒæŠŠ80ç«¯å£æš´éœ²å‡ºå»\n1apiVersion: v1 2kind: Service 3metadata: 4 name: nginx-svc 5spec: 6 ports: 7 - port: 80 8 targetPort: 80 9 name: http 10 selector: 11 app: nginx-deploy 12 type: ClusterIP prometheus æ˜¯è‡ªåŠ¨å‘ç°çš„ï¼Œæ‰€ä»¥ annotations å°±ä¼šè§¦å‘ prometheus è‡ªåŠ¨å¼€å§‹æ”¶é›†è¿™äº› nginx metricæŒ‡æ ‡\né›†ç¾¤å†…èµ·ä¸ªshellï¼Œè®¿é—®çœ‹çœ‹\n1$ curl nginx-svc.default.svc.hbb.local/status/format/prometheus 2# HELP nginx_vts_info Nginx info 3# TYPE nginx_vts_info gauge 4nginx_vts_info{hostname=\u0026#34;nginx-deployment-65d8df7488-c578v\u0026#34;,version=\u0026#34;1.13.12\u0026#34;} 1 5# HELP nginx_vts_start_time_seconds Nginx start time 6# TYPE nginx_vts_start_time_seconds gauge 7nginx_vts_start_time_seconds 1574283147.043 8# HELP nginx_vts_main_connections Nginx connections 9# TYPE nginx_vts_main_connections gauge 10nginx_vts_main_connections{status=\u0026#34;accepted\u0026#34;} 215 11nginx_vts_main_connections{status=\u0026#34;active\u0026#34;} 4 12nginx_vts_main_connections{status=\u0026#34;handled\u0026#34;} 215 13nginx_vts_main_connections{status=\u0026#34;reading\u0026#34;} 0 14nginx_vts_main_connections{status=\u0026#34;requests\u0026#34;} 15577 15nginx_vts_main_connections{status=\u0026#34;waiting\u0026#34;} 3 16nginx_vts_main_connections{status=\u0026#34;writing\u0026#34;} 1 17# HELP nginx_vts_main_shm_usage_bytes Shared memory [ngx_http_vhost_traffic_status] info 18# TYPE nginx_vts_main_shm_usage_bytes gauge 19nginx_vts_main_shm_usage_bytes{shared=\u0026#34;max_size\u0026#34;} 1048575 20nginx_vts_main_shm_usage_bytes{shared=\u0026#34;used_size\u0026#34;} 3510 21nginx_vts_main_shm_usage_bytes{shared=\u0026#34;used_node\u0026#34;} 1 22# HELP nginx_vts_server_bytes_total The request/response bytes 23# TYPE nginx_vts_server_bytes_total counter 24# HELP nginx_vts_server_requests_total The requests counter 25# TYPE nginx_vts_server_requests_total counter 26# HELP nginx_vts_server_request_seconds_total The request processing time in seconds 27# TYPE nginx_vts_server_request_seconds_total counter 28# HELP nginx_vts_server_request_seconds The average of request processing times in seconds 29# TYPE nginx_vts_server_request_seconds gauge 30# HELP nginx_vts_server_request_duration_seconds The histogram of request processing time 31# TYPE nginx_vts_server_request_duration_seconds histogram 32# HELP nginx_vts_server_cache_total The requests cache counter 33# TYPE nginx_vts_server_cache_total counter 34nginx_vts_server_bytes_total{host=\u0026#34;_\u0026#34;,direction=\u0026#34;in\u0026#34;} 3303449 35nginx_vts_server_bytes_total{host=\u0026#34;_\u0026#34;,direction=\u0026#34;out\u0026#34;} 61641572 36nginx_vts_server_requests_total{host=\u0026#34;_\u0026#34;,code=\u0026#34;1xx\u0026#34;} 0 37nginx_vts_server_requests_total{host=\u0026#34;_\u0026#34;,code=\u0026#34;2xx\u0026#34;} 15574 38nginx_vts_server_requests_total{host=\u0026#34;_\u0026#34;,code=\u0026#34;3xx\u0026#34;} 0 39nginx_vts_server_requests_total{host=\u0026#34;_\u0026#34;,code=\u0026#34;4xx\u0026#34;} 2 40nginx_vts_server_requests_total{host=\u0026#34;_\u0026#34;,code=\u0026#34;5xx\u0026#34;} 0 41nginx_vts_server_requests_total{host=\u0026#34;_\u0026#34;,code=\u0026#34;total\u0026#34;} 15576 42nginx_vts_server_request_seconds_total{host=\u0026#34;_\u0026#34;} 0.000 43nginx_vts_server_request_seconds{host=\u0026#34;_\u0026#34;} 0.000 44nginx_vts_server_cache_total{host=\u0026#34;_\u0026#34;,status=\u0026#34;miss\u0026#34;} 0 45nginx_vts_server_cache_total{host=\u0026#34;_\u0026#34;,status=\u0026#34;bypass\u0026#34;} 0 46nginx_vts_server_cache_total{host=\u0026#34;_\u0026#34;,status=\u0026#34;expired\u0026#34;} 0 47nginx_vts_server_cache_total{host=\u0026#34;_\u0026#34;,status=\u0026#34;stale\u0026#34;} 0 48nginx_vts_server_cache_total{host=\u0026#34;_\u0026#34;,status=\u0026#34;updating\u0026#34;} 0 49nginx_vts_server_cache_total{host=\u0026#34;_\u0026#34;,status=\u0026#34;revalidated\u0026#34;} 0 50nginx_vts_server_cache_total{host=\u0026#34;_\u0026#34;,status=\u0026#34;hit\u0026#34;} 0 51nginx_vts_server_cache_total{host=\u0026#34;_\u0026#34;,status=\u0026#34;scarce\u0026#34;} 0 52nginx_vts_server_bytes_total{host=\u0026#34;*\u0026#34;,direction=\u0026#34;in\u0026#34;} 3303449 53nginx_vts_server_bytes_total{host=\u0026#34;*\u0026#34;,direction=\u0026#34;out\u0026#34;} 61641572 54nginx_vts_server_requests_total{host=\u0026#34;*\u0026#34;,code=\u0026#34;1xx\u0026#34;} 0 55nginx_vts_server_requests_total{host=\u0026#34;*\u0026#34;,code=\u0026#34;2xx\u0026#34;} 15574 56nginx_vts_server_requests_total{host=\u0026#34;*\u0026#34;,code=\u0026#34;3xx\u0026#34;} 0 57nginx_vts_server_requests_total{host=\u0026#34;*\u0026#34;,code=\u0026#34;4xx\u0026#34;} 2 58nginx_vts_server_requests_total{host=\u0026#34;*\u0026#34;,code=\u0026#34;5xx\u0026#34;} 0 59nginx_vts_server_requests_total{host=\u0026#34;*\u0026#34;,code=\u0026#34;total\u0026#34;} 15576 60nginx_vts_server_request_seconds_total{host=\u0026#34;*\u0026#34;} 0.000 61nginx_vts_server_request_seconds{host=\u0026#34;*\u0026#34;} 0.000 62nginx_vts_server_cache_total{host=\u0026#34;*\u0026#34;,status=\u0026#34;miss\u0026#34;} 0 63nginx_vts_server_cache_total{host=\u0026#34;*\u0026#34;,status=\u0026#34;bypass\u0026#34;} 0 64nginx_vts_server_cache_total{host=\u0026#34;*\u0026#34;,status=\u0026#34;expired\u0026#34;} 0 65nginx_vts_server_cache_total{host=\u0026#34;*\u0026#34;,status=\u0026#34;stale\u0026#34;} 0 66nginx_vts_server_cache_total{host=\u0026#34;*\u0026#34;,status=\u0026#34;updating\u0026#34;} 0 67nginx_vts_server_cache_total{host=\u0026#34;*\u0026#34;,status=\u0026#34;revalidated\u0026#34;} 0 68nginx_vts_server_cache_total{host=\u0026#34;*\u0026#34;,status=\u0026#34;hit\u0026#34;} 0 69nginx_vts_server_cache_total{host=\u0026#34;*\u0026#34;,status=\u0026#34;scarce\u0026#34;} 0 ç„¶åç”¨ wrk éšæœºå‘ç‹‚å‘è¯·æ±‚å‹ä¸€æŠŠï¼Œæˆ‘ä»¬å» prometheus çš„é¢æ¿çœ‹çœ‹æŒ‡æ ‡è¢«æ”¶é›†åˆ°æ²¡æœ‰\nå¾ˆç–¯ç‹‚å•Šã€‚æˆ‘ä»¬ç¼–è¾‘ Prometheus-Adapter çš„ configmap ï¼ŒåŠ ä¸Šå¦‚ä¸‹å†…å®¹\n1rules: 2- seriesQuery: \u0026#39;nginx_vts_server_requests_total\u0026#39; 3 seriesFilters: [] 4 resources: 5 overrides: 6 kubernetes_namespace: 7 resource: namespace 8 kubernetes_pod_name: 9 resource: pod 10 name: 11 matches: \u0026#34;^(.*)_total\u0026#34; 12 as: \u0026#34;${1}_per_second\u0026#34; 13 metricsQuery: (sum(rate(\u0026lt;\u0026lt;.Series\u0026gt;\u0026gt;{\u0026lt;\u0026lt;.LabelMatchers\u0026gt;\u0026gt;}[1m])) by (\u0026lt;\u0026lt;.GroupBy\u0026gt;\u0026gt;)) ç„¶åæ€äº† Prometheus-Adapter çš„ Pod è®©å®ƒé‡å¯é‡æ–°åŠ è½½é…ç½®ï¼Œè¿‡æ®µæ—¶é—´è®¿é—®ä¸€ä¸‹ï¼Œçœ‹çœ‹å€¼ï¼Œæ˜¯527m\n1kubectl get --raw \u0026#34;/apis/custom.metrics.k8s.io/v1beta1/namespaces/default/pods/*/nginx_vts_server_requests_per_second\u0026#34; | jq . 2{ 3 \u0026#34;kind\u0026#34;: \u0026#34;MetricValueList\u0026#34;, 4 \u0026#34;apiVersion\u0026#34;: \u0026#34;custom.metrics.k8s.io/v1beta1\u0026#34;, 5 \u0026#34;metadata\u0026#34;: { 6 \u0026#34;selfLink\u0026#34;: \u0026#34;/apis/custom.metrics.k8s.io/v1beta1/namespaces/default/pods/%2A/nginx_vts_server_requests_per_second\u0026#34; 7 }, 8 \u0026#34;items\u0026#34;: [ 9 { 10 \u0026#34;describedObject\u0026#34;: { 11 \u0026#34;kind\u0026#34;: \u0026#34;Pod\u0026#34;, 12 \u0026#34;namespace\u0026#34;: \u0026#34;default\u0026#34;, 13 \u0026#34;name\u0026#34;: \u0026#34;hpa-prom-demo-755bb56f85-lvksr\u0026#34;, 14 \u0026#34;apiVersion\u0026#34;: \u0026#34;/v1\u0026#34; 15 }, 16 \u0026#34;metricName\u0026#34;: \u0026#34;nginx_vts_server_requests_per_second\u0026#34;, 17 \u0026#34;timestamp\u0026#34;: \u0026#34;2020-04-07T09:45:45Z\u0026#34;, 18 \u0026#34;value\u0026#34;: \u0026#34;527m\u0026#34;, 19 \u0026#34;selector\u0026#34;: null 20 } 21 ] 22} okï¼Œæ²¡é—®é¢˜ï¼Œæˆ‘ä»¬å®šä¹‰ä¸ªhpaï¼Œæ ¹æ®è¿™ä¸ªæŒ‡æ ‡æ¥ä¼¸ç¼©\n1apiVersion:autoscaling/v2beta12kind:HorizontalPodAutoscaler3metadata:4name:nginx-hpa5spec:6scaleTargetRef:7apiVersion:apps/v18kind:Deployment9name:nginx-deploy10minReplicas:211maxReplicas:512metrics:13- type:Pods14pods:15metricName:nginx_vts_server_requests_per_second16targetAverageValue:10è¿™æ ·å°±å¥½äº†ã€‚\nå¦‚æœ pod æœ¬èº«ä¸èƒ½æš´éœ² metric ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ sidecar é‡Œå®‰è£… exporter æ¥æ”¶é›†æ•°æ®å¹¶æš´éœ²å‡ºå»å°±å¯ä»¥äº†ã€‚\n","date":"2021-11-25","img":"","permalink":"https://bajie.dev/posts/20211125-kubernetes_hpa/","series":null,"tags":null,"title":"Kubernetesçš„hpaå’Œè‡ªå®šä¹‰æŒ‡æ ‡hpa"},{"categories":null,"content":"å…¬å¸å·²ç»ç”± saltstack å…¨é¢è½¬å‘äº† ansible ã€‚\nç”¨ ansible-playbook æ‰§è¡Œå„ç§ä»»åŠ¡çš„æ—¶å€™ï¼Œéœ€è¦ç™»å½•ä¸»æœºï¼Œå°±å¿…ç„¶æ¶‰åŠåˆ°ä¸»æœº ssh å¯†ç çš„è¾“å…¥ã€‚\næœ€æ—©æˆ‘ä»¬æ˜¯åœ¨ inventory é‡Œåšäº†å®šä¹‰ï¼š\n1[deqin:vars] 2ansible_ssh_common_args=\u0026#34;-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null\u0026#34; 3host_key_checking=False 4ansible_ssh_user=\u0026#34;peadmin\u0026#34; 5ansible_ssh_pass=\u0026#34;Fuck2021!\u0026#34; 6 7[deqin] 8192.168.1.19 å¤ªç›´ç™½äº†ï¼Œæ‰€æœ‰çœ‹åˆ°è¿™æ–‡ä»¶å†…å®¹çš„äººéƒ½ä¼šçŸ¥é“å¯†ç äº†ã€‚å®Œå…¨æ²¡æœ‰å®‰å…¨æ€§ï¼Œè¿™æ ·è¡Œä¸é€šå•Šï¼\nå¥½åœ¨ ansible-vault æä¾›äº†ä¸€ç§æ–¹æ³•æ¥è§£å†³ï¼šé‚£å°±æ˜¯ç”Ÿæˆä¸€ä¸ªå¯†æ–‡æ”¾è¿›å»ï¼Œç„¶åè§£å¼€å®ƒå¿…é¡»å†è¾“å…¥ä¸€ä¸ªå¯†ç ã€‚è¿™æ ·çœ‹åˆ°çš„äººä¹Ÿä¸çŸ¥é“å®é™…çš„å¯†ç åˆ°åº•æ˜¯ä»€ä¹ˆ\nå…·ä½“çš„åšæ³•å¦‚ä¸‹ï¼Œé¦–å…ˆç”Ÿæˆ key \u0026ndash;\u0026gt; åŠ å¯†å­—ç¬¦ä¸²çš„é”®å€¼å¯¹ï¼š\n1ansible-vault encrypt_string \u0026#39;Fuck2021!\u0026#39; --name \u0026#39;ansible_ssh_pass\u0026#39; è¾“å…¥å¯†ç ï¼Œä¼šå¾—åˆ°ä¸‹é¢ä¸€ä¸²å­—ç¬¦\n1ansible_ssh_pass: !vault | 2 $ANSIBLE_VAULT;1.1;AES256 3 37393235646234613332646366306233346330656666623862313339313861393239646261366237 4 6663343263363161643634653266343466356634656539650a393834663938636165336431656433 5 66333761643538623434363334316661653035313166333137373562363436613636366162353239 6 3661623733323933350a373164626131646235616361356638653733646534616163393362373135 7 6139 è¿™ä¸ªå°±æ˜¯å¯†æ–‡äº†ï¼Œå¿…é¡»ç”¨è¾“å…¥çš„å¯†ç æ‰èƒ½è§£å¼€ã€‚\næ³¨æ„ï¼šè¿™é‡Œçš„é”®å€¼ name ä¸å¯æ”¹å˜ï¼Œå¦‚æœä½ æƒ³æŠŠå­—ç¬¦ä¸²æ‹·è´ä¸‹æ¥ï¼Œæ”¹æ‰ ansible_ssh_pass çš„åå­—ï¼Œæ”¹æˆåˆ«çš„ï¼Œæƒ³æ”¹åå¼•ç”¨ï¼Œæ˜¯ä¸è¡Œçš„ã€‚\nè¿™ä¸€å¤§é•¿ä¸²å¯†æ–‡æœ‰ä»¥ä¸‹ä¸¤ç§ç”¨æ³•ï¼š\nä¸€ã€iniæ ¼å¼çš„inventoryå¼•ç”¨ æœ€åŸå§‹çš„ inventory.ini å†…å®¹å¦‚ä¸‹ï¼š\n1[deqin:vars] 2ansible_ssh_common_args=\u0026#34;-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null\u0026#34; 3host_key_checking=False 4ansible_ssh_user=\u0026#34;peadmin\u0026#34; 5 6[deqin] 7192.168.1.19 8 æˆ‘ä»¬å®šä¹‰ playbook æ–‡ä»¶ shenji.ymlï¼š\n1- hosts:deqin2become:yes3vars_files:4- pass.yml5vars:6ansible_ssh_pass:\u0026#39;{{ ansible_ssh_pass }}\u0026#39;78tasks:9- name:mkdirs10file:path=\u0026#34;{{ item }}\u0026#34; state=directory11with_items:12- \u0026#34;OS.05\u0026#34;13- \u0026#34;OS.06\u0026#34;æŠŠå¯†æ–‡æ”¾è¿› pass.yml æ–‡ä»¶\n1cat \u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; pass.yml 2ansible_ssh_pass: !vault | 3$ANSIBLE_VAULT;1.1;AES256 437393235646234613332646366306233346330656666623862313339313861393239646261366237 56663343263363161643634653266343466356634656539650a393834663938636165336431656433 666333761643538623434363334316661653035313166333137373562363436613636366162353239 73661623733323933350a373164626131646235616361356638653733646534616163393362373135 86139 9EOF è¿è¡Œ playbookï¼š\n1ansible-playbook --ask-vault-pass -i inventory.ini shenji.yml -vvv ä¸ºä»€ä¹ˆè¿™æ ·å‘¢ï¼Ÿå› ä¸º ansible-vault åŠ å¯†è¿‡çš„å­—ç¬¦ä¸²æ˜¯ yaml æ ¼å¼çš„ï¼Œåœ¨ ini é‡Œæ— æ³•ç›´æ¥å¼•ç”¨ã€‚\næ‰€ä»¥åœ¨ playbook çš„ yaml æ–‡ä»¶ä¸­å¼•å…¥å®ƒï¼Œç„¶åå†è·Ÿä» inventory.ini ä¸­è·å–çš„å˜é‡åˆä½œä¸€èµ·ã€‚\näºŒã€yamlæ ¼å¼çš„inventoryå¼•ç”¨ ä¸Šé¢æˆ‘ä»¬çœ‹åˆ°äº†å¿…é¡»é—´æ¥å¼•ç”¨æ‰å¯ä»¥ï¼Œä¸ºäº†é¿å…æ‰ pass.yml æ–‡ä»¶ï¼Œé‚£ä¹ˆå¹²è„†æŠŠ inventroy ç”¨ yaml æ ¼å¼æ¥å†™ï¼Œé‚£ä¸å°±å¯ä»¥äº†ä¹ˆ\nå¦‚ä¸‹å³å¯ï¼š\n1cat \u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; inventory.yml2---3all:4hosts:5deqin:6ansible_host:192.168.1.197vars:8host_key_checking:\u0026#34;False\u0026#34;9ansible_ssh_common_args:\u0026#34;-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null\u0026#34;10ansible_ssh_pass:!vault |11$ANSIBLE_VAULT;1.1;AES2561237393235646234613332646366306233346330656666623862313339313861393239646261366237136663343263363161643634653266343466356634656539650a3938346639386361653364316564331466333761643538623434363334316661653035313166333137373562363436613636366162353239153661623733323933350a37316462613164623561636135663865373364653461616339336237313516613917EOFç„¶åè¿è¡Œå°±å¯ä»¥äº†ï¼š\n1ansible-playbook --ask-vault-pass -i inventory.yml shenji.yml -vvv ","date":"2021-11-24","img":"","permalink":"https://bajie.dev/posts/20211124-ansible_vault/","series":null,"tags":null,"title":"Ansible VaultåŠ å¯†çš„ä½¿ç”¨"},{"categories":null,"content":"å®¡è®¡å•Šå®¡è®¡ï¼Œå…¬å¸ä½¿ç”¨çš„åä¸ºé˜²ç«å¢™éœ€è¦é…ç½®åŒå› å­ç™»å½•è®¤è¯ï¼Œè¿™ä¸‹éº»çƒ¦äº†ã€‚\næŸ¥äº†ä¸€ä¸‹åä¸ºæ‰‹å†Œï¼Œæ”¯æŒ Radius è®¤è¯ï¼Œé‚£ä¹ˆæ²¡åŠæ³•ï¼Œæœ€çœé’±çš„åŠæ³•å°±æ˜¯ç”¨ FreeIPA å’Œ FreeRadius æ­ä¸€å¥— OTP åŒå› å­è®¤è¯äº†ã€‚\nç³»ç»Ÿæ˜¯ CentOS 7 ï¼Œå·²å…³é—­é˜²ç«å¢™æœåŠ¡ï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š\nä¸€ã€æ­å»ºFreeIPA é¦–å…ˆè®¾ç½® hostname\n1hostnamectl set-hostname freeipa.rendoumi.local 2 3echo \u0026#34;192.168.1.5 freeipa.rendoumi.local\u0026#34; \u0026gt;\u0026gt; /etc/hosts ç„¶åå®‰è£… FreeIPAï¼Œæ³¨æ„è¦å›ç­”çš„å‡ ä¸ªé—®é¢˜\n ä¸è£…bindï¼Œæ— è®ºæ˜¯ dnsmasq æˆ– corednsï¼Œéƒ½æ¯” bind è½»ï¼Œè¦è£…ä¹Ÿè£…é‚£ä¸¤ä¸ªã€‚ server hostname æ˜¯ freeipa.rendoumi.local domian name æ˜¯ rendoumi.local realm name æ˜¯å¤§å†™çš„ RENDOUMI.LOCAL æœ‰ä¸¤ä¸ªå¯†ç ï¼Œç¬¬ä¸€ä¸ªæ˜¯ LDAP çš„å¯†ç ï¼Œç¬¬äºŒä¸ªæ˜¯ IPA çš„å¯†ç   1yum -y install deltarpm 2yum update 3 4yum -y install freeipa-server 5ipa-server-install 6 7This program will set up the IPA Server. 8 9This includes: 10 * Configure a stand-alone CA (dogtag) for certificate management 11 * Configure the Network Time Daemon (ntpd) 12 * Create and configure an instance of Directory Server 13 * Create and configure a Kerberos Key Distribution Center (KDC) 14 * Configure Apache (httpd) 15 16To accept the default shown in brackets, press the Enter key. 17 18WARNING: conflicting time\u0026amp;date synchronization service \u0026#39;chronyd\u0026#39; will be disabled in favor of ntpd 19 20Do you want to configure integrated DNS (BIND)? [no]:no 21 22Server host name [freeipa.rendoumi.local]: 23 24Please confirm the domain name [rendoumi.local]: 25 26Please provide a realm name [RENDOUMI.LOCAL]: 27 28Directory Manager password: 29Password (confirm): 30... 31IPA admin password: 32Password (confirm): 33 34The IPA Master Server will be configured with: 35Hostname: freeipa.rendoumi.local 36IP address(es): 192.168.1.5 37Domain name: rendoumi.local 38Realm name: RENDOUMI.LOCAL 39 40Continue to configure the system with these values? [no]: yes 41 42The following operations may take some minutes to complete. 43Please wait until the prompt is returned. 44 45Configuring NTP daemon (ntpd) 46 47... 48 49Setup complete 50 51Next steps: 52 1. You must make sure these network ports are open: 53 TCP Ports: 54 * 80, 443: HTTP/HTTPS 55 * 389, 636: LDAP/LDAPS 56 * 88, 464: kerberos 57 UDP Ports: 58 * 88, 464: kerberos 59 * 123: ntp 60 61 2. You can now obtain a kerberos ticket using the command: \u0026#39;kinit admin\u0026#39; 62 This ticket will allow you to use the IPA tools (e.g., ipa user-add) 63 and the web user interface. 64 65Be sure to back up the CA certificate stored in /root/cacert.p12 66This file is required to create replicas. The password for this file is the Directory Manager password 67 ä»¥ä¸Šï¼Œå°±è£…å¥½äº† FreeIPAï¼Œé…ç½®æ–‡ä»¶åœ¨ /etc/ipa/default.conf\néªŒè¯ä¸€ä¸‹ï¼š\n1# è¾“å…¥ipaå¯†ç  2kinit admin 3klist 4 5ipactl status 6# sn è¾“å…¥ 01 7ipa cert-show ç™»å½•ï¼š http://freeipa.rendoumi.com ï¼Œï¼ˆæ³¨æ„ä½ è®¿é—®çš„æœºå™¨å¿…é¡»èƒ½è§£æåˆ°è¿™ä¸ªåŸŸåï¼‰ç”¨æˆ·å admin ï¼Œå¯†ç æ˜¯ä¸Šé¢å¡«å…¥çš„ ipa å¯†ç ï¼Œå»ºç«‹ä¸€ä¸ªæ–°ç”¨æˆ·\nç„¶åç»™è¿™ä¸ªç”¨æˆ·æ·»åŠ  OTP Tokenï¼š\nç¼ºçœä»€ä¹ˆéƒ½ä¸ç”¨å¡«ï¼Œç›´æ¥é€‰ Addï¼š\nä¼šè¹¦å‡ºæ¥ä¸€ä¸ªäºŒç»´ç ï¼Œå»ºè®®æ˜¯ç”¨ FreeOTP æ‰«æï¼š\næˆ‘ä»¬åœ¨æ‰‹æœºä¸Šè£…ä¸Š FreeOTP è½¯ä»¶ï¼Œæ‰«ææ·»åŠ ï¼š\nè¿™æ ·å°±okäº†ã€‚ä¸‹æ¬¡ç™»å½•çš„æ—¶å€™å¯†ç å°±æ˜¯é¢„è®¾å¯†ç +FreeOTPå¯†ç åˆåœ¨ä¸€èµ·ã€‚ä¸­é—´æ²¡æœ‰åŠ å·å“¦\næ¯”å¦‚é¢„è®¾å¯†ç æ˜¯ Fuckï¼Œotpå¯†ç æ˜¯762405ï¼Œåˆåœ¨ä¸€èµ·å°±æ˜¯ Fuck762405ï¼Œä¸€èµ·è¾“å…¥å³å¯ã€‚\né‚£ FreeIPA çš„éƒ¨åˆ†å°±å®Œæˆäº†ã€‚\näºŒã€æ­å»ºFreeRadius ä¸Šé¢çš„éƒ¨åˆ†å…¶å®æ˜¯ FreeIPA å……å½“äº†ç”¨æˆ·æ•°æ®åº“ï¼Œç”¨ LDAP å­˜æ”¾æ•°æ®ï¼Œè€Œ Radius éœ€è¦ä» IPA æ‹¿åˆ°ç”¨æˆ·ä¿¡æ¯ã€‚\nå®‰è£…ï¼š\n1yum -y install freeradius freeradius-utils freeradius-ldap freeradius-krb5 Radius çš„é…ç½®éƒ½åœ¨ /etc/raddb ç›®å½•ä¸‹ï¼š\nç¼–è¾‘ /etc/raddb/client.conf ï¼Œå¢åŠ ä¸€ä¸ªç½‘æ®µçš„è®¤è¯ï¼Œå…è®¸ 172.0.0.0/8 è®¿é—®\n1client localnet { 2 ipaddr = 172.0.0.0/8 3proto = * 4secret = Fuck2021 5nas_type = other 6limit { 7max_connections = 16 8lifetime = 0 9idle_timeout = 30 10} 11} åŒæ—¶ä¿®æ”¹ä¸‹é¢çš„ clinet localhost éƒ¨åˆ†ï¼Œä¿®æ”¹ secretï¼Œä¹‹åæˆ‘ä»¬è¦ä»æœ¬åœ°ç™»å½•åšæµ‹è¯•\n1client localhost { 2 secret = ChinaBank2021 3 å†ä¿®æ”¹ /etc/raddb/sites-enabled/default and /etc/raddb/sites-enabled/inner-tunnel ï¼Œæ”¯æŒ LDAPï¼Œæœ‰äºŒå¤„åœ°æ–¹\næŠŠ\n1 # 2 # The ldap module reads passwords from the LDAP database. 3 -ldap æ¢æˆï¼š\n1 # 2 # The ldap module reads passwords from the LDAP database. 3 ldap 4 if ((ok || updated) \u0026amp;\u0026amp; User-Password) { 5 update { 6 control:Auth-Type := ldap 7} 8} æŠŠ\n1# Auth-Type LDAP { 2# ldap 3# } æ¢æˆï¼š\n1 Auth-Type LDAP { 2 ldap 3 } ç„¶å ldap æ¨¡å—é…ç½®ä¸€ä¸‹\n1ln -s /etc/raddb/mods-available/ldap /etc/raddb/mods-enabled/ æˆ‘ä»¬å…ˆç”¨ ldapsearch æœç´¢ä¸€ä¸‹ï¼Œçœ‹çœ‹å…·ä½“çš„ dn ä¿¡æ¯ï¼Œè¿™é‡Œè¾“å…¥ä¹‹å‰è®¾ç½®çš„ ldap å¯†ç \n1ldapsearch -x -v -W -D \u0026#39;cn=Directory Manager\u0026#39; uid=test|grep test 2ldap_initialize( \u0026lt;DEFAULT\u0026gt; ) 3Enter LDAP Password: 4filter: uid=test 5requesting: All userApplication attributes 6memberOf: cn=test,cn=groups,cn=accounts,dc=rendoumi,dc=local å¾—åˆ° cn=accounts,dc=rendoumi,dc=local\nå†å»ä¿®æ”¹ /etc/raddb/mods-enabled/ldap æ–‡ä»¶ï¼Œä¿®æ”¹ server å’Œ base_dn ä¸ä¹‹å¯¹åº”ï¼š\n1 server = \u0026#39;freeipa.rendoumi.local\u0026#39; 2base_dn = \u0026#39;cn=accounts,dc=rendoumi,dc=local\u0026#39; æ³¨æ„ï¼Œä¸Šé¢æˆ‘ä»¬æ²¡è£… bindï¼Œæ‰€ä»¥å¿…é¡»åœ¨ /etc/hosts å­˜åœ¨è®°å½•ï¼Œå¦åˆ™æœ¬åœ°å°±è®¿é—®ä¸åˆ°äº†\nå¯åŠ¨ radiusd çš„è°ƒè¯•æ¨¡å¼ï¼š\n1radiusd â€“X 2... 3Listening on auth address * port 1812 as server default 4Listening on acct address * port 1813 as server default 5Listening on auth address :: port 1812 as server default 6Listening on acct address :: port 1813 as server default 7Listening on auth address 127.0.0.1 port 18120 as server inner-tunnel 8Opening new proxy socket \u0026#39;proxy address * port 0\u0026#39; 9Listening on proxy address * port 36752 10Ready to process requests å†å¼€ä¸€ä¸ªç»ˆç«¯æµ‹è¯•ä¸€ä¸‹ï¼Œæ³¨æ„ï¼Œæˆ‘ä»¬æ˜¯ä»æœ¬åœ°(127.0.0.1)å‘èµ·æµ‹è¯•çš„ï¼Œæ‰€ä»¥å¯¹åº”è¦ç”¨åˆ°ä¸Šé¢è®¾ç½®çš„ secretï¼Œç”¨ admin ç™»å½•ï¼Œå°±é¿å…è¦ç”¨åˆ° freeotp çš„å£ä»¤ï¼Œè¿™é‡Œ xxxxxxxx æ˜¯ admin çš„å¯†ç ï¼š\n1radtest admin xxxxxxxx freeipa.rendoumi.local 1812 ChinaBank2021 2Sent Access-Request Id 57 from 0.0.0.0:45247 to 172.18.31.41:1812 length 75 3 User-Name = \u0026#34;admin\u0026#34; 4 User-Password = \u0026#34;xxxxxxxx\u0026#34; 5 NAS-IP-Address = 172.18.31.41 6 NAS-Port = 1812 7 Message-Authenticator = 0x00 8 Cleartext-Password = \u0026#34;xxxxxxxx\u0026#34; 9Received Access-Accept Id 57 from 172.18.31.41:1812 to 0.0.0.0:0 length 20 çœ‹åˆ°ä¸Šé¢ Access-Accept å°±okäº†ï¼Œctrl-c ç»ˆæ­¢ radiusd çš„è¿è¡Œï¼Œå¼€å¯ radiusd æœåŠ¡ã€‚\n1systemctl enable --now radiusd ç„¶ååœ¨åä¸ºé˜²ç«å¢™è®¾ç½®è¿™ä¸ª radiusd æœåŠ¡å™¨å°±å¯ä»¥äº†ã€‚\nå‚è€ƒèµ„æ–™ï¼š\nhttps://www.freeipa.org/page/Using_FreeIPA_and_FreeRadius_as_a_RADIUS_based_software_token_OTP_system_with_CentOS/RedHat_7 ","date":"2021-11-23","img":"","permalink":"https://bajie.dev/posts/20211123-freeipa_freeradius/","series":null,"tags":null,"title":"ä½¿ç”¨FreeIPAå’ŒFreeRadiusæ­å»ºåŒå› å­è®¤è¯æœåŠ¡å™¨"},{"categories":null,"content":"è¿™ä¸ªæ¯”è¾ƒæœ‰æ„æ€ï¼ŒåŒäº‹è¦å­˜æ”¾ 2TB çš„æ•°æ®ï¼Œä½†æ˜¯ç³»ç»Ÿæ˜¯ 1.7TB çš„ 4 å— 600G ç›˜ç»„æˆçš„ Raid10ã€‚\nå¾ˆæ˜æ˜¾ç›˜ç©ºé—´ä¸å¤Ÿäº†ï¼Œå»åº“æˆ¿æ‰¾ä¸¤å— 10TB çš„å¤§ç›˜ç»„æˆ Raid1 ç»™ä»–ç”¨å¥½äº†ã€‚\né—®é¢˜æ¥äº†ï¼Œç³»ç»Ÿæ˜¯ KVM è™šæœºï¼Œæ€æ ·æŠŠè¿™ä¸ª 10TB çš„å¤§ç›˜ç»™é€è¿›è™šæœºå‘¢ï¼Ÿ\nè¿™é‡Œé¢è¿˜çœŸæœ‰è¦æ³¨æ„çš„é—®é¢˜ï¼š\n Important\nGuest virtual machines should not be given write access to whole disks or block devices (for example, /dev/sdb). Guest virtual machines with access to whole block devices may be able to modify volume labels, which can be used to compromise the host physical machine system. Use partitions (for example, /dev/sdb1) or LVM volumes to prevent this issue.\n æ³¨æ„ä¸Šé¢çš„è¯´æ˜ï¼Œæ˜¯ä¸å»ºè®®å°†æ•´ä¸ªç¡¬ç›˜é€è¿›è™šæœºé‡Œé¢å»çš„ï¼Œå»ºè®®æ˜¯é€åˆ†åŒºè¿›å»ï¼Œé¿å…ä¼šå†™åæ•´ä¸ªç›˜ã€‚\næ‰€ä»¥å…ˆæŠŠç›˜çš„åˆ†åŒºåšå¥½ï¼Œæ ¼å¼åŒ–å¹¶æŒ‚è½½ï¼Œä»¥ /dev/sdb ä¸ºä¾‹\n1parted -s /dev/sdb mklabel gpt mkpart primary 0% 100% 2mkfs.xfs /dev/sdb1 3mount -t xfs /dev/sdb1 /mnt/sdb1 ç„¶ååˆ°å®ä½“æœºçš„ç£ç›˜ç›®å½•\n1# cd /dev/disk/ 2# ls 3by-id by-path by-uuid 4 5# cd by-id 6# ll 7total 0 8lrwxrwxrwx 1 root root 9 3æœˆ 26 2018 scsi-36b083fe0e4f71a001c36c36716543d4d -\u0026gt; ../../sda 9lrwxrwxrwx 1 root root 10 3æœˆ 26 2018 scsi-36b083fe0e4f71a001c36c36716543d4d-part1 -\u0026gt; ../../sda1 10lrwxrwxrwx 1 root root 10 3æœˆ 26 2018 scsi-36b083fe0e4f71a001c36c36716543d4d-part2 -\u0026gt; ../../sda2 11lrwxrwxrwx 1 root root 10 3æœˆ 26 2018 scsi-36b083fe0e4f71a001c36c36716543d4d-part3 -\u0026gt; ../../sda3 12lrwxrwxrwx 1 root root 9 11æœˆ 18 16:02 scsi-36b083fe0e4f71a002928bf63ef284827 -\u0026gt; ../../sdb 13lrwxrwxrwx 1 root root 10 11æœˆ 18 16:24 scsi-36b083fe0e4f71a002928bf63ef284827-part1 -\u0026gt; ../../sdb1 14lrwxrwxrwx 1 root root 9 3æœˆ 26 2018 wwn-0x6b083fe0e4f71a001c36c36716543d4d -\u0026gt; ../../sda 15lrwxrwxrwx 1 root root 10 3æœˆ 26 2018 wwn-0x6b083fe0e4f71a001c36c36716543d4d-part1 -\u0026gt; ../../sda1 16lrwxrwxrwx 1 root root 10 3æœˆ 26 2018 wwn-0x6b083fe0e4f71a001c36c36716543d4d-part2 -\u0026gt; ../../sda2 17lrwxrwxrwx 1 root root 10 3æœˆ 26 2018 wwn-0x6b083fe0e4f71a001c36c36716543d4d-part3 -\u0026gt; ../../sda3 18lrwxrwxrwx 1 root root 9 11æœˆ 18 16:02 wwn-0x6b083fe0e4f71a002928bf63ef284827 -\u0026gt; ../../sdb 19lrwxrwxrwx 1 root root 10 11æœˆ 18 16:24 wwn-0x6b083fe0e4f71a002928bf63ef284827-part1 -\u0026gt; ../../sdb1 çœ‹ä¸­é—´ä¸€è¡Œï¼Œscsi-36b083fe0e4f71a002928bf63ef284827-part1 æŒ‡å‘ /dev/sdb1ï¼Œè®°å½•ä¸‹æ¥\nç„¶å virsh-edit ç¼–è¾‘ KVM è™šæœºæ–‡ä»¶ï¼Œå¢åŠ ç¡¬ç›˜éƒ¨åˆ†ï¼š\n1 \u0026lt;disk type=\u0026#39;block\u0026#39; device=\u0026#39;disk\u0026#39;\u0026gt; 2\u0026lt;driver name=\u0026#39;qemu\u0026#39; type=\u0026#39;raw\u0026#39;/\u0026gt; 3\u0026lt;source dev=\u0026#39;/dev/disk/by-id/scsi-36b083fe0e4f71a002928bf63ef284827-part1\u0026#39;/\u0026gt; 4\u0026lt;target dev=\u0026#39;vda\u0026#39; bus=\u0026#39;virtio\u0026#39;/\u0026gt; 5\u0026lt;/disk\u0026gt; æ³¨ï¼šä¸Šé¢æˆ‘ä»¬æ˜¯ä½¿ç”¨äº† by-idï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨ by-path å’Œ by-uuid æ¥æŒ‡å®šæºç›˜\né‡å¯è™šæœºå¹¶è¿›å…¥æŸ¥çœ‹ï¼Œæˆ‘ä»¬èƒ½çœ‹åˆ°è¿™å—ç›˜ç›˜ç¬¦æ˜¯ /dev/vda\n1fdisk -l 2 3Disk /dev/vda: 11755.9 GB, 11755860262912 bytes, 22960664576 sectors 4Units = sectors of 1 * 512 = 512 bytes 5Sector size (logical/physical): 512 bytes / 512 bytes 6I/O size (minimum/optimal): 512 bytes / 512 bytes æ¥ä¸‹æ¥å°±æ¯”è¾ƒæ€ªå¼‚äº†ï¼Œè¿™ä¸ªç›˜åˆ†æ˜æ²¡æœ‰åˆ†åŒºï¼Œæˆ‘ä»¬å´å¯ä»¥ç›´æ¥ mount\n1mount -t xfs /dev/vda /material ç„¶å df -h å†çœ‹\nèƒ½è®¤å‡ºæ¥ï¼Œæ­£å¸¸ä½¿ç”¨å°±è¡Œäº†ã€‚\néå¸¸å¤æ€ªæ˜¯å§ã€‚\nå¤§å®¶è¿˜è¦æ³¨æ„å®ä½“æœºçš„æŒ‚è½½è·¯å¾„æ˜¯ /mnt/sdb1ï¼Œè™šæœºå†…çš„æŒ‚è½½è·¯å¾„æ˜¯ /materialï¼Œè¿™ä¸¤ä¸ªè·¯å¾„éƒ½æ˜¯æŒ‡å‘åŒä¸€å—ç›˜ï¼Œå¯ä»¥å…±é€šã€‚\n","date":"2021-11-19","img":"","permalink":"https://bajie.dev/posts/20211119-kvm_disk_passthrough/","series":null,"tags":null,"title":"KVMä¸‹é™„åŠ ç¡¬ç›˜çš„passthroughç›´é€š"},{"categories":null,"content":"è¯´åˆ° CentOS7 çš„ç´§æ€¥æ¨¡å¼ä¸æ•‘æ´æ¨¡å¼ï¼Œç½‘ä¸Šå¯ä»¥æœåˆ°æ¼«å¤©é£çš„å¸–å­ï¼Œè¯´ä¸€ä¸‹åŒºåˆ«\nRESCUE æ•‘æ´æ¨¡å¼ï¼š æ•‘æ´æ¨¡å¼å¯åŠ¨çš„ç³»ç»Ÿæ²¡æœ‰æŒ‚è½½ç¡¬ç›˜ï¼Œå¯ä»¥å°†ç¡¬ç›˜ mount å‡ºç„¶åæ‹·å‡ºæ•°æ®ã€‚\nEMERGENCY ç´§æ€¥æ¨¡å¼ï¼š ç´§æ€¥æ¨¡å¼å¯åŠ¨çš„ç³»ç»Ÿæ˜¯ä¸€ä¸ªæœ€å°çš„ç¯å¢ƒã€‚æ ¹ç›®å½•æ¡£æ¡ˆç³»ç»Ÿå°†ä¼šè¢«æŒ‚è½½ä¸ºä»…èƒ½è¯»å–ï¼Œè€Œä¸”å°†ä¸ä¼šåšä»»ä½•çš„è®¾å®šã€‚\nå½“ç„¶è¿›å…¥çš„æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œè¿›å…¥ç³»ç»Ÿçš„æ—¶å€™æŒ‰ e ä¿®æ”¹ grub èœå•å‚æ•°ï¼Œå°±å¯ä»¥è¿›å…¥ä¸åŒçš„æ¨¡å¼\næœ¬æ–‡è®¨è®ºçš„é‡ç‚¹ä¸æ˜¯æ€ä¹ˆè¿›å»ï¼Œè€Œæ˜¯é‚£ä¸¤å¥å‘½ä»¤ï¼Œåœ¨ç´§æ€¥çŠ¶æ€ä¸‹åæ­£æˆ‘æ˜¯è®°ä¸ä½çš„\n1systemd.unit=rescue.target 2systemd.unit=emergency.target éƒ½æ²¡æœ‰ä¹‹å‰çš„ single ç®€å•ï¼Œä¹Ÿå®Œå…¨è®°ä¸ä½ï¼Œæ—¢ç„¶è®°ä¸ä½ï¼Œé‚£å°±å¹²è„†åšåˆ°èœå•é‡Œå¥½äº†ï¼Œè¿™æ‰æ˜¯æœ¬æ–‡çš„é‡ç‚¹ã€‚\nç°åœ¨éƒ½æ˜¯ä½¿ç”¨ grub2 äº†ï¼Œè€Œä¸æ˜¯ grubï¼Œè¿™å¾ˆé‡è¦ã€‚grub2çš„é…ç½®æ–‡ä»¶æ˜¯ /boot/grub2/grub.cfgã€‚\nä¿®æ”¹ grub2 æœ‰ä¸¤ä¸ªå·¥å…·ï¼Œgrub2-mkconfig å’Œ grubbyï¼Œä¸è¦åŒæ—¶ä½¿ç”¨è¿™ä¸¤ä¸ªå·¥å…·ä¿®æ”¹ï¼Œä¼šè¦†ç›–çš„\n grub2-mkconfig ä¼šå»æœç´¢ /boot ç›®å½•ä¸‹çš„å†…æ ¸æ–‡ä»¶ï¼Œæœ‰å¤šå°‘ä¸ªå†…æ ¸å°±ä¼šç”Ÿæˆå¤šå°‘ä¸ªå¯åŠ¨é¡¹ã€‚é‚£ä¹ˆå¦‚æœæ˜¯åŒä¸€ä¸ªå†…æ ¸ï¼Œæƒ³ä¿®æ”¹ä¸åŒçš„å¯åŠ¨å‚æ•°ï¼Œåšå¤šä¸ªå¯åŠ¨é¡¹å°±å®Œè›‹ï¼Œä»–ä¸èƒ½è‡ªåŠ¨ç”Ÿæˆå•å†…æ ¸çš„å¤šä¸ªå¯åŠ¨é¡¹ grubby å¾ˆçµæ´»ï¼Œå¯ä»¥æ ¹æ®å½“å‰ grub2 çš„é…ç½®ï¼Œç”Ÿæˆä¸€ä¸ªå†…æ ¸ï¼Œå¤šä¸ªä¸åŒå¯åŠ¨å‚æ•°çš„å¤šä¸ªå¯åŠ¨é¡¹ã€‚  é‚£ä¹ˆæˆ‘ä»¬è¦åŠ è¿›å»ä¸¤ä¸ªåªæ˜¯å¯åŠ¨å‚æ•°ä¸åŒï¼Œå†…æ ¸å…¶å®ä¸€æ ·çš„å¯åŠ¨é¡¹ï¼Œç”¨ grubby å°±å¥½äº†\n1grubby --add-kernel=\\$(ls -1cat /boot/vmlinuz*|grep rescue) --title=\u0026#34;RESCUE BOOT\u0026#34; --initrd=\\$(ls -1cat /boot/initramfs*|grep rescue) --args=\u0026#34;systemd.unit=rescue.target\u0026#34; --copy-default 2 3grubby --add-kernel=\\$(ls -1cat /boot/vmlinuz*|grep rescue) --title=\u0026#34;EMERGENCY BOOT\u0026#34; --initrd=\\$(ls -1cat /boot/initramfs*|grep rescue) --args=\u0026#34;systemd.unit=emergency.target\u0026#34; --copy-default åˆ‡å¿Œæˆ‘ä»¬ä¹‹åä¸èƒ½è¿è¡Œ\n1grub2-mkconfig -o /boot/grub2/grub.cfg å¦åˆ™ä¸Šé¢çš„ä¸¤ä¸ªå¯åŠ¨é¡¹èœå•ä¼šæ¶ˆå¤±ï¼Œå› ä¸º grub2-mkconfig é…ç½®çš„è¯ä¸€ä¸ªå†…æ ¸åªèƒ½æœ‰ä¸€ä¸ªå¯åŠ¨é¡¹\ngrub2-mkconfig ä¹Ÿæœ‰è‡ªå·±çš„å¼ºé¡¹ï¼Œå¦‚æœè¦ä¿®æ”¹ç¼ºçœçš„èœå•è¶…æ—¶æ—¶é—´ï¼Œgrubby å°±åšä¸åˆ°äº†\n1sed -i \u0026#39;/^GRUB_TIMEOUT=/s/^.*$/GRUB_TIMEOUT=10/\u0026#39; /etc/default/grub 2grub2-mkconfig -o /boot/grub2/grub.cfg ","date":"2021-11-19","img":"","permalink":"https://bajie.dev/posts/20211119-linux_rescue/","series":null,"tags":null,"title":"CentOS7çš„æ•‘æ´æ¨¡å¼å’Œç´§æ€¥æ¨¡å¼"},{"categories":null,"content":"è¯´å®åœ¨è¯ï¼Œè¿™ä¸ªåœºæ™¯éå¸¸æ€ªå¼‚ï¼Œå®¢æˆ·åœ¨ linux ä¸‹è¦åŠ¨æ€æ ¹æ® url é€‰æ‹©ä»£ç†ï¼š\nçœ‹å›¾ï¼Œä¸­é—´çš„æ˜¯å‰ç«¯ä»£ç†ï¼Œåœ°å€æ˜¯ 192.168.1.1:8080ï¼Œç„¶åå®¢æˆ·è®¾ç½®ä½¿ç”¨è¿™ä¸ªä»£ç†\n1export http_proxy=http://192.168.1.1:8080 2export https_proxy=http://192.168.1.1:8080 ç„¶åå¯¹åº”åç«¯æœ‰ä¸‰ä¸ªä»£ç†ï¼Œä¸¤ä¸ª http ä»£ç†ï¼Œä¸€ä¸ª socks ä»£ç†\n1http 192.168.2.1:3128 2socks 192.168.2.2:1080 3http 192.168.2.3:3128 æˆ‘ä»¬è¦æ ¹æ®å®¢æˆ·çš„è¯·æ±‚ URL æ¥å†³å®šå…·ä½“è¦ä½¿ç”¨åç«¯çš„å“ªä¸ªä»£ç†\nè¿™ä¸ªå¦‚æœåœ¨æµè§ˆå™¨ä¸Šè®¾ç½®éå¸¸å®¹æ˜“ï¼Œè®¾ç½® PAC å³å¯ã€‚ä½†æ˜¯ååå®¢æˆ·ç«¯ä¸æ˜¯æµè§ˆå™¨ï¼Œè€Œæ˜¯ä¸€ä¸ªç¨‹åºï¼Œé‚£ä¹ˆéº»çƒ¦å°±æ¥äº†ã€‚æ€ä¹ˆè®¾ç½®å‘¢ï¼Ÿ\næ­¥éª¤å¾ˆç®€å•ï¼š\nä¸€ã€å®‰è£… pacproxy ç½‘å€ï¼šhttps://github.com/williambailey/pacproxy\n1wget https://github.com/williambailey/pacproxy/releases/download/v.2.0.4/pacproxy_2.0.4_linux_amd64.tar.gz 2tar zxvf pacproxy_2.0.4_linux_amd64.tar.gz æ‹·å‡ºæ¥ pacproxy å¤‡ç”¨\näºŒã€ç”Ÿæˆé…ç½®æ–‡ä»¶ æœ€ä¸»è¦çš„å°±æ˜¯ PAC æ–‡ä»¶çš„ç”Ÿæˆ\næˆ‘ä»¬ç»™ä¸ªä¾‹å­ï¼š\n1cat \u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; pac 2function FindProxyForURL(url, host) 3{ 4if (host == \u0026#34;www.baidu.com\u0026#34;) { 5return \u0026#34;PROXY 192.168.2.1:3128\u0026#34;; 6} 7else if (host == \u0026#34;www.sina.com.cn\u0026#34;) { 8return \u0026#34;SOCKS 192.168.2.2:1080\u0026#34;; 9} 10else if (host == \u0026#34;www.sohu.com\u0026#34;) { 11return \u0026#34;SOCKS 192.168.2.3:1080\u0026#34;; 12} 13else { 14return \u0026#34;DIRECT\u0026#34;; 15} 16} 17EOF å…¶å® PAC æ–‡ä»¶çš„å†…å®¹å°±æ˜¯ä¸€æ®µ javascriptï¼Œç”¨æ¥è¿”å›ä»£ç†çš„åœ°å€\nè¿è¡Œå¹¶æµ‹è¯•ï¼š\n1pacproxy -c pac -l 0.0.0.0:8080 -v 2 3 4export http_proxy=http://192.168.1.1:8080 5export https_proxy=http://192.168.1.1:8080 6curl -I www.baidu.com è¿™æ ·å°±åœ¨ Linux æ­å»ºäº†ä¸€ä¸ªåŠ¨æ€çš„ PAC ä»£ç†\nPACæ–‡ä»¶çš„å‚è€ƒèµ„æ–™ï¼š\n  https://web.archive.org/web/20070602031929/http://wp.netscape.com/eng/mozilla/2.0/relnotes/demo/proxy-live.html   https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Proxy_servers_and_tunneling/Proxy_Auto-Configuration_PAC_file   https://www.websense.com/content/support/library/web/v76/pac_file_best_practices/PAC_file_sample.aspx   ","date":"2021-11-16","img":"","permalink":"https://bajie.dev/posts/20211116-pacproxy/","series":null,"tags":null,"title":"Linuxä¸‹web Pacproxyçš„ç”¨æ³•"},{"categories":null,"content":"Tomcat æ˜¯ä¸€ä¸ª HTTP serverã€‚åŒæ—¶ï¼Œå®ƒä¹Ÿæ˜¯ä¸€ä¸ª serverlet å®¹å™¨ï¼Œå¯ä»¥æ‰§è¡Œ java çš„ Servletï¼Œä¹Ÿå¯ä»¥æŠŠ JavaServer Pagesï¼ˆJSPï¼‰å’Œ JavaServerFacesï¼ˆJSFï¼‰ç¼–è¯‘æˆ Java Servletã€‚å®ƒçš„æ¨¡å‹å›¾å¦‚ä¸‹ï¼š\nç»™ä¸ªç”Ÿäº§ç¯å¢ƒ server.xml çš„ä¾‹å­ï¼š\n1\u0026lt;?xml version=\u0026#39;1.0\u0026#39; encoding=\u0026#39;utf-8\u0026#39;?\u0026gt; 2\u0026lt;Server port=\u0026#34;-1\u0026#34; shutdown=\u0026#34;SHUTDOWN\u0026#34;\u0026gt; 3\u0026lt;Listener className=\u0026#34;org.apache.catalina.startup.VersionLoggerListener\u0026#34; /\u0026gt; 4\u0026lt;Listener className=\u0026#34;org.apache.catalina.core.AprLifecycleListener\u0026#34; SSLEngine=\u0026#34;on\u0026#34; /\u0026gt; 5\u0026lt;Listener className=\u0026#34;org.apache.catalina.core.JreMemoryLeakPreventionListener\u0026#34; /\u0026gt; 6\u0026lt;Listener className=\u0026#34;org.apache.catalina.mbeans.GlobalResourcesLifecycleListener\u0026#34; /\u0026gt; 7\u0026lt;Listener className=\u0026#34;org.apache.catalina.core.ThreadLocalLeakPreventionListener\u0026#34; /\u0026gt; 8 9 \u0026lt;GlobalNamingResources\u0026gt; 10 \u0026lt;Resource name=\u0026#34;UserDatabase\u0026#34; auth=\u0026#34;Container\u0026#34; 11type=\u0026#34;org.apache.catalina.UserDatabase\u0026#34; 12description=\u0026#34;User database that can be updated and saved\u0026#34; 13factory=\u0026#34;org.apache.catalina.users.MemoryUserDatabaseFactory\u0026#34; 14pathname=\u0026#34;conf/tomcat-users.xml\u0026#34; /\u0026gt; 15\u0026lt;/GlobalNamingResources\u0026gt; 16 17 \u0026lt;Service name=\u0026#34;Catalina\u0026#34;\u0026gt; 18\u0026lt;Connector port=\u0026#34;8080\u0026#34; 19server=\u0026#34;www.rendoumi.com\u0026#34; 20protocol=\u0026#34;org.apache.coyote.http11.Http11NioProtocol\u0026#34; 21maxHttpHeaderSize=\u0026#34;8192\u0026#34; 22acceptCount=\u0026#34;500\u0026#34; 23maxThreads=\u0026#34;1000\u0026#34; 24minSpareThreads=\u0026#34;200\u0026#34; 25enableLookups=\u0026#34;false\u0026#34; 26redirectPort=\u0026#34;8443\u0026#34; 27connectionTimeout=\u0026#34;20000\u0026#34; 28relaxedQueryChars=\u0026#34;[]|{}@!$*()+\u0026#39;.,;^\\`\u0026amp;quot;\u0026amp;lt;\u0026amp;gt;\u0026#34; 29disableUploadTimeout=\u0026#34;true\u0026#34; 30allowTrace=\u0026#34;false\u0026#34; 31URIEncoding=\u0026#34;UTF-8\u0026#34; 32useBodyEncodingForURI=\u0026#34;true\u0026#34; /\u0026gt;  33 34 \u0026lt;Engine name=\u0026#34;Catalina\u0026#34; defaultHost=\u0026#34;localhost\u0026#34;\u0026gt; 35\u0026lt;Realm className=\u0026#34;org.apache.catalina.realm.LockOutRealm\u0026#34;\u0026gt; 36\u0026lt;Realm className=\u0026#34;org.apache.catalina.realm.UserDatabaseRealm\u0026#34; 37resourceName=\u0026#34;UserDatabase\u0026#34;/\u0026gt; 38\u0026lt;/Realm\u0026gt; 39\u0026lt;Host name=\u0026#34;localhost\u0026#34; appBase=\u0026#34;webapps\u0026#34; unpackWARs=\u0026#34;false\u0026#34; autoDeploy=\u0026#34;false\u0026#34;\u0026gt; 40\u0026lt;Valve className=\u0026#34;org.apache.catalina.valves.AccessLogValve\u0026#34; directory=\u0026#34;logs\u0026#34; prefix=\u0026#34;access_log.\u0026#34; suffix=\u0026#34;.txt\u0026#34; 41fileDateFormat=\u0026#34;yyyy-MM-dd\u0026#34; 42pattern=\u0026#34;%a|%A|%T|%{X-Forwarded-For}i|%l|%u|%t|%r|%s|%b|%{Referer}i|%{User-Agent}i \u0026#34; resolveHosts=\u0026#34;false\u0026#34;/\u0026gt; 43\u0026lt;Context path=\u0026#34;\u0026#34; docBase=\u0026#34;/export/servers/tomcat/webapps/web\u0026#34; /\u0026gt; 44\u0026lt;/Host\u0026gt; 45 46 \u0026lt;/Engine\u0026gt; 47 \u0026lt;/Service\u0026gt; 48\u0026lt;/Server\u0026gt; åˆ†è§£å¼€æ¥ä¸€éƒ¨åˆ†ä¸€éƒ¨åˆ†çš„çœ‹ï¼š\nServer Server ç¬¬2è¡Œï¼Œæ˜¯æœ€å¤§ä¸”å¿…é¡»å”¯ä¸€çš„ç»„ä»¶ã€‚è¡¨ç¤ºä¸€ä¸ª Tomcat çš„å®ä¾‹ï¼Œå®ƒå¯ä»¥åŒ…å«å¤šä¸ª Servicesï¼Œè€Œæ¯ä¸ª Service éƒ½å¯ä»¥æœ‰è‡ªå·±çš„ Engine å’Œ connectorsã€‚\n1\u0026lt;Server port=\u0026#34;8005\u0026#34; shutdown=\u0026#34;SHUTDOWN\u0026#34;\u0026gt; ...... \u0026lt;/Server\u0026gt; æ³¨æ„ä¸Šé¢ï¼Œæˆ‘ä»¬æŠŠç¼ºçœçš„ port=\u0026ldquo;8005\u0026rdquo; æ”¹æˆäº† â€œ-1â€ï¼Œè¿™æ ·é˜²æ­¢ä»8005é‡å¯ï¼Œé¿å…å®‰å…¨é—®é¢˜ã€‚\nListeners ä¸€ä¸ª Server å®¹å™¨æ‹¥æœ‰è‹¥å¹² Listeners (è¡Œ 3-7)ã€‚ä¸€ä¸ª Listener ç›‘å¬å¹¶å›åº”ç‰¹å®šçš„äº‹ä»¶.\n  ä¾‹å¦‚ GlobalResourcesLifecycleListener å°±è®¾ç½®äº† global resourcesï¼Œè¿™æ ·å°±å¯ä»¥ä½¿ç”¨ JNDI æ¥å­˜å–åƒæ•°æ®åº“è¿™ç§èµ„æºã€‚\n1\u0026lt;Listener className=\u0026#34;org.apache.catalina.mbeans.GlobalResourcesLifecycleListener\u0026#34; /\u0026gt;   Global Naming Resources \u0026lt;GlobalNamingResources\u0026gt; (è¡Œ 9-15) å®šä¹‰äº† JNDI (Java Naming and Directory Interface) èµ„æºï¼Œè¿™ä¸ªæ˜¯ LDAP çš„ä¸œè¥¿ï¼Œå…è®¸ java è½¯ä»¶é€šè¿‡ç›®å½•å‘ç°å¯¹è±¡å’Œå±æ€§å€¼ã€‚\nç¼ºçœå®šä¹‰äº†ä¸€ä¸ª UserDatabase çš„ JNDI èµ„æºï¼ˆè¡Œ 10-14ï¼‰ï¼Œè¿™ä¸ªå¯¹è±¡å…¶å®æ˜¯ä¸€ä¸ªå†…å­˜æ•°æ®åº“ï¼Œä¿å­˜ç€ä» conf/tomcat-users.xml ä¸­åŠ è½½ä¸Šæ¥çš„ç”¨æˆ·è®¤è¯æ•°æ®ã€‚\n1\u0026lt;GlobalNamingResources\u0026gt; 2 \u0026lt;Resource name=\u0026#34;UserDatabase\u0026#34; auth=\u0026#34;Container\u0026#34; 3type=\u0026#34;org.apache.catalina.UserDatabase\u0026#34; 4description=\u0026#34;User database that can be updated and saved\u0026#34; 5factory=\u0026#34;org.apache.catalina.users.MemoryUserDatabaseFactory\u0026#34; 6pathname=\u0026#34;conf/tomcat-users.xml\u0026#34; /\u0026gt; 7\u0026lt;/GlobalNamingResources\u0026gt; æˆ‘ä»¬å¯ä»¥å†å®šä¹‰ä¸€ä¸ª Mysql ä¹‹ç±»çš„ JNDI æ¥ä¿å­˜ mysql æ•°æ®åº“è¿æ¥ä¿¡æ¯ï¼Œç”¨æ¥å®ç°è¿æ¥æ± \nServices Service ç”¨æ¥å…³è”å¤šä¸ª Connectors åˆ° Engineã€‚ç¼ºçœçš„é…ç½®æ˜¯é…äº†ä¸€ä¸ª å«åš Catalina çš„ Service ï¼ŒCatalinna ç¼ºçœé…äº†ä¸¤ä¸ª Connectorsï¼Œä¸€ä¸ªæ˜¯8080çš„HTTPï¼Œä¸€ä¸ªæ˜¯8009çš„AJPã€‚\n1\u0026lt;Service name=\u0026#34;Catalina\u0026#34;\u0026gt; 2\u0026lt;Connector port=\u0026#34;8080\u0026#34; protocol=\u0026#34;HTTP/1.1\u0026#34; 3connectionTimeout=\u0026#34;20000\u0026#34; 4redirectPort=\u0026#34;8443\u0026#34; /\u0026gt; 5\u0026lt;Connector port=\u0026#34;8009\u0026#34; protocol=\u0026#34;AJP/1.3\u0026#34; redirectPort=\u0026#34;8443\u0026#34; /\u0026gt; 6\u0026lt;/Service\u0026gt; æ³¨æ„æœ€ä¸Šé¢çš„é…ç½®ï¼Œæˆ‘ä»¬å–æ¶ˆäº†8009çš„AJPï¼Œè¿™ä¸ªåè®®ç°åœ¨åŸºæœ¬æ²¡äººç”¨ï¼Œå–æ¶ˆæ‰ä¹Ÿé¿å…å®‰å…¨é—®é¢˜ã€‚\nä¸‹é¢ç»™å‡ºä¸€ä¸ª SSL 8443 çš„ connectors çš„ä¾‹å­\n1 \u0026lt;Connector port=\u0026#34;8443\u0026#34; maxHttpHeaderSize=\u0026#34;8192\u0026#34; SSLEnabled=\u0026#34;true\u0026#34; server=\u0026#34;Rendoumi\u0026#34; 2maxThreads=\u0026#34;150\u0026#34; minSpareThreads=\u0026#34;25\u0026#34; maxSpareThreads=\u0026#34;75\u0026#34; 3enableLookups=\u0026#34;false\u0026#34; disableUploadTimeout=\u0026#34;true\u0026#34; 4acceptCount=\u0026#34;100\u0026#34; scheme=\u0026#34;https\u0026#34; secure=\u0026#34;true\u0026#34; clientAuth=\u0026#34;false\u0026#34; 5URIEncoding=\u0026#34;UTF-8\u0026#34; 6sslProtocol=\u0026#34;SSL\u0026#34; 7ciphers=\u0026#34;SSL_RSA_WITH_RC4_128_MD5, SSL_RSA_WITH_RC4_128_SHA\u0026#34; 8keystoreFile=\u0026#34;/export/servers/tomcat/rendoumi.keystore\u0026#34; 9keystorePass=\u0026#34;Fuck2020\u0026#34; /\u0026gt; Containers æ¦‚å¿µ Tomcat çš„å®¹å™¨æ¦‚å¿µï¼ŒTomcatè®¤ä¸º Engine, Host, Context å’Œ Clusterå¤„åœ¨åŒä¸€ä¸ªå®¹å™¨ä¸­. æœ€é¡¶å±‚çš„æ˜¯ Engine; æœ€åº•å±‚æ˜¯Contextã€‚\nå¦å¤–åƒ Realm å’Œ Valveï¼Œä¹Ÿå¯ä»¥æ”¾åœ¨å®¹å™¨ä¸­\nEngine Engine æ˜¯å®¹å™¨çš„é¡¶ç«¯ï¼Œå¯ä»¥åŒ…å«æœ‰è‹¥å¹² Hostsã€‚æˆ‘ä»¬å¯ä»¥é…ç½® tomcat æœåŠ¡å¤šä¸ªè™šæ‹Ÿä¸»æœºã€‚ä¸‹é¢é…ç½®å°±æ˜¯æœåŠ¡æœ¬æœºçš„ä¸€ä¸ªæœåŠ¡ã€‚\n1\u0026lt;Engine name=\u0026#34;Catalina\u0026#34; defaultHost=\u0026#34;localhost\u0026#34;\u0026gt; Catalina Engine ä» HTTP connector å¤„æ¥æ”¶åˆ°å®¢æˆ·ç«¯çš„ HTTP è¯·æ±‚ï¼Œæ ¹æ®è¯·æ±‚å¤´ä¸­ Host: xxx çš„å†…å®¹ï¼ŒæŠŠè¯·æ±‚è·¯ç”±åˆ°æŸä¸ªå…·ä½“çš„ Hostä¸Šã€‚\nRealm Realm æœ¬è´¨æ˜¯ä¸€ä¸ªæ•°æ®åº“ï¼Œæ˜¯ç”¨æ¥ä¿å­˜ç”¨æˆ·åã€å¯†ç ã€è®¤è¯è§’è‰²çš„ä¸œè¥¿ã€‚\n1\u0026lt;Realm className=\u0026#34;org.apache.catalina.realm.LockOutRealm\u0026#34;\u0026gt; 2\u0026lt;Realm className=\u0026#34;org.apache.catalina.realm.UserDatabaseRealm\u0026#34; resourceName=\u0026#34;UserDatabase\u0026#34;/\u0026gt; 3\u0026lt;/Realm\u0026gt; Hosts Host å®šä¹‰äº†è™šæ‹Ÿä¸»æœºï¼Œå¯ä»¥å®šä¹‰å¤šä¸ªè™šæ‹Ÿä¸»æœºã€‚å…¶ä¸­ appBase åƒä¸‡ä¸èƒ½ä¸ºç©ºï¼Œå¦åˆ™å°±å¯ä»¥è¯»åˆ° tomcat çš„æ‰€æœ‰æ–‡ä»¶ï¼Œå°±å‡ºçº¿ä¸Šäº‹æ•…å¤§ Bug äº†ï¼ï¼ï¼\n1\u0026lt;Host name=\u0026#34;localhost\u0026#34; appBase=\u0026#34;webapps\u0026#34; unpackWARs=\u0026#34;true\u0026#34; autoDeploy=\u0026#34;true\u0026#34;\u0026gt; æˆ‘ä»¬æœ€ä¸Šé¢çš„ç”Ÿäº§é…ç½®ï¼Œä¸è‡ªè§£å‹ï¼Œä¹Ÿä¸è‡ªåŠ¨éƒ¨ç½²ã€‚\nValve Valve æ˜¯ç”¨æ¥æ‹¦æˆª HTTP requestsçš„ï¼Œåšé¢„å¤„ç†åå†äº¤ç»™ä¸‹ä¸€ä¸ªç»„ä»¶ï¼Œå®ƒèƒ½åœ¨ Engine, Host, Context ä¸­è¢«å®šä¹‰ã€‚ä¸‹é¢çš„ä¾‹å­å°±æ˜¯åœ¨ Engine ä¸­åšäº†æ‹¦æˆªï¼Œå®šä¹‰äº†æ—¥å¿—æ ¼å¼ï¼Œäº¤ç»™ä¸‹ä¸€ä¸ªæ—¥å¿—å¤„ç†ç»„ä»¶åšå¤„ç†ã€‚\nç¼ºçœé…ç½®\n1\u0026lt;Valve className=\u0026#34;org.apache.catalina.valves.AccessLogValve\u0026#34; directory=\u0026#34;logs\u0026#34; 2prefix=\u0026#34;localhost_access_log.\u0026#34; suffix=\u0026#34;.txt\u0026#34; 3pattern=\u0026#34;%h %l %u %t \u0026amp;quot;%r\u0026amp;quot; %s %b\u0026#34; /\u0026gt; æˆ‘ä»¬çš„é…ç½®ä¿®æ”¹äº†ç¼ºçœçš„æ—¥å¿—æ ¼å¼ï¼Œå¤šäº†å¾ˆå¤šæ˜ç»†çš„å†…å®¹ï¼Œæ”¹å˜äº†åˆ†å‰²ç¬¦ï¼š\n1\u0026lt;Valve className=\u0026#34;org.apache.catalina.valves.AccessLogValve\u0026#34; directory=\u0026#34;logs\u0026#34; 2prefix=\u0026#34;access_log.\u0026#34; suffix=\u0026#34;.txt\u0026#34; 3fileDateFormat=\u0026#34;yyyy-MM-dd\u0026#34; 4pattern=\u0026#34;%a|%A|%T|%{X-Forwarded-For}i|%l|%u|%t|%r|%s|%b|%{Referer}i|%{User-Agent}i \u0026#34; resolveHosts=\u0026#34;false\u0026#34;/\u0026gt;  Context Contextå®šä¹‰äº†å…·ä½“çš„è®¿é—®è·¯å¾„ï¼Œä¸€å®šè¦æŒ‡å®š docBase ï¼ï¼ï¼å¤§å®¶ä¸€å®šè¦è®°ä½ appBase å’Œ docBase ä¸åŒä¸ºç©ºï¼ï¼ï¼\n1\u0026lt;Context path=\u0026#34;\u0026#34; docBase=\u0026#34;/export/servers/tomcat/webapps/web\u0026#34; /\u0026gt;  å¦‚ä¸Šï¼Œæˆ‘ä»¬å°±é…å¥½äº†ä¸€ä¸ªç”Ÿäº§ç¯å¢ƒçš„ server.xml ï¼Œæ³¨æ„ï¼Œè¿™ä¸ª xml æ–‡ä»¶æ˜¯å¯ä»¥æ”¾åœ¨è§£å¼€çš„tomcatå‹ç¼©åŒ… apache-tomcat-8.5.64 ç›®å½•ä¹‹å¤–çš„ã€‚\næˆ‘ä»¬å†å¦å¤–ç¼–å†™ä¸€ä¸ªå¯åŠ¨æ–‡ä»¶ start.shï¼š\n1#!/bin/sh 2export JAVA_OPTS=\u0026#34;-server -Xms1024m -Xmx2048m -Djava.awt.headless=true -Dsun.net.client.defaultConnectTimeout=60000 -Dsun.net.client.defaultReadTimeout=60000 -Djmagick.systemclassloader=no -Dnetworkaddress.cache.ttl=300 -Dsun.net.inetaddr.ttl=300\u0026#34; 3export CATALINA_HOME=/export/servers/tomcat/apache-tomcat-8.5.64 4 5cd /export/servers/tomcat/ 6$CATALINA_HOME/bin/catalina.sh start -config \u0026#34;/export/servers/tomcat/server.xml\u0026#34; è¿™æ ·ï¼Œæˆ‘ä»¬çš„å¯åŠ¨æ–‡ä»¶å’Œé…ç½®æ–‡ä»¶ï¼Œå°±å’Œ tomcat ç›®å½•åˆ†ç¦»äº†ï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯å¦‚æœ tomcat éœ€è¦å‡çº§ï¼Œé‚£ä¹ˆç›´æ¥è§£å‹æ¢ç›®å½•å³å¯ã€‚\næˆ‘ä»¬å¯ä»¥åšä¸ªè½¯é“¾æ¥ tomcat é“¾æ¥åˆ° apache-tomcat-8.5.64ï¼Œè¿™æ ·æ›´æ–¹ä¾¿æ“ä½œã€‚\n","date":"2021-11-15","img":"","permalink":"https://bajie.dev/posts/20211115-tomcat_config/","series":null,"tags":null,"title":"Tomcat Server.xmlé…ç½®è¯¦ç»†è§£é‡Š"},{"categories":null,"content":"å…¬å¸ç”¨äº†6å¹´çš„GlusterFSç»ˆäºåˆ°äº†è¦è°ƒæ•´å·å‚æ•°çš„åœ°æ­¥äº†ã€‚\nå°æ–‡ä»¶å·²ç»å¤šåˆ°è¦å½±å“ IO çš„åœ°æ­¥äº†ã€‚\né¦–å…ˆè¯´ä¸€ä¸‹ç»“è®ºï¼ŒGlusterFS å®‰è£…å®Œæˆåï¼ŒåŸºæœ¬ä¸éœ€è¦è°ƒæ•´ä»»ä½•å‚æ•°ã€‚ç”Ÿäº§ç³»ç»Ÿåƒä¸‡ä¸å¯ç›²ç›®ï¼\nç„¶åæˆ‘ä»¬è¿™æ˜¯æœ‰ç‰¹æ®Šæƒ…å†µï¼Œæ‰€ä»¥è°ƒä¼˜æ­¥éª¤å¦‚ä¸‹ï¼ˆä»¥å·åä¸º esign-vol ä¸ºä¾‹ï¼‰ï¼š\n1#å¿…é¡»å…³æ‰NFS 2gluster volume set esign-vol nfs.disable on 3 4#å¿…é¡»ä¿ç•™10%çš„ç©ºé—´ï¼Œé¿å…å¡çˆ†å·ç©ºé—´ 5gluster volume set esign-vol cluster.min-free-disk 10% 6 7#æœ¬æœºæœ‰256Gçš„å†…å­˜ï¼Œæ‰€ä»¥è®¾ç½®25Gçš„è¯»ç¼“å­˜ 8gluster volume set esign-vol performance.cache-size 25GB 9#è¯»ç¼“å­˜ä¸­ï¼Œå•ä¸ªæ–‡ä»¶çš„ç¼“å­˜ï¼Œæœ€å¤§æ–‡ä»¶sizeæ˜¯128MBï¼Œå¤§äº128MBçš„å•ä¸ªæ–‡ä»¶ä¸ç¼“å­˜ 10gluster volume set esign-vol performance.cache-max-file-size 128MB 11 12#è®¾ç½®æ¯ä¸ªå®¢æˆ·ç«¯éƒ½å…è®¸å¤šçº¿ç¨‹ï¼Œç¼ºçœæ˜¯2ï¼Œå¤šä¸ªå°æ–‡ä»¶å¢åŠ ä¸º4 13gluster volume set esign-vol client.event-threads 4 14#è®¾ç½®æœåŠ¡å™¨ç«¯å¯¹ç‰¹å®šçš„å·å…è®¸å¤šçº¿ç¨‹ï¼Œç¼ºçœæ˜¯1,å¤šä¸ªå°æ–‡ä»¶å¢åŠ ä¸º4 15gluster volume set esign-vol server.event-threads 4 16 17#åˆ†å‰²çº¿ï¼Œä»¥ä¸‹å‚æ•°ä¸è¦è°ƒæ•´ï¼Œé™¤éæ˜ç¡®çŸ¥é“åæœ 18 19#è®¾ç½® io çº¿ç¨‹æ•°é‡ï¼Œè¿™ä¸ªå€¼ç¼ºçœæ˜¯16ï¼Œå·²ç»å¾ˆå¤§äº†ï¼Œè¶³å¤Ÿç”¨ 20gluster volume set esign-vol performance.io-thread-count 16 21#è®¾ç½®å†™ç¼“å†²åŒºï¼Œè¿™ä¸ªå€¼ç¼ºçœæ˜¯1Mï¼Œå¼„å¤§äº†å¦‚æœåœç”µä»€ä¹ˆçš„ï¼Œä¼šä¸¢æ•°æ® 22gluster volume set esign-vol performance.write-behind-window-size: 1M ä»¥ä¸Šå°±å¯ä»¥äº†ã€‚è¿˜æœ‰ä¸ªå‚æ•° global-threading ï¼Œç¼ºçœæ˜¯ offï¼Œä¸è¦è®¾ç½®ä¸º onï¼Œæœ‰ä½¿ç”¨æ¡ä»¶çš„ï¼Œå¼„é”™äº†åè€Œä¼šå¯¼è‡´æ€§èƒ½é™ä½ã€‚\n","date":"2021-11-15","img":"","permalink":"https://bajie.dev/posts/20211115-gluster_tuning/","series":null,"tags":null,"title":"GlusterFSæ–‡ä»¶ç³»ç»Ÿçš„ä¼˜åŒ–"},{"categories":null,"content":"åœ¨å®é™…ä¸­é‡åˆ°è¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼Œå…¬å¸è½¯ä»¶å‘å¸ƒä¸Šçº¿è‡ªåŠ¨åŒ–ã€‚\nè¯´ç®€å•ç‚¹ï¼Œå°±æ˜¯éœ€è¦å»ç™»å½•ä¸€ä¸ªä¸Šçº¿çš„å†…éƒ¨ç½‘ç«™ï¼Œç„¶åçˆ¬ä¸‹æ‰€æœ‰çš„ä¸Šçº¿æ•°æ®ã€‚\nç„¶åæ ¹æ®çˆ¬ä¸‹æ¥çš„æ•°æ®æ•´ç†å¥½ï¼Œå¯ä»¥ä¸€èµ·ä¸Šçº¿çš„ï¼Œå°±å¹¶å‘å¤šçº¿ç¨‹ï¼Œå…¶å®å°±æ˜¯å»ä¼ å‚æ•°ç‚¹å‡»ä¸€ä¸ªé“¾æ¥ç­‰è¿”å›ã€‚\nä¸èƒ½å¹¶å‘çš„å°±å•çº¿ç¨‹ç‚¹é“¾æ¥ã€‚\né‚£è¿™ä¸ªäº‹æƒ…å¿…é¡»æ›´æœ‰æ•ˆç‡ï¼Œå•çº¿ç¨‹çš„æ²¡é—®é¢˜ï¼Œç”¨ python çš„ request å°±å¯ä»¥å®ç°äº†ã€‚\næˆ‘ä»¬ä»”ç»†ç ”ç©¶ä¸€ä¸‹åç¨‹ï¼Œå…ˆè®²ä¸€ä¸‹å†å²ï¼š\nä½¿ç”¨Pythonçš„äººå¾€å¾€çº ç»“åœ¨å¤šçº¿ç¨‹ã€å¤šè¿›ç¨‹ï¼Œå“ªä¸ªæ•ˆç‡æ›´é«˜ï¼Ÿåˆ°åº•ç”¨å“ªä¸ªå¥½å‘¢ï¼Ÿ\nå…¶å® Python çš„å¤šè¿›ç¨‹å’Œå¤šçº¿ç¨‹ï¼Œç›¸å¯¹äºåˆ«å®¶çš„åç¨‹å’Œå¼‚æ­¥å¤„ç†æœºåˆ¶ï¼Œéƒ½ä¸è¡Œï¼Œçº¿ç¨‹ä¹‹é—´åˆ‡æ¢è€—è´¹ CPU å’Œå¯„å­˜å™¨ï¼ŒOS çš„è°ƒåº¦ä¸å¯æ§ï¼Œå¤šè¿›ç¨‹ä¹‹é—´é€šè®¯ä¹Ÿä¸ä¾¿ã€‚æ€§èƒ½æ ¹æœ¬ä¸è¡Œã€‚\nåæ¥å‘¢ Python æ”¹è¿›äº†è¯­æ³•ï¼Œå‡ºç°äº† yiled from å……å½“åç¨‹è°ƒåº¦ï¼Œæœ‰äººå°±æ ¹æ®è¿™ä¸ªç‰¹æ€§å¼€å‘äº†ç¬¬ä¸‰æ–¹çš„åç¨‹æ¡†æ¶ï¼ŒTornadoï¼ŒGeventç­‰ã€‚\nå®˜æ–¹ä¹Ÿä¸èƒ½åè§†ä¸ç†å•Šï¼Œä»»å‡­åˆ«äººå‡ºé£å¤´ï¼Œäºæ˜¯ Python ä¹‹çˆ¶æ·±å…¥ç®€å‡º3å¹´ï¼Œè‹¦å¿ƒé’»ç ”è‡ªå®¶çš„åç¨‹ï¼Œasync/await å’Œ asyncio åº“ï¼Œå¹¶æ”¾åˆ° Python3.5 åæˆä¸ºå®˜æ–¹åŸç”Ÿçš„åç¨‹ã€‚\nå¯¹äº httpè¯·æ±‚ã€è¯»å†™æ–‡ä»¶ã€è¯»å†™æ•°æ®åº“è¿™ç§é«˜å»¶æ—¶çš„ IO æ“ä½œï¼Œåç¨‹æ˜¯ä¸ªå¤§æ€å™¨ï¼Œä¼˜ç‚¹éå¸¸å¤šï¼›å®ƒå¯ä»¥åœ¨é¢„æ–™åˆ°ä¸€ä¸ªé˜»å¡å°†å‘ç”Ÿæ—¶ï¼ŒæŒ‚èµ·å½“å‰åç¨‹ï¼Œè·‘å»æ‰§è¡Œå…¶å®ƒåç¨‹ï¼ŒåŒæ—¶æŠŠäº‹ä»¶æ³¨å†Œåˆ°å¾ªç¯ä¸­ï¼Œå®ç°äº†å¤šåç¨‹å¹¶å‘ï¼Œå…¶å®è¿™ç©æ„æ˜¯è·Ÿ Nodejs çš„å›è°ƒå­¦çš„ã€‚\nçœ‹ä¸‹å›¾ï¼Œè¯¦ç»†è§£é‡Šä¸‹ï¼Œå·¦è¾¹æˆ‘ä»¬æœ‰100ä¸ªç½‘é¡µè¯·æ±‚ï¼Œå¹¶å‘100ä¸ªåç¨‹è¯·æ±‚ï¼ˆå…¶å®ä¹Ÿæ˜¯1ä¸ª1ä¸ªå‘ï¼‰ï¼Œå½“éœ€è¦ç­‰å¾…é•¿æ—¶é—´å›åº”å›åº”æ—¶ï¼ŒæŒ‚èµ·å½“å‰åç¨‹ï¼Œå¹¶æ³¨å†Œä¸€ä¸ªå›è°ƒå‡½æ•°åˆ°äº‹ä»¶å¾ªç¯ï¼ˆEvent Loopï¼‰ä¸­ï¼Œæ‰§è¡Œä¸‹ä¸€ä¸ªåç¨‹ï¼Œå½“æœ‰åç¨‹äº‹ä»¶å®Œæˆå†é€šè¿‡å›è°ƒå‡½æ•°å”¤é†’æŒ‚èµ·çš„åç¨‹ï¼Œç„¶åè¿”å›ç»“æœã€‚\nè¿™ä¸ªè·Ÿ nodejs çš„å›è°ƒå‡½æ•°åŸºæœ¬ä¸€æ ·ï¼Œæˆ‘ä»¬å¿…é¡»æ³¨æ„ä¸»è¿›ç¨‹å’Œåç¨‹çš„å…³ç³»ï¼Œå¦‚æœæˆ‘åœ¨ä¸€ä¸ªä¸»è¿›ç¨‹ä¸­ï¼Œè§¦å‘åç¨‹å‡½æ•°ï¼Œæœ‰100ä¸ªåç¨‹ï¼Œé‚£ä¹ˆå¿…é¡»ç­‰å¾…100ä¸ªåç¨‹éƒ½ç»“æŸåï¼Œæ‰èƒ½å›åˆ°æ­£å¸¸çš„é‚£ä¸ªä¸»è¿›ç¨‹ä¸­ã€‚å½“ç„¶ï¼Œä¸»è¿›ç¨‹ä¹Ÿå¯èƒ½ä¹Ÿæ˜¯ä¸€ä¸ªåç¨‹ã€‚\né‚£ä¹ˆåç¨‹çš„åŸºæœ¬ç”¨æ³•\n  async f(n) å£°æ˜ä¸€ä¸ªå‡½æ•°æ˜¯åç¨‹çš„\n  await f(n) æŒ‚èµ·å½“å‰åç¨‹ï¼ŒæŠŠæ§åˆ¶æƒäº¤å› event loopï¼Œå¹¶ä¸”æ‰§è¡Œf(n)å’Œæ³¨å†Œä¹‹åçš„f(n)å›è°ƒã€‚\nä¸¾ä¸ªä¾‹å­ï¼šå¦‚æœåœ¨ g() è¿™ä¸ªå‡½æ•°ä¸­æ‰§è¡Œäº† await f()ï¼Œé‚£ä¹ˆg()å‡½æ•°ä¼šè¢«æŒ‚èµ·ï¼Œå¹¶ç­‰å¾… f() å‡½æ•°æœ‰ç»“æœç»“æŸï¼Œç„¶åè¿”å› g() ç»§ç»­æ‰§è¡Œã€‚\n  1async def get(url): 2 async with aiohttp.ClientSession() as session: 3 async with session.get(url) as response: 4 return await response.text() æœ€åä¸€è¡Œ await æ˜¯æŒ‚èµ·å‘½ä»¤ï¼ŒæŒ‚èµ·å½“å‰å‡½æ•° get() ï¼Œå¹¶æ‰§è¡Œ response.text() å’Œæ³¨å†Œå›è°ƒï¼Œç­‰å¾… response.text() æ‰§è¡Œå®Œæˆåé‡æ–°æ¿€æ´»å½“å‰å‡½æ•¸get()ç»§ç»­æ‰§è¡Œï¼Œè¿”å›ã€‚\næ‰€ä»¥ await åªå«åšæŒ‚èµ·æ˜¯ä¸å¤ªå¯¹çš„ï¼Œæ„Ÿè§‰åº”è¯¥å«åš æŒ‚èµ·å¹¶æ³¨å†Œå›è°ƒ æ¯”è¾ƒåˆé€‚ã€‚\nçœ‹ä»¥ä¸‹ç¨‹åºï¼Œåœ¨ Python 3.7 ä¹‹å‰ï¼Œåç¨‹æ˜¯è¿™ä¹ˆç”¨çš„ï¼š\n1import time 2import asyncio 3 4now = lambda : time.time() 5 6async def do_some_work(x): 7 print(\u0026#39;Waiting: \u0026#39;, x) 8 9start = now() 10coroutine = do_some_work(2) 11loop = asyncio.get_event_loop() 12loop.run_until_complete(coroutine) 13print(\u0026#39;TIME: \u0026#39;, now() - start) æˆ‘ä»¬æŒ‡å®šäº†ä¸€ä¸ªåç¨‹ coroutine ï¼Œç„¶åå®šä¹‰äº†ä¸€ä¸ªäº‹ä»¶å¾ªç¯ loopï¼Œloop æ˜¯éœ€è¦ run_until_complete æ‰€æœ‰çš„åç¨‹ï¼Œç„¶åäº¤å‡ºæ§åˆ¶æƒï¼Œè¿”å›æ­£å¸¸çš„ä¸»è¿›ç¨‹ã€‚\nè·Ÿä¸Šå›¾å®Œå…¨åŒ¹é…ã€‚\nåœ¨ Python 3.7 ä¹‹åï¼Œç®€åŒ–äº†ç”¨æ³•ï¼Œä¸€å¥ asyncio.run å°±å¯ä»¥äº†ï¼š\n1asyncio.run(do_some_work(2)) ä¸Šé¢ç¨‹åºå°±å˜äº†ï¼Œçœäº†å¥½å¤šï¼Œä½†æ˜¯å‰¯ä½œç”¨æ˜¯ç¬¬ä¸€æ¬¡çœ‹åˆ°çš„äººä¼šä¸æ˜ç™½å®ƒæ˜¯æ€ä¹ˆè¿›åŒ–è¿‡æ¥çš„ï¼š\n1import time 2import asyncio 3 4now = lambda : time.time() 5 6async def do_some_work(x): 7 print(\u0026#39;Waiting: \u0026#39;, x) 8 9start = now() 10asyncio.run(do_some_work(2)) 11print(\u0026#39;TIME: \u0026#39;, now() - start) å¦‚æœæˆ‘ä»¬è¦è®¿é—®ä¸€ä¸ªç½‘ç«™çš„100ä¸ªç½‘é¡µï¼Œå•çº¿ç¨‹çš„åšæ³•æ˜¯ï¼šè¯·æ±‚ä¸€æ¬¡ï¼Œå›æ¥ä¸€æ¬¡ï¼Œç„¶åè¿›è¡Œä¸‹ä¸€ä¸ª\n1for url in urlsï¼š 2 response=get(url) 3 results=parse(response) è¿™æ ·æ•ˆç‡å¾ˆä½ï¼Œåç¨‹å‘¢ï¼Œåšæ³•å°±ä¸åŒäº†ï¼Œä¸€æ¬¡å‘èµ·100ä¸ªè¯·æ±‚ï¼ˆå‡†ç¡®çš„è¯´ä¹Ÿæ˜¯ä¸€ä¸ªä¸€ä¸ªå‘ï¼‰ï¼Œä¸åŒçš„æ˜¯åç¨‹ä¸ä¼šæ­»ç­‰è¿”å›ï¼Œè€Œæ˜¯å‘ä¸€ä¸ªè¯·æ±‚ï¼ŒæŒ‚èµ·ï¼Œå†å‘ä¸€ä¸ªå†æŒ‚èµ·ï¼Œå‘èµ·100ä¸ªï¼Œå°±æŒ‚èµ·100ä¸ªï¼Œç„¶åæ³¨å†Œå¹¶ç­‰å¾…100ä¸ªè¿”å›ï¼Œæ•ˆç‡æå‡äº†100å€ã€‚å¯ä»¥ç†è§£ä¸ºåŒæ—¶åšäº†100ä»¶äº‹ï¼Œåšåˆ°ç”±è‡ªå·±è°ƒåº¦è€Œä¸æ˜¯äº¤ç»™CPUï¼Œç¨‹åºçš„å¹¶å‘ç”±è‡ªå·±æ¥æ§åˆ¶ï¼Œè€Œä¸æ˜¯äº¤ç”± OS å»è°ƒåº¦ï¼Œæ•ˆç‡æå¤§çš„æé«˜äº†ã€‚\nè¿›åŒ–åˆ°åç¨‹ï¼Œæˆ‘ä»¬æŠŠè´¹ IO çš„ get å‡½æ•°æŠ½å‡ºæ¥æ”¾åˆ°åç¨‹é‡Œï¼š\n1async def get(url:str): 2 my_conn = aiohttp.TCPConnector(limit=10) 3 async with aiohttp.ClientSession(connector=my_conn) as session: 4 async with session.get(url) as resp: 5 return await resp.text() 6 7 8for url in urlsï¼š 9 response=asyncio.run(get(url)) 10 results=parse(response) 11 å…·ä½“åˆ°æˆ‘ä»¬çš„é¡¹ç›®ï¼Œæˆ‘ä»¬é¦–å…ˆè¦ç™»å½•ä¸€ä¸ªç½‘é¡µæ‹¿åˆ° cookieï¼Œè¿™ä¸ªè¿‡ç¨‹å…¶å®å°±ä¸€ä¸ªåç¨‹ï¼Œæ²¡äººä¼šç™»å½•ä¸ªå‡ ç™¾æ¬¡å§ã€‚ç„¶åæŠŠæ”¾äº† cookie çš„ session å–å‡ºæ¥ï¼Œä¾›åé¢çš„åç¨‹å†å¤ç”¨å°±å¯ä»¥äº†ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š\n1import aiohttp 2import asyncio 3 4async def login(): 5 my_conn = aiohttp.TCPConnector(limit=10) 6 async with aiohttp.ClientSession(connector=my_conn) as session: 7 data = {\u0026#39;loginname\u0026#39;:\u0026#39;wangbadan\u0026#39;,\u0026#39;password\u0026#39;:\u0026#39;Fuckyouall\u0026#39;} 8 async with session.post(\u0026#39;http://192.168.1.3/user/login\u0026#39;,data=data) as resp: 9 print(resp.url) 10 print(resp.status) 11 print(await resp.text()) 12 return session 13 14session = asyncio.run(login()) 15print(f\u0026#34;{session}\u0026#34;) å†ç»™ä¸€ä¸ªå®Œå…¨ç‰ˆçš„ä¸»å‡½æ•°æ˜¯è¿›ç¨‹ï¼Œä¸‹è½½æ˜¯åç¨‹çš„ä¾‹å­ï¼Œæ³¨æ„é‡Œé¢çš„ aiohttp.TCPConnector(limit=10)ï¼Œé™åˆ¶ä¸€ä¸‹å¹¶å‘æ˜¯10ä¸ªï¼Œå¦åˆ™ä¼šè¢«æœåŠ¡å™¨ Ban æ‰ï¼š\n1import asyncio 2import time 3import aiohttp 4from aiohttp.client import ClientSession 5 6async def download_link(url:str,session:ClientSession): 7 async with session.get(url) as response: 8 result = await response.text() 9 print(f\u0026#39;Read {len(result)}from {url}\u0026#39;) 10 11async def download_all(urls:list): 12 my_conn = aiohttp.TCPConnector(limit=10) 13 async with aiohttp.ClientSession(connector=my_conn) as session: 14 tasks = [] 15 for url in urls: 16 task = asyncio.ensure_future(download_link(url=url,session=session)) 17 tasks.append(task) 18 await asyncio.gather(*tasks,return_exceptions=True) # the await must be nest inside of the session 19 20url_list = [\u0026#34;https://www.google.com\u0026#34;,\u0026#34;https://www.bing.com\u0026#34;]*50 21print(url_list) 22start = time.time() 23asyncio.run(download_all(url_list)) 24end = time.time() 25print(f\u0026#39;download {len(url_list)}links in {end - start}seconds\u0026#39;) åç¨‹é‡Œçš„ session ä¹Ÿæœ‰å¾ˆå¤šç§ç”¨æ³•ï¼Œå‚è€ƒä¸‹é¢çš„é“¾æ¥å°±å¥½ï¼š\nhttps://blog.csdn.net/weixin_39643613/article/details/109171090 æˆ‘ä»¬ä¹Ÿç»™å‡ºç®€å•æ˜“ç”¨çš„çº¿ç¨‹æ± ç‰ˆï¼Œè¯´ä¸å®šä»¥åä¼šç”¨ä¸Šï¼š\n1import requests 2from requests.sessions import Session 3import time 4from concurrent.futures import ThreadPoolExecutor 5from threading import Thread,local 6 7url_list = [\u0026#34;https://www.google.com/\u0026#34;,\u0026#34;https://www.bing.com\u0026#34;]*50 8thread_local = local() 9 10def get_session() -\u0026gt; Session: 11 if not hasattr(thread_local,\u0026#39;session\u0026#39;): 12 thread_local.session = requests.Session() 13 return thread_local.session 14 15def download_link(url:str): 16 session = get_session() 17 with session.get(url) as response: 18 print(f\u0026#39;Read {len(response.content)}from {url}\u0026#39;) 19 20def download_all(urls:list) -\u0026gt; None: 21 with ThreadPoolExecutor(max_workers=10) as executor: 22 executor.map(download_link,url_list) 23 24start = time.time() 25download_all(url_list) 26end = time.time() 27print(f\u0026#39;download {len(url_list)}links in {end - start}seconds\u0026#39;) ","date":"2021-11-12","img":"","permalink":"https://bajie.dev/posts/20211112-python_aiohttp/","series":null,"tags":null,"title":"Pythonçš„åç¨‹è¯¦ç»†è§£é‡Š"},{"categories":null,"content":"æˆ‘ä»¬ä»‹ç»äº†å¦‚ä½•åœ¨ kubernetes ç¯å¢ƒä¸­ä½¿ç”¨ filebeat sidecar æ–¹å¼æ”¶é›†æ—¥å¿—\nä½¿ç”¨çš„æ˜¯ filebeat çš„ moudle æ¨¡å—ï¼Œä½†å‡¡æ˜¯å¸¸ç”¨çš„è½¯ä»¶ï¼ŒåŸºæœ¬éƒ½æœ‰å¯¹åº”çš„æ¨¡å—å¯ç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬é¦–å…ˆåº”è¯¥ä½¿ç”¨æ¨¡å—æ¥æ”¶é›†æ—¥å¿—ã€‚\né‚£å¯¹äºä¸€äº›æˆ‘ä»¬è‡ªå·±å†™çš„ Go è½¯ä»¶å‘¢ï¼Œæˆ–è€…æ ¹æœ¬ä¸æ˜¯æ ‡å‡†çš„ï¼Œé‚£è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ\né‚£å°±è‡ªå®šä¹‰ filebeat.inputsï¼Œç½‘ä¸Šçš„ filebeat ä¾‹å­ï¼Œå…¶å®å¤§å¤šéƒ½æ˜¯è¿™æ ·çš„\nå¾ˆç®€å•ï¼Œç»™ä¸ªä¾‹å­\n1[beat-logstash-some-name-832-2015.11.28] IndexNotFoundException[no such index] 2 at org.elasticsearch.cluster.metadata.(IndexNameExpressionResolver.java:566) 3 at org.elasticsearch.cluster.metadata.(IndexNameExpressionResolver.java:133) 4 at org.elasticsearch.cluster.metadata.(IndexNameExpressionResolver.java:77) 5 at org.elasticsearch.action.admin..checkBlock(TransportDeleteIndexAction.java:75) çœ‹å¦‚ä¸Šæ—¥å¿—ï¼Œå¦‚æœä¸ç”¨æ¨¡å¼åŒ¹é…çš„è¯ï¼Œé‚£ä¹ˆä¼šé€5æ¡è®°å½•åˆ° ESï¼Œ Kibana çœ‹èµ·æ¥å°±ååˆ†å‰²è£‚äº†ã€‚\næ‰€ä»¥è¦ç”¨æ­£åˆ™æŠŠåº•ä¸‹çš„4è¡Œå’Œä¸Šé¢çš„ç¬¬1è¡Œåˆåœ¨ä¸€èµ·ï¼Œåˆå¹¶æˆä¸€æ¡å°±è®°å½•æ¨é€åˆ° ES å»\nä»”ç»†è§‚å¯Ÿï¼Œå¼€å¤´ä¸€è¡Œæ˜¯ä»¥ [ å¼€å§‹çš„ï¼Œæ‰€ä»¥æ­£åˆ™å°±æ˜¯ \u0026lsquo;^\\['ï¼Œæˆ‘ä»¬è¦åŒ¹é…çš„æ˜¯åº•ä¸‹çš„4è¡Œï¼Œå¿…é¡»åè½¬ä¸€ä¸‹æ¨¡å¼ã€‚\nmultiline çš„ negate å±æ€§ï¼Œè¿™ä¸ªæ˜¯æŒ‡å®šæ˜¯å¦åè½¬åŒ¹é…åˆ°çš„å†…å®¹ï¼Œè¿™é‡Œå¦‚æœæ˜¯ true çš„è¯ï¼Œåè½¬ï¼Œé‚£å°±æ˜¯é€‰æ‹©ä¸ä»¥ [ å¼€å¤´çš„è¡Œã€‚ netgate å±æ€§çš„ç¼ºçœå€¼æ˜¯ false\nmultiline çš„ match å±æ€§ï¼Œafter æŒ‡è¿½åŠ åˆ°ä¸Šä¸€æ¡äº‹ä»¶ï¼ˆå‘ä¸Šåˆå¹¶ï¼‰ï¼Œbefore æŒ‡åˆå¹¶åˆ°ä¸‹ä¸€æ¡ï¼ˆå‘ä¸‹åˆå¹¶ï¼‰\näºæ˜¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥å†™å‡ºä»¥ä¸‹çš„åŒ¹é…æ¨¡å¼ï¼Œè¿™æ ·å°±æŠŠåŒ¹é…åˆ°æ¡ç›®è¿½åŠ åˆ°ä¸Šä¸€æ¡ï¼Œåˆå¹¶åœ¨ä¸€èµ·äº†ï¼š\n1filebeat.inputs: 2 - type: log 3 enabled: true 4 paths: 5 - /Users/liuxg/data/multiline/multiline.log 6 multiline.type: pattern 7 multiline.pattern: \u0026#39;^\\[\u0026#39; 8 multiline.negate: true 9 multiline.match: after 10 11output.elasticsearch: 12 hosts: [\u0026#34;localhost:9200\u0026#34;] 13 index: \u0026#34;multiline\u0026#34; 14 å†ç»™ä¸ªä¾‹å­ï¼Œjava çš„ stack è°ƒç”¨ï¼Œæ—¥å¿—æ ¼å¼å¦‚ä¸‹ï¼š\n1Exception in thread \u0026#34;main\u0026#34; java.lang.NullPointerException 2 at com.example.myproject.Book.getTitle(Book.java:16) 3 at com.example.myproject.Author.getBookTitles(Author.java:25) 4 at com.example.myproject.Bootstrap.main(Bootstrap.java:14) åˆ†æä¸€ä¸‹ï¼š\n åŒ¹é…åˆ°å¼€å¤´æ˜¯ç©ºæ ¼çš„é‚£äº›è¡Œï¼Œæ­£åˆ™ \u0026lsquo;^[[:space]]\u0026rsquo; åŒ¹é…çš„è¡Œä¸åè½¬ï¼Œå°±æ˜¯è¦é‚£äº›ç©ºæ ¼å¼€å¤´çš„è¡Œï¼Œæ‰€ä»¥ negate æ˜¯ç¼ºçœçš„ false åŒ¹é…çš„ç©ºæ ¼è¡Œè¿½åŠ åˆ°ä¸Šä¸€ä¸ªäº‹ä»¶ï¼Œå‘ä¸Šåˆå¹¶ï¼Œæ‰€ä»¥ match æ˜¯ after  1filebeat.inputs: 2 - type: log 3 enabled: true 4 paths: 5 - /Users/liuxg/data/multiline/multiline.log 6 multiline.type: pattern 7 multiline.pattern: \u0026#39;^[[:space:]]\u0026#39; 8 multiline.negate: false 9 multiline.match: after å†ç»™ä¸ªä¾‹å­ï¼Œå‡å¦‚ä½ åœ¨ Go ç¨‹åºé‡Œå®šä¹‰äº†è¾“å‡ºæ—¥å¿—çš„æ ¼å¼ï¼Œä»¥ Start new event å¼€å¤´ï¼Œä»¥ End event ç»“å°¾\n1[2015-08-24 11:49:14,389] Start new event 2[2015-08-24 11:49:14,395] Content of processing something 3[2015-08-24 11:49:14,399] End event 4[2015-08-24 11:50:14,389] Some other log 5[2015-08-24 11:50:14,395] Some other log 6[2015-08-24 11:50:14,399] Some other log 7[2015-08-24 11:51:14,389] Start new event 8[2015-08-24 11:51:14,395] Content of processing something 9[2015-08-24 11:51:14,399] End event æˆ‘ä»¬å°±ç”¨åˆ° filebeat multiline çš„å¦ä¸€ä¸ªå¼€å…³ï¼Œflush_patternï¼Œæ¥æ§åˆ¶å¦‚ä½•ç»“æŸï¼Œæ³¨æ„ negate æ˜¯ true ï¼ŒåŒ¹é…åˆ°çš„æ˜¯ Start å’Œ End ä¸­é—´çš„éƒ¨åˆ†ï¼š\n1multiline.type: pattern 2multiline.pattern: \u0026#39;Start new event\u0026#39; 3multiline.negate: true 4multiline.match: after 5multiline.flush_pattern: \u0026#39;End event\u0026#39; 6 7filebeat.inputs: 8 - type: log 9 enabled: true 10 paths: 11 - /Users/liuxg/data/multiline/multiline.log 12 multiline.type: pattern 13 multiline.pattern: \u0026#39;Start new event\u0026#39; 14 multiline.negate: true 15 multiline.match: after 16 multiline.flush_pattern: \u0026#39;End event\u0026#39; ç»™ä¸¤ç¯‡å‚è€ƒï¼Œå¤§å®¶ä¸€å®šè¦å…ˆçœ‹é‚£ç¯‡åŸç‰ˆè‹±æ–‡çš„ï¼Œä¸­æ–‡çš„é‚£ç¯‡ç¿»å¾—ä¸å¤ªå¥½ï¼›æœ€å¥½ä¸¤ç¯‡å¯¹ç…§ç€çœ‹ã€‚\nå‚è€ƒï¼š\n https://www.elastic.co/guide/en/beats/filebeat/current/multiline-examples.html  https://developer.aliyun.com/article/764544   ","date":"2021-11-11","img":"","permalink":"https://bajie.dev/posts/20211111-k8s_filebeat/","series":null,"tags":null,"title":"Kubernetesä½¿ç”¨filebeat Multilineè‡ªå®šä¹‰æ”¶é›†æ—¥å¿—"},{"categories":null,"content":"åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ Kubernetes ï¼Œç»•ä¸è¿‡å»çš„ä¸€ä¸ªé—®é¢˜å°±æ˜¯æŒä¹…åŒ–å·ã€‚\nå¦‚æœæ˜¯ä½¿ç”¨é˜¿é‡Œ ACK æ‰˜ç®¡å¹³å°çš„è¯ï¼Œå¯ä»¥ç”¨ OSS æ¥æŒä¹…åŒ–å·ï¼Œå¦‚æœæ˜¯è‡ªæ­çš„ kubernetesï¼Œé‚£ä¹ˆå­˜å‚¨å°±éœ€è¦ä»”ç»†è€ƒè™‘äº†ã€‚\ncephæ¯”è¾ƒå¤æ‚ï¼Œå®¹æ˜“å‡ºæ•…éšœã€‚nfs ä¹Ÿä¸å¯ç”¨ï¼Œæ¯›ç—…å¤šå¤šã€‚minioå€’æ˜¯å¯ä»¥ã€‚\nè¿™ç§æƒ…å†µä¸‹ä½¿ç”¨åŒå‰¯æœ¬çš„ GlusterFS å°±æ˜¯ä¸é”™çš„é€‰æ‹©ã€‚\nç”Ÿäº§ç¯å¢ƒå°±ä¸èƒ½éšæ„äº†ï¼Œæœ€å¥½ä¸è¦ä½¿ç”¨ Heketiï¼Œå› ä¸ºå‡¡æ˜¯è¦æŒä¹…åŒ–çš„ä¸œè¥¿ï¼Œéƒ½æ˜¯æ¯”è¾ƒé‡è¦çš„ä¸œè¥¿ï¼Œæœ€å¥½éƒ½æœ‰ yaml è®°å½•ã€‚\nGlusterFS çš„æ­å»ºå°±ä¸è¯´äº†ã€‚è¯´è¯´å®é™…ä½¿ç”¨è¿‡ç¨‹ï¼š\nä¸€ã€è£…GFSï¼Œç”Ÿäº§æ–°å· å®‰è£…å°±ä¸è¯´äº†ï¼Œæˆ‘ä»¬çš„GFSæœ‰ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œ172.19.20.18 å’Œ 172.19.20.36ï¼Œæˆ‘ä»¬å¼ºåˆ¶å»ºç«‹ä¸€ä¸ªä¸¤å‰¯æœ¬çš„å·ï¼š kuaijian-vol\n1gluster volume create kuaijian-vol replica 2 transport tcp 172.19.20.18:/glusterfs/kuaijian-vol 172.19.20.36:/glusterfs/kuaijian-vol force äºŒã€ä¸ºk8säº§ç”ŸGFSçš„endingpointå’Œservice 1cat \u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; ep-svc.yaml 2--- 3apiVersion: v1 4kind: Service 5metadata: 6name: gfs-cluster_svc 7spec: 8ports: 9- port: 1 10--- 11apiVersion: v1 12kind: Endpoints 13metadata: 14name: gfs-cluster_svc 15subsets: 16- addresses: 17- ip: 172.19.20.18 18ports: 19- port: 1 20- addresses: 21- ip: 172.19.20.36 22ports: 23- port: 1 24EOF 25 26kubectl apply -f ep-svc.yaml è¿™é‡Œè¦æä¸€ä¸ªæ¦‚å¿µï¼Œé€šå¸¸æƒ…å†µä¸‹ service æ˜¯é€šè¿‡ selector æ ‡ç­¾æ¥é€‰æ‹©å¯¹åº”çš„ pod æ¥å¢åŠ  endingpoint çš„ã€‚å¦‚ä¸‹ï¼š\n1apiVersion: v1 2kind: Service 3metadata: 4 name: go-api_svc 5spec: 6 ports: 7 - port: 8080 8 protocol: TCP 9 targetPort: 8080 10 selector: 11 app: go-api 12 type: ClusterIP è€Œä¸Šé¢ï¼Œæˆ‘ä»¬æ²¡æœ‰é€šè¿‡æ ‡ç­¾ï¼Œè€Œæ˜¯è®© endingpoint å’Œ svc åŒåè€Œæ‰‹åŠ¨å¢åŠ  endingpoint åˆ° svc çš„ã€‚\nä¸‰ã€ä¸ºk8sç”Ÿäº§åˆ›å»º PVå’ŒPVC é™æ€ç¯å¢ƒä¸ä½¿ç”¨ Storageclass æŒä¹…åŒ–å·çš„å›¾è§£å¦‚ä¸‹ï¼Œpodåšpvcå£°æ˜ï¼Œpvcè¿æ¥åˆ°pvï¼Œpvä»GFSä¸­æ‹¿åˆ°å·ã€‚\né¦–å…ˆå£°æ˜ä¸€ä¸ª pvï¼š\n1cat \u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; kuaijian-pv.yaml 2apiVersion: v1 3kind: PersistentVolume 4metadata: 5name: gfs-kuaijian-50G_pv 6labels: 7name: gfs-kuaijian-50G_pv 8spec: 9capacity: 10storage: 50Gi 11accessModes: 12- ReadWriteMany 13glusterfs: 14endpoints: gfs-cluster_svc 15path: kuaijian-vol 16readOnly: false 17persistentVolumeReclaimPolicy: Retain 18EOF 19 20kubectl apply -f kuaijian-pv.yaml ç„¶åå£°æ˜ä¸€ä¸ª pvc é€šè¿‡ matchLabels æ¥è·Ÿä¹‹å‰çš„ pv ç»‘å®šã€‚\n1cat \u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; kuaijian-pvc.yaml 2kind: PersistentVolumeClaim 3apiVersion: v1 4metadata: 5name: gfs-kuaijian-50G_pvc 6spec: 7accessModes: 8- ReadWriteMany 9resources: 10requests: 11storage: 50Gi 12selector: 13matchLabels: 14name: gfs-kuaijian-50G_pv 15EOF 16 17kubectl apply -f kuaijian-pvc.yaml æ³¨æ„ä¸Šé¢çš„ pvcï¼Œæˆ‘ä»¬ä¸€ä¸‹å­ç”³è¯·äº†50Gï¼ŒæŠŠæ•´ä¸ª pv ç©ºé—´å…¨ç”¨å…‰äº†ï¼›å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥åªç”³è¯·ä¸ª 10Giï¼Œä¸‹ä¸ª pvc å† 10Giï¼Œè¿™æ ·ä¹Ÿæ˜¯è¡Œçš„é€šçš„ã€‚\nå››ã€PODä½¿ç”¨PVC å£°æ˜ä¸€ä¸ª Nginx çš„ Deployment æ¥ä½¿ç”¨è¿™ä¸ª pvc\n1apiVersion: apps/v1 2kind: Deployment 3metadata: 4 name: nginx-deployment 5 labels: 6 app: nginx 7spec: 8 replicas: 2 9 selector: 10 matchLabels: 11 app: nginx 12 template: 13 metadata: 14 labels: 15 app: nginx 16 spec: 17 containers: 18 - name: nginx 19 image: nginx 20 ports: 21 - containerPort: 80 22 volumeMounts: 23 - name: data-www 24 mountPath: /data/www 25 volumes: 26 - name: data-www 27 persistentVolumeClaim: 28 claimName: gfs-kuaijian-50G_pvc è¿™æ · kubernetes çš„å­˜å‚¨éƒ¨åˆ†å°±æå®šäº†ã€‚GFS ç”¨äºç”Ÿäº§éå¸¸ç¨³å®šï¼ŒåŸºæœ¬è·‘äº† 7 å¹´äº†æ²¡æœ‰å¤§æ¯›ç—…ã€‚\n","date":"2021-11-10","img":"","permalink":"https://bajie.dev/posts/20211110-k8s_gfs/","series":null,"tags":null,"title":"ç”Ÿäº§ç¯å¢ƒkubernetesä½¿ç”¨æŒä¹…åŒ–å·GlusterFS"},{"categories":null,"content":"åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼ŒES é€šå¸¸æ˜¯ä¸ä¼šåœ¨ k8s é›†ç¾¤ä¸­å­˜åœ¨çš„ï¼Œä¸€èˆ¬ MySQL å’Œ Elasticsearch éƒ½æ˜¯ç‹¬ç«‹åœ¨ k8s ä¹‹å¤–ã€‚\né‚£ä¹ˆæ— è®ºå“ªç§ podï¼Œè¦ç”©æ—¥å¿—åˆ° ESï¼Œæœ€è½»é‡çš„æ–¹æ¡ˆè‚¯å®šæ˜¯ç”¨ filebeat ç”©è¿‡å»äº†ã€‚\nå½“ç„¶ï¼Œå¦‚æœæ˜¯é˜¿é‡Œçš„ ACKï¼Œlogtail å’Œ logstore é…æ­å·²ç»éå¸¸ä¸é”™äº†ï¼Œæ ¹æœ¬ç”¨ä¸åˆ° filebeat å’Œ ESã€‚\nå¯ä½†æ˜¯ï¼Œæˆ‘ä»¬ä¸æƒ³ä¸ºé˜¿é‡Œ slsã€logstore å‡ºé’±ä¹°å•ï¼Œå°±åªèƒ½ç”¨ filebeat + ES äº†\nè¯´ä¸€ä¸‹ filebeat çš„ sidecar è¾¹è½¦ï¼ˆåƒšæœºï¼‰ç”¨æ³•ï¼š\nå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œç®€å•è¯´å°±æ˜¯èµ·ä¸€ä¸ª filebeat çš„ logging-agent è¾¹è½¦ï¼ˆåƒšæœºï¼‰ï¼Œè¾¹è½¦å’Œä¸»åº”ç”¨ä¹‹é—´å…±äº«æŸä¸ªæ–‡ä»¶å¤¹ï¼ˆmountPathï¼‰ï¼Œè¾¾åˆ°æ”¶é›†ä¸»åº”ç”¨æ—¥å¿—å¹¶å‘é€åˆ° ESï¼Œè€Œä¸ç”¨åŠ¨ app-container åˆ†æ¯«ã€‚\næˆ‘ä»¬ä»¥éƒ¨ç½²ä¸€ä¸ª Tomcat åº”ç”¨ä¸ºä¾‹æ¥è¯´æ˜ï¼š\nä¸€ã€æ‰“é€  filebeat è¾¹è½¦é•œåƒ é¦–å…ˆå‡†å¤‡ Dockerfile\n1FROM alpine:3.12  2 3ARG VERSION=7.15.1  4 5COPY docker-entrypoint.sh /  6 7RUN set -x \\  8 \u0026amp;\u0026amp; cd /tmp \\  9 \u0026amp;\u0026amp; wget https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-${VERSION}-linux-x86_64.tar.gz \\  10 \u0026amp;\u0026amp; tar xzvf filebeat-${VERSION}-linux-x86_64.tar.gz \\  11 \u0026amp;\u0026amp; mv filebeat-${VERSION}-linux-x86_64 /opt \\  12 \u0026amp;\u0026amp; rm /tmp/* \\  13 \u0026amp;\u0026amp; chmod +x /docker-entrypoint.sh  14 15 16ENV PATH $PATH:/opt/filebeat-${VERSION}-linux-x86_64  17 18WORKDIR /opt/filebeat-${VERSION}-linux-x86_64  19 20ENTRYPOINT [\u0026#34;/docker-entrypoint.sh\u0026#34;]  æˆ‘ä»¬ä»¥ alphine:3.12 ä¸ºåº•ç‰ˆï¼Œç„¶åä¸‹è½½ filebeat 7.15.1çš„äºŒè¿›åˆ¶åŒ…å¹¶é‡Šæ”¾åˆ° /opt ä¸‹ï¼Œæœ€åæŒ‡å®šå…¥å£æ–‡ä»¶ /docker-entrypoint.sh\nå¥¥å¦™å…¨åœ¨è¿™ä¸ª docker-entrypoint.sh ä¸­äº†\n1#!/bin/bash 2 3cat \u0026gt; /etc/filebeat.yaml \u0026lt;\u0026lt; EOF 4filebeat.config.modules: 5path: /opt/filebeat-7.15.1-linux-x86_64/modules.d/*.yml 6reload.enabled: true 78# åŠ å…¥è‡ªå®šä¹‰çš„å­—æ®µ 9fields_under_root: true 10fields: 11project: kuaijian-tomcat 12pod_ip: ${POD_IP} 13pod_name: ${POD_NAME} 14node_name: ${NODE_NAME} 15pod_namespace: ${POD_NAMESPACE} 1617# æ”¶é›†äº‘å‚å•†çš„æ•°æ®å’Œdockerçš„å˜é‡ 18processors: 19- add_cloud_metadata: ~ 20- add_docker_metadata: ~ 2122filebeat.modules: 23- module: apache 24access: 25enabled: true 26var.paths: 27- \u0026#34;/usr/local/tomcat/logs/localhost_access_log.*.txt\u0026#34; 28error: 29enabled: true 30var.paths: 31- \u0026#34;/usr/local/tomcat/logs/application.log*\u0026#34; 32- \u0026#34;/usr/local/tomcat/logs/catalina.*.log\u0026#34; 33- \u0026#34;/usr/local/tomcat/logs/host-manager.*.log\u0026#34; 34- \u0026#34;/usr/local/tomcat/logs/localhost.*.log\u0026#34; 35- \u0026#34;/usr/local/tomcat/logs/manager.*.log\u0026#34; 3637setup.template.name: \u0026#34;tomcat-logs\u0026#34; 38setup.template.pattern: \u0026#34;tomcat-logs-*\u0026#34; 39output.elasticsearch: 40hosts: [\u0026#34;172.19.20.xxx:9200\u0026#34;,\u0026#34;172.19.20.xxx:9200\u0026#34;] 41index: \u0026#34;tomcat-logs-%{+yyyy.MM}\u0026#34; 42EOF 43 44set -xe 45 46# If user don\u0026#39;t provide any command  47# Run filebeat  48if [[ \u0026#34;$1\u0026#34; == \u0026#34;\u0026#34; ]]; then 49 exec /opt/filebeat-7.15.1-linux-x86_64/filebeat -c /etc/filebeat.yaml 50else 51 # Else allow the user to run arbitrarily commands like bash  52 exec \u0026#34;$@\u0026#34; 53fi æˆ‘ä»¬ä¸ºä»€ä¹ˆä¸åœ¨ k8s é‡Œç”¨ configmap æ¥é…ç½® filebeat.yml å‘¢ï¼Ÿ\nç†ç”±æ˜¯æ”¶é›†æ—¥å¿—æ–‡ä»¶å¤šä¸”è·¯å¾„ã€ç±»å‹å„ä¸ç›¸åŒï¼Œè¿™ä¹ˆä¸€å †çš„é…ç½®éƒ½æ”¾åœ¨ configmap é‡Œä¼šè®©äººç™«ç‹‚çš„ã€‚æ‰€ä»¥å¹²è„†æ”¾åˆ°é•œåƒé‡Œï¼Œä¾¿äºè°ƒè¯•ä¹Ÿä¾¿äºä¿®æ”¹ã€‚\nä¸Šé¢æˆ‘ä»¬ä¹Ÿå……åˆ†åˆ©ç”¨äº† filebeat çš„ moduleï¼Œæœ‰ module å¯ç”¨å°±å¿…é¡»ç”¨ moduleï¼Œè€Œä¸æ˜¯æ‰‹åŠ¨æŒ‡å®š filebeat.inputs ï¼Œå¯ç”¨çš„ mudole å®åœ¨å¤ªå¤šäº†ï¼Œä¸€å®šè¦å–„ç”¨ï¼ï¼ï¼å¦å¤– tomcat å’Œ apache çš„æ—¥å¿—æ ¼å¼æ˜¯ä¸€æ ·çš„ã€‚\næˆ‘ä»¬åœ¨æœ€åæ‰§è¡Œçš„æ—¶å€™ï¼Œä¹ŸåŠ äº† exec $@ ä¾¿äºè°ƒè¯•ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®š CMDï¼Œå°±å¯åŠ¨ filebeatï¼Œå¦‚æœæŒ‡å®šäº†æ¯”å¦‚ /bin/bashï¼Œå°±è¿›å…¥è°ƒè¯•çŠ¶æ€ã€‚\næˆ‘ä»¬æ‰“å¥½é•œåƒå°± push åˆ° harbor é‡Œå¾…ç”¨\né™„å½•ï¼šhttps://www.elastic.co/guide/en/beats/filebeat/current/configuration-general-options.html filebeatçš„é…ç½®åˆ—è¡¨\näºŒã€sidecaréƒ¨ç½² æˆ‘ä»¬å†™ä¸€ä¸ª k8s çš„ tomcat deploymentæ–‡ä»¶ï¼š\n1apiVersion: apps/v1 2kind: Deployment 3metadata: 4 name: tomcat 5 labels: 6 app: tomcat 7spec: 8 replicas: 1 9 selector: 10 matchLabels: 11 app: tomcat 12 template: 13 metadata: 14 labels: 15 app: tomcat 16 spec: 17 containers: 18 - name: filebeat-sidecar 19 image: xxxx.xxxx.xxx/filebeat:xxx 20 env: 21 - name: POD_NAMESPACE 22 valueFrom: 23 fieldRef: 24 apiVersion: v1 25 fieldPath: metadata.namespace 26 - name: NODE_NAME 27 valueFrom: 28 fieldRef: 29 apiVersion: v1 30 fieldPath: spec.nodeName 31 - name: POD_IP 32 valueFrom: 33 fieldRef: 34 apiVersion: v1 35 fieldPath: status.podIP 36 - name: POD_NAME 37 valueFrom: 38 fieldRef: 39 apiVersion: v1 40 fieldPath: metadata.name  41 volumeMounts: 42 - name: logs-volume 43 mountPath: /usr/local/tomcat/logs 44 - name: tomcat 45 image: tomcat 46 ports: 47 - containerPort: 8080 48 volumeMounts: 49 - name: logs-volume 50 mountPath: /usr/local/tomcat/logs 51 volumes: 52 - name: logs-volume 53 emptyDir: {} å¯ä»¥çœ‹åˆ°æˆ‘ä»¬åœ¨è¿™ä¸ª deployment é‡Œå®šä¹‰äº† pod æ˜¯å•å‰¯æœ¬ï¼Œé‡Œé¢è·‘äº†ä¸¤ä¸ª containerï¼Œä¸€ä¸ªæ˜¯ filebeatï¼Œä¸€ä¸ªæ˜¯ tocmatï¼Œä¸¤è€…é€šè¿‡åŒä¸€ä¸ª volume è¿æ¥åœ¨ä¸€èµ·ï¼Œè¿™æ ·å°±å¯ä»¥åšåˆ°ä¸ä¿®æ”¹ tomcat container è€Œæ‹¿åˆ°é‡Œé¢çš„æ—¥å¿—äº†ã€‚\nè¿™æ ·å°±æŠŠ tomcat åº”ç”¨çš„æ—¥å¿—æ”¶åˆ° ES å»äº†ã€‚\n","date":"2021-11-10","img":"","permalink":"https://bajie.dev/posts/20211110-k8s_sidecar/","series":null,"tags":null,"title":"Kubernetesç”Ÿäº§ç¯å¢ƒä½¿ç”¨filebeat Sidecaræ”¶é›†æ—¥å¿—"},{"categories":null,"content":"æˆ‘ä»¬é€‰æ‹© haproxy 1.8 ç‰ˆæœ¬ä»¥ä¸Šçš„ï¼Œç¼–è¯‘å®‰è£…åˆ°è·¯å¾„ /export/servers/haproxy\n1make TARGET=linux2628 PREFIX=/export/servers/haproxy USE_GETADDRINFO=1 USE_ZLIB=1 USE_REGPARM=1 USE_OPENSSL=1 \\ 2 USE_SYSTEMD=1 USE_PCRE=1 USE_PCRE_JIT=1 USE_NS=1 3 4make install PREFIX=/export/servers/haproxy ç¼–è¾‘ haproxy.conf é…ç½®æ–‡ä»¶ï¼š\n1global  2 maxconn 5120  3 chroot /export/servers/haproxy  4 daemon  5 quiet  6 nbproc 2  7 pidfile /tmp/haproxy.pid 8 9defaults  10 timeout connect 5s  11 timeout client 50s  12 timeout server 20s 13 14listen http  15 bind :80  16 timeout client 1h  17 tcp-request inspect-delay 2s  18 acl is_http req_proto_http  19 tcp-request content accept if is_http  20 server server-http :8080 21 use_backend ssh if !is_http 22 23backend ssh  24 mode tcp  25 timeout server 1h  26 server server-ssh :22 è§£é‡Šä¸€ä¸‹ï¼šæˆ‘ä»¬åœ¨ 8080 ç«¯å£å¼€äº† http æœåŠ¡ï¼Œåœ¨ 22 ç«¯å£å¼€äº† ssh æœåŠ¡ï¼Œ80ç«¯å£ç”± haproxy åšä»£ç†è½¬å‘ï¼Œé¦–å…ˆåˆ¤æ–­å®¢æˆ·ç«¯è¯·æ±‚æ˜¯å¦æ˜¯ http è¯·æ±‚ï¼Œå¦‚æœæ˜¯å°±è½¬å‘åˆ° 8080 ç«¯å£ï¼Œå¦‚æœä¸æ˜¯ï¼Œå°±è½¬å‘åˆ° 22 ç«¯å£ï¼Œè¿™æ ·å°±å®ç°äº† 80 ç«¯å£åŒæ—¶è·‘ http å’Œ ssh ä¸¤ä¸ªæœåŠ¡ã€‚\n","date":"2021-11-10","img":"","permalink":"https://bajie.dev/posts/20211110-haproxy_multiple_port/","series":null,"tags":null,"title":"Haproxyä¸€ä¸ªç«¯å£è·‘å¤šä¸ªæœåŠ¡"},{"categories":null,"content":"Ucloudçš„æœºå™¨åœ¨ä¸¤ä¼šæœŸé—´å¹²è„†ç«¯å£å…¨ç­ï¼Œfirewallè®¾ç½®è¿›æ¥çš„ç«¯å£å…¨å…³é—­ï¼ï¼ï¼ï¼ï¼ï¼\nè¿˜å¥½æœ‰ä¸ªGlobal sshçš„æœåŠ¡ï¼Œå¯ä»¥ ssh ubuntu@111.129.37.89.ipssh.net ç™»å½•ä¸Šå»ï¼Œæ³¨æ„ï¼Œç›´æ¥ssh ubuntu@111.129.37.89 æ˜¯ä¸é€šçš„ã€‚\né‚£æˆ‘ä»¬å°±æ­å»ºä¸€ä¸ªSSLHæœåŠ¡ï¼Œå¯ä»¥æŠŠsshå’Œopenvpnä»¥åŠsslæœåŠ¡ç»Ÿç»Ÿå¡åˆ°ä¸€ä¸ªç«¯å£22é‡Œ\nåŠ¨æ‰‹å§\n1ã€ä¿®æ”¹opensshçš„ç«¯å£ ä»22ç«¯å£æ”¹æˆ2222ï¼Œåƒä¸‡åˆ«é‡å¯ï¼Œ22è¿™ä¼šå…ˆå¾—å½’sshç”¨\n2ã€å®‰è£…sslh\n1sudo apt install sslh 2vi /etc/default/sslh 3 4æ‰¾åˆ°Run=no 5æ”¹æˆRun=yes 6 7ç„¶ååˆ°ä¸‹é¢ï¼ŒæŒ‰éœ€é…ç½®ï¼ˆä¸è·‘443çš„è¯å¯ä»¥ä¸é…ï¼‰ 8DAEMON_OPTS=\u0026#34;--user sslh --listen 0.0.0.0:22 --ssh 127.0.0.1:2222 --ssl 127.0.0.1:443 --openvpn 127.0.0.1:1194 --pidfile /var/run/sslh/sslh.pid --timeout 5\u0026#34; 3ã€é…ç½®sslhå¹¶ä¸”é‡å¯æœåŠ¡å™¨\n1sudo systemctl enable sslh 2sudo reboot å°±æå®šäº†\n","date":"2021-11-10","img":"","permalink":"https://bajie.dev/posts/20211110-sslh_multiple_port/","series":null,"tags":null,"title":"Sslhçš„ä¸€ä¸ªç«¯å£åŒæ—¶è·‘å¤šä¸ªæœåŠ¡"},{"categories":null,"content":"è¿™ä¸ªè¦æ±‚æŒºå¤æ€ªçš„ï¼ŒèƒŒæ™¯æ˜¯é˜²ç«å¢™åªå¼€äº† nginx 443 ç«¯å£ã€‚æˆ‘ä¹Ÿæƒ³åŒæ—¶ ssh ç™»å½•è¿›å»ï¼Œä½†æ˜¯F5æ²¡å¼€IP\nå°±åªèƒ½è¿™ä¹ˆå¹²äº†ï¼Œè®© Nginx ä¸€ä¸ªç«¯å£è·‘å¤šä¸ªæœåŠ¡\nåœ¨ nginx.conf åŠ ä¸€æ®µï¼Œstream é…ç½®ï¼Œnginx çš„ ip æ˜¯ 192.168.8.110ï¼š\n1 2#Multi Ports 3stream { 4 upstream ssh { 5 server 192.168.8.112:22; 6 } 7 8 upstream https { 9 server 192.168.8.111:443; 10 } 11 12 map $ssl_preread_protocol $upstream { 13 default ssh; 14 \u0026#34;TLSv1.2\u0026#34; https; 15 \u0026#34;TLSv1.3\u0026#34; https; 16 \u0026#34;TLSv1.1\u0026#34; https; 17 \u0026#34;TLSv1.0\u0026#34; https; 18 } 19 20 # SSH and SSL on the same port 21 server { 22 listen 443; 23 24 proxy_pass $upstream; 25 ssl_preread on; 26 } 27} 28 æµ‹è¯•ä¸€ä¸‹ï¼š\n1curl -v https://192.168.8.110 2 3ssh 192.168.8.110 -p 443 4 è¿™æ ·å°±å¯ä»¥äº†ã€‚\n","date":"2021-11-09","img":"","permalink":"https://bajie.dev/posts/20211109-nginx_multiple_port/","series":null,"tags":null,"title":"Nginxçš„ä¸€ä¸ªç«¯å£åŒæ—¶è·‘SSHå’ŒHTTPSæœåŠ¡"},{"categories":null,"content":"kubernetes è£…å¥½æ­£å¸¸è¿è¡Œä¸€æ®µæ—¶é—´åï¼Œä¼šå‡ºç°è¦æŠŠç ”å‘å’Œè¿ç»´æƒé™åˆ†å¼€çš„åœºæ™¯ï¼š\næ¯”å¦‚ï¼š\n ç»™æŸä¸ªç”¨æˆ·æŸä¸€æŒ‡å®šåç§°ç©ºé—´ä¸‹çš„ç®¡ç†æƒé™ ç»™ç”¨æˆ·èµ‹äºˆé›†ç¾¤çš„åªè¯»æƒé™ â€¦  éå¸¸éº»çƒ¦ï¼Œæˆ‘ä»¬è¿™é‡Œä¸è®¨è®ºè¿‡å¤šçš„æ¦‚å¿µï¼Œä»è¿ç»´çš„è§’åº¦å‡ºå‘ï¼Œç®€å•å®ç”¨åŒ–\næˆ‘ä»¬éœ€è¦æ˜ç¡®ä¸‰ä¸ªRBACæœ€åŸºæœ¬çš„æ¦‚å¿µ\n Role: è§’è‰²ï¼Œå®ƒå®šä¹‰äº†ä¸€ç»„è§„åˆ™ï¼Œå®šä¹‰äº†ä¸€ç»„å¯¹Kubernetes APIå¯¹è±¡çš„æ“ä½œæƒé™ RoleBinding: å®šä¹‰äº†\u0026quot;è¢«ä½œç”¨è€…\u0026quot;å’Œ\u0026quot;è§’è‰²\u0026quot;çš„ç»‘å®šå…³ç³» Subject: è¢«ä½œç”¨è€…ï¼Œæ—¢å¯ä»¥æ˜¯\u0026quot;äºº\u0026quot;ï¼Œä¹Ÿå¯ä»¥æ˜¯æœºå™¨ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥æ˜¯ Kubernetes ä¸­å®šä¹‰çš„ç”¨æˆ·(ServiceAccountä¸»è¦è´Ÿè´£kuberneteså†…ç½®ç”¨æˆ·)  æˆ‘ä»¬çš„æ“ä½œè¿‡ç¨‹æµç¨‹å¦‚ä¸‹ï¼Œé¦–å…ˆåˆ›å»ºå®¢æˆ·ç«¯è¯ä¹¦ï¼›å…¶æ¬¡åˆ›å»ºRoleè§’è‰²ï¼›å†åˆ›å»ºRoleBindingï¼ŒæŠŠSubjectå’ŒRoleç»‘å®šï¼Œå°±å®Œäº‹äº†ï¼›æœ€åä¸€æ­¥æ˜¯ç”Ÿæˆ kubectl çš„é…ç½®æ–‡ä»¶ã€‚\nä¸€ã€åˆ›å»ºå®¢æˆ·ç«¯è¯ä¹¦ æˆ‘ä»¬ä»¥å·²å»ºå¥½çš„é˜¿é‡Œ ACK ä¸ºä¾‹ï¼Œæˆ–è€…è‡ªå»ºå¥½çš„ Kubernetes ä¹Ÿè¡Œï¼›ç¡®å®šå·²ç»æœ‰äº† .kube/config é…ç½®æ–‡ä»¶ï¼Œæ‹¥æœ‰é›†ç¾¤æœ€é«˜æƒé™ï¼Œå¹¶ä¸”å¯ä»¥æ­£å¸¸æ‰§è¡Œ kubectl å‘½ä»¤ã€‚\né¦–å…ˆæ˜¯ç”Ÿæˆè¯ä¹¦ï¼Œå¹¶å‘é›†ç¾¤æå‡ºè¯ä¹¦è¯·æ±‚å¹¶ç­¾å‘ï¼Œè„šæœ¬å¦‚ä¸‹ï¼š\n1#!/bin/sh 2 3useraccount=reader 4 5openssl req -new -newkey rsa:4096 -nodes -keyout $useraccount-k8s.key -out $useraccount-k8s.csr -subj \u0026#34;/CN=$useraccount/O=devops\u0026#34; 6csr=$(cat $useraccount-k8s.csr | base64 | tr -d \u0026#39;\\n\u0026#39;) 7cat \u0026lt;\u0026lt; EOF \u0026gt; k8s-csr.yaml 8apiVersion: certificates.k8s.io/v1beta1 9kind: CertificateSigningRequest 10metadata: 11name: $useraccount-k8s-access 12spec: 13groups: 14- system:authenticated 15request: $csr 16usages: 17- client auth 18EOF 19 20 21kubectl create -f k8s-csr.yaml 22kubectl certificate approve $useraccount-k8s-access 23 24kubectl get csr $useraccount-k8s-access -o jsonpath=\u0026#39;{.status.certificate}\u0026#39; | base64 --decode \u0026gt; $useraccount-k8s-access.crt 25kubectl config view -o jsonpath=\u0026#39;{.clusters[0].cluster.certificate-authority-data}\u0026#39; --raw | base64 --decode - \u0026gt; k8s-ca.crt è§£é‡Šä¸€ä¸‹ï¼šæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªç”¨æˆ·CN=readerï¼Œç„¶åå‘é›†ç¾¤å‘é€äº†è¯ä¹¦è¯·æ±‚å¹¶ç­¾å‘ï¼Œæœ€ç»ˆä»é›†ç¾¤è·å¾—äº† reader-k8s-access.crt çš„å®¢æˆ·ç«¯è¯ä¹¦å’Œ k8s-ca.crt çš„ CA è¯ä¹¦ã€‚\nk8s-csr.yaml å’Œ reader-k8s.csr éƒ½æ˜¯ä¸­é—´äº§ç‰©ï¼Œæœ€ç»ˆæˆ‘ä»¬æœ‰äº†å®¢æˆ·ç«¯ç§é’¥ reader-k8s.key ï¼Œå®¢æˆ·ç«¯è¯ä¹¦ reader-k8s-access.crt ï¼ŒCA è¯ä¹¦ k8s-ca.crt è¿™ä¸‰ä¸ªæœ‰ç”¨çš„æ–‡ä»¶ã€‚\näºŒã€åˆ›å»º Role è§’è‰² 1cat \u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; role.yaml 2apiVersion: rbac.authorization.k8s.io/v1 3kind: Role 4metadata: 5name: role-pods_reader 6namespace: default 7rules: 8- apiGroups: 9- \u0026#34;\u0026#34; 10resources: 11- pods 12- pods/log 13verbs: 14- get 15- list 16- watch 17EOF 18 19kubectl apply -f role.yaml è§£é‡Šï¼šæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª role è§’è‰²ï¼Œåå­—å«åš role-pods_readerï¼Œæ‰€å±å‘½åç©ºé—´æ˜¯ default ï¼Œå®ƒå¯¹ pods å’Œ pods/log æœ‰ get ã€listã€watchçš„æƒé™ï¼Œä¹Ÿå°±æ˜¯è¯´role-pods_reader å¯ä»¥æŸ¥çœ‹ default ç©ºé—´çš„ pods å’Œ pods çš„æ—¥å¿—ã€‚\nä¸‰ã€åˆ›å»º Rolebinding 1cat \u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; rolebinding.yaml 2apiVersion: rbac.authorization.k8s.io/v1 3kind: RoleBinding 4metadata: 5name: rolebinding-default_pods_reader 6namespace: default 7roleRef: 8apiGroup: rbac.authorization.k8s.io 9kind: Role 10name: role-pods_reader 11subjects: 12- apiGroup: rbac.authorization.k8s.io 13kind: User 14name: reader 15EOF 16 17kubectl apply -f rolebinding.yaml è§£é‡Šï¼šæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª rolebindingï¼Œåå­—å«åš rolebinding-default_pods_readerï¼ŒåŒæ ·æ‰€å±å‘½åç©ºé—´æ˜¯ defaultï¼Œå®ƒç»‘äº†ä¸¤ä¸ªä¸œè¥¿ï¼Œä¸€ä¸ªæ˜¯ roleï¼Œå°±æ˜¯ä¸Šé¢ç¬¬äºŒæ­¥åˆ›å»ºçš„ role-pods_readerï¼›å¦ä¸€ä¸ªæ˜¯ subjectï¼Œå¯¹åº”äº†ä¸€ä¸ªç”¨æˆ·ï¼Œå°±æ˜¯æˆ‘ä»¬ç¬¬ä¸€æ­¥åˆ›å»ºçš„é‚£ä¸ª readerã€‚\nå››ã€ç”Ÿæˆ kubectl é…ç½®æ–‡ä»¶ 1#!/bin/sh 2useraccount=reader 3namespace=default 4 5kubectl config set-cluster $(kubectl config view -o jsonpath=\u0026#39;{.clusters[0].name}\u0026#39;) --server=$(kubectl config view -o jsonpath=\u0026#39;{.clusters[0].cluster.server}\u0026#39;) --certificate-authority=k8s-ca.crt --embed-certs --kubeconfig=$useraccount-k8s-config 6 7kubectl config set-credentials $useraccount --client-certificate=$useraccount-k8s-access.crt --client-key=$useraccount-k8s.key --embed-certs --kubeconfig=$useraccount-k8s-config 8 9kubectl config set-context $useraccount --cluster=$(kubectl config view -o jsonpath=\u0026#39;{.clusters[0].name}\u0026#39;) --namespace=$namespace --user=$useraccount --kubeconfig=$useraccount-k8s-config 10 11kubectl config use-context $useraccount --kubeconfig=$useraccount-k8s-config è§£é‡Šï¼šä¸Šé¢çœ‹èµ·æ¥å¾ˆå¤æ‚ï¼Œå…¶å®å°±æ˜¯å››æ­¥ï¼Œåœ¨é…ç½®æ–‡ä»¶é‡Œè®¾ç½® cluster ã€è®¾ç½® credentials è¯ä¹¦ã€è®¾ç½® context ä¸Šä¸‹æ–‡ã€è®¾ç½®å½“å‰ä¸Šä¸‹æ–‡ã€‚\nå®Œäº‹åä¼šäº§ç”Ÿä¸€ä¸ªå®Œæ•´çš„ reader-k8s-config æ–‡ä»¶ï¼Œå¦‚ä¸‹ï¼š\näº”ã€æµ‹è¯• æˆ‘ä»¬éªŒè¯ä¸€ä¸‹ï¼š\n1KUBECONFIG=reader-k8s-config kubectl get pods 2 3KUBECONFIG=reader-k8s-config kubectl auth can-i delete pods 4 5KUBECONFIG=reader-k8s-config kubectl auth can-i delete svc 6 è¿™æ ·ä¸€ä¸ªå¯¹ default ç©ºé—´çš„åªè¯»ç”¨æˆ·å°±å»ºç«‹å¥½äº†\nå…­ã€é›†ç¾¤åªè¯»ç”¨æˆ· æˆ‘ä»¬è¿™é‡Œç»™å‡ºé›†ç¾¤åªè¯»ç”¨æˆ·çš„ roleï¼Œå‘½å role-cluster_reader\n1kubectl apply -f - \u0026lt;\u0026lt;EOF 2apiVersion: rbac.authorization.k8s.io/v1 3kind: ClusterRole 4metadata: 5name: role-cluster_reader 6rules: 7- apiGroups: 8- \u0026#34;\u0026#34; 9resources: 10- nodes 11- pods 12- pods/exec 13- pods/log 14- services 15- configmaps 16- secrets 17- serviceaccounts 18- endpoints 19verbs: 20- get 21- list 22- watch 23- apiGroups: 24- apps 25resources: 26- deployments 27- replicasets 28- daemonsets 29- statefulsets 30verbs: 31- get 32- list 33- watch 34- apiGroups: 35- batch 36resources: 37- jobs 38- cronjobs 39verbs: 40- get 41- list 42- watch 43EOF ä»¥åŠ rolebindingï¼Œè¿˜æ˜¯ç»‘åˆ°ç¬¬ä¸€æ­¥çš„ç”¨æˆ· reader çš„ä¾‹å­\n1kubectl apply -f - \u0026lt;\u0026lt;EOF 2apiVersion: rbac.authorization.k8s.io/v1 3kind: ClusterRoleBinding 4metadata: 5name: rolebinding-cluster_reader 6roleRef: 7apiGroup: rbac.authorization.k8s.io 8kind: ClusterRole 9name: role-cluster_reader 10subjects: 11- apiGroup: rbac.authorization.k8s.io 12kind: User 13name: reader 14EOF ç”Ÿæˆé…ç½®æ–‡ä»¶çš„æ­¥éª¤è·Ÿä¸Šä¸€æ­¥æ˜¯ä¸€æ ·çš„ã€‚\nä»ä¸Šé¢å¤§å®¶å¯ä»¥çœ‹åˆ°ï¼Œå…¶å®æœ€ä¸»è¦çš„å°±æ˜¯ role çš„ yaml æ–‡ä»¶ï¼Œé‡Œé¢æ§åˆ¶ç€åˆ°åº•æœ‰æ€ä¹ˆæ ·çš„æƒé™ã€‚\n","date":"2021-11-09","img":"","permalink":"https://bajie.dev/posts/20211109-k8s_rbac/","series":null,"tags":null,"title":"Kubernetesåˆ›å»ºæ™®é€šè´¦å·"},{"categories":null,"content":"æ²¡å•ŠåŠæ³•ï¼Œç¿»å¢™ç¿»å¢™è¿˜æ˜¯ç¿»å¢™ã€‚\nä¸Šæ¸¸æœ‰è‹¥å¹² trojian ã€v2ray ã€sock5 ã€httpå„ç§å„æ ·çš„ä»£ç†ï¼Œè¿™æ ·å¤šç§çš„é€‰æ‹©ï¼Œé‚£ä¹ˆå°±è£…ä¸€ä¸ª clash å®¢æˆ·ç«¯å°±å¯ä»¥å…¨æ¥ç®¡äº†ã€‚\nè¯´ä¸‹æˆ‘ä»¬çš„åšæ³•ï¼šæ‰¾ä¸ªå°Linuxåšæ—è·¯ç”±ï¼ŒDNSå’Œç½‘å…³éƒ½è®¾ç½®åœ¨è¿™å°æœºå™¨ä¸Šï¼Œå±€åŸŸç½‘å†…çš„æœºå™¨éƒ½é€šè¿‡è¿™å°ä¸Šç½‘ã€‚\næˆ‘ä»¬ç”¨åˆ°çš„æ˜¯ clash çš„ Tproxy redir-host å’Œ udp-proxy æ¨¡å¼ï¼Œè¿™ç§æ¨¡å¼æ¯”è¾ƒå¼ºå¤§ã€‚ç”¨å°±ç”¨æœ€å¼ºå¤§çš„ã€‚\nå®‰è£…å¾ˆç®€å•ï¼Œæ“ä½œç³»ç»Ÿ centos æˆ–è€… ubuntu éƒ½è¡Œï¼Œé¡¹ç›®åœ°å€ï¼š\nhttps://github.com/Dreamacro/clash è¯´æ˜ä¹¦ï¼š\nhttps://lancellc.gitbook.io/clash/clash-config-file/proxy-groups/load-balance é¦–å…ˆä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œç°åœ¨ç‰ˆæœ¬æ˜¯ v1.7.1ï¼Œè§£å‹åæ”¾åˆ° /usr/local/bin ç›®å½•ä¸‹\n1wget https://github.com/Dreamacro/clash/releases/download/v1.7.1/clash-linux-amd64-v1.7.1.gz 2gzip -d clash-linux-amd64-v1.7.1.gz 3chmod 755 clash-linux-amd64-v1.7.1 4mv clash-linux-amd64-v1.7.1 /usr/local/bin ç„¶åç”Ÿæˆ clash.service\n1cat \u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; /etc/systemd/system/clash.service 2[Unit] 3Description=clash service 4After=network.target 56[Service] 7Type=simple 8User=root 9ExecStart=/usr/local/bin/clash-linux-amd64-v1.7.1 10Restart=on-failure # or always, on-abort, etc 1112[Install] 13WantedBy=multi-user.target 14EOF ç„¶åæœ€é‡è¦çš„ï¼Œå°±æ˜¯é…ç½®æ–‡ä»¶äº†\næˆ‘è¿™é‡Œè¿™ä¸ªæ—è·¯ç”±çš„è®¾å¤‡ IP åœ°å€æ˜¯ 192.168.2.2ï¼Œç½‘å¡è®¾å¤‡æ˜¯ enp2s0\nä¸‹å–å¼„\n1# httpçš„ä»£ç†ç«¯å£ 2port: 7890 3#mixed-port: 7890 4socks-port: 7891 5redir-port: 7892 6tproxy-port: 7893 7 8ipv6: false 9 10allow-lan: true 11bind-address: \u0026#39;192.168.2.2\u0026#39; 12interface-name: enp2s0 13 14mode: rule 15log-level: info 16external-controller: 0.0.0.0:9090 17secret: \u0026#34;Fuck2021\u0026#34; 18external-ui: dashboard 19 20profile: 21 store-selected: false 22 tracing: true 23 24 25hosts: 26 # æŠŠcantvçš„åŸŸåè§£æå±è”½æ‰ï¼Œç¦æ­¢å®ƒè‡ªåŠ¨å‡çº§ 27 \u0026#39;tms.can.cibntv.net\u0026#39;: 0.0.0.0 28 29dns: 30 enable: true 31 listen: 0.0.0.0:1053 32 enhanced-mode: redir-host # or fake-ip 33 nameserver: 34 - \u0026#39;114.114.114.114\u0026#39; 35 - \u0026#39;223.5.5.5\u0026#39; 36 fallback: 37 - 208.67.220.220:5353 38 - 208.67.222.222:5353 39 - 101.6.6.6:5353 40 41proxies: 42 - name: \u0026#34;trojan1\u0026#34; 43 type: trojan 44 server: www.linuxboy.net 45 port: 443 46 password: Fuck2021 47 sni: www.linuxboy.net 48 skip-cert-verify: true 49 50 - name: \u0026#34;vmess1\u0026#34; 51 type: vmess 52 server: 101.59.201.93 53 port: 41555 54 uuid: 7a17ae5e-fb86-42e2-abd4-b8c33cfabcd 55 alterId: 64 56 cipher: auto 57 58proxy-groups: 59 - name: Proxy 60 type: select 61 proxies: 62 - trojan 63 64 - name: \u0026#34;auto\u0026#34; 65 type: url-test 66 proxies: 67 - vmess1 68 - trojan1 69 url: \u0026#39;http://www.gstatic.com/generate_204\u0026#39; 70 interval: 300 71 72rules: 73 - DOMAIN-SUFFIX,v2ex.com,Proxy 74 - DOMAIN-SUFFIX,t66y.com,Proxy 75 - DOMAIN-SUFFIX,ycombinator.com,Proxy 76 - DOMAIN-SUFFIX,reddit.com,Proxy 77 - DOMAIN-KEYWORD,amazon,Proxy 78 - DOMAIN-KEYWORD,google,Proxy 79 - DOMAIN-KEYWORD,gmail,Proxy 80 - DOMAIN-KEYWORD,youtube,Proxy 81 - DOMAIN-KEYWORD,facebook,Proxy 82 - DOMAIN-SUFFIX,fb.me,Proxy 83 - DOMAIN-SUFFIX,fbcdn.net,Proxy 84 - DOMAIN-KEYWORD,twitter,Proxy 85 - DOMAIN-KEYWORD,instagram,Proxy 86 - DOMAIN-KEYWORD,dropbox,Proxy 87 - DOMAIN-SUFFIX,twimg.com,Proxy 88 - DOMAIN-KEYWORD,blogspot,Proxy 89 - DOMAIN-SUFFIX,youtu.be,Proxy 90 - DOMAIN-KEYWORD,whatsapp,Proxy 91 - SRC-IP-CIDR,192.168.1.0/32,DIRECT 92 - SRC-IP-CIDR,192.168.2.0/32,DIRECT 93 - IP-CIDR,127.0.0.0/8,DIRECT 94 - GEOIP,CN,DIRECT 95 - MATCH,Proxy è§£é‡Šä¸€ä¸‹ï¼šproxy å®šä¹‰äº†ä¸¤ä¸ªä»£ç†ï¼Œä¸€ä¸ªæ˜¯ trojanï¼Œä¸€ä¸ªæ˜¯ v2rayã€‚ç„¶åå†é›†åˆæˆç»„ï¼Œä¸€ä¸ªç»„å« Proxyï¼Œ æ˜¾å¼æŒ‡å®šç”¨ trojanï¼›å¦ä¸€ä¸ªç»„å« autoï¼Œæ ¹æ® vmess1 å’Œ trojan1 è®¿é—® http://www.gstatic.com/generate_204 çš„é¡µé¢é€Ÿåº¦ï¼Œè°å¿«å°±ç”¨è°ï¼Œç¼ºçœ300ç§’ä¼šè®¿é—®ä¸€æ¬¡è¿™ä¸ªé¡µé¢æ¥å†³å®šå“ªä¸ªä»£ç†å¿«ã€‚\nå‰©ä¸‹çš„ rules å°±å¾ˆç®€å•ï¼ŒæŠŠè‡ªå·±çŸ¥é“è¦è®¿é—®çš„åŸŸåæ”¾åˆ°ä»£ç†ä¸­å»ï¼Œç„¶åæŠŠå±€åŸŸç½‘çš„ IP æ®µæ”¾è¿› DIRECT ç›´æ¥è®¿é—®ï¼Œæœ€å GEO IP ä¸æ˜¯ä¸­å›½çš„ç”± Proxy å…œåº•ã€‚\nç½‘ä¸Šæœ‰ä¸€å¤§å †è§„åˆ™ï¼Œå…«æˆ’çš„å»ºè®®æ˜¯ä¸è¦å»å­¦ï¼Œè§„åˆ™è¶Šå¤šè¶Šæ…¢ï¼Œä½ è‡ªå·±çŸ¥é“è¦è®¿é—®ä»€ä¹ˆç½‘ç«™éœ€è¦ç¿»å¢™ï¼ŒåŠ è¿›å»å°±å¥½äº†ã€‚å¼„ä¸€å †ï¼Œè‡ªå·±çœ‹ç€éƒ½å¤´è’™\næœ€åæˆ‘ä»¬åœ¨ rc.local æ”¾å…¥ä»¥ä¸‹ iptable å†…å®¹ï¼Œå°±å¯ä»¥äº†\n1### 2#clash 3ip rule add fwmark 1 table 100 4ip route add local 0.0.0.0/0 dev lo table 100 5 6# CREATE TABLE 7iptables -t mangle -N clash 8 9# RETURN LOCAL AND LANS 10iptables -t mangle -A clash -d 0.0.0.0/8 -j RETURN 11iptables -t mangle -A clash -d 10.0.0.0/8 -j RETURN 12iptables -t mangle -A clash -d 100.64.0.0/10 -j RETURN 13iptables -t mangle -A clash -d 127.0.0.0/8 -j RETURN 14iptables -t mangle -A clash -d 169.254.0.0/16 -j RETURN 15iptables -t mangle -A clash -d 172.16.0.0/12 -j RETURN 16iptables -t mangle -A clash -d 192.168.0.0/16 -j RETURN 17iptables -t mangle -A clash -d 224.0.0.0/4 -j RETURN 18iptables -t mangle -A clash -d 240.0.0.0/4 -j RETURN 19 20# whitelist China ip. 21# iptables -t mangle -A clash -m set --match-set china dst -j RETURN 22 23# FORWARD ALL 24iptables -t mangle -A clash -p udp -j TPROXY --on-port 7893 --tproxy-mark 1 25iptables -t mangle -A clash -p tcp -j TPROXY --on-port 7893 --tproxy-mark 1 26 27# REDIRECT 28iptables -t mangle -A PREROUTING -j clash 29 30# hijack DNS to Clash 31iptables -t nat -N CLASH_DNS 32iptables -t nat -F CLASH_DNS 33iptables -t nat -A CLASH_DNS -p udp -j REDIRECT --to-port 1053 34iptables -t nat -I PREROUTING -p udp --dport 53 -j CLASH_DNS 35 æœ€åå¯åŠ¨clash\n1systemctl start clash ","date":"2021-11-08","img":"","permalink":"https://bajie.dev/posts/20211108-clash/","series":null,"tags":null,"title":"Clashçš„æ­å»ºæ•™ç¨‹"},{"categories":null,"content":"ä¸Šç¯‡ç®€å•ä»‹ç»äº† onedev ï¼Œè¿™ç¯‡æˆ‘ä»¬å…·ä½“æ‹¿ä¸ª java spring çš„é¡¹ç›®æ¥å®é™…ç¼–è¯‘ä¸€ä¸‹\né¦–å…ˆå¿…é¡»ç¡®è®¤ç¯å¢ƒï¼š\nonedev å’Œ agent éƒ½æ˜¯ç”¨ root å®‰è£…è¿è¡Œçš„ï¼Œç„¶åå·²ç»å®‰è£…äº† dockerï¼Œä¸” selinux è®¾ç½®ä¸º disabledï¼Œå¦åˆ™ä¼šå‡ºæƒé™éº»çƒ¦ã€‚\næˆ‘ä»¬ç”¨çš„ä¾‹å­æ˜¯ spring çš„ petclinicï¼Œæ­£å¸¸çš„ build çš„æ­¥éª¤å¦‚ä¸‹ï¼š\n1git clone https://github.com/spring-projects/spring-petclinic.git 2cd spring-petclinic 3./mvnw package æˆ‘ä»¬é¦–å…ˆåœ¨ onedev çš„ projects æ–°å»ºä¸€ä¸ªé¡¹ç›® spring-boot\nç„¶ååˆ° clone ä¸‹æ¥çš„æºä»£ç ç›®å½•ä¸‹\n1cd spring-petclinic 2 3git init 4git add . 5git commit -m \u0026#34;Spring boot demo project\u0026#34; 6 7git remote add origin http://192.168.86.101:6610/spring-boot 8git push --set-upstream origin master è¿™æ ·å°±å¯ä»¥åœ¨ spring-boot é‡Œçœ‹åˆ°ä»£ç äº†\nç„¶åçœ‹ä¸Šå›¾ï¼Œæœ‰ä¸ªç´«è‰²ç¯æ³¡ï¼ŒEnable build support by adding.onedev-buildspec.ymlï¼Œç‚¹é‚£ä¸ªé“¾æ¥\næˆ‘ä»¬å¢åŠ ä¸€ä¸ª build çš„æ­¥éª¤ï¼Œé‡Œé¢å†å¢åŠ ä¸¤ä¸ª jobï¼Œä¸€ä¸ªæ˜¯ Get code ï¼Œä¸€ä¸ªæ˜¯ build\nç¬¬ä¸€æ­¥è‚¯å®šæ˜¯æŠŠä»£ç æ‹¿ä¸‹æ¥ï¼Œé€‰æ‹© Checkout Code ï¼Œå‘½åä¸º Get code ï¼Œç„¶åå…¶ä»–ä¿æŒç¼ºçœé…ç½®ï¼Œä¿å­˜\nç¬¬äºŒæ­¥å°±æ˜¯ build ä»£ç ï¼Œé€‰æ‹© Execute Shell/Batch Commandsï¼Œç„¶åå®é™…æ˜¯å¯åŠ¨äº†ä¸€ä¸ª docker é•œåƒæ¥æ‰§è¡Œ build çš„è¿‡ç¨‹\n  Image å¡«å…¥ï¼šmaven:3.5-jdk-8-alphine\n  Commands å¡«å…¥ï¼š\n1unset MAVEN_CONFIG 2cat \u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; /root/.m2/settings.xml 3\u0026lt;settings\u0026gt; 4\u0026lt;proxies\u0026gt; 5\u0026lt;proxy\u0026gt; 6\u0026lt;id\u0026gt;default\u0026lt;/id\u0026gt; 7\u0026lt;active\u0026gt;true\u0026lt;/active\u0026gt; 8\u0026lt;protocol\u0026gt;http\u0026lt;/protocol\u0026gt; 9\u0026lt;host\u0026gt;192.168.1.10\u0026lt;/host\u0026gt; 10\u0026lt;port\u0026gt;3128\u0026lt;/port\u0026gt; 11\u0026lt;/proxy\u0026gt; 12\u0026lt;/proxies\u0026gt; 13\u0026lt;/settings\u0026gt; 14EOF 15./mvnw package è§£é‡Šä¸€ä¸‹ï¼Œmaven:3.5-jdk-8-alphine è¿™ä¸ªé•œåƒï¼Œå¦‚æœåœ¨é‡Œé¢æ‰§è¡Œ mvnw package ï¼Œä¼šæŠ¥é”™ repository çš„é”™ï¼Œæ‰€ä»¥å¿…é¡»æŠŠ MAVEN_CONFIG çš„ç¯å¢ƒå˜é‡ç»™åˆ é™¤ï¼Œå¦å¤–æ•´ä¸ª build è¿‡ç¨‹ä¼šå»æ‹‰ N å¤šåŒ…å’Œé…ç½®ï¼Œå¤§æ¦‚200å¤šå…†ï¼Œå¦‚æœä¸ç¿»å¢™ï¼ŒåŸºæœ¬æ˜¯å¤±è´¥ã€‚æ‰€ä»¥è¿™é‡Œå¼ºåˆ¶ mvn ä½¿ç”¨äº†ä»£ç†ï¼ï¼ï¼å¦åˆ™ build ä¸€å¤©éƒ½ä¸ä¼šæˆåŠŸã€‚\n  ç¬¬ä¸‰æ­¥æ˜¯é…ç½® mvn repositoryçš„ç¼“å­˜ï¼Œå¤§å®¶ä¸æƒ³æ¯æ¬¡buildéƒ½å»ä¸‹ä¸€éä¾èµ–åŒ…å§ï¼Œåœ¨ More Settings è®¾ç½®\nåœ¨Cachesé‡Œå¡«å…¥ï¼š\n  key: maven-cache\n  path: /root/.m2/repository\n  ç„¶åæ‰§è¡Œ Build , ç„¶åç­‰å¾…ï¼Œç¬¬ä¸€æ¬¡æ—¶é—´ä¼šå¾ˆé•¿ï¼Œç»ˆäº Successful äº†\næ¥ä¸‹æ¥çš„æ­¥éª¤å°±å¯ä»¥ç”¨ Dockerfile ç”Ÿæˆé•œåƒï¼Œç„¶åæ¨åˆ° Harborï¼Œå†ä¸‹è½½æˆ–è€… gitopsä¸‹è½½æ¥å„ç§ yaml æ–‡ä»¶ï¼Œæ‹‰ kubectl å’Œé…ç½®æ–‡ä»¶ï¼Œå°±å¯ä»¥æ¨é€åˆ° kubernetes äº†ã€‚\nè¡¥å……ä¸€ä¸‹ï¼Œåœ¨åˆ«çš„åœ°æ–¹çªç„¶çœ‹åˆ°æœ‰ maven çš„é˜¿é‡Œé•œåƒåœ°å€ï¼Œè®°å½•ä¸€ä¸‹ï¼š\n1 \u0026lt;mirror\u0026gt; 2 \u0026lt;id\u0026gt;alimaven\u0026lt;/id\u0026gt; 3 \u0026lt;name\u0026gt;aliyun maven\u0026lt;/name\u0026gt; 4 \u0026lt;url\u0026gt;http://maven.aliyun.com/nexus/content/groups/public/\u0026lt;/url\u0026gt; 5 \u0026lt;mirrorOf\u0026gt;*\u0026lt;/mirrorOf\u0026gt; 6 \u0026lt;/mirror\u0026gt; ","date":"2021-11-08","img":"","permalink":"https://bajie.dev/posts/20211108-onedev_maven/","series":null,"tags":null,"title":"Onedevæ„å»ºä¸€ä¸ªå®é™…java Springåº”ç”¨"},{"categories":null,"content":"vpnçš„æ­å»ºä¸€ç›´æ˜¯ä¸€ä¸ªéš¾è§£çš„é¢˜ç›®ï¼Œopenvpnã€ipsecã€tinc éƒ½åœ¨ç”¨ï¼Œéƒ½ä¸å¤Ÿç®€æ´ã€‚\nn2n æ˜¯ä¸€ç§ peer to peer ç«¯åˆ°ç«¯çš„ vpnï¼Œæ­å»ºèµ·æ¥éå¸¸ç®€å•æ–¹ä¾¿ã€‚å¿…å¤‡åˆ©å™¨\né¦–å…ˆäº†è§£ä¸€ä¸‹æ¦‚å¿µ\nn2n çš„ vpn åˆ†ä¸ºä¸¤ç§è§’è‰²ï¼ŒSupernode è¶…çº§èŠ‚ç‚¹å’Œ Edgenode è¾¹ç¼˜èŠ‚ç‚¹ã€‚\nå¾ˆç®€å•ï¼ŒSupernode æœ€å¥½æ˜¯å…¬ç½‘åœ°å€ï¼Œéœ€è¦å¼€æ”¾ç«¯å£ä¾›å…¶å®ƒèŠ‚ç‚¹è¿æ¥ä¸Šæ¥ï¼›å‰©ä½™çš„ Edgenode å¯ä»¥æ²¡æœ‰å…¬ç½‘åœ°å€ï¼Œå„ä¸ª Edgenode è¾¹ç¼˜èŠ‚ç‚¹ä¹‹é—´ä¼šå°è¯•ç»•è¿‡ Supernode ç›´æ¥è¿æ¥ã€‚è¿™å¤§å¤§æé«˜äº†èŠ‚ç‚¹ä¹‹é—´é€šè®¯çš„æ•ˆç‡ã€‚é€šè®¯æ˜¯åŠ å¯†çš„ï¼Œéå¸¸å®‰å…¨ã€‚\nå®‰è£…çš„è¯å®Œå…¨ä¸ç”¨å®‰è£…ï¼Œç›´æ¥ä¸€ä¸ªå‘½ä»¤å°±æå®šäº†ã€‚\nhttps://github.com/ntop/n2n å¼„å‡ºä¸¤ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ supernode å’Œ edge å°±å¥½äº†\nè¶…çº§èŠ‚ç‚¹ï¼š\n1/usr/local/bin/supernode -p 11111 -v è¾¹ç¼˜èŠ‚ç‚¹ï¼š\n1/usr/local/bin/edge -d n2n0 -c ThisisaSecret2012 -k Fuck2020 -a 192.168.0.2 -l 41.22.59.112:11111 -f å‚æ•°è§£é‡Šï¼š\n -d ç”Ÿæˆçš„è™šæ‹Ÿç½‘å¡çš„å‘½å -c æŸç»„vpnèŠ‚ç‚¹çš„å£ä»¤ã€‚å¤§å®¶çœ‹åˆ°å¯åŠ¨ supernode çš„æ—¶å€™æ²¡æœ‰ä»»ä½•å‚æ•°ï¼Œsupdernode åªè´Ÿè´£è½¬å‘ã€‚supernode æ”¯æŒå¤šç»„ä¸åŒçš„ vpnã€‚è¿™é‡Œå°±æ˜¯ç”¨æ¥åŒºåˆ†ä¸åŒçš„ vpn ç»„çš„ã€‚ -k èŠ‚ç‚¹ä¹‹é—´é€šè®¯æ˜¯ç”¨çš„ twofish åŠ å¯†ç®—æ³•ï¼Œè¿™é‡ŒæŒ‡å®šçš„æ˜¯å¯†é’¥ -a èŠ‚ç‚¹çš„ip -l supernodeçš„ipå’Œç«¯å£ -f æ”¾åˆ°åå° daemon æ‰§è¡Œ  è¿™æ ·å°±å»ºç«‹å¥½äº†ï¼Œç³»ç»Ÿä¸­ä¼šå¤šå‡ºä¸€å¼  n2n0 çš„ç½‘å¡ã€‚\n","date":"2021-11-05","img":"","permalink":"https://bajie.dev/posts/20211105-n2n_vpn/","series":null,"tags":null,"title":"N2nä¸€ç§peer to Peerçš„VPNçš„ä½¿ç”¨"},{"categories":null,"content":"å…¶å®ä¸€ç›´åœ¨ç”¨ githubã€gitlabã€jenkinsï¼Œä½†æ˜¯ github æ—¶ä¸æ—¶çš„æŠ½é£ï¼Œ gitlab çš„ runner å¥— Docker in docker çš„æ–¹æ³•å§”å®å¾ˆéš¾ç”¨ã€‚\næ‰€ä»¥ CI/CD è¿™ä¸€å—åå€’æŒºå–œæ¬¢é˜¿é‡Œäº‘æ•ˆè¿™ç§ç®€ä¾¿æ˜“è¡Œçš„ã€‚ä½†ç¡®å®æ‰¾ä¸åˆ°å…¶ä»–åˆé€‚ä¸”ç±»ä¼¼çš„è½¯ä»¶ã€‚\nä» V2EX ä¸Šçœ‹åˆ°ä¸€ä¸ªè€å“¥å‘çš„ onedevï¼Œæ˜¯ä¸€ä¸ªä¸€ç«™å¼çš„å¼€æºè½¯ä»¶ï¼Œè¿™ä¸å°±è¯•è¯•å…ˆ\nä»¥ centos7 ä¸ºä¾‹ï¼Œå®‰è£…è¿‡ç¨‹å¦‚ä¸‹ï¼š\nä¸€ã€å®‰è£… java 1.8 ç‰ˆæœ¬ 1rpm -ivh jdk-8u201-linux-x64.rpm äºŒã€å®‰è£… git é«˜ç‰ˆæœ¬ ç¼ºçœ centos7 å’Œ epel å¸¦çš„ git ç‰ˆæœ¬å¤ªä½ï¼Œä¸ç¬¦åˆè¦æ±‚ï¼Œå¾—åŠ ä¸ªæ–°çš„æºè£…æ–°ç‰ˆæœ¬\n1yum -y install https://packages.endpoint.com/rhel/7/os/x86_64/endpoint-repo-1.7-1.x86_64.rpm 2yum -y install git curl ä¸‰ã€å®‰è£…é…ç½® onedev https://github.com/theonedev/onedev ä¸‹è½½å‹ç¼©åŒ…ï¼Œç„¶åè§£å‹è¿è¡Œ bin/server.sh start ï¼Œå¾ˆç®€æ´ï¼Œä¸é”™ï¼\nè¿è¡Œå®Œæ‰“å¼€ http://192.168.86.101:6610 è¿›è¡Œåˆå§‹é…ç½®ï¼Œå°±ä¸¤æ­¥å°± ok äº†ã€‚\nä¸‰ã€ä¾‹å­ æˆ‘ä»¬æ˜¯è¦åœ¨æ­£å¼ç”Ÿäº§ç¯å¢ƒç”¨çš„ï¼Œæ‰€ä»¥åœ¨ projects æ–°å»ºä¸€ä¸ªé¡¹ç›® spring-bootï¼Œä»¥ spring-petclinic ä¸ºä¾‹ï¼š\nç„¶ååˆ°æºä»£ç ç›®å½•ä¸‹\n1git clone https://github.com/spring-projects/spring-petclinic.git 2cd spring-petclinic 3./mvnw package 4 5cd spring-petclinic 6 7git init 8git add . 9git commit -m \u0026#34;Spring boot demo project\u0026#34; 10 11git remote add origin http://192.168.86.101:6610/spring-boot 12git push --set-upstream origin master è¿™æ ·å°±å¯ä»¥åœ¨ spring-boot é‡Œçœ‹åˆ°ä»£ç äº†\nç„¶åçœ‹ä¸Šå›¾ï¼Œæœ‰ä¸ªç´«è‰²ç¯æ³¡ï¼ŒEnable build support by adding.onedev-buildspec.ymlï¼Œç‚¹é‚£ä¸ªé“¾æ¥å°±å¯ä»¥è¿›å…¥ä¸€ç³»åˆ— build ã€pushã€deploy çš„ pipeline äº†ã€‚\nå‹æƒ…æç¤ºï¼Œå•æœºçš„è¯ï¼Œæœºå™¨éœ€è¦è£… onedev çš„ agentï¼Œç„¶åè¿˜æœ‰ dockerï¼Œå°±å¯ä»¥buildäº†ã€‚ç”¨èµ·æ¥æ„Ÿè§‰è·Ÿäº‘æ•ˆå·®ä¸å¤šï¼Œå¾ˆä¸é”™ã€‚\n","date":"2021-11-05","img":"","permalink":"https://bajie.dev/posts/20211105-onedev/","series":null,"tags":null,"title":"ä¸€ç«™å¼Gitè½¯ä»¶onedevçš„å®‰è£…ä½¿ç”¨"},{"categories":null,"content":"Nginx å¯ä»¥ç”¨ kill -HUP æ¥é‡å¯ï¼Œä¸ä¼šä¸¢å¤±å·²å»ºè¿æ¥ã€‚Haproxy å¦‚ä½•åšæ‰èƒ½åšåˆ° zero downtime æ— ç¼é‡è½½å‘¢ï¼Ÿ\nåšæ³•å¦‚ä¸‹ï¼š\nä¸€ã€é…ç½® ç¼–è¯‘harpoxyçš„æ—¶å€™å¸¦ä¸Šå‚æ•° USE_SYSTEMDï¼Œé€‰æ‹© Haproxy 1.8 ä»¥ä¸Šç‰ˆæœ¬\n1make TARGET=linux2628 USE_GETADDRINFO=1 USE_ZLIB=1 USE_REGPARM=1 USE_OPENSSL=1 \\ 2 USE_SYSTEMD=1 USE_PCRE=1 USE_PCRE_JIT=1 USE_NS=1 3make install Haproxyæ— ç¼é‡è½½æŠ€æœ¯ï¼š\n  æ—§è¿›ç¨‹å½“å‰ç®¡ç†çš„è¿æ¥æ ¹æ® file descriptor æ–‡ä»¶æè¿°ç¬¦é€šè¿‡ socket å¥—æ¥å­—ä¼ è¾“åˆ°æ–°è¿›ç¨‹ã€‚\n  åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæ–‡ä»¶socketï¼ˆunix socketï¼‰çš„è¿æ¥æ²¡æœ‰æ–­å¼€ã€‚\n  æ–°è¿›ç¨‹åœ¨å……å½“ master-worker ä¸»å·¥ä½œè€…çš„åŒæ—¶æ‰§è¡Œæ­¤ä»»åŠ¡ã€‚\n  ç»¼ä¸Šæ‰€è¿°ï¼Œé€šè¿‡ä½¿ç”¨unix socketæ¥ç»´æŠ¤è¿æ¥çŠ¶æ€å¹¶åœ¨æ—§è¿›ç¨‹å’Œæ–°è¿›ç¨‹ä¹‹é—´ä¼ é€’ï¼Œé˜²æ­¢äº†è¿æ¥ä¸¢å¤±ã€‚\nhaproxy çš„è¿è¡Œä½¿ç”¨ Systemd é‡è½½ï¼Œä½¿ç”¨ -Ws æ–¹å¼ã€‚ ï¼ˆæ­¤å¤–ï¼Œåœ¨æ„å»ºæ—¶å¿…é¡»å¯ç”¨ USE_SYSTEMDï¼‰\n1 -D : start as a daemon. The process detaches from the current terminal after 2 forking, and errors are not reported anymore in the terminal. It is 3 equivalent to the \u0026#34;daemon\u0026#34; keyword in the \u0026#34;global\u0026#34; section of the 4 configuration. It is recommended to always force it in any init script so 5 that a faulty configuration doesn\u0026#39;t prevent the system from booting. 6 7 -W : master-worker mode. It is equivalent to the \u0026#34;master-worker\u0026#34; keyword in 8 the \u0026#34;global\u0026#34; section of the configuration. This mode will launch a \u0026#34;master\u0026#34; 9 which will monitor the \u0026#34;workers\u0026#34;. Using this mode, you can reload HAProxy 10 directly by sending a SIGUSR2 signal to the master. The master-worker mode 11 is compatible either with the foreground or daemon mode. It is 12 recommended to use this mode with multiprocess and systemd. 13 14 -Ws : master-worker mode with support of `notify` type of systemd service. 15 This option is only available when HAProxy was built with `USE_SYSTEMD` 16 build option enabled. 17 18 å…·ä½“çš„å¯åŠ¨è„šæœ¬ï¼š/etc/systemd/system/haproxy.service\n1[Unit] 2Description=HAProxy Load Balancer 3After=network-online.target 4Wants=network-online.target 5 6[Service] 7Environment=\u0026#34;CONFIG=/etc/haproxy/haproxy.cfg\u0026#34; \u0026#34;PIDFILE=/run/haproxy.pid\u0026#34; 8ExecStartPre=/usr/sbin/haproxy -f $CONFIG -c -q 9ExecStart=/usr/sbin/haproxy -Ws -f $CONFIG -p $PIDFILE 10ExecReload=/usr/sbin/haproxy -f $CONFIG -c -q 11ExecReload=/bin/kill -USR2 $MAINPID 12KillMode=mixed 13Restart=always 14SuccessExitStatus=143 15Type=notify 16 17# The following lines leverage SystemD\u0026#39;s sandboxing options to provide 18# defense in depth protection at the expense of restricting some flexibility 19# in your setup (e.g. placement of your configuration files) or possibly 20# reduced performance. See systemd.service(5) and systemd.exec(5) for further 21# information. 22 23# NoNewPrivileges=true 24# ProtectHome=true 25# If you want to use \u0026#39;ProtectSystem=strict\u0026#39; you should whitelist the PIDFILE, 26# any state files and any other files written using \u0026#39;ReadWritePaths\u0026#39; or 27# \u0026#39;RuntimeDirectory\u0026#39;. 28# ProtectSystem=true 29# ProtectKernelTunables=true 30# ProtectKernelModules=true 31# ProtectControlGroups=true 32# If your SystemD version supports them, you can add: @reboot, @swap, @sync 33# SystemCallFilter=~@cpu-emulation @keyring @module @obsolete @raw-io 34 35[Install] 36WantedBy=multi-user.target äºŒã€éªŒè¯ éªŒè¯æ˜¯å¦çœŸçš„æ˜¯æ— ç¼é‡è½½çš„æ­¥éª¤å¦‚ä¸‹ï¼š\nåœ¨haproxy.cfgçš„globalæ®µè½ä¸­åŠ å…¥statçš„é…ç½®ï¼š\n1stats socket /var/run/haproxy.sock level admin expose-fd listeners process 1 è¿è¡Œä¸€ä¸ªä¸æ–­å¾ªç¯é‡å¯çš„è„šæœ¬ï¼š\n1while true ; do systemctl reload haproxy ; sleep 3 ; done ç”¨ apache çš„å‹æµ‹å·¥å…· ab æ¥å‹ä¸€ä¸‹ã€‚\nSend request while service is reloading:\n1ab -r -c 20 -n 100000 http://127.0.0.1/ æœ€åæ£€æŸ¥ç»“æœä¸­ \u0026ldquo;Failed requests\u0026rdquo; æ˜¯å¦ä¸ºé›¶å°±å¯ä»¥äº†\n","date":"2021-11-04","img":"","permalink":"https://bajie.dev/posts/20211104-haproxy_restart/","series":null,"tags":null,"title":"Haproxyçš„Zero Downtimeé‡å¯å¦‚ä½•åš"},{"categories":null,"content":"ç”¨ alphine é•œåƒçš„ä¸€äº›å¸¸ç”¨æŠ€å·§ï¼š\nä¼šéšæ—¶å¢åŠ ï¼š\nä¸€ã€ä¿®æ”¹æºï¼Œç”¨å›½å¤–çš„æºéå¸¸æ…¢ï¼Œæ›¿æ¢æˆå›½å†…çš„ä¸­ç§‘å¤§æº 1sed -i \u0026#39;s/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g\u0026#39; /etc/apk/repositories äºŒã€æ›´æ–°apkåº“ 1apk update ä¸‰ã€å®‰è£…è½¯ä»¶ 1#å®‰è£…telnet 2apk add busybox-extras 3 4#å®‰è£…curl 5apk add curl 6 7#å®‰è£…æ—¶é—´ç»„ä»¶ 8apk add tzdata 9 10#æ›´æ–°å¹¶ä¸”å®‰è£…è½¯ä»¶ 11apk add --update tzdata å››ã€è¿›å…¥å®¹å™¨ä¸€æ­¥æ‰§è¡Œæ¢æºã€æ›´æ–°ã€å®‰è£… 1sed -i \u0026#39;s/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g\u0026#39; /etc/apk/repositories \u0026amp;\u0026amp; apk update \u0026amp;\u0026amp; apk add curl \u0026amp;\u0026amp; apk add busybox-extras äº”ã€è§£å†³ç¼ºå°‘glibcåº“çš„é—®é¢˜ å¦‚æœä¸lnä¼šæŠ¥é”™ï¼ŒåŸå› æ˜¯ç¼ºå°‘glibcåº“ï¼ï¼ï¼è§£å†³æ–¹æ³•å¦‚ä¸‹ï¼š\n1RUN mkdir /lib64 \u0026amp;\u0026amp; \\  2 ln -s /lib/libc.musl-x86_64.so.1 /lib64/ld-linux-x86-64.so.2 å…­ã€ä¸€äº›è°ƒè¯•çš„CMD 1CMD [\u0026#34;/bin/bash\u0026#34;, \u0026#34;-c\u0026#34;, \u0026#34;while true; do echo hi; sleep 10; done\u0026#34;] 2 3kubectl run curlpod --image=radial/busyboxplus:curl --command -- /bin/sh -c \u0026#34;while true; do echo hi; sleep 10; done\u0026#34; ä¸ƒã€podçš„ç­‰å¾…æŠ€å·§ è¿™å„¿é‡Œå¯åŠ¨æ­£å¼çš„podä¹‹å‰ï¼Œå…ˆä¸´æ—¶èµ·äº†ä¸¤ä¸ªå®¹å™¨ç­‰å¾…å…¶ä»–æœåŠ¡çš„å®Œæˆ\n1 containers: 2 - name: myapp-container 3 image: busybox 4 command: [\u0026#39;sh\u0026#39;, \u0026#39;-c\u0026#39;, \u0026#39;echo The app is running! \u0026amp;\u0026amp; sleep 3600\u0026#39;] 5 initContainers: 6 - name: init-myservice 7 image: busybox 8 command: [\u0026#39;sh\u0026#39;, \u0026#39;-c\u0026#39;, \u0026#39;until nslookup myservice; do echo waiting for myservice; sleep 2; done;\u0026#39;] 9 - name: init-mydb 10 image: busybox 11 command: [\u0026#39;sh\u0026#39;, \u0026#39;-c\u0026#39;, \u0026#39;until nslookup mydb; do echo waiting for mydb; sleep 2; done;\u0026#39;] ","date":"2021-11-04","img":"","permalink":"https://bajie.dev/posts/20211104-alphine_usage/","series":null,"tags":null,"title":"Alphineé•œåƒçš„ä½¿ç”¨æŠ€å·§"},{"categories":null,"content":"æˆ‘ä»¬éƒ½å–œæ¬¢ç”¨ alphine çš„é•œåƒåšåº•åŒ…ï¼Œæ¥ç”Ÿäº§è‡ªå·±çš„é•œåƒ\nalphine çš„åº•åŒ…çš„æ—¶é—´è®¾å®šå°±éå¸¸é‡è¦äº†\nç›´æ¥ç»™å‡º Dockerfile\n1FROM alpine:3.12 2 3# latest certs 4RUN apk add ca-certificates --no-cache \u0026amp;\u0026amp; update-ca-certificates 5 6# timezone support 7ENV TZ=Asia/Shanghai 8RUN apk add --update tzdata --no-cache \u0026amp;\u0026amp;\\ 9 cp /usr/share/zoneinfo/${TZ} /etc/localtime \u0026amp;\u0026amp;\\ 10 echo $TZ \u0026gt; /etc/timezone 11 12# install chrony and place default conf which can be overridden with volume 13RUN apk add --no-cache chrony \u0026amp;\u0026amp; mkdir -p /etc/chrony 14COPY chrony.conf /etc/chrony/. 15 16# port exposed 17EXPOSE 123/udp 18 19# start 20CMD [ \u0026#34;/usr/sbin/chronyd\u0026#34;, \u0026#34;-d\u0026#34;, \u0026#34;-s\u0026#34;] 21 æ—¶é—´è®¾å®šé‡è¦çš„å°±æ˜¯ä¸‹é¢è¿™å‡ è¡Œ\n1# timezone support 2ENV TZ=Asia/Shanghai 3RUN apk add --update tzdata --no-cache \u0026amp;\u0026amp;\\ 4 cp /usr/share/zoneinfo/${TZ} /etc/localtime \u0026amp;\u0026amp;\\ 5 echo $TZ \u0026gt; /etc/timezone è¿˜æœ‰å¦‚æœåœ¨ image: maven:3.5-jdk-8-alpine è¿™ç§é•œåƒé‡Œï¼Œæ— è®ºæ€ä¹ˆæ”¹æ—¶é—´éƒ½ä¸æ˜¯ä¸œå…«åŒºï¼Œå¯ä»¥è¯•è¯•ä¸‹é¢çš„å‘½ä»¤ï¼š\n1export COMMIT_TIME=$(TZ=CST-8 date +%F-%H-%M) ","date":"2021-11-03","img":"","permalink":"https://bajie.dev/posts/20211103-alphine_timezone/","series":null,"tags":null,"title":"Alphineé•œåƒä¸­timezoneçš„è®¾å®š"},{"categories":null,"content":"å…¶å®æˆ‘ä»¬çš„ç”Ÿäº§ç¯å¢ƒä¸€ç›´æ˜¯ KVM ï¼Œç„¶åç”¨ shell è„šæœ¬æ§åˆ¶è™šæœºçš„ç”Ÿæˆï¼Œä¹Ÿæ˜¯ç”¨åˆ°äº† Cloud-init çš„æ ‡å‡†é•œåƒã€‚\nå¬è¯´ Proxmox ä¹Ÿå¾ˆä¸é”™ï¼Œäºæ˜¯æƒ³çœ‹çœ‹èƒ½å¦ä¹Ÿåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ç”¨ä¸Š\nå¦‚æœåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ç”¨ï¼Œå¿…é¡»è¦è®© proxmox æ”¯æŒ cloud-init ï¼Œå¦åˆ™æ— æ„ä¹‰ï¼Œä¸‹é¢ä¹Ÿè¯´ä¸€ä¸‹è·‘åœ¨ç”Ÿäº§çš„æ³¨æ„äº‹é¡¹\né¦–å…ˆæˆ‘ä»¬ç”¨å…‰ç›˜å®‰è£…ï¼š\nç„¶åç¬¬ä¸€ä¸ªæ³¨æ„çš„åœ°æ–¹å°±æ˜¯ç¡¬ç›˜ï¼Œé€‰ Options åï¼š\nä¼šå†’å‡ºä¸€å †é€‰é¡¹ï¼Œå…¬å¸çš„ç”Ÿäº§ç¯å¢ƒï¼ŒæœåŠ¡å™¨å¦‚æœæ²¡æœ‰ raid å¡æ˜¯å¾ˆå¥‡æ€ªçš„ï¼Œæ‰€ä»¥ zfs åè€Œä¸æ˜¯æ ‡é…ï¼Œå› ä¸ºæˆ‘ä»¬ä¼šäº‹å…ˆåœ¨ raid å¡ä¸Šåˆ’åˆ†å¥½ç¡¬ç›˜ï¼Œç”Ÿäº§ç¯å¢ƒåŸºæœ¬å¿…ç„¶æ˜¯ raid10 ï¼Œæ¥ä¸‹æ¥å°±æ˜¯ ext4 å’Œ xfs äºŒé€‰ä¸€äº†ï¼Œå…«æˆ’é€‰ ext4 ï¼Œå› ä¸ºåäº†å¥½ä¿®ç†ï¼Œxfs_repair ç”¨èµ·æ¥ç›¸å½“é¾Ÿæ¯›ï¼š\né‚£ä¹ˆï¼Œé€‰å®šäº† ext4 ï¼Œæ¥ä¸‹æ¥å°±æ¯”è¾ƒé‡è¦äº†\n  hdsize 1116.0 ï¼Œå•ä½æ˜¯Gï¼Œè¿™ä¸ªæ˜¯è‡ªåŠ¨æ”¶é›†ä¸Šæ¥çš„ï¼Œä¸ç”¨æ”¹\n  swapsizeï¼Œäº¤æ¢åˆ†åŒºå¤§å°ï¼Œè¿™ä¸ªç»™ 8 Gï¼ˆæœ€å¤§8Gï¼‰\n  maxrootï¼Œè¿™ä¸ªåˆ†åŒºæ˜¯ç¬¬ä¸€ä¸ªåˆ†åŒºï¼Œå­˜æ”¾ iso å’Œ template çš„ï¼Œéœ€è¦ç»™å¤Ÿï¼Œ100 G\n  minfreeï¼Œç¬¬ä¸€ä¸ªåˆ†åŒºæœ€å°ç•™å¤šå¤§ï¼Œç»™ 10 Gï¼ˆç¼ºçœ16Gï¼‰\n  maxvzï¼Œè¿™ä¸ªåˆ†åŒºæ˜¯ç¬¬äºŒä¸ªåˆ†åŒºï¼Œå­˜æ”¾å®é™…çš„è™šæœºæ–‡ä»¶ï¼Œå…¨éƒ½ç”¨ä¸Šï¼Œä»€ä¹ˆä¹Ÿä¸å¡«å†™\n  ç„¶åç»§ç»­ï¼Œå›½å®¶é€‰ chinaï¼ŒHostname å¡«å†™ proxmox-168-86-103.localï¼Œå†å¡«å†™å¥½å…¶ä»–ä¿¡æ¯ï¼Œå°±å®‰è£…æˆåŠŸäº†ã€‚\næ‰“å¼€ç½‘é¡µï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸€ä¸ª localï¼Œ100Gï¼Œå¯¹åº”ä¸Šé¢çš„ maxroot\nç„¶å local-lvm ï¼Œå°±æ˜¯å‰©ä½™æ”¾è™šæœºçš„ç©ºé—´\nsshç™»å½•ç³»ç»Ÿï¼Œé¦–å…ˆæ¢æˆä¸­ç§‘å¤§çš„ apt æºï¼Œå¹¶å‡çº§ä¸€ä¸‹ç³»ç»Ÿï¼š\n1sed -i \u0026#39;s|^deb http://ftp.debian.org|deb https://mirrors.ustc.edu.cn|g\u0026#39; /etc/apt/sources.list 2sed -i \u0026#39;s|^deb http://security.debian.org|deb https://mirrors.ustc.edu.cn/debian-security|g\u0026#39; /etc/apt/sources.list 3CODENAME=`cat /etc/os-release |grep CODENAME |cut -f 2 -d \u0026#34;=\u0026#34;` 4echo \u0026#34;deb https://mirrors.ustc.edu.cn/proxmox/debian $CODENAMEpve-no-subscription\u0026#34; \u0026gt; /etc/apt/sources.list.d/pve-no-subscription.list 5cat /etc/apt/sources.list.d/pve-no-subscription.list 6rm /etc/apt/sources.list.d/pve-enterprise.list 7apt update 8apt upgrade é‚£ç”Ÿäº§ä½¿ç”¨ï¼Œæ˜¯å¿…é¡»ç”¨ Cloud-init çš„æ ‡å‡†åŒ–é•œåƒçš„ã€‚æˆ‘ä»¬éœ€è¦é€ å‡ºä¸€ä¸ª template ã€‚\nä»¥ Centos7 ä¸ºä¾‹å­\n1wget http://cloud.centos.org/centos/7/images/CentOS-7-x86_64-GenericCloud.qcow2 2apt-get install libguestfs-tools ç„¶åå‡†å¤‡è„šæœ¬ modify.sh ï¼š\n1#!/bin/sh 2image_name=CentOS-7-x86_64-GenericCloud.qcow2 3# virt-edit -a ${image_name} /etc/cloud/cloud.cfg 4virt-edit -a ${image_name} /etc/cloud/cloud.cfg -e \u0026#39;s/disable_root: [Tt]rue/disable_root: False/\u0026#39; 5virt-edit -a ${image_name} /etc/cloud/cloud.cfg -e \u0026#39;s/disable_root: 1/disable_root: 0/\u0026#39; 6virt-edit -a ${image_name} /etc/cloud/cloud.cfg -e \u0026#39;s/lock_passwd: [Tt]rue/lock_passwd: False/\u0026#39; 7virt-edit -a ${image_name} /etc/cloud/cloud.cfg -e \u0026#39;s/lock_passwd: 1/lock_passwd: 0/\u0026#39; 8virt-edit -a ${image_name} /etc/cloud/cloud.cfg -e \u0026#39;s/ssh_pwauth: 0/ssh_pwauth: 1/\u0026#39; 9virt-edit -a ${image_name} /etc/ssh/sshd_config -e \u0026#39;s/PasswordAuthentication no/PasswordAuthentication yes/\u0026#39; 10virt-edit -a ${image_name} /etc/ssh/sshd_config -e \u0026#39;s/PermitRootLogin [Nn]o/PermitRootLogin yes/\u0026#39; 11virt-edit -a ${image_name} /etc/ssh/sshd_config -e \u0026#39;s/#PermitRootLogin [Yy]es/PermitRootLogin yes/\u0026#39; 12virt-edit -a ${image_name} /etc/ssh/sshd_config -e \u0026#39;s/#PermitRootLogin prohibit-password/PermitRootLogin yes/\u0026#39; 13virt-edit -a ${image_name} /etc/ssh/sshd_config -e \u0026#39;s/[#M]axAuthTries 6/MaxAuthTries 20/\u0026#39; 14virt-customize --install cloud-init,atop,htop,nano,vim,qemu-guest-agent,curl,wget,telnet,lsof,screen -a ${image_name} è¿è¡Œå®ƒï¼Œä»¥ä¸Šå‘½ä»¤å…¶å®æ˜¯ä¾µå…¥é•œåƒï¼Œä¿®æ”¹ sshd_config å…è®¸ root ç”¨ password ç™»å½•ï¼Œç„¶ååˆå®‰äº†å‡ ä¸ªå¸¸ç”¨è½¯ä»¶ï¼Œå¤§å®¶å¯ä»¥æŒ‰éœ€ä¿®æ”¹ã€‚\næœ€åç”Ÿæˆ template , è„šæœ¬ï¼š vm.sh 1#!/bin/sh 2vm_id=9999 3image_name=CentOS-7-x86_64-GenericCloud.qcow2 4 5qm create ${vm_id} --memory 8196 --net0 virtio,bridge=vmbr0 6qm importdisk ${vm_id} ${image_name} local-lvm 7qm set ${vm_id} --scsihw virtio-scsi-pci --scsi0 local-lvm:vm-${vm_id}-disk-0 8qm set ${vm_id} --ide2 local-lvm:cloudinit 9qm set ${vm_id} --boot c --bootdisk scsi0 10qm set ${vm_id} --serial0 socket --vga serial0 11qm template ${vm_id} cloud-init æŠ€æœ¯çš„æ ¸å¿ƒå…¶å®å°±æ˜¯ç”¨é…ç½®æ–‡ä»¶ï¼Œåœ¨è™šæœºå¯åŠ¨çš„æ—¶å€™åŠ¨æ€ä¿®æ”¹ï¼Œè¿™é‡ŒæŠŠé…ç½®æ”¾åˆ°äº† ide2 çš„ä¸€ä¸ªè™šæ‹Ÿ cdrom ä¸­\næœ€ç»ˆä¼šç”Ÿæˆä¸€ä¸ª id ä¸º 9999 çš„ template\næˆ‘ä»¬è¿˜éœ€è¦æ”¹ä¸¤å¤„ï¼š\nä¸€æ˜¯ CPUã€MEMORYã€ç¡¬ç›˜å¤§å°ï¼Œç¼ºçœæ˜¯ 8Gï¼Œæˆ‘ä»¬ç”Ÿäº§çš„é•œåƒæ ‡é…æ˜¯80Gï¼Œéœ€è¦ resize , åŠ  72Gï¼Œåˆè®¡80G\näºŒæ˜¯ cloud-init éƒ¨åˆ†ï¼Œç”¨æˆ·åã€å¯†ç ã€DNSã€IPã€MASKã€GATEWAY\nè¿™æ ·è¿™ä¸ª template å°±åšå¥½äº†ï¼Œåœ¨ç”Ÿäº§çš„æ—¶å€™ï¼Œåªéœ€è¦ clone è¿™ä¸ªæ¨¡æ¿ï¼ˆæ¨¡å¼è¦é€‰ Full Cloneï¼‰ï¼Œç„¶åè®°å¾—ä¿®æ”¹ä¸ºä¸åŒçš„IPï¼Œå°±å¯ä»¥äº†ã€‚\næ€»ä½“æ¥è¯´ï¼Œè¿™ä¸ªä¸œè¥¿åå°ç™½ï¼Œå¯¹äºä¹ æƒ¯äº† KVM çš„äººæ¥è¯´ï¼Œåè€Œä¸å¦‚è„šæœ¬æ¥çš„å¿«ã€‚\nç›¸å…³æ–‡æ¡£ï¼šhttps://whattheserver.com/proxmox-cloud-init-os-template-creation/\n","date":"2021-11-03","img":"","permalink":"https://bajie.dev/posts/20211103-proxmox/","series":null,"tags":null,"title":"ç”Ÿäº§ç¯å¢ƒProxmox 7.02çš„å®‰è£…å’Œé…ç½®"},{"categories":null,"content":"kubernetes ä¸­ nginx ingress çš„ä¼˜åŒ–åˆ†ä¸¤éƒ¨åˆ†\nä¸€ã€ç³»ç»Ÿsysctléƒ¨åˆ†ä¼˜åŒ– é¦–å…ˆæ˜¯å¯¹nginxå¯åŠ¨å‰çš„ç³»ç»Ÿæ€§èƒ½è¿›è¡Œä¼˜åŒ–ï¼Œè¿™éƒ¨åˆ†è°ƒæ•´ç½‘ç»œçš„ç¼“å†²åŒºï¼Œå‡å°é—²ç½® socket å…³é—­çš„æ—¶é—´\nä»¥é˜¿é‡Œ ACK ä¸ºä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥ç¼–è¾‘ deployments çš„ nginx-ingress-controller\n1 initContainers: 2 - command: 3 - /bin/sh 4 - -c 5 - | 6 mount -o remount rw /proc/sys 7 sysctl -w net.core.somaxconn=65535 8sysctl -w net.ipv4.ip_local_port_range=\u0026#34;1024 65535\u0026#34; 9sysctl -w net.ipv4.tcp_tw_reuse=1 10sysctl -w fs.file-max=1048576 11sysctl -w net.ipv4.tcp_keepalive_time = 300 12sysctl -w net.ipv4.tcp_keepalive_probes = 5 13sysctl -w net.ipv4.tcp_keepalive_intvl = 15 14 äºŒã€nginx ingress å‚æ•°ä¼˜åŒ– å¤§å®¶åˆ¶åŠ¨ï¼Œnginx ingree å…¶å®æ˜¯åšä¸ºä¸€ä¸ªä¸­é—´ä»£ç†ï¼Œæ‰€ä»¥ä¸Šä¸‹æ¸¸çš„socketå‚æ•°ä¹Ÿéœ€è¦ä¼˜åŒ–\nåŒæ ·ä»¥é˜¿é‡ŒACKä¸ºä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥ç¼–è¾‘ configmaps çš„ nginx-configuration\n1apiVersion: v1 2data: 3 allow-backend-server-header: \u0026#34;true\u0026#34; 4 enable-underscores-in-headers: \u0026#34;true\u0026#34; 5 generate-request-id: \u0026#34;true\u0026#34; 6 ignore-invalid-headers: \u0026#34;true\u0026#34; 7 log-format-upstream: $remote_addr - [$remote_addr] - $remote_user [$time_local] 8 \u0026#34;$request\u0026#34; $status $body_bytes_sent \u0026#34;$http_referer\u0026#34; \u0026#34;$http_user_agent\u0026#34; $request_length 9 $request_time [$proxy_upstream_name] $upstream_addr $upstream_response_length 10 $upstream_response_time $upstream_status $req_id $host [$proxy_alternative_upstream_name] 11 proxy-body-size: 20m 12 proxy-connect-timeout: \u0026#34;10\u0026#34; 13 reuse-port: \u0026#34;true\u0026#34; 14 server-tokens: \u0026#34;false\u0026#34; 15 ssl-redirect: \u0026#34;false\u0026#34; 16 17 upstream-keepalive-timeout: \u0026#34;900\u0026#34; 18 keep-alive-requests: \u0026#34;10000\u0026#34; 19 upstream-keepalive-connections: \u0026#34;500\u0026#34; 20 max-worker-connections: \u0026#34;65536\u0026#34; 21 22 worker-cpu-affinity: auto 23kind: ConfigMap ","date":"2021-11-02","img":"","permalink":"https://bajie.dev/posts/20211102-ingress_nginx/","series":null,"tags":null,"title":"K8sä¸­nginx Ingressçš„æ€§èƒ½ä¼˜åŒ–"},{"categories":null,"content":"è¿™ç¯‡æ˜¯çº¯é…ç½®ç¯‡ï¼Œè§£é‡Šéƒ½åœ¨é…ç½®é‡Œäº†ï¼Œæ˜¯ç”Ÿäº§æœåŠ¡å™¨ sysctl.conf çš„é…ç½®\n1### KERNEL ### 2 3# Reboot after 10sec. on kernel panic 4kernel.panic = 10 5 6### IMPROVE SYSTEM MEMORY MANAGEMENT ### 7 8# Increase size of file handles and inode cache 9fs.file-max = 2097152 10 11# Insure we always have enough memory 12vm.min_free_kbytes = 8192 13 14# Do less swapping 15vm.swappiness = 10 16vm.dirty_ratio = 10 17vm.dirty_background_ratio = 2 18 19 20### GENERAL NETWORK SECURITY OPTIONS ### 21 22# Avoid a smurf attack 23net.ipv4.icmp_echo_ignore_broadcasts = 1 24 25# Turn on protection for bad icmp error messages 26net.ipv4.icmp_ignore_bogus_error_responses = 1 27 28# Turn on syncookies for SYN flood attack protection 29net.ipv4.tcp_syncookies = 1 30net.ipv4.tcp_max_syn_backlog = 8192 31 32 33# Turn on timestamping 34net.ipv4.tcp_timestamps = 1 35 36# Turn on and log spoofed, source routed, and redirect packets 37net.ipv4.conf.all.log_martians = 1 38net.ipv4.conf.default.log_martians = 1 39 40# No source routed packets here 41net.ipv4.conf.all.accept_source_route = 0 42net.ipv4.conf.default.accept_source_route = 0 43 44# Turn on reverse path filtering 45net.ipv4.conf.all.rp_filter = 1 46net.ipv4.conf.default.rp_filter = 1 47 48# Make sure no one can alter the routing tables 49net.ipv4.conf.all.accept_redirects = 0 50net.ipv4.conf.default.accept_redirects = 0 51net.ipv4.conf.all.secure_redirects = 0 52net.ipv4.conf.default.secure_redirects = 0 53 54# Don\u0026#39;t act as a router 55net.ipv4.ip_forward = 0 56net.ipv4.conf.all.send_redirects = 0 57net.ipv4.conf.default.send_redirects = 0 58 59# Number of times SYNACKs for passive TCP connection. 60net.ipv4.tcp_synack_retries = 2 61 62# Allowed local port range 63net.ipv4.ip_local_port_range = 1024 65000 64 65# Protect Against TCP Time-Wait 66net.ipv4.tcp_rfc1337 = 1 67 68# Decrease the time default value for tcp_fin_timeout connection 69net.ipv4.tcp_fin_timeout = 15 70 71# Decrease the time default value for connections to keep alive 72net.ipv4.tcp_keepalive_time = 300 73net.ipv4.tcp_keepalive_probes = 5 74net.ipv4.tcp_keepalive_intvl = 15 75# This means that the keepalive process waits 300 seconds for socket  76# activity before sending the first keepalive probe, and then resend 77# it every 15 seconds. If no ACK response is received for 5 consecutive  78# times (75s in this case), the connection is marked as broken. 79 80### TUNING NETWORK PERFORMANCE ### 81 82# Disable IPv6 83net.ipv6.conf.all.disable_ipv6 = 1 84net.ipv6.conf.default.disable_ipv6 = 1 85net.ipv6.conf.lo.disable_ipv6 = 1 86 87# Default Socket Receive Buffer 88net.core.rmem_default = 31457280 89 90# Maximum Socket Receive Buffer 91net.core.rmem_max = 12582912 92 93# Default Socket Send Buffer 94net.core.wmem_default = 31457280 95 96# Maximum Socket Send Buffer 97net.core.wmem_max = 12582912 98 99# Increase number of incoming connections 100net.core.somaxconn = 5000 101 102# Increase number of incoming connections backlog 103net.core.netdev_max_backlog = 65536 104 105# Enable TCP window scaling 106net.ipv4.tcp_window_scaling = 1 107 108# Increase the maximum amount of option memory buffers 109net.core.optmem_max = 25165824 110 111 112# Increase the maximum total buffer-space allocatable 113# This is measured in units of pages (4096 bytes) 114net.ipv4.tcp_mem = 65536 131072 262144 115net.ipv4.udp_mem = 65536 131072 262144 116 117# Increase the read-buffer space allocatable 118net.ipv4.tcp_rmem = 8192 87380 16777216 119net.ipv4.udp_rmem_min = 16384 120 121# Increase the write-buffer-space allocatable 122net.ipv4.tcp_wmem = 8192 65536 16777216 123net.ipv4.udp_wmem_min = 16384 124 125 126# Increase the tcp-time-wait buckets pool size to prevent simple DOS attacks 127net.ipv4.tcp_max_tw_buckets = 1800000 128 129# TIME_WAIT socket policy 130# Note: if both enabled then disable 131# net.ipv4.tcp_timestamps for servers  132# behind NAT to prevent dropped incoming connections 133#net.ipv4.tcp_tw_recycle = 1 134net.ipv4.tcp_tw_reuse = 1 135 136# Enable TCP MTU probing (in case of Jumbo Frames enabled) 137#net.ipv4.tcp_mtu_probing = 1 138 139# Speedup retrans (Google recommended) 140net.ipv4.tcp_slow_start_after_idle = 0 141net.ipv4.tcp_early_retrans = 1 142 143# Conntrack 144# 288bytes x 131072 = 37748736 (~38MB) max memory usage 145#net.netfilter.nf_conntrack_max = 131072 146#net.netfilter.nf_conntrack_tcp_loose = 1 147 148#TCPçš„ç›´æ¥æ‹¥å¡é€šå‘Š(tcp_ecn)å…³æ‰ 149net.ipv4.tcp_ecn = 0 150 151#è·¯ç”±ç¼“å­˜åˆ·æ–°é¢‘ç‡ï¼Œå½“ä¸€ä¸ªè·¯ç”±å¤±è´¥åå¤šé•¿æ—¶é—´è·³åˆ°å¦ä¸€ä¸ªè·¯ç”±ï¼Œé»˜è®¤æ˜¯300ã€‚ 152net.ipv4.route.gc_timeout = 100 153 154#è®¾å®šç³»ç»Ÿä¸­æœ€å¤šå…è®¸åœ¨å¤šå°‘TCPå¥—æ¥å­—ä¸è¢«å…³è”åˆ°ä»»ä½•ä¸€ä¸ªç”¨æˆ·æ–‡ä»¶å¥æŸ„ä¸Šã€‚ 155#å¦‚æœè¶…è¿‡è¿™ä¸ªæ•°å­—ï¼Œæ²¡æœ‰ä¸ç”¨æˆ·æ–‡ä»¶å¥æŸ„å…³è”çš„TCP å¥—æ¥å­—å°†ç«‹å³è¢«å¤ä½ 156#é˜²ç®€å•Dos 157net.ipv4.tcp_max_orphans = 655360 158 159# NOTE: Enable this if machine support it 160# -- 10gbe tuning from Intel ixgb driver README -- # 161# turn off selective ACK and timestamps 162#net.ipv4.tcp_sack = 0 163#net.ipv4.tcp_timestamps = 1 ** æ³¨æ„ï¼Œnet.ipv4.tcp_tw_recycle ä¸è¦æ‰“å¼€ï¼Œåœ¨ NAT ç¯å¢ƒä¸­ä¼šå‡ºé”™ï¼Œè€Œä¸”åœ¨ K8S ä¸­ä¹Ÿä¼šå›  NAT å¯¼è‡´ pod å‡ºé”™ï¼Œåˆ‡è®°ï¼ï¼ï¼**\n","date":"2021-11-02","img":"","permalink":"https://bajie.dev/posts/20211102-sysctl_conf/","series":null,"tags":null,"title":"Linuxå†…æ ¸sysctlå†…æ ¸å‚æ•°ä¼˜åŒ–"},{"categories":null,"content":"Custom Configuration of TCP Socket Keep-Alive Timeouts è¿™æ˜¯ä¸ªå¤è€çš„è¯é¢˜ï¼Œæˆ‘ä»¬åœ¨æœºå™¨çš„ä¼˜åŒ–ä¸­ï¼Œéœ€è¦è®¾ç½® TCP Socket çš„ Timeout å‚æ•°\nç”¨æ¥åŠ å¿« TCP å…³é—­æ— ç”¨é—²ç½®è¿æ¥çš„æ—¶é—´\nLinux å†…æ ¸ä¸­æœ‰ä¸‰ä¸ªç¼ºçœå‚æ•°:\n  1 tcp_keepalive_time  ç¼ºçœæ˜¯ 7200 ç§’    1 tcp_keepalive_probes  ç¼ºçœæ˜¯ 9    1 tcp_keepalive_intvl  ç¼ºçœæ˜¯ 75 ç§’    å¤„ç†æµç¨‹å¦‚ä¸‹ï¼š\nä¸€ã€å®¢æˆ·ç«¯æ‰“å¼€ä¸€ä¸ª TCP socket è¿æ¥ï¼Œå¼€å§‹è·ŸæœåŠ¡å™¨é€šè®¯\näºŒã€å¦‚æœè¿™æ¡ socket è¿æ¥ç©ºé—²æ²¡æœ‰ä»»ä½•æ•°æ®ä¼ è¾“ï¼Œé™é»˜äº† tcp_keepalive_time ç§’åï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯ä¼šä¸»åŠ¨å‘é€ä¸€ä¸ªç©ºçš„ ACK åŒ…åˆ°æœåŠ¡å™¨\nä¸‰ã€é‚£ä¹ˆï¼Œæ ¹æ®æœåŠ¡å™¨æ˜¯å¦å›åº”äº†ä¸€ä¸ªç›¸åº”çš„ ACK åŒ…æ¥åˆ¤æ–­\n1ACK  æœªå›åº”  ç­‰å¾… tcp_keepalive_intvl ç§’ï¼Œç„¶åå†å‘ä¸€ä¸ª ACK åŒ… é‡å¤ä»¥ä¸Šç­‰å¾…å¹¶å‘é€ ACK åŒ…çš„è¿‡ç¨‹ï¼Œç›´åˆ°æ¬¡æ•°ç­‰äº tcp_keepalive_probes å¦‚æœç¬¬2æ­¥åšå®Œè¿˜æ”¶ä¸åˆ°ä»»ä½•å›åº”ï¼Œå‘é€ä¸€ä¸ª RST åŒ…å¹¶å…³é—­è¿æ¥   å›åº”äº†: å›åˆ°ä¸Šè¿°ç¬¬äºŒæ­¥  é‚£ä¹ˆç¼ºçœæƒ…å†µä¸‹ï¼Œ7200+75Ã—9ï¼Œä¸€ä¸ªæ²¡æœ‰ä»»ä½•æ•°æ®ä¼ è¾“çš„ socket æ‰ä¼šè¢«å…³é—­ï¼Œå¤§æ¦‚æ˜¯2å°æ—¶11åˆ†é’Ÿã€‚\nè¿™ä¸ªæ—¶é—´å¤ªé•¿äº†ã€‚éœ€è¦ä¼˜åŒ–ä¸€ä¸‹ï¼š\n1net.ipv4.tcp_keepalive_time = 300 2net.ipv4.tcp_keepalive_probes = 5 3net.ipv4.tcp_keepalive_intvl = 15 ä¸Šé¢çš„æ—¶é—´æ˜¯ 300 + 5x15ï¼Œå¤§æ¦‚æ˜¯6åˆ†é’Ÿï¼Œå¤§å¤§ç¼©çŸ­é‡Šæ”¾ç©ºé—² socket çš„æ—¶é—´\n","date":"2021-11-02","img":"","permalink":"https://bajie.dev/posts/20211102-tcp_keealive/","series":null,"tags":null,"title":"Linuxå†…æ ¸TCPè¿æ¥Keep-Alive Timeoutçš„é…ç½®"},{"categories":null,"content":"è¿™å±äºShellçš„é«˜çº§æŠ€å·§äº†ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦åœ¨ bash ä¸­å¹¶å‘ wget rsync æ–‡ä»¶ï¼Œä¸‹é¢å°±è®¨è®ºä¸€ä¸‹è¿™ä¸ªé—®é¢˜ã€‚\né¦–å…ˆä»ç®€å•çš„å•çº¿ç¨‹å¼€å§‹ï¼š\n1$ for i in $(seq 1 2); do echo $i; done 21 32 å¯ä»¥çœ‹åˆ°æ˜¯é¡ºåºæ‰§è¡Œçš„ï¼Œä¸‹é¢å˜å¤šçº¿ç¨‹ï¼š\n1$ for i in $(seq 1 2); do echo $i \u0026amp; done 2[1] 245505 31 4[2] 245506 52 6[1] Done echo $i 7[2] Done echo $i å¯ä»¥çœ‹åˆ°æˆ‘ä»¬åªæŠŠ ; å·æ”¹æˆäº† \u0026amp; å·ï¼Œç¨‹åºå°±å˜æˆäº†å¤šçº¿ç¨‹æ‰§è¡Œã€‚\nåŒºåˆ«åœ¨äº ; å·ä¼šç­‰å¾…ä¹‹å‰çš„å‘½ä»¤æ‰§è¡Œå®Œæ¯•å†æ‰§è¡Œä¸‹ä¸€æ¡ï¼Œè€Œ \u0026amp; ä¸ç­‰å¾…ï¼Œç›´æ¥ç»§ç»­æ‰§è¡Œä¸‹ä¸€æ¡ï¼›ç›¸å½“äºåå°è¿è¡Œäº†å‰ä¸€æ¡å‘½ä»¤ã€‚\nä¸‹é¢è¯´è¯´ find çš„å•çº¿ç¨‹å’Œå¤šçº¿ç¨‹ï¼š\nfind çš„ exec ç”¨æ³•\n1$ find /path [args] -exec [cmd] {} \\;  {} å ä½ç¬¦å·ï¼Œå­˜æ”¾findæ‰¾åˆ°çš„è®°å½• ; å¯¹äºæ¯ä¸€æ¡æ‰¾åˆ°çš„å•ç‹¬è®°å½•ï¼Œæ‰§è¡Œçš„cmdæ˜¯ä¸€æ¡ä¸€æ¡å•ç‹¬æ‰§è¡Œçš„ æ‰§è¡Œçš„é¡ºåºå¦‚ä¸‹: cmd result1; cmd result2; \u0026hellip;; cmd result N  1$ find /path [args] -exec [cmd] {} \\+  {} å ä½ç¬¦å·ï¼Œå­˜æ”¾findæ‰¾åˆ°çš„è®°å½• + å¯¹äºæ‰¾åˆ°çš„æ‰€æœ‰è®°å½•ï¼Œæ‰§è¡Œçš„cmdæ˜¯åˆå¹¶äº†æ‰€æœ‰è®°å½•é›†æ‰§è¡Œçš„ æ‰§è¡Œé¡ºåºå¦‚ä¸‹: cmd result1 result2 \u0026hellip; result N  å¤šä¸ªexecå¯ä»¥ä¸²èµ·æ¥ï¼š\n1$ find /tmp/dir1/ -type f -exec grep howtouselinux {} \\; -exec echo {} \\; | sed \u0026#39;s/howtouselinux/deep/g\u0026#39; è‡³æ­¤ï¼Œfind ä¹Ÿè¿˜æ˜¯å•çº¿ç¨‹æ‰§è¡Œçš„ï¼Œå¹¶æ²¡æœ‰å¹¶å‘ã€‚\nfind è¦å¹¶å‘ï¼Œå°±åªèƒ½è·Ÿ xargs ç»“åˆåœ¨ä¸€èµ·ï¼š\nxargs é€šå¸¸é…åˆç®¡é“ä½¿ç”¨ï¼Œå°†å‰é¢å‘½ä»¤äº§ç”Ÿçš„å‚æ•°ï¼Œé€ä¸ªä¼ å…¥åç»­å‘½ä»¤ï¼Œä½œä¸ºå‚æ•°ã€‚xargs ä¼ æ¥çš„å‚æ•°ï¼Œé»˜è®¤ä½äº xargs åé¢å‘½ä»¤çš„æœ€åï¼Œå¦‚æœè¦æ”¹å˜ä½ç½®ï¼Œéœ€è¦ç”¨**-I**å‚æ•°ã€‚xargs å¦‚æœä¸å¸¦å‘½ä»¤ï¼Œç¼ºçœæ˜¯ echo\n  -d åˆ†éš”ç¬¦\n 1$ echo -e \u0026#34;a\\tb\\tc\u0026#34; | xargs -d \u0026#34;\\t\u0026#34; echo 2a b c    -I{} æŒ‡å®šå ä½ç¬¦ï¼Œ-I %é‚£å°±æ˜¯ % æ›¿ä»£ä»ä¹‹å‰ç®¡é“å–å¾—çš„å‚æ•°\n 1$ find . -type d | xargs -I % -0 rsync -auvPR % 192.168.1.38::new/    -0 è·Ÿfindçš„-print0é…åˆï¼Œfindå‘½ä»¤æœ‰ä¸€ä¸ªç‰¹åˆ«çš„å‚æ•°-print0ï¼ŒæŒ‡å®šè¾“å‡ºçš„æ–‡ä»¶åˆ—è¡¨ä»¥nullåˆ†éš”ã€‚ç„¶åï¼Œxargså‘½ä»¤çš„-0å‚æ•°è¡¨ç¤ºç”¨nullå½“ä½œåˆ†éš”ç¬¦ã€‚\n 1$ find ./new -mindepth 6 -maxdepth 6 -type d -print0 | xargs -I % -0 rsync -auvPR % 172.18.34.38::new/    -P æœ€å¤§å¹¶å‘çº¿ç¨‹æ•°ï¼Œä¸‹é¢æ˜¯å¹¶å‘30çº¿ç¨‹\n 1$ find ./new -mindepth 6 -maxdepth 6 -type d -print0 | xargs -P 30 -I % -0 rsync -auvPR % 172.18.34.38::new/    -n é€‰é¡¹é™åˆ¶å•ä¸ªå‘½ä»¤è¡Œçš„å‚æ•°ä¸ªæ•°ï¼Œä¸‹é¢æ˜¯ rsync ä¸€è¡Œå‘½ä»¤ä¼ å¸¦60ä¸ªæ–‡ä»¶ï¼Œ30ä¸ªè¿›ç¨‹é‚£å°±æ˜¯30ä¸ª rsyncï¼Œæ¯ä¸ª rsync åŒæ—¶ä¼ 60ä¸ªæ–‡ä»¶ã€‚\n 1$ find ./new -mindepth 6 -maxdepth 6 -type d -print0 | xargs -P 30 -n 60 -I % -0 rsync -auvPR % 172.18.34.38::new/ 2 3$ echo {0..10} | xargs -I{} -n 2 40 1 52 3 64 5 76 7 88 9 910    ä½¿ç”¨ bash -c å¹¶å‘çš„ä¾‹å­ï¼š\n1$ time for i in $(seq 1 5); do echo $[$RANDOM % 5 + 1]; done | xargs -I{} echo \u0026#34;sleep {}; echo \u0026#39;Done! {}\u0026#39;\u0026#34; | xargs -P5 -I{} bash -c \u0026#34;{}\u0026#34; ","date":"2021-10-29","img":"","permalink":"https://bajie.dev/posts/20211029-bash_multithread/","series":null,"tags":null,"title":"Shellä»¥åŠfindçš„å¤šçº¿ç¨‹æ‰§è¡Œ"},{"categories":null,"content":"ä¹‹å‰è®²è¿‡å¦‚ä½•å¯¹ opnvpn æ€»ä½“é™é€Ÿï¼Œè¿™æ¬¡æ¥äº†ä¸€ä¸ªæ›´ä¸¥æ ¼çš„ç¨‹åºé™é€Ÿéœ€æ±‚ï¼š\nåœºæ™¯å¦‚ä¸‹ï¼š\n  ä¸¤ä¸ªæœºæˆ¿é—´æœ‰ä¸€æ¡ä¸“çº¿ 100M\n  ä¸¤ä¸ªæœºæˆ¿é—´éœ€è¦åŒæ­¥æ•°æ®ï¼ŒåŒæ­¥éœ€è¦é™åˆ¶åˆ°60Mï¼Œç»™åˆ«çš„ç¨‹åºç•™å‡ºå¸¦å®½ç©ºé—´\n  ä¼ è¾“æ˜¯å¤šä¸ªæ–‡ä»¶ï¼Œç”¨ rsync å¹¶å‘ä¼ é€\n  åˆ†æäº†ä¸€ä¸‹è„šæœ¬çš„æ ¸å¿ƒéƒ¨åˆ†\n1find . -type f | grep $(date -d\u0026#34;-1 day\u0026#34; +\u0026#39;%Y%m%d\u0026#39;) |xargs -I % -P 30 rsync -auvPR % 192.168.9.17::mysql å‘ç°æ˜¯åˆ©ç”¨ xargs çš„å¹¶å‘ï¼Œ-P 30 æœ€å¤§å¹¶å‘30ä¸ªï¼Œå¯åŠ¨äº† rsync åŒæ­¥\nrsync æ²¡æœ‰é™é€Ÿï¼Œè¿™å°±éº»çƒ¦äº†ã€‚\nä¸€ã€å•æ–‡ä»¶å•ç‹¬é™é€Ÿ é¦–å…ˆæ˜¯ä½¿ç”¨ rsync çš„ \u0026ndash;bwlimit=600 å‚æ•°ï¼ŒæŠŠé€Ÿåº¦é™åˆ¶ä¸º 600KB/s ï¼Œ600Ã—8=4800ï¼Œå•è¿›ç¨‹åŸºæœ¬æ˜¯5Mçš„é€Ÿåº¦ï¼Œæœ€å¤šåªèƒ½è·‘12ä¸ªäº†ï¼Œå°±ä¼šè·‘åˆ°60Mã€‚\nè¿™æ ·ä¹Ÿä¸å¤ªå¯¹ï¼Œå°¤å…¶æ˜¯ rsync å¹¶å‘è¿›ç¨‹é€æ¸å‡å°‘ï¼Œå°‘äº12ä¸ªçš„æ—¶å€™ï¼Œè¿™æ ·å°±å‡ºç°è·‘ä¸æ»¡60Mçš„ç°è±¡ã€‚\näºŒã€å¤šæ–‡ä»¶æ•´ä½“é™é€Ÿ é‚£ä¹ˆ rsync æ”¯æŒå¤šæ–‡ä»¶ä¼ è¾“ ï¼Œä½¿ç”¨å¦‚ä¸‹æ ¼å¼æ•´ä½“é™é€Ÿ\n1rsync --bwlimit=7200 -auvPR æ–‡ä»¶1 æ–‡ä»¶2 æ–‡ä»¶3 192.168.9.17::mysql é—®é¢˜åˆæ¥äº†ï¼Œæ–‡ä»¶1 æ–‡ä»¶2 æ–‡ä»¶3 çš„è·¯å¾„éå¸¸é•¿ï¼Œè€Œæ–‡ä»¶ä¸ªæ•°ä¸å®šï¼Œæœ‰æ’‘çˆ†å‘½ä»¤è¡Œå•è¡Œé•¿åº¦é™åˆ¶çš„å¯èƒ½ï¼Œä¹Ÿä¸å¯è¡Œ\nä¸‰ã€tc ä½¿ç”¨ tc å¯ä»¥æ§åˆ¶æºipæˆ–è€…ç›®çš„ipçš„å¸¦å®½ï¼Œä½†æ˜¯æœ¬æœºç½‘å¡æ˜¯ä¸‡å…†å…‰å¡ï¼Œç”Ÿäº§ç¯å¢ƒï¼Œæ¯æ—¶æ¯åˆ»éƒ½æœ‰æ•°æ®è¯»å†™ã€‚\nä¸€æ—¦é”™äº†ï¼Œå°±ç›´æ¥å®Œè›‹äº†ã€‚ä¹Ÿä¸å¤ªå¯è¡Œ\nå››ã€æ€å™¨trickle å¯»æ‰¾äº†åŠå¤©ï¼Œç»ˆäºæ‰¾åˆ°äº†ä¸ªå¤§æ€å™¨trickleï¼Œå¯ä»¥å¯¹ç¨‹åºå•ç‹¬é™é€Ÿï¼Œä¹Ÿå¯ä»¥å¯¹ä¸€å †ç¨‹åºæ•´ä½“é™é€Ÿ\nå®‰è£…ï¼š\n1$ yum install -y epel-release 2$ yum install trickle å‚æ•°è§£é‡Šï¼š\n -u ä¸Šè½½é€Ÿåº¦ KB/s ï¼Œä¹˜ä»¥8æ¢ç®—æˆç½‘ç»œé€Ÿåº¦ -d ä¸‹è½½é€Ÿåº¦ KB/s ï¼Œä¹˜ä»¥8æ¢ç®—æˆç½‘ç»œé€Ÿåº¦ -s standaloneç‹¬ç«‹æ¨¡å¼ï¼Œä¸å‚ä¸ trickled çš„æ•´ä½“æ¨¡å¼  å¦‚æœè¦å¯¹ä¸€ä¸ªç¨‹åºå•ç‹¬é™é€Ÿï¼Œ10KB\n1trickle -s -u 10 -d 10 wget http://mirrors.163.com/rocky/8/isos/x86_64/Rocky-8.4-x86_64-dvd1.iso wget çš„ä¸‹è½½å®Œå…¨è¢«é™åˆ¶åœ¨äº†10KB\nå¦‚è¿‡è¦å¯¹ä½¿ç”¨trickleçš„æ‰€æœ‰ç¨‹åºåšæ•´ä½“é™é€Ÿ\n1# é¦–å…ˆå¯åŠ¨å®ˆæŠ¤è¿›ç¨‹ trickled 2$ trickled -u 7200 -d 7200 3 4# ç„¶åæ‰€æœ‰ç”¨trickleæ‰§è¡Œçš„å‘½ä»¤å°±ä¼šæ•´ç†é™é€Ÿåœ¨7200KB/s ï¼ˆç½‘ç»œé€Ÿåº¦60Mï¼‰ 5find . -type f | grep $(date -d\u0026#34;-1 day\u0026#34; +\u0026#39;%Y%m%d\u0026#39;) |xargs -I % -P 30 trickle rsync -auvPR % 192.168.9.17::mysql ","date":"2021-10-28","img":"","permalink":"https://bajie.dev/posts/20211028-trickle/","series":null,"tags":null,"title":"Linuxä¸‹çš„ç¨‹åºé™é€Ÿè½¯ä»¶Trickle"},{"categories":null,"content":"Dockerfile æ˜¯é€ å‡ºé•œåƒçš„åŸºç¡€ï¼Œæ˜¯å¿…é¡»ç†ŸçŸ¥å¹¶äº†è§£çš„çŸ¥è¯†ï¼š\nä¸€ã€ç¼–å†™Dockerfile å…ˆç»™ä¸ªä¾‹å­ï¼Œæ˜¯ minio ä»£ç†è®¿é—®é˜¿é‡Œçš„ OSS\n1FROM alpine:3.12  2 3RUN apk add --update bash \u0026amp;\u0026amp; rm -rf /var/cache/apk/*  4 5COPY minio.RELEASE.2020-04-15T19-42-18Z /data/minio.RELEASE.2020-04-15T19-42-18Z  6 7ENV MINIO_ACCESS_KEY=LTAI5tFFTbsxxxxxuLb  8ENV MINIO_SECRET_KEY=t78PyGnHZilxxxxxdxBCjvNgtVC5Y  9 10WORKDIR /data  11EXPOSE 9000  12 13CMD [\u0026#34;/data/minio.RELEASE.2020-04-15T19-42-18Z\u0026#34;,\u0026#34;gateway\u0026#34;,\u0026#34;oss\u0026#34;,\u0026#34;http://oss-cn-shanghai-internal.aliyuncs.com\u0026#34;]  14# CMD /bin/sh -c \u0026#34;while true; do echo hi; sleep 10; done\u0026#34; 15  è¯¦ç»†è§£é‡Šæ¯ä¸€æ¡è¯­å¥ï¼š\n  FROM\nåŸºæ¿ï¼Œalpine 3.12 æ˜¯ä¸ªæ¯”è¾ƒå¾®å°çš„ç‰ˆæœ¬ï¼Œæ³¨æ„å®ƒçš„æ¯›ç—…ï¼Œ/bin/shå…¶å®æ˜¯busyboxï¼Œæ²¡æœ‰/bin/bashï¼ŒæŸäº›bashçš„å‡½æ•°åŠŸèƒ½æ”¯æŒä¸å…¨ï¼Œæ¯”å¦‚forå¾ªç¯\n  RUN\nåœ¨å®¹å™¨ä¸­è¿è¡Œå‘½ä»¤ï¼Œä¸Šä¾‹ä¸­æˆ‘ä»¬æ·»åŠ äº† bash ï¼Œå¹¶æ¸…ç†äº†ç¼“å­˜ã€‚å‘½ä»¤é—´ç”¨ \u0026amp;\u0026amp; å¯ä»¥é¿å…é•œåƒè¿‡å¤šåˆ†å±‚ã€‚\nRUNåˆ†ä¸¤ç§æ¨¡å¼shellå’Œexecæ¨¡å¼:\næˆ‘ä»¬åªç”¨ exec æ¨¡å¼ï¼Œå› ä¸ºåœ¨ image é‡Œè£…å…¥å¤šä¸ª shellï¼Œæ²¡ä»€ä¹ˆæ„ä¹‰ã€‚\n  COPY å’Œ ADD\nä½œç”¨éƒ½æ˜¯å°†æ–‡ä»¶æˆ–ç›®å½•å¤åˆ¶åˆ° Dockerfile æ„å»ºçš„é•œåƒä¸­\næˆ‘ä»¬åªç”¨COPYï¼Œå¦‚æœé‡åˆ°è¦æŠŠURLçš„æ–‡ä»¶æ”¾è¿›å»ï¼Œå¯ä»¥å…ˆwgetï¼Œç„¶åæ”¾ï¼›å¦‚æœè¦è§£å‹tarråŒ…æ”¾è¿›å»ï¼Œé‚£å°±å…ˆè§£å‹å†æ”¾ã€‚\næ³¨æ„æºæ–‡ä»¶è·¯å¾„éƒ½ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œç›®æ ‡è·¯å¾„ä½¿ç”¨ç»å¯¹è·¯å¾„ã€‚\nå¦‚æœdestä¸æŒ‡å®šç»å¯¹è·¯å¾„ï¼Œåˆ™æ˜¯æƒ³å¯¹äºWORDIRçš„ç›¸å¯¹è·¯å¾„\n  CMD å…¥å£\nç”¨ [] åˆ†å‰²ï¼Œ æŠŠæ‰€æœ‰ \u0026quot;\u0026quot; çš„éƒ¨åˆ†åˆå¹¶ä¸ºä¸€è¡Œï¼Œä¸­é—´ç”¨ç©ºæ ¼éš”å¼€æ‰§è¡Œï¼›æˆ–è€…ç›´æ¥ä¸€è¡Œæ²¡ä»»ä½•åˆ†å‰²ç¬¦ã€‚\næ‰€ä»¥ä¸Šé¢çš„ä¾‹å­å°±æ˜¯æ‰§è¡Œäº†ä¸€å¥ï¼š\n1/data/minio.RELEASE.2020-04-15T19-42-18Z gateway oss http://oss-cn-shanghai-internal.aliyuncs.com æŠ€å·§ï¼š\næŠŠå‡ ä¸ªå‘½ä»¤åˆåœ¨ä¸€èµ·æ‰§è¡Œ\n()è¡¨ç¤ºåœ¨å½“å‰shellåˆå¹¶æ‰§è¡Œ\n{}è¡¨ç¤ºæ´¾ç”Ÿå‡ºä¸€ä¸ªå­shellï¼Œåœ¨å­shellä¸­åˆå¹¶æ‰§è¡Œï¼Œ{ echo \u0026ldquo;aaa\u0026rdquo; }å¿…é¡»æœ‰ç©ºæ ¼\n\u0026amp;è¡¨ç¤ºåå°è¿è¡Œ\nå‘½ä»¤ä¹‹é—´ä½¿ç”¨ \u0026amp;\u0026amp; è¿æ¥ï¼Œå®ç°é€»è¾‘ä¸çš„åŠŸèƒ½ã€‚\n åªæœ‰åœ¨ \u0026amp;\u0026amp; å·¦è¾¹çš„å‘½ä»¤è¿”å›çœŸï¼ˆå‘½ä»¤è¿”å›å€¼ $? == 0ï¼‰ï¼Œ\u0026amp;\u0026amp; å³è¾¹çš„å‘½ä»¤æ‰ä¼šè¢«æ‰§è¡Œã€‚ åªè¦æœ‰ä¸€ä¸ªå‘½ä»¤è¿”å›å‡ï¼ˆå‘½ä»¤è¿”å›å€¼ $? == 1ï¼‰ï¼Œåé¢çš„å‘½ä»¤å°±ä¸ä¼šè¢«æ‰§è¡Œã€‚  \u0026amp;\u0026amp;å·¦è¾¹çš„å‘½ä»¤ï¼ˆå‘½ä»¤1ï¼‰è¿”å›çœŸ(å³è¿”å›0ï¼ŒæˆåŠŸè¢«æ‰§è¡Œï¼‰åï¼Œ\u0026amp;\u0026amp;å³è¾¹çš„å‘½ä»¤ï¼ˆå‘½ä»¤2ï¼‰æ‰èƒ½å¤Ÿè¢«æ‰§è¡Œï¼›æ¢å¥è¯è¯´ï¼Œâ€œå¦‚æœè¿™ä¸ªå‘½ä»¤æ‰§è¡ŒæˆåŠŸ\u0026amp;\u0026amp;é‚£ä¹ˆæ‰§è¡Œç¬¬äºŒä¸ªå‘½ä»¤â€ã€‚\næœ€ä¸‹çš„è¯­æ³•ç”¨äº†seqè€Œä¸æ˜¯forå¾ªç¯ï¼Œæ˜¯å› ä¸ºbusyboxçš„shä¸æ”¯æŒforè¯­æ³•\næ‰€ä»¥æ‰æœ‰å¦‚æ­¤æ€ªå¼‚çš„è¯­æ³•ï¼Œåœ¨å®¹å™¨ä¸­åå°è·‘10ä¸ªphp think queueï¼Œ1ä¸ªcrondï¼Œå‰å°è·‘ä¸€ä¸ªphp-fpmï¼š\n1CMD for i in $(seq 10); do (php think queue \u0026amp;) ; done \u0026amp; crond \u0026amp;\u0026amp; php-fpm   ARG å‚æ•°\nARG VERSION=7.6.1\nå®šä¹‰åå¯ä»¥ç”¨${VERSION}å¼•ç”¨ï¼Œbuildçš„æ—¶å€™å¯ä»¥åŠ \u0026ndash;build-arg ä¼ å‚æ•°è¿›å»\n1docker build --build-arg VERSION=${LATEST} -t $(ORG)/$(NAME):$(BUILD) .   è¿˜æœ‰å¾ˆå¤š Build çš„æŠ€å·§ï¼Œå¦‚æœé€ ä¸€ä¸ª go è¯­è¨€ç¼–è¯‘ç¯å¢ƒçš„ä¸­é—´å±‚é•œåƒï¼Œç„¶åé€ æœ€ç»ˆé•œåƒã€‚\nä½†æ˜¯å…«æˆ’è¿˜æ˜¯æ¨èç›´æ¥é€ å‡ºäºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ï¼Œç„¶åç›´æ¥æ‹·è´è¿›å»å°±å¥½ï¼Œä¸è¦å¼„çš„è¿‡äºéº»çƒ¦ï¼Œä¸­é—´å±‚é‚£ç§é€‚ç”¨äºç”¨æºç  CI/CD ä¸­æ— ç¼–è¯‘ç¯å¢ƒçš„æƒ…å†µã€‚\näºŒã€è°ƒè¯•å®¹å™¨ å¾ˆå¤šæƒ…å†µä¸‹æˆ‘ä»¬é€ å¥½äº† image ï¼Œä¸€è·‘å°±æ‰ä¸‹æ¥äº†ï¼Œä¹Ÿä¸çŸ¥é“æ˜¯ä»€ä¹ˆæƒ…å†µ\nè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬æŠŠ CMD æ¢æˆä¸€ä¸ª sh æ‰§è¡Œä¸€ä¸ªæ­»å¾ªç¯\n1CMD /bin/sh -c \u0026#34;while true; do echo hi; sleep 10; done\u0026#34; ç„¶åè¿›å…¥å®¹å™¨ï¼Œç„¶åå†æ‰§è¡Œä¹‹å‰çš„ CMD å‘½ä»¤ï¼Œçœ‹çœ‹æŠ¥é”™ä¿¡æ¯æ˜¯ä»€ä¹ˆï¼Œå°±å¯ä»¥è°ƒè¯•äº†\n1$ docker exec -it 89174asklja /bin/sh ä¸‰ã€podçš„ç­‰å¾…æŠ€å·§ è¿™é‡Œå¯åŠ¨æ­£å¼çš„podä¹‹å‰ï¼Œå…ˆä¸´æ—¶èµ·äº†ä¸¤ä¸ªå®¹å™¨ç­‰å¾…å…¶ä»–æœåŠ¡çš„å®Œæˆ\n1 containers: 2 - name: myapp-container 3 image: busybox 4 command: [\u0026#39;sh\u0026#39;, \u0026#39;-c\u0026#39;, \u0026#39;echo The app is running! \u0026amp;\u0026amp; sleep 3600\u0026#39;] 5 initContainers: 6 - name: init-myservice 7 image: busybox 8 command: [\u0026#39;sh\u0026#39;, \u0026#39;-c\u0026#39;, \u0026#39;until nslookup myservice; do echo waiting for myservice; sleep 2; done;\u0026#39;] 9 - name: init-mydb 10 image: busybox 11 command: [\u0026#39;sh\u0026#39;, \u0026#39;-c\u0026#39;, \u0026#39;until nslookup mydb; do echo waiting for mydb; sleep 2; done;\u0026#39;] ","date":"2021-10-28","img":"","permalink":"https://bajie.dev/posts/20211028-dockerfile/","series":null,"tags":null,"title":"Dockerfileçš„ç¼–å†™ä¸è°ƒè¯•æŠ€å·§"},{"categories":null,"content":"ç»™åŒäº‹åšäº†ä¸ª PHP æ¥å£ï¼Œè½¬å‘å‘é€çŸ­ä¿¡çš„è¯·æ±‚ï¼ŒåŒæ—¶è¦æŠŠå‘é€è®°å½•å‘é€åˆ°è¿œç¨‹çš„ cacti çš„ syslog å»\nå¾ˆç®€å•ï¼Œä½†æ˜¯ä¹Ÿä¸ç®€å•\né¦–å…ˆæ˜¯ PHP æœåŠ¡å™¨ï¼Œæ˜¯æœ€ç®€åŒ–ç¼–è¯‘çš„ï¼Œphp -m æŸ¥äº†ä¸€ä¸‹\n1php -m 2[PHP Modules] 3Core 4ctype 5curl 6date 7dom 8fileinfo 9filter 10gettext 11hash 12iconv 13json 14libxml 15openssl 16pcre 17PDO 18pdo_sqlite 19Phar 20posix 21Reflection 22session 23SimpleXML 24SPL 25sqlite3 26standard 27tokenizer 28xml 29xmlreader 30xmlwriter 31 32[Zend Modules] å±…ç„¶æ²¡æœ‰ socket æ¨¡å—ï¼Œæ²¡åŠæ³•ï¼Œæ‰¾åˆ°æºä»£ç ï¼Œç¼–è¯‘ä¸€ä¸ªå®‰è£…ï¼ŒåŸæœ‰çš„ php å®‰è£…è·¯å¾„æ˜¯ /export/servers/php\n1$ tar zxvf php-7.4.0.tar.gz 2$ cd php-7.4.0/sockets 3$ /export/servers/php/bin/phpize 4$ ./configure --enable-sockets --with-php-config=/export/servers/php/bin/php-config 5$ make 6$ make install åˆçœ‹äº†ä¸€çœ¼ï¼Œæ˜¯ php-fpmï¼Œå±…ç„¶æ²¡æœ‰ php.ini ï¼Œå¾—ï¼Œå†ç”Ÿæˆä¸€ä¸ªï¼Œæ”¾åœ¨ /export/servers/php/lib/php.ini\n1extension_dir = \u0026#34;/export/servers/php740/lib/php/extensions/no-debug-non-zts-20190902/\u0026#34; 2extension = sockets.so ç„¶åé‡å¯ php-fpm ï¼Œé‡æ–° php -m æ£€æŸ¥ï¼Œå‘ç°æœ‰ socket æ¨¡å—å°± ok äº†ã€‚\næ¥ä¸‹æ¥å°±æ˜¯ php æºä»£ç äº†\n1\u0026lt;?php 2date_default_timezone_set(\u0026#39;Asia/Shanghai\u0026#39;); 3 4function send_remote_syslog($message) { 5 $sock = socket_create(AF_INET, SOCK_DGRAM, SOL_UDP); 6 foreach(explode(\u0026#34;\\n\u0026#34;, $message) as $line) { 7 $syslog_message = \u0026#34;\u0026lt;22\u0026gt;\u0026#34; . date(\u0026#39;M d H:i:s \u0026#39;) . \u0026#39;Qi_an_xin sms_log: \u0026#39; . $line; 8 socket_sendto($sock, $syslog_message, strlen($syslog_message), 0, \u0026#39;172.18.31.6\u0026#39;, 514); 9 } 10 socket_close($sock); 11} 12 13 send_remote_syslog(\u0026#34;ABC éªŒè¯ç : 39792192\u0026#34;); 14?\u0026gt;è¿™æ ·å°±å¯ä»¥äº†ï¼Œä¸Šé¢ä»£ç æ¯”è¾ƒéš¾ç†è§£çš„æ˜¯\u0026lt;22\u0026gt;ï¼Œé‚£æ˜¯æŠ¥é”™çº§åˆ«çš„è®¡ç®—æ–¹æ³•ï¼ŒFacility + Severityï¼š\n1 * Facility values: 2 * 0 kernel messages 3 * 1 user-level messages 4 * 2 mail system 5 * 3 system daemons 6 * 4 security/authorization messages 7 * 5 messages generated internally by syslogd 8 * 6 line printer subsystem 9 * 7 network news subsystem 10 * 8 UUCP subsystem 11 * 9 clock daemon 12 * 10 security/authorization messages 13 * 11 FTP daemon 14 * 12 NTP subsystem 15 * 13 log audit 16 * 14 log alert 17 * 15 clock daemon 18 * 16 local user 0 (local0) (default value) 19 * 17 local user 1 (local1) 20 * 18 local user 2 (local2) 21 * 19 local user 3 (local3) 22 * 20 local user 4 (local4) 23 * 21 local user 5 (local5) 24 * 22 local user 6 (local6) 25 * 23 local user 7 (local7) 26 * 27 * Severity values: 28 * 0 Emergency: system is unusable 29 * 1 Alert: action must be taken immediately 30 * 2 Critical: critical conditions 31 * 3 Error: error conditions 32 * 4 Warning: warning conditions 33 * 5 Notice: normal but significant condition (default value) 34 * 6 Informational: informational messages 35 * 7 Debug: debug-level messages è®¡ç®—æ–¹æ³•å°±æ˜¯ ï¼ˆfacility*8 + severityï¼‰ï¼Œè¿™é‡Œçš„22+0ï¼Œå¯ä»¥ç†è§£æˆ local6 ï¼Œå°±æ˜¯çº§åˆ«6\nå¦‚æœå‘äº†ä¸€ä¸ª \u0026ldquo;local use 4\u0026rdquo; å’Œ Serverity = 5 çš„æ¶ˆæ¯ï¼Œé‚£ä¹ˆå°±æ˜¯ 20Ã—8+5=165 ï¼ŒåŒ…å¤´å°±æ˜¯ \u0026lt;165\u0026gt;\n","date":"2021-10-28","img":"","permalink":"https://bajie.dev/posts/20211028-php_syslog/","series":null,"tags":null,"title":"PHPç¨‹åºå¦‚ä½•å‘é€syslogåˆ°è¿œç¨‹æœåŠ¡å™¨"},{"categories":null,"content":"ç”¨ kubernetes è¶Šå¤šï¼Œç”¨ docker è¶Šå¤šï¼Œå°±æ„ˆå‘æ„Ÿè§‰åˆ°å¥½å¤„å¤šå¤šã€‚\nç®€ç®€å•å•çš„ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œç”¨ docker åŸºæ¿ alphine å°è£…ï¼Œå°±å¯ä»¥è¿è¡Œèµ·ä¸€ä¸ª pod ï¼Œç„¶åæŒ‡å®š deploymentã€svcã€ingressï¼Œå°±å¯ä»¥å°†æœåŠ¡æš´éœ²å‡ºå»ã€‚\nå…¶å®å¾ˆå¤šæƒ…å†µä¸‹å•å¯æ‰§è¡Œæ–‡ä»¶ + systemdä¹Ÿæ˜¯ä¸é”™çš„é€‰æ‹©ã€‚\nè¿™ä¸å°±é‡åˆ°ä¸ªé—®é¢˜ï¼Œghostunnel è¿™ä¸ªè½¯ä»¶ï¼Œgithub åªé‡Šæ”¾å‡ºäº†æºä»£ç ä»¥åŠ windows ã€linux å’Œ mac çš„ä¸‰ä¸ªå¯æ‰§è¡Œç‰ˆæœ¬ã€‚\nå¯æˆ‘çš„æ‰§è¡Œç¯å¢ƒæ˜¯ nanopi ï¼Œæ˜¯ä¸ª arm7 çš„æ¶æ„ï¼Œå°±æ— è®¡å¯æ–½äº†ã€‚\næ— å¥ˆä¸‹ï¼Œåœ¨ nanopi ä¸Šè£…äº† go ï¼Œç¼–è¯‘äº†ä¸ª arm7 çš„å‡ºæ¥ã€‚\nä½†æ˜¯é‡åˆ° vaultwanden ï¼Œrust çš„ï¼Œå°±æ²¡æ³•å¼„äº†ï¼Œvps å¤ªå¼±ï¼Œæ ¹æœ¬æ— æ³•ç”¨ cargo ç¼–è¯‘ã€‚\né‚£æ€ä¹ˆåŠå‘¢ï¼Ÿæ–¹æ³•å¦‚ä¸‹ï¼Œä¸å®‰è£… Docker ï¼Œä¹Ÿå¯ä»¥æŠŠé•œåƒä¸­çš„æ–‡ä»¶æŠ½å–å‡ºæ¥\n1$ mkdir vm 2$ wget https://raw.githubusercontent.com/jjlin/docker-image-extract/main/docker-image-extract 3$ chmod +x docker-image-extract 4$ ./docker-image-extract vaultwarden/server:alpine 5Getting API token... 6Getting image manifest for vaultwarden/server:alpine... 7Fetching and extracting layer a0d0a0d46f8b52473982a3c466318f479767577551a53ffc9074c9fa7035982e... 8Fetching and extracting layer 3a9a529931676767ec84d35ab19774b24bd94e20f6fff7e6bda57ef5f2a66cfc... 9Fetching and extracting layer f9dcfa9aefe67ce52ab2a73e515ea715d242348b8fc338dbe4ca72a853ea0318... 10Fetching and extracting layer 4249d8cece35148b5faca2c6a98d566a271a1996b127b14480793ee8825e43c0... 11Fetching and extracting layer 72f4873a62cc82eaf28905077df3791e3b235bf5d17670e7aff6d5fb5e280739... 12Fetching and extracting layer 8eb772c524f9d998c8c7c92acc5ba96e3e9ebfb175dbb2441fe6e7b7598874f5... 13Fetching and extracting layer 663794f103b44abb8a90e1376dce14735905e2f938b4ca7e0ff379b09cbf6148... 14Image contents extracted into ./output. 15 è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨ output ç›®å½•ä¸‹å¾—åˆ° vaultwarden å’Œ web-vault\nå¦‚æœæˆ‘ä»¬è¦æ‹¿åˆ° arm7 çš„é•œåƒï¼Œè¿˜éœ€è¦å†è´¹ç‚¹åŠ²ï¼Œä»¥ ghostunnel ä¸ºä¾‹ï¼š\nè®¿é—®ï¼š https://hub.docker.com/r/ghostunnel/ghostunnel/tags æ‰¾åˆ° linux/arm/v7 çš„ tagï¼Œ40247f4b49c3 ç‚¹å¼€åï¼Œæ‰¾åˆ° DIGEST: ï¼Œå¤åˆ¶sha256ä»¥åŠåé¢çš„å­—ä¸²ï¼Œsha256:40247f4b49c364046ebf47696dbd31752b4db2ae2b9edf1fd4c52c2573f06e04\næŒ‰å¦‚ä¸‹æ–¹æ³•é‡Šæ”¾å³å¯ï¼š\n1$ ./docker-image-extract ghostunnel/ghostunnel:sha256:40247f4b49c364046ebf47696dbd31752b4db2ae2b9edf1fd4c52c2573f06e04 ä¸ç”¨æ‹…å¿ƒç›®å½•ç»“æ„ï¼Œé‡Šæ”¾å‡ºæ¥çš„æ–‡ä»¶ä¼šæ”¾åˆ°å½“å‰ output ç›®å½•ä¸‹ã€‚\n","date":"2021-10-27","img":"","permalink":"https://bajie.dev/posts/20211027-docker_extract_file/","series":null,"tags":null,"title":"æ²¡æœ‰è£…Dockerå¦‚ä½•ä»é•œåƒä¸­é‡Šæ”¾å‡ºæ–‡ä»¶"},{"categories":null,"content":"ä¸ºä»€ä¹ˆä¼šæœ‰é Docker ç¯å¢ƒè¿™ä¸ªæ€ªå­—çœ¼å‘¢ï¼Ÿ\næ— ä»–ï¼Œå› ä¸ºæ»¡ç½‘æœç´¢åˆ°çš„æ•™ç¨‹éƒ½æ˜¯åœ¨ Docker ç¯å¢ƒä¸‹å®‰è£…ä½¿ç”¨ã€‚\nä½†æ˜¯ç©·å•Šï¼Œå…«æˆ’çš„ vps æ˜¯ä¸ªå•æ ¸ 500m çš„ justhost æœºå™¨ï¼Œä¾¿å®œçš„å¾ˆï¼Œè¿™ç§å»‰ä»·æœºå™¨æ¥è·‘ Dockerï¼ŒåŸºæœ¬è¦å 100Mï¼Œè·‘ä¸å¤ªåŠ¨ã€‚\nè¿™ç§ä¸€ç©·äºŒç™½çš„ç¯å¢ƒï¼Œå°±åªèƒ½æŠŠ Bitwarden ä»å®¹å™¨é‡Œæ‹†å‡ºæ¥ç”¨ã€‚\nå¥½åœ¨ Bitwarden_rs æ˜¯ä¸€ä¸ª rust ç¨‹åºï¼Œå å†…å­˜(16Må·¦å³)å’Œcpuæå°‘ï¼Œæœ¬èº«å°±é€‚åˆåœ¨ systemd ç¯å¢ƒä¸‹è·‘ã€‚\nè¿™é‡Œå°±åˆ©ç”¨ vaultwarden å’Œ traefikï¼Œåœ¨ä¸€å°è€ç ´å°æœåŠ¡å™¨ä¸Šè¿è¡Œã€‚\nç³»ç»Ÿç¯å¢ƒæ˜¯ CentOS 7.9\næ­¥éª¤å¦‚ä¸‹ï¼š\nä¸€ã€ä¸‹è½½bitwarden(vaultwarden) 1wget https://github.com/dani-garcia/vaultwarden/archive/refs/tags/1.23.0.tar.gz äºŒã€å®‰è£…cargoå¹¶ç¼–è¯‘ï¼ˆå¯é€‰ï¼‰ 1yum install -y epel-release 2yum install -y openssl-devel cargo 3 4cd vaultwarden-1.23.0 5cargo build --release --features sqlite ç›´æ¥çˆ†é”™å•Šï¼Œå°å°çš„ vps è¿ç¼–è¯‘éƒ½è¿‡ä¸å»ï¼Œç¼–è¯‘è¿›ç¨‹éƒ½è¢« kill æ‰äº†\nä¸‰ã€ä¸‹è½½vaultwardenä¸»æ–‡ä»¶ ç¼–è¯‘ä¸é€šï¼Œå°±åªèƒ½æƒ³åˆ«çš„åŠæ³•äº†ã€‚Faint\næ‰¾ä¸€å°æœ‰ docker æœºå™¨ï¼Œä»é‡Œé¢æŠŠæ–‡ä»¶éƒ½è§£æå‡ºæ¥å¥½äº†\n1docker pull vaultwarden/server:alpine 2docker create --name vw vaultwarden/server:alpine 3docker cp vw:/vaultwarden . 4docker cp vw:/web-vault . 5docker rm vw è¿™æ ·ä¼šå¾—åˆ°ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ vaultwarden å’Œä¸€ä¸ªç›®å½• web-vault\næˆ‘ä»¬æŠŠè¿™ä¸¤ä¸ªä¸œè¥¿éƒ½æŒªåˆ° /opt/vaultwarden ç›®å½•ä¸‹ï¼Œå¹¶ä¸”å»ºç«‹ data æ–‡ä»¶å¤¹ï¼Œç”¨æ¥å­˜æ”¾è¦ç”Ÿæˆçš„ sqlite3 æ•°æ®æ–‡ä»¶ã€‚\n1mkdir -p /opt/vaultwarden/data 2mv vaultwarden /opt/vaultwarden 3mv web-vault /opt/vaultwarden å››ã€ç”Ÿæˆsystemdå¯åŠ¨æ–‡ä»¶ æ³¨æ„ï¼Œä¸‹é¢æˆ‘ä»¬è®¾ç½®äº† vaultwarden ROCKET_ADDRESS çš„ç›‘å¬åœ°å€æ˜¯ 127.0.0.1 ï¼Œä¸€æ˜¯ä¸ºäº†å®‰å…¨ï¼ŒäºŒæ˜¯ä¸ºäº†ä¸‹ä¸€æ­¥æˆ‘ä»¬æ­å»º traefikï¼Œæ¥åä»£ vaultwarden ç”¨çš„ï¼›å› ä¸ºè®¿é—® vaultwarden å¿…é¡»è¦åŠ è¯ä¹¦ï¼Œè€Œå®ƒæœ¬èº«æ˜¯æ²¡æœ‰è¿™ä¸ªåŠŸèƒ½çš„ï¼Œå¿…é¡»å‰ç½®ä¸€ä¸ª nginx æˆ–è€… haproxy æˆ–è€… traefik æˆ–è€… carddyã€‚\n1cat \u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; /etc/systemd/system/vaultwarden.service  2[Unit] 3Description=Bitwarden 4 5[Service] 6Type=simple 7Restart=always 8Environment=\u0026#34;ROCKET_ADDRESS=127.0.0.1\u0026#34; 9WorkingDirectory=/opt/vaultwarden 10ExecStart=/opt/vaultwarden/vaultwarden 11 12[Install] 13WantedBy=local.target 14EOF äº”ã€é…ç½®traefik 1wget https://github.com/traefik/traefik/releases/download/v2.4.8/traefik_v2.4.8_linux_amd64.tar.gz 2tar zxvf traefik_v2.4.8_linux_amd64.tar.gz 3 4mkdir -p /opt/traefik/dynamic 5mv traefik /opt/traefik ç”Ÿæˆtraefiké…ç½®æ–‡ä»¶ï¼Œåˆ©ç”¨ traefik è‡ªåŠ¨ç”³è¯· Let\u0026rsquo;s encrypt è¯ä¹¦\n1cat \u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; /opt/traefik/traefik.yml 2log: 3 level: DEBUG 4 5api: 6 insecure: false 7 dashboard: true 8 9entryPoints: 10 http: 11 address: \u0026#34;:80\u0026#34; 12 http: 13 redirections: 14 entryPoint: 15 to: https 16 scheme: https 17 https: 18 address: \u0026#34;:443\u0026#34; 19 20certificatesResolvers: 21 letsEncrypt: 22 acme: 23 storage: /opt/traefik/acme.json 24 email: zhangranrui@gmail.com 25 tlsChallenge: {} 26 httpChallenge: 27 entryPoint: http 28 29providers: 30 file: 31 directory: /opt/traefik/dynamic 32 watch: true é…ç½® vaultwarden ä»£ç†\n1cat \u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; /opt/traefik/dynamic/pass.yml 2http: 3 routers: 4 https_01: 5 rule: \u0026#34;Host(`xxx.rendoumi.com`)\u0026#34; 6 service: svc_01 7 tls: 8 certresolver: letsEncrypt 9 http_01: 10 rule: \u0026#34;Host(`xxx.rendoumi.com`)\u0026#34; 11 service: svc_01 12 entryPoints: 13 - http 14 services: 15 svc_01: 16 loadBalancer: 17 servers: 18 - url: \u0026#34;http://localhost:8000\u0026#34; 19EOF è®¾ç½® traefik çš„ systemd å¯åŠ¨æ–‡ä»¶\n1cat \u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; /etc/systemd/system/traefik.service  2[Unit] 3Description=traefik 4 5[Service] 6Type=simple 7Restart=always 8WorkingDirectory=/export/servers/traefik 9ExecStart=/export/servers/traefik/traefik 10 11[Install] 12WantedBy=local.target 13EOF äº”ã€å¯åŠ¨vaultwardenå’Œtraefik 1systemctl daemon-reload 2systemctl enable --now vaultwarden 3systemctl enable --now traefik æ‰“å¼€é¡µé¢ï¼Œæˆ‘ä»¬å°±æˆåŠŸçš„ç”¨ä¸€å°è€ç ´å°æ­å»ºäº†è‡ªå·±çš„å¯†ç ç®¡ç†æœåŠ¡å™¨ï¼ï¼ï¼\n","date":"2021-10-27","img":"","permalink":"https://bajie.dev/posts/20211027-bitwarden/","series":null,"tags":null,"title":"Bitwardenï¼ˆvaultwardenï¼‰å¦‚ä½•åœ¨éDockerç¯å¢ƒä¸‹å®‰è£…ä½¿ç”¨"},{"categories":null,"content":"åœ¨ç”Ÿäº§ç¯å¢ƒæ¥åˆ›å»ºé˜¿é‡ŒACKæ‰˜ç®¡k8sé›†ç¾¤çš„è¿‡ç¨‹ï¼š\nå®Œå…¨ç”¨äºç”Ÿäº§ï¼Œä¸æ˜¯æ­å»ºæ¥åšæµ‹è¯•ç”¨çš„ã€‚\næˆå…¬å¸å§”æ‰˜ï¼Œç»™çš„RAMç”¨æˆ·ï¼Œæ‰€ä»¥é˜¿é‡Œäº‘RAMç¬¬ä¸€æ¬¡ç™»å½•åï¼Œå¼ºåˆ¶ä¿®æ”¹å¯†ç \nç„¶åæˆæƒèµ„æºç®¡ç†ï¼Œ æ­£å¼å¼€å§‹å»ºç«‹è¿‡ç¨‹\nä¸€ã€å‡†å¤‡æ¡ä»¶   ä¸¤å°åŠä»¥ä¸ŠecsæœåŠ¡å™¨\n  é˜¿é‡Œäº‘è´¦æˆ·ä½™é¢100å…ƒä»¥ä¸Šï¼ˆé˜¿é‡Œäº‘è¦æ±‚ï¼‰\n  é˜¿é‡Œäº‘ossä¸€ä¸ªï¼ˆosså’Œecsåœ¨ä¸€ä¸ªåŒºåŸŸæœ€å¥½ï¼‰\n  é¦–å…ˆé˜¿é‡Œäº‘åˆ›å»ºk8sé›†ç¾¤è¦æ±‚è‡³å°‘æœ‰ä¸¤å°ecsæœåŠ¡å™¨ï¼Œå¯ä»¥åˆ›å»ºé›†ç¾¤çš„æ—¶å€™å†è´­ä¹°ï¼Œä¸è¦é¢„å…ˆè´­ä¹°ã€‚\näºŒã€ä¸‹é¢å¼€å§‹åˆ›å»ºï¼š é˜¿é‡Œäº‘æœ€å·¦ä¸Šè§’çš„èœå•ï¼ˆæ–°ç‰ˆæœ¬é¦–é¡µï¼‰-\u0026gt;äº§å“ä¸æœåŠ¡-\u0026gt;å®¹å™¨æœåŠ¡kubernetesç‰ˆæœ¬\nç¬¬ä¸€æ¬¡åˆ›å»ºä¼šè®©å¼€å¯ramæˆæƒï¼Œæ­£å¸¸ç‚¹å‡»æˆæƒå°±å¯ä»¥\nç‚¹å‡»åˆ›å»ºé›†ç¾¤\nç‚¹å‡»åå¦‚ä¸‹\nå„ä¸ªé€‰é¡¹çš„è¯¦ç»†è¯´æ˜ï¼š\nç¬¬ä¸€éƒ¨åˆ†ï¼š\né›†ç¾¤ç‰ˆæœ¬ï¼š æœ€ä¸Šé¢å¯ä»¥é€‰æ‹©ACKæ‰˜ç®¡ç‰ˆï¼Œå’Œå…¶ä»–4ä¸ªç‰ˆæœ¬ï¼Œç€é‡è¯´ä¸€ä¸‹ä¸“æœ‰ç‰ˆå’Œæ‰˜ç®¡ç‰ˆçš„åŒºåˆ«\nä¸“æœ‰ç‰ˆæœ¬ï¼šmasterå’Œworkeréƒ½éœ€è¦è‡ªå·±åˆ›å»ºï¼Œå¦‚æœéœ€è¦é«˜å¯ç”¨ï¼Œé‚£ä¹ˆmasteréœ€è¦è‡³å°‘ä¸‰ä¸ªï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä½ ä¸æƒ³æŠŠmasterå’Œworkeræ”¾åœ¨åŒä¸€å°æœåŠ¡å™¨ä¸Šï¼Œå°±è¦å¤šä½¿ç”¨ä¸‰å°æœåŠ¡å™¨ã€‚\nACKæ‰˜ç®¡ç‰ˆï¼šmasterç”±é˜¿é‡Œäº‘ç»™åˆ›å»ºï¼Œè‡ªå·±åªéœ€è¦è´­ä¹°workeræœåŠ¡å™¨ã€‚\né›†ç¾¤åç§°ï¼š k8s-hbb\nåœ°åŸŸï¼š è¯·é€‰æ‹©è‡ªå·±ecså’Œrdsç­‰èµ„æºæ‰€åœ¨åŒºåŸŸï¼Œè¿™é‡Œæ˜¯åä¸œ2ï¼ˆä¸Šæµ·ï¼‰\nKubernetesç‰ˆæœ¬ï¼šé˜¿é‡Œäº‘å·²ç»åšå¥½å……åˆ†çš„æµ‹è¯•äº†ï¼Œæ‰€ä»¥é€‰æ‹©é»˜è®¤çš„å³å¯ã€‚è¿™é‡Œæ˜¯ 1.18.8-aliyun.1\nå®¹å™¨è¿è¡Œæ—¶ï¼š Docker 19.03.5\nç¬¬äºŒéƒ¨åˆ†ï¼š\nä¸“æœ‰ç½‘ç»œ: ä¸“æœ‰ç½‘ç»œé€‰æ‹©å’Œecsï¼ŒrdsåŒä¸€ä¸ªä¸“æœ‰ç½‘ç»œï¼Œè¿™é‡Œæ˜¯vpc-uf6pcr7nvp3dqmx86yyk0ï¼Œç½‘æ®µæ˜¯172.19.0.0/16\nè™šæ‹Ÿäº¤æ¢æœºï¼š åŒä¸€ä¸ªä¸“æœ‰ç½‘ç»œä¸‹é¢çš„äº¤æ¢æœºæ˜¯å¯ä»¥äº’é€šçš„ï¼Œè¿™é‡Œæ–°å»ºä¸€ä¸ªè™šæ‹Ÿäº¤æ¢æœºï¼Œç½‘æ®µæ˜¯172.19.240.0/20\nç½‘ç»œæ’ä»¶ï¼š é€‰Flannelï¼Œé™¤å»é˜¿é‡Œäº‘è‡ªå·±çš„åŒºåˆ«æè¿°ï¼Œè¿˜æœ‰ä¸€ç‚¹ å¦‚æœä½¿ç”¨flannelæ’ä»¶ï¼Œåˆ™workerç«¯å¯¹å¤–ï¼Œè®¿é—®å¤–ç½‘ï¼ˆæ¯”å¦‚çŸ­ä¿¡æ¥å£ç­‰ï¼‰ä½¿ç”¨çš„æ˜¯worderæ‰€åœ¨ecsè‡ªå·±çš„eipæˆ–è€…å¦‚æœä½¿ç”¨çš„æ˜¯snatæ¨¡å¼ï¼Œå°±æ˜¯snatç»‘å®šçš„eipã€‚å¦‚æœä½¿ç”¨çš„terwayæ’ä»¶åˆ™èµ°çš„å°±æ˜¯snatçš„eipã€‚æ³¨æ„ï¼Œåˆ›å»ºé›†ç¾¤æˆåŠŸåï¼Œä¼šä¸ºé›†ç¾¤åˆ›å»ºä¸€ä¸ªå¯¹å¤–æœåŠ¡çš„ingressçš„slbï¼Œworkerå†…éƒ¨çš„å®¹å™¨ç›´æ¥å¯¹å¤–è®¿é—®ï¼Œä½¿ç”¨çš„ä¸æ˜¯è¿™ä¸ªslbçš„ipã€‚slbåªæ˜¯è¿›æ¥çš„é€šé“ã€‚\npodç½‘ç»œ CIDRï¼šä¸ºç»Ÿä¸€èµ·è§ï¼Œ10.240.0.0/20\nservice CIDRï¼šä¸ºç»Ÿä¸€èµ·è§ï¼Œ192.168.240.0/20\næ³¨æ„ä»¥ä¸Š å»ºç«‹å¥½äº†ä¸‰ä¸ªç½‘æ®µï¼Œä¸‰ä¸ªç½‘æ®µä¸­å‡æœ‰240å­—æ®µï¼Œä¾¿äºè®°å¿†\nECS(2å°)ï¼š172.19.240.0/20\nPODç½‘æ®µï¼š10.240.0.0/20\nServiceç½‘æ®µï¼š192.168.240.0/20 â€‹\nèŠ‚ç‚¹IPæ•°é‡ï¼š256ï¼ŒæŒ‡å•ä¸ªèŠ‚ç‚¹å¯è¿è¡Œ Pod æ•°é‡çš„ä¸Šé™ã€‚ ä¸€å®šè¦æ‹‰åˆ°æœ€å¤§é‡256 ï¼Œå¼„åˆ°16çš„è¯ï¼Œä¸€ä¸ªèŠ‚ç‚¹æœ¬èº«è¦è·‘10å¤šä¸ªsystemçš„podï¼Œå°±æ— æ³•è·‘åº”ç”¨podäº†ã€‚\nç¬¬ä¸‰éƒ¨åˆ†:\né…ç½®SNATï¼šå¿…é€‰é…ç½®SNATï¼Œå¯¹å¤–ä¸»åŠ¨è®¿é—®çš„æ—¶å€™IPéœ€è¦ä¸€è‡´ã€‚è§£é‡Šï¼šå¦‚æœecsæ²¡æœ‰è®¿é—®å¤–ç½‘èƒ½åŠ›ï¼Œåˆ™å¿…é¡»ä½¿ç”¨snatï¼Œsnatå°±æ˜¯æŠŠvpcç»‘å®šä¸€ä¸ªeipï¼Œç„¶åç»™å†…éƒ¨çš„ecsä½¿ç”¨natæ–¹å¼ä¸»åŠ¨å¤–å‡ºè®¿é—®ç”¨çš„ï¼Œæ¯”å¦‚ä¸»åŠ¨åé—®ç¬¬ä¸‰æ–¹çš„æ¥å£ç­‰ã€‚å¦‚æœecsè‡ªå·±å·²ç»ç»‘å®šäº†eipæˆ–è€…è‡ªå¸¦ipå¸¦å®½ï¼Œå¯ä»¥ä¸é€‰æ‹©ã€‚\nAPISERVERè®¿é—®ï¼šå¿…é€‰å…¬ç½‘EIPæš´éœ²ï¼Œè¿™ä¸ªç»‘å®šä»¥åipä¸æ”¶è´¹ï¼Œå¯ä»¥ä½¿ç”¨æµé‡åŒ…ï¼Œç®¡ç†masterç”¨çš„ã€‚å¦‚æœè¦ä½¿ç”¨ã€äº‘æ•ˆã€å¿…é€‰ã€‚\né»˜è®¤ä¸é€‰ä¸­ä½¿ç”¨EIPæš´éœ²API Serverã€‚ API Serveræä¾›äº†å„ç±»èµ„æºå¯¹è±¡ï¼ˆPodï¼ŒServiceç­‰ï¼‰çš„å¢åˆ æ”¹æŸ¥åŠwatchç­‰HTTP Restæ¥å£ã€‚ - å¦‚æœé€‰æ‹©å¼€æ”¾ï¼Œä¼šåˆ›å»ºä¸€ä¸ªEIPï¼Œå¹¶æŒ‚è½½åˆ°å†…ç½‘SLBä¸Šã€‚æ­¤æ—¶ï¼ŒMasterèŠ‚ç‚¹çš„6443ç«¯å£ï¼ˆå¯¹åº”API Serverï¼‰æš´éœ²å‡ºæ¥ï¼Œç”¨æˆ·å¯ä»¥åœ¨å¤–ç½‘é€šè¿‡kubeconfigè¿æ¥å¹¶æ“ä½œé›†ç¾¤ã€‚ - å¦‚æœé€‰æ‹©ä¸å¼€æ”¾ï¼Œåˆ™ä¸ä¼šåˆ›å»ºEIPï¼Œæ‚¨åªèƒ½åœ¨VPCå†…éƒ¨ç”¨kubeconfigè¿æ¥å¹¶æ“ä½œé›†ç¾¤ã€‚\nRDSç™½åå•ï¼šè¿™ä¸ªæ³¨æ„é€‰æ‹©ï¼Œç›®å‰é˜¿é‡Œäº‘æ˜¾ç¤ºå‡ºæ¥çš„åªæœ‰æ™®é€šçš„mysql-rdsï¼Œredisçš„å’Œpolardbçš„éƒ½ä¸æ˜¾ç¤º\nå®‰å…¨ç»„ï¼šé€‰æ‹©ä¼ä¸šç±»å‹å°±å¯ä»¥ï¼ŒåæœŸå¯ä»¥ä¿®æ”¹è§„åˆ™ã€‚\nç¬¬å››éƒ¨åˆ†\nKube-proxyæ¨¡å¼ï¼šé€‰IPVSï¼Œæ¯”IPTABLESæ€§èƒ½é«˜\né›†ç¾¤æœ¬åœ°åŸŸåï¼š hbb.localï¼Œ.localç»“å°¾çš„ç»Ÿç»Ÿæ˜¯æœ¬åœ°åŸŸå\nä¸‹ä¸€æ­¥ï¼Œå¢åŠ worker\nå¿…é¡»é€‰æ–°å¢å®ä¾‹ï¼Œä¸è¦é€‰æ‹©ç°æœ‰å®ä¾‹\næ–°å¢å®ä¾‹ï¼šå°±æ˜¯æ–°è´­ä¹°ecsï¼Œè¦æ³¨æ„è‡ªå·±é€‰æ‹©vpcå’Œäº¤æ¢æœº\né€‰æ‹©å·²æœ‰å®ä¾‹ï¼šå¯ä»¥é€‰æ‹©ç°æœ‰çš„æœåŠ¡å™¨ï¼Œæ³¨æ„ï¼šç°æœ‰æœåŠ¡å™¨ä¼šè¢«æ›´æ¢ç¡¬ç›˜ï¼Œç¡¬ç›˜å†…å®¹ä¼šè¢«æ¸…ç©ºã€‚\nä¼ä¸šçº§å®ä¾‹è§„æ ¼æ—\nå®ä¾‹è§„æ ¼æ—åç§°æ ¼å¼ä¸ºecs.\u0026lt;è§„æ ¼æ—\u0026gt;ï¼Œå®ä¾‹è§„æ ¼åç§°ä¸ºecs.\u0026lt;è§„æ ¼æ—\u0026gt;.largeã€‚\n ecsï¼šäº‘æœåŠ¡å™¨ECSçš„äº§å“ä»£å·ã€‚ \u0026lt;è§„æ ¼æ—\u0026gt;ï¼šç”±å°å†™å­—æ¯åŠ æ•°å­—ç»„æˆã€‚  å°å†™å­—æ¯ä¸ºæŸä¸ªå•è¯çš„ç¼©å†™ï¼Œå¹¶æ ‡å¿—ç€è§„æ ¼æ—çš„æ€§èƒ½é¢†åŸŸã€‚éƒ¨åˆ†å°å†™å­—æ¯çš„å«ä¹‰å¦‚ä¸‹æ‰€ç¤ºã€‚  cï¼šä¸€èˆ¬è¡¨ç¤ºè®¡ç®—å‹ï¼ˆcomputationalï¼‰ gï¼šä¸€èˆ¬è¡¨ç¤ºé€šç”¨å‹ï¼ˆgeneralï¼‰ rï¼šä¸€èˆ¬è¡¨ç¤ºå†…å­˜å‹ï¼ˆramï¼‰ neï¼šä¸€èˆ¬è¡¨ç¤ºç½‘ç»œå¢å¼ºå‹ï¼ˆnetwork enhancedï¼‰   æ•°å­—ä¸€èˆ¬åŒºåˆ«åŒç±»å‹è§„æ ¼æ—é—´çš„å‘å¸ƒæ—¶é—´ã€‚æ›´å¤§çš„æ•°å­—ä»£è¡¨æ–°ä¸€ä»£è§„æ ¼æ—ï¼Œæ‹¥æœ‰æ›´é«˜çš„æ€§ä»·æ¯”ï¼Œä»·æ ¼ä½æ€§èƒ½å¥½ã€‚   largeï¼šnè¶Šå¤§ï¼ŒvCPUæ ¸æ•°è¶Šå¤šã€‚  ä¾‹å¦‚ï¼Œecs.g6.2xlargeè¡¨ç¤ºé€šç”¨å‹g6è§„æ ¼æ—ä¸­çš„ä¸€ä¸ªå®ä¾‹è§„æ ¼ï¼Œæ‹¥æœ‰8ä¸ªvCPUæ ¸ã€‚ç›¸æ¯”äºg5è§„æ ¼æ—ï¼Œg6ä¸ºæ–°ä¸€ä»£é€šç”¨å‹å®ä¾‹è§„æ ¼æ—ã€‚\næŒ‰ä¸Šé¢é€‰ecs.c6.largeï¼Œè´¹ç”¨0.95/æ—¶ï¼Œä¼¼ä¹æ¯”ecs.n1.medium 1.34/æ—¶å¥½ã€‚\nèŠ‚ç‚¹æ•°é‡ï¼šæœ€å°‘æ˜¯2ä¸ªï¼Œæ— æ³•å‡åˆ°0ï¼Œæ²¡åŠæ³•ã€‚\nç³»ç»Ÿç›˜ï¼šé€‰ESSDï¼Œé€Ÿåº¦å¿«ï¼Œ40Gå³å¯ã€‚ä¸è¦å¼€äº‘ç›˜å¤‡ä»½ï¼Œä¼šè¦æ±‚è®¾ç½®snapshotç­–ç•¥ï¼Œè¦æ”¶é’±ã€‚\næ“ä½œç³»ç»Ÿï¼šé€‰CentOS 7.9ï¼Œä¸è¦é€‰aliyunçš„è‡ªå®šä¹‰ç‰ˆæœ¬ã€‚æ›´åŠ æ ‡å‡†åŒ–ï¼Œä¾¿äºå‡çº§ã€‚\nè¿™é‡Œé€‰æ‹©æ“ä½œç³»ç»Ÿçš„æ—¶å€™ï¼Œåªæœ‰ä¸¤ä¸ªç³»ç»Ÿå¯ä»¥é€‰æ‹©ï¼Œä¸€ä¸ªæ˜¯centos7ï¼Œä¸€ä¸ªæ˜¯é˜¿é‡Œäº‘linuxã€‚ä¸ºä»€ä¹ˆæ“ä½œç³»ç»Ÿä¸èƒ½é€‰å¾ˆå¤šç§ï¼Ÿå› ä¸ºé˜¿é‡Œäº‘è¦ä½¿ç”¨Cloud-initè‡ªåŠ¨å®‰è£…dockerçš„å„ç§å·¥å…·åŒ…è¿›ä½œä¸ºworkerè§’è‰²çš„ecsï¼Œæ‰€ä»¥ä»–å¯¹ç³»ç»Ÿçš„è¦æ±‚æ›´é«˜ï¼Œå¦åˆ™å¾ˆå¯èƒ½å‡ºç°å„ç§å„æ ·çš„é—®é¢˜ã€‚è¿™é‡Œæ‰ä¼šæœ‰è¿™ç§é™åˆ¶ã€‚\nå¯†é’¥å¯¹é€‰åˆ™æ–°å»ºä¸€ä¸ªk8s-sshã€‚\nä¸‹ä¸€æ­¥ç»„ä»¶é…ç½®\nå®‰è£…ingressç»„ä»¶ï¼šéœ€è¦å¯¹å¤–æœåŠ¡ï¼Œè¿™ä¸ªå¿…é€‰ï¼Œä¼šç»™åˆ†é…ä¸€ä¸ªslbè´Ÿè½½å‡è¡¡\nå¦‚æœæƒ³K8Sé›†ç¾¤çš„æœåŠ¡ç›´æ¥æä¾›æœåŠ¡ç»™ç”¨æˆ·è®¿é—®ï¼Œå¯ä»¥é€‰æ‹©ã€å…¬ç½‘ã€ï¼Œå®ƒä¼šåˆ›å»ºä¸€ä¸ªSLBå¹¶ç”¨EIPæš´éœ²å…¬ç½‘ï¼Œåç«¯æ˜¯k8s-ingresså…¥å£ã€‚\nè´Ÿè½½ç±»å‹ï¼š å…¬ç½‘ï¼Œå¯¹å¤–æœåŠ¡å°±è¦å†™å…¬ç½‘ã€‚\nå­˜å‚¨æ’ä»¶ï¼š å¿…é€‰CSIï¼Œå¯¹ä¹‹ååˆ›å»ºæ•°æ®å·è¯­æ³•æ²¡å½±å“\nç›‘æ§æ’ä»¶ï¼š åŸºç¡€ç‰ˆæ˜¯å…è´¹çš„ï¼Œå¯ä»¥æ”¾å¿ƒä½¿ç”¨\næ—¥å¿—æœåŠ¡ï¼š æ—¥å¿—æœåŠ¡å¯ä»¥åŠ ï¼Œå°¤å…¶æ˜¯ä»¥åå¦‚æœæƒ³é‡‡é›†å†…éƒ¨dokeré‡Œé¢çš„æ—¥å¿—ï¼Œè¿™é‡Œè¿˜æ˜¯æ¨èåŠ ä¸€ä¸‹æœ€å¥½ï¼Œä»–ä¼šè‡ªåŠ¨åˆ›å»ºæ ‡è®°é‡‡é›†ï¼Œåé¢ä½¿ç”¨è¿™ä¸ªæ ‡è®°å¯ä»¥æ–¹ä¾¿çš„è‡ªåŠ¨æ·»åŠ æ—¥å¿—èŠ‚ç‚¹ã€‚\nslbè´¹ç”¨ï¼š 0.66/å°æ—¶,å¸¦å®½è´¹ç”¨0.8/g\nä¸‹ä¸€æ­¥ç¡®è®¤é…ç½®\næ ¸å¯¹ä¸€ä¸‹æ˜¯å¦å’Œè‡ªå·±é€‰æ‹©çš„ä¸€æ ·\næ ¸å¯¹æ— è¯¯åç‚¹å‡»åˆ›å»ºé›†ç¾¤ã€‚æ³¨æ„ï¼šåˆ›å»ºé›†ç¾¤çš„æ—¶å€™ï¼Œä¼šæ£€æµ‹ä¸€äº›æƒé™ï¼Œå¦‚æœæƒé™æœªå¼€é€šï¼Œå¯ä»¥ä»¤å¼€é¡µé¢è¿›è¡Œå¼€é€šæˆæƒï¼Œæ¯”å¦‚esså¼¹æ€§ä¼¸ç¼©ï¼Œå¼€é€šåç‚¹å°æŒ‰é’®åˆ·æ–°çŠ¶æ€ï¼Œ çŠ¶æ€éƒ½okä»¥åï¼Œç‚¹å‡»åˆ›å»ºé›†ç¾¤ã€‚\nç­‰å¾…ååˆ†é’Ÿå·¦å³é›†ç¾¤åˆ›å»ºæˆåŠŸã€‚åˆ°æ­¤åˆ›å»ºé›†ç¾¤å·²ç»å®Œæˆã€‚\nç„¶ååˆ°æ§åˆ¶å°å¯ä»¥æŸ¥çœ‹ï¼Œè¿™æ ·ACKé›†ç¾¤å°±åˆ›å»ºå¥½äº†ã€‚\nåè®°ï¼š\næ¯æ‰ACKçš„æ—¶å€™ï¼Œåˆ‡å¿Œå»åˆ é™¤arms-promçš„helmï¼Œå†åˆ é™¤acké›†ç¾¤ï¼Œå¦åˆ™ä¼šæ¸…ä¸å¹²å‡€ä¸œè¥¿ã€‚\nä¸‹æ¬¡é‡å»ºçš„æ—¶å€™ä¼šè£…ä¸ä¸Šprometheus\n","date":"2021-10-26","img":"","permalink":"https://bajie.dev/posts/20211026-ack_build/","series":null,"tags":null,"title":"é˜¿é‡Œäº‘ACKå®Œå…¨ç”Ÿäº§ç¯å¢ƒè§„åˆ’å’Œæ­å»º"},{"categories":null,"content":"ä¹‹å‰ä»‹ç»è¿‡å¦‚ä½•åˆ¶ä½œä¸€ä¸ª centos live cdrom ç³»ç»Ÿ\né‚£ä¹ˆï¼ŒæŸäº›æƒ…å†µä¸‹æˆ‘ä»¬å¯èƒ½æ— æ³•å¼„ä¸€ä¸ª pxe ç³»ç»Ÿï¼Œè€Œåªèƒ½é€šè¿‡ idrac æŒ‚è½½ iso çš„æ–¹å¼å®‰è£…ç³»ç»Ÿ\nè¯¥å¦‚ä½•å»åšå‘¢ï¼Ÿ\næ­¥éª¤å¦‚ä¸‹ï¼š\nä¸€ã€ä¸‹è½½Centosçš„minimalå®‰è£…å…‰ç›˜ 1wget http://mirrors.163.com/centos/7.9.2009/isos/x86_64/CentOS-7-x86_64-Minimal-2009.iso 2yum install -y mkisofs äºŒã€å‡†å¤‡kickstartå®‰è£…æ–‡ä»¶ ä¸‹è½½ï¼š centos7.ks 1text 2skipx 3install 4 5auth --useshadow --enablemd5 6authconfig --enableshadow --passalgo=sha512 7 8firstboot --disable 9keyboard us 10lang en_US.UTF-8 11reboot 12cdrom 13 14firewall --disable 15selinux --disabled 16 17services --enabled=\u0026#34;chronyd\u0026#34; 18logging level=info 19 20 21#ignoredisk --only-use=vda 22ignoredisk --only-use=sda 23#bootloader --location=mbr --append=\u0026#34;net.ifnames=0 biosdevname=0 crashkernel=auto\u0026#34; 24bootloader --location=mbr --append=\u0026#34;crashkernel=auto\u0026#34; 25 26rootpw --plaintext Renren2021! 27timezone Asia/Shanghai --isUtc 28 29network --device=lo --hostname=localhost.localdomain 30user --name=supdev --gid=511 --groups=\u0026#34;supdev\u0026#34; --uid=511 --password=\u0026#34;Renren2021!\u0026#34; 31 32zerombr 33clearpart --all --initlabel  34 35part biosboot --fstype=biosboot --size=1 36part /boot --fstype ext4 --size=2048  37part swap --asprimary --size=8192 38part / --fstype ext4 --size=1 --grow 39 40#part biosboot --fstype=biosboot --size=1 41#part /boot --fstype ext2 --size 250 42#part pv.01 --size 1 --grow 43#volgroup vg pv.01 44#logvol / --vgname=vg --size=1 --grow --fstype ext4 --fsoptions=discard,noatime --name=root 45#logvol /tmp --vgname=vg --size=1024 --fstype ext4 --fsoptions=discard,noatime --name=tmp 46#logvol swap --vgname=vg --recommended --name=swap 47 48#uefi 49#partition /boot/efi --asprimary --fstype=vfat --label EFI --size=200 50#partition /boot --asprimary --fstype=ext4 --label BOOT --size=500 51#partition / --asprimary --fstype=ext4 --label ROOT --size=4096 --grow 52 53 54services --enabled=network 55 56reboot 57 58%pre 59parted -s /dev/sda mklabel gpt 60%end 61 62%packages 63@core 64@system-admin-tools 65@additional-devel 66@virtualization-client 67@virtualization-platform 68@virtualization-tools 69libguestfs-tools-c 70perl-Sys-Virt 71qemu-guest-agent 72qemu-kvm-tools 73curl 74dstat 75expect 76openssl 77initscripts 78ipmitool 79lrzsz 80lsof 81mtools 82nc 83nmap 84perl 85perl-CPAN 86procps 87python 88screen 89sysstat 90systemtap 91systemtap-client 92systemtap-devel 93tcpdump 94telnet 95vim 96wget 97wsmancli 98zip 99chrony 100kexec-tools 101net-tools 102ntp 103ntpdate 104man 105acpid 106chrony 107telnet 108%end ä¸‰ã€å‡†å¤‡ç”Ÿæˆisoçš„è„šæœ¬ ä¸‹è½½ï¼š makeiso.sh 1#!/bin/bash 2rm -rf /tmp/bootiso /tmp/bootcustom /tmp/boot.iso 3mkdir /tmp/bootiso 4mount -o loop CentOS-7-x86_64-Minimal-2009.iso /tmp/bootiso 5 6mkdir /tmp/bootcustom 7cp -r /tmp/bootiso/* /tmp/bootcustom 8umount /tmp/bootiso 9rmdir /tmp/bootiso 10 11 12chmod -R u+w /tmp/bootcustom 13 14cp centos7.ks /tmp/bootcustom/isolinux/ks.cfg 15 16sed -i \u0026#39;/menu\\ default/d\u0026#39; /tmp/bootcustom/isolinux/isolinux.cfg 17sed -i \u0026#39;s/^timeout\\ .*/timeout 10/g\u0026#39; /tmp/bootcustom/isolinux/isolinux.cfg 18sed -i \u0026#39;/^label\\ linux/i label\\ kickstart\u0026#39; /tmp/bootcustom/isolinux/isolinux.cfg 19sed -i \u0026#39;/^label\\ linux/i \\ \\ menu\\ label\\ ^Install\\ Using\\ Kickstart\\ CentOS 7\u0026#39; /tmp/bootcustom/isolinux/isolinux.cfg 20sed -i \u0026#39;/^label\\ linux/i \\ \\ menu\\ default\u0026#39; /tmp/bootcustom/isolinux/isolinux.cfg 21sed -i \u0026#39;/^label\\ linux/i \\ \\ kernel\\ vmlinuz\\ biosdevname=0\u0026#39; /tmp/bootcustom/isolinux/isolinux.cfg 22sed -i \u0026#39;/^label\\ linux/i \\ \\ append\\ initrd=initrd.img\\ ks=cdrom:\\/ks.cfg\u0026#39; /tmp/bootcustom/isolinux/isolinux.cfg 23sed -i \u0026#39;/^label\\ linux/i \\\\n\u0026#39; /tmp/bootcustom/isolinux/isolinux.cfg 24 25cd /tmp/bootcustom 26mkisofs -o /tmp/boot.iso -b isolinux.bin -c boot.cat -no-emul-boot -boot-load-size 4 -boot-info-table -V \u0026#34;CentOS 7 x86_64\u0026#34; -R -J -v -T isolinux/. . ç”Ÿæˆçš„è‡ªåŠ¨å®‰è£…å…‰ç›˜æ–‡ä»¶åœ¨ /tmp/boot.iso ï¼Œåœ¨ idrac ä¸­ mount å‡ºæ¥ï¼Œå°±å¯ä»¥ç”¨ virtual CD-ROM è‡ªåŠ¨å®‰è£…äº†\n","date":"2021-10-25","img":"","permalink":"https://bajie.dev/posts/20211025-autoinstall_cd/","series":null,"tags":null,"title":"Centos Auto Install Cdromè‡ªåŠ¨å®‰è£…cdromçš„åˆ¶ä½œ"},{"categories":null,"content":"ä¸ºäº†ç ”å‘æ–¹ä¾¿å°±ç»™ä»–ä»¬åœ¨å†…ç½‘å¼€é€šäº† vsftpd çš„æœåŠ¡ã€‚\nç»“æœ java ç›´æ¥æœ‰å°å¥½çš„ ftp library å¯ç”¨ï¼Œå¤§å®¶å°±ç›´æ¥ç”¨äº†ã€‚\nå¯¼è‡´ä»»ä½•å•ç‹¬çš„ä¸€ä¸ªæ–‡ä»¶ä¸Šä¼ éƒ½ä¼šèµ·ä¸€ä¸ª ftp å®ä¾‹ï¼Œæ²¡æœ‰å¤ç”¨ ftp çš„ socket é“¾æ¥ ã€‚ç³»ç»ŸæŒ¤å‹äº†å¤§é‡çš„socketè¿æ¥ã€‚\nçƒ¦æ¼å•Šï¼Œå‡ºäº†äº‹å°±éº»çƒ¦ã€‚éœ€è¦æŠŠæ—¥å¿—éƒ½è¯¦ç»†è®°ä¸‹æ¥\nåšæ³•å¦‚ä¸‹ï¼š\n1vi /etc/vsftp/vsftpd.conf 2...... 3dual_log_enable=YES 4log_ftp_protocol=YES 5xferlog_enable=YES 6xferlog_std_format=NO 7...... è§£é‡Šä¸€ä¸‹ï¼š\n  dual_log_enable \u0026mdash; å’Œ xferlog_enable ååŒï¼Œä¼šå†™ä¸¤ä»½æ—¥å¿—ï¼Œä¸€ä»½åˆ°/var/log/xferlogï¼Œä¸€ä»½åˆ°/var/log/vsftpd.log\n  log_ftp_protocol \u0026mdash; å’Œ xferlog_enable ååŒï¼ŒåŒæ—¶xferlog_std_formatéœ€è¦è®¾ç½®ä¸ºNOï¼Œè¿™æ ·æ‰€æœ‰çš„ FTP å‘½ä»¤éƒ½ä¼šè®°å½•ä¸‹æ¥ã€‚\n  è¿™æ ·æ‰€æœ‰äººçš„æ“ä½œéƒ½ä¼šè¢«è®°å½•ä¸‹æ¥ï¼Œå°±åé¡¾æ— å¿§äº†ã€‚\n","date":"2021-10-25","img":"","permalink":"https://bajie.dev/posts/20211025-vsftpd/","series":null,"tags":null,"title":"Vsftpdçš„æ—¥å¿—è®¾ç½®"},{"categories":null,"content":"ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬è¦æ­å»ºä¸€ä¸ªæ­£å¼çš„pxeè‡ªåŠ¨è£…æœºç³»ç»Ÿï¼Œéœ€è¦è£… dnsmasq åš dhcp + tftp ï¼Œéœ€è¦ç¼–è¯‘ ipxe æ¥è·å¾— undionly.kpxe ï¼Œéœ€è¦ http æœåŠ¡å™¨æ¥æä¾›èµ„æºä¸‹è½½ï¼Œrepo åŒæ­¥æœåŠ¡æ¥æä¾› repoã€‚ç»„ä»¶éå¸¸å¤šï¼Œä¹Ÿæ¯”è¾ƒéº»çƒ¦ã€‚\nå½“ç„¶ï¼Œè¿™ä¹ˆå¤šä¹Ÿæ˜¯æœ‰å¿…è¦çš„ï¼Œå› ä¸ºå¯ä»¥æŒç»­æä¾›ä¸€ä¸ªç¨³å®šçš„è£…æœºç³»ç»Ÿã€‚\nåœºæ™¯ä¸€æ¢ï¼Œå¦‚æœæˆ‘ä»¬åœ¨æœ¬åœ°æœºæˆ¿é‡Œï¼Œä»€ä¹ˆéƒ½æ²¡æœ‰ï¼Œæƒ³æ­ä¸€å¥—ç¯å¢ƒçš„æ­¥éª¤å°±æ¯”è¾ƒç¹å¤äº†ã€‚\nPyPXE å°±æ˜¯éå¸¸ç®€å•çš„ä¸€ä¸ªç¨‹åºï¼Œå±…ç„¶è‡ªå·±å®ç°äº†ç”¨äº PXE çš„ dhcpã€tftp å’Œ http å…¨éƒ¨çš„åŠŸèƒ½ï¼Œè€Œä¸”æ”¯æŒ iPXEã€‚\nå¤ªç‰›é€¼äº†ï¼Œå‰æå•Šï¼ŒPyPXE æ˜¯åŸºäº Python 2.7 çš„ï¼ŒPython 3.xæ˜¯è¿è¡Œä¸äº†çš„ã€‚\næƒ³è®©å®ƒè·‘èµ·æ¥è¿˜å¿…é¡»åšä¸€å®šçš„ä¿®æ”¹ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š\nä¸€ã€ä¸‹è½½PyPXE 1git clone https://github.com/pypxe/PyPXE.git 2cd PyPXE ä¸‹è½½å°±è¡Œäº†ï¼Œä¸ç”¨å®‰è£…ã€‚\näºŒã€æ‰‹åŠ¨ç”Ÿæˆconfig.jsoné…ç½®æ–‡ä»¶ 1{ 2 \u0026#34;DHCP_SERVER_IP\u0026#34;: \u0026#34;192.168.85.27\u0026#34;, 3 \u0026#34;DHCP_FILESERVER\u0026#34;: \u0026#34;192.168.85.27\u0026#34;, 4 5 \u0026#34;DHCP_OFFER_BEGIN\u0026#34;: \u0026#34;192.168.85.200\u0026#34;, 6 \u0026#34;DHCP_OFFER_END\u0026#34;: \u0026#34;192.168.85.250\u0026#34;, 7 \u0026#34;DHCP_SUBNET\u0026#34;: \u0026#34;255.255.255.0\u0026#34;, 8 \u0026#34;DHCP_ROUTER\u0026#34;: \u0026#34;192.168.85.1\u0026#34;, 9 \u0026#34;DHCP_DNS\u0026#34;: \u0026#34;114.114.114.114\u0026#34;, 10 11 \u0026#34;DHCP_SERVER_PORT\u0026#34;: 67, 12 \u0026#34;DHCP_BROADCAST\u0026#34;: \u0026#34;\u0026#34;, 13 \u0026#34;DHCP_MODE_PROXY\u0026#34;: false, 14 \u0026#34;DHCP_WHITELIST\u0026#34;: false, 15 \u0026#34;HTTP_PORT\u0026#34;: 80, 16 \u0026#34;LEASES_FILE\u0026#34;: \u0026#34;\u0026#34;, 17 \u0026#34;MODE_DEBUG\u0026#34;: \u0026#34;dhcp\u0026#34;, 18 \u0026#34;MODE_VERBOSE\u0026#34;: \u0026#34;\u0026#34;, 19 \u0026#34;NBD_BLOCK_DEVICE\u0026#34;: \u0026#34;\u0026#34;, 20 \u0026#34;NBD_COPY_TO_RAM\u0026#34;: false, 21 \u0026#34;NBD_COW\u0026#34;: true, 22 \u0026#34;NBD_COW_IN_MEM\u0026#34;: false, 23 \u0026#34;NBD_PORT\u0026#34;: 10809, 24 \u0026#34;NBD_SERVER_IP\u0026#34;: \u0026#34;0.0.0.0\u0026#34;, 25 \u0026#34;NBD_WRITE\u0026#34;: false, 26 \u0026#34;NETBOOT_DIR\u0026#34;: \u0026#34;netboot\u0026#34;, 27 \u0026#34;NETBOOT_FILE\u0026#34;: \u0026#34;boot.http.ipxe\u0026#34;, 28 \u0026#34;STATIC_CONFIG\u0026#34;: \u0026#34;\u0026#34;, 29 \u0026#34;SYSLOG_PORT\u0026#34;: 514, 30 \u0026#34;SYSLOG_SERVER\u0026#34;: null, 31 \u0026#34;USE_DHCP\u0026#34;: true, 32 \u0026#34;USE_HTTP\u0026#34;: true, 33 \u0026#34;USE_IPXE\u0026#34;: true, 34 \u0026#34;USE_TFTP\u0026#34;: true 35} ä¸Šé¢jsonæ–‡ä»¶æ— æ³•åŠ æ³¨è§£ï¼Œæˆ‘ä»¬æŠŠå®ƒåˆ†ä¸‰éƒ¨åˆ†\n  æœ¬æœºé…ç½®ï¼Œæœ¬æœºçš„åœ°å€éƒ½æ˜¯ 192.168.85.27\n  dhcp çš„é…ç½®ï¼Œå¼€å§‹192.168.85.200ï¼Œç»“æŸ192.68.85.250ï¼Œæ©ç 255.255.255.0ï¼Œç½‘å…³192.168.85.1ï¼ŒDNS114.114.114.114\n  ç¬¬ä¸‰éƒ¨åˆ†ä¸ç”¨åŠ¨\n  ä¸‰ã€ä¸‹è½½ISOå¹¶ä¿®æ”¹ipxeè„šæœ¬ 1cd netboot 2wget http://mirrors.163.com/rocky/8/isos/x86_64/Rocky-8.4-x86_64-dvd1.iso 3mkdir rocky8.iso 4mount -o loop Rocky-8.4-x86_64-dvd1.iso rocky8.iso 5 6cat \u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; boot.http.ipxe 7#!ipxe 89:start 10menu PXE Boot Options 11item shell iPXE shell 12item Rocky8 Install rocky8 13item exit Exit to BIOS 1415choose --default rocky8 --timeout 5000 option \u0026amp;\u0026amp; goto ${option} 16:shell 17shell 181920:rocky8 21set root http://192.168.85.27/rocky8.iso 22initrd ${root}/images/pxeboot/initrd.img 23kernel ${root}/images/pxeboot/vmlinuz inst.repo=${root}/ initrd=initrd.img ip=dhcp 24boot 252627:exit 28exit 29EOF ä¸‰ã€ä¿®æ”¹æºä»£ç  è¿è¡Œä¸€ä¸‹ï¼š\n1python -m pypxe.server --config config.json --debug all --verbose all å¦‚æœæˆ‘ä»¬èµ·ä¸€å°æœºå™¨æˆ–è€…è™šæœºï¼Œä¼šæŠ¥ç¬¬ä¸€ä¸ªé”™ï¼š\nUnicodeDecodeError: \u0026lsquo;ascii\u0026rsquo; codec can\u0026rsquo;t decode byte 0xc0 in position 0: ordinal not in range(128)\nè¿™ä¸ªæ˜¯ä»£ç æŠ¥é”™ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹ä¸€ä¸‹\n1vi pypxe/dhcp.py 2 3 def tlv_encode(self, tag, value): 4 \u0026#39;\u0026#39;\u0026#39;Encode a TLV option.\u0026#39;\u0026#39;\u0026#39; 5 6 # æ³¨é‡Šæ‰ä¸‹é¢çš„ä¸¤è¡Œï¼Œæˆ‘ä»¬ä¸éœ€è¦æ‰“å°å‡ºæˆ‘ä»¬ä¸€å®šèƒ½çœ‹æ‡‚çš„å­—ç¬¦ï¼Œéƒ½æŒ‰byteså¤„ç†å³å¯ 7 #if type(value) is str: 8 # value = value.encode(\u0026#39;ascii\u0026#39;) 9 value = bytes(value) 10return struct.pack(\u0026#39;BB\u0026#39;, tag, len(value)) + value ç„¶åæˆ‘ä»¬éœ€è¦ä¿®æ”¹ç¬¬äºŒä¸ªåœ°æ–¹ï¼Œç†ç”±æ˜¯è¿™ä¸ª PyPXE ä¼šåˆ¤æ–­ Client å‘è¿‡æ¥çš„ dhcp è¯·æ±‚ï¼Œå®ƒåªå®ç°äº†é’ˆå¯¹PXE-Clientçš„ Vendor-classï¼š\næ‰€ä»¥æˆ‘ä»¬ä¹Ÿè¦å±è”½ä¸€ä¸‹ï¼Œå¦åˆ™æŒ‰ç…§æ­£å¸¸è¿‡ç¨‹\nå®¢æˆ·ç«¯dhcp \u0026ndash;\u0026gt; PyPXE åï¼ŒPyPXE é€å›å®¢æˆ· ipxe è„šæœ¬ï¼Œç„¶åå®¢æˆ·å®‰è£…ï¼Œå½“åŠ è½½äº†vmlinuzå’Œinitrdä¹‹åä¼šè¿›å…¥anaconda-linuxè¿›è¡Œç³»ç»Ÿå®‰è£…ï¼Œè¿‡ç¨‹ä¸­ä¼šå†æ¬¡å‘DHCPæœåŠ¡å™¨ç”³è¯·IPåœ°å€ï¼Œ è¿™ä¸ªæ—¶å€™ä»–å‘DHCP Serverå‘å‡ºçš„discoverç”³è¯·æ˜¯å¾—ä¸åˆ°å›å¤çš„ï¼Œå› æ­¤å®‰è£…è¿‡ç¨‹å°†è¢«æ‰“æ–­ã€‚\n1vi pypxe/dhcp.py 2 3 def validate_req(self, client_mac): 4 # client request is valid only if contains Vendor-Class = PXEClient 5 \u0026#39;\u0026#39;\u0026#39;ä»£ç æ•´ä¸ªæ³¨é‡Šæ‰ï¼Œç›´æ¥è¿”å› True 6 if self.whitelist and self.get_mac(client_mac) not in self.get_namespaced_static(\u0026#39;dhcp.binding\u0026#39;): 7 self.logger.info(\u0026#39;Non-whitelisted client request received from {0}\u0026#39;.format(self.get_mac(client_mac))) 8 return False 9 if 60 in self.options[client_mac] and \u0026#39;PXEClient\u0026#39;.encode() in self.options[client_mac][60][0]: 10 self.logger.info(\u0026#39;PXE client request received from {0}\u0026#39;.format(self.get_mac(client_mac))) 11 return True 12 self.logger.info(\u0026#39;Non-PXE client request received from {0}\u0026#39;.format(self.get_mac(client_mac))) 13 return False 14 \u0026#39;\u0026#39;\u0026#39; 15 return True è¿™æ ·ä¿®æ”¹åï¼Œå°±å¯ä»¥æ­£å¸¸å®‰è£…äº†ã€‚\næœåŠ¡å™¨å¯åŠ¨ï¼š\nå®¢æˆ·ç«¯å¯åŠ¨pxeå¼€å§‹å®‰è£…ï¼Œçœ‹ä¸‹é¢ï¼Œç³»ç»Ÿçš„ipxe dhcpä¸€æ¬¡ï¼Œç„¶åchainload.kpxe åˆä¸€æ¬¡ï¼Œanaconda åˆä¸€æ¬¡ï¼Œæœ€å°‘ä¼šå‘ä¸‰æ¬¡æˆ–æ›´å¤šçš„dhcpè¯·æ±‚ã€‚\nç”¨ VNC è¿è¿›å»å¯ä»¥çœ‹åˆ°å®‰è£…ç”»é¢ï¼Œå¦‚æœæ˜¯ kickstart å°±æ˜¯å…¨è‡ªåŠ¨å®‰è£…äº†ã€‚\n","date":"2021-10-22","img":"","permalink":"https://bajie.dev/posts/20211022-pypxe/","series":null,"tags":null,"title":"PyPXE-ä¸€ä¸ªç‰›é€¼çš„ä¸€ç«™å¼PXEå®‰è£…åŒ…"},{"categories":null,"content":"ä¸Šä¸€ç¯‡æ–‡ç« æˆ‘ä»¬ä»‹ç»äº† ETCD çš„å®¹å™¨åŒ–ï¼Œæè¿™ä»¶äº‹æƒ…çš„ä¸»è¦ç›®çš„å…¶å®æ˜¯è¦åŠ¨æ€æ›´æ–° Nginx çš„é…ç½®\nè¿™ä¸€ç« æˆ‘ä»¬å°±æ¥é…ç½® confd å’Œ Nginxï¼Œæ¥è¾¾åˆ°åŠ¨æ€æ›´æ–° Nginx é…ç½®çš„ç›®çš„\nä¸€ã€å®‰è£…é…ç½®confd ä¸‹è½½å¹¶å®‰è£…ï¼š\n1wget https://github.com/kelseyhightower/confd/releases/download/v0.16.0/confd-0.16.0-linux-amd64 2mv confd-0.16.0-linux-amd64 /usr/sbin/confd 3chmod +x /usr/sbin/confd ç”Ÿæˆé…ç½®æ–‡ä»¶ï¼š\næˆ‘ä»¬åœ¨ etcd ä¸­å­˜æ”¾çš„æ ¼å¼å¦‚ä¸‹\n1etcdctl set /nginx/app01/subdomain app1 2etcdctl set /nginx/app01/upstream/app01_1 \u0026#34;192.168.0.1:5601\u0026#34; 3 4/nginx/app01/subdomain \u0026#34;app01\u0026#34; 5/nginx/app01/upstream/app01_1 \u0026#34;192.168.0.1:5601\u0026#34; 6/nginx/app01/upstream/app01_2 \u0026#34;192.168.0.2:5601\u0026#34; é‚£ä¹ˆï¼Œæˆ‘ä»¬å…ˆç”Ÿæˆ confd çš„é…ç½®æ–‡ä»¶ï¼š\n1mkdir -p /etc/confd/{conf.d,templates} 2 3cat \u0026lt;\u0026lt;EOF\u0026gt;\u0026gt;/etc/confd/conf.d/nginx.toml 4[template] 5src = \u0026#34;nginx.conf.tmpl\u0026#34; 6dest = \u0026#34;/etc/nginx/conf.d/nginx-auto.conf\u0026#34; 7keys = [ 8\u0026#34;/nginx/app01/subdomain\u0026#34;, 9\u0026#34;/nginx/app01/upstream\u0026#34;, 10] 11check_cmd = \u0026#34;/usr/sbin/nginx -t\u0026#34; 12reload_cmd = \u0026#34;/usr/sbin/nginx -s reload\u0026#34; 13EOF 14 15cat \u0026lt;\u0026lt;EOT\u0026gt;\u0026gt;/etc/confd/templates/nginx.conf.tmpl 16upstream {{getv \u0026#34;/nginx/app01/subdomain\u0026#34;}} { 17{{range getvs \u0026#34;/nginx/app01/upstream/*\u0026#34;}} 18server {{.}}; 19{{end}} 20} 2122server { 23server_name {{getv \u0026#34;/nginx/app01/subdomain\u0026#34;}}.example.com; 24location / { 25proxy_pass http://{{getv \u0026#34;/nginx/app01/subdomain\u0026#34;}}; 26proxy_redirect off; 27proxy_set_header Host $host; 28proxy_set_header X-Real-IP $remote_addr; 29proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 30} 31} 32EOT 33 confd ä¼šæ ¹æ® etcd çš„å€¼ï¼Œç»“åˆ nginx.conf.tmpl ï¼Œç”Ÿæˆ nginx-auto.confï¼Œç„¶å nginx -t éªŒè¯é€šè¿‡åï¼Œæ‰§è¡Œ nginx -s roladã€‚\næ³¨æ„ï¼šnginxçš„é…ç½®ä¸­å¿…é¡»æœ‰ include /etc/nginx/conf.d/*.conf;\näºŒã€è¿è¡Œconfd 1# åªå¤„ç†ä¸€æ¬¡ 2confd -onetime -backend etcd -node http://etcd-svc.default:2379 3 4# æŒ‰æ—¶é—´è½®è¯¢ 5confd -interval=60 -backend etcd -node http://etcd-svc.default:2379 \u0026amp; 6 è¿™æ ·å°±å¯ä»¥åŠ¨æ€æ›´æ–° Nginx äº†ã€‚\n","date":"2021-10-21","img":"","permalink":"https://bajie.dev/posts/20211021-etcd_confd_nginx/","series":null,"tags":null,"title":"ETCD + CONFD + NGINXçš„é…ç½®"},{"categories":null,"content":"ç”±äºä½¿ç”¨åˆ°äº†é˜¿é‡Œçš„ K8S æ‰˜ç®¡é›†ç¾¤ ACKï¼Œäºæ˜¯æƒ³å ä¾¿å®œã€‚æƒ³ç”¨åˆ°æ‰˜ç®¡ master node çš„ etcd æ¥ä¿å­˜æ•°æ®ã€‚\nç»“æœæ˜¯ï¼Œæœªé‚ï¼ï¼æ— æ³•ä½¿ç”¨ã€‚\né˜¿é‡Œæœ‰å•ç‹¬çš„é…ç½®ç®¡ç†æœåŠ¡ï¼Œå¤æ‚åŒ–äº†ï¼Œä¸æƒ³ç”¨ã€‚\né‚£ä¹ˆè§£å†³æ–¹æ¡ˆå°±æ˜¯ï¼Œå¯åŠ¨åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹å‰¯æœ¬çš„ etcd podï¼Œç„¶åæ•°æ®æŒä¹…åŒ–åˆ° OSS çš„ S3 æ¡¶ä¸­ã€‚\nä¸€ã€å®ç°etcdçš„å•èŠ‚ç‚¹dockeråŒ– é¦–å…ˆæˆ‘ä»¬åªæƒ³åœ¨æµ‹è¯•ç¯å¢ƒä¸­è·‘ä¸€ä¸ªå•èŠ‚ç‚¹çš„ etcdï¼Œè¿˜æ²¡æœ‰ç”¨åˆ° k8sï¼Œåšæ³•å¦‚ä¸‹ï¼š\n1#!/bin/bash 2 3NODE1=172.18.31.33 4REGISTRY=quay.io/coreos/etcd 5# available from v3.2.5 6#REGISTRY=gcr.io/etcd-development/etcd 7 8docker run \\ 9 -p 2379:2379 \\ 10 -p 2380:2380 \\ 11 --volume=/data/etcd:/etcd-data \\ 12 --name etcd ${REGISTRY}:latest \\ 13 /usr/local/bin/etcd \\ 14 --data-dir=/etcd-data --name node1 \\ 15 --initial-advertise-peer-urls http://${NODE1}:2380 --listen-peer-urls http://0.0.0.0:2380 \\ 16 --advertise-client-urls http://${NODE1}:2379 --listen-client-urls http://0.0.0.0:2379 \\ 17 --initial-cluster node1=http://${NODE1}:2380 18 19 å¦‚ä¸Šå°±å¯ä»¥äº†ï¼Œå®¹å™¨è·‘èµ·æ¥ä»¥åè¿›å…¥å®¹å™¨æµ‹è¯•ä¸€ä¸‹ï¼š\n1docker exec -it 425f26903466 /bin/sh 2 3etcdctl -C http://127.0.0.1:2379 member list 4c3511611548b7c7c: name=node1 peerURLs=http://172.18.31.33:2380 clientURLs=http://172.18.31.33:2379 isLeader=true 5 6etcdctl ls --recursive / è¿™æ ·ä¸€ä¸ªå•èŠ‚ç‚¹çš„ etcd å°±å¼„å¥½äº†ï¼Œå¯¹å¤–æš´éœ²çš„æ˜¯ 2379 å’Œ 2380 ç«¯å£\näºŒã€å®ç° etcd çš„å•èŠ‚ç‚¹ k8s åŒ– é¦–å…ˆç¼–å†™ä¸€ä¸ªdeploymentæ–‡ä»¶etcd-deploy.yamlï¼š\nä¸‹è½½ï¼šetcd-deploy.yaml 1apiVersion: apps/v1  2kind: Deployment  3metadata:  4 name: etcd-deploy 5 labels:  6 app: etcd 7spec:  8 replicas: 1  9 selector:  10 matchLabels:  11 app: etcd 12 template:  13 metadata:  14 labels:  15 app: etcd 16 spec:  17 containers:  18 - name: etcd 19 image: quay.io/coreos/etcd:latest 20 ports: 21 - containerPort: 2379 22 name: client 23 protocol: TCP 24 - containerPort: 2380 25 name: server 26 protocol: TCP 27 command: 28 - /usr/local/bin/etcd 29 - --name 30 - etcd 31 - --initial-advertise-peer-urls 32 - http://etcd:2380 33 - --listen-peer-urls 34 - http://0.0.0.0:2380 35 - --listen-client-urls 36 - http://0.0.0.0:2379 37 - --advertise-client-urls 38 - http://etcd:2379 39 - --initial-cluster 40 - etcd=http://etcd:2380 41- --data-dir 42- /etcd-data 43volumeMounts: 44- mountPath: /etcd-data 45name: etcd-data 46lifecycle: 47postStart: 48exec: 49command: 50- \u0026#34;sh\u0026#34; 51- \u0026#34;-c\u0026#34; 52- \u0026gt; 53echo \u0026#34;127.0.0.1 etcd\u0026#34; \u0026gt;\u0026gt; /etc/hosts; 54volumes: 55- name: etcd-data 56persistentVolumeClaim: 57claimName: k8s-etcd-20g 58restartPolicy: Always æ³¨æ„ä¸Šé¢ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ª pvc å· k8s-etcd-20gï¼Œè¿™ä¸ªå·æŒ‚åœ¨ /etcd-dataï¼Œæ˜¯ç”± OSS å»ºç«‹çš„ï¼Œç”¨äºæŒä¹…è¯æ•°æ®ï¼Œçœå¾—é‡å¯ etcd çš„ podï¼Œæ•°æ®æ¶ˆå¤±ä¸è§äº†ã€‚\nç„¶åï¼Œæˆ‘ä»¬éœ€è¦æŠŠè¿™ä¸ª deployment ä½œä¸º svc æœåŠ¡æš´éœ²åœ¨é›†ç¾¤ä¸­ï¼Œå†ç¼–å†™ä¸€ä¸ªetcd-svc.yaml\nä¸‹è½½ï¼šetcd-svc.yaml 1apiVersion: v1 2kind: Service 3metadata: 4 name: etcd-svc 5spec: 6 ports: 7 - port: 2379 8 name: tcp2379 9 protocol: TCP 10 targetPort: 2379 11 - port: 2380 12 name: tcp2380 13 protocol: TCP 14 targetPort: 2380 15 selector: 16 app: etcd 17 type: ClusterIP kubectl apply éƒ¨ç½²åˆ° k8s ä¸­ï¼Œè¿™æ ·å°±å¯ä»¥äº†ã€‚\nk8sæµ‹è¯•æ–¹æ³•ï¼Œéšä¾¿å¯åŠ¨ä¸€ä¸ª busybox podï¼Œè¿›å»æµ‹è¯•ä¸€ä¸‹ï¼š\n1kubectl run curl --image=radial/busyboxplus:curl -i --tty --rm 2 3curl http://etcd-svc:2379/version 4 5curl http://etcd-svc.default:2379/version 6 7curl http://etcd-svc.default:2379/v2/keys 8 9curl http://etcd-svc.default:2379/v2/keys/?recursive=true 10 11curl http://etcd-svc.default:2379/v2/keys/service/nginx 12 13curl http://etcd-svc.default:2379/v2/keys/service/nginx/127.0.0.1 14 15curl --location --request PUT \u0026#39;http://etcd-svc:2379/v2/keys/service/nginx/10.240.0.41\u0026#39; --header \u0026#39;Content-Type: application/x-www-form-urlencoded\u0026#39; --data-urlencode \u0026#39;value=10.240.0.41:9000\u0026#39; 16 17curl http://etcd-svc.default:2379/v2/keys/service/nginx/ ","date":"2021-10-21","img":"","permalink":"https://bajie.dev/posts/20211021-etcd_docker/","series":null,"tags":null,"title":"Etcdå•èŠ‚ç‚¹åº”ç”¨"},{"categories":null,"content":"åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æˆ‘ä»¬å¤§é‡ä½¿ç”¨äº† kvm çš„è™šæ‹ŸæŠ€æœ¯ï¼Œè™šæ‹Ÿæœºçš„é•œåƒç³»ç»Ÿä½¿ç”¨çš„æ˜¯ Cloud-init çš„æŠ€æœ¯\nä¸å¯é¿å…çš„ï¼Œè™šæœºä¼šé­åˆ°å„ç§æŸåï¼Œç»´æŠ¤çš„æ‰‹æ®µå°±ååˆ†å¿…è¦äº†\nå‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªè™šæœºæ–‡ä»¶ vis-16-41-18.qcow2 åäº†\nä¸€ã€å®‰è£…æ”¯æŒåŒ… 1yum install libguestfs libguestfs-tools äºŒã€æŸ¥çœ‹æ—¥å¿— 1virt-log -a vis-16-41-18.qcow2 æ²¡æœ‰ä»€ä¹ˆç‰¹æ®Šçš„æŠ¥é”™ä¿¡æ¯\nä¸‰ã€åˆ†ææ–‡ä»¶ç³»ç»Ÿç»„æˆ virt-filesystemså’Œvirt-dféƒ½å¯ä»¥ï¼Œç”¨virt-dfçœ‹çš„æ›´å¤šä¸€äº›\n1virt-filesystems -l -a vis-16-41-18.qcow2 2Name Type VFS Label Size Parent 3/dev/sda1 filesystem ext4 - 209715200 - 4/dev/sda2 filesystem ext4 - 214536355840 - 5 6virt-df -a vis-16-41-18.qcow2 7Filesystem 1K-blocks Used Available Use% 8vis-16-41-18.qcow2:/dev/sda1 194241 31706 152295 17% 9vis-16-41-18.qcow2:/dev/sda2 206088704 5639856 189973444 3% 10 å››ã€æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿå¼€å§‹ä¿®å¤ï¼ˆæ–¹æ³•1ï¼‰ ä»ä¸Šé¢å¯ä»¥çœ‹åˆ° vis-16-41-18.qcow2 é‡Œé¢æœ‰ä¸¤ä¸ªåˆ†åŒºï¼Œ/dev/sda1 å’Œ/dev/sda2\nç¬¬ä¸€ä¸ªåº”è¯¥æ˜¯/bootï¼Œç¬¬äºŒä¸ªæ˜¯/\næŠŠ / mount å‡ºæ¥\n1mkdir 18 2guestmount -a vis-16-41-18.qcow2 -m /dev/sda2 --rw ./18 æˆ–è€…å…¨è‡ªåŠ¨mount\n1guestmount -a vis-16-41-18.qcow2 -i --rw ./18 è¿™æ ·å°±å¯ä»¥ç›´æ¥è¿›18ç›®å½•è¿›è¡Œä¿®å¤æ“ä½œäº†\n1cd 18/lib64 2ls libc*.* å‘ç°åŒäº‹èƒ¡ä¹±å‡çº§glibcï¼ŒæŠŠlibcçš„åŸºç¡€åº“å¼„åäº†ï¼Œå°‘libc.so.6çš„è½¯é“¾æ¥ï¼Œå»ºç«‹ä¸€ä¸ªä¿®å¤å³å¯\n1ln -s libc-2.15.so libc.so.6 äº”ã€æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿå¼€å§‹ä¿®å¤ï¼ˆæ–¹æ³•2ï¼‰ æˆ‘ä»¬å¯ä»¥ç”¨ guestmountï¼Œä¹Ÿå¯ä»¥ç›´æ¥ç”¨ guestfish ã€‚\nguestfish æ˜¯ä¸ªå‘½ä»¤è¡Œå·¥å…·ã€‚å®ƒä½¿ç”¨ libguestfs çš„æ‰€æœ‰åŠŸèƒ½ã€‚\n1guestfish 2 3Welcome to guestfish, the libguestfs filesystem interactive shell for 4editing virtual machine filesystems. 5 6Type: \u0026#39;help\u0026#39; for help on commands 7 \u0026#39;man\u0026#39; to read the manual 8 \u0026#39;quit\u0026#39; to quit the shell 9 10\u0026gt;\u0026lt;fs\u0026gt; add vis-16-41-18.qcow2 11\u0026gt;\u0026lt;fs\u0026gt; run 12\u0026gt;\u0026lt;fs\u0026gt; list-filesystems 13/dev/sda1: ext4 14/dev/sda2: ext4 15\u0026gt;\u0026lt;fs\u0026gt; mount /dev/sda2 / 16\u0026gt;\u0026lt;fs\u0026gt; cat /etc/fstab 17 18# 19# /etc/fstab 20# Created by anaconda on Mon Dec 29 15:24:53 2014 21# 22# Accessible filesystems, by reference, are maintained under \u0026#39;/dev/disk\u0026#39; 23# See man pages fstab(5), findfs(8), mount(8) and/or blkid(8) for more info 24# 25UUID=9fdc111c-3042-4527-b3f8-a2961e55077e / ext4 defaults 1 1 26UUID=1855d5e1-18f8-48ea-8c3b-c52cdd512a5e /boot ext4 defaults 1 2 27tmpfs /dev/shm tmpfs defaults 0 0 28devpts /dev/pts devpts gid=5,mode=620 0 0 29sysfs /sys sysfs defaults 0 0 30proc /proc proc defaults 0 0 31 32\u0026gt;\u0026lt;fs\u0026gt; guestfishçš„å¸¸ç”¨å‘½ä»¤ï¼š\n1add vis-16-41-18.qcow2 2run 3list-filesystems 4 5ll / 6ls / 7cat /etc/fstab 8write-append /etc/rc.d/rc.local \u0026#34;service sshd start\u0026#34; 9edit /etc/fstab. 10less /var/log/messages 11mkdir /tmp/a 12touch /tmp/a/b.txt 13write /tmp/a/b.txt 14rm /tmp/a/b.txt 15 16upload Upload a local file to the disk. ###æ³¨æ„ï¼šæ˜¯ä¸Šè½½æœ¬åœ°æ–‡ä»¶åˆ°é•œåƒæ–‡ä»¶å»ï¼ï¼ï¼ 17 å…­ã€virtå¯¹åº”guestfishçš„ä¸€äº›å‘½ä»¤ 1virt-cat vis-16-41-18.qcow2 /home/supdev/.bash_history 2 3virt-copy-in Copy files and directories into a guest. 4virt-copy-out Copy files and directories out of a guest. 5 6virt-edit Edit a file in a guest. 7virt-ls List files and directories in a guest ä¸ƒã€virt-rescueæ•‘æ´æ¨¡å¼ å¦‚æœè™šæœºç³»ç»Ÿèµ·ä¸æ¥ï¼Œå¯ä»¥å…ˆå°è¯•è¿›å…¥ rescue æ•‘æ´æ¨¡å¼\nvirt-rescue ç±»ä¼¼äºæ•‘æ´ CDï¼Œä½†ç”¨äºè™šæ‹Ÿæœºï¼Œä¸”æ— éœ€æä¾› CDã€‚\nvirt-rescue ä¸ºç”¨æˆ·æä¾›æ•‘æ´å¤–å£³å’Œä¸€äº›ç®€å•çš„æ¢å¤å·¥å…·ï¼Œå¯ç”¨äºæ£€æŸ¥å’Œæ›´æ­£è™šæ‹Ÿæœºæˆ–ç£ç›˜æ˜ åƒä¸­çš„é—®é¢˜ã€‚\n1virt-rescue -a vis-16-41-18.qcow2 2Welcome to virt-rescue, the libguestfs rescue shell. 3 4Note: The contents of / are the rescue appliance. 5You need to mount the guest\u0026#39;s partitions under /sysroot 6before you can examine them. A helper script for that exists: 7mount-rootfs-and-do-chroot.sh /dev/sda2 8 9\u0026gt;\u0026lt;rescue\u0026gt; 10[ 67.194384] EXT4-fs (sda1): mounting ext3 file system 11using the ext4 subsystem 12[ 67.199292] EXT4-fs (sda1): mounted filesystem with ordered data 13mode. Opts: (null) 14mount: /dev/sda1 mounted on /sysroot. 15mount: /dev bound on /sysroot/dev. 16mount: /dev/pts bound on /sysroot/dev/pts. 17mount: /proc bound on /sysroot/proc. 18mount: /sys bound on /sysroot/sys. 19Directory: /root 20Thu Jun 5 13:20:51 UTC 2014 21(none):~ # ","date":"2021-10-21","img":"","permalink":"https://bajie.dev/posts/20211021-libguestfs/","series":null,"tags":null,"title":"Libguestfsçš„æ•‘æ´æ‰‹æ®µ"},{"categories":null,"content":"è¿™æ˜¯ä¸ªå¨±ä¹è¯é¢˜ï¼ŒDogecoin ç‹—å¸åœ¨é©¬æ–¯å…‹çš„å¹æ§é¼“åŠ¨ä¸‹ï¼Œå†²ä¸Šäº‘éœ„\nå…¶å®çœŸçš„ç”¨CPUæŒ–å¸ï¼Œåº”è¯¥æ˜¯æŒ– xmb é—¨ç½—å¸æ‰æ˜¯å¯¹çš„é€‰æ‹©ï¼ŒæŒ–ç‹—å¸åªæ˜¯å¨±ä¹ä¸€ä¸‹\nåºŸè¯ä¸å¤šè¯´ï¼Œç›´æ¥æ”¾ä¸Šæ•™ç¨‹ï¼Œæˆ‘çš„æœºå™¨æ˜¯ CentoOS\né¦–å…ˆéœ€è¦æœ‰ä¸ªç‹—å¸é’±åŒ…åœ°å€ï¼Œè¿™ä¸ªæˆ‘å°±ä¸æ•™å¤§å®¶äº†\nä¸€ã€ä¸‹è½½xmrigæŒ–çŸ¿è½¯ä»¶ ä¸‹è½½åœ°å€ï¼šhttps://github.com/xmrig/xmrig/releases\næˆ‘ä»¬é€‰æ‹©æœ€è¿‘çš„ä¸‹è½½å°±å¥½\näºŒã€åšå¥½åŠ å¯†é€šé“ æˆ‘ä»¬éœ€è¦åšå¥½ä¸€æ¡åŠ å¯†tcpé€šé“\nç”¨ ghostunnel, localhost:9999 \u0026mdash;\u0026gt; vps:9999 \u0026mdash;\u0026gt; rx.unmineable.com:3333\nä¸‰ã€ç”¨screenåå°å¼€æŒ– 1screen 2 3#./xmrig -o localhost:9999 -a rx -k -u DOGE:ç‹—å¸åœ°å€.çŸ¿å·¥å#heyt-3711 4./xmrig -o localhost:9999 -a rx -k -u DOGE:DLR3DZGucJiSdahARW1vV5B1h3WYiw454a.work01 5 6ctrl+a+d å››ã€æŸ¥çœ‹æŒ–äº†å¤šå°‘ æŸ¥çœ‹åœ°å€ï¼šhttps://unmineable.com/coins/DOGE/address/\n","date":"2021-10-21","img":"","permalink":"https://bajie.dev/posts/20211021-dogecoin/","series":null,"tags":null,"title":"å¦‚ä½•ç”¨CPUæŒ–ç‹—å¸Dogecoin"},{"categories":null,"content":"chrony å·²ç»æˆäº†äº‹å®æ ‡å‡†ï¼Œæ›¿ä»£äº†ntpã€‚\nä½†æ˜¯ï¼Œæœ‰å‡ ä¸ªç»†èŠ‚ï¼Œéœ€è¦éå¸¸æ³¨æ„ã€‚\nç»™å‡ºæˆ‘ä»¬çš„é…ç½®ï¼Œ/etc/chrony.conf\n1 2# Use public servers from the pool.ntp.org project. 3# Please consider joining the pool (http://www.pool.ntp.org/join.html). 4server 172.10.1.1 iburst prefer minpoll 6 maxpoll 10 5server 172.10.1.2 iburst 6 7# Record the rate at which the system clock gains/losses time. 8driftfile /var/lib/chrony/drift 9 10# Allow the system clock to be stepped in the first three updates 11# if its offset is larger than 1 second. 12makestep 1.0 3 13 14# Enable kernel synchronization of the real-time clock (RTC). 15rtcsync 16 17# Enable hardware timestamping on all interfaces that support it. 18#hwtimestamp * 19 20# Increase the minimum number of selectable sources required to adjust 21# the system clock. 22#minsources 2 23 24# Allow NTP client access from local network. 25#allow 192.168.0.0/16 26 27# Serve time even if not synchronized to a time source. 28#local stratum 10 29 30# Specify file containing keys for NTP authentication. 31#keyfile /etc/chrony.keys 32 33# Specify directory for log files. 34logdir /var/log/chrony 35logchange 0.5 36# Select which information is logged. 37#log measurements statistics tracking rtc é‡Œé¢æœ‰å¥½å‡ ä¸ªç»†èŠ‚ï¼Œä¸‹é¢é€ä¸€è§£é‡Šä¸€ä¸‹ï¼š\nä¸€ã€server è¿™é‡Œå¯ä»¥æ·»åŠ å¾ˆå¤šæ—¶é—´æœåŠ¡å™¨ï¼Œ172.10.1.1 å’Œ 172.10.1.2 æ˜¯ä¸¤å°è‡ªå»ºçš„æ—¶é—´æœåŠ¡å™¨ã€‚\nibust ä¼šåœ¨ chrony å¯åŠ¨çš„2ç§’å†…ï¼Œå»å¿«é€ŸpollæœåŠ¡å™¨4æ¬¡æ¥å¿«é€ŸçŸ«æ­£å½“å‰ç³»ç»Ÿæ—¶é—´\nprefer ä¼˜å…ˆä½¿ç”¨æŒ‡å®šçš„æœåŠ¡å™¨\nminpoll 6ï¼Œç¼ºçœæ˜¯6ï¼Œæ„æ€æ˜¯2çš„6æ¬¡æ–¹ï¼Œä¹Ÿå°±æ˜¯64ç§’ï¼Œæœ€å°è½®è¯¢æ—¶é—´æœåŠ¡å™¨çš„æ—¶é—´é—´éš”æ˜¯64ç§’\nmaxpoll 10ï¼Œç¼ºçœæ˜¯10ï¼ŒåŒä¸Šï¼Œ2çš„10æ¬¡æ–¹ï¼Œä¹Ÿå°±æ˜¯1024ç§’ï¼Œæœ€å¤§è½®è¯¢æ—¶é—´é—´éš”æ˜¯1024ç§’\né€šå¸¸æƒ…å†µä¸‹ä¸€è¿‡minpollçš„æ—¶é—´å‘¨æœŸï¼Œå°±ä¼šè§¦å‘ä¸€æ¬¡æ—¶é—´åŒæ­¥è¯¢é—®ã€‚\näºŒã€makestep æ­£å¸¸æƒ…å†µä¸‹å¦‚æœç³»ç»Ÿæ—¶é’Ÿè·Ÿæ—¶é—´æœåŠ¡å™¨ä¸ä¸€è‡´ï¼Œchronyè°ƒæ•´çš„æ–¹å¼æ˜¯æ…¢æ…¢å¢åŠ ï¼Œæˆ–æ…¢æ…¢å‡å°‘ï¼Œä¸ä¼šä¸€æ­¥åˆ°ä½ï¼Œç›´æ¥å»è·Ÿæ—¶é—´æœåŠ¡å™¨å¯¹é½ã€‚\nmakestep 1.0 3ï¼Œæ„æ€å°±æ˜¯å¦‚æœæ—¶é—´æœåŠ¡å™¨è·Ÿç³»ç»Ÿæ—¶é—´ç›¸å·®1ç§’ï¼Œé‚£ä¹ˆå°±åœ¨ä¸‹3ä¸ªæ—¶é’Ÿæ›´æ–°ä¸­è¿½ä¸Šæ—¶é—´æœåŠ¡å™¨ã€‚\nè¿™æ ·å°±ä¼šç«‹åˆ»å¿«é€Ÿè¿½å¹³äº†ï¼Œè¿™æ ·ä¼šå¸¦æ¥æ—¶é—´è·³è·ƒã€‚\nä¸‰ã€rtcsync è¿™ä¸ªæ˜¯æŠŠç³»ç»Ÿæ—¶é’ŸåŒæ­¥åˆ°ä¸»æ¿çš„ç¡¬ä»¶æ—¶é’Ÿå»ã€‚\nç¼ºçœæƒ…å†µä¸‹æ˜¯11åˆ†é’ŸåŒæ­¥ä¸€æ¬¡\nå››ã€logchange logchange 0.5ï¼Œæ„æ€æ˜¯å¦‚æœchronyè°ƒæ•´çš„ç³»ç»Ÿæ—¶é—´ï¼Œè¶…è¿‡äº†0.5ç§’çš„æ—¶é•¿ï¼Œå°±ä¼šå‘ä¸€æ¡æ¶ˆæ¯åˆ°syslogï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½åœ¨/var/log/messagesé‡Œçœ‹åˆ°è¿™æ¡æ¶ˆæ¯äº†ã€‚\näº”ã€éªŒè¯è°ƒè¯• å¼€å‘äººå‘˜ä¼šé—®ï¼Œä»€ä¹ˆæ—¶å€™åŒæ­¥çš„æœåŠ¡å™¨å•Šï¼Œå¤šé•¿æ—¶é—´åŒæ­¥ä¸€æ¬¡ï¼Œæ—¶é—´åˆ°åº•å‡†ä¸å‡†å•Šï¼Œæœ‰æ²¡æœ‰å‘ç”Ÿè·³è·ƒå•Š\næˆ‘ä»¬å°±ç”¨chronyc sourcesæ¥éªŒè¯ï¼Œé…ç½®ä¸­\n1server 172.10.1.1 iburst prefer minpoll 4 maxpoll 5 2server 172.10.1.2 iburst è§£é‡Šä¸€ä¸‹ï¼Œminpoll 4 maxpoll 5 ï¼Œé‚£ä¹ˆæœ€å°è½®è¯¢æ—¶é—´16ç§’ï¼Œæœ€å¤§32ç§’ã€‚\næˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸Šå›¾ LastRx å°±æ˜¯ä¸Šæ¬¡è¯¢é—®æ—¶é—´æœåŠ¡å™¨çš„é—´éš”æ—¶é—´ï¼Œ14ç§’ã€15ç§’ã€16ç§’ï¼Œç„¶åå°±å˜1äº†ï¼Œæœ€å°é—´éš”16ç§’åï¼Œç«‹å³å°±è¯¢é—®æ—¶é—´æœåŠ¡å™¨ï¼ŒåŒæ­¥æ—¶é—´ã€‚\nåŒæ ·å¯ä»¥çœ‹åˆ°ç¬¬äºŒå°æ—¶é—´æœåŠ¡å™¨å°±ä¸å—è¿™ä¸ªé™åˆ¶ï¼Œç¼ºçœminpoll 6ï¼Œå°±æ˜¯64ç§’ã€‚æ‰€ä»¥ä¸Šå›¾ç¬¬äºŒå°ï¼Œ63ç§’ã€64ç§’ã€65ç§’ï¼Œå˜0ï¼Œæ‰å»è¯¢é—®æ—¶é—´æœåŠ¡å™¨ã€‚\næ€»ç»“ä¸€ä¸‹ï¼Œchrony è°ƒæ•´æ—¶é—´åå·®æ˜¯åŒ€é€Ÿçš„ï¼Œç¼“æ…¢çš„ã€‚å®ƒè¯¢é—®æ—¶é—´æœåŠ¡å™¨çš„é—´éš”ç”±minpollæ¥æ§åˆ¶ã€‚\næˆ‘ä»¬ç”¨logchangeæ¥è®°å½•å¤§çš„æ—¶é—´è°ƒæ•´ï¼Œä»¥å¤‡è¿½æº¯å’ŒæŸ¥è¯¢ã€‚\n","date":"2021-10-20","img":"","permalink":"https://bajie.dev/posts/20211020-chrony/","series":null,"tags":null,"title":"Chronyçš„å‡ ä¸ªè¯¦ç»†é…ç½®ç»†èŠ‚"},{"categories":null,"content":"å¾ˆç°å®çš„é—®é¢˜ï¼Œå±€åŸŸç½‘å†…æœ‰æ€åŠ¿æ„ŸçŸ¥å’Œç½‘ç»œæµé‡åˆ†æï¼Œè¿™å¾ˆè®¨åŒï¼\né‚£ä¹ˆï¼Œå¦‚ä½•æŠŠæŸæ®µæµé‡éšè—èµ·æ¥ï¼Œè®©æ€åŠ¿æ„ŸçŸ¥æ— æ³•åˆ†æå‘¢ï¼Ÿ\nå‰ææ¡ä»¶ï¼Œä½ éœ€è¦æœ‰å›½å¤–çš„ä¸€å° VPS ä½œä¸ºå¤–æ´ï¼ŒæŠŠ TCP æµé‡é€šè¿‡ TLS åŠ å¯†é€åˆ°å›½å¤–çš„æœåŠ¡å™¨ï¼Œç„¶åå†è½¬å‘åˆ°æ­£ç¡®çš„ç›®æ ‡æœåŠ¡å™¨ä¸Šï¼Œè¿™æ ·å°±ä¸ä¼šè¢«äººè¿½è¸ªäº†ã€‚\nè¿™é‡Œæ¨è Ghostunnel ï¼Œè¿™æ˜¯ä¸ª Go çš„ç¨‹åºï¼Œåªæœ‰ä¸€ä¸ªæ‰§è¡Œæ–‡ä»¶ã€‚é…åˆ certik è¯ä¹¦ç”Ÿæˆï¼Œå°±å®Œç¾äº†ã€‚\né¡¹ç›®åœ°å€ï¼šhttps://github.com/ghostunnel/ghostunnel\né¦–å…ˆæˆ‘ä»¬ä½¿ç”¨ certik ç”Ÿæˆä¸‰ä¸ªè¯ä¹¦ï¼Œca.pem server.pem å’Œ client1.pem\nç„¶åghostunnelä»¥åŠä¸‰ä¸ªè¯ä¹¦æ–‡ä»¶éƒ½æ”¾åœ¨/usr/local/binä¸‹\nä¸€ã€åœ¨VPSä¸Šè¿è¡Œghostunnelæ¨¡å¼server 1/usr/local/bin/ghostunnel server --listen 0.0.0.0:9999 --target tr.dero.herominers.com:1117 --keystore server.pem --cacert ca.pem --allow-cn client1 --unsafe-target ä¸Šé¢ç›‘å¬äº†ç«¯å£0.0.0.0:9999ï¼ˆç›‘å¬0.0.0.0å¿…é¡»åŠ å‚æ•°\u0026ndash;unsafe-targetï¼‰ï¼Œè¿œç¨‹è½¬å‘åˆ°deroçš„çŸ¿æ± ç«¯å£1117ï¼Œåªå…è®¸éªŒè¯è¿‡çš„cn client1è¿æ¥ã€‚\näºŒã€åœ¨æœ¬åœ°æœºå™¨ä¸Šè¿è¡Œghostunnelæ¨¡å¼client 1/usr/local/bin/ghostunnel client --listen localhost:9999 --target 193.42.114.129:9999 --keystore client.pem --cacert ca.pem æœ¬åœ°ç›‘å¬localhost:9999ï¼Œæ‰€ä»¥ä¸ç”¨åŠ \u0026ndash;unsafe-targetå‚æ•°ï¼Œç„¶åè¿æ¥åˆ°è¿œç¨‹ vps æœåŠ¡å™¨ï¼Œipåœ°å€æ˜¯193.42.114.129ï¼Œç«¯å£æ˜¯9999\nè¿™æ ·å°±å®Œæˆäº†ã€‚å¯ä»¥æ”¾å¿ƒçš„å¯åŠ¨ç¨‹åºï¼Œè¿æ¥åˆ°æœ¬åœ°ç«¯å£localhost:9999ï¼ŒTCPæµé‡å°±ä¼šè¢«éšè—èµ·æ¥ï¼Œä¸ä¼šè¢«åˆ†æåˆ°.\n","date":"2021-10-19","img":"","permalink":"https://bajie.dev/posts/20211019-ghostunnel/","series":null,"tags":null,"title":"Ghostunnelä½¿ç”¨TLSåŠ å¯†TCPæµé‡"},{"categories":null,"content":"æˆ‘ä»¬ä¼šæœ‰å¾ˆå¤šæ—¶å€™éœ€è¦ç”¨åˆ°TLSè¯ä¹¦ï¼Œä¸€ä¸ªéå¸¸æ–¹ä¾¿ã€å°ä¼—çš„å·¥å…·å°±æ˜¯ certik ã€‚\nè¿™ä¸ªè½¯ä»¶çº¯ç”± Go ç»„æˆï¼Œå°±ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œä½¿ç”¨äº† etcd çš„ boltdb æ ¼å¼å­˜æ”¾æ‰€æœ‰çš„è¯ä¹¦ã€‚\nè½¯ä»¶åœ°å€ï¼šhttps://github.com/opencoff/certik\nä½¿ç”¨ï¼š\nä¸€ã€åˆå§‹åŒ–è¯ä¹¦åº“ 1./certik -v tls.db init CA äºŒã€ç­¾å‘ä¸€å¼ serverè¯ä¹¦ 1#./certik -v tls.db server -i IP.ADDR.ES server.domain.name 2./certik -v tls.db server -i 193.42.114.129 server ä¸Šé¢æˆ‘ä»¬ server çš„ ip æ˜¯193.42.114.129ï¼ŒåŸŸåç®€æ´èµ·è§å°±å« server äº† ã€‚\nä¸‰ã€ç­¾å‘ä¸€å¼ client1è¯ä¹¦ 1./certik -v tls.db client client1 å››ã€æŸ¥çœ‹è¯ä¹¦åº“ 1./certik -v tls.db list æˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°ä¸‰ä¸ªè¯ä¹¦äº†ï¼Œä¸€ä¸ª CA ï¼Œä¸€ä¸ª server ï¼Œä¸€ä¸ª client1\näº”ã€å¯¼å‡ºå„ä¸ªè¯ä¹¦ 1#å¯¼å‡ºCA 2./certik -v tls.db export --root-ca 3 4#å¯¼å‡ºserver 5./certik -v tls.db export server 6 7#å¯¼å‡ºclient1 8./certik -v tls.db export client1 ä»¥ä¸Šå°±å¯ä»¥å¾—åˆ°å„ä¸ªä¸œè¥¿äº†ã€‚\né‚£ä¹ˆæˆ‘ä»¬ gen å‡ºè¯ä¹¦åšä»€ä¹ˆç”¨å‘¢ï¼Ÿå½“ç„¶ç”¨ä½œ ghostunnel çš„éªŒè¯ç”¨\n","date":"2021-10-19","img":"","permalink":"https://bajie.dev/posts/20211019-certik/","series":null,"tags":null,"title":"Certik è¯ä¹¦ç­¾å‘è½¯ä»¶"},{"categories":null,"content":"ç°åœ¨å›½å†…éƒ½ç¦æ­¢æŒ–å¸ï¼Œä»€ä¹ˆå¸å®‰ã€ç«å¸ã€cnsparkä¹‹ç±»çš„éƒ½ä¸å…è®¸å›½å†… IP è®¿é—®äº†ã€‚\nå¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ\né¦–å…ˆéœ€è¦å¾—åˆ°å›½å®¶IPæ®µï¼Œä¸‹è½½åœ°å€ï¼šhttp://www.ipdeny.com/ipblocks/ã€‚è¿™é‡Œä»¥æˆ‘ä»¬å›½å®¶ cn ä¸ºä¾‹\næ­¥éª¤å¦‚ä¸‹ï¼š\nä¸€ã€å®‰è£…ipset 1#Debian/Ubuntuç³»ç»Ÿ 2apt-get -y install ipset 3 4#CentOSç³»ç»Ÿ 5yum -y install ipset äºŒã€æ¸…ç©ºiptableè§„åˆ™ 1#é˜²æ­¢è®¾ç½®ä¸ç”Ÿæ•ˆï¼Œæ¸…ç©ºä¹‹å‰çš„é˜²ç«å¢™è§„åˆ™ 2iptables -P INPUT ACCEPT 3iptables -F ä¸‰ã€åˆ›å»ºipsetè§„åˆ™é›† 1#åˆ›å»ºä¸€ä¸ªåä¸ºcnipçš„è§„åˆ™ 2ipset -N cnip hash:net 3 4#ä¸‹è½½å›½å®¶IPæ®µï¼Œè¿™é‡Œä»¥ä¸­å›½ä¸ºä¾‹ 5wget -P . http://www.ipdeny.com/ipblocks/data/countries/cn.zone 6 7#å°†IPæ®µæ·»åŠ åˆ°cnipè§„åˆ™é›†ä¸­ 8for i in $(cat /root/cn.zone ); do ipset -A cnip $i; done å››ã€åˆ›å»ºiptableé»‘åå• 1#æ‰”é»‘åå• 2iptables -A INPUT -p tcp --dport 80 -m set --match-set cnip src -j DROP 3iptables -A INPUT -p tcp --dport 443 -m set --match-set cnip src -j DROP 4 5#ç„¶åæ”¾è¡Œå…¶ä»–çš„ 6iptables -P INPUT ACCEPT ","date":"2021-10-18","img":"","permalink":"https://bajie.dev/posts/20211018-ipset_block_cn/","series":null,"tags":null,"title":"ä½¿ç”¨IPSETå°æ‰æŸä¸ªå›½å®¶æ•´ä¸ªçš„è®¿é—®"},{"categories":null,"content":"å…¬å¸å®‰è£…äº† openvpn ï¼Œå¸¦æ¥æ–¹ä¾¿ï¼Œä½†æ˜¯ä¹Ÿæœ‰å¾ˆå¤šä¸ä¾¿çš„åœ°æ–¹ï¼Œæœºæˆ¿çš„æ€»å¸¦å®½å°±é‚£ä¹ˆå¤šã€‚\nå¾ˆå¤šäººå…±ç”¨ vpn çš„æ—¶å€™ï¼Œå°±ä¼šæŠ¢å å¸¦å®½ã€‚\né‚£ä¹ˆï¼Œæˆ‘ä»¬éœ€è¦é™åˆ¶ä¸€ä¸‹ï¼Œé™åˆ¶ openvpn æ‰€èƒ½ä½¿ç”¨çš„å¸¦å®½ï¼Œé¿å…æŠ¢å  WEB çš„å¸¦å®½\nåšæ³•å¦‚ä¸‹ï¼š\nç”±äºæˆ‘ä»¬ä¸æ˜¯è¦å•ç‹¬é™åˆ¶æŸä¸€ä¸ª openvpn ç”¨æˆ·ï¼Œè€Œæ˜¯é™åˆ¶æ•´ä½“ï¼Œæ‰€ä»¥ç®€å•ç”¨ TC å°±å¯ä»¥äº†\n1#!/bin/sh 2tc qdisc del dev tun0 root 3tc qdisc add dev tun0 root handle 1: htb default 1 4tc class add dev tun0 parent 1: classid 1:1 htb rate 30Mbit ceil 30Mbit è§£é‡Šä¸€ä¸‹ï¼š\n æˆ‘ä»¬ openvpn å¯çš„æ˜¯ tun0 ï¼Œæ‰€ä»¥é™åˆ¶çš„å¯¹è±¡å°±æ˜¯ dev tun0 é¦–å…ˆç¬¬ä¸€è¡Œæ¸…é™¤ tun0 çš„æ ¹é˜Ÿåˆ— ç„¶åç¬¬äºŒè¡Œå»ºç«‹ tun0 çš„ root æ ¹é˜Ÿåˆ—ä¸º 1:0 htb ï¼Œç¼ºçœæ˜¯1:1çš„å­é˜Ÿåˆ— æœ€åä¸€è¡Œï¼Œç¬¬ä¸‰è¡Œå»ºç«‹ 1:1 çš„å­é˜Ÿåˆ—ï¼Œå¸¦å®½é™åˆ¶æ˜¯ 30Mbit ï¼Œæ³¨æ„è¿™é‡Œæ˜¯å¤§Bï¼Œå°±æ˜¯ç½‘ç»œæœ¯è¯­ä¸­çš„å¸¦å®½ï¼Œæ¢ç®—æˆå°bçš„è¯ï¼Œéœ€è¦é™¤ä»¥8  æ•ˆæœå¾ˆæ˜æ˜¾ï¼Œç›´æ¥è¢«é™åˆ¶ä½ï¼ˆ41å…†è€Œä¸æ˜¯30Mæ˜¯å› ä¸ºè¿™å°æœºå™¨æ˜¯è™šæœºï¼Œå®ä½“æœºä¸Šè¿˜æœ‰åˆ«çš„æµé‡ï¼‰ï¼š\n","date":"2021-10-18","img":"","permalink":"https://bajie.dev/posts/20211018-openvpn_limit_bandwidth/","series":null,"tags":null,"title":"OpenVPN é™åˆ¶æµé‡å¸¦å®½"},{"categories":null,"content":"æœ¬ç«™è¿™ä¸ªåšå®¢çš„ç”±æ¥ï¼š\næºè‡ªäº wiredcraft çš„é¢è¯•ï¼Œè¿™ä¸ªå…¬å¸è®©è€å…«å¾ˆæ˜¯å‘å¾€ï¼Œå¯ä»¥è¿œç¨‹å·¥ä½œï¼Œç¬¬ä¸€æ¬¡é¢è¯•æ˜¯ devops ï¼Œè€å¤–è§é¢èŠäº†åï¼Œç”±ä»£ç†ä¸­å›½äººé¢ã€‚å› ä¸ºé¢çš„æ˜¯K8Sçš„ä¸œè¥¿ï¼Œæ­£å¥½åˆšç»™ç”»åŒ…åŒ…å…¬å¸åšäº†æ•´ä½“è¿å¾€é˜¿é‡ŒACKçš„å·¥ç¨‹ï¼Œä»¥ä¸ºæ²¡é—®é¢˜ï¼Œå®é™…æ˜¯ç›´æ¥é—®å€’äº†æˆ‘ã€‚å°±å¥½æ¯”master nodeä¸Šé¢éƒ½è·‘äº†ä»€ä¹ˆè¿›ç¨‹ï¼Œå”‰ï¼Œä¸€è¨€éš¾å°½å•Šï¼Œåˆé—®åˆ°ansibleçš„å˜é‡ï¼Œå›ç­”ä¼°è®¡ä¹Ÿä¸æ»¡æ„ï¼Œç»“æœå°±æŒ‚äº†\nçŸ¥è€»è€Œåå‹‡ï¼Œåé¢å»æ¶è¡¥äº†ä¸€ä¸‹ansibleå’Œk8sçš„ä¸œè¥¿ï¼Œå®é™…ä¹Ÿæ˜¯å®é™…æ“ä½œå±…å¤šï¼Œç„¶åç¬¬äºŒæ¬¡é¢çš„æ˜¯ sysadminï¼Œå…¨ç¨‹è€å¤–é¢ã€‚è¿˜å‡ºäº†å‡ é“é¢˜ï¼Œåº”è¯¥æ˜¯æ²¡é—®é¢˜ã€‚ä½†æ˜¯å·¥èµ„è¦é«˜äº†ï¼Œä¹Ÿè¢«åˆ·äº†ã€‚\nè¿™ä¸ªåšå®¢å°±æ˜¯å…¶ä¸­ä¸€é“é¢˜ï¼Œé‚£æ—¢ç„¶æ­å»ºå‡ºæ¥äº†ï¼Œå¹²è„†å°±å¥½å¥½ç”¨å§ã€‚\næœ¬èº«è‡ªå·±å¯¹é™æ€çš„ Blog ç³»ç»Ÿä¹Ÿæ¯”è¾ƒæ„Ÿå…´è¶£ï¼Œè‡ªå·±ä¸»ç«™ www.rendoumi.com çš„ Blog æ˜¯ç”± journey æ­å»ºçš„ï¼Œæ˜¯ä¸€ä¸ªç²¾å·§çš„ go ç¨‹åºï¼Œæœ€å¦™çš„æ˜¯å®ƒå…¼å®¹ Ghost åšå®¢ç³»ç»Ÿï¼Œä¹Ÿèƒ½ä½¿ç”¨ Ghost çš„ theme ï¼Œè¿™æ ·å°±å®Œç¾çš„æŠŠè‡ªå·±ä»¥å‰ Ghost çš„åšå®¢è¿ç§»äº†è¿‡å»ï¼Œä½†æ˜¯ï¼Œé‡Œé¢æ–‡ç« æœ‰å¾ˆå¤šè¿‡æ—¶äº†ï¼Œä½†ä¹Ÿä¸æƒ³æ¸…ç†ï¼Œå¹²è„†å€Ÿç€è¿™ä¸ªæœºä¼šï¼Œä»æ–°å¼€å§‹ã€‚æ­ä¸€ä¸ªè‡ªå·±å–œæ¬¢çš„ç³»ç»Ÿç»§ç»­å†™æ–°åšå®¢\næµè¡Œçš„ Markdown å†™ä½œå¹³å°æœ‰Hexoå’ŒHugoï¼Œé€‰Hugoæ˜¯å› ä¸ºå®åœ¨æ˜¯ä¸å–œæ¬¢nodeï¼Œå¼„ä¸€å †npmï¼Œè¿ç§»éº»çƒ¦æ­»ã€‚\nè¿™ä¸ªåšå®¢ç¨‹åºåŸºäºHugoï¼Œæ‰˜ç®¡åœ¨ githubï¼Œä¼—æ‰€å‘¨çŸ¥ï¼Œgithub æ˜¯æ‰˜ç®¡é™æ€æ–‡ä»¶çš„åœ°æ–¹ï¼ŒMarkdownçš„æœ€å¤§æ¯›ç—…æ˜¯å›¾ç‰‡ã€‚å›¾ç‰‡æ”¾åœ¨å›¾åºŠä¹Ÿä¸æ˜¯å¥½åŠæ³•ï¼Œæ‰€ä»¥å›¾ç‰‡å’Œé™æ€æ–‡ä»¶è¦åœ¨ä¸€èµ·ï¼Œä¸‹é¢å°±è¯´ä¸€ä¸‹æ­å»ºè¿‡ç¨‹ï¼Œæˆ‘çš„ä¸»æœºæ˜¯Ubuntuï¼š\nä¸€ã€ä¸‹è½½Hugo ä¸‹è½½åœ°å€ï¼š https://github.com/gohugoio/hugo/releases/download/v0.88.1/hugo_0.88.1_Linux-64bit.tar.gz 1wget https://github.com/gohugoio/hugo/releases/download/v0.88.1/hugo_0.88.1_Linux-64bit.tar.gz 2tar zxvf hugo_0.88.1_Linux-64bit.tar.gz äºŒã€åˆå§‹ä¸€ä¸ªåšå®¢å†™ä½œç›®å½• 1./hugo new site MyBlog â€‹\nä¸‰ã€ä¸‹è½½theme 1cd MyBlog 2git clone https://github.com/halogenica/beautifulhugo.git themes/beautifulhugo 3echo theme = \\\u0026#34;beautifulhugo\\\u0026#34; \u0026gt;\u0026gt; config.toml â€‹\nå››ã€å†™ä¸€ç¯‡æ–°æ–‡ç«  1cd MyBlog 2../hugo new posts/my-first-post.md echo \u0026#34;#### This is another Blog\u0026#34; \u0026gt;\u0026gt; content/posts/my-first-post.md äº”ã€è¿è¡Œserverï¼Œbuildè‰ç¨¿ 1cd MyBlog 2../hugo server --buildDrafts â€‹\nå…­ã€æµ‹è¯•ä¸€ä¸‹ 1curl http://localhost:1313 â€‹\nä¸ƒã€æ¨é€åˆ°github é¦–å…ˆæˆ‘ä»¬è¦å»githubå¼€ä¸€ä¸ªxxx.github.ioçš„repoä»“åº“ï¼Œç„¶å git æŠŠç”Ÿæˆçš„é™æ€å†…å®¹æ¨ä¸Šå»å°±å¥½äº†\n1cd MyBlog 2 3#ç”Ÿæˆé™æ€æ–‡ä»¶ 4../hugo --buildDrafts 5 6#æ–‡ä»¶ç”Ÿæˆçš„ç›®å½•æ˜¯public 7cd public 8 9#æ­£å¸¸gitæ“ä½œå°±å¯ä»¥äº† 10git init 11git add . 12git commit -m \u0026#34;first commit\u0026#34; 13git branch -M main 14git remote add origin git@github.com:zhangrr/zhangrr.github.io.git 15git push -u origin main å…«ã€çœ‹ä¸‹ç»“æœ æ‰“å¼€ç½‘é¡µ http://zhangrr.github.io å°±èƒ½çœ‹åˆ°ç½‘é¡µäº†\nâ€‹\nä¹ã€é€‰æ‹©å†™ä½œè½¯ä»¶ å…¶å®ç°åœ¨å¼€å§‹æ‰æ˜¯æœ€é‡è¦çš„ï¼Œç”¨ä»€ä¹ˆè½¯ä»¶æ¥å†™ï¼Œå°±ç”¨å¤§å®¶æ¨èçš„ Typora æ¥å°±å¥½äº†\n1# or use 2# sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys BA300B7755AFCFAE 3wget -qO - https://typora.io/linux/public-key.asc | sudo apt-key add - 4 5# add Typora\u0026#39;s repository 6sudo add-apt-repository \u0026#39;deb https://typora.io/linux ./\u0026#39; 7sudo apt-get update 8 9# install typora 10sudo apt-get install typora åã€é€‰æ‹©ç›®å½•å­˜æ”¾æ ¼å¼ è¿™ä¸ªæ‰æ˜¯æœ€ä¸»è¦çš„é—®é¢˜ï¼Œçœ‹ä¸‹å›¾ï¼Œpostç›®å½•æ˜¯æ‰€æœ‰æ–‡ç« ï¼Œä¸‹é¢æŒ‰ç›®å½•å­˜æ”¾ï¼Œç›®å½•åæ˜¯æ—¥æœŸå’Œæ–‡ç« åï¼Œç›®å½•é‡Œé¢æ˜¯index.mdå’Œæ–‡ç« é™„å¸¦çš„å›¾ç‰‡ã€‚\næˆ‘è§‰å¾—è¿™ä¸ªæ¨¡å¼æ‰æ˜¯ç¬¦åˆæˆ‘çš„è¦æ±‚çš„ã€‚\n1. 2â”œâ”€â”€ post 3â”‚ â”œâ”€â”€ 2018-01-11-å…³è”äº†ä¸¤æ¬¾å°ç¨‹åº.md 4â”‚ â””â”€â”€ index.md 5â”‚ â”œâ”€â”€ 2018-02-05-ä¸€æ¬¾å°å°çš„ç‰©æµæ•°æ®äº§å“.md 6â”‚ â””â”€â”€ index.md 7â”‚ â”œâ”€â”€ 2018-03-19-ç°å·²åŠ å…¥ Algolia æœç´¢æœåŠ¡.md 8â”‚ â””â”€â”€ index.md 9â”‚ â”œâ”€â”€ 2018-04-13-æˆ‘æ˜¯å¦‚ä½•æç ¸äº†æœ¬ç«™æœç´¢æœåŠ¡çš„.md 10â”‚ â””â”€â”€ index.md 11â”‚ â”œâ”€â”€ 2018-04-18-å°ç«™æ„å»ºå·¥å…·å·²æˆåŠŸåˆ‡æ¢åˆ° Hugo.md 12â”‚ â””â”€â”€ index.md 13â”‚ â”œâ”€â”€ 2018-04-19-å¼€å§‹ç¿»è¯‘ä¸€ä¸ªæ–‡æ¡£ï¼šSaleor.md 14â”‚ â””â”€â”€ index.md 15â”‚ â”œâ”€â”€ 2018-04-22-Saleor åˆç¨¿å·²ç¿»è¯‘å®Œæˆ.md 16â”‚ â””â”€â”€ index.md 17â”‚ â”œâ”€â”€ 2018-04-26-ä»Šå¤©å…¨æ˜¯å¹²è´§ 18â”‚ â”‚ â”œâ”€â”€ IMG_5991-4755089.jpg 19â”‚ â”‚ â”œâ”€â”€ IMG_5997-4755064.jpg 20â”‚ â”‚ â”œâ”€â”€ IMG_5998-4755103.jpg 21â”‚ â”‚ â”œâ”€â”€ IMG_5999-4755051.jpg 22â”‚ â”‚ â”œâ”€â”€ IMG_6001-4755073.jpg 23â”‚ â”‚ â”œâ”€â”€ IMG_6002-4755080.jpg 24â”‚ â”‚ â”œâ”€â”€ IMG_6003-4755030.jpg 25â”‚ â”‚ â”œâ”€â”€ IMG_6004-4755009.jpg 26â”‚ â”‚ â””â”€â”€ index.md 27â”‚ â”œâ”€â”€ 2018-05-02-ä» Jekyll åˆ° Hugo çš„ä¸€äº›ç»†èŠ‚.md 28â”‚ â””â”€â”€ index.md 29â”‚ â””â”€â”€ 2018-05-03-Hugo çš„æ–‡ä»¶ç®¡ç†æ–¹æ¡ˆ.md 30â”‚ â””â”€â”€ index.md 31 åä¸€ã€å¾®è°ƒ Typora   ä¸ºäº†èƒ½æ˜¾ç¤ºç›®å½•ç»“æ„Outlineï¼Œæ‰€ä»¥æ‰€æœ‰å‰¯æ ‡é¢˜éœ€è¦ç”¨ ctrl+2 çš„æ ‡é¢˜æ–‡æœ¬ï¼Œè¿™æ ·å°±èƒ½è‡ªåŠ¨ç”ŸæˆOutline\n     ä¸ºäº†èƒ½è®©å‰ªè´´æ¿è‡ªåŠ¨æŠŠctrl+vè´´ä¸Šçš„å›¾ç‰‡æ”¾åˆ°ç›®å½•é‡Œé¢ï¼Œéœ€è¦è®¾ç½®Image\n  è¿™æ ·å°±å®Œç¾äº†ï¼Œä»¥åå°±åœ¨è¿™é‡Œå†™å·¥ä½œåšå®¢äº†ã€‚\n  åäºŒã€æ›´æ–°ï¼Œ Typora çš„é™çº§ æœ€æ–°æ¶ˆæ¯ï¼ŒTypora å‡åˆ°äº† 1.0 ï¼Œå¼€å§‹æ”¶è´¹äº†ã€‚\nå…è´¹çš„æœ€åä¸€ä¸ªç‰ˆæœ¬æ˜¯ typora 0.11.18 ç‰ˆæœ¬ï¼Œè¿˜å¥½èƒ½ä¸‹åˆ°ï¼š\nä¸‹è½½åœ°å€ï¼šhttps://download.typora.io/linux/typora_0.11.18_amd64.deb\nå›é€€æ–¹æ³•ï¼š\n1sudo apt autoremove typora 2sudo dpkg -i typora_0.11.18_amd64.deb 3 4sudo add-apt-repository --remove \u0026#39;deb https://typora.io/linux ./\u0026#39; ","date":"2021-10-15","img":"","permalink":"https://bajie.dev/posts/20211015-hugo_blog/","series":null,"tags":null,"title":"æœ¬ç«™åšå®¢çš„ç”±æ¥ä»¥åŠæ­å»ºä½¿ç”¨æ•™ç¨‹"},{"categories":null,"content":"ä¸Šä¸€ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬å®æ–½äº†Ubuntuä¸‹wifiçƒ­ç‚¹çš„æ­å»ºï¼Œé‚£ä¹ˆï¼Œå…¶å®æˆ‘æ˜¯æƒ³æŠ“æˆ‘iphoneæ‰‹æœºçš„httpsæ˜æ–‡æµé‡åŒ…æ¥ç€ã€‚\næ€ä¹ˆæŠ“å–å‘¢ï¼Ÿ\næ–¹æ³•ä¹Ÿå¾ˆç®€å•\nä¸€ã€å®‰è£… mitmproxy æœ‰wifiçƒ­ç‚¹é‚£å°æœºå™¨çš„wlanç½‘å¡åœ°å€æ˜¯192.168.222.1ï¼Œå°±åœ¨é‚£å°ä¸Šå®‰è£…ï¼Œä¾¿äºæŠ“å–\n1pip install mitmproxy äºŒã€è¿è¡Œmitmproxy 1mitmproxy -p 8080 ä¸‰ã€é…ç½®iphoneå®‰è£…mitmè¯ä¹¦ æ‰“å¼€æ‰‹æœºï¼Œè·å–wifiçƒ­ç‚¹ï¼Œè®¾ç½®è¿™ä¸ªwifiä½¿ç”¨æ‰‹æœºä»£ç†ï¼Œ192.168.222.1:8080\nç„¶åç”¨Safariæµè§ˆå™¨æ‰“å¼€ç½‘å€ï¼šhttp://mitm.it\n æ‰¾åˆ°IOSé‚£è¡Œï¼Œä»”ç»†çœ‹ä¸€çœ‹è¯´æ˜\n ç‚¹å‡» Get mitmproxy-ca-cert.pem å®‰è£…æè¿°æ–‡ä»¶\nå®‰è£…å®Œä»¥åï¼Œåœ¨è®¾ç½® \u0026ndash;\u0026gt; å·²ä¸‹è½½æè¿°æ–‡ä»¶ï¼Œå®‰è£…æè¿°æ–‡ä»¶\n å®‰è£…å¥½ä»¥åä¼šæ˜¾ç¤ºç»¿è‰²çš„å·²éªŒè¯\nç„¶ååœ¨æ‰‹æœºä¸Šç”¨ safari è®¿é—®ç½‘å€ï¼šhttps://ip138.com\nå›åˆ° Ubuntu çš„å‘½ä»¤è¡Œçª—å£ï¼Œä¸Šä¸‹é€‰ä¸­æŠ“åˆ°çš„åŒ…ï¼Œç„¶åæŒ‰å›è½¦æŸ¥çœ‹ï¼Œå·¦å³å…‰æ ‡é”®ç§»åŠ¨ï¼Œå¯ä»¥çœ‹åˆ°responseæ˜¯æ˜æ–‡çš„ï¼Œqé”®æ˜¯è¿”å›ä¸Šä¸€çº§\nå››ã€åŒ…çš„æ‹¦æˆªä¿®æ”¹ ä¸Šé¢æ¼”ç¤ºçš„æ˜¯å¸¸è§„çš„æŸ¥çœ‹æ“ä½œï¼Œä¸‹é¢ä»‹ç»ä¸€ä¸‹ mitmproxy çš„å¦ä¸€å¼ºå¤§åŠŸèƒ½ï¼Œæ‹¦æˆªä¿®æ”¹ request å’Œ responseã€‚\nè¾“å…¥ iï¼Œç„¶åè¾“å…¥ ~s å†æŒ‰å›è½¦é”®ï¼Œè¿™æ—¶å€™å°±è¿›å…¥äº† response æ‹¦æˆªæ¨¡å¼ã€‚å¦‚æœè¾“å…¥  ~q åˆ™è¿›å…¥ request çš„æ‹¦æˆªæ¨¡å¼ï¼Œæ›´å¤šçš„å‘½ä»¤å¯ä»¥è¾“å…¥ ï¼Ÿ æŸ¥çœ‹ã€‚æ‹¦æˆªæ¨¡å¼ä¸‹çš„é¡µé¢æ˜¾ç¤ºå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nå…¶ä¸­çº¢è‰²çš„è¡¨ç¤ºè¯·æ±‚æ­£è¢«æ‹¦æˆªï¼Œè¿™æ—¶ Enter è¿›å…¥å å†æŒ‰ e å°±å¯ä»¥ä¿®æ”¹ request æˆ–è€… responseã€‚ä¿®æ”¹æ—¶æ˜¯ç”¨ vim è¿›è¡Œç¼–è¾‘çš„ï¼Œä¿®æ”¹å®ŒæˆåæŒ‰ a å°†è¯·æ±‚æ”¾è¡Œï¼Œå¦‚æœè¦æ”¾è¡Œæ‰€æœ‰è¯·æ±‚è¾“å…¥ A å³å¯ã€‚\n","date":"2021-10-14","img":"","permalink":"https://bajie.dev/posts/20211014-iphone_hijack/","series":null,"tags":null,"title":"Iphoneæ‰‹æœºçš„httpsæŠ“åŒ…"},{"categories":null,"content":"å…¬å¸çš„wifiä¿¡å·å¾ˆå¼±ï¼Œä¹Ÿä¸ä¿é™©ã€‚çœäº‹èµ·è§ï¼Œè¿˜æ˜¯è‡ªå·±å»ºç«‹ä¸€ä¸ªå¥½\nusbæ— çº¿ç½‘å¡è®¾å¤‡å¿…é¡»æ˜¯ä¸€ä¸ª nl80211 å…¼å®¹çš„æ— çº¿è®¾å¤‡ï¼Œæ‰€ä»¥é©±åŠ¨å°±æ˜¯è¿™ä¸ªï¼šnl80211\næˆ‘çš„æ“ä½œç³»ç»Ÿæ˜¯Ubuntuï¼Œå¦‚æœæ˜¯CentOSå‘½ä»¤åŸºæœ¬ä¸€æ ·\næ’ä¸Šwifi usbå¡å ip a çœ‹ä¸€ä¸‹ç½‘å¡çš„åç§°ï¼Œæˆ‘è¿™é‡Œæ˜¯ï¼šwlx00a1b0817651ï¼Œå¤Ÿé•¿\nä¸€ã€å®‰è£…hostapdè½¯ä»¶ 1sudo apt install -y hostapd äºŒã€å»ºç«‹hostapd.confæ–‡ä»¶ 1vi /etc/hostapd/hostapd.conf 2driver=nl80211 3ssid=Fast_8188  4channel=10 5interface=wlx00a1b0817651 6wpa=2 7wpa_passphrase=GreatWall2021! 8wpa_key_mgmt=WPA-PSK 9wpa_pairwise=TKIP ä¸‰ã€å»ºç«‹å¯åŠ¨è„šæœ¬/usr/local/bin/initAP.sh 1cat /usr/local/bin/initAP.sh 2 3#!/bin/bash 4 5start() {  6rfkill unblock all 7ifconfig wlx00a1b0817651 up 192.168.222.1 netmask 255.255.255.0 8sleep 2 9 10dnsmasq -i wlx00a1b0817651 --dhcp-range=192.168.222.10,192.168.222.20,2h 11 12#Enable NAT 13sysctl -w net.ipv4.ip_forward=1 14iptables -F  15iptables -X  16iptables -t nat -A POSTROUTING -s 192.168.222.0/24 -j SNAT --to 192.168.41.15 17 18hostapd -B /etc/hostapd/hostapd.conf  19} 20 21stop() { 22iptables -P INPUT ACCEPT 23iptables -P FORWARD ACCEPT 24iptables -P OUTPUT ACCEPT 25iptables -F 26iptables -X 27iptables -t nat -F 28iptables -t nat -X 29iptables -t mangle -F 30iptables -t mangle -X 31systemctl stop dnsmasq 32pkill hostapd 33/sbin/ip link set down dev wlx00a1b0817651 34} 35 36case $1 in  37 start) 38 start 39 ;; 40 stop) 41 stop 42 ;; 43 *) 44 echo \u0026#34;Usage: $0 {start|stop}\u0026#34; 45 exit 2 46esac å››ã€ç”¨rootèº«ä»½æ‰§è¡Œå³å¯ 1sudo chmod 755 /usr/local/bin/initAP.sh 2sudo /usr/local/bin/initAP.sh start è¿™æ ·å°±å¯ä»¥ç”¨è‡ªå·±çš„æ‰‹æœºè¿ä¸Šè¿™ä¸ªwifiçƒ­ç‚¹ï¼Œå°½æƒ…å†²æµªå•¦ã€‚\n ","date":"2021-10-14","img":"","permalink":"https://bajie.dev/posts/20211014-linux_wifi/","series":null,"tags":null,"title":"Ubuntuä¸‹è‡ªå»ºä¸€ä¸ªwifiçƒ­ç‚¹ä¾›æ‰‹æœºä½¿ç”¨"},{"categories":null,"content":"æŸäº›åœºåˆï¼Œå¾ˆæœ‰å¯èƒ½éœ€è¦å¯åŠ¨ISOæˆ–è€…USBç›˜ï¼Œè‡ªå¸¦Linuxç³»ç»Ÿï¼Œç„¶åæ‹¯æ•‘å½“å‰æŸåçš„ç³»ç»Ÿ\næˆ–è€…ç›´æ¥å¯åŠ¨ä¸€ä¸ªLIVE CentOSç³»ç»Ÿï¼Œå»åšæŸäº›äº‹ï¼Œæ¯”å¦‚ç”¨MegaRaidåˆ’åˆ†Raidã€æµ‹è¯•ç³»ç»Ÿç­‰ç­‰\nè¿™æ—¶å€™å°±éœ€è¦åˆ¶ä½œå‡ºæ¥ä¸€ä¸ªLIVE CDçš„ç³»ç»Ÿäº†\nåˆ¶ä½œæ­¥éª¤å¦‚ä¸‹ï¼š\nä¸€ã€å®‰è£…live-tools 1yum -y install livecd-tools äºŒã€å‡†å¤‡Kickstartæ–‡ä»¶centos7-live-docker.ks ä¸‹è½½åœ°å€ï¼šcentos7-live-docker.ks 1lang en_GB.UTF-8 2keyboard us 3timezone Asia/Shanghai --isUtc 4 5#selinux --enforcing 6selinux --disabled 7 8#firewall --enabled --service=cockpit 9firewall --disabled 10 11#xconfig --startxonboot 12part / --size 8192 --fstype ext4 13services --enabled=NetworkManager,sshd --disabled=network 14 15 16# Root password 17auth --useshadow --enablemd5 18rootpw --plaintext Kalaisadog2021 19 20repo --name=base --baseurl=http://mirror.centos.org/centos/7/os/x86_64/ 21repo --name=updates --baseurl=http://mirror.centos.org/centos/7/updates/x86_64/ 22repo --name=extras --baseurl=http://mirror.centos.org/centos/7/extras/x86_64/ 23repo --name=epel --baseurl=http://dl.fedoraproject.org/pub/epel/7/x86_64/ 24 25%packages  26@core 27kernel 28dracut 29bash 30firewalld 31NetworkManager 32e2fsprogs 33rootfiles 34docker 35openssh-server 36 37#By zhang ranrui 38unzip 39net-tools 40binutils 41wget 42bash-completion 43bc 44dmidecode 45dmraid 46dmraid-events 47lvm2 48lvm2-libs 49kpartx 50mdadm 51parted 52xfsdump 53xfsprogs 54gdisk 55bzip2 56extundelete 57libHX 58libHX-devel 59autoconf 60gcc 61gcc-c++ 62make 63screen 64telnet 65 66%end 67 68%post 69 70systemctl enable docker 71 72# By Zhang Ranrui, Add your custom script 73#wget http://www.rendoumi.com/soft/other/xfs_irecover -O /usr/local/bin/xfs_irecover 74#chmod 755 /usr/local/bin/xfs_irecover 75 76echo \u0026#34;Banner /etc/issue\u0026#34; \u0026gt;\u0026gt; /etc/ssh/sshd_config 77 78sed -i \u0026#34;s/After=network\\.target/After=network-online\\.target\\nWants=network-online\\.target/g\u0026#34; /usr/lib/systemd/system/rc-local.service 79 80chmod 755 /etc/systemd/system/rc.local.service.d 81chmod 644 /etc/systemd/system/rc.local.service.d/local.conf 82 83chmod 755 /etc/rc.d/rc.local 84systemctl enable rc-local 85systemctl start rc-local 86 87# FIXME: it\u0026#39;d be better to get this installed from a package 88cat \u0026gt; /etc/rc.d/init.d/livesys \u0026lt;\u0026lt; EOF 89#!/bin/bash 90# 91# live: Init script for live image 92# 93# chkconfig: 345 00 99 94# description: Init script for live image. 95### BEGIN INIT INFO 96# X-Start-Before: display-manager 97### END INIT INFO 98 99. /etc/init.d/functions 100 101if ! strstr \u0026#34;\\`cat /proc/cmdline\\`\u0026#34; rd.live.image || [ \u0026#34;\\$1\u0026#34; != \u0026#34;start\u0026#34; ]; then 102exit 0 103fi 104 105if [ -e /.liveimg-configured ] ; then 106 configdone=1 107fi 108 109exists() { 110 which \\$1 \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 || return 111 \\$* 112} 113 114# Make sure we don\u0026#39;t mangle the hardware clock on shutdown 115ln -sf /dev/null /etc/systemd/system/hwclock-save.service 116 117livedir=\u0026#34;LiveOS\u0026#34; 118for arg in \\`cat /proc/cmdline\\` ; do 119 if [ \u0026#34;\\${arg##rd.live.dir=}\u0026#34; != \u0026#34;\\${arg}\u0026#34; ]; then 120livedir=\\${arg##rd.live.dir=} 121return 122fi 123if [ \u0026#34;\\${arg##live_dir=}\u0026#34; != \u0026#34;\\${arg}\u0026#34; ]; then 124livedir=\\${arg##live_dir=} 125return 126fi 127done 128 129# enable swaps unless requested otherwise 130swaps=\\`blkid -t TYPE=swap -o device\\` 131if ! strstr \u0026#34;\\`cat /proc/cmdline\\`\u0026#34; noswap \u0026amp;\u0026amp; [ -n \u0026#34;\\$swaps\u0026#34; ] ; then 132 for s in \\$swaps ; do 133 action \u0026#34;Enabling swap partition \\$s\u0026#34; swapon \\$s 134 done 135fi 136if ! strstr \u0026#34;\\`cat /proc/cmdline\\`\u0026#34; noswap \u0026amp;\u0026amp; [ -f /run/initramfs/live/\\${livedir}/swap.img ] ; then 137 action \u0026#34;Enabling swap file\u0026#34; swapon /run/initramfs/live/\\${livedir}/swap.img 138fi 139 140mountDockerDisk() { 141 # support label/uuid 142 if [ \u0026#34;\\${dockerdev##LABEL=}\u0026#34; != \u0026#34;\\${dockerdev}\u0026#34; -o \u0026#34;\\${dockerdev##UUID=}\u0026#34; != \u0026#34;\\${dockerdev}\u0026#34; ]; then 143dockerdev=\\`/sbin/blkid -o device -t \u0026#34;\\$dockerdev\u0026#34;\\` 144fi 145 146 # if we\u0026#39;re given a file rather than a blockdev, loopback it 147 if [ \u0026#34;\\${dockerdev##mtd}\u0026#34; != \u0026#34;\\${dockerdev}\u0026#34; ]; then 148# mtd devs don\u0026#39;t have a block device but get magic-mounted with -t jffs2 149mountopts=\u0026#34;-t jffs2\u0026#34; 150elif [ ! -b \u0026#34;\\$dockerdev\u0026#34; ]; then 151loopdev=\\`losetup -f\\` 152if [ \u0026#34;\\${dockerdev##/run/initramfs/live}\u0026#34; != \u0026#34;\\${dockerdev}\u0026#34; ]; then 153action \u0026#34;Remounting live store r/w\u0026#34; mount -o remount,rw /run/initramfs/live 154fi 155losetup \\$loopdev \\$dockerdev 156dockerdev=\\$loopdev 157fi 158 159 # if it\u0026#39;s encrypted, we need to unlock it 160 if [ \u0026#34;\\$(/sbin/blkid -s TYPE -o value \\$dockerdev 2\u0026gt;/dev/null)\u0026#34; = \u0026#34;crypto_LUKS\u0026#34; ]; then 161echo 162echo \u0026#34;Setting up encrypted Docker device\u0026#34; 163plymouth ask-for-password --command=\u0026#34;cryptsetup luksOpen \\$dockerdev EncDocker\u0026#34; 164dockerdev=/dev/mapper/EncDocker 165fi 166 167 # and finally do the mount 168 mount \\$mountopts \\$dockerdev /var/lib/docker 169 # if we have /home under what\u0026#39;s passed for persistent home, then 170 # we should make that the real /home. useful for mtd device on olpc 171 if [ -d /var/lib/docker/docker ]; then mount --bind /var/lib/docker/docker /var/lib/docker ; fi 172 [ -x /sbin/restorecon ] \u0026amp;\u0026amp; /sbin/restorecon /var/lib/docker 173} 174 175findDockerDisk() { 176 for arg in \\`cat /proc/cmdline\\` ; do 177 if [ \u0026#34;\\${arg##dockerdisk=}\u0026#34; != \u0026#34;\\${arg}\u0026#34; ]; then 178dockerdev=\\${arg##dockerdisk=} 179return 180fi 181done 182} 183 184if strstr \u0026#34;\\`cat /proc/cmdline\\`\u0026#34; dockerdisk= ; then 185findDockerDisk 186elif [ -e /run/initramfs/live/\\${livedir}/docker.img ]; then 187 dockerdev=/run/initramfs/live/\\${livedir}/docker.img 188fi 189 190# if we have a persistent /home, then we want to go ahead and mount it 191if ! strstr \u0026#34;\\`cat /proc/cmdline\\`\u0026#34; nodockerdisk \u0026amp;\u0026amp; [ -n \u0026#34;\\$dockerdev\u0026#34; ] ; then 192 action \u0026#34;Mounting persistent /var/lib/docker\u0026#34; mountDockerDisk 193fi 194 195# make it so that we don\u0026#39;t do writing to the overlay for things which 196# are just tmpdirs/caches 197mount -t tmpfs -o mode=0755 varcacheyum /var/cache/yum 198mount -t tmpfs vartmp /var/tmp 199[ -x /sbin/restorecon ] \u0026amp;\u0026amp; /sbin/restorecon /var/cache/yum /var/tmp \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 200 201if [ -n \u0026#34;\\$configdone\u0026#34; ]; then 202 exit 0 203fi 204 205# add fedora user with no passwd 206action \u0026#34;Adding live user\u0026#34; useradd \\$USERADDARGS -c \u0026#34;Live System User\u0026#34; liveuser 207passwd -d liveuser \u0026gt; /dev/null 208usermod -aG wheel,docker liveuser \u0026gt; /dev/null 209 210# Remove root password lock 211passwd -d root \u0026gt; /dev/null 212(echo Kalaisadog2021; echo Kalaisadog2021)|passwd root --stdin 213 214# turn off firstboot for livecd boots 215systemctl --no-reload disable firstboot-text.service 2\u0026gt; /dev/null || : 216systemctl --no-reload disable firstboot-graphical.service 2\u0026gt; /dev/null || : 217systemctl stop firstboot-text.service 2\u0026gt; /dev/null || : 218systemctl stop firstboot-graphical.service 2\u0026gt; /dev/null || : 219 220# don\u0026#39;t use prelink on a running live image 221sed -i \u0026#39;s/PRELINKING=yes/PRELINKING=no/\u0026#39; /etc/sysconfig/prelink \u0026amp;\u0026gt;/dev/null || : 222 223# turn off mdmonitor by default 224systemctl --no-reload disable mdmonitor.service 2\u0026gt; /dev/null || : 225systemctl --no-reload disable mdmonitor-takeover.service 2\u0026gt; /dev/null || : 226systemctl stop mdmonitor.service 2\u0026gt; /dev/null || : 227systemctl stop mdmonitor-takeover.service 2\u0026gt; /dev/null || : 228 229# don\u0026#39;t enable the gnome-settings-daemon packagekit plugin 230gsettings set org.gnome.settings-daemon.plugins.updates active \u0026#39;false\u0026#39; || : 231 232# don\u0026#39;t start cron/at as they tend to spawn things which are 233# disk intensive that are painful on a live image 234systemctl --no-reload disable crond.service 2\u0026gt; /dev/null || : 235systemctl --no-reload disable atd.service 2\u0026gt; /dev/null || : 236systemctl stop crond.service 2\u0026gt; /dev/null || : 237systemctl stop atd.service 2\u0026gt; /dev/null || : 238 239# Mark things as configured 240touch /.liveimg-configured 241 242# add static hostname to work around xauth bug 243# https://bugzilla.redhat.com/show_bug.cgi?id=679486 244echo \u0026#34;localhost\u0026#34; \u0026gt; /etc/hostname 245 246# Fixing the lang install issue when other lang than English is selected . See http://bugs.centos.org/view.php?id=7217 247/usr/bin/cp /usr/lib/python2.7/site-packages/blivet/size.py /usr/lib/python2.7/site-packages/blivet/size.py.orig 248/usr/bin/sed -i \u0026#34;s#return self.humanReadable()#return self.humanReadable().encode(\u0026#39;utf-8\u0026#39;)#g\u0026#34; /usr/lib/python2.7/site-packages/blivet/size.py 249 250EOF 251 252# bah, hal starts way too late 253cat \u0026gt; /etc/rc.d/init.d/livesys-late \u0026lt;\u0026lt; EOF 254#!/bin/bash 255# 256# live: Late init script for live image 257# 258# chkconfig: 345 99 01 259# description: Late init script for live image. 260 261. /etc/init.d/functions 262 263if ! strstr \u0026#34;\\`cat /proc/cmdline\\`\u0026#34; rd.live.image || [ \u0026#34;\\$1\u0026#34; != \u0026#34;start\u0026#34; ] || [ -e /.liveimg-late-configured ] ; then 264exit 0 265fi 266 267exists() { 268 which \\$1 \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 || return 269 \\$* 270} 271 272touch /.liveimg-late-configured 273 274# read some variables out of /proc/cmdline 275for o in \\`cat /proc/cmdline\\` ; do 276 case \\$o in 277 ks=*) 278ks=\u0026#34;--kickstart=\\${o#ks=}\u0026#34; 279;; 280xdriver=*) 281xdriver=\u0026#34;\\${o#xdriver=}\u0026#34; 282;; 283esac 284done 285 286# if liveinst or textinst is given, start anaconda 287if strstr \u0026#34;\\`cat /proc/cmdline\\`\u0026#34; liveinst ; then 288 plymouth --quit 289 /usr/sbin/liveinst \\$ks 290fi 291if strstr \u0026#34;\\`cat /proc/cmdline\\`\u0026#34; textinst ; then 292 plymouth --quit 293 /usr/sbin/liveinst --text \\$ks 294fi 295 296# configure X, allowing user to override xdriver 297if [ -n \u0026#34;\\$xdriver\u0026#34; ]; then 298 cat \u0026gt; /etc/X11/xorg.conf.d/00-xdriver.conf \u0026lt;\u0026lt;FOE 299Section \u0026#34;Device\u0026#34; 300 Identifier \u0026#34;Videocard0\u0026#34; 301 Driver \u0026#34;\\$xdriver\u0026#34; 302EndSection 303FOE 304fi 305 306EOF 307 308chmod 755 /etc/rc.d/init.d/livesys 309/sbin/restorecon /etc/rc.d/init.d/livesys 310/sbin/chkconfig --add livesys 311 312chmod 755 /etc/rc.d/init.d/livesys-late 313/sbin/restorecon /etc/rc.d/init.d/livesys-late 314/sbin/chkconfig --add livesys-late 315 316# enable tmpfs for /tmp 317systemctl enable tmp.mount 318 319 320# enable docker 321systemctl enable docker.service 322 323# work around for poor key import UI in PackageKit 324rm -f /var/lib/rpm/__db* 325releasever=$(rpm -q --qf \u0026#39;%{version}\\n\u0026#39; --whatprovides system-release) 326basearch=$(uname -i) 327rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-fedora-$releasever-$basearch 328echo \u0026#34;Packages within this LiveCD\u0026#34; 329rpm -qa 330# Note that running rpm recreates the rpm db files which aren\u0026#39;t needed or wanted 331rm -f /var/lib/rpm/__db* 332 333# go ahead and pre-make the man -k cache (#455968) 334/usr/bin/mandb 335 336# save a little bit of space at least... 337rm -f /boot/initramfs* 338# make sure there aren\u0026#39;t core files lying around 339rm -f /core* 340 341# convince readahead not to collect 342# FIXME: for systemd 343 344cat \u0026gt;\u0026gt; /etc/rc.d/init.d/livesys \u0026lt;\u0026lt; EOF 345 346 347# disable updates plugin 348cat \u0026gt;\u0026gt; /usr/share/glib-2.0/schemas/org.gnome.settings-daemon.plugins.updates.gschema.override \u0026lt;\u0026lt; FOE 349[org.gnome.settings-daemon.plugins.updates] 350active=false 351FOE 352 353# Show the system-config-keyboard tool on the desktop 354mkdir /home/liveuser/Desktop -p \u0026gt;/dev/null 355cat /usr/share/applications/system-config-keyboard.desktop | sed \u0026#39;/NotShowIn/d\u0026#39; |sed \u0026#39;s/Terminal=false/Terminal=true/\u0026#39; \u0026gt; /home/liveuser/Desktop/system-config-keyboard.desktop 356cat /usr/share/applications/liveinst.desktop | sed \u0026#39;/NoDisplay/d\u0026#39; \u0026gt; /home/liveuser/Desktop/liveinst.desktop  357chmod +x /home/liveuser/Desktop/*.desktop 358chown -R liveuser:liveuser /home/liveuser 359 360# Liveuser face 361if [ -e /usr/share/icons/hicolor/96x96/apps/fedora-logo-icon.png ] ; then 362 cp /usr/share/icons/hicolor/96x96/apps/fedora-logo-icon.png /home/liveuser/.face 363 chown liveuser:liveuser /home/liveuser/.face 364fi 365 366# make the installer show up 367if [ -f /usr/share/applications/liveinst.desktop ]; then 368 # Show harddisk install in shell dash 369 sed -i -e \u0026#39;s/NoDisplay=true/NoDisplay=false/\u0026#39; /usr/share/applications/liveinst.desktop 370# need to move it to anaconda.desktop to make shell happy 371#cp /usr/share/applications/liveinst.desktop /usr/share/applications/anaconda.desktop 372fi 373 cat \u0026gt;\u0026gt; /usr/share/glib-2.0/schemas/org.gnome.shell.gschema.override \u0026lt;\u0026lt; FOE 374[org.gnome.shell] 375favorite-apps=[\u0026#39;liveinst.desktop\u0026#39;,\u0026#39;firefox.desktop\u0026#39;, \u0026#39;evolution.desktop\u0026#39;, \u0026#39;empathy.desktop\u0026#39;, \u0026#39;rhythmbox.desktop\u0026#39;, \u0026#39;shotwell.desktop\u0026#39;, \u0026#39;libreoffice-writer.desktop\u0026#39;, \u0026#39;nautilus.desktop\u0026#39;, \u0026#39;gnome-documents.desktop\u0026#39;, \u0026#39;anaconda.desktop\u0026#39;] 376FOE 377 378 379# set up auto-login 380cat \u0026gt; /etc/gdm/custom.conf \u0026lt;\u0026lt; FOE 381[daemon] 382AutomaticLoginEnable=True 383AutomaticLogin=liveuser 384FOE 385 386# Turn off PackageKit-command-not-found while uninstalled 387if [ -f /etc/PackageKit/CommandNotFound.conf ]; then 388 sed -i -e \u0026#39;s/^SoftwareSourceSearch=true/SoftwareSourceSearch=false/\u0026#39; /etc/PackageKit/CommandNotFound.conf 389fi 390 391# make sure to set the right permissions and selinux contexts 392chown -R liveuser:liveuser /home/liveuser/ 393restorecon -R /home/liveuser/ 394 395# Fixing default locale to us 396localectl set-keymap us 397localectl set-x11-keymap us 398EOF 399 400 401# rebuild schema cache with any overrides we installed 402glib-compile-schemas /usr/share/glib-2.0/schemas 403 404 405%end æ³¨æ„ï¼Œä¸Šé¢æ³¨é‡Šäº†ä¸¤ä¸ªåœ°æ–¹ï¼Œéƒ½å¯ä»¥æ·»åŠ è½¯ä»¶æˆ–è€…è¿è¡Œè„šæœ¬\nä¸‰ã€buildå‡ºisoæ–‡ä»¶ 1livecd-creator --verbose -c centos7-live-docker.ks --cache=cache -f centos7-live-docker ç„¶åå°±ä¼šå¾—åˆ°centos7-live-docker.isoçš„æ–‡ä»¶ï¼Œæ³¨æ„åœ¨buildè¿‡ç¨‹ä¸­çš„æŠ¥é”™ä¿¡æ¯ï¼Œå¤šæ•°æ˜¯æ— æ³•ä¸‹è½½åŒ…å¯¼è‡´çš„ã€‚\nç›´æ¥åŠ è½½ISOæ–‡ä»¶å¯åŠ¨æˆ–è€…åˆ»å½•åˆ°USBä¸Šå¯åŠ¨ï¼Œå°±å¯ä»¥è¿›å…¥è¿™ä¸ªè‡ªåˆ¶çš„Liveç³»ç»Ÿäº†\nåƒä¸‡æ³¨æ„ï¼Œå¯åŠ¨ä¸€å®šè¦é€‰Bios legacyï¼Œä¸è¦ç”¨Uefiã€‚\nç›¸å…³ä¸€äº›æœ‰ç”¨çš„é“¾æ¥ï¼š\n https://github.com/minishift/minishift-centos-iso  https://github.com/livecd-tools/livecd-tools  https://blog.csdn.net/sharpbladepan/article/details/107423468   ","date":"2021-10-10","img":"","permalink":"https://bajie.dev/posts/20211010-live_cd/","series":null,"tags":null,"title":"CentOS 7 Live-CD çš„åˆ¶ä½œ"},{"categories":[],"content":"This article offers a sample of basic Markdown syntax that can be used in Hugo content files, also it shows whether basic HTML elements are decorated with CSS in a Hugo theme.\nHeadings The following HTML \u0026lt;h1\u0026gt;â€”\u0026lt;h6\u0026gt; elements represent six levels of section headings. \u0026lt;h1\u0026gt; is the highest section level while \u0026lt;h6\u0026gt; is the lowest.\nH1 H2 H3 H4 H5 H6 Paragraph Xerum, quo qui aut unt expliquam qui dolut labo. Aque venitatiusda cum, voluptionse latur sitiae dolessi aut parist aut dollo enim qui voluptate ma dolestendit peritin re plis aut quas inctum laceat est volestemque commosa as cus endigna tectur, offic to cor sequas etum rerum idem sintibus eiur? Quianimin porecus evelectur, cum que nis nust voloribus ratem aut omnimi, sitatur? Quiatem. Nam, omnis sum am facea corem alique molestrunt et eos evelece arcillit ut aut eos eos nus, sin conecerem erum fuga. Ri oditatquam, ad quibus unda veliamenimin cusam et facea ipsamus es exerum sitate dolores editium rerore eost, temped molorro ratiae volorro te reribus dolorer sperchicium faceata tiustia prat.\nItatur? Quiatae cullecum rem ent aut odis in re eossequodi nonsequ idebis ne sapicia is sinveli squiatum, core et que aut hariosam ex eat.\nBlockquotes The blockquote element represents content that is quoted from another source, optionally with a citation which must be within a footer or cite element, and optionally with in-line changes such as annotations and abbreviations.\nBlockquote without attribution  Tiam, ad mint andaepu dandae nostion secatur sequo quae. Note that you can use Markdown syntax within a blockquote.\n Blockquote with attribution  Don\u0026rsquo;t communicate by sharing memory, share memory by communicating.â€” Rob Pike1 Tables Tables aren\u0026rsquo;t part of the core Markdown spec, but Hugo supports supports them out-of-the-box.\n   Name Age     Bob 27   Alice 23    Inline Markdown within tables    Italics Bold Code     italics bold code    Code Blocks Code block with backticks 1\u0026lt;!doctype html\u0026gt; 2\u0026lt;html lang=\u0026#34;en\u0026#34;\u0026gt; 3\u0026lt;head\u0026gt; 4 \u0026lt;meta charset=\u0026#34;utf-8\u0026#34;\u0026gt; 5 \u0026lt;title\u0026gt;Example HTML5 Document\u0026lt;/title\u0026gt; 6\u0026lt;/head\u0026gt; 7\u0026lt;body\u0026gt; 8 \u0026lt;p\u0026gt;Test\u0026lt;/p\u0026gt; 9\u0026lt;/body\u0026gt; 10\u0026lt;/html\u0026gt; Code block with Hugo\u0026rsquo;s internal highlight shortcode 1\u0026lt;!doctype html\u0026gt; 2\u0026lt;html lang=\u0026#34;en\u0026#34;\u0026gt; 3\u0026lt;head\u0026gt; 4 \u0026lt;meta charset=\u0026#34;utf-8\u0026#34;\u0026gt; 5 \u0026lt;title\u0026gt;Another Example HTML5 Document\u0026lt;/title\u0026gt; 6\u0026lt;/head\u0026gt; 7\u0026lt;body\u0026gt; 8 \u0026lt;p\u0026gt;A looooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooong text\u0026lt;/p\u0026gt; 9\u0026lt;/body\u0026gt; 10\u0026lt;/html\u0026gt; List Types Ordered List  First item Second item Third item  Unordered List  List item Another item And another item  Nested List  Fruit  Apple Orange Banana   Dairy  Milk Cheese    TODO List  Done WIP  Other Elements â€” abbr, sub, sup, kbd, mark GIFis a bitmap image format.\nH2O\nXn+ Yn= ZnPress CTRL+ALT+Deleteto end the session.\nMost salamandersare nocturnal, and hunt for insects, worms, and other small creatures.\n  The above quote is excerpted from Rob Pike\u0026rsquo;s talk during Gopherfest, November 18, 2015.\u0026#160;\u0026#x21a9;\u0026#xfe0e;\n  ","date":"2020-11-09","img":"https://bajie.dev/images/markdown.png","permalink":"https://bajie.dev/posts/markdown-syntax/","series":["Manual"],"tags":["Markdown","CSS","HTML"],"title":"Markdown Syntax Guide"}]